adjust_extent_cmip6_hist_ssp585<-function(
  
){
  
  files = list.files('/media/root/Shen_drive1/CMIP6_combined',full.names = T)
  
  for(i in c(1,2,4)){
    f1 = files[i]
    f1 = list.files(f1,full.names = T)
    print(i)
    for(j in 2){
      f2 = list.files(f1[j],full.names = T)
      
      for(z in 1:length(f2)){
        library(raster)
        library(ncdf4)
        tmp = stack(f2[z])
        extent(tmp) = extent(0,360,0,90)
        
        e1 = extent(0,180,0,90)
        e2 = extent(180,360,0,90)
        
        tmp1 = crop(tmp,e1)
        tmp2 = crop(tmp,e2)
        
        extent(tmp2) = extent(-180,0,0,90)
        
        tmp = merge(tmp2,tmp1)
        writeRaster(tmp,f2[z],format = 'CDF',overwrite = T)
      }
      
    }
    
    
    
  }
  
  
  
  
}
adjust_extent_cmip6_sst<-function(
  
){
  
  files = list.files('/media/root/Shen_drive1/CMIP6_combined',
                     full.names = T)
  
  for(i in 3){
    f1 = files[i]
    f1 = list.files(f1,full.names = T)
    print(i)
    for(j in 1:2){
      f2 = list.files(f1[j],full.names = T)
      
      for(z in 1:length(f2)){
        library(raster)
        library(ncdf4)
        tmp = try(stack(f2[z]),
                  silent = T)
        
        if('try-error' %in% class(tmp)){
          tmp = fread(f2[z])
          tmp = as.data.frame(tmp)
          
          loc = tmp[,1:2]
          
          minlong = min(loc[,1])
          minlat = min(loc[,2])
          maxlong = max(loc[,1])
          maxlat = max(loc[,2])
          
          diflong = minlong -()
          
          coordinates(tmp1) = ~long+lat
          gridded(tmp1) = T
          
          tmp1 = raster(tmp1)
          ggplot()+
            geom_point(data = tmp1,
                      aes(x = long,
                          y = lat,
                          color = value),
                      shape = 2)
            
        }
        extent(tmp) = extent(0,360,0,90)
        
        e1 = extent(0,180,0,90)
        e2 = extent(180,360,0,90)
        
        tmp1 = crop(tmp,e1)
        tmp2 = crop(tmp,e2)
        
        extent(tmp2) = extent(-180,0,0,90)
        
        tmp = merge(tmp2,tmp1)
        writeRaster(tmp,f2[z],format = 'CDF',overwrite = T)
      }
      
    }
    
    
    
  }
  
  
  
  
}
adjust_extent_cmip6<-function(
  
){
  
  files = list.files('/media/root/Shen_drive1/CMIP6_combined_2099',full.names = T)
  
  for(i in 1:3){
    f1 = files[i]
    f1 = list.files(f1,full.names = T)
    print(i)
    for(j in 1:2){
      f2 = list.files(f1[j],full.names = T)
      
      for(z in 1:length(f2)){
        library(raster)
        library(ncdf4)
        tmp = stack(f2[z])
        extent(tmp) = extent(0,360,0,90)
        
        e1 = extent(0,180,0,90)
        e2 = extent(180,360,0,90)
        
        tmp1 = crop(tmp,e1)
        tmp2 = crop(tmp,e2)
        
        extent(tmp2) = extent(-180,0,0,90)
        
        tmp = merge(tmp2,tmp1)
        writeRaster(tmp,f2[z],format = 'CDF',overwrite = T)
      }
      
    }
    
        
    
  }
  
  
  
  
}
analyze_contr_monthly_var_rel_new<-function(
  
){
  library(data.table)
  # files contr in source
  files = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
  files_name = list.files('/media/sdb1/xinjiang_output_file')
  
  files = paste0(files,'/output/contr_by_source_released_new')
  files = list.files(files,full.names = T)
  
  yearmon = paste0('year',substr(files_name,9,14))
  
  oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
  con_names = c('as','xj','eu','naf','na')
  
  sou_names = c(oce_names,con_names)
  
  tmp_df = 1
  for(i in 1:length(files)){
    
    tmp = fread(files[i])
    tmp = as.data.frame(tmp)
    tmpname = tmp[,1]
    if(length(tmpname) == length(sou_names)){
      tmp_df = cbind(tmp_df,tmp[,2]*100)
    }else{
      tmp_value = tmp[1,]
      for(j in 1:length(sou_names)){
        tmpid = which(tmpname == sou_names[j])
        #print(tmpid)
        if(length(tmpid) == 0){
          tmp_re = c(sou_names[j],NA)
          tmp_value = rbind(tmp_value,tmp_re)
          #print(tmp_value)
        }else{
          #print(tmp[tmpid,])
          tmp_value = rbind(tmp_value,tmp[tmpid,])
          #print(tmp_value)
        }
      }
      #tmp_value = as.data.frame(tmp_value)
      tmp_value[,2] = as.numeric(tmp_value[,2])
      tmp_value = tmp_value[-1,]
      tmp_df = cbind(tmp_df,tmp_value[,2]*100)
    }
  }
  tmp_df = tmp_df[,-1]
  
  df = tmp_df
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),
             '1 month')
  
  trend_cal <- function(x){
    naid = which(is.na(x))
    x[naid] = 0
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    return(xt)
  }
  
  dft = apply(df,1,trend_cal)
  nid = which(is.na(dft[,1]))
  
  date_m = date[-nid]
  dft = dft[-nid,]
  
  dft = t(dft)
  rownames(dft) = sou_names
  colnames(dft) = yearmon[-nid]
  dft = data.frame(sou_names,dft)
  
  colnames(df) = yearmon
  df = data.frame(sou_names,df)
  
  
  library(reshape2)
  dfm = melt(df,'sou_names')
  dftm = melt(dft,'sou_names')
  
  
  dfm$date = rep(date,each = length(sou_names))
  dftm$date = rep(date_m,each = length(sou_names))
  dir.create('analysis_output')
  fwrite(df,'analysis_output/contr_in_source_variance_new.csv')
  fwrite(dft,'analysis_output/contr_in_source_tr_new.csv')
  
  return(tmp_df)
  
  
  
}


analyze_contr_monthly_var<-function(
  
){
  # files contr in source
  files = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
  files_name = list.files('/media/sdb1/xinjiang_output_file')
  
  files = paste0(files,'/output/contr_by_source')
  files = list.files(files,full.names = T)
  
  yearmon = paste0('year',substr(files_name,9,14))
  
  oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
  con_names = c('as','xj','eu','naf','na')
  
  sou_names = c(oce_names,con_names)
  
  tmp_df = 1
  for(i in 1:length(files)){
    tmp = fread(files[i])
    tmp = as.data.frame(tmp)
    tmpname = tmp[,1]
    if(length(tmpname) == length(sou_names)){
      tmp_df = cbind(tmp_df,tmp[,2]*100)
    }else{
      tmp_value = 1
      for(j in 1:length(sou_names)){
          tmpid = which(tmpname == sou_names[j])
          if(length(tmpid) == 0){
            tmp_re = c(sou_names[j],NA)
            tmp_value = rbind(tmp_value,tmp_re)
            #print(tmp_value)
          }else{
            tmp_value = rbind(tmp_value,tmp[tmpid,])
            #print(tmp_value)
          }
      }
      tmp_value[,2] = as.numeric(tmp_value[,2])
      tmp_value = tmp_value[-1,]
      tmp_df = cbind(tmp_df,tmp_value[,2]*100)
    }
  }
  tmp_df = tmp_df[,-1]
  
  df = tmp_df
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),
             '1 month')
  
  trend_cal <- function(x){
    naid = which(is.na(x))
    x[naid] = 0
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    return(xt)
  }
  
  dft = apply(df,1,trend_cal)
  nid = which(is.na(dft[,1]))
  
  date_m = date[-nid]
  dft = dft[-nid,]
  
  dft = t(dft)
  rownames(dft) = sou_names
  colnames(dft) = yearmon[-nid]
  dft = data.frame(sou_names,dft)
  
  colnames(df) = yearmon
  df = data.frame(sou_names,df)
  
  
  library(reshape2)
  dfm = melt(df,'sou_names')
  dftm = melt(dft,'sou_names')
  
  
  dfm$date = rep(date,each = length(sou_names))
  dftm$date = rep(date_m,each = length(sou_names))
  dir.create('analysis_output')
  fwrite(df,'contr_in_source_variance.csv')
  fwrite(dft,'contr_in_source_tr.csv')
  
  return(tmp_df)
  
  
  
}

df = tmp_df
date = seq(as.Date('2003-01-01'),
           as.Date('2017-12-01'),
           '1 month')

trend_cal <- function(x){
  naid = which(is.na(x))
  x[naid] = 0
  xt = ts(x,start = c(2003,1),frequency = 12)
  xt = decompose(xt)$trend
  return(xt)
}

dft = apply(df,1,trend_cal)
nid = which(is.na(dft[,1]))

date_m = date[-nid]
dft = dft[-nid,]

dft = t(dft)
rownames(dft) = sou_names
colnames(dft) = yearmon[-nid]
dft = data.frame(sou_names,dft)

colnames(df) = yearmon
df = data.frame(sou_names,df)


library(reshape2)
dfm = melt(df,'sou_names')
dftm = melt(dft,'sou_names')


dfm$date = rep(date,each = length(sou_names))
dftm$date = rep(date_m,each = length(sou_names))
which(is.na(dfm$value))


p = ggplot()+
  geom_line(data = dfm,aes(x= date,y = value,color = sou_names))


oce_df = dftm[1,]
for(i in 1:length(oce_names)){
  ocetmp = which(dftm$sou_names == oce_names[i])
  ocetmp = dftm[ocetmp,]
  oce_df = rbind(oce_df,ocetmp)
}

oce_df = oce_df[-1,]

con_df = dftm[1,]
for(i in 1:length(con_names)){
  contmp = which(dftm$sou_names == con_names[i])
  contmp = dftm[contmp,]
  con_df = rbind(con_df,contmp)
}

con_df = con_df[-1,]
naid_con = which(con_df$sou_names =='na')
con_df = con_df[-naid_con,]

p_con = ggplot()+
  geom_line(data = con_df,aes(x= date,y = value,color = sou_names))+
  facet_wrap(~sou_names,nrow = 2,scales = 'free')+theme_bw()+
  theme(
    panel.background = element_rect(fill = 'transparent'),
    axis.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
    axis.title = element_text(color = 'black',size = 14,face = 'bold',hjust = 0.5),
    legend.position = 'bottom',
    legend.direction = 'horizontal',
    legend.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
    legend.title = element_text(color = 'black',size = 14, face = 'bold',hjust = 0.5),
    strip.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5)
  )+
  guides(fill = guide_legend(nrow = 1))+
  xlab('Date (month)')+
  ylab('Contribution Ratio (%)')


png('plot/contr_con_monthly_var_line.png',
    height = 20,
    width = 21,
    units = 'cm',
    res = 800)
print(p_con)
dev.off()

p_oce = ggplot()+
  geom_line(data = oce_df,aes(x= date,y = value,color = sou_names))+
  facet_wrap(~sou_names,nrow = 4,scales = 'free')+theme_bw()+
  theme(
    panel.background = element_rect(fill = 'transparent'),
    axis.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
    axis.title = element_text(color = 'black',size = 14,face = 'bold',hjust = 0.5),
    legend.position = 'bottom',
    legend.direction = 'horizontal',
    legend.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
    legend.title = element_text(color = 'black',size = 14, face = 'bold',hjust = 0.5),
    strip.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5)
  )+
  guides(color = guide_legend(nrow = 1))+
  xlab('Date (month)')+
  ylab('Contribution Ratio (%)')


png('plot/contr_oce_monthly_var_line.png',
    height = 20,
    width = 21,
    units = 'cm',
    res = 800)
print(p_oce)
dev.off()






anunal_pattern_analysis<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/anunal_pattern_cal.R')
  # gpcc 
  source('/home/share/R_project/xinjiang_vapor/gpcc_pr_in_xinjiang.R')
  gpcc_full = gpcc_pr_in_xinjiang(mode = 'full')
  gpcc_anu = anunal_pattern_cal(gpcc_full)
  # gws
  source('/home/share/R_project/xinjiang_vapor/gws_in_xinjiang.R')
  gws_full = gws_in_xinjiang(mode = 'full')
  gws_anu = anunal_pattern_cal(gws_full,'grace')
  # era5_evpor
  source('/home/share/R_project/xinjiang_vapor/era5_evapor.R')
  eva_full = era5_evapor(mode = 'full')
  eva_anu = anunal_pattern_cal(eva_full)
  # era5_temper
  source('/home/share/R_project/xinjiang_vapor/era5_temper.R')
  t_full = era5_tmp(mode = 'full')
  t_anu = anunal_pattern_cal(t_full)
  # ndvi 
  source('/home/share/R_project/xinjiang_vapor/ndvi_in_xinjiang.R')
  ndvi_full = ndvi_in_xinjiang(mode = 'full')
  ndvi_anu = anunal_pattern_cal(ndvi_full)
  
  year = 2003:2017
  gpcc_anu = stand_fun(gpcc_anu)
  gws_anu = stand_fun(gws_anu)
  eva_anu = stand_fun(eva_anu)
  t_anu = stand_fun(t_anu)
  ndvi_anu = stand_fun(ndvi_anu)
  
  ep = gpcc_anu-eva_anu
  
  d = data.frame(year,gpcc_anu,gws_anu)
  
  dm = reshape2::melt(d,'year')
  
  dm$year = factor(dm$year,levels = year)
  
  p = ggplot()+
    geom_line(data = dm,aes(x = year,y = value, color = variable,group = variable))+
    theme_bw()+
    theme(
      panel.background = element_rect(fill = 'transparent'),
      axis.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      axis.title = element_text(color = 'black',size = 14,face = 'bold',hjust = 0.5),
      legend.position = 'bottom',
      legend.direction = 'horizontal',
      legend.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      legend.title = element_text(color = 'black',size = 14, face = 'bold',hjust = 0.5),
      strip.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5)
    )+
    guides(color = guide_legend(nrow = 1))+
    xlab('Date (month)')+
    ylab('Index')
  
  p
}
anunal_pattern_cal<-function(
  index,mode = 'others'
){
  
  #start = 2003-01-01
  #end = 2017-12-01
  if(mode == 'grace'){
    index = c(index,rep(NA,6))
  }
  indexm = matrix(index,nrow = 12)
  
  mean_fun<-function(x){
    tmp = mean(x,na.rm = T)
  }
  indexm = apply(indexm,2,mean_fun)
  return(indexm)
  
}
attribution_analysis_tws_pmeato3_freshwater <- function(
  
){
  pmeato3 = pmeato3_year[,3]
  pmeato4 = pmeato3_year[,4]
  # import tws 
  input_tws_by_country = 'NC_mod_xinjiang/tws_by_country/tws_year.csv'
  tws_year = as.data.frame(fread(input_tws_by_country))
  col_twsyear = colnames(tws_year)
  reid = which(col_twsyear %in% c('Mongolia','Indonesia','Japan','Iceland','Australia'))
  tws_year = tws_year[,-reid]
  
  tws_china = as.data.frame(fread('NC_mod_xinjiang/tws_by_china/tws_year.csv'))
  # import pmeato3
  pmeato3_full = as.data.frame(
    fread('NC_mod_xinjiang/era5_pme_sum/ato/era5_pme_sum.csv')
  )
  
  stand_trend_fun <-function(x){
    x = ts(x,start = c(2003,1),
           frequency = 12)
    x = decompose(x)$trend
    x = x[-which(is.na(x))]
    
    x = (x-mean(x))/(max(x)-min(x))
    return(x)
  }
  to_year <-function(x){
    x = matrix(x,nrow = 12)
    x = apply(x,2,sum)
    x = (x-mean(x))/(max(x)-min(x))
    return(x)
    
  }
  pmeato3_year = apply(pmeato3_full,2,to_year)
  pmeato3_year = pmeato3_year[-15,]
  
  # import freshwater
  freshwater = as.data.frame(fread('NC_mod_xinjiang/freshwater/freshwater_filter.csv'))
  country = freshwater[,1]
  reid = which(country %in% c('Mongolia','Indonesia','Japan','Iceland','Australia'))
  
  freshwater = freshwater[,-c(1,2,17)]
  freshwater = t(freshwater)
  colnames(freshwater) = country
  
  freshwater = freshwater[,-reid]
  country = country[-reid]
  freshwater_china = as.data.frame(fread('NC_mod_xinjiang/freshwater/china_area_freshwater_new.csv'))
  
  #freshwater = freshwater * -1
  stand_fun <- function(x){
    x = (x-mean(x))/(max(x)-min(x))
    return(x)
  }
  
  freshwater = apply(freshwater,2,stand_fun)
  freshwater_china = apply(freshwater_china,2,stand_fun)
  freshwater_china = freshwater_china[1:14,]
  
  nanid = apply(freshwater,2,mean)
  nanid = which(is.nan(nanid)) 
  
  country = country[-nanid]
  freshwater = freshwater[,-nanid]  
  tws_year = tws_year[,-nanid]
  
  country = c(country,c('Xinjiang','North China Plain'))
  colnames(tws_china) = c('Xinjiang','NorthChinaPlain')
  
  tws_year = cbind(tws_year,tws_china)
  freshwater = cbind(freshwater,freshwater_china[,2:3])
  
  
  i =1:ncol(freshwater)
  countrys = country
  write.csv(matrix(countrys,ncol = 1),'NC_mod_xinjiang/fig_human_impact/countrys.csv')
  sub_attr_fun <-function(
    i
  ){
    print(i)
    fresh1 = freshwater[,i]
    tws1 = tws_year[,i]
    pmeato3 = pmeato3_year[,3]
    pmeato4 = pmeato3_year[,4]
    
    source("/home/share/R_project/xinjiang_vapor/mmkTrend.R")
    trend = mmkTrend(tws1)$tau
    #trend2 = mmkTrend()
    print(trend)
    if(trend >=0 ){
      model = lm(tws1~fresh1+pmeato3+pmeato4)
      
      coeff = model$coefficients
      
      cor = cor(model$fitted.values,tws1)
      retdf = data.frame(
        coeff_freshwater_withdraw = coeff[2],
        coeff_pmeato3 = coeff[3],
        coeff_pmeato4 = coeff[4],
        cor = cor,
        type = 'increasing_TWS'
      )
      
      
    }else{
      model = lm(tws1~fresh1+pmeato3)
      
      coeff = model$coefficients
      cor = cor(model$fitted.values,tws1)
      retdf = data.frame(
        coeff_freshwater_withdraw = coeff[2],
        coeff_pmeato3 = coeff[3],
        coeff_pmeato4 = 0,
        cor = cor,
        type = 'declining_TWS'
      )
    }
    return(retdf) 
    
  }
  
  coeffddf = do.call(rbind,lapply(i, sub_attr_fun))
  fwrite(coeffddf,'NC_mod_xinjiang/fig_human_impact/coeffdf.csv')
  source("/home/share/R_project/xinjiang_vapor/spatial_pattern_increasing_decling_tws.R")
  p_trend_tws = spatial_pattern_increasing_decling_tws(countrys,coeffddf)
  source("/home/share/R_project/xinjiang_vapor/select_important_factor.R")
  
  peo_country = select_important_factor(coeffddf,
                                        countrys)
  pos_peo1 = peo_country[[1]]
  neg_peo1 = peo_country[[2]]
  
  peo_coun_rbind = rbind(pos_peo1,neg_peo1)
  fwrite(peo_coun_rbind,'NC_mod_xinjiang/fig_human_impact/peo_coun_rbind.csv')
    
  col_tws = colnames(tws_year)
  pos_tws = tws_year[,which(col_tws %in% pos_peo1$country)]
  neg_tws = tws_year[,which(col_tws %in% neg_peo1$country)]
  
  pos_fre = freshwater[,which(col_tws %in% pos_peo1$country)]
  neg_fre = freshwater[,which(col_tws %in% neg_peo1$country)]

  pos_twsdf = data.frame(
    year = 2003:2016,pos_tws
  )
  neg_twsdf = data.frame(
    year = 2003:2016,neg_tws
  )
  pos_twsdf = reshape2::melt(pos_twsdf,'year')
  neg_twsdf = reshape2::melt(neg_twsdf,'year')
  pos_twsdf$type = 'Increasing_TWS'
  neg_twsdf$type = 'Declining_TWS'
  
  twsdf = rbind(pos_twsdf,neg_twsdf)
  twsdf$var = 'tws'
  
  pos_fredf = data.frame(
    year = 2003:2016,pos_fre
  )
  neg_fredf = data.frame(
    year = 2003:2016,neg_fre
  )
  pos_fredf = reshape2::melt(pos_fredf,'year')
  neg_fredf = reshape2::melt(neg_fredf,'year')
  
  pos_fredf$type = 'Increasing_TWS'
  neg_fredf$type = 'Declining_TWS'
  
  fredf = rbind(pos_fredf,neg_fredf)
  fredf$var = 'freshwater_withdraw'
  
  linedf = rbind(twsdf,fredf)
  
  fwrite(linedf,'NC_mod_xinjiang/fig_human_impact/tws_freshwater_df.csv')
  pmedf = data.frame(
    year= 2003:2016,
    pmeato3,
    pmeato4
  )
  fwrite(pmedf,'NC_mod_xinjiang/fig_human_impact/pmedf.csv')
  pmedf = reshape2::melt(pmedf,'year')
  colnames(pmedf) = c('year','var','value')
  pline =ggplot()+
    geom_line(data = linedf,
              aes(x = year,y = value,color = var))+
    #geom_line(data = pmedf,
    #          aes(x = year,y = value,color =var))+
    facet_wrap(~variable)+
    theme_bw()
  pline
  
  negid = which(coeffddf$coeff_freshwater_withdraw < 0)
  
  negdf = coeffddf[negid,]
  negfresh = freshwater[,negid]
  negtws = tws_year[,negid]
  pmeato3 = pmeato3_year[,3]
  pmeato4 = pmeato3_year[,4]
  neg_country = countrys[negid]
  
  id_fresh_ato4 = which(negdf$type == 'increasing_TWS')
  id_fresh_ato3 = which(negdf$type == 'declining_TWS')
  
  negfresh_idato4 = negfresh[,id_fresh_ato4]
  negfresh_idato3 = negfresh[,id_fresh_ato3]
  negtws_idato4 = negtws[,id_fresh_ato4]
  negtws_idato3 = negtws[,id_fresh_ato3]
  neg_country_ato4 = neg_country[id_fresh_ato4]
  neg_country_ato3 = neg_country[id_fresh_ato3]
  
  
  negdif13 = abs(negdf$coeff_freshwater_withdraw) - 
    abs(negdf$coeff_pmeato3)
  negdif14 = abs(negdf$coeff_freshwater_withdraw) - 
    abs(negdf$coeff_pmeato4)
  neg
  
  
  peopid13 = which(negdif13 >0)
  peopid14 = which(negdif14 >0)
  
  peopid134 = intersect(peopid13,peopid14)
  
  
  
  
  peodf = negdf[peopid,]
  peofresh = negfresh[,peopid]
  peotws = negtws[,peopid]
  peo_country = neg_country[peopid]
  
  peofreshdf = data.frame(
    year = 2003:2016,
    peofresh
  )
  peotwsdf = data.frame(
    year = 2003:2016,
    peotws
  )
  
  peofreshdf = reshape2::melt(peofreshdf,'year')
  peotwsdf = reshape2::melt(peotwsdf,'year')
  
  peofreshdf$type = 'freshwater'
  peotwsdf$type = 'tws'
  
  df = rbind(peofreshdf,peotwsdf)
  
  # input country in and not in HSR
  hsr = shapefile('analysis_output/fig2/combine_sub_window.shp')
  coun_dfnoin = fread('NC_mod_xinjiang/freshwater/loc_dfnoin_hsr.csv')
  coun_dfin = fread('NC_mod_xinjiang/freshwater/loc_in_hsr.csv')
  
  coun_dfnoin = as.data.frame(coun_dfnoin)
  coun_dfin = as.data.frame(coun_dfin)
  country_label <- as.data.frame(
    fread('/media/sdb5/Vapor_projcts/Vapor_tibet/main_plot_data/fig3/country_label.csv')
  )
  country_label = country_label[-which(country_label$name == 'Hong Kong'|
                                         country_label$name == 'Macau'),]
  country_label$latitude[which(country_label$name=='India')]=
    country_label$latitude[which(country_label$name=='India')]+2
  
  #import xj
  citys = shp_management('china_city')
  city_china = citys[citys$PINYIN %in%
                          c('Wulumuqi','Shijiazhuang'),]
  city_china = as.data.frame(city_china,xy = T)
  city_china1 = data.frame(
    country = c('NCP','XJ'),
    latitude = city_china$coords.x2,
    longitude = city_china$coords.x1,
    name = c('North China Plain','Xinjiang')
  )
  city_china2 = data.frame(
    country = c('NCP','XJ'),
    latitude = city_china$coords.x2,
    longitude = city_china$coords.x1,
    name = c('North China Plain','Xinjiang'),
    xy = c(TRUE,TRUE)
  )
 
  country_label = rbind(country_label,city_china1)
  coun_dfin = rbind(coun_dfin,city_china2)
  
  peo_coun_loc = which(country_label$name %in% peofreshdf$variable)
  peo_coun_loc = country_label[peo_coun_loc,]
  
  world = shp_management('world')
  world = crop(world,extent(-20,180,0,90))
  
  p = ggplot()+
    geom_polygon(data = world,
                 aes(x = long,y = lat,
                     group = group),
                 size = 0.5,
                 fill = 'grey80')+
    geom_polygon(data = hsr,
                 aes(x = long,y = lat,
                     group = group),
                 size = 0.5,
                 fill = 'transparent',color = 'black')+
    geom_point(data = coun_dfin,
               aes(x = longitude,y = latitude),
               size = 3,shape = 1,
               color = 'red')+
    geom_point(data =coun_dfin,
               aes(x = longitude,y = latitude),
               size = 2,shape = 16,
               color = 'red')+
    
    geom_point(data = peo_coun_loc,
               aes(x = longitude,y = latitude),
               size = 3,shape = 1,
               color = 'blue')+
    geom_point(data =peo_coun_loc,
               aes(x = longitude,y = latitude),
               size = 2,shape = 16,
               color = 'blue')+
    geom_text(data = peo_coun_loc,
              aes(x = longitude,y = latitude,
                  label = name),
              size = 4)+
    theme_bw()
  
  
  
  
  
  pmedf = data.frame(
    year = 2003:2016,
    pmeato3
  )
  p1 = ggplot()+
    geom_line(data = df,aes(x = year,y = value,
                            color = type),
              size = 1)+
    geom_line(data = pmedf,
              aes(x = year,y = pmeato3),
              color = 'blue')+
    facet_wrap(~variable,nrow = 4)+
    theme_bw()
  
  # 
}
back_chose_within_boundury<-function(
  input_data
){
  
  # aim to back choosing the particles released in xinjiang Area
  sub_choose<-function(
    input_sub
  ){
    print(input_sub)
    
    df = fread(paste0(input_sub,'/alldates_output.csv'))
    # df = as.data.frame(df)
    # data_structure
    # c('long','lat','height','ep','type')
    
    # Calculation of total released in Xinjiang Extent
    shp_path = '/usr/local/flexpart_bk1/shp/Xinjiang_border.shp'
    xinjiang_shp = shapefile(shp_path)
    ## crop releasing zone
    dfc = df
    coordinates(dfc) = ~ long+lat
    proj4string(dfc) = "+proj=longlat +datum=WGS84 +no_defs"
    df_m = over(dfc,xinjiang_shp)
    df_index = which(!is.na(df_m[,1]))
    df_m = dfc[df_index,]
    df_xinjiang = as.data.frame(df_m,xy = T)
    #back chosing id
    id_inzone = unique(df_xinjiang$type)
    rm(df_xinjiang)
    rm(df_m)
    rm(dfc)
    
    
    
    gc()
    print('Accomplish first gc')
    
    group_id_vector<-function(x){
      step = round(length(x) /100)
      ids = seq(1,length(x),step)
      ide = ids -1
      ide = ide[-1]
      ide = c(ide,length(x))
      xl = list()
      for(i in 1:length(ids)){
        stmp = ids[i]
        etmp = ide[i]
        tmp = x[stmp:etmp]
        xl[[i]] = tmp
      }
      return(xl)
    }
    idl = group_id_vector(id_inzone)

    df_fullid <<- df$type
    back_chose_pal<-function(x){
      mats = min(which(df_fullid == x[1]))
      mate = max(which(df_fullid == x[length(x)]))
      
      df_sce <<- df_fullid[mats:mate]
      x<<-x
      back_chose_sec<-function(id){
        tmpid = which(df_sce == id)
        return(tmpid)
      }
      #print(x[1])
      ret_id = lapply(x,back_chose_sec)
      
      ret_id = do.call('c',ret_id)
      #cl = makeCluster(3)
      #clusterExport(cl,c('df_sce','x'))
      #system.time(
      #  ret_id <- parLapply(cl,x,back_chose_sec)
      #)
      #stopCluster(cl)
      #ret_id = do.call('c',ret_id)
      #print(mats)
      ret_id = ret_id+mats-1
      return(ret_id)
    }
  
    system.time(whole_id <- lapply(idl,back_chose_pal))
    whole_id = do.call('c',whole_id)
    
    gc()
    print('Accomplish second gc ')
    
    df_released_inxinjiang = df[whole_id,]
    rm(df)
    output = paste0(input_sub,'/df_released_inxinjiang.csv')
    fwrite(df_released_inxinjiang,output)
  }
  
  sapply(input_data,sub_choose)
}
better_cluster_determine<-function(
  
){
  # month 1:12
  input_data = list.files('/media/sdb1/xinjiang_output_file',full.names = T)[1:12]
  
  input_data = paste0(input_data,'/output')
  
  sub_better<-function(input_sub){
    print(input_sub)
    con_names = c('as','xj','eu','naf','na')
    input_land = paste0(input_sub,'/contr_released_land')
    input_land = paste0(input_land,'/',con_names,'.csv')
    
    input_land <<- input_land
    cluster_better_con_fun<-function(i){
      library(factoextra)
      library(vegan)
      library(data.table)
      if(file.exists(input_land[i])){
        tmpdf = fread(input_land[i])
        if(nrow(tmpdf)>15){
          tmpdf = as.data.frame(tmpdf)
          loc = tmpdf[,1:2]
          ca_clust = cascadeKM(loc,1,15,iter = 100)
          cal_best = as.numeric(which.max(ca_clust$results[2,]))
          cluster_best_con = cal_best
        }else{
          tmpdf = as.data.frame(tmpdf)
          cluster_best_con = 1
        }
        
      }else{
        cluster_best_con = NA
      }
      return(cluster_best_con)
    }
    
    i = 1:length(input_land)
    i <<- i
    
    library(doParallel)
    cl = makeCluster(5)
    clusterExport(cl,c('input_land','i'))
    system.time(ret_con <- parLapply(cl,i,cluster_better_con_fun))
    stopCluster(cl)
    
    ret_con = do.call('c',ret_con)
    
    
    
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    input_oce = paste0(input_sub,'/contr_released_ocean')
    input_oce = paste0(input_oce,'/',oce_names,'.csv')
    input_oce <<- input_oce
    
    cluster_best_oce_fun<-function(i){
      library(factoextra)
      library(vegan)
      library(data.table)
      if(file.exists(input_oce[i])){
        tmpdf = fread(input_oce[i])
        if(nrow(tmpdf)>15){
          tmpdf = as.data.frame(tmpdf)
          loc = tmpdf[,1:2]
          ca_clust = cascadeKM(loc,1,15,iter = 100)
          cal_best = as.numeric(which.max(ca_clust$results[2,]))
          cluster_best_oce = cal_best 
        }else{
          tmpdf = as.data.frame(tmpdf)
          cluster_best_oce = 1
        }
        
      }else{
        cluster_best_oce = NA
      }
      return(cluster_best_oce)
    }
    
    i = 1:length(input_oce)
    i <<- i 
    
    library(doParallel)
    cl = makeCluster(8)
    clusterExport(cl,c('input_oce','i'))
    system.time(ret_oce <- parLapply(cl,i,cluster_best_oce_fun))
    stopCluster(cl)
    
    ret_oce = do.call('c',ret_oce)
    
    ret = c(ret_oce,ret_con)
    return(ret)
  }
  
  better_cluster = lapply(input_data,sub_better)
  
  better_cluster = do.call('cbind',better_cluster)
  
  return(better_cluster)
}
bias_correct_cmip6_pme_trend_backup <- function(
  
){
  # import cmip6 pme
  input_pme = 'analysis_output/cmip6_by_model/pme'
  files = list.files(input_pme,
                     full.names = T)
  
  pme3ssp245 = as.data.frame(
    fread(files[3])
  )
  pme3ssp585 = as.data.frame(
    fread(files[4])
  )
  
  loc201706 = length(2003:2017)*12-6
  pme3ssp245 = pme3ssp245[1:180,]
  pme3ssp585 = pme3ssp585[1:180,]
  
  models = colnames(pme3ssp245)
  
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:180,]
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:180,]
  
  era5_pme = pe_in_source[,c(7)] - pet_sum[,c(7)]
  #era5_pme = pe_in_source[,c(5)] - pet_sum[,c(5)]
  
  era5_pme = as.matrix(era5_pme)
  era5_pme = era5_pme[1:180,]
  
  output_bc_cmip6 = 'analysis_output/bc_cmip6_fut'
  dir.create(output_bc_cmip6)
  output_train = paste0(output_bc_cmip6,'/train')
  output_test = paste0(output_bc_cmip6,'/test')
  output_diff = paste0(output_bc_cmip6,'/diff')
  output_coeff =  paste0(output_bc_cmip6,'/coeff')
  output_full = paste0(output_bc_cmip6,'/fullinorder')
  
  dir.create(output_train)
  dir.create(output_test)
  dir.create(output_diff)
  dir.create(output_coeff)
  dir.create(output_full)
  
  output_train245 = paste0(output_train,'/ssp245/')
  output_test245 = paste0(output_test,'/ssp245/')
  output_diff245 = paste0(output_diff,'/ssp245/')
  output_coeff245 = paste0(output_coeff,'/ssp245/')
  output_full245 = paste0(output_full,'/ssp245/')
  
  dir.create(output_train245)
  dir.create(output_test245)
  dir.create(output_diff245)
  dir.create(output_coeff245)
  dir.create(output_full245)
  
  output_train245 = paste0(output_train245,'/train.csv')
  output_test245 = paste0(output_test245,'/test.csv')
  output_diff245 = paste0(output_diff245,'/diff.csv')
  output_coeff245 = paste0(output_coeff245,'/coeff.csv')
  output_full245 = paste0(output_full245,'/full.csv')
  
  output_train585 = paste0(output_train,'/ssp585/')
  output_test585 = paste0(output_test,'/ssp585/')
  output_diff585 = paste0(output_diff,'/ssp585/')
  output_coeff585 = paste0(output_coeff,'/ssp585/')
  output_full585 = paste0(output_full,'/ssp585/')
  
  dir.create(output_train585)
  dir.create(output_test585)
  dir.create(output_diff585)
  dir.create(output_coeff585)
  dir.create(output_full585)
  
  
  output_train585 = paste0(output_train585,'/train.csv')
  output_test585 = paste0(output_test585,'/test.csv')
  output_diff585 = paste0(output_diff585,'/diff.csv')
  output_coeff585 = paste0(output_coeff585,'/coeff.csv')
  output_full585 = paste0(output_full585,'/full.csv')
  
  trend_stand <- function(x){
    x = ts(x,start =c(2003,1),frequency = 12)
    x = decompose(x)$trend
    
    x = x[-which(is.na(x))]
    x = (x-mean(x))/(max(x)-min(x))
    return(x)      
  }
  era5_full = era5_pme
  era5_pme  = trend_stand(era5_pme)
  
  pmemean = apply(pme3ssp245,1,mean)
  
  
  bias_correct245 <- function(){
    tmp = pme3ssp245
    #tmp = as.numeric(tmp) 
    #tmp= trend_stand(tmp)
    tmp = apply(tmp,2,trend_stand)
    tmp = as.data.frame(tmp)
    colnames(tmp) = paste0('m',1:8)
    
    set.seed(4321)
    trainid = sample(168,
                     135,replace = FALSE)
    
    #trainid = 1:135
    tmpcal = tmp[trainid,]
    tmpval = tmp[-trainid,]
    
    era5_train = era5_pme[trainid]
    era5_test = era5_pme[-trainid]
    
    
    tmpb = lm(era5_train~tmpcal$m1+
                tmpcal$m2+tmpcal$m3+tmpcal$m4+tmpcal$m5+
                tmpcal$m6+tmpcal$m7+tmpcal$m8)
    tmpb2 = lm(era5_train~tmpcal$m1+tmpcal$m5+tmpcal$m8)
    
    a = tmpb$coefficients[1]
    b1 = tmpb$coefficients[2]
    b2 = tmpb$coefficients[3]
    b3 = tmpb$coefficients[4]
    b4 = tmpb$coefficients[5]
    b5 = tmpb$coefficients[6]
    b6 = tmpb$coefficients[7]
    b7 = tmpb$coefficients[8]
    b8 = tmpb$coefficients[9]
    
    
    retdf = data.frame(
      a = a,
      b1 = b1,
      b2 = b2,
      b3 = b3,
      b4 = b4,
      b5 = b5,
      b6 = b6,
      b7 = b7,
      b8 = b8
    )
    
    proj_test = a+b1*tmpval$m1+b2*tmpval$m2+
      b3*tmpval$m3+b4*tmpval$m4+b5*tmpval$m5+
      b6*tmpval$m6+b7*tmpval$m7+b8*tmpval$m8
    
    rettest = cbind(era5_test,proj_test)
    rettrain = cbind(era5_train,tmpb$fitted.values)
    
    #plot(rettest)
    fwrite(rettrain,output_train245)
    fwrite(rettest,output_test245)
    fwrite(retdf,output_coeff245)
    
    #trainid = round(runif(135,1,168))
    #trainid = 1:135
    #tmpcal = tmp[trainid,]
    tmpval = tmp
    era5_test = era5_pme
    
    proj_testin = a+b1*tmpval$m1+b2*tmpval$m2+
      b3*tmpval$m3+b4*tmpval$m4+b5*tmpval$m5+
      b6*tmpval$m6+b7*tmpval$m7+b8*tmpval$m8
    ret_fullin = cbind(era5_test,proj_testin)
    matplot(ret_fullin)
    fwrite(ret_fullin,output_full245)
    
  }
  bias_correct585 <- function(){
    tmp = pme3ssp585
    #tmp = as.numeric(tmp) 
    #tmp= trend_stand(tmp)
    tmp = apply(tmp,2,trend_stand)
    tmp = as.data.frame(tmp)
    colnames(tmp) = paste0('m',1:8)
    
    set.seed(4321)
    trainid = sample(168,
                     135,replace = FALSE)
    #trainid = 1:135
    tmpcal = tmp[trainid,]
    tmpval = tmp[-trainid,]
    
    era5_train = era5_pme[trainid]
    era5_test = era5_pme[-trainid]
    
    
    tmpb = lm(era5_train~tmpcal$m1+
                tmpcal$m2+tmpcal$m3+tmpcal$m4+tmpcal$m5+
                tmpcal$m6+tmpcal$m7+tmpcal$m8)
    
    a = tmpb$coefficients[1]
    b1 = tmpb$coefficients[2]
    b2 = tmpb$coefficients[3]
    b3 = tmpb$coefficients[4]
    b4 = tmpb$coefficients[5]
    b5 = tmpb$coefficients[6]
    b6 = tmpb$coefficients[7]
    b7 = tmpb$coefficients[8]
    b8 = tmpb$coefficients[9]
    
    
    retdf = data.frame(
      a = a,
      b1 = b1,
      b2 = b2,
      b3 = b3,
      b4 = b4,
      b5 = b5,
      b6 = b6,
      b7 = b7,
      b8 = b8
    )
    
    proj_test = a+b1*tmpval$m1+b2*tmpval$m2+
      b3*tmpval$m3+b4*tmpval$m4+b5*tmpval$m5+
      b6*tmpval$m6+b7*tmpval$m7+b8*tmpval$m8
    
    rettest = cbind(era5_test,proj_test)
    rettrain = cbind(era5_train,tmpb$fitted.values)
    
    #plot(rettest)
    fwrite(rettrain,output_train585)
    fwrite(rettest,output_test585)
    fwrite(retdf,output_coeff585)
    
    #trainid = round(runif(135,1,168))
    #trainid = 1:135
    #tmpcal = tmp[trainid,]
    tmpval = tmp
    era5_test = era5_pme
    
    proj_testin = a+b1*tmpval$m1+b2*tmpval$m2+
      b3*tmpval$m3+b4*tmpval$m4+b5*tmpval$m5+
      b6*tmpval$m6+b7*tmpval$m7+b8*tmpval$m8
    ret_fullin = cbind(era5_test,proj_testin)
    matplot(ret_fullin)
    
    
    fwrite(ret_fullin,output_full585)
  }
  
  
  bias_correct245()
  bias_correct585()
  
  
  
  
}
bias_correct_cmip6_pme_trend <- function(
  
){
  # import cmip6 pme
  input_pme = 'analysis_output/cmip6_by_model/pme'
  files = list.files(input_pme,
                     full.names = T)
  
  pme3ssp245 = as.data.frame(
    fread(files[3])
  )
  pme3ssp585 = as.data.frame(
    fread(files[4])
  )
  
  loc201706 = length(2003:2017)*12-6
  pme3ssp245 = pme3ssp245[1:180,]
  pme3ssp585 = pme3ssp585[1:180,]
  
  models = colnames(pme3ssp245)
  
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:180,]
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:180,]
  
  era5_pme = pe_in_source[,c(7)] - pet_sum[,c(7)]
  #era5_pme = pe_in_source[,c(5)] - pet_sum[,c(5)]
  
  era5_pme = as.matrix(era5_pme)
  era5_pme = era5_pme[1:180,]
  
  output_bc_cmip6 = 'analysis_output/bc_cmip6_fut'
  dir.create(output_bc_cmip6)
  output_train = paste0(output_bc_cmip6,'/train')
  output_test = paste0(output_bc_cmip6,'/test')
  output_diff = paste0(output_bc_cmip6,'/diff')
  output_coeff =  paste0(output_bc_cmip6,'/coeff')
  output_full = paste0(output_bc_cmip6,'/fullinorder')
  
  dir.create(output_train)
  dir.create(output_test)
  dir.create(output_diff)
  dir.create(output_coeff)
  dir.create(output_full)
  
  output_train245 = paste0(output_train,'/ssp245/')
  output_test245 = paste0(output_test,'/ssp245/')
  output_diff245 = paste0(output_diff,'/ssp245/')
  output_coeff245 = paste0(output_coeff,'/ssp245/')
  output_full245 = paste0(output_full,'/ssp245/')
  
  dir.create(output_train245)
  dir.create(output_test245)
  dir.create(output_diff245)
  dir.create(output_coeff245)
  dir.create(output_full245)
  
  output_train245 = paste0(output_train245,'/train.csv')
  output_test245 = paste0(output_test245,'/test.csv')
  output_diff245 = paste0(output_diff245,'/diff.csv')
  output_coeff245 = paste0(output_coeff245,'/coeff.csv')
  output_full245 = paste0(output_full245,'/full.csv')
  
  output_train585 = paste0(output_train,'/ssp585/')
  output_test585 = paste0(output_test,'/ssp585/')
  output_diff585 = paste0(output_diff,'/ssp585/')
  output_coeff585 = paste0(output_coeff,'/ssp585/')
  output_full585 = paste0(output_full,'/ssp585/')
  
  dir.create(output_train585)
  dir.create(output_test585)
  dir.create(output_diff585)
  dir.create(output_coeff585)
  dir.create(output_full585)
  
  
  output_train585 = paste0(output_train585,'/train.csv')
  output_test585 = paste0(output_test585,'/test.csv')
  output_diff585 = paste0(output_diff585,'/diff.csv')
  output_coeff585 = paste0(output_coeff585,'/coeff.csv')
  output_full585 = paste0(output_full585,'/full.csv')
  
  trend_stand <- function(x){
    x = ts(x,start =c(2003,1),frequency = 12)
    x = decompose(x)$trend
    
    x = x[-which(is.na(x))]
    x = (x-mean(x))/(max(x)-min(x))
    return(x)      
  }
  era5_full = era5_pme
  era5_pme  = trend_stand(era5_pme)
  
  pmemean = apply(pme3ssp245,1,mean)
  
  
  bias_correct245 <- function(){
    tmp = pme3ssp245
    #tmp = as.numeric(tmp) 
    #tmp= trend_stand(tmp)
    tmp = apply(tmp,2,trend_stand)
    tmp = as.data.frame(tmp)
    colnames(tmp) = paste0('m',1:8)
    
    set.seed(4321)
    trainid = sample(168,
                     135,replace = FALSE)
    
    #trainid = 1:135
    tmpcal = tmp[trainid,]
    tmpval = tmp[-trainid,]
    
    era5_train = era5_pme[trainid]
    era5_test = era5_pme[-trainid]
    
    
    tmpb = lm(era5_train~tmpcal$m1+
                   tmpcal$m2+tmpcal$m3+tmpcal$m4+tmpcal$m5+
                   tmpcal$m6+tmpcal$m7+tmpcal$m8)
    tmpb2 = lm(era5_train~tmpcal$m1+tmpcal$m5+tmpcal$m8)
    
    a = tmpb2$coefficients[1]
    b1 = tmpb2$coefficients[2]
    b2 = tmpb2$coefficients[3]
    b3 = tmpb2$coefficients[4]
    
    
    retdf = data.frame(
      a = a,
      b1 = b1,
      b2 = b2,
      b3 = b3
    )
    
    proj_test = a+b1*tmpval$m1+b2*tmpval$m5+
      b3*tmpval$m8
    
    rettest = cbind(era5_test,proj_test)
    rettrain = cbind(era5_train,tmpb2$fitted.values)
    
    #plot(rettest)
    fwrite(rettrain,output_train245)
    fwrite(rettest,output_test245)
    fwrite(retdf,output_coeff245)
    
    #trainid = round(runif(135,1,168))
    #trainid = 1:135
    #tmpcal = tmp[trainid,]
    tmpval = tmp
    era5_test = era5_pme
    
    proj_testin = a+b1*tmpval$m1+b2*tmpval$m5+
      b3*tmpval$m8
    ret_fullin = cbind(era5_test,proj_testin)
    matplot(ret_fullin)
  }
  bias_correct585 <- function(){
    tmp = pme3ssp585
    #tmp = as.numeric(tmp) 
    #tmp= trend_stand(tmp)
    tmp = apply(tmp,2,trend_stand)
    tmp = as.data.frame(tmp)
    colnames(tmp) = paste0('m',1:8)
    
    set.seed(4321)
    trainid = sample(168,
                     135,replace = FALSE)
    #trainid = 1:135
    tmpcal = tmp[trainid,]
    tmpval = tmp[-trainid,]
    
    era5_train = era5_pme[trainid]
    era5_test = era5_pme[-trainid]
    
    
    tmpb = lm(era5_train~tmpcal$m1+
                tmpcal$m2+tmpcal$m3+tmpcal$m4+tmpcal$m5+
                tmpcal$m6+tmpcal$m7+tmpcal$m8)
    tmpb2 = lm(era5_train~
                 tmpcal$m2+tmpcal$m3+tmpcal$m6)
    
    a = tmpb2$coefficients[1]
    b1 = tmpb2$coefficients[2]
    b2 = tmpb2$coefficients[3]
    b3 = tmpb2$coefficients[4]
    
    
    retdf = data.frame(
      a = a,
      b1 = b1,
      b2 = b2,
      b3 = b3
    )
    
    proj_test = a+b1*tmpval$m2+b2*tmpval$m3+
      b3*tmpval$m6
    
    rettest = cbind(era5_test,proj_test)
    rettrain = cbind(era5_train,tmpb2$fitted.values)
    
    #plot(rettest)
    fwrite(rettrain,output_train585)
    fwrite(rettest,output_test585)
    fwrite(retdf,output_coeff585)
    
    #trainid = round(runif(135,1,168))
    #trainid = 1:135
    #tmpcal = tmp[trainid,]
    tmpval = tmp
    era5_test = era5_pme
    
    proj_testin = a+b1*tmpval$m2+b2*tmpval$m3+
      b3*tmpval$m6
    ret_fullin = cbind(era5_test,proj_testin)
    matplot(ret_fullin)
    
    fwrite(ret_fullin,output_full585)
  }
  
  
  bias_correct245()
  bias_correct585()
  

  
  
}
bias_correct_cmip6_pme_trend1_backup <- function(
  
){
  # import cmip6 pme
  input_pme = 'analysis_output/cmip6_by_model/pme'
  files = list.files(input_pme,
                     full.names = T)
  
  pme3ssp245 = as.data.frame(
    fread(files[1])
  )
  pme3ssp585 = as.data.frame(
    fread(files[2])
  )
  
  loc201706 = length(2003:2017)*12-6
  pme3ssp245 = pme3ssp245[1:180,]
  pme3ssp585 = pme3ssp585[1:180,]
  
  models = colnames(pme3ssp245)
  
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:180,]
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:180,]
  
  era5_pme = pe_in_source[,c(5)] - pet_sum[,c(5)]
  #era5_pme = pe_in_source[,c(5)] - pet_sum[,c(5)]
  
  era5_pme = as.matrix(era5_pme)
  era5_pme = era5_pme[1:180,]
  
  output_bc_cmip6 = 'analysis_output/bc_cmip6_fut_reg1'
  dir.create(output_bc_cmip6)
  output_train = paste0(output_bc_cmip6,'/train')
  output_test = paste0(output_bc_cmip6,'/test')
  output_diff = paste0(output_bc_cmip6,'/diff')
  output_coeff =  paste0(output_bc_cmip6,'/coeff')
  output_full = paste0(output_bc_cmip6,'/fullinorder')
  
  dir.create(output_train)
  dir.create(output_test)
  dir.create(output_diff)
  dir.create(output_coeff)
  dir.create(output_full)
  
  output_train245 = paste0(output_train,'/ssp245/')
  output_test245 = paste0(output_test,'/ssp245/')
  output_diff245 = paste0(output_diff,'/ssp245/')
  output_coeff245 = paste0(output_coeff,'/ssp245/')
  output_full245 = paste0(output_full,'/ssp245/')
  
  dir.create(output_train245)
  dir.create(output_test245)
  dir.create(output_diff245)
  dir.create(output_coeff245)
  dir.create(output_full245)
  
  output_train245 = paste0(output_train245,'/train.csv')
  output_test245 = paste0(output_test245,'/test.csv')
  output_diff245 = paste0(output_diff245,'/diff.csv')
  output_coeff245 = paste0(output_coeff245,'/coeff.csv')
  output_full245 = paste0(output_full245,'/full.csv')
  
  output_train585 = paste0(output_train,'/ssp585/')
  output_test585 = paste0(output_test,'/ssp585/')
  output_diff585 = paste0(output_diff,'/ssp585/')
  output_coeff585 = paste0(output_coeff,'/ssp585/')
  output_full585 = paste0(output_full,'/ssp585/')
  
  dir.create(output_train585)
  dir.create(output_test585)
  dir.create(output_diff585)
  dir.create(output_coeff585)
  dir.create(output_full585)
  
  
  output_train585 = paste0(output_train585,'/train.csv')
  output_test585 = paste0(output_test585,'/test.csv')
  output_diff585 = paste0(output_diff585,'/diff.csv')
  output_coeff585 = paste0(output_coeff585,'/coeff.csv')
  output_full585 = paste0(output_full585,'/full.csv')
  
  trend_stand <- function(x){
    x = ts(x,start =c(2003,1),frequency = 12)
    x = decompose(x)$trend
    
    x = x[-which(is.na(x))]
    x = (x-mean(x))/(max(x)-min(x))
    return(x)      
  }
  era5_full = era5_pme
  era5_pme  = trend_stand(era5_pme)
  
  pmemean = apply(pme3ssp245,1,mean)
  
  
  bias_correct245 <- function(){
    tmp = pme3ssp245
    #tmp = as.numeric(tmp) 
    #tmp= trend_stand(tmp)
    tmp = apply(tmp,2,trend_stand)
    tmp = as.data.frame(tmp)
    colnames(tmp) = paste0('m',1:8)
    
    set.seed(4321)
    trainid = sample(168,
                     135,replace = FALSE)
    #trainid = 1:135
    tmpcal = tmp[trainid,]
    tmpval = tmp[-trainid,]
    
    era5_train = era5_pme[trainid]
    era5_test = era5_pme[-trainid]
    
    
    tmpb = lm(era5_train~tmpcal$m1+
                tmpcal$m2+tmpcal$m3+tmpcal$m4+tmpcal$m5+
                tmpcal$m6+tmpcal$m7+tmpcal$m8)
    
    a = tmpb$coefficients[1]
    b1 = tmpb$coefficients[2]
    b2 = tmpb$coefficients[3]
    b3 = tmpb$coefficients[4]
    b4 = tmpb$coefficients[5]
    b5 = tmpb$coefficients[6]
    b6 = tmpb$coefficients[7]
    b7 = tmpb$coefficients[8]
    b8 = tmpb$coefficients[9]
    
    
    retdf = data.frame(
      a = a,
      b1 = b1,
      b2 = b2,
      b3 = b3,
      b4 = b4,
      b5 = b5,
      b6 = b6,
      b7 = b7,
      b8 = b8
    )
    
    proj_test = a+b1*tmpval$m1+b2*tmpval$m2+
      b3*tmpval$m3+b4*tmpval$m4+b5*tmpval$m5+
      b6*tmpval$m6+b7*tmpval$m7+b8*tmpval$m8
    
    rettest = cbind(era5_test,proj_test)
    rettrain = cbind(era5_train,tmpb$fitted.values)
    
    #plot(rettest)
    fwrite(rettrain,output_train245)
    fwrite(rettest,output_test245)
    fwrite(retdf,output_coeff245)
    
    #trainid = round(runif(135,1,168))
    #trainid = 1:135
    #tmpcal = tmp[trainid,]
    tmpval = tmp
    era5_test = era5_pme
    
    proj_testin = a+b1*tmpval$m1+b2*tmpval$m2+
      b3*tmpval$m3+b4*tmpval$m4+b5*tmpval$m5+
      b6*tmpval$m6+b7*tmpval$m7+b8*tmpval$m8
    ret_fullin = cbind(era5_test,proj_testin)
    matplot(ret_fullin)
    fwrite(ret_fullin,output_full245)
    
  }
  bias_correct585 <- function(){
    tmp = pme3ssp585
    #tmp = as.numeric(tmp) 
    #tmp= trend_stand(tmp)
    tmp = apply(tmp,2,trend_stand)
    tmp = as.data.frame(tmp)
    colnames(tmp) = paste0('m',1:8)
    
    set.seed(4321)
    trainid = sample(168,
                     135,replace = FALSE)
    #trainid = 1:135
    tmpcal = tmp[trainid,]
    tmpval = tmp[-trainid,]
    
    era5_train = era5_pme[trainid]
    era5_test = era5_pme[-trainid]
    
    
    tmpb = lm(era5_train~tmpcal$m1+
                tmpcal$m2+tmpcal$m3+tmpcal$m4+tmpcal$m5+
                tmpcal$m6+tmpcal$m7+tmpcal$m8)
    
    a = tmpb$coefficients[1]
    b1 = tmpb$coefficients[2]
    b2 = tmpb$coefficients[3]
    b3 = tmpb$coefficients[4]
    b4 = tmpb$coefficients[5]
    b5 = tmpb$coefficients[6]
    b6 = tmpb$coefficients[7]
    b7 = tmpb$coefficients[8]
    b8 = tmpb$coefficients[9]
    
    
    retdf = data.frame(
      a = a,
      b1 = b1,
      b2 = b2,
      b3 = b3,
      b4 = b4,
      b5 = b5,
      b6 = b6,
      b7 = b7,
      b8 = b8
    )
    
    proj_test = a+b1*tmpval$m1+b2*tmpval$m2+
      b3*tmpval$m3+b4*tmpval$m4+b5*tmpval$m5+
      b6*tmpval$m6+b7*tmpval$m7+b8*tmpval$m8
    
    rettest = cbind(era5_test,proj_test)
    rettrain = cbind(era5_train,tmpb$fitted.values)
    
    #plot(rettest)
    fwrite(rettrain,output_train585)
    fwrite(rettest,output_test585)
    fwrite(retdf,output_coeff585)
    
    #trainid = round(runif(135,1,168))
    #trainid = 1:135
    #tmpcal = tmp[trainid,]
    tmpval = tmp
    era5_test = era5_pme
    
    proj_testin = a+b1*tmpval$m1+b2*tmpval$m2+
      b3*tmpval$m3+b4*tmpval$m4+b5*tmpval$m5+
      b6*tmpval$m6+b7*tmpval$m7+b8*tmpval$m8
    ret_fullin = cbind(era5_test,proj_testin)
    matplot(ret_fullin)
    
    
    fwrite(ret_fullin,output_full585)
  }
  
  
  bias_correct245()
  bias_correct585()
  
  
  
  
}
bias_correct_cmip6_pme_trend1 <- function(
  
){
  # import cmip6 pme
  input_pme = 'analysis_output/cmip6_by_model/pme'
  files = list.files(input_pme,
                     full.names = T)
  
  pme3ssp245 = as.data.frame(
    fread(files[1])
  )
  pme3ssp585 = as.data.frame(
    fread(files[2])
  )
  
  loc201706 = length(2003:2017)*12-6
  pme3ssp245 = pme3ssp245[1:180,]
  pme3ssp585 = pme3ssp585[1:180,]
  
  models = colnames(pme3ssp245)
  
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:180,]
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:180,]
  
  era5_pme = pe_in_source[,c(5)] - pet_sum[,c(5)]
  #era5_pme = pe_in_source[,c(5)] - pet_sum[,c(5)]
  
  era5_pme = as.matrix(era5_pme)
  era5_pme = era5_pme[1:180,]
  
  output_bc_cmip6 = 'analysis_output/bc_cmip6_fut_reg1'
  dir.create(output_bc_cmip6)
  output_train = paste0(output_bc_cmip6,'/train')
  output_test = paste0(output_bc_cmip6,'/test')
  output_diff = paste0(output_bc_cmip6,'/diff')
  output_coeff =  paste0(output_bc_cmip6,'/coeff')
  output_full = paste0(output_bc_cmip6,'/fullinorder')
  
  dir.create(output_train)
  dir.create(output_test)
  dir.create(output_diff)
  dir.create(output_coeff)
  dir.create(output_full)
  
  output_train245 = paste0(output_train,'/ssp245/')
  output_test245 = paste0(output_test,'/ssp245/')
  output_diff245 = paste0(output_diff,'/ssp245/')
  output_coeff245 = paste0(output_coeff,'/ssp245/')
  output_full245 = paste0(output_full,'/ssp245/')
  
  dir.create(output_train245)
  dir.create(output_test245)
  dir.create(output_diff245)
  dir.create(output_coeff245)
  dir.create(output_full245)
  
  output_train245 = paste0(output_train245,'/train.csv')
  output_test245 = paste0(output_test245,'/test.csv')
  output_diff245 = paste0(output_diff245,'/diff.csv')
  output_coeff245 = paste0(output_coeff245,'/coeff.csv')
  output_full245 = paste0(output_full245,'/full.csv')
  
  output_train585 = paste0(output_train,'/ssp585/')
  output_test585 = paste0(output_test,'/ssp585/')
  output_diff585 = paste0(output_diff,'/ssp585/')
  output_coeff585 = paste0(output_coeff,'/ssp585/')
  output_full585 = paste0(output_full,'/ssp585/')
  
  dir.create(output_train585)
  dir.create(output_test585)
  dir.create(output_diff585)
  dir.create(output_coeff585)
  dir.create(output_full585)
  
  
  output_train585 = paste0(output_train585,'/train.csv')
  output_test585 = paste0(output_test585,'/test.csv')
  output_diff585 = paste0(output_diff585,'/diff.csv')
  output_coeff585 = paste0(output_coeff585,'/coeff.csv')
  output_full585 = paste0(output_full585,'/full.csv')
  
  trend_stand <- function(x){
    x = ts(x,start =c(2003,1),frequency = 12)
    x = decompose(x)$trend
    
    x = x[-which(is.na(x))]
    x = (x-mean(x))/(max(x)-min(x))
    return(x)      
  }
  era5_full = era5_pme
  era5_pme  = trend_stand(era5_pme)
  
  pmemean = apply(pme3ssp245,1,mean)
  
  
  bias_correct245 <- function(){
    tmp = pme3ssp245
    #tmp = as.numeric(tmp) 
    #tmp= trend_stand(tmp)
    tmp = apply(tmp,2,trend_stand)
    tmp = as.data.frame(tmp)
    colnames(tmp) = paste0('m',1:8)
    
    set.seed(4321)
    trainid = sample(168,
                     135,replace = FALSE)
    #trainid = 1:135
    tmpcal = tmp[trainid,]
    tmpval = tmp[-trainid,]
    
    era5_train = era5_pme[trainid]
    era5_test = era5_pme[-trainid]
    
    
    tmpb = lm(era5_train~tmpcal$m1+
                tmpcal$m2+tmpcal$m3+tmpcal$m4+tmpcal$m5+
                tmpcal$m6+tmpcal$m7+tmpcal$m8)
    tmpb2 = lm(era5_train~tmpcal$m1+
                tmpcal$m2+tmpcal$m3)
    
    a = tmpb2$coefficients[1]
    b1 = tmpb2$coefficients[2]
    b2 = tmpb2$coefficients[3]
    b3 = tmpb2$coefficients[4]
    
    
    retdf = data.frame(
      a = a,
      b1 = b1,
      b2 = b2,
      b3 = b3
    )
    
    proj_test = a+b1*tmpval$m1+b2*tmpval$m2+
      b3*tmpval$m3
    
    rettest = cbind(era5_test,proj_test)
    rettrain = cbind(era5_train,tmpb2$fitted.values)
    
    #plot(rettest)
    fwrite(rettrain,output_train245)
    fwrite(rettest,output_test245)
    fwrite(retdf,output_coeff245)
    
    #trainid = round(runif(135,1,168))
    #trainid = 1:135
    #tmpcal = tmp[trainid,]
    tmpval = tmp
    era5_test = era5_pme
    
    proj_testin = a+b1*tmpval$m1+b2*tmpval$m2+
      b3*tmpval$m3
    ret_fullin = cbind(era5_test,proj_testin)
    matplot(ret_fullin)
    fwrite(ret_fullin,output_full245)
    
  }
  bias_correct585 <- function(){
    tmp = pme3ssp585
    #tmp = as.numeric(tmp) 
    #tmp= trend_stand(tmp)
    tmp = apply(tmp,2,trend_stand)
    tmp = as.data.frame(tmp)
    colnames(tmp) = paste0('m',1:8)
    
    set.seed(4321)
    trainid = sample(168,
                     135,replace = FALSE)
    #trainid = 1:135
    tmpcal = tmp[trainid,]
    tmpval = tmp[-trainid,]
    
    era5_train = era5_pme[trainid]
    era5_test = era5_pme[-trainid]
    
    
    tmpb2 = lm(era5_train~tmpcal$m1+tmpcal$m3+
                tmpcal$m6)
    
    a = tmpb2$coefficients[1]
    b1 = tmpb2$coefficients[2]
    b2 = tmpb2$coefficients[3]
    b3 = tmpb2$coefficients[4]
    
    
    retdf = data.frame(
      a = a,
      b1 = b1,
      b2 = b2,
      b3 = b3
    )
    
    proj_test = a+b1*tmpval$m1+b2*tmpval$m3+
      b3*tmpval$m6
    
    rettest = cbind(era5_test,proj_test)
    rettrain = cbind(era5_train,tmpb2$fitted.values)
    
    #plot(rettest)
    fwrite(rettrain,output_train585)
    fwrite(rettest,output_test585)
    fwrite(retdf,output_coeff585)
    
    #trainid = round(runif(135,1,168))
    #trainid = 1:135
    #tmpcal = tmp[trainid,]
    tmpval = tmp
    era5_test = era5_pme
    
    proj_testin = a+b1*tmpval$m1+b2*tmpval$m3+
      b3*tmpval$m6
    ret_fullin = cbind(era5_test,proj_testin)
    matplot(ret_fullin)
    
    
    fwrite(ret_fullin,output_full585)
  }
  
  
  bias_correct245()
  bias_correct585()
  
  
  
  
}
bias_correct_cmip6_pme <- function(
  
){
  # import cmip6 pme
  input_pme = 'analysis_output/cmip6_by_model/pme'
  files = list.files(input_pme,
                     full.names = T)
  
  pme3ssp245 = as.data.frame(
    fread(files[3])
  )
  pme3ssp585 = as.data.frame(
    fread(files[4])
  )
  
  loc201706 = length(2003:2017)*12-6
  pme3ssp245 = pme3ssp245[1:180,]
  pme3ssp585 = pme3ssp585[1:180,]
  
  models = colnames(pme3ssp245)
  
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:180,]
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:180,]
  
  era5_pme = pe_in_source[,c(7)] - pet_sum[,c(7)]
  era5_pme = as.matrix(era5_pme)
  era5_pme = era5_pme[1:180,]
  
  output_bc_cmip6 = 'analysis_output/bc_cmip6'
  dir.create(output_bc_cmip6)
  output_train = paste0(output_bc_cmip6,'/train')
  output_test = paste0(output_bc_cmip6,'/test')
  output_diff = paste0(output_bc_cmip6,'/diff')
  output_coeff =  paste0(output_bc_cmip6,'/coeff')
  
  dir.create(output_train)
  dir.create(output_test)
  dir.create(output_diff)
  dir.create(output_coeff)
  
  output_train245 = paste0(output_train,'/ssp245/')
  output_test245 = paste0(output_test,'/ssp245/')
  output_diff245 = paste0(output_diff,'/ssp245/')
  output_coeff245 = paste0(output_coeff,'/ssp245/')
  
  dir.create(output_train245)
  dir.create(output_test245)
  dir.create(output_diff245)
  dir.create(output_coeff245)
  
  output_train245 = paste0(output_train245,'/',models,'.csv')
  output_test245 = paste0(output_test245,'/',models,'.csv')
  output_diff245 = paste0(output_diff245,'/',models,'.csv')
  output_coeff245 = paste0(output_coeff245,'/',models,'.csv')
  
  output_train585 = paste0(output_train,'/ssp585/')
  output_test585 = paste0(output_test,'/ssp585/')
  output_diff585 = paste0(output_diff,'/ssp585/')
  output_coeff585 = paste0(output_coeff,'/ssp585/')
  
  dir.create(output_train585)
  dir.create(output_test585)
  dir.create(output_diff585)
  dir.create(output_coeff585)
  
  output_train585 = paste0(output_train585,'/',models,'.csv')
  output_test585 = paste0(output_test585,'/',models,'.csv')
  output_diff585 = paste0(output_diff585,'/',models,'.csv')
  output_coeff585 = paste0(output_coeff585,'/',models,'.csv')
  
  
  trend_stand <- function(x){
    x = ts(x,start =c(2003,1),frequency = 12)
    x = decompose(x)$trend
    
    x = x[-which(is.na(x))]
    stx = (x-mean(x))/(max(x)-min(x))
    return(stx)      
  }
  
  bias_correct245 <- function(i){
    tmp = pme3ssp245[,i]
    tmp = as.numeric(tmp) 
    #tmp= trend_stand(tmp)
    
    tmptest = tmp[145:180]
    tmptrain = tmp[1:144]
    tmp = tmptrain
    
    era5_test = era5_pme[145:180]
    era5_train = era5_pme[1:144]
    #era5_pme = era5_train
    
    tmpb = lm(era5_train~tmp+I(tmp^2))
    
    matera5 = matrix(era5_train,
                     nrow = 12)
    matera5 = apply(matera5,1,mean,
                    na.rm = T)
    
    fits = tmpb$fitted.values
    matfits = matrix(fits,nrow = 12)
    matfits = apply(matfits,1,mean,
                    na.rm = T)
    
    matdiff = matera5 - matfits
    
    repdif = rep(matdiff,12)
    
    revfits = fits + repdif
    rettrain= cbind(era5_train,
                    revfits)
    fwrite(rettrain,output_train245[i])
    
    #matplot(cbind(revfits,))
    
    a = tmpb$coefficients[1]
    b = tmpb$coefficients[2]
    c = tmpb$coefficients[3]
    d = tmpb$coefficients[4]
    
    retdf = data.frame(
      a = a,
      b = b,
      c = c,
      d = d
    )
    
    proj_test = a+b*tmptest+c*I(tmptest^2)+
      d*I(tmptest^3)
    proj_test = proj_test + rep(matdiff,3)
    
    rettest = cbind(era5_test,proj_test)
    fwrite(rettest,output_test245[i])
    
    fwrite(retdf,output_coeff245[i])
    fwrite(data.frame(matdiff),output_diff245[i])
  }
  
  bias_correct585 <- function(i){
    tmp = pme3ssp585[,i]
    tmp = as.numeric(tmp) 
    
    tmptest = tmp[145:180]
    tmptrain = tmp[1:144]
    tmp = tmptrain
    
    era5_test = era5_pme[145:180]
    era5_train = era5_pme[1:144]
    #era5_pme = era5_train
    
    tmpb = lm(era5_train~tmp+I(tmp^2)+I(tmp^3))
    
    matera5 = matrix(era5_train,
                     nrow = 12)
    matera5 = apply(matera5,1,mean,
                    na.rm = T)
    
    fits = tmpb$fitted.values
    matfits = matrix(fits,nrow = 12)
    matfits = apply(matfits,1,mean,
                    na.rm = T)
    
    matdiff = matera5 - matfits
    
    repdif = rep(matdiff,12)
    
    revfits = fits + repdif
    rettrain= cbind(era5_train,
                    revfits)
    fwrite(rettrain,output_train585[i])
    
    #matplot(cbind(revfits,))
    
    a = tmpb$coefficients[1]
    b = tmpb$coefficients[2]
    c = tmpb$coefficients[3]
    d = tmpb$coefficients[4]
    
    retdf = data.frame(
      a = a,
      b = b,
      c = c,
      d = d
    )
    
    proj_test = a+b*tmptest+c*I(tmptest^2)+
      d*I(tmptest^3)
    proj_test = proj_test + rep(matdiff,3)
    
    rettest = cbind(era5_test,proj_test)
    fwrite(rettest,output_test585[i])
    
    fwrite(retdf,output_coeff585[i])
    fwrite(data.frame(matdiff),output_diff585[i])
  }
  
  i = 1:8
  lapply(i,bias_correct245)
  lapply(i,bias_correct585)
  
  
  
  
  
  
  
  
  
  
  
}
bias_correct_cmip6_pme1 <- function(
  
){
  # import cmip6 pme
  input_pme = 'analysis_output/cmip6_by_model/pme'
  files = list.files(input_pme,
                     full.names = T)
  
  pme3ssp245 = as.data.frame(
    fread(files[1])
  )
  pme3ssp585 = as.data.frame(
    fread(files[2])
  )
  
  loc201706 = length(2003:2017)*12-6
  pme3ssp245 = pme3ssp245[1:180,]
  pme3ssp585 = pme3ssp585[1:180,]
  
  models = colnames(pme3ssp245)
  
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:180,]
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:180,]
  
  era5_pme = pe_in_source[,c(7)] - pet_sum[,c(7)]
  era5_pme = as.matrix(era5_pme)
  era5_pme = era5_pme[1:180,]
  
  output_bc_cmip6 = 'analysis_output/bc_cmip6_region1'
  dir.create(output_bc_cmip6)
  output_train = paste0(output_bc_cmip6,'/train')
  output_test = paste0(output_bc_cmip6,'/test')
  output_diff = paste0(output_bc_cmip6,'/diff')
  output_coeff =  paste0(output_bc_cmip6,'/coeff')
  
  dir.create(output_train)
  dir.create(output_test)
  dir.create(output_diff)
  dir.create(output_coeff)
  
  output_train245 = paste0(output_train,'/ssp245/')
  output_test245 = paste0(output_test,'/ssp245/')
  output_diff245 = paste0(output_diff,'/ssp245/')
  output_coeff245 = paste0(output_coeff,'/ssp245/')
  
  dir.create(output_train245)
  dir.create(output_test245)
  dir.create(output_diff245)
  dir.create(output_coeff245)
  
  output_train245 = paste0(output_train245,'/',models,'.csv')
  output_test245 = paste0(output_test245,'/',models,'.csv')
  output_diff245 = paste0(output_diff245,'/',models,'.csv')
  output_coeff245 = paste0(output_coeff245,'/',models,'.csv')
  
  output_train585 = paste0(output_train,'/ssp585/')
  output_test585 = paste0(output_test,'/ssp585/')
  output_diff585 = paste0(output_diff,'/ssp585/')
  output_coeff585 = paste0(output_coeff,'/ssp585/')
  
  dir.create(output_train585)
  dir.create(output_test585)
  dir.create(output_diff585)
  dir.create(output_coeff585)
  
  output_train585 = paste0(output_train585,'/',models,'.csv')
  output_test585 = paste0(output_test585,'/',models,'.csv')
  output_diff585 = paste0(output_diff585,'/',models,'.csv')
  output_coeff585 = paste0(output_coeff585,'/',models,'.csv')
  
  
  bias_correct245 <- function(i){
    tmp = pme3ssp245[,i]
    tmp = as.numeric(tmp) 
    
    tmptest = tmp[145:180]
    tmptrain = tmp[1:144]
    tmp = tmptrain
    
    era5_test = era5_pme[145:180]
    era5_train = era5_pme[1:144]
    #era5_pme = era5_train
    
    tmpb = lm(era5_train~tmp+I(tmp^2)+I(tmp^3))
    
    matera5 = matrix(era5_train,
                     nrow = 12)
    matera5 = apply(matera5,1,mean,
                    na.rm = T)
    
    fits = tmpb$fitted.values
    matfits = matrix(fits,nrow = 12)
    matfits = apply(matfits,1,mean,
                    na.rm = T)
    
    matdiff = matera5 - matfits
    
    repdif = rep(matdiff,12)
    
    revfits = fits + repdif
    rettrain= cbind(era5_train,
                    revfits)
    fwrite(rettrain,output_train245[i])
    
    #matplot(cbind(revfits,))
    
    a = tmpb$coefficients[1]
    b = tmpb$coefficients[2]
    c = tmpb$coefficients[3]
    d = tmpb$coefficients[4]
    
    retdf = data.frame(
      a = a,
      b = b,
      c = c,
      d = d
    )
    
    proj_test = a+b*tmptest+c*I(tmptest^2)+
      d*I(tmptest^3)
    proj_test = proj_test + rep(matdiff,3)
    
    rettest = cbind(era5_test,proj_test)
    fwrite(rettest,output_test245[i])
    
    fwrite(retdf,output_coeff245[i])
    fwrite(data.frame(matdiff),output_diff245[i])
  }
  
  bias_correct585 <- function(i){
    tmp = pme3ssp585[,i]
    tmp = as.numeric(tmp) 
    
    tmptest = tmp[145:180]
    tmptrain = tmp[1:144]
    tmp = tmptrain
    
    era5_test = era5_pme[145:180]
    era5_train = era5_pme[1:144]
    #era5_pme = era5_train
    
    tmpb = lm(era5_train~tmp+I(tmp^2)+I(tmp^3))
    
    matera5 = matrix(era5_train,
                     nrow = 12)
    matera5 = apply(matera5,1,mean,
                    na.rm = T)
    
    fits = tmpb$fitted.values
    matfits = matrix(fits,nrow = 12)
    matfits = apply(matfits,1,mean,
                    na.rm = T)
    
    matdiff = matera5 - matfits
    
    repdif = rep(matdiff,12)
    
    revfits = fits + repdif
    rettrain= cbind(era5_train,
                    revfits)
    fwrite(rettrain,output_train585[i])
    
    #matplot(cbind(revfits,))
    
    a = tmpb$coefficients[1]
    b = tmpb$coefficients[2]
    c = tmpb$coefficients[3]
    d = tmpb$coefficients[4]
    
    retdf = data.frame(
      a = a,
      b = b,
      c = c,
      d = d
    )
    
    proj_test = a+b*tmptest+c*I(tmptest^2)+
      d*I(tmptest^3)
    proj_test = proj_test + rep(matdiff,3)
    
    rettest = cbind(era5_test,proj_test)
    fwrite(rettest,output_test585[i])
    
    fwrite(retdf,output_coeff585[i])
    fwrite(data.frame(matdiff),output_diff585[i])
  }
  
  i = 1:8
  lapply(i,bias_correct245)
  lapply(i,bias_correct585)
  
  
  source("/home/share/R_project/xinjiang_vapor/correct_fut_pme_region1.R")
  correct_fut_pme_region1()
  
  
  
  
  
  
  
  
}
cal_contri_rate<-function(
  input_data 
){
  library(raster)
  library(maps)
  library(maptools)
  library(ggplot2)
  library(reshape2)
  library(RColorBrewer)
  library(data.table)
  library(foreach)
  library(doParallel)
  library(parallel)
  library(snow)
  
  
  sub_cal_contri<-function(
    input_sub
  ){
    # import total relased in xinjiang 
    input_tr = paste0(input_sub,'/totoal_release_in_xinjiang') 
    input_tr = paste0(input_tr, '/total_released.csv')
    
    tr = read.csv(input_tr,header = T)
    tr = tr[1,2]
    
    # cal by oceans
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    
    input_path = paste0(input_sub,'/contr_ocean')
    input_ocean = paste0(input_path,'/',oce_names,'.csv')
    
    rate_ocean_b = 1
    for(i in 1:length(input_ocean)){
      tmp_df = fread(input_ocean[i])
      tmprate = sum(tmp_df$varep_insource)/tr
      tmprate_bp = tmp_df$varep_insource /tr
      
      
      tmp_df$contr_rate = tmprate_bp
      fwrite(tmp_df,input_ocean[i])
      
      rate_ocean_b = c(rate_ocean_b,tmprate)
    }
    rate_ocean_b = rate_ocean_b[-1]
    
    
    # cal by lands 
    con_names = c('as','xj','eu','naf','na')
    input_land = paste0(input_sub,'/contr_land')
    input_land = paste0(input_land,'/',con_names,'.csv')
    
    rate_land_b = 1
    for(i in 1:length(input_land)){
      tmp_df = fread(input_land[i])
      if(con_names[i] == 'xj'){
        tmprate = sum(tmp_df$varep_insource[which(tmp_df$varep_insource<0)])/tr
        tmprate = abs(tmprate)
        tmprate_bp = tmp_df$varep_insource /tr
        
      }else{
        tmprate = sum(tmp_df$varep_insource)/tr
        tmprate_bp = tmp_df$varep_insource /tr
        
      }
      
      tmp_df$contr_rate = tmprate_bp
      fwrite(tmp_df,input_land[i])
      
      rate_land_b = c(rate_land_b,tmprate)
    }
    rate_land_b = rate_land_b[-1]
    
    source_names = c(oce_names,con_names)
    rates = c(rate_ocean_b,rate_land_b)
    
    contr_df = data.frame(source_names,rates)
    
    output_contr = paste0(input_sub,'/contr_by_source')
    dir.create(output_contr)
    output_contr = paste0(output_contr,'/contri_each_source.csv')
    
    fwrite(contr_df,output_contr)
    
    
    
    
    
  }
  sapply(input_data,sub_cal_contri)
}
cal_contri_rate2<-function(
  input_data 
){
  library(raster)
  library(maps)
  library(maptools)
  library(ggplot2)
  library(reshape2)
  library(RColorBrewer)
  library(data.table)
  library(foreach)
  library(doParallel)
  library(parallel)
  library(snow)
  
  
  sub_cal_contri<-function(
    input_sub
  ){
    # import total relased in xinjiang 
    
    # cal by oceans
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    
    input_path = paste0(input_sub,'/contr_released_ocean')
    input_ocean = paste0(input_path,'/',oce_names,'.csv')
    
    rate_ocean_b = 1
    nid = 1
    for(i in 1:length(input_ocean)){
      if(file.exists(input_ocean[i])){
        tmp_df = fread(input_ocean[i])
        if(nrow(tmp_df)>0){
          tmprate = sum(tmp_df$contr_rate)
          rate_ocean_b = c(rate_ocean_b,tmprate)
          nid = c(nid,i)
        }
      }
    }
    rate_ocean_b = rate_ocean_b[-1]
    nid = nid[-1]
    oce_names = oce_names[nid]
    
    # cal by lands 
    con_names = c('as','xj','eu','naf','na')
    input_land = paste0(input_sub,'/contr_released_land')
    input_land = paste0(input_land,'/',con_names,'.csv')
    
    rate_land_b = 1
    nid = 1
    for(i in 1:length(input_land)){
      if(file.exists(input_land[i])){
        tmp_df = fread(input_land[i])
        if(nrow(tmp_df)>0){
          tmprate = sum(tmp_df$contr_rate)
          rate_land_b = c(rate_land_b,tmprate)  
          nid = c(nid,i)
        }  
      }
    }
    rate_land_b = rate_land_b[-1]
    nid =nid[-1]
    con_names = con_names[nid]
    
    source_names = c(oce_names,con_names)
    rates = c(rate_ocean_b,rate_land_b)
    
    contr_df = data.frame(source_names,rates)
    
    output_contr = paste0(input_sub,'/contr_by_source_released_new')
    dir.create(output_contr)
    output_contr = paste0(output_contr,'/contri_each_source.csv')
    
    fwrite(contr_df,output_contr)
    
  }
  sapply(input_data,sub_cal_contri)
}
cal_convey_amount_based_on_era5_eva <-function(
  
){
  
  target = c('north_jishui','north_moun','south_jishui','south_moun')
  sources = c('as','ato','eu')
  
  sources = paste0(rep(sources,each = 4),'_',1:4)
  target = rep(target,each = 12)
  sources = rep(sources,4)
  tar_sou = paste0(target,'_',sources)
  
  tar_sou <<- tar_sou
  library(data.table)
  sub_cal<-function(tar_sou){
    # input era5 ep sum
    tar_sou_full = tar_sou
    tar_sou = strsplit(tar_sou,'_')[[1]]
    
    source = paste0(tar_sou[1],'_',tar_sou[2])
    mode = tar_sou[3]
    reg_id = as.numeric(tar_sou[4])
    
    input_path = paste0('era5_eva_sum/',mode)
    
    input_path = list.files(input_path,full.names = T)
    input_path = list.files(input_path,full.names = T)
    
    input_path = input_path[reg_id]
    
    # input convey_rate 
    input_con_min = 'analysis_output/convey_rate_by_region_min.csv'
    input_con_max = 'analysis_output/convey_rate_by_region_max.csv'
    input_con_mean = 'analysis_output/convey_rate_by_region_mean.csv'
    
    
    # import data
    
    ep_sum = fread(input_path)
    ep_sum = ep_sum$ERA5
    
    con_min = fread(input_con_min)
    con_max = fread(input_con_max)
    con_mean = fread(input_con_mean)
    
    group_id = con_min$re_group
    group_id = which(group_id ==tar_sou_full)
    
    con_min = as.numeric(con_min[group_id,-1])
    con_max = as.numeric(con_max[group_id,-1])
    con_mean = as.numeric(con_mean[group_id,-1])
    
    con_min = rep(con_min,(length(ep_sum)/12))
    con_max = rep(con_max,(length(ep_sum)/12))
    con_mean = rep(con_mean,(length(ep_sum)/12))
    
    ep_sum_min = ep_sum * con_min
    ep_sum_max = ep_sum * con_max
    ep_sum_mean = ep_sum * con_mean
    
    return(cbind(ep_sum_min,ep_sum_max,ep_sum_mean))
  }
  
  
  ret = lapply(tar_sou,sub_cal)
  
  match_min <-function(x){
    return(x[,1])
  }
  
  match_max <-function(x){
    return(x[,2])
  }
  
  match_mean <-function(x){
    return(x[,3])
  }
  
  
  ret_min = lapply(ret,match_min)
  ret_max = lapply(ret,match_max)
  ret_mean = lapply(ret,match_mean)
  
  ret_min = do.call(cbind,ret_min)
  ret_max = do.call(cbind,ret_max)
  ret_mean = do.call(cbind,ret_mean)  
  
  colnames(ret_min) = tar_sou
  colnames(ret_max) = tar_sou
  colnames(ret_mean) = tar_sou
  
  output = 'convey_amount_based_era5_eva_in_target'
  dir.create(output)
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  
  
  output_min = paste0(output,'/min')
  output_max = paste0(output,'/max')
  output_mean = paste0(output,'/mean')
  
  dir.create(output_min)
  dir.create(output_max)
  dir.create(output_mean)
  
  output_min = paste0(output_min,'/',files,'.csv')
  output_max = paste0(output_max,'/',files,'.csv')
  output_mean = paste0(output_mean,'/',files,'.csv')
  
  ret_north_jishui_min = ret_min[,1:12]
  ret_north_jishui_max = ret_max[,1:12]
  ret_north_jishui_mean = ret_mean[,1:12]
  
  fwrite(ret_north_jishui_min,output_min[2])
  fwrite(ret_north_jishui_max,output_max[2])
  fwrite(ret_north_jishui_mean,output_mean[2])
  
  ret_north_moun_min = ret_min[,13:24]
  ret_north_moun_max = ret_max[,13:24]
  ret_north_moun_mean = ret_mean[,13:24]
  
  fwrite(ret_north_moun_min,output_min[1])
  fwrite(ret_north_moun_max,output_max[1])
  fwrite(ret_north_moun_mean,output_mean[1])
  
  ret_south_jishui_min = ret_min[,25:36]
  ret_south_jishui_max = ret_max[,25:36]
  ret_south_jishui_mean = ret_mean[,25:36]
  
  fwrite(ret_south_jishui_min,output_min[4])
  fwrite(ret_south_jishui_max,output_max[4])
  fwrite(ret_south_jishui_mean,output_mean[4])
  
  ret_south_moun_min = ret_min[,37:48]
  ret_south_moun_max = ret_max[,37:48]
  ret_south_moun_mean = ret_mean[,37:48]
  
  fwrite(ret_south_moun_min,output_min[3])
  fwrite(ret_south_moun_max,output_max[3])
  fwrite(ret_south_moun_mean,output_mean[3])
  
  
  
  # 
  
  
  
  # structure:
  
  north_jishui_min  =apply(ret_min[,1:12],1,sum)
  north_moun_min = apply(ret_min[,13:24],1,sum)
  south_jishui_min = apply(ret_min[,25:36],1,sum)
  south_moun_min = apply(ret_min[,37:48],1,sum)
  
  north_jishui_max  =apply(ret_max[,1:12],1,sum)
  north_moun_max = apply(ret_max[,13:24],1,sum)
  south_jishui_max = apply(ret_max[,25:36],1,sum)
  south_moun_max = apply(ret_max[,37:48],1,sum)
  
  north_jishui_mean  =apply(ret_mean[,1:12],1,sum)
  north_moun_mean = apply(ret_mean[,13:24],1,sum)
  south_jishui_mean = apply(ret_mean[,25:36],1,sum)
  south_moun_mean = apply(ret_mean[,37:48],1,sum)
  
  north_jishui_df = data.frame(min = north_jishui_min,
                               max = north_jishui_max,
                               mean = north_jishui_mean,
                               type = 'North_plain')
  north_moun_df = data.frame(min = north_moun_min,
                             max = north_moun_max,
                             mean = north_moun_mean,
                             type = 'North_mountain')
  south_jishui_df = data.frame(min = south_jishui_min,
                               max = south_jishui_max,
                               mean = south_jishui_mean,
                               type = 'South_plain')
  south_moun_df = data.frame(min = south_moun_min,
                             max = south_moun_max,
                             mean = south_moun_mean,
                             type = 'South_mountain')
  
  
  
  
  
  
}
cal_convey_amount_based_on_era5_pe <-function(
  
){
  
  target = c('north_jishui','north_moun','south_jishui','south_moun')
  sources = c('as','ato','eu')
  
  sources = paste0(rep(sources,each = 4),'_',1:4)
  target = rep(target,each = 12)
  sources = rep(sources,4)
  tar_sou = paste0(target,'_',sources)
  
  tar_sou <<- tar_sou
  library(data.table)
  sub_cal<-function(tar_sou){
    # input era5 ep sum
    tar_sou_full = tar_sou
    tar_sou = strsplit(tar_sou,'_')[[1]]
    
    source = paste0(tar_sou[1],'_',tar_sou[2])
    mode = tar_sou[3]
    reg_id = as.numeric(tar_sou[4])
    
    input_path = paste0('era5_pe_sum/',mode)
    
    input_path = list.files(input_path,full.names = T)
    input_path = list.files(input_path,full.names = T)
    
    input_path = input_path[reg_id]
    
    # input convey_rate 
    input_con_min = 'analysis_output/convey_rate_by_region_min.csv'
    input_con_max = 'analysis_output/convey_rate_by_region_max.csv'
    input_con_mean = 'analysis_output/convey_rate_by_region_mean.csv'
    
    
    # import data
    
    ep_sum = fread(input_path)
    ep_sum = ep_sum$ERA5
    
    con_min = fread(input_con_min)
    con_max = fread(input_con_max)
    con_mean = fread(input_con_mean)
    
    group_id = con_min$re_group
    group_id = which(group_id ==tar_sou_full)
    
    con_min = as.numeric(con_min[group_id,-1])
    con_max = as.numeric(con_max[group_id,-1])
    con_mean = as.numeric(con_mean[group_id,-1])
    
    con_min = rep(con_min,(length(ep_sum)/12))
    con_max = rep(con_max,(length(ep_sum)/12))
    con_mean = rep(con_mean,(length(ep_sum)/12))
    
    ep_sum_min = ep_sum * con_min
    ep_sum_max = ep_sum * con_max
    ep_sum_mean = ep_sum * con_mean
    
    return(cbind(ep_sum_min,ep_sum_max,ep_sum_mean))
  }
  
  
  ret = lapply(tar_sou,sub_cal)
  
  match_min <-function(x){
    return(x[,1])
  }
  
  match_max <-function(x){
    return(x[,2])
  }
  
  match_mean <-function(x){
    return(x[,3])
  }
  
  
  ret_min = lapply(ret,match_min)
  ret_max = lapply(ret,match_max)
  ret_mean = lapply(ret,match_mean)
  
  ret_min = do.call(cbind,ret_min)
  ret_max = do.call(cbind,ret_max)
  ret_mean = do.call(cbind,ret_mean)  
  
  colnames(ret_min) = tar_sou
  colnames(ret_max) = tar_sou
  colnames(ret_mean) = tar_sou
  
  output = 'convey_amount_based_era5_pe_in_target'
  dir.create(output)
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  
  
  output_min = paste0(output,'/min')
  output_max = paste0(output,'/max')
  output_mean = paste0(output,'/mean')
  
  dir.create(output_min)
  dir.create(output_max)
  dir.create(output_mean)
  
  output_min = paste0(output_min,'/',files,'.csv')
  output_max = paste0(output_max,'/',files,'.csv')
  output_mean = paste0(output_mean,'/',files,'.csv')
  
  ret_north_jishui_min = ret_min[,1:12]
  ret_north_jishui_max = ret_max[,1:12]
  ret_north_jishui_mean = ret_mean[,1:12]
  
  fwrite(ret_north_jishui_min,output_min[2])
  fwrite(ret_north_jishui_max,output_max[2])
  fwrite(ret_north_jishui_mean,output_mean[2])
  
  ret_north_moun_min = ret_min[,13:24]
  ret_north_moun_max = ret_max[,13:24]
  ret_north_moun_mean = ret_mean[,13:24]
  
  fwrite(ret_north_moun_min,output_min[1])
  fwrite(ret_north_moun_max,output_max[1])
  fwrite(ret_north_moun_mean,output_mean[1])
  
  ret_south_jishui_min = ret_min[,25:36]
  ret_south_jishui_max = ret_max[,25:36]
  ret_south_jishui_mean = ret_mean[,25:36]
  
  fwrite(ret_south_jishui_min,output_min[4])
  fwrite(ret_south_jishui_max,output_max[4])
  fwrite(ret_south_jishui_mean,output_mean[4])
  
  ret_south_moun_min = ret_min[,37:48]
  ret_south_moun_max = ret_max[,37:48]
  ret_south_moun_mean = ret_mean[,37:48]
  
  fwrite(ret_south_moun_min,output_min[3])
  fwrite(ret_south_moun_max,output_max[3])
  fwrite(ret_south_moun_mean,output_mean[3])
  
  
  
  # 
  
  
  
  # structure:
  
  north_jishui_min  =apply(ret_min[,1:12],1,sum)
  north_moun_min = apply(ret_min[,13:24],1,sum)
  south_jishui_min = apply(ret_min[,25:36],1,sum)
  south_moun_min = apply(ret_min[,37:48],1,sum)
  
  north_jishui_max  =apply(ret_max[,1:12],1,sum)
  north_moun_max = apply(ret_max[,13:24],1,sum)
  south_jishui_max = apply(ret_max[,25:36],1,sum)
  south_moun_max = apply(ret_max[,37:48],1,sum)
  
  north_jishui_mean  =apply(ret_mean[,1:12],1,sum)
  north_moun_mean = apply(ret_mean[,13:24],1,sum)
  south_jishui_mean = apply(ret_mean[,25:36],1,sum)
  south_moun_mean = apply(ret_mean[,37:48],1,sum)
  
  north_jishui_df = data.frame(min = north_jishui_min,
                               max = north_jishui_max,
                               mean = north_jishui_mean,
                               type = 'North_plain')
  north_moun_df = data.frame(min = north_moun_min,
                             max = north_moun_max,
                             mean = north_moun_mean,
                             type = 'North_mountain')
  south_jishui_df = data.frame(min = south_jishui_min,
                               max = south_jishui_max,
                               mean = south_jishui_mean,
                               type = 'South_plain')
  south_moun_df = data.frame(min = south_moun_min,
                             max = south_moun_max,
                             mean = south_moun_mean,
                             type = 'South_mountain')
  
  
  
  
  
  
}
cal_convey_amount_based_on_era5 <-function(
  
){
  
  target = c('north_jishui','north_moun','south_jishui','south_moun')
  sources = c('as','ato','eu')
  
  sources = paste0(rep(sources,each = 4),'_',1:4)
  target = rep(target,each = 12)
  sources = rep(sources,4)
  tar_sou = paste0(target,'_',sources)
  
  tar_sou <<- tar_sou
  library(data.table)
  sub_cal<-function(tar_sou){
    # input era5 ep sum
    tar_sou_full = tar_sou
    tar_sou = strsplit(tar_sou,'_')[[1]]
    
    source = paste0(tar_sou[1],'_',tar_sou[2])
    mode = tar_sou[3]
    reg_id = as.numeric(tar_sou[4])
    
    input_path = paste0('era5_ep_sum/',mode)
    
    input_path = list.files(input_path,full.names = T)
    input_path = list.files(input_path,full.names = T)
    
    input_path = input_path[reg_id]
    
    # input convey_rate 
    input_con_min = 'analysis_output/convey_rate_by_region_min.csv'
    input_con_max = 'analysis_output/convey_rate_by_region_max.csv'
    input_con_mean = 'analysis_output/convey_rate_by_region_mean.csv'
    
    
    # import data
    
    ep_sum = fread(input_path)
    ep_sum = ep_sum$ERA5
    
    con_min = fread(input_con_min)
    con_max = fread(input_con_max)
    con_mean = fread(input_con_mean)
    
    group_id = con_min$re_group
    group_id = which(group_id ==tar_sou_full)
    
    con_min = as.numeric(con_min[group_id,-1])
    con_max = as.numeric(con_max[group_id,-1])
    con_mean = as.numeric(con_mean[group_id,-1])
    
    con_min = rep(con_min,(length(ep_sum)/12))
    con_max = rep(con_max,(length(ep_sum)/12))
    con_mean = rep(con_mean,(length(ep_sum)/12))
    
    ep_sum_min = ep_sum * con_min
    ep_sum_max = ep_sum * con_max
    ep_sum_mean = ep_sum * con_mean
    
    return(cbind(ep_sum_min,ep_sum_max,ep_sum_mean))
  }
  
  
  ret = lapply(tar_sou,sub_cal)
  
  match_min <-function(x){
    return(x[,1])
  }
  
  match_max <-function(x){
    return(x[,2])
  }
  
  match_mean <-function(x){
    return(x[,3])
  }
  
  
  ret_min = lapply(ret,match_min)
  ret_max = lapply(ret,match_max)
  ret_mean = lapply(ret,match_mean)
  
  ret_min = do.call(cbind,ret_min)
  ret_max = do.call(cbind,ret_max)
  ret_mean = do.call(cbind,ret_mean)  
  
  colnames(ret_min) = tar_sou
  colnames(ret_max) = tar_sou
  colnames(ret_mean) = tar_sou
  
  output = 'convey_amount_based_era5_in_target'
  dir.create(output)
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  
  
  output_min = paste0(output,'/min')
  output_max = paste0(output,'/max')
  output_mean = paste0(output,'/mean')
  
  dir.create(output_min)
  dir.create(output_max)
  dir.create(output_mean)
  
  output_min = paste0(output_min,'/',files,'.csv')
  output_max = paste0(output_max,'/',files,'.csv')
  output_mean = paste0(output_mean,'/',files,'.csv')
  
  ret_north_jishui_min = ret_min[,1:12]
  ret_north_jishui_max = ret_max[,1:12]
  ret_north_jishui_mean = ret_mean[,1:12]
  
  fwrite(ret_north_jishui_min,output_min[2])
  fwrite(ret_north_jishui_max,output_max[2])
  fwrite(ret_north_jishui_mean,output_mean[2])
  
  ret_north_moun_min = ret_min[,13:24]
  ret_north_moun_max = ret_max[,13:24]
  ret_north_moun_mean = ret_mean[,13:24]
  
  fwrite(ret_north_moun_min,output_min[1])
  fwrite(ret_north_moun_max,output_max[1])
  fwrite(ret_north_moun_mean,output_mean[1])
  
  ret_south_jishui_min = ret_min[,25:36]
  ret_south_jishui_max = ret_max[,25:36]
  ret_south_jishui_mean = ret_mean[,25:36]
  
  fwrite(ret_south_jishui_min,output_min[4])
  fwrite(ret_south_jishui_max,output_max[4])
  fwrite(ret_south_jishui_mean,output_mean[4])
  
  ret_south_moun_min = ret_min[,37:48]
  ret_south_moun_max = ret_max[,37:48]
  ret_south_moun_mean = ret_mean[,37:48]
  
  fwrite(ret_south_moun_min,output_min[3])
  fwrite(ret_south_moun_max,output_max[3])
  fwrite(ret_south_moun_mean,output_mean[3])
  
  
  
  # 
  
  
  
  # structure:
  
  north_jishui_min  =apply(ret_min[,1:12],1,sum)
  north_moun_min = apply(ret_min[,13:24],1,sum)
  south_jishui_min = apply(ret_min[,25:36],1,sum)
  south_moun_min = apply(ret_min[,37:48],1,sum)
  
  north_jishui_max  =apply(ret_max[,1:12],1,sum)
  north_moun_max = apply(ret_max[,13:24],1,sum)
  south_jishui_max = apply(ret_max[,25:36],1,sum)
  south_moun_max = apply(ret_max[,37:48],1,sum)
  
  north_jishui_mean  =apply(ret_mean[,1:12],1,sum)
  north_moun_mean = apply(ret_mean[,13:24],1,sum)
  south_jishui_mean = apply(ret_mean[,25:36],1,sum)
  south_moun_mean = apply(ret_mean[,37:48],1,sum)
  
  north_jishui_df = data.frame(min = north_jishui_min,
                               max = north_jishui_max,
                               mean = north_jishui_mean,
                               type = 'North_plain')
  north_moun_df = data.frame(min = north_moun_min,
                             max = north_moun_max,
                             mean = north_moun_mean,
                             type = 'North_mountain')
  south_jishui_df = data.frame(min = south_jishui_min,
                               max = south_jishui_max,
                               mean = south_jishui_mean,
                               type = 'South_plain')
  south_moun_df = data.frame(min = south_moun_min,
                             max = south_moun_max,
                             mean = south_moun_mean,
                             type = 'South_mountain')
  
  
  
  
  
  
}
cal_convey_by_region_based_on_cmip6 <-function(
  mode = 'hist_ssp245'
){
  
  # input ep of cmip6
  mode <<- mode
  model_name = c('ACCESS-ESM1-5','BCC-CSM2-MR',
                 'CanESM5','GFDL-ESM4','IPSL-CM6A-LR',
                 'MIROC6','MRI-ESM2-0','NorESM2-LM')
  model_name <<- model_name
  
  input = 'cmip6_ep_sum_by_model'
  input = paste0(input,'/',mode)
  input2 = paste0(input,'/',model_name)
  input3 = paste0(input2,'/ep_sum.csv')
  
  input_cmip <<- input3
  
  target_region = paste0(c('north','north','south','south'),
                         '_',c('jishui','moun','jishui',"moun"))
  # define outptu
  output = 'convey_amount_based_on_cmip6_in_target'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output_max = paste0(output,'/','max')
  output_min = paste0(output,'/','min')
  output_mean = paste0(output,'/','mean')
  
  dir.create(output_max)
  dir.create(output_min)
  dir.create(output_mean)
  
  output_max = paste0(output_max,'/',model_name)
  output_min = paste0(output_min,'/',model_name)
  output_mean = paste0(output_mean,'/',model_name)
  
  lapply(output_max,dir.create)
  lapply(output_min,dir.create)
  lapply(output_mean,dir.create)
  
  output_max <<- output_max
  output_min <<- output_min
  output_mean <<- output_mean
  
  
  sub_cal_convey <-function(target_region){
    
    # import convey rate
    input_mean = 'analysis_output/convey_rate_by_region_mean.csv'
    input_max = 'analysis_output/convey_rate_by_region_max.csv'
    input_min ='analysis_output/convey_rate_by_region_min.csv' 
    
    con_rate_mean = fread(input_mean)
    con_rate_max = fread(input_max)
    con_rate_min = fread(input_min)
    
    group = con_rate_mean[,1]
    
    con_rate_mean = con_rate_mean[,-1]
    con_rate_max = con_rate_max[,-1]
    con_rate_min = con_rate_min[,-1]
    
    if(target_region == 'north_jishui'){
      con_rate_mean = con_rate_mean[1:12,]
      con_rate_max = con_rate_max[1:12,]
      con_rate_min = con_rate_min[1:12,]
    }else if(target_region =='north_moun'){
      con_rate_mean = con_rate_mean[13:24,]
      con_rate_max = con_rate_max[13:24,]
      con_rate_min = con_rate_min[13:24,]
    }else if(target_region =='south_jishui'){
      con_rate_mean = con_rate_mean[25:36,]
      con_rate_max = con_rate_max[25:36,]
      con_rate_min = con_rate_min[25:36,]
    }else if(target_region =='south_moun'){
      con_rate_mean = con_rate_mean[37:48,]
      con_rate_max = con_rate_max[37:48,]
      con_rate_min = con_rate_min[37:48,]
    }
    
    con_rate_mean = t(con_rate_mean)
    con_rate_max = t(con_rate_max)
    con_rate_min = t(con_rate_min)
    
    
    eps = lapply(input_cmip,fread)
    eps = lapply(eps,as.data.frame)
    
    as_negative_zero <-function(x){
      
      sub_as_neg <-function(x){
        x  = as.numeric(x)
        idneg = which(x <0)
        x[idneg] = 0
        return(x)
      }
      x = apply(x,2,sub_as_neg)
      return(x)
    }
    
    eps = lapply(eps,as_negative_zero)
    eps<<-eps
    
    con_rate_min <<- con_rate_min
    con_rate_max <<- con_rate_max
    con_rate_mean <<- con_rate_mean
    
    
    j = 1:8
    j <<- j
    
    cal_fun<-function(subeps,j){
      
      if(mode =='hist_ssp245'){
        i = 1:12
        cols = paste0(rep(c('as','ato','eu'),each = 4),
                      1:4)
      }else{
        i = 1:11
        cols = paste0(rep(c('as','ato','eu'),each = 4),
                      1:4)
        cols = cols[-12]
      }
      
      subeps <<- subeps
      
      calc_by_col_min<-function(i){
        rep_len = nrow(subeps)/12
        
        tmprate_min = con_rate_min[,i]
        tmprate_min = as.numeric(tmprate_min)
        tmprate_min = rep(tmprate_min,rep_len)

        tmpeps = subeps[,i]
        
        tmpeps_min = tmpeps * tmprate_min
        return(tmpeps_min)
        
      }
      calc_by_col_max<-function(i){
        rep_len = nrow(subeps)/12
        
        tmprate_max = con_rate_max[,i]
        tmprate_max = as.numeric(tmprate_max)
        tmprate_max = rep(tmprate_max,rep_len)
        
        tmpeps = subeps[,i]
        
        tmpeps_max = tmpeps * tmprate_max
        return(tmpeps_max)
        
      }
      calc_by_col_mean<-function(i){
        rep_len = nrow(subeps)/12
        
        tmprate_mean = con_rate_mean[,i]
        tmprate_mean = as.numeric(tmprate_mean)
        tmprate_mean = rep(tmprate_mean,rep_len)
        
        tmpeps = subeps[,i]
        
        tmpeps_mean = tmpeps * tmprate_mean
        return(tmpeps_mean)
        
      }
      
      ret_min = lapply(i,calc_by_col_min)
      ret_max = lapply(i,calc_by_col_max)
      ret_mean = lapply(i,calc_by_col_mean)
      
      ret_min = do.call(cbind,ret_min)
      ret_max = do.call(cbind,ret_max)
      ret_mean = do.call(cbind,ret_mean)
      
      
      colnames(ret_min) = cols
      colnames(ret_max) = cols
      colnames(ret_mean) = cols
          
      tmpoutput_min = paste0(output_min[j],'/',
                             target_region,'.csv')
      tmpoutput_max = paste0(output_max[j],'/',
                             target_region,'.csv')
      tmpoutput_mean = paste0(output_mean[j],'/',
                              target_region,'.csv')
      
      print(tmpoutput_max)
      print(tmpoutput_min)
      print(tmpoutput_mean)
      print(ret_min)
      fwrite(ret_min,tmpoutput_min)
      fwrite(ret_max,tmpoutput_max)
      fwrite(ret_mean,tmpoutput_mean)
      
    }
    
    mapply(cal_fun,eps,j)
  
  }
  
  lapply(target_region,sub_cal_convey)
  
  
  
}
cal_convey_rate_by_region <- function(
  input_file
){
  sub_cal<-function(input){
    input_north = paste0(input,'/output/combine_uptake_rel_by_region/north')
    input_south = paste0(input,'/output/combine_uptake_rel_by_region/south')
    
    input_north_file = list.files(input_north)
    input_south_file = list.files(input_south)
    
    input_north = list.files(input_north,full.names = T)
    input_south = list.files(input_south,full.names = T)
    
    output = paste0(input,'/output/convey_rate_by_region.csv')
    
    inputs = c(input_north,input_south)
    
    groups = c(
      paste0('north_jishui_',c('as','ato','eu')),
      paste0('north_moun_',c('as','ato','eu')),
      paste0('south_jishui_',c('as','ato','eu')),
      paste0('south_moun_',c('as','ato','eu'))
    )
    
    convey_box = 1
    for(i in 1:length(inputs)){
    
      tmpdf = fread(inputs[i])
      if(nrow(tmpdf)==0){
        tmp_convey = data.frame(
          up_region = 1:4,
          convey_rate =0,
          groups = paste0(groups[i],'_',1:4)
        )
      }else{
        tmp_rel = aggregate(tmpdf$release,list(tmpdf$region_id),sum)
        tmp_up = aggregate(tmpdf$uptake,list(tmpdf$region_id),sum)
        
        
        tmp_convey = data.frame(up_region= tmp_rel[,1],
                                convey_rate = abs(tmp_rel[,2])/tmp_up[,2])
        print(tmp_convey)
        
        id = tmp_rel$Group.1
        if(length(id)<4){
          idfull = 1:4
          reid = which(idfull %in% id)
          idfull = idfull[-reid]
          
          rel_lack = rep(0,length(idfull))
          add_mat = data.frame(up_region = idfull,
                               convey_rate = rel_lack)
          tmp_convey = rbind(tmp_convey,add_mat)
          
          reorder = order(tmp_convey[,1])
          tmp_convey = tmp_convey[reorder,]
        }
        
        tmp_convey$groups = paste0(groups[i],'_',tmp_convey$up_region)
        
      }
      convey_box = rbind(convey_box,tmp_convey) 
    }
    convey_box = convey_box[-1,]
    fwrite(convey_box,output)
  }
    
  
  sapply(input_file,sub_cal)
}
cal_convey_rate_by_type <- function(
  
){
  # type only inclues asia, europe, ato, bs
  
  # 1. determine cluster and label df
  outter_cluster_basedon_allpart()
  # 2. calculated uptake rates within each squared region
  source('/home/share/R_project/xinjiang_vapor/cal_uptake_ratio_in_each_squared_region.R')
  mode = c('ato','as','eu')
  system.time(sapply(mode,cal_uptake_ratio_in_each_squared_region))
  
}
cal_dep_by_as_bu_xinjiang_cloud<-function(
  input_ocean_type, # denote land 
  names_o,
  pattern = 'as_bu_xinjiang'
){
  
  type = fread(input_ocean_type)
  type = type[,-1]
  
  ids = as.data.frame(type)[,1]
  xfull <<- df_cal_dep$type
  df_fullid <<- df_cal_dep$type
  names_o <<- names_o # ocean_name
  
  
  group_id <- function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  idsl = group_id(ids)
  # trans df_cal_dep to df_in_ocean / df_in_land
  system.time(df_in<-lapply(idsl,divide_full_as_each_type_cloud))
  df_in = do.call('c',df_in)
  df_cal_dep <<- df_cal_dep[df_in,]
  xfull <<- df_cal_dep$type
  df_fullid <<- df_cal_dep$type
  
  #source('/home/share/R_project/xinjiang_vapor/mask_via_each_ocean_for_contri_cal.R')
  mas_df=mask_via_each_ocean_for_contri_cal_cloud(df_cal_dep,names_o,pattern = pattern)
  input_tmp_masdf = 'tmp/tmp_mas_df.csv'
  fwrite(mas_df,input_tmp_masdf)
  rm(mas_df)
  source('~/search_which_full_as_bu_xinjiang_cloud.R')
  ret_li = lapply(idsl,search_which_full_as_bu_xinjiang_cloud)
  ret_li_source = do.call('rbind',ret_li)
  rm(ret_li)
  rm(df_cal_dep)
  return(ret_li_source)
  
}
cal_dep_by_as_bu_xinjiang<-function(
  input_ocean_type, # denote land 
  names_o,
  pattern = 'as_bu_xinjiang'
){
  
  type = fread(input_ocean_type)
  type = type[,-1]
  
  ids = as.data.frame(type)[,1]
  xfull <<- df_cal_dep$type
  df_fullid <<- df_cal_dep$type
  names_o <<- names_o # ocean_name
  
  
  group_id <- function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  idsl = group_id(ids)
  # trans df_cal_dep to df_in_ocean / df_in_land
  system.time(df_in<-lapply(idsl,divide_full_as_each_type))
  df_in = do.call('c',df_in)
  df_cal_dep <<- df_cal_dep[df_in,]
  xfull <<- df_cal_dep$type
  df_fullid <<- df_cal_dep$type
  
  source('/home/share/R_project/xinjiang_vapor/mask_via_each_ocean_for_contri_cal.R')
  mas_df=mask_via_each_ocean_for_contri_cal(df_cal_dep,names_o,pattern = pattern)
  input_tmp_masdf = 'tmp/tmp_mas_df.csv'
  fwrite(mas_df,input_tmp_masdf)
  rm(mas_df)
  source('/home/share/R_project/xinjiang_vapor/search_which_full_as_bu_xinjiang.R')
  ret_li = lapply(idsl,search_which_full_as_bu_xinjiang)
  ret_li_source = do.call('rbind',ret_li)
  rm(ret_li)
  rm(df_cal_dep)
  return(ret_li_source)
  
}
cal_dep_by_each_source_type_cloud <- function(
  input_data
){
  library(raster)
  library(maps)
  library(maptools)
  library(ggplot2)
  library(reshape2)
  library(RColorBrewer)
  library(data.table)
  library(foreach)
  library(doParallel)
  library(parallel)
  library(snow)
  # source refers to ocean
  sub_cal_dep<-function(
    input_sub
  ){
    # full dep data frame import
    source('~/declare_glob_var_fun_cloud.R')
    declare_glob_var_fun_cloud(input_sub)
    
    # calc_by_ocean
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    
    input_ocean_type = paste0(input_sub,'/df_first_ocean')
    input_ocean_type = paste0(input_ocean_type,'/',oce_names,'.csv')
    source('~/cal_dep_by_ocean.R')
    # shp 
    print('cal_dep_by_each_source_type: start ocean')
    output_path = paste0(input_sub,'/contr_ocean')
    dir.create(output_path)
    output_ocean = paste0(output_path,'/',oce_names,'.csv')
    source('~/cal_dep_by_ocean_cloud.R')
    for(i in 1:length(input_ocean_type)){
      source('~/declare_glob_var_fun_cloud.R')
      declare_glob_var_fun_cloud(input_sub)
      tmpdf = cal_dep_by_ocean_cloud(input_ocean_type[i],oce_names[i])
      fwrite(tmpdf,output_ocean[i])
      rm(tmpdf)
      gc()
      #li = ls()
      #re1 = which(li != "input_sub" & li !='declare_glob_var_fun')
      #rm(list = li[re1])
      print(i)
    }
    print('cal_dep_by_each_source_type: end ocean')
    print('cal_dep_by_each_source_type: start land')
    # lands but asia 
    con_names = c('as','xj','eu','naf','na')
    input_land_type = paste0(input_sub,'/df_first_land')
    input_land_type = paste0(input_land_type,'/',con_names,'.csv')
    
    output_path = paste0(input_sub,'/contr_land')
    dir.create(output_path)
    output_land = paste0(output_path,'/',con_names,'.csv')
    
    for(i in 1:length(input_land_type)){
      source('~/declare_glob_var_fun_cloud.R')
      declare_glob_var_fun_cloud(input_sub)
      if(con_names[i] == 'as'){
        source('~/cal_dep_by_as_bu_xinjiang_cloud.R')
        # as bu xinjiang
        tmpdf = cal_dep_by_as_bu_xinjiang_cloud(input_land_type[i],names_o = 'as',pattern = 'as_bu_xinjiang')
        
      }else if(con_names[i] == 'xj'){
        tmpdf = cal_dep_by_as_bu_xinjiang_cloud(input_land_type[i],names_o = 'xj',pattern = 'xinjiang')
      }else{
        source('~/cal_dep_by_land_cloud.R')
        tmpdf= cal_dep_by_land_cloud(input_land_type[i],con_names[i])
      }
      fwrite(tmpdf,output_land[i])
      rm(tmpdf)
      #li = ls()
      #re1 = which(li != "input_sub" & li !='declare_glob_var_fun')
      #rm(list = li[re1])
      gc()
      print(i)
    }
    print('cal_dep_by_each_source_type: end land')
    
    
    # xinjiang
    
    
    
  }
  
  
  sapply(input_data,sub_cal_dep)
  
}
cal_dep_by_each_source_type <- function(
  input_data
){
  library(raster)
  library(maps)
  library(maptools)
  library(ggplot2)
  library(reshape2)
  library(RColorBrewer)
  library(data.table)
  library(foreach)
  library(doParallel)
  library(parallel)
  library(snow)
  # source refers to ocean
  sub_cal_dep<-function(
    input_sub
  ){
    # full dep data frame import
    source('/home/share/R_project/xinjiang_vapor/declare_glob_var_fun.R')
    declare_glob_var_fun(input_sub)
    
    # calc_by_ocean
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    
    input_ocean_type = paste0(input_sub,'/df_first_ocean')
    input_ocean_type = paste0(input_ocean_type,'/',oce_names,'.csv')
    source('/home/share/R_project/xinjiang_vapor/cal_dep_by_ocean.R')
    # shp 
    print('cal_dep_by_each_source_type: start ocean')
    output_path = paste0(input_sub,'/contr_ocean')
    dir.create(output_path)
    output_ocean = paste0(output_path,'/',oce_names,'.csv')
  
    for(i in 1:length(input_ocean_type)){
      source('/home/share/R_project/xinjiang_vapor/declare_glob_var_fun.R')
      declare_glob_var_fun(input_sub)
      tmpdf = cal_dep_by_ocean(input_ocean_type[i],oce_names[i])
      fwrite(tmpdf,output_ocean[i])
      rm(tmpdf)
      gc()
      #li = ls()
      #re1 = which(li != "input_sub" & li !='declare_glob_var_fun')
      #rm(list = li[re1])
      print(i)
    }
    print('cal_dep_by_each_source_type: end ocean')
    print('cal_dep_by_each_source_type: start land')
    # lands but asia 
    con_names = c('as','xj','eu','naf','na')
    input_land_type = paste0(input_sub,'/df_first_land')
    input_land_type = paste0(input_land_type,'/',con_names,'.csv')
    
    output_path = paste0(input_sub,'/contr_land')
    dir.create(output_path)
    output_land = paste0(output_path,'/',con_names,'.csv')
    
    for(i in 1:length(input_land_type)){
      source('/home/share/R_project/xinjiang_vapor/declare_glob_var_fun.R')
      declare_glob_var_fun(input_sub)
      if(con_names[i] == 'as'){
        source('/home/share/R_project/xinjiang_vapor/cal_dep_by_as_bu_xinjiang.R')
        # as bu xinjiang
        tmpdf = cal_dep_by_as_bu_xinjiang(input_land_type[i],names_o = 'as',pattern = 'as_bu_xinjiang')
        
      }else if(con_names[i] == 'xj'){
        tmpdf = cal_dep_by_as_bu_xinjiang(input_land_type[i],names_o = 'xj',pattern = 'xinjiang')
      }else{
        tmpdf= cal_dep_by_land(input_land_type[i],con_names[i])
      }
      fwrite(tmpdf,output_land[i])
      rm(tmpdf)
      #li = ls()
      #re1 = which(li != "input_sub" & li !='declare_glob_var_fun')
      #rm(list = li[re1])
      gc()
      print(i)
    }
    print('cal_dep_by_each_source_type: end land')
    
    
    # xinjiang
    
  
  
  }
  
  
  sapply(input_data,sub_cal_dep)
  
}
cal_dep_by_land_cloud<-function(
  input_ocean_type, # denote land 
  names_o,
  pattern = 'combine_land'
){
  
  type = fread(input_ocean_type)
  type = type[,-1]
  
  ids = as.data.frame(type)[,1]
  xfull <<- df_cal_dep$type
  df_fullid <<- df_cal_dep$type
  names_o <<- names_o # ocean_name
  
  
  group_id <- function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  idsl = group_id(ids)
  # trans df_cal_dep to df_in_ocean / df_in_land
  system.time(df_in<-lapply(idsl,divide_full_as_each_type_cloud))
  df_in = do.call('c',df_in)
  df_cal_dep <<- df_cal_dep[df_in,]
  xfull <<- df_cal_dep$type
  df_fullid <<- df_cal_dep$type
  
  
  mas_df=mask_via_each_ocean_for_contri_cal_cloud(df_cal_dep,names_o,pattern = 'land')
  input_tmp_masdf = 'tmp/tmp_mas_df.csv'
  fwrite(mas_df,input_tmp_masdf)
  rm(mas_df)
  
  mas_df_route=mask_via_each_ocean_for_contri_cal_cloud(df_cal_dep,names_o,pattern = pattern)
  input_tmp_masdfr = 'tmp/tmp_mas_df_r.csv'
  fwrite(mas_df_route,input_tmp_masdfr)
  rm(mas_df_route)
  
  source('~/search_which_full_acc1_cloud.R')
  ret_li = lapply(idsl,search_which_full_acc1_cloud)
  ret_li = do.call('rbind',ret_li)
  
  rm(df_cal_dep)
  return(ret_li)
  
}
cal_dep_by_land<-function(
  input_ocean_type, # denote land 
  names_o,
  pattern = 'combine_land'
){
  
  type = fread(input_ocean_type)
  type = type[,-1]
  
  ids = as.data.frame(type)[,1]
  xfull <<- df_cal_dep$type
  df_fullid <<- df_cal_dep$type
  names_o <<- names_o # ocean_name
  
  
  group_id <- function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  idsl = group_id(ids)
  # trans df_cal_dep to df_in_ocean / df_in_land
  system.time(df_in<-lapply(idsl,divide_full_as_each_type))
  df_in = do.call('c',df_in)
  df_cal_dep <<- df_cal_dep[df_in,]
  xfull <<- df_cal_dep$type
  df_fullid <<- df_cal_dep$type
  
  
  mas_df=mask_via_each_ocean_for_contri_cal(df_cal_dep,names_o,pattern = 'land')
  input_tmp_masdf = 'tmp/tmp_mas_df.csv'
  fwrite(mas_df,input_tmp_masdf)
  rm(mas_df)
  
  mas_df_route=mask_via_each_ocean_for_contri_cal(df_cal_dep,names_o,pattern = pattern)
  input_tmp_masdfr = 'tmp/tmp_mas_df_r.csv'
  fwrite(mas_df_route,input_tmp_masdfr)
  rm(mas_df_route)
  
  source('/home/share/R_project/xinjiang_vapor/search_which_full_acc1.R')
  ret_li = lapply(idsl,search_which_full_acc1)
  ret_li = do.call('rbind',ret_li)
  
  rm(df_cal_dep)
  return(ret_li)
  
}
cal_dep_by_ocean_cloud<-function(
  input_ocean_type, names_o,
  pattern = 'combine_ocean'
){
  
  type = fread(input_ocean_type)
  type = type[,-1]
  
  ids = as.data.frame(type)[,1]
  xfull <<- df_cal_dep$type
  df_fullid <<- df_cal_dep$type
  names_o <<- names_o # ocean_name
  
  
  group_id <- function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  idsl = group_id(ids)
  # trans df_cal_dep to df_in_ocean / df_in_land
  source('~/divide_full_as_each_type_cloud.R')
  system.time(df_in<-lapply(idsl,divide_full_as_each_type_cloud))
  df_in = do.call('c',df_in)
  df_cal_dep <<- df_cal_dep[df_in,]
  xfull <<- df_cal_dep$type
  df_fullid <<- df_cal_dep$type
  
  
  
  source('~/mask_via_each_ocean_for_contri_cal_cloud.R')
  mas_df = mask_via_each_ocean_for_contri_cal_cloud(df_cal_dep,names_o,pattern = 'ocean')
  input_tmp_masdf = 'tmp/tmp_mas_df.csv'
  fwrite(mas_df,input_tmp_masdf)
  rm(mas_df)
  
  mas_df_route = mask_via_each_ocean_for_contri_cal_cloud(df_cal_dep,names_o,pattern = pattern)
  input_tmp_masdfr = 'tmp/tmp_mas_df_r.csv'
  fwrite(mas_df_route,input_tmp_masdfr)
  rm(mas_df_route)
  #dir.create('tmp')
  
  
  
  source('~/search_which_full_acc1_cloud.R')
  ret_li = lapply(idsl,search_which_full_acc1_cloud)
  ret_li = do.call('rbind',ret_li)
  
  rm(df_cal_dep)
  return(ret_li)
  
  
}
cal_dep_by_ocean<-function(
  input_ocean_type, names_o,
  pattern = 'combine_ocean'
){
  
  type = fread(input_ocean_type)
  type = type[,-1]
  
  ids = as.data.frame(type)[,1]
  xfull <<- df_cal_dep$type
  df_fullid <<- df_cal_dep$type
  names_o <<- names_o # ocean_name
  
  
  group_id <- function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  idsl = group_id(ids)
  # trans df_cal_dep to df_in_ocean / df_in_land
  source('/home/share/R_project/xinjiang_vapor/divide_full_as_each_type.R')
  system.time(df_in<-lapply(idsl,divide_full_as_each_type))
  df_in = do.call('c',df_in)
  df_cal_dep <<- df_cal_dep[df_in,]
  xfull <<- df_cal_dep$type
  df_fullid <<- df_cal_dep$type
  
  
  
  source('/home/share/R_project/xinjiang_vapor/mask_via_each_ocean_for_contri_cal.R')
  mas_df = mask_via_each_ocean_for_contri_cal(df_cal_dep,names_o,pattern = 'ocean')
  input_tmp_masdf = 'tmp/tmp_mas_df.csv'
  fwrite(mas_df,input_tmp_masdf)
  rm(mas_df)
  
  mas_df_route = mask_via_each_ocean_for_contri_cal(df_cal_dep,names_o,pattern = pattern)
  input_tmp_masdfr = 'tmp/tmp_mas_df_r.csv'
  fwrite(mas_df_route,input_tmp_masdfr)
  rm(mas_df_route)
  #dir.create('tmp')
  
  
  
  source('/home/share/R_project/xinjiang_vapor/search_which_full_acc1.R')
  ret_li = lapply(idsl,search_which_full_acc1)
  ret_li = do.call('rbind',ret_li)
  
  rm(df_cal_dep)
  return(ret_li)
  

}
cal_dp_sub_pal<-function(
  x
){
  # sub function of main cal dp whole route mpi
  # to calculate the variation of vapor alongside the transimision route
  library(foreach)
  library(doParallel)
  library(parallel)
  library(snow)
  
  
  idx <<- unique(x$type)
  x <<- x
  pal_cal_by_id <- function(id){
    tmpr = which(x$type == id)
    tmpm = x[tmpr,]
    
    # calculate the variance
    nrows = nrow(tmpm)
    nrowsec = nrows -1
    
    tmpme = tmpm[2:nrows,]
    tmpms = tmpm[1:nrowsec,]
    
    midlong = (tmpme$long + tmpms$long)/2
    midlat = (tmpme$lat + tmpms$lat)/2
    midhei = (tmpme$height + tmpms$height)/2
    
    varep = tmpme$ep - tmpms$ep
    ret_m = data.frame(long = midlong,lat = midlat,height = midhei,varep = varep,
                       type = tmpme$type)
    return(ret_m)
  }
  
  
  ret_mid = lapply(idx,pal_cal_by_id)
  ret_m = do.call('rbind',ret_mid)
  
  #cl = makeCluster(4)
  #clusterExport(cl,c('x','idx'))
  #system.time(
  #  ret_mid <- parLapply(cl,idx,pal_cal_by_id)
  #)
  #stopCluster(cl)
  
  
  return(ret_m)
  
  
  
}
cal_ep_in_source_region<-function(
  mode = 'ato'
){
  
  #mode = c('ato','as','eu')
  #ssp = c('hist','245','585')
  # calculation e minus p based on CMIP6 ss245 and ssp 585
  
  source('/home/share/R_project/xinjiang_vapor/outter_mask_crop_cmip6.R')
  outter_mask_crop_cmip6()
  
  # import and cal the sum of ep in each sub-regions 
  source('/home/share/R_project/xinjiang_vapor/cal_sum_ep.R')
  mode = c('ato','as','eu')
  cal_sum_ep(mode[1])
  mode = c('ato','as','eu')
  cal_sum_ep(mode[2])
  mode = c('ato','as','eu')
  cal_sum_ep(mode[3])
}
cal_eva_in_each_region_based_cmip6 <-function(
  cmip6_model,
  pattern = 'hist_ssp245'
){
  # input_shp
  #
  source('/home/share/R_project/xinjiang_vapor/import_cmip6_combined_.R')
  cmip6_eva = import_cmip6_combined(pattern,'E',cmip6_model)
  cmip6_eva = cmip6_eva *86400 *30.5
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  
  south = shp_management('xinjiang_south')
  north = shp_management('xinjiang_north')
  
  crs(south) = crs(south_moun)
  crs(north) = crs(north_moun)
  
  output = 'eva_in_target_cmip6'
  dir.create(output)
  
  output = paste0(output,'/',pattern)
  dir.create(output)
  
  output = paste0(output,'/',cmip6_model)
  dir.create(output)
  
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  output = paste0(output,'/',files,'.csv')
  
  # cal north
  cal_pr_sum <-function(cmip6_eva,full_shp,shp_moun){
    cmip6_full = crop(cmip6_eva,full_shp)
    
    cmip6_moun = mask(cmip6_full,shp_moun)
    cmip6_moun = as.list(cmip6_moun)
    
    cmip6_full = mask(cmip6_full,full_shp)
    cmip6_full = as.list(cmip6_full)
    
    sum_fun <- function(x){
      xs = cellStats(x,sum,na.rm = T)
      return(xs)
    }
    
    moun_sum = lapply(cmip6_moun,sum_fun)
    full_sum = lapply(cmip6_full,sum_fun)
    
    moun_sum = do.call('c',moun_sum)
    full_sum = do.call('c',full_sum)
    
    jishui_sum = full_sum -moun_sum
    
    return(cbind(moun_sum,jishui_sum))
  }
  
  north_df = cal_pr_sum(cmip6_eva,north,north_moun)
  south_df = cal_pr_sum(cmip6_eva,south,south_moun)
  
  north_moun = data.frame(north_moun =north_df[,1])
  north_jishui = data.frame(north_jishui = north_df[,2])
  
  south_moun = data.frame(south_moun =south_df[,1])
  south_jishui = data.frame(south_jishui = south_df[,2])
  
  fwrite(north_moun,output[1])
  fwrite(north_jishui,output[2])
  fwrite(south_moun,output[3])
  fwrite(south_jishui,output[4])
  
  
  
  
}
cal_evaporation_in_each_region_based_era5 <-function(
  
){
  # input_shp
  
  ear5_eva = data_management(mode = 'era5_e_include_ocean')
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  
  south = shp_management('xinjiang_south')
  north = shp_management('xinjiang_north')
  
  crs(south) = crs(south_moun)
  crs(north) = crs(north_moun)
  
  output = 'evaporation_in_target'
  dir.create(output)
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  output = paste0(output,'/',files,'.csv')
  
  # cal north
  cal_pr_sum <-function(ear5_eva,full_shp,shp_moun){
    era5_full = crop(ear5_eva,full_shp)
    
    era5_moun = mask(era5_full,shp_moun)
    era5_moun = as.list(era5_moun)
    
    era5_full = mask(era5_full,full_shp)
    era5_full = as.list(era5_full)
    
    sum_fun <- function(x){
      xs = cellStats(x,sum,na.rm = T)
      return(xs)
    }
    
    moun_sum = lapply(era5_moun,sum_fun)
    full_sum = lapply(era5_full,sum_fun)
    
    moun_sum = do.call('c',moun_sum)
    full_sum = do.call('c',full_sum)
    
    jishui_sum = full_sum -moun_sum
    
    return(cbind(moun_sum,jishui_sum))
  }
  
  north_df = cal_pr_sum(ear5_eva,north,north_moun)
  south_df = cal_pr_sum(ear5_eva,south,south_moun)
  
  north_moun = data.frame(north_moun =north_df[,1])
  north_jishui = data.frame(north_jishui = north_df[,2])
  
  south_moun = data.frame(south_moun =south_df[,1])
  south_jishui = data.frame(south_jishui = south_df[,2])
  
  fwrite(north_moun,output[1])
  fwrite(north_jishui,output[2])
  fwrite(south_moun,output[3])
  fwrite(south_jishui,output[4])
  
  
  
  
}
cal_increasing_rate_pmedf <- function(df){
  
  id = c('SSP245_PME1','SSP245_PME3',
         'SSP585_PME1','SSP585_PME3')
  c1 = 1
  c2 = 1
  for(i in 1:4){
    tmpid = which(df$type %in% id[i])
    tmpdf = df[tmpid,3]
    
    c12 = (tmpdf[14]- tmpdf[1])/(abs(tmpdf[1]))
    c23 = (tmpdf[33] - tmpdf[1])/abs(tmpdf[1])
    
    c1 = c(c1,round(c12))
    c2 = c(c2,round(c23))
    
  }
  c1 = c1[-1]
  c2 = c2[-1]
  
  retdf1 = data.frame(
    x = rep(7,10),
    label = paste0(c1[1]),
    type = id
  )
  retdf2 = data.frame(
    x = rep(23,10),
    label = paste0(c2,'%'),
    type = id
  )
}
cal_increasing_rate_whole <- function(df,
                                      mode = 'TWS_245')
{
  library(cpm)
  
  if(mode == 'TWS_245'){
    ids = c('SSP245_TWS')
  }else if(mode =='TWS_585'){
    ids = c('SSP585_TWS')
  
  }else if(mode =='SSP245_PME'){
    
    ids = c('SSP245_PME1',
                 'SSP245_PME3')
    
  }else if(mode =='SSP585_PME'){
    ids = c('SSP585_PME1',
            'SSP585_PME3')
  }
  
  c1 = 1
  c2 = 1
  #c3 = 1
  for(i in 1:length(ids)){
    tmpid = which(df$variable == ids[i])
    tmpdf2 = df[tmpid,3]
    
    date = 2018:2050
    pv = data.frame(
      ds = seq(as.Date('2018-01-01'),
               as.Date('2050-01-01'),
               '1 year'),
      y = tmpdf2
    )
    
    #i = 6
    m <- prophet(pv, changepoint.prior.scale = 1.5,
                 n.changepoints = 2)
    forecast <- predict(m, pv)
    plot(m, forecast)+add_changepoints_to_plot(m)
    tmpid = which(pv$ds == m$changepoints[1])
    print(tmpid)
    
    tmp12 = (tmpdf2[tmpid]-tmpdf2[1])/abs(tmpdf2[1])*100
    tmp23 = (tmpdf2[33]-tmpdf2[tmpid])/abs(tmpdf2[1])*100
    #tmp13 = (tmpdf2[33] - tmpdf2[1])/abs(tmpdf2[1])
    diff1 = (tmpdf2[tmpid]-tmpdf2[1])
    diff2 = (tmpdf2[33]-tmpdf2[tmpid])
    #print(mmkTrend(tmpdf2[1:tmpid])$Zc)
    #print(mmkTrend(tmpdf2[tmpid:33])$Zc)
    #print(tmp23)
    c1 = c(c1,round(tmp12))
    c2 = c(c2,round(tmp23))
    #c3 = c(c3,round(tmp13))
    #print(tmp23)
    #print(tmp12)
    #print(tmp13)
  }
  c1 = c1[-1]
  c2 = c2[-1]
  #c3 = c3[-1]
  
  idbig1 = which(c1>0)
  idbig2 = which(c2>0)
  c1[idbig1] = paste0('+',c1[idbig1])
  c2[idbig2] = paste0('+',c2[idbig2])
  
  print(c1)
  retdf1 = data.frame(
    x = rep(7,length(ids)),
    label = paste0('VR: ',c1,'%'),
    variable = ids
  )
  retdf2 = data.frame(
    x = rep(23,length(ids)),
    label = paste0('VR: ',c2,'%'),
    variable = ids
  )
  
  retdf = rbind(retdf1,retdf2)
  
  return(retdf)

  
  
}
cal_increasing_rate <- function(df)
{
  library(cpm)
  c1 = 1
  c2 = 1
  c3 = 1
  ids = paste0('SW',1:10)
  
  for(i in 1:length(ids)){
    tmpid = which(df$variable == ids[i])
    tmpdf2 = df[tmpid,3]
    
    date = 2018:2050
    pv = data.frame(
      ds = seq(as.Date('2018-01-01'),
               as.Date('2050-01-01'),
               '1 year'),
      y = tmpdf2
    )
    
    #i = 6
    #m <- prophet(pv, changepoint.prior.scale = 1.5,
    #             n.changepoints = 2)
    #forecast <- predict(m, pv)
    #plot(m, forecast)+add_changepoints_to_plot(m)
    #tmpid = which(pv$ds == m$changepoints[1])
    #print(tmpid)
    tmpid = 14
    
    tmp12 = (tmpdf2[tmpid]-tmpdf2[1])/abs(tmpdf2[1])*100
    tmp23 = (tmpdf2[33]-tmpdf2[tmpid])/abs(tmpdf2[tmpid])*100
    #tmp13 = (tmpdf2[33] - tmpdf2[1])/abs(tmpdf2[1])
    
    #print(mmkTrend(tmpdf2[1:tmpid])$Zc)
    #print(mmkTrend(tmpdf2[tmpid:33])$Zc)
    #print(tmp23)
    c1 = c(c1,round(tmp12))
    c2 = c(c2,round(tmp23))
    #print(tmp23)
    #print(tmp12)
    #print(tmp13)
  }
  c1 = c1[-1]
  c2 = c2[-1]
  c3 = c3[-1]
  
  idbig1 = which(c1>0)
  idbig2 = which(c2>0)
  c1[idbig1] = paste0('+',c1[idbig1])
  c2[idbig2] = paste0('+',c2[idbig2])
  
  retdf1 = data.frame(
    x = rep(7,10),
    label = paste0('VR: ',c1,'%'),
    variable = paste0('SW',1:10)
  )
  retdf2 = data.frame(
    x = rep(23,10),
    label = paste0('VR: ',c2,'%'),
    variable = paste0('SW',1:10)
  )
  retdf3 = data.frame(
    x = rep(17,10),
    label = paste0(c3,'%'),
    variable = paste0('SW',1:10)
  )
  
  
  retdf = rbind(retdf1,retdf2)
  
  return(list(retdf,retdf3))
  
  
}
cal_mean_e_in_source_based_on_era5 <- function(
  
){
  mode = c('ato','as','eu')
  ###
  source('/home/share/R_project/xinjiang_vapor/sub_cal_mean_eva_in_source.R')
  source('/home/share/R_project/xinjiang_vapor/mask_era5_eva.R')
  
  mask_era5_eva('ato')
  mask_era5_eva('as')
  mask_era5_eva('eu')
  
  mode = c('ato','as','eu')
  system.time(lapply(mode,sub_cal_mean_eva_in_source))
  
  
}
cal_mean_p_in_source_based_on_era5 <- function(
  
){
  mode = c('as','ato','eu')
  source('/home/share/R_project/xinjiang_vapor/sub_cal_mean_pr_in_source.R')
  system.time(lapply(mode,sub_cal_mean_pr_in_source))
  
  
}
cal_mean_peva_for_subwindow <- function(
  
){
  input = 'sub_windows'
  num = 1:19
  input = paste0(input,'/sub_window',num,'.shp')
  
  # tas
  tws = data_management('global_era5_poten_evap')
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  tws = crop(tws,world)
  tws = mask(tws,world)
  
  sub_cal_sum <-function(x){
    x = cellStats(x,'sum')
    return(x)
  }
  trend_fun <-function(x){
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    
    xt = as.numeric(xt)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }
  
  tws_sumt_box = 1
  for(i in 1:19){
    tmpshp = shapefile(input[i])
    crs(tmpshp) = crs(world)
    
    tmptws = crop(tws,tmpshp)
    tmptws = mask(tmptws,tmpshp)
    
    tmptws = as.list(tmptws)
    
    tws_sum = lapply(tmptws,sub_cal_sum)
    tws_sum = do.call('c',tws_sum)
    
    tws_sum = tws_sum[1:174]
    
    tws_sumt = trend_fun(tws_sum)
    
    tws_sumt_box = cbind(tws_sumt_box,tws_sumt)
    print(i)
  }
  
  tws_sumt_box = tws_sumt_box[,-1]
  
  write.csv(tws_sumt_box,
            'analysis_output/poten_eva_subwindow_2003_2017.csv')
  
  
  
}
cal_mean_pme_for_subwindow <- function(
  
){
  input = 'sub_windows'
  num = 1:19
  input = paste0(input,'/sub_window',num,'.shp')
  
  # t
  pr = data_management('era5_pr_include_ocean')
  peva = data_management('global_era5_poten_evap')
  
  pme = pr - peva
  
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  pme = crop(pme,world)
  pme = mask(pme,world)
  
  sub_cal_sum <-function(x){
    x = cellStats(x,'sum')
    return(x)
  }
  trend_fun <-function(x){
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    
    xt = as.numeric(xt)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }
  
  pme_sumt_box = 1
  for(i in 1:19){
    tmpshp = shapefile(input[i])
    crs(tmpshp) = crs(world)
    
    tmppme = crop(pme,tmpshp)
    tmppme = mask(tmppme,tmpshp)
    
    tmppme = as.list(tmppme)
    
    pme_sum = lapply(tmppme,sub_cal_sum)
    pme_sum = do.call('c',pme_sum)
    
    pme_sum = pme_sum[1:174]
    
    pme_sumt = trend_fun(pme_sum)
    
    pme_sumt_box = cbind(pme_sumt_box,pme_sumt)
    print(i)
  }
  
  pme_sumt_box = pme_sumt_box[,-1]
  
  write.csv(pme_sumt_box,
            'analysis_output/pme_subwindow_2003_2017.csv')
  
  
  
}
cal_mean_sst_in_source_based_on_era5<-function(
  
){
  mode = c('as','ato','eu')
  source('/home/share/R_project/xinjiang_vapor/mask_era5_sst.R')
  mask_era5_sst(mode[2])
  
  source('/home/share/R_project/xinjiang_vapor/sub_cal_mean_sst_in_source.R')
  sub_cal_mean_sst_in_source(mode[2])
  
  
  
  
}
cal_mean_tas_for_subwindow <- function(
  
){
  input = 'sub_windows'
  num = 1:19
  input = paste0(input,'/sub_window',num,'.shp')
  
  # tas
  tws = data_management('global_era5_temperature')
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  tws = crop(tws,world)
  tws = mask(tws,world)
  
  sub_cal_sum <-function(x){
    x = cellStats(x,'mean')
    return(x)
  }
  trend_fun <-function(x){
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    
    xt = as.numeric(xt)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }
  
  tws_sumt_box = 1
  for(i in 1:19){
    tmpshp = shapefile(input[i])
    crs(tmpshp) = crs(world)
    
    tmptws = crop(tws,tmpshp)
    tmptws = mask(tmptws,tmpshp)
    
    tmptws = as.list(tmptws)
    
    tws_sum = lapply(tmptws,sub_cal_sum)
    tws_sum = do.call('c',tws_sum)
    
    tws_sum = tws_sum[1:174]
    
    tws_sumt = trend_fun(tws_sum)
    
    tws_sumt_box = cbind(tws_sumt_box,tws_sumt)
    print(i)
  }
  
  tws_sumt_box = tws_sumt_box[,-1]
  
  write.csv(tws_sumt_box,
            'analysis_output/tas_subwindow_2003_2017.csv')
  
  
  
}
cal_mean_temerature_in_source_based_on_era5<-function(
  
){
  mode = c('as','ato','eu')
  source('/home/share/R_project/xinjiang_vapor/mask_era5_temperature.R')
  mask_era5_temperature(mode[1])
  mask_era5_temperature(mode[2])
  mask_era5_temperature(mode[3])
  
  source('/home/share/R_project/xinjiang_vapor/sub_cal_mean_tas_in_source.R')
  lapply(mode,sub_cal_mean_tas_in_source)
  
  
  
  
}
cal_mean_tws_among_windows<-function(
  df,mode = 'mean'
){
  
  id = paste0('SW',1:10)
  if(mode == 'mean'){
    valbox = 1
    for(i in 1:length(id)){
      tmpid = which(df$variable == id[i])
      subval = df[tmpid,3]
      valbox = cbind(valbox,subval)
      date = df[tmpid,1]
      type = df[tmpid,4]
    }
    valbox = valbox[,-1]
    meanbox = apply(valbox,1,mean,na.rm = T)
    meandf = data.frame(
      date = date,
      type = '(a) Mean-TWS-among-SWs',
      value = meanbox,
      variable = type
    )
  }else{
    valbox_max = 1
    valbox_min = 1
    for(i in 1:length(id)){
      tmpid = which(df$variable == id[i])
      subval1 = df[tmpid,3]
      subval2 = df[tmpid,4]
      
      valbox_max = cbind(valbox_max,subval1)
      valbox_min = cbind(valbox_min,subval2)
      
      date = df[tmpid,1]
      type = df[tmpid,5]
    }
    valbox_max = valbox_max[,-1]
    valbox_min = valbox_min[,-1]
    
    valbox_max = apply(valbox_max,1,max,na.rm = T)
    valbox_min = apply(valbox_min,1,min,na.rm = T)
    meandf = data.frame(
      date = date,
      type = '(a) Mean-TWS-among-SWs',
      max = valbox_max,
      min = valbox_min,
      variable = type
    )
  }

  return(meandf)
  
  
}
cal_mean_tws_for_subwindow <- function(
  
){
  input = 'sub_windows'
  num = 1:19
  input = paste0(input,'/sub_window',num,'.shp')
  
  
  # tws
  tws = data_management('grace')
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  tws = crop(tws,world)
  tws = mask(tws,world)
  
  sub_cal_sum <-function(x){
    x = cellStats(x,'sum')
    return(x)
  }
  trend_fun <-function(x){
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    
    xt = as.numeric(xt)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }
  
  tws_sumt_box = 1
  for(i in 1:19){
    tmpshp = shapefile(input[i])
    crs(tmpshp) = crs(world)
    
    tmptws = crop(tws,tmpshp)
    tmptws = mask(tmptws,tmpshp)
    
    tmptws = as.list(tmptws)
    
    tws_sum = lapply(tmptws,sub_cal_sum)
    tws_sum = do.call('c',tws_sum)
    
    tws_sumt = trend_fun(tws_sum)
    
    tws_sumt_box = cbind(tws_sumt_box,tws_sumt)
    print(i)
  }
  
  tws_sumt_box = tws_sumt_box[,-1]
  
  write.csv(tws_sumt_box,'analysis_output/tws_subwindow_2003_2017.csv')
  
  
  
}
cal_mean_tws_monthly_sum_subwins <-function(
  
){
  input_tws_mean = 'analysis_output/fig3/twsmean_mon.csv'
  
  tws_mean = fread(input_tws_mean)
  tws_mean = as.data.frame(tws_mean)
  
  naidtws = which(is.na(tws_mean$JAN))
  tws_mean = tws_mean[-naidtws,]
  
  loc = tws_mean[,1:2]
  loc <<- loc
  
  tws_mean = tws_mean[,-c(1,2)]
  tws_mean <<- tws_mean
  
  #input_shp
  input = 'sub_windows'
  num = 1:19
  input = paste0(input,'/sub_window',num,'.shp')
  
  subs = lapply(input,shapefile)
  subs <<- subs
  sub_cal_mean <-function(i){
    library(raster)
    tmptws = data.frame(
      long = loc[,1],
      lat = loc[,2],
      tws_mean[,i]
    )
    coordinates(tmptws) = ~long+lat
    gridded(tmptws) = T
    tmptws = raster(tmptws)
    tmptws <<- tmptws
    cell_mean_stat <- function(x){
      crops = crop(tmptws,x)  
      masks = mask(crops,x)
      xmean = cellStats(masks,'mean')
      return(xmean)
    }
    
    subs_mean = lapply(subs,cell_mean_stat)
    subs_mean = do.call('c',subs_mean)
    return(subs_mean)
  }
  
  i <<- 1:12
  library(doParallel)
  cl = makeCluster(12)
  clusterExport(cl,c('i','subs','loc','tws_mean'))
  ret_tws_mean = parLapply(cl,i,sub_cal_mean)
  stopCluster(cl)
  
  ret_tws_mean = do.call('cbind',ret_tws_mean)
  colnames(ret_tws_mean) = toupper(month.abb)
  
  df = data.frame(
    SW = paste0('SW',1:19),
    ret_tws_mean
  )
  dfm = reshape2::melt(df,'SW')
  
  dfm$cuts = cut(dfm$value,
                 breaks = seq(-10,10,2))
  dfm$SW = factor(dfm$SW,
                  levels = paste0('SW',1:19))
  ptile = ggplot()+
    geom_tile(data = dfm,aes(x = SW,
                             y = variable,
                             fill = cuts))+
    scale_fill_brewer(palette = 'Spectral')+
    theme_bw()
  
  
}
cal_month_mean_pme_ato <-function(
  
){
  input_pr_ato  = list.files('/media/sdb5/Data/era5_pr_masked/ato',
                             full.names = T)
  input_pr_ato = do.call('c',lapply(input_pr_ato,list.files,
                                    full.names = T))
  
  input_pet_ato = list.files('/media/sdb5/Data/era5_pet_masked/ato',
                             full.names = T)
  input_pet_ato = do.call('c',
                          lapply(input_pet_ato,
                                 list.files,
                                 full.names = T))
  
  pr_ato = lapply(input_pr_ato,stack)
  pet_ato = lapply(input_pet_ato,stack)
  
  pr_ato = do.call('merge',pr_ato)
  pr_ato = pr_ato*30.5
  pet_ato = do.call('merge',pet_ato)
  
  pme_ato = pr_ato - pet_ato
  
  cal_ana_fun<-function(x){
    x = x-mean(x,na.rm = T)
    return(x)
  }
  beginCluster(14)
  pme_ato = clusterR(pme_ato,calc,args = list(fun= cal_ana_fun))
  endCluster()
  
  janid = seq(1,180,12)
  febid = seq(2,180,12)
  marid = seq(3,180,12)
  aprid = seq(4,180,12)
  mayid = seq(5,180,12)
  junid = seq(6,180,12)
  julid = seq(7,180,12)
  augid = seq(8,180,12)
  sepid = seq(9,180,12)
  octid = seq(10,180,12)
  novid = seq(11,180,12)
  decid = seq(12,180,12)
  
  monid = list(janid,febid,marid,aprid,
               mayid,junid,julid,augid,
               sepid,octid,novid,decid)
  
  
  pme_ato <<- pme_ato 
  monid <<- monid
  
  cell_mean_fun_pme <-function(i){
    tmpid = monid[[i]]
    tmppme = pme_ato[[tmpid]]
    
    tmppmedf = as.data.frame(tmppme,
                             xy = T)
    loc = tmppmedf[,1:2]
    tmppmedf = tmppmedf[,-c(1,2)]
    
    tmppmedfmean = apply(tmppmedf,1,mean
                       ,na.rm = T)
    retbox = cbind(loc,tmppmedfmean)
    return(retbox)
  }
 
  i = 1:length(monid)
  mon_mean_box = lapply(i,cell_mean_fun_pme)
  
  
  pmemean1 = mon_mean_box[[1]]
  pmemean2 = mon_mean_box[[2]][,3]
  pmemean3 = mon_mean_box[[3]][,3]
  pmemean4 = mon_mean_box[[4]][,3]
  pmemean5 = mon_mean_box[[5]][,3]
  pmemean6 = mon_mean_box[[6]][,3]
  pmemean7 = mon_mean_box[[7]][,3]
  pmemean8 = mon_mean_box[[8]][,3]
  pmemean9 = mon_mean_box[[9]][,3]
  pmemean10 = mon_mean_box[[10]][,3]
  pmemean11 = mon_mean_box[[11]][,3]
  pmemean12 = mon_mean_box[[12]][,3]
  
  pmemean_mon = cbind(pmemean1,
                     pmemean2,
                     pmemean3,
                     pmemean4,
                     pmemean5,
                     pmemean6,
                     pmemean7,
                     pmemean8,
                     pmemean9,
                     pmemean10,
                     pmemean11,
                     pmemean12)
  
  
  colnames(pmemean_mon) = c('long','lat',
                           toupper(month.abb))
  dir.create('analysis_output/fig3')
  output = 'analysis_output/fig3/pmemean_mon.csv'
  
  fwrite(pmemean_mon,output)
}
cal_month_mmk_pme_ato <-function(
  
){
  input_pr_ato  = list.files('/media/sdb5/Data/era5_pr_masked/ato',
                             full.names = T)
  input_pr_ato = do.call('c',lapply(input_pr_ato,list.files,
                                    full.names = T))
  
  input_pet_ato = list.files('/media/sdb5/Data/era5_pet_masked/ato',
                             full.names = T)
  input_pet_ato = do.call('c',
                          lapply(input_pet_ato,
                                 list.files,
                                 full.names = T))
  
  pr_ato = lapply(input_pr_ato,stack)
  pet_ato = lapply(input_pet_ato,stack)
  
  pr_ato = do.call('merge',pr_ato)
  pr_ato = pr_ato*30.5
  pet_ato = do.call('merge',pet_ato)
  
  pme_ato = pr_ato - pet_ato

  janid = seq(1,180,12)
  febid = seq(2,180,12)
  marid = seq(3,180,12)
  aprid = seq(4,180,12)
  mayid = seq(5,180,12)
  junid = seq(6,180,12)
  julid = seq(7,180,12)
  augid = seq(8,180,12)
  sepid = seq(9,180,12)
  octid = seq(10,180,12)
  novid = seq(11,180,12)
  decid = seq(12,180,12)
  
  monid = list(janid,febid,marid,aprid,
               mayid,junid,julid,augid,
               sepid,octid,novid,decid)
  
  
  pme_ato <<- pme_ato 
  monid <<- monid
  
  cell_mmk_fun_pme <-function(i){
    tmpid = monid[[i]]
    tmppme = pme_ato[[tmpid]]
    
    
    tmppmedf = as.data.frame(tmppme,
                             xy = T)
    loc = tmppmedf[,1:2]
    tmppmedf = tmppmedf[,-c(1,2)]
    j <<- 1:nrow(tmppmedf)
    tmppmedf <<- tmppmedf
    sub_mmk <-function(j){
      source('/home/share/R_project/xinjiang_vapor/mmk_fundf.R')
      tmp = as.numeric(tmppmedf[j,])
      ret = mmk_fundf(tmp)
      return(ret)
    }
    
    cl = makeCluster(14)
    clusterExport(cl,c('tmppmedf','j'))
    tmppmedfmmk = parLapply(cl,j,sub_mmk)
    stopCluster(cl)
    
    tmppmedfmmk = do.call('c',tmppmedfmmk)
    retbox = cbind(loc,tmppmedfmmk)
    gc()
    return(retbox)
  }
  
  i = 1:length(monid)
  mon_mmk_box = lapply(i,cell_mmk_fun_pme)
  
  
  Zpmemmk1 = mon_mmk_box[[1]]
  pmemmk2 = mon_mmk_box[[2]][,3]
  pmemmk3 = mon_mmk_box[[3]][,3]
  pmemmk4 = mon_mmk_box[[4]][,3]
  pmemmk5 = mon_mmk_box[[5]][,3]
  pmemmk6 = mon_mmk_box[[6]][,3]
  pmemmk7 = mon_mmk_box[[7]][,3]
  pmemmk8 = mon_mmk_box[[8]][,3]
  pmemmk9 = mon_mmk_box[[9]][,3]
  pmemmk10 = mon_mmk_box[[10]][,3]
  pmemmk11 = mon_mmk_box[[11]][,3]
  pmemmk12 = mon_mmk_box[[12]][,3]
  
  pmemmk_mon = cbind(pmemmk1,
                      pmemmk2,
                      pmemmk3,
                      pmemmk4,
                      pmemmk5,
                      pmemmk6,
                      pmemmk7,
                      pmemmk8,
                      pmemmk9,
                      pmemmk10,
                      pmemmk11,
                      pmemmk12)
  
  
  colnames(pmemmk_mon) = c('long','lat',
                            toupper(month.abb))
  dir.create('analysis_output/fig3')
  output = 'analysis_output/fig3/pmemmk_mon.csv'
  
  fwrite(pmemmk_mon,output)
}
cal_pe_in_each_region_based_era5 <-function(
  
){
  # input_shp
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  
  input_pr = 'era5_pr_in_target/'
  input_pr = paste0(input_pr,files,'.csv')
  
  input_ev = 'evaporation_in_target/'
  input_ev = paste0(input_ev,files,'.csv')
  
  output = 'precp_minus_evapor_in_target'
  dir.create(output)
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  output = paste0(output,'/',files,'.csv')
  
  
  for(i in 1:4){
    
    pr = as.data.frame(fread(input_pr[i]))
    ev = as.data.frame(fread(input_ev[i]))
    
    pe = pr[,1] - ev[,1]
    pe = data.frame(pe)
    fwrite(pe,output[i])
  }
  
  
  
}
cal_ponte_evap_in_each_region_based_era5 <-function(
  
){
  # input_shp
  
  ear5_eva = data_management(mode = 'global_era5_poten_evap')
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  
  south = shp_management('xinjiang_south')
  north = shp_management('xinjiang_north')
  
  crs(south) = crs(south_moun)
  crs(north) = crs(north_moun)
  
  output = 'poten_evap_in_target'
  dir.create(output)
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  output = paste0(output,'/',files,'.csv')
  
  # cal north
  cal_pr_sum <-function(ear5_eva,full_shp,shp_moun){
    era5_full = crop(ear5_eva,full_shp)
    
    era5_moun = mask(era5_full,shp_moun)
    era5_moun = as.list(era5_moun)
    
    era5_full = mask(era5_full,full_shp)
    era5_full = as.list(era5_full)
    
    sum_fun <- function(x){
      xs = cellStats(x,sum,na.rm = T)
      return(xs)
    }
    
    moun_sum = lapply(era5_moun,sum_fun)
    full_sum = lapply(era5_full,sum_fun)
    
    moun_sum = do.call('c',moun_sum)
    full_sum = do.call('c',full_sum)
    
    jishui_sum = full_sum -moun_sum
    
    return(cbind(moun_sum,jishui_sum))
  }
  
  north_df = cal_pr_sum(ear5_eva,north,north_moun)
  south_df = cal_pr_sum(ear5_eva,south,south_moun)
  
  north_moun = data.frame(north_moun =north_df[,1])
  north_jishui = data.frame(north_jishui = north_df[,2])
  
  south_moun = data.frame(south_moun =south_df[,1])
  south_jishui = data.frame(south_jishui = south_df[,2])
  
  fwrite(north_moun,output[1])
  fwrite(north_jishui,output[2])
  fwrite(south_moun,output[3])
  fwrite(south_jishui,output[4])
  
  
  
  
}
cal_pr_in_each_region_based_era5 <-function(
  
){
  # input_shp
  
  era5_pr = data_management(mode = 'era5_pr_include_ocean')
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  
  south = shp_management('xinjiang_south')
  north = shp_management('xinjiang_north')
  
  crs(south) = crs(south_moun)
  crs(north) = crs(north_moun)
  
  output = 'era5_pr_in_target'
  dir.create(output)
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  output = paste0(output,'/',files,'.csv')

  # cal north
  cal_pr_sum <-function(era5_pr,full_shp,shp_moun){
    era5_full = crop(era5_pr,full_shp)
    
    era5_moun = mask(era5_full,shp_moun)
    era5_moun = as.list(era5_moun)
    
    era5_full = mask(era5_full,full_shp)
    era5_full = as.list(era5_full)
    
    sum_fun <- function(x){
      xs = cellStats(x,sum,na.rm = T)
      return(xs)
    }
    
    moun_sum = lapply(era5_moun,sum_fun)
    full_sum = lapply(era5_full,sum_fun)
    
    moun_sum = do.call('c',moun_sum)
    full_sum = do.call('c',full_sum)
    
    jishui_sum = full_sum -moun_sum
    
    return(cbind(moun_sum,jishui_sum))
  }
  
  north_df = cal_pr_sum(era5_pr,north,north_moun)
  south_df = cal_pr_sum(era5_pr,south,south_moun)
  
  north_moun = data.frame(north_moun =north_df[,1])
  north_jishui = data.frame(north_jishui = north_df[,2])
  
  south_moun = data.frame(south_moun =south_df[,1])
  south_jishui = data.frame(south_jishui = south_df[,2])
  
  fwrite(north_moun,output[1])
  fwrite(north_jishui,output[2])
  fwrite(south_moun,output[3])
  fwrite(south_jishui,output[4])
  
  
  
  
}
cal_pr_in_each_region_based_gpcc <-function(
  
){
  # input_shp
  
  gpcc_pr = data_management(mode = 'gpcc_full')
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  
  south = shp_management('xinjiang_south')
  north = shp_management('xinjiang_north')
  
  crs(south) = crs(south_moun)
  crs(north) = crs(north_moun)
  
  output = 'gpcc_pr_in_target'
  dir.create(output)
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  output = paste0(output,'/',files,'.csv')
  
  # cal north
  cal_pr_sum <-function(gpcc_pr,full_shp,shp_moun){
    gpcc_full = crop(gpcc_pr,full_shp)
    
    gpcc_moun = mask(gpcc_full,shp_moun)
    gpcc_moun = as.list(gpcc_moun)
    
    gpcc_full = mask(gpcc_full,full_shp)
    gpcc_full = as.list(gpcc_full)
    
    sum_fun <- function(x){
      xs = cellStats(x,sum,na.rm = T)
      return(xs)
    }
    
    moun_sum = lapply(gpcc_moun,sum_fun)
    full_sum = lapply(gpcc_full,sum_fun)
    
    moun_sum = do.call('c',moun_sum)
    full_sum = do.call('c',full_sum)
    
    jishui_sum = full_sum -moun_sum
    
    return(cbind(moun_sum,jishui_sum))
  }
  
  north_df = cal_pr_sum(gpcc_pr,north,north_moun)
  south_df = cal_pr_sum(gpcc_pr,south,south_moun)
  
  north_moun = data.frame(north_moun =north_df[,1])
  north_jishui = data.frame(north_jishui = north_df[,2])
  
  south_moun = data.frame(south_moun =south_df[,1])
  south_jishui = data.frame(south_jishui = south_df[,2])
  
  fwrite(north_moun,output[1])
  fwrite(north_jishui,output[2])
  fwrite(south_moun,output[3])
  fwrite(south_jishui,output[4])
  
  
  
  
}
cal_released_by_type<-function(
  mas_df
){
  mas_df = as.data.frame(mas_df)
  varep <<- mas_df$varep
  type <<- mas_df$type
  sub_cal_released_fun<-function(x){
    tyid = which(type == x)
    tmp = varep[tyid]
    tmps = abs(sum(tmp[which(tmp<0)]))
    return(c(tmps,x))
  }
  
  cl = makeCluster(15)
  clusterExport(cl,c('varep','type'))
  released = parLapply(cl,type,sub_cal_released_fun)
  stopCluster(cl)
  
  re_df = do.call('rbind',released)
  sum_fun_neg<-function(x){
    xs = sum(x[which(x <0)])
  }
  type = as.list(unique(mas_df$type))
  
  
  
  
  return(re_df)
}
cal_released_in_xinjiang_jishui<-function(
  input_path
){
  # calcluation of jishui released vapor in xinjiang
  sub_cal<-function(input){
    library(data.table)
    library(doParallel)
    library(dplyr)
    
    print(paste0('start ',input))
    input_df = paste0(input,'/masked_var_whole_route_mid.csv') 
    df = fread(input_df)
    
    # 1. import shp
    source('/home/share/R_project/xinjiang_vapor/shp_management.R')
    shp_north = shp_management('xinjiang_south')
    ex = extent(shp_north)
    # 2. fileter with shp
    id = which(df[,1]>=ex[1] &
               df[,1]<=ex[2] &
               df[,2]>=ex[3] &
               df[,2]<=ex[4])
    
    df = df[id,]
    
    loc = df[,1:2]
    loc$type = df$type
    
    source('/home/share/R_project/xinjiang_vapor/mask_points_for_south_xinjiang.R')
    system.time(id_south <- mask_points_for_south_xinjiang(loc,pattern = 'xinjiang_jishui_south'))
    
    df_south_in_mountain = df[id_south,]
    df_south_in_jishui = df[-id_south,]
    
    cal_release<-function(x){
      re = sum(x[which(x<0)])
      return(re)
    }
    
    re_in_jishui = aggregate(df_south_in_jishui$varep,
                             list(df_south_in_jishui$type),cal_release)
    re_in_moun = aggregate(df_south_in_mountain$varep,
                           list(df_south_in_mountain$type),cal_release)
    
    id0 = which(re_in_jishui[,2]==0)
    re_in_jishui = re_in_jishui[-id0,]
    colnames(re_in_jishui) = c('type','release')
    
    id0 = which(re_in_moun[,2]==0)
    re_in_moun = re_in_moun[-id0,]
    colnames(re_in_moun) = c('type','release')
    
    output = paste0(input,'/xinjiang_release')
    output_south = paste0(output,'/south')
    
    dir.create(output)
    dir.create(output_south)
    
    output_south_jishui = paste0(output_south,'/jishui_re.csv')
    output_south_moun = paste0(output_south,'/moun_re.csv')
    
    fwrite(re_in_jishui,output_south_jishui)
    fwrite(re_in_moun,output_south_moun)
    
    print(paste0('pass South'))
    gc()
    ##### 
    # North
    df = fread(input_df)
    
    # 1. import shp
    source('/home/share/R_project/xinjiang_vapor/shp_management.R')
    shp_north = shp_management('xinjiang_north')
    ex = extent(shp_north)
    # 2. fileter with shp
    id = which(df[,1]>=ex[1] &
                 df[,1]<=ex[2] &
                 df[,2]>=ex[3] &
                 df[,2]<=ex[4])
    
    df = df[id,]
    
    loc = df[,1:2]
    loc$type = df$type
    
    source('/home/share/R_project/xinjiang_vapor/mask_points_for_south_xinjiang.R')
    system.time(id_north <- mask_points_for_south_xinjiang(loc,pattern = 'xinjiang_jishui_north'))
    
    df_north_in_mountain = df[id_north,]
    df_north_in_jishui = df[-id_north,]
    
    re_in_jishui = aggregate(df_north_in_jishui$varep,
                             list(df_north_in_jishui$type),cal_release)
    re_in_moun = aggregate(df_north_in_mountain$varep,
                           list(df_north_in_mountain$type),cal_release)
    
    id0 = which(re_in_jishui[,2]==0)
    re_in_jishui = re_in_jishui[-id0,]
    colnames(re_in_jishui) = c('type','release')
    
    id0 = which(re_in_moun[,2]==0)
    re_in_moun = re_in_moun[-id0,]
    colnames(re_in_moun) = c('type','release')
  
    output_north = paste0(output,'/north')
    dir.create(output_north)
    
    output_north_jishui = paste0(output_north,'/jishui_re.csv')
    output_north_moun = paste0(output_north,'/moun_re.csv')
    
    fwrite(re_in_jishui,output_north_jishui)
    fwrite(re_in_moun,output_north_moun)
    gc()
    print(paste0('pass North'))
    print(paste0('pass ',input))
  }  
  
  lapply(input_path,sub_cal)
  
  
  
  
}
cal_snowmelt_in_each_region_based_era5 <-function(
  
){
  # input_shp
  
  era5_sm = data_management(mode = 'era5_snowmelt')
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  
  south = shp_management('xinjiang_south')
  north = shp_management('xinjiang_north')
  
  crs(south) = crs(south_moun)
  crs(north) = crs(north_moun)
  
  output = 'snowmelt_in_target'
  dir.create(output)
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  output = paste0(output,'/',files,'.csv')
  
  # cal north
  cal_pr_sum <-function(era5_sm,full_shp,shp_moun){
    era5_full = crop(era5_sm,full_shp)
    
    era5_moun = mask(era5_full,shp_moun)
    era5_moun = as.list(era5_moun)
    
    era5_full = mask(era5_full,full_shp)
    era5_full = as.list(era5_full)
    
    sum_fun <- function(x){
      xs = cellStats(x,sum,na.rm = T)
      return(xs)
    }
    
    moun_sum = lapply(era5_moun,sum_fun)
    full_sum = lapply(era5_full,sum_fun)
    
    moun_sum = do.call('c',moun_sum)
    full_sum = do.call('c',full_sum)
    
    jishui_sum = full_sum -moun_sum
    
    return(cbind(moun_sum,jishui_sum))
  }
  
  north_df = cal_pr_sum(era5_sm,north,north_moun)
  south_df = cal_pr_sum(era5_sm,south,south_moun)
  
  north_moun = data.frame(north_moun =north_df[,1])
  north_jishui = data.frame(north_jishui = north_df[,2])
  
  south_moun = data.frame(south_moun =south_df[,1])
  south_jishui = data.frame(south_jishui = south_df[,2])
  
  fwrite(north_moun,output[1])
  fwrite(north_jishui,output[2])
  fwrite(south_moun,output[3])
  fwrite(south_jishui,output[4])
  
  
  
  
}
cal_subs_tws_his_annual_loss <- function(
  
){
  input_tws = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws = fread(input_tws)
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  tws = as.data.frame(tws)
  tws = tws[,-1]
  twsdf = tws[,id_box]
  colnames(twsdf) = paste0('SW',1:10)
  twsdf <<- twsdf

  twsdf = apply(twsdf,1,mean)
  twsdf= twsdf[1:168]
  
  twsm = matrix(twsdf,nrow = 12)
  twsm = apply(twsm,2,sum,na.rm= T)
  
  tws= (twsm[14]-twsm[1])/abs(twsm[1])
  
}
cal_sum_ep_in_source_based_on_era5 <- function(
  
){
  mode = c('ato','as','eu')
  ###
  source('/home/share/R_project/xinjiang_vapor/mask_era5_e_pr.R')
  system.time(lapply(mode,mask_era5_e_pr))
  
  mode = c('ato','as','eu')
  source('/home/share/R_project/xinjiang_vapor/sub_cal_sum_ep_in_source.R')
  system.time(lapply(mode,sub_cal_sum_ep_in_source))
  
  
}
cal_sum_ep_hist_ssp585 <- function(
  mode = 'ato'
){
  mode <<- mode
  # 1. input file 
  input_file = '/media/root/Shen_drive1/CMIP6_e-p'
  input_file = paste0(input_file,'/',mode)
  
  input_ssp245 = paste0(input_file,'/','hist_ssp245')
  input_ssp585 = paste0(input_file,'/','hist_ssp585')
  
  input_ssp245 = paste0(input_ssp245,'/region',1:4)
  input_ssp585 = paste0(input_ssp585,'/region',1:4)
  
  
  input_ssp245 <<- input_ssp245
  input_ssp585 <<- input_ssp585
  
  i = 1:4
  
  output = 'cmip6_ep_sum'
  dir.create(output)
  
  output = paste0(output,'/',mode)
  
  dir.create(output)
  
  output245 = paste0(output,'/hist_ssp245')
  output585 = paste0(output,'/hist_ssp585')
  
  dir.create(output245)
  dir.create(output585)
  
  output245 = paste0(output245,'/region',1:4)
  output585 = paste0(output585,'/region',1:4)
  
  lapply(output245,dir.create)
  lapply(output585,dir.create)
  
  output245 = paste0(output245,'/sum_ep.csv')
  output585 = paste0(output585,'/sum_ep.csv')
  
  output245 <<- output245
  output585 <<- output585
  
  model_name = list.files('/media/root/Shen_drive1/CMIP6_combined/E/hist_ssp245')
  
  model_name_extract<-function(x){
    x = strsplit(x,'_')[[1]][2]
    return(x)
  }
  
  model_name= sapply(model_name,model_name_extract)
  model_name = as.character(model_name)
  
  model_name <<- model_name
  
  
  sub_cal_sum_ep<-function(i){
    tmpinput245 = list.files(input_ssp245[i],full.names = T)
    tmpinput585 = list.files(input_ssp585[i],full.names = T)
    
    tmpinput245 <<- tmpinput245
    tmpinput585 <<- tmpinput585
    
    j = 1:length(tmpinput585)
    j <<- j
    
    
    
    sub2_cal_sum_ep_ssp585 <- function(j){
      library(raster)
      library(ncdf4)
      library(doParallel)
      tmp = stack(tmpinput585[j])
      tmp = as.list(tmp)
      
      sum_fun <- function(x){
        x = cellStats(x,'sum',na.rm = T)
      }
      
      tmps = lapply(tmp,sum_fun)
      tmps = do.call('c',tmps)
      return(tmps)
    }
    
    
    if(mode =='eu' & i == 4){
      tmpb = 1
      for(j in j){
        if(j == 3){
          library(data.table)
          tmpdf = fread(tmpinput585[3])
          tmpdf = tmpdf[,-c(1,2)]
          sum_fun2 <- function(x){
            x = sum(x,na.rm = T)
          }
          
          tmpdf = apply(tmpdf,2,sum_fun2)
          tmpdf = as.numeric(tmpdf)
        }else{
          tmpdf = sub2_cal_sum_ep_ssp585(j)
        }
        tmpb = cbind(tmpb,tmpdf)
      }
      tmpb = tmpb[,-1]
      colnames(tmpb) = model_name
      fwrite(tmpb,output585[i])
    }else{
      library(doParallel)
      cl = makeCluster(8)
      clusterExport(cl,c('tmpinput585','j'))
      ret = parLapply(cl,j,sub2_cal_sum_ep_ssp585)
      stopCluster(cl)
      
      ret = do.call('cbind',ret)
      
      colnames(ret) = model_name
      fwrite(ret,output585[i])
    }
    
    
    
    
  }
  
  
  sub_cal_sum_ep(1)
  sub_cal_sum_ep(2)
  sub_cal_sum_ep(3)
  sub_cal_sum_ep(4)
  
  print(paste0('pass ',mode))
}
cal_sum_ep <- function(
  mode = 'ato'
){
  mode <<- mode
  # 1. input file 
  input_file = '/media/root/Shen_drive1/CMIP6_e-p'
  input_file = paste0(input_file,'/',mode)
  
  input_ssp245 = paste0(input_file,'/','hist_ssp245')
  input_ssp585 = paste0(input_file,'/','hist_ssp585')

  input_ssp245 = paste0(input_ssp245,'/region',1:4)
  input_ssp585 = paste0(input_ssp585,'/region',1:4)
  
  
  input_ssp245 <<- input_ssp245
  input_ssp585 <<- input_ssp585
  
  i = 1:4
  
  output = 'cmip6_ep_sum'
  dir.create(output)
  
  output = paste0(output,'/',mode)
  
  dir.create(output)
  
  output245 = paste0(output,'/hist_ssp245')
  output585 = paste0(output,'/hist_ssp585')
  
  dir.create(output245)
  dir.create(output585)
  
  output245 = paste0(output245,'/region',1:4)
  output585 = paste0(output585,'/region',1:4)
  
  lapply(output245,dir.create)
  lapply(output585,dir.create)
  
  output245 = paste0(output245,'/sum_ep.csv')
  output585 = paste0(output585,'/sum_ep.csv')
  
  output245 <<- output245
  output585 <<- output585
  
  model_name = list.files('/media/root/Shen_drive1/CMIP6_combined/E/hist_ssp245')
  
  model_name_extract<-function(x){
    x = strsplit(x,'_')[[1]][2]
    return(x)
  }
  
  model_name= sapply(model_name,model_name_extract)
  model_name = as.character(model_name)
  
  model_name <<- model_name
  
  
  sub_cal_sum_ep<-function(i){
    tmpinput245 = list.files(input_ssp245[i],full.names = T)
    tmpinput585 = list.files(input_ssp585[i],full.names = T)
    
    tmpinput245 <<- tmpinput245
    tmpinput585 <<- tmpinput585
    
    j = 1:length(tmpinput245)
    j <<- j
    
    sub2_cal_sum_ep_ssp245 <- function(j){
      library(raster)
      library(ncdf4)
      library(doParallel)
      tmp = stack(tmpinput245[j])
      tmp = as.list(tmp)
      
      sum_fun <- function(x){
        x = cellStats(x,'sum',na.rm = T)
      }
      
      tmps = lapply(tmp,sum_fun)
      tmps = do.call('c',tmps)
      return(tmps)
    }
    
    sub2_cal_sum_ep_ssp585 <- function(j){
      library(raster)
      library(ncdf4)
      library(doParallel)
      tmp = stack(tmpinput585[j])
      tmp = as.list(tmp)
      
      sum_fun <- function(x){
        x = cellStats(x,'sum',na.rm = T)
      }
      
      tmps = lapply(tmp,sum_fun)
      tmps = do.call('c',tmps)
      return(tmps)
    }
    
    if(mode =='eu' & i == 4){
      tmpb = 1
      for(j in j){
        if(j == 3){
          library(data.table)
          tmpdf = fread(tmpinput245[3])
          tmpdf = tmpdf[,-c(1,2)]
          sum_fun2 <- function(x){
            x = sum(x,na.rm = T)
          }
          
          tmpdf = apply(tmpdf,2,sum_fun2)
          tmpdf = as.numeric(tmpdf)
        }else{
          tmpdf = sub2_cal_sum_ep_ssp245(j)
        }
        tmpb = cbind(tmpb,tmpdf)
      }
      tmpb = tmpb[,-1]
      colnames(tmpb) = model_name
      fwrite(tmpb,output245[i])
    }else{
      library(doParallel)
      cl = makeCluster(8)
      clusterExport(cl,c('tmpinput245','j'))
      ret = parLapply(cl,j,sub2_cal_sum_ep_ssp245)
      stopCluster(cl)
      
      ret = do.call('cbind',ret)
      
      colnames(ret) = model_name
      fwrite(ret,output245[i])
      
      
    }
    
    if(mode =='eu' & i == 4){
      tmpb = 1
      for(j in j){
        if(j == 3){
          library(data.table)
          tmpdf = fread(tmpinput585[3])
          tmpdf = tmpdf[,-c(1,2)]
          sum_fun2 <- function(x){
            x = sum(x,na.rm = T)
          }
          
          tmpdf = apply(tmpdf,2,sum_fun2)
          tmpdf = as.numeric(tmpdf)
        }else{
          tmpdf = sub2_cal_sum_ep_ssp585(j)
        }
        tmpb = cbind(tmpb,tmpdf)
      }
      tmpb = tmpb[,-1]
      colnames(tmpb) = model_name
      fwrite(tmpb,output585[i])
    }else{
      library(doParallel)
      cl = makeCluster(8)
      clusterExport(cl,c('tmpinput585','j'))
      ret = parLapply(cl,j,sub2_cal_sum_ep_ssp585)
      stopCluster(cl)
      
      ret = do.call('cbind',ret)
      
      colnames(ret) = model_name
      fwrite(ret,output585[i])
    }
    
    
    
    
  }
  
  
  sub_cal_sum_ep(1)
  sub_cal_sum_ep(2)
  sub_cal_sum_ep(3)
  sub_cal_sum_ep(4)
  
  print(paste0('pass ',mode))
}
cal_sum_eva_in_source_based_on_era5 <- function(
  
){
  mode = c('ato','as','eu')
  ### calculation of precipitation on
  source('/home/share/R_project/xinjiang_vapor/mask_era5_eva.R')
  mask_era5_eva('ato')
  mask_era5_eva('as')
  mask_era5_eva('eu')
  
  #mode = c('ato','as','eu')
  source('/home/share/R_project/xinjiang_vapor/sub_cal_sum_eva_in_source.R')
  system.time(lapply(mode,sub_cal_sum_eva_in_source))
  
  
}
cal_sum_p_in_source_based_on_era5 <- function(
  
){
  mode = c('ato','as','eu')
  ### calculation of precipitation on
  source('/home/share/R_project/xinjiang_vapor/mask_era5_p.R')
  source('/home/share/R_project/xinjiang_vapor/sub_cal_sum_pr_in_source.R')
  
  mask_era5_p('ato')
  mask_era5_p('as')
  mask_era5_p('eu')
  
  mode = c('ato','as','eu')
  system.time(lapply(mode,sub_cal_sum_pr_in_source))
  
  
}
cal_sum_p_in_source_based_on_gpcc <- function(
  
){
  mode = c('ato','as','eu')
  ### calculation of precipitation on
  source('/home/share/R_project/xinjiang_vapor/sub_cal_sum_pr_in_source_based_gpcc.R')
  source('/home/share/R_project/xinjiang_vapor/mask_gpcc_p.R')
  
  mask_gpcc_p('ato')
  mask_gpcc_p('as')
  mask_gpcc_p('eu')
  
  mode = c('ato','as','eu')
  system.time(lapply(mode,sub_cal_sum_pr_in_source_based_gpcc))
  
  
}
cal_sum_pe_in_source_based_on_era5 <- function(
  
){
  mode = c('ato','as','eu')
  ### calculation of precipitation on
  source('/home/share/R_project/xinjiang_vapor/mask_era5_p_er.R')
  source('/home/share/R_project/xinjiang_vapor/sub_cal_mean_pe_in_source.R') 
  system.time(lapply(mode,mask_era5_p_er))
  
  mask_era5_p_er('ato')
  mask_era5_p_er('as')
  mask_era5_p_er('eu')
  
  mode = c('ato','as','eu')
  system.time(lapply(mode,sub_cal_sum_pe_in_source))
  
  
}
cal_sum_poten_evap_in_source_based_on_era5<-function(
  
){
  mode = c('as','ato','eu')
  source('/home/share/R_project/xinjiang_vapor/mask_era5_poten_evap.R')
  mask_era5_poten_evap(mode[1])
  mask_era5_poten_evap(mode[2])
  mask_era5_poten_evap(mode[3])
  
  source('/home/share/R_project/xinjiang_vapor/sub_cal_sum_pet_in_source.R')
  lapply(mode,sub_cal_sum_pet_in_source)
  
  
  
  
}
cal_sum_tws_in_source_based_on_era5 <- function(
  
){
  library(data.table)
  library(raster)
  library(ncdf4)
  mode = c('ato','as','eu')
  ### calculation of precipitation on
  source('/home/share/R_project/xinjiang_vapor/mask_grace_tws.R')
  source('/home/share/R_project/xinjiang_vapor/sub_cal_sum_tws_in_source.R')
  
  mask_grace_tws('ato')
  mask_grace_tws('as')
  mask_grace_tws('eu')
  
  mode = c('ato','as','eu')
  system.time(lapply(mode,sub_cal_sum_tws_in_source))
  
  
}
cal_temp_in_each_region_based_cmip6 <-function(
  cmip6_model,
  pattern = 'hist_ssp245'
){
  # input_shp
  #
  source('/home/share/R_project/xinjiang_vapor/import_cmip6_combined_.R')
  cmip6_temp = import_cmip6_combined(pattern,'T',cmip6_model)
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  
  south = shp_management('xinjiang_south')
  north = shp_management('xinjiang_north')
  
  crs(south) = crs(south_moun)
  crs(north) = crs(north_moun)
  
  output = 'temp_in_target_cmip6'
  dir.create(output)
  
  output = paste0(output,'/',pattern)
  dir.create(output)
  
  output = paste0(output,'/',cmip6_model)
  dir.create(output)
  
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  output = paste0(output,'/',files,'.csv')
  
  # cal north
  cal_pr_sum <-function(cmip6_temp,full_shp,shp_moun){
    cmip6_full = crop(cmip6_temp,full_shp)
    
    cmip6_moun = mask(cmip6_full,shp_moun)
    cmip6_moun = as.list(cmip6_moun)
    
    cmip6_full = mask(cmip6_full,full_shp)
    cmip6_full = as.list(cmip6_full)
    
    sum_fun <- function(x){
      xs = cellStats(x,mean,na.rm = T)
      return(xs)
    }
    
    moun_sum = lapply(cmip6_moun,sum_fun)
    full_sum = lapply(cmip6_full,sum_fun)
    
    moun_sum = do.call('c',moun_sum)
    full_sum = do.call('c',full_sum)
    
    jishui_sum = full_sum -moun_sum
    
    return(cbind(moun_sum,jishui_sum))
  }
  
  north_df = cal_pr_sum(cmip6_temp,north,north_moun)
  south_df = cal_pr_sum(cmip6_temp,south,south_moun)
  
  north_moun = data.frame(north_moun =north_df[,1])
  north_jishui = data.frame(north_jishui = north_df[,2])
  
  south_moun = data.frame(south_moun =south_df[,1])
  south_jishui = data.frame(south_jishui = south_df[,2])
  
  fwrite(north_moun,output[1])
  fwrite(north_jishui,output[2])
  fwrite(south_moun,output[3])
  fwrite(south_jishui,output[4])
  
  
  
  
}
cal_tmean_in_each_region_based_era5 <-function(
  
){
  # input_shp
  
  era5_t = data_management(mode = 'era5_temper')
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  
  south = shp_management('xinjiang_south')
  north = shp_management('xinjiang_north')
  
  crs(south) = crs(south_moun)
  crs(north) = crs(north_moun)
  
  output = 'temperature_in_target'
  dir.create(output)
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  output = paste0(output,'/',files,'.csv')
  
  # cal north
  cal_pr_sum <-function(era5_t,full_shp,shp_moun){
    era5_full = crop(era5_t,full_shp)
    
    era5_moun = mask(era5_full,shp_moun)
    era5_moun = as.list(era5_moun)
    
    era5_full = mask(era5_full,full_shp)
    era5_full = as.list(era5_full)
    
    sum_fun <- function(x){
      xs = cellStats(x,mean,na.rm = T)
      return(xs)
    }
    
    moun_sum = lapply(era5_moun,sum_fun)
    full_sum = lapply(era5_full,sum_fun)
    
    moun_sum = do.call('c',moun_sum)
    full_sum = do.call('c',full_sum)
    
    jishui_sum = full_sum -moun_sum
    
    return(cbind(moun_sum,jishui_sum))
  }
  
  north_df = cal_pr_sum(era5_t,north,north_moun)
  south_df = cal_pr_sum(era5_t,south,south_moun)
  
  north_moun = data.frame(north_moun =north_df[,1])
  north_jishui = data.frame(north_jishui = north_df[,2])
  
  south_moun = data.frame(south_moun =south_df[,1])
  south_jishui = data.frame(south_jishui = south_df[,2])
  
  fwrite(north_moun,output[1])
  fwrite(north_jishui,output[2])
  fwrite(south_moun,output[3])
  fwrite(south_jishui,output[4])
  
  
  
  
}
cal_tws_in_each_region_based_grace <-function(
  
){
  # input_shp
  
  era5_tws = data_management(mode = 'grace')
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  
  south = shp_management('xinjiang_south')
  north = shp_management('xinjiang_north')
  
  crs(south) = crs(south_moun)
  crs(north) = crs(north_moun)
  
  output = 'tws_in_target'
  dir.create(output)
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  output = paste0(output,'/',files,'.csv')
  
  # cal north
  cal_pr_sum <-function(era5_tws,full_shp,shp_moun){
    era5_full = crop(era5_tws,full_shp)
    
    era5_moun = mask(era5_full,shp_moun)
    era5_moun = as.list(era5_moun)
    
    era5_full = mask(era5_full,full_shp)
    era5_full = as.list(era5_full)
    
    sum_fun <- function(x){
      xs = cellStats(x,sum,na.rm = T)
      return(xs)
    }
    
    moun_sum = lapply(era5_moun,sum_fun)
    full_sum = lapply(era5_full,sum_fun)
    
    moun_sum = do.call('c',moun_sum)
    full_sum = do.call('c',full_sum)
    
    jishui_sum = full_sum -moun_sum
    
    return(cbind(moun_sum,jishui_sum))
  }
  
  north_df = cal_pr_sum(era5_tws,north,north_moun)
  south_df = cal_pr_sum(era5_tws,south,south_moun)
  
  north_moun = data.frame(north_moun =north_df[,1])
  north_jishui = data.frame(north_jishui = north_df[,2])
  
  south_moun = data.frame(south_moun =south_df[,1])
  south_jishui = data.frame(south_jishui = south_df[,2])
  
  fwrite(north_moun,output[1])
  fwrite(north_jishui,output[2])
  fwrite(south_moun,output[3])
  fwrite(south_jishui,output[4])
  
  
  
  
}
cal_uptake_ratio_in_each_squared_region<-function(
  mode = 'ato'
){
  
  library(raster)
  library(maps)
  library(maptools)
  library(ggplot2)
  library(reshape2)
  library(RColorBrewer)
  library(data.table)
  library(foreach)
  library(doParallel)
  library(parallel)
  library(snow)
  library(doParallel)
  library(snow)
  library(foreach)
  library(parallel)
  library(factoextra)
  library(vegan)
  library(dplyr)
  library(plyr)
  
  first_files = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
  whole_files = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
  if(mode == 'ato'){
    first_files = paste0(first_files,'/output/contr_released_ocean/')
    #shp = shp_management('ocean',mode)
  }else{
    first_files = paste0(first_files,'/output/contr_released_land/')
    #shp = shp_management('land',mode)
  }
  whole_files = paste0(whole_files,'/output/masked_var_whole_route_mid.csv')
  first_files = paste0(first_files,mode,'.csv')
  
  region_file = paste0('cluster_shp/',mode,'/',mode,1:4,'.shp')
  region_file <<- region_file
  
  
  whole_files <<- whole_files
  first_files <<- first_files
  
  output_file = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
  output_file = paste0(output_file,'/output/convey_rate_df')
  #for(i in 1:length(output_file)){
  #  dir.create(output_file[i])
  #}
  
  output_file = paste0(output_file,'/',mode,'.csv')
  output_file <<- output_file
  i = 1:length(first_files)
  i <<- i
  sub_cal_uptake <- function(i){
    library(dplyr)
    library(data.table)
    library(raster)
    df_whole = fread(whole_files[i])
    df_first = fread(first_files[i])
    df_first$uptake_in_region = NA
    
    regid = as.numeric(unique(df_first$region_label))
    regid = sort(regid)
    
    for(j in regid){
      regionid = which(df_first$region_label == j)
      
      type = df_first$type[regionid]
      
      typeid = which(df_whole$type %in% type)
      
      df_region = df_whole[typeid,]
      
      reg_shp = shapefile(region_file[j])
      reg_shp = extent(reg_shp)
      
      minlong = reg_shp[1]
      maxlong = reg_shp[2]
      minlat = reg_shp[3]
      maxlat = reg_shp[4]
      
      id_in_region = which(df_region[,1]<=maxlong &
              df_region[,1]>=minlong &
              df_region[,2] <=maxlat &
              df_region[,2]>=minlat)
      
      df_in_region = df_region[id_in_region,]
      sum_fun<-function(x){
        x = sum(x,na.rm = T)
        return(x)
      }
      varep_in_region = aggregate(df_in_region$varep,list(df_in_region$type),sum_fun)
      
      first_type_id = which(df_first$type %in% varep_in_region[,1])
      
      df_first$uptake_in_region[first_type_id] = varep_in_region[,2]
      #print(j)
    }
    df_first$convey_rate = abs(df_first$contr_value)/df_first$uptake_in_region
    
    id_pos = which(df_first$uptake_in_region >0)
    df_convey = df_first[id_pos,]
    fwrite(df_convey,output_file[i])
  }
  
  cl = makeCluster(15)
  clusterExport(cl,c('whole_files','first_files','output_file','region_file','i'))
  #system.time(lapply(i,sub_cal_uptake))
  system.time(parLapply(cl,i,sub_cal_uptake))
  stopCluster(cl)
  
}
calc_cluster_traj_with_height<-function(
  
){
  input_files = list.files('/media/sdb1/xinjiang_output_file',
                           full.names = T)
  
  
  input_files <<- input_files
  input_land = paste0(input_files,'/output/contr_released_land')
  input_ocean = paste0(input_files,'/output/contr_released_ocean')
  input_land <<- input_land
  input_ocean <<- input_ocean
  
  output_files = paste0(input_files,'/output/cluster_traj_loc_with_height.csv')
  output_files <<- output_files
  
  library(data.table)
  library(raster)
  library(reshape2)
  
  
  time = c('JAN','FEB','MAR','APR','MAY',"JUN",
           'JUL',"AUG",'SEP','OCT','NOV',"DEC")
  
  i = 1:180
  i <<- i
  cluster_k_mean<-function(i){
    library(data.table)
    library(raster)
    library(dplyr)
    input_sub = paste0(input_files[i],'/output/masked_var_whole_route_mid.csv')
    df = fread(input_sub)
    df = as.data.frame(df)
    
    ret_fun <-function(x){
      len = length(x)
      if(len < 38){
        dif = 38-len 
        addna = rep(NA,dif)
        x = c(x,addna)
      }else if(len > 38){
        return(NULL)
      }
      return(x)
    }
    
    
    long = aggregate(df$long,list(df$type),ret_fun)[,2]
    lat = aggregate(df$lat,list(df$type),ret_fun)[,2]
    height = aggregate(df$height,list(df$type),ret_fun)[,2]
    
    
    dim = dim(long)
    if(length(dim) == 0){
      long = do.call('rbind',long)  
    }
    
    dim = dim(lat)
    if(length(dim) == 0){
      lat = do.call('rbind',lat)  
    }
    
    dim = dim(height)
    if(length(dim) == 0){
      height = do.call('rbind',height)
    }
    
    
    feature= cbind(long,lat,height)
    set.seed(4321)
    cl = kmeans(na.omit(feature),13)
    
    cluster = cl$centers
    fwrite(cluster,output_files[i])
    #print(i)
    return(cluster)
  }
  
  # Calculation of trajectory
  ########
  i1 = seq(1,180,10)
  i2 = seq(10,180,10)
  
  ilist = list()
  for(j in 1:length(i1)){
    ilist[[j]] = i1[j]:i2[j]
  }
  library(doParallel)
  ret_traj_box = list()
  for(j in 1:length(i1)){
    i = ilist[[j]]
    i <<- i
    
    cl = makeCluster(10)
    clusterExport(cl,c('input_files','i','output_files'))
    system.time(ret_traj_loc <- parLapply(cl,i,cluster_k_mean))
    stopCluster(cl)
    
    ret_traj_box = c(ret_traj_box,ret_traj_loc)
    print(j)
  }
  ########
  
  ret_traj_box = lapply(output_files,fread)
  ret_traj_box = lapply(ret_traj_box,as.data.frame)
  
  janid = seq(1,180,12)
  febid = seq(2,180,12)
  marid = seq(3,180,12)
  aprid = seq(4,180,12)
  mayid = seq(5,180,12)
  junid = seq(6,180,12)
  julid = seq(7,180,12)
  augid = seq(8,180,12)
  sepid = seq(9,180,12)
  octid = seq(10,180,12)
  novid = seq(11,180,12)
  decid = seq(12,180,12)
  
  monid = list(janid,febid,marid,aprid,mayid,junid,
               julid,augid,sepid,octid,novid,decid)
  
  ret_traj_box <<- ret_traj_box
  i = 1:12
  i <<- i
  monname = c('JAN','FEB','MAR','APR','MAY',"JUN",
              'JUL',"AUG",'SEP','OCT','NOV',"DEC")
  monname <<- monname
  output_monthly_traj = 'monthly_kmeans_traj_with_height'
  dir.create(output_monthly_traj)
  output_monthly_traj = paste0(output_monthly_traj,'/',
                               monname,'.csv')
  output_monthly_traj <<- output_monthly_traj
  monthly_cluster_loc<-function(i){
    tmpid = monid[[i]]
    traj_mon = ret_traj_box[tmpid]
    traj_mon = do.call('rbind',traj_mon)
    
    cl = kmeans(traj_mon,13)
    
    cluster = cl$centers
    colnames(cluster) = c(paste0('long',1:38),
                          paste0('lat',1:38),
                          paste0('heihgt',1:38))
    
    long = cluster[,1:38]
    lat = cluster[,39:76]
    height = cluster[,77:114]
    
    routeid = 1:13
    
    longdf = data.frame(routeid,long)
    latdf = data.frame(routeid,lat)
    heightdf = data.frame(routeid,height)
    
    
    longdf = reshape2::melt(longdf,'routeid')
    latdf = reshape2::melt(latdf,'routeid')
    heightdf = reshape2::melt(heightdf,'routeid')
    
    retdf = data.frame(routeid = longdf$routeid,
                       variable = longdf$variable,
                       long = longdf$value,
                       lat = latdf$value,
                       height = heightdf$value,
                       month = monname[i])
    fwrite(retdf,output_monthly_traj[i])
    
    return(retdf)
  }
  mon_kmean_traj = lapply(i,monthly_cluster_loc)
  
  traj_df_by_mon = do.call('rbind',mon_kmean_traj)
  traj_df_by_mon$group = paste0(traj_df_by_mon$month,'_',
                                traj_df_by_mon$routeid)
  
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management("world")
  world = crop(world,extent(-180,180,0,90))
  
  xj = shp_management('xinjiang')
  
  library(RColorBrewer)
  mycolor = colorRampPalette(brewer.pal(11,'Spectral'))(12)
  
  
  library(ggplot2)
  # Trajectory Plot
  #####
  p = ggplot()+
    geom_polygon(data = world,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 1)+
    geom_polygon(data = xj,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 1)+
    geom_path(data = traj_df_by_mon,aes(x = long,y = lat,
                                        group = group,
                                        color = month))+
    scale_color_manual(values = mycolor)+
    facet_wrap(~month,nrow = 4)+
    theme_bw()
  #####
  
  #
  
  
  
}
calc_cluster_traj<-function(
  
){
  input_files = list.files('/media/sdb1/xinjiang_output_file',
                           full.names = T)
  
  
  input_files <<- input_files
  input_land = paste0(input_files,'/output/contr_released_land')
  input_ocean = paste0(input_files,'/output/contr_released_ocean')
  input_land <<- input_land
  input_ocean <<- input_ocean
  
  output_files = paste0(input_files,'/output/cluster_traj_loc.csv')
  output_files <<- output_files
  
  library(data.table)
  library(raster)
  library(reshape2)
  
  
  time = c('JAN','FEB','MAR','APR','MAY',"JUN",
           'JUL',"AUG",'SEP','OCT','NOV',"DEC")
  
  i = 1:180
  i <<- i
  cluster_k_mean<-function(i){
    library(data.table)
    library(raster)
    library(dplyr)
    input_sub = paste0(input_files[i],'/output/masked_var_whole_route_mid.csv')
    df = fread(input_sub)
    df = as.data.frame(df)
    
    ret_fun <-function(x){
      len = length(x)
      if(len < 38){
        dif = 38-len 
        addna = rep(NA,dif)
        x = c(x,addna)
      }else if(len > 38){
        return(NULL)
      }
      return(x)
    }
    
    
    long = aggregate(df$long,list(df$type),ret_fun)[,2]
    lat = aggregate(df$lat,list(df$type),ret_fun)[,2]
    
    dim = dim(long)
    if(length(dim) == 0){
      long = do.call('rbind',long)  
    }
    
    dim = dim(lat)
    if(length(dim) == 0){
      lat = do.call('rbind',lat)  
    }
    
    
    feature= cbind(long,lat)
    set.seed(4321)
    cl = kmeans(na.omit(feature),13)
    
    cluster = cl$centers
    fwrite(cluster,output_files[i])
    #print(i)
    return(cluster)
  }
  
  # Calculation of trajectory
  ########
  i1 = seq(1,180,10)
  i2 = seq(10,180,10)
  
  ilist = list()
  for(j in 1:length(i1)){
    ilist[[j]] = i1[j]:i2[j]
  }
  library(doParallel)
  ret_traj_box = list()
  for(j in 1:length(i1)){
    i = ilist[[j]]
    i <<- i
    
    cl = makeCluster(10)
    clusterExport(cl,c('input_files','i','output_files'))
    system.time(ret_traj_loc <- parLapply(cl,i,cluster_k_mean))
    stopCluster(cl)
    
    ret_traj_box = c(ret_traj_box,ret_traj_loc)
    print(j)
  }
  ########
  
  janid = seq(1,180,12)
  febid = seq(2,180,12)
  marid = seq(3,180,12)
  aprid = seq(4,180,12)
  mayid = seq(5,180,12)
  junid = seq(6,180,12)
  julid = seq(7,180,12)
  augid = seq(8,180,12)
  sepid = seq(9,180,12)
  octid = seq(10,180,12)
  novid = seq(11,180,12)
  decid = seq(12,180,12)
  
  monid = list(janid,febid,marid,aprid,mayid,junid,
               julid,augid,sepid,octid,novid,decid)
  
  ret_traj_box <<- ret_traj_box
  i = 1:12
  i <<- i
  monname = c('JAN','FEB','MAR','APR','MAY',"JUN",
              'JUL',"AUG",'SEP','OCT','NOV',"DEC")
  monname <<- monname
  output_monthly_traj = 'monthly_kmeans_traj'
  dir.create(output_monthly_traj)
  output_monthly_traj = paste0(output_monthly_traj,'/',
                               monname,'.csv')
  output_monthly_traj <<- output_monthly_traj
  monthly_cluster_loc<-function(i){
    tmpid = monid[[i]]
    traj_mon = ret_traj_box[tmpid]
    traj_mon = do.call('rbind',traj_mon)
    
    cl = kmeans(traj_mon,13)
    
    cluster = cl$centers
    colnames(cluster) = c(paste0('long',1:38),
                          paste0('lat',1:38))
    
    long = cluster[,1:38]
    lat = cluster[,39:76]
    
    routeid = 1:13
    
    longdf = data.frame(routeid,long)
    latdf = data.frame(routeid,lat)
    
    longdf = reshape2::melt(longdf,'routeid')
    latdf = reshape2::melt(latdf,'routeid')
    
    retdf = data.frame(routeid = longdf$routeid,
                       variable = longdf$variable,
                       long = longdf$value,
                       lat = latdf$value,
                       month = monname[i])
    fwrite(retdf,output_monthly_traj[i])
    
    return(retdf)
  }
  mon_kmean_traj = lapply(i,monthly_cluster_loc)
  
  traj_df_by_mon = do.call('rbind',mon_kmean_traj)
  traj_df_by_mon$group = paste0(traj_df_by_mon$month,'_',
                                traj_df_by_mon$routeid)
  
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management("world")
  world = crop(world,extent(-180,180,0,90))
  
  xj = shp_management('xinjiang')
  
  library(RColorBrewer)
  mycolor = colorRampPalette(brewer.pal(11,'Spectral'))(12)
  
  
  library(ggplot2)
  # Trajectory Plot
  #####
  p = ggplot()+
    geom_polygon(data = world,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 1)+
    geom_polygon(data = xj,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 1)+
    geom_path(data = traj_df_by_mon,aes(x = long,y = lat,
                                        group = group,
                                        color = month))+
    scale_color_manual(values = mycolor)+
    facet_wrap(~month,nrow = 4)+
    theme_bw()
  #####
  
  #
  
  
  
}
calc_cmip6_pme_by_source_yrb <- function(
  region = 'ato')
{
  library(raster)
  if(region == 'ato'){
    shp  = shp_management('ocean',region)  
    cluster_shp = '/home/share/R_project/xinjiang_vapor/cluster_shp/ato'
    cluster_shp = list.files(cluster_shp,full.names = T,pattern = '*.shp$')[1:4]
    cluster_shp = lapply(cluster_shp,shapefile)
  }else{
    shp = shp_management('ocean',region)
    cluster_shp = 'shp/po_box/'
    cluster_shp = list.files(cluster_shp,full.names = T,pattern = '*.shp$')
    cluster_shp = lapply(cluster_shp,shapefile)
  }
  
  input_pme = 'Data/cmip6_pme_global'
  input_pme245 = paste0(input_pme,'/hist_ssp245')
  input_pme585 = paste0(input_pme,'/hist_ssp585')
  
  input_pme245 = list.files(input_pme245,full.names = T)
  input_pme585 = list.files(input_pme585,full.names = T)
  
  i = 1:8
  i <<- i 
  input_pme245 <<- input_pme245
  input_pme585 <<- input_pme585
  shp <<- shp
  cluster_shp <<- cluster_shp
  sub_calc_fun245 <-function(i){
    library(raster)
    tmppme = stack(input_pme245[i])
    tmppme = mask(crop(tmppme,shp),shp)
    
    j = 1:4
    
    sub_calc_sum <-function(j){
      maskpme = crop(tmppme,cluster_shp[[j]])
      maskpme = as.list(maskpme)
      maskpme = lapply(maskpme,cellStats,stat = 'sum',na.rm = T)
      maskpme = do.call('c',maskpme)
      return(maskpme)
      
    }
    tmp_pme_cl = lapply(j,sub_calc_sum)
    tmp_pme_cl = do.call('cbind',tmp_pme_cl)
    return(tmp_pme_cl)
  }
  sub_calc_fun585 <-function(i){
    library(raster)
    tmppme = stack(input_pme585[i])
    tmppme = mask(crop(tmppme,shp),shp)
    
    j = 1:4
    
    sub_calc_sum <-function(j){
      maskpme = crop(tmppme,cluster_shp[[j]])
      maskpme = as.list(maskpme)
      maskpme = lapply(maskpme,cellStats,stat = 'sum',na.rm = T)
      maskpme = do.call('c',maskpme)
      return(maskpme)
      
    }
    tmp_pme_cl = lapply(j,sub_calc_sum)
    tmp_pme_cl = do.call('cbind',tmp_pme_cl)
    return(tmp_pme_cl)
  }
  
  
  output = 'output/cmip6_pmesum_in_source'
  dir.create(output)
  output = paste0(output,'/',region)
  dir.create(output)
  output245 = paste0(output,'/cmip6_pme_ssp245.csv')
  output585= paste0(output,'/cmip6_pme_ssp585.csv')
  
  library(doParallel)
  cl = makeCluster(9)
  clusterExport(cl,c('i','input_pme245','cluster_shp','shp'))
  ret245 = parLapply(cl,i,sub_calc_fun245)
  stopCluster(cl)
  
  cl = makeCluster(9)
  clusterExport(cl,c('i','input_pme585','cluster_shp','shp'))
  ret585 = parLapply(cl,i,sub_calc_fun585)
  stopCluster(cl)
  
  ret245 = do.call('cbind',ret245)
  ret585 = do.call('cbind',ret585)
  
  colnames(ret245) = model
  colnames(ret585) = model
  library(data.table)
  fwrite(ret245,output245)
  fwrite(ret585,output585)
  
  
  print(paste0('pass ',region))
  
}
calc_each_dqt_group <- function(x){
  xstype = x$type[1]
  xetype = x$type[length(x$type)]
  
  tmpids = min(which(df_full$type ==xstype))
  tmpide = max(which(df_full$type ==xetype))
  
  df_sec <<- df_full[tmpids:tmpide,]
  x<<- x
  idu = unique(x$type)
  
  calc_by_id <- function(id){
    tmpidu = which(x$type == id)
    print(id)
    if(length(tmpidu)==1){
      tmpidfull = which(df_sec$type == id)
      len1 = length(tmpidfull)
      len2 = len1 -1
      tmpdf = df_sec[len2:len1,]
      
      tmpdq = tmpdf$varep[2] - tmpdf$varep[1]
    }else if (length(tmpidu) ==2){
      tmpdf = x[tmpidu,]
      tmpdq = tmpdf$varep[2] - tmpdf$varep[1]
    }else{
      len1 = length(tmpidu)
      len2 = len1 - 1
      tmpdq1 = x$varep[2:len1] # end
      tmpdq2 = x$varep[1:len2] # start
      tmpdq = tmpdq1-tmpdq2
      
    }
    tmpdq = sum(tmpdq)
    return(tmpdq)
  }
  
  cl = makeCluster(detectCores()-2)
  clusterExport(cl,c('df_sec','x'))
  system.time(
    ret_box <- parLapply(cl,idu,calc_by_id)
  )
  stopCluster(cl)
  ret_box = do.call('c',ret_box)
  return(ret_box)
}
calc_figs3_sig <- function(
  
){
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pe_in_source = pe_in_source * 30.5
  
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  pe_minus_eva = pe_in_source - pet_sum
  colnames(pe_minus_eva) = paste0('pme',1:12)
  pmedf = pe_minus_eva[,1:11]
  
  tws_in_source = import_pe_in_source('tws_in_source',
                                      name = 'tws_sum.csv')
  colnames(tws_in_source) = paste0('tws',1:12)
  tws_in_source = tws_in_source[,1:11]
  tws_in_source  =as.data.frame(tws_in_source)
  
  input_pr_intarget = list.files('era5_pr_in_target',
                                 full.names = T)[c(1,3)]
  input_eva_intarget = list.files('poten_evap_in_target',
                                  full.names =T)[c(1,3)]
  prtar = lapply(lapply(input_pr_intarget,fread),
                 as.data.frame)
  evatar = lapply(lapply(input_eva_intarget,fread),
                  as.data.frame)
  
  prtar = do.call('cbind',prtar)
  evatar = do.call('cbind',evatar)
  
  #prtar = apply(prtar,1,sum,na.rm =T)
  #evatar = apply(evatar,1,sum,na.rm = T)
  
  pmetar = prtar-evatar
  pmetar = pmetar[1:174,]
  
  input_tws = 'tws_in_target/'
  input_tws = list.files(input_tws,
                         full.names = T)[c(1,3)]
  
  twstar = lapply(lapply(input_tws,
                         fread),
                  as.data.frame)
  twstar = do.call('cbind',twstar)
  
  #twstar = apply(twstar,1,sum,na.rm = T)
  
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  pmedf = apply(pmedf,2,trend_fun)
  twsdf = apply(tws_in_source,2,trend_fun)
  #pmetar = trend_fun(pmetar)
  #twstar = trend_fun(twstar)
  north_pme = trend_fun(pmetar[,1])
  north_tws = trend_fun(twstar[,1])
  south_pme = trend_fun(pmetar[,2])
  south_tws = trend_fun(twstar[,2])
  
  #twsdf = twsdf[,-c(1,3,5:8)]
  pmedf = pmedf[,-c(1,3)]
  
  corpme_nor = 1
  corpme_sou = 1
  p_nor = 1
  p_sou = 1
  
  for(i in 1:ncol(pmedf)){
    tmpcor_nor = cor(pmedf[,i],north_pme)
    #tmpcor_nor = max(ccf(pmedf[,i],north_pme,
    #                     lag.max = 3)$acf)
    tmp_p_nor = cor.test(pmedf[,i],north_pme)$p.value
    p_nor = c(p_nor,tmp_p_nor)
    corpme_nor = c(corpme_nor,tmpcor_nor)
    
    tmpcor_sou = cor(pmedf[,i],south_pme)
    tmp_p_sou = cor.test(pmedf[,i],south_pme)$p.value
    p_sou = c(p_sou,tmp_p_sou)
    
    #tmpcor_sou = max(ccf(pmedf[,i],south_pme,
    #                     lag.max = 3)$acf)
    corpme_sou = c(corpme_sou,tmpcor_sou)
  }
  corpme_nor = corpme_nor[-1]
  corpme_sou = corpme_sou[-1]
  
  p_nor = p_nor[-1]
  p_sou = p_sou[-1]
  
  retdf = data.frame(
    region = c(paste0("AS",1:2),paste0('ATO',1:4),
               paste0('EU',1:3)),
    p_nor = p_nor,
    p_sou = p_sou
  )
  
  retdf$p_nor = scientific(retdf$p_nor,
                           2)
  retdf$p_sou = scientific(retdf$p_sou,
                           2)
  fwrite(retdf,'main_plot/SI/big_scale_pme_pme_cor/pvalue.csv')
  
  
}
calc_figS6_sig <- function(
  
){
  # cor plot 
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pe_in_source = pe_in_source * 30.5
  
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  pe_minus_eva = pe_in_source - pet_sum
  colnames(pe_minus_eva) = paste0('pme',1:12)
  pmedf = pe_minus_eva[,1:11]
  
  tws_in_source = import_pe_in_source('tws_in_source',
                                      name = 'tws_sum.csv')
  colnames(tws_in_source) = paste0('tws',1:12)
  tws_in_source = tws_in_source[,1:11]
  tws_in_source  =as.data.frame(tws_in_source)
  
  input_pr_intarget = list.files('era5_pr_in_target',
                                 full.names = T)[c(1,3)]
  input_eva_intarget = list.files('poten_evap_in_target',
                                  full.names =T)[c(1,3)]
  prtar = lapply(lapply(input_pr_intarget,fread),
                 as.data.frame)
  evatar = lapply(lapply(input_eva_intarget,fread),
                  as.data.frame)
  
  prtar = do.call('cbind',prtar)
  evatar = do.call('cbind',evatar)
  
  #prtar = apply(prtar,1,sum,na.rm =T)
  #evatar = apply(evatar,1,sum,na.rm = T)
  
  pmetar = prtar-evatar
  pmetar = pmetar[1:174,]
  
  input_tws = 'tws_in_target/'
  input_tws = list.files(input_tws,
                         full.names = T)[c(1,3)]
  
  twstar = lapply(lapply(input_tws,
                         fread),
                  as.data.frame)
  twstar = do.call('cbind',twstar)
  
  #twstar = apply(twstar,1,sum,na.rm = T)
  
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  pmedf = apply(pmedf,2,trend_fun)
  twsdf = apply(tws_in_source,2,trend_fun)
  #pmetar = trend_fun(pmetar)
  #twstar = trend_fun(twstar)
  north_pme = trend_fun(pmetar[,1])
  north_tws = trend_fun(twstar[,1])
  south_pme = trend_fun(pmetar[,2])
  south_tws = trend_fun(twstar[,2])
  
  twsdf = twsdf[,-c(1,3,5:8)]
  pmedf = pmedf[,5:8]
  
  corpme_nor = 1
  corpme_sou = 1
  pme_tws_p_nor = 1
  pme_tws_p_sou = 1
  for(i in 1:ncol(pmedf)){
    tmpcor_nor = cor(pmedf[,i],north_tws)
    tmp_p_nor = cor.test(pmedf[,i],north_tws)$p.value
    pme_tws_p_nor = c(pme_tws_p_nor,
                      tmp_p_nor)
    #tmpcor_nor = max(ccf(pmedf[,i],north_tws)$acf)
    corpme_nor = c(corpme_nor,tmpcor_nor)
    
    tmpcor_sou = cor(pmedf[,i],south_tws)
    tmp_p_sou = cor.test(pmedf[,i],south_tws)$p.value
    pme_tws_p_sou = c(pme_tws_p_sou,
                      tmp_p_sou)
    #tmpcor_sou = max(ccf(pmedf[,i],south_tws)$acf)
    corpme_sou = c(corpme_sou,tmpcor_sou)
  }
  corpme_nor = corpme_nor[-1]
  corpme_sou = corpme_sou[-1]
  pme_tws_p_nor = pme_tws_p_nor[-1]
  pme_tws_p_sou = pme_tws_p_sou[-1]
  
  ret_pmetwsp = data.frame(
    sou = paste0('ATO',1:4),
    pnor = pme_tws_p_nor,
    psou = pme_tws_p_sou
  )
  
  cordf1 = data.frame(
    x = paste0('ATO',1:4),
    COR_PME_TWS_North = corpme_nor,
    COR_PME_TWS_South = corpme_sou,
    type = 1
  )
  
  cortws_nor = 1
  cortws_sou = 1
  tws_tws_p_nor = 1
  tws_tws_p_sou = 1
  for(i in 1:ncol(twsdf)){
    tmpcor_nor = cor(twsdf[,i],north_tws)
    tmp_p_nor = cor.test(twsdf[,i],
                         north_tws)$p.value
    tws_tws_p_nor = c(tws_tws_p_nor,
                      tmp_p_nor)
    #tmpcor_nor = max(ccf(twsdf[,i],north_tws)$acf)
    cortws_nor = c(cortws_nor,tmpcor_nor)
    
    tmpcor_sou = cor(twsdf[,i],south_tws)
    tmp_p_sou = cor.test(twsdf[,i],
                         south_tws)$p.value
    tws_tws_p_sou = c(tws_tws_p_sou,
                      tmp_p_sou)
    #tmpcor_sou = max(ccf(twsdf[,i],south_tws)$acf)
    cortws_sou = c(cortws_sou,tmpcor_sou)
    
  }
  cortws_nor = cortws_nor[-1]
  cortws_sou = cortws_sou[-1]
  tws_tws_p_sou= tws_tws_p_sou[-1]
  tws_tws_p_nor = tws_tws_p_nor[-1]
  
  cordf2 = data.frame(
    x = c(paste0('AS',1:2),paste0('EU',1:3)),
    COR_TWS_TWS_North = cortws_nor,
    COR_TWS_TWS_South = cortws_sou,
    type = c(rep(3,2),rep(2,3))
  )
  ret_pmetwsp
  ret_twstwsp = data.frame(
    sou = c(paste0('AS',1:2),paste0('EU',1:3)),
    pnor = tws_tws_p_nor,
    psou = tws_tws_p_sou
  )
  
  ret_pmetwsp$pnor = scientific(ret_pmetwsp$pnor,
                                2)
  ret_pmetwsp$psou = scientific(ret_pmetwsp$psou,
                                2)
  ret_twstwsp$pnor = scientific(ret_twstwsp$pnor,
                                2)
  ret_twstwsp$psou = scientific(ret_twstwsp$psou,
                                2)
  
  fwrite(ret_pmetwsp,'main_plot/SI/big_scale_pme_tws_tws_cor/pmetwsp.csv')
  fwrite(ret_twstwsp,'main_plot/SI/big_scale_pme_tws_tws_cor/twstwsp.csv')
  
  
}
calc_figs9_sig <- function(
  
){
  # maps of subwindows 
  # cor analysis 
  input = paste0('sub_windows/sub_window',1:19,'.shp')
  shp = lapply(input,shapefile)
  
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pe_in_source = pe_in_source * 30.5
  
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  pe_minus_eva = pe_in_source - pet_sum
  colnames(pe_minus_eva) = paste0('pme',1:12)
  pmedf = pe_minus_eva[,5:8]
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  pmedf = apply(pmedf,2,trend_fun)
  
  
  input_tws_subwindow = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws_subs = read.csv(input_tws_subwindow,header = T)
  tws_subs = tws_subs[,-1]
  
  colnames(tws_subs) = paste0('subwindow',1:ncol(tws_subs))
  naid = which(is.na(tws_subs[,1]))
  tws_subs = tws_subs[-naid,]
  
  cor1 = 1
  cor2 = 1
  cor3 = 1
  cor4 = 1
  lag1 = 1
  lag2 = 1
  lag3 = 1
  lag4 = 1
  for(i in 1:ncol(tws_subs)){
    #tmpcor1 = cor(pmedf[,1],tws_subs[,i])
    #tmpcor2 = cor(pmedf[,2],tws_subs[,i])
    #tmpcor3 = cor(pmedf[,3],tws_subs[,i])
    #tmpcor4 = cor(pmedf[,4],tws_subs[,i])
    
    tmpcor1 = ccf(pmedf[,1],tws_subs[,i])
    tmpcor2 = ccf(pmedf[,2],tws_subs[,i])
    tmpcor3 = ccf(pmedf[,3],tws_subs[,i])
    tmpcor4 = ccf(pmedf[,4],tws_subs[,i])
    
    tmplag1 = tmpcor1$lag
    tmplag2 = tmpcor2$lag
    tmplag3 = tmpcor3$lag
    tmplag4 = tmpcor4$lag
    
    maxcor1 = max(tmpcor1$acf)
    maxcor2 = max(tmpcor2$acf)
    maxcor3 = max(tmpcor3$acf)
    maxcor4 = max(tmpcor4$acf)
    
    id1 = which.max(tmpcor1$acf)
    id2 = which.max(tmpcor2$acf)
    id3 = which.max(tmpcor3$acf)
    id4 = which.max(tmpcor4$acf)
    
    
    tmplag1 = tmplag1[id1]
    tmplag2 = tmplag2[id2]
    tmplag3 = tmplag3[id3]
    tmplag4 = tmplag4[id4]
    
    if(maxcor3>0.4){
      print(i)
    }
    cor1 = c(cor1,maxcor1)
    cor2 = c(cor2,maxcor2)
    cor3 = c(cor3,maxcor3)
    cor4 = c(cor4,maxcor4)
    
    
    lag1 = c(lag1,tmplag1)
    lag2 = c(lag2,tmplag2)
    lag3 = c(lag3,tmplag3)
    lag4 = c(lag4,tmplag4)
    
  }
  cor1 = cor1[-1]
  cor2 = cor2[-1]
  cor3 = cor3[-1]
  cor4 = cor4[-1]
  lag1 = lag1[-1]
  lag2 = lag2[-1]
  lag3 = lag3[-1]
  lag4 = lag4[-1]
  
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  shphigh = do.call(bind,shp[id_box])
  shplow = do.call(bind,shp[-id_box])
  
  
  atoshp = list.files('cluster_shp/ato',
                      full.names = T,
                      pattern = '*.shp$')[1:4]
  atoshp = lapply(atoshp,shapefile)
  cal_center_point <- function(x){
    xm = extent(x)
    latm = round((xm[3]+xm[4])/2)
    longm = round((xm[1]+xm[2])/2)
    rm = data.frame(x = longm,y = latm)
    return(rm)
  }
  
  dfhigh_label = lapply(shp[id_box],cal_center_point)
  dflow_label = lapply(shp[-id_box],cal_center_point)
  dfato_label = lapply(atoshp,cal_center_point)
  
  
  dfhigh_label = do.call(rbind,dfhigh_label)
  dflow_label = do.call(rbind,dflow_label)
  dfato_label = do.call(rbind,dfato_label)
  
  dfhigh_label$label = paste0('HSW','\n',1:10)
  dflow_label$label = paste0('LSW','\n',1:9)
  dfato_label$label = paste0('ATO',1:4)
  
  dfato_label$y[4] = dfato_label$y[4]+15
  dflabel = rbind(dfhigh_label,
                  dflow_label,
                  dfato_label)
  
  
  
  
  pals = pal_lancet(alpha = 0.8)(9)
  
  atoshp =do.call(bind,atoshp)
  trajs = fread('analysis_output/fig2/cluster_traj_df.csv')
  trajs = as.data.frame(trajs)
  route_col = pal_npg()(10)[4]
  route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
  
  
  
  psubs = ggplot()+
    geom_polygon(data = world,aes(x = long,y= lat,
                                  group= group),
                 size = 0.5,
                 color = 'black',
                 fill = 'grey80',
                 alpha= 0.8)+
    geom_path(data = trajs,aes(x = long,y = lat,
                               group = routeid,
                               color = factor(routeid,
                                              levels = 1:20)),
              size = 1,
              #color = route_col,
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="open"))+   
    scale_color_manual(values = route_col)+
    geom_polygon(data = atoshp,aes(x = long,y= lat,
                                   group= group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha= 0.5)+
    geom_polygon(data = shplow,aes(x = long,y= lat,
                                   group= group),
                 size = 0.5,
                 color = pals[4],
                 fill = pals[4],
                 alpha = 0.3)+
    geom_polygon(data = shphigh,aes(x = long,y = lat,
                                    group = group),
                 size = 0.5,
                 color = pals[7],
                 fill = pals[7],
                 alpha = 0.3)+
    geom_text_repel(data = dflabel,
                    aes(x = x,y = y,label = label),
                    size = 3.5,
                    color = 'black',
                    bg.color = 'white',
                    bg.r =0.25,
                    force = F)+
    theme_bw()
  
  dfcor = rbind(cor1,cor2,cor3,cor4)
  dfcorh = dfcor[,id_box]
  dfcorl = dfcor[,-id_box]
  
  colnames(dfcorh) = paste0('HSW',1:ncol(dfcorh))
  colnames(dfcorl) = paste0('LSW',1:ncol(dfcorl))
  
  dfcorh = data.frame(
    ATO = paste0('ATO',1:4),
    dfcorh
  )
  
  dfcorh = reshape2::melt(dfcorh,'ATO')
  
  
  dfcorl = data.frame(
    ATO = paste0('ATO',1:4),
    dfcorl
  )
  
  dfcorl = reshape2::melt(dfcorl,'ATO')
  
}
calc_index_st_by_ato_region<-function(
  
){
  mode = 'ato'
  input = paste0('/home/share/R_project/xinjiang_vapor/cluster_shp',
                 '/',mode,'/')
  input_shps = input
  input_shps = list.files(input_shps,full.names = T,
                          pattern = '*.shp$')[1:4]
  atos = lapply(input_shps,shapefile)
  
  input_loc_pme = 'NC_mod_xinjiang/svd_mca_analysis/whole_land/loc_pme.csv'
  input_loc_tws = 'NC_mod_xinjiang/svd_mca_analysis/whole_land/loc_whole_tws.csv'
  
  loc_pme = as.data.frame(fread(input_loc_pme))
  loc_tws = as.data.frame(fread(input_loc_tws))
  colnames(loc_pme) = c('long','lat')
  colnames(loc_tws) = c('long','lat')
  
  mask_pmepoint_by_extent<-function(i){
    tmp = atos[[i]]
    tmp = extent(tmp)
    
    id = which(loc_pme[,1]<=tmp[2] &
                 loc_pme[,1]>=tmp[1] &
                 loc_pme[,2] <=tmp[4] &
                 loc_pme[,2] >= tmp[3])
    return(id)
  }
  
  mask_twspoint_by_extent<-function(){
    tmp = c(-20,180,20,60)
    
    id = which(loc_tws[,1]<=tmp[2] &
                 loc_tws[,1]>=tmp[1] &
                 loc_tws[,2] <=tmp[4] &
                 loc_tws[,2] >= tmp[3])
    return(id)
  }
  
  i = 1:4
  pmeid = lapply(i,mask_pmepoint_by_extent)
  twsid = mask_twspoint_by_extent()
  
  # import pme u and pme_st
  pmev = as.data.frame(
    fread('NC_mod_xinjiang/svd_mca_analysis/whole_land/v_ecy.csv')
  )
  pmest = as.data.frame(
    fread('NC_mod_xinjiang/svd_mca_analysis/pme_st.csv')
  )
  pmest = t(pmest)
  
  i = 1:4
  
  calc_bjs_fun <- function(i){
    tmppmev = pmev[pmeid[[i]],]
    j = 1:162
    
    subs <- function(j){
      tmp2 = tmppmev[,j]
      bjs_pme = t(tmp2) %*% pmest[pmeid[[i]],]
      return(bjs_pme)
    }
    
    tmpbj = do.call(rbind,
                    lapply(j,subs))
    return(tmpbj)
  }
  
  pme_bi_li = lapply(i,calc_bjs_fun)
  
  
  
  
  
  
  
  
}
calc_long_term_contr_by_month<-function(
  
){
  
  input_files = list.files('/media/sdb1/xinjiang_output_file',
                           full.names = T)
  
  
  input_files <<- input_files
  input_land = paste0(input_files,'/output/contr_released_land')
  input_ocean = paste0(input_files,'/output/contr_released_ocean')
  input_land <<- input_land
  input_ocean <<- input_ocean
  
  time = c('JAN','FEB','MAR','APR','MAY',"JUN",
           'JUL',"AUG",'SEP','OCT','NOV',"DEC")
  
  i = 1:180
  i <<- i
  sub_calc<-function(i){
    library(data.table)
    library(raster)
    
    input_land_sub = list.files(input_land[i],full.names = T)
    input_ocean_sub = list.files(input_ocean[i],full.names = T)
    
    land_df = lapply(lapply(input_land_sub,fread),as.data.frame)
    ocean_df = lapply(lapply(input_ocean_sub,fread),as.data.frame)
    
    filter_col <-function(x){
      if(ncol(x) ==8){
        x = x[,1:7]
      }
      return(x)
    }
    
    land_df = lapply(land_df,filter_col)
    ocean_df = lapply(ocean_df,filter_col)
    
    land_df = do.call('rbind',land_df)
    ocean_df = do.call('rbind',ocean_df)
    
    df = rbind(land_df,ocean_df)
    #df$contr_rate = abs(df$contr_rate)
    
    df$contr_rate[which(df$contr_rate <0)] = 0
    
    df = cbind(df[,1:2],
               contr_rate = df$contr_rate*1000000) # 1 / 1000000
    
    r = raster(nrow = 360,ncol = 720) 
    coordinates(df) = ~ long+lat
    rdf = rasterize(df,r,'contr_rate')
    
    rdf1 = crop(rdf,extent(-180,180,0,90))
    
    return(rdf1)
    
    #df1_df = as.data.frame(rdf1,xy = T)
    #if(i >12){
    #  i = i -12
    #}
    
    
    #df1_df$type = time[i]
    #return(df1_df)
  }
  
  library(data.table)
  library(raster)
  library(reshape2)
  
  
  janid = seq(1,180,12)
  febid = seq(2,180,12)
  marid = seq(3,180,12)
  aprid = seq(4,180,12)
  mayid = seq(5,180,12)
  junid = seq(6,180,12)
  julid = seq(7,180,12)
  augid = seq(8,180,12)
  sepid = seq(9,180,12)
  octid = seq(10,180,12)
  novid = seq(11,180,12)
  decid = seq(12,180,12)
  
  monid = list(janid,febid,marid,aprid,mayid,junid,
               julid,augid,sepid,octid,novid,decid)
  
  
  library(doParallel)
  cl = makeCluster(12)
  clusterExport(cl,c('i',"input_land",'input_ocean'))
  system.time(season_box <- parLapply(cl,i,sub_calc))
  stopCluster(cl)
  
  #season_box = lapply(i,sub_calc)
  season_box = do.call('stack',season_box)
  
  #season_box = season_box *-1
  cell_calc_fun<-function(x){
    xmean = mean(x,na.rm = T)
    return(xmean)
  }
  cell_sum_fun<-function(x){
    xsum = sum(x,na.rm = T)
    return(xsum)
  }
  
  
  jan_contr = calc(season_box[[janid]],
                   cell_calc_fun)
  feb_contr = calc(season_box[[febid]],
                   cell_calc_fun)
  mar_contr = calc(season_box[[marid]],cell_calc_fun)
  apr_contr = calc(season_box[[aprid]],cell_calc_fun)
  may_contr = calc(season_box[[mayid]],cell_calc_fun)
  jun_contr = calc(season_box[[junid]],cell_calc_fun)
  jul_contr = calc(season_box[[julid]],cell_calc_fun)
  aug_contr = calc(season_box[[augid]],cell_calc_fun)
  sep_contr = calc(season_box[[sepid]],cell_calc_fun)
  oct_contr = calc(season_box[[octid]],cell_calc_fun)
  nov_contr = calc(season_box[[novid]],cell_calc_fun)
  dec_contr = calc(season_box[[decid]],cell_calc_fun)
  
  contr_by_month = list(jan_contr,
                         feb_contr,
                         mar_contr,
                         apr_contr,
                         may_contr,
                         jun_contr,
                         jul_contr,
                         aug_contr,
                         sep_contr,
                         oct_contr,
                         nov_contr,
                         dec_contr)
  
  
  contr_by_month = calc(contr_by_month,cell_sum_fun)
  
  
  contr_by_month = lapply(contr_by_month,as.data.frame,
                         xy  =T)
  
  monname = c('JAN','FEB','MAR','APR','MAY',"JUN",
              'JUL',"AUG",'SEP','OCT','NOV',"DEC")
  
  contr_by_month[[1]]$type = monname[1]
  contr_by_month[[2]]$type = monname[2]
  contr_by_month[[3]]$type = monname[3]
  contr_by_month[[4]]$type = monname[4]
  contr_by_month[[5]]$type = monname[5]
  contr_by_month[[6]]$type = monname[6]
  contr_by_month[[7]]$type = monname[7]
  contr_by_month[[8]]$type = monname[8]
  contr_by_month[[9]]$type = monname[9]
  contr_by_month[[10]]$type = monname[10]
  contr_by_month[[11]]$type = monname[11]
  contr_by_month[[12]]$type = monname[12]
  
  contr_by_month = do.call('rbind',contr_by_month)
  mean_df = contr_by_month
  colnames(mean_df) = c('x','y','contr_rate','type')
  
  output = 'analysis_output/mean_contr_raster_bymonth.csv'
  fwrite(mean_df,output)
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
}
calc_long_term_contri <- function(
  
){
  library(raster)
  library(data.table)
  library(reshape2)
  library(dplyr)
  library(doParallel)
  
  input_files = list.files('/media/sdb1/xinjiang_output_file',
                           full.names = T)
  
  
  input_files <<- input_files
  input_land = paste0(input_files,'/output/contr_released_land')
  input_ocean = paste0(input_files,'/output/contr_released_ocean')
  input_land <<- input_land
  input_ocean <<- input_ocean
  
  time = c('JAN','FEB','MAR','APR','MAY',"JUN",
           'JUL',"AUG",'SEP','OCT','NOV',"DEC")
  
  i = 1:180
  i <<- i
  sub_calc<-function(i){
    library(data.table)
    library(raster)
    
    input_land_sub = list.files(input_land[i],full.names = T)
    input_ocean_sub = list.files(input_ocean[i],full.names = T)
    
    land_df = lapply(lapply(input_land_sub,fread),as.data.frame)
    ocean_df = lapply(lapply(input_ocean_sub,fread),as.data.frame)
    
    filter_col <-function(x){
      if(ncol(x) ==8){
        x = x[,1:7]
      }
      return(x)
    }
    
    land_df = lapply(land_df,filter_col)
    ocean_df = lapply(ocean_df,filter_col)
    
    land_df = do.call('rbind',land_df)
    ocean_df = do.call('rbind',ocean_df)
    
    df = rbind(land_df,ocean_df)
    #df$contr_rate = abs(df$contr_rate)
    
    df$contr_rate[which(df$contr_rate <0)] = 0
    
    df = cbind(df[,1:2],
               contr_rate = df$contr_rate*1000000) # 1 / 1000000
    
    r = raster(nrow = 360,ncol = 720) 
    coordinates(df) = ~ long+lat
    rdf = rasterize(df,r,'contr_rate')

    rdf1 = crop(rdf,extent(-180,180,0,90))
    
    return(rdf1)
    
    #df1_df = as.data.frame(rdf1,xy = T)
    #if(i >12){
    #  i = i -12
    #}
    
    
    #df1_df$type = time[i]
    #return(df1_df)
  }
  
  library(data.table)
  library(raster)
  library(reshape2)
  
  library(doParallel)
  cl = makeCluster(12)
  clusterExport(cl,c('i',"input_land",'input_ocean'))
  system.time(season_box <- parLapply(cl,i,sub_calc))
  stopCluster(cl)
  
  #season_box = lapply(i,sub_calc)
  season_box = do.call('stack',season_box)
  
  #season_box = season_box *-1
  cell_calc_fun<-function(x){
    xmean = mean(x,na.rm = T)
    return(xmean)
  }
  cell_sum_fun<-function(x){
    xsum = sum(x,na.rm = T)
    return(xsum)
  }
  
  
  # whole_mean
  mean_dump = calc(season_box,
                   cell_calc_fun)
                   #cell_sum_fun)
  
  mean_df = as.data.frame(mean_dump,xy = T)
  
  colnames(mean_df) = c('x','y','contr_rate') # 1/1000000
  
  #mean_df$cuts = cut(mean_df$contr_rate,
  #                   breaks = c(seq(0,100,10),seq(200,400,50)),right = F)
  
  mean_df$cuts = cut(mean_df$contr_rate,
                     breaks = c(seq(0,5,0.5),15,20,25,30),right = F)
  
  output = 'analysis_output/long_term_mean_contr_raster.csv'
  
  fwrite(mean_df,output)
  
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management("world")
  world = crop(world,extent(-180,180,0,90))
  
  xj = shp_management('xinjiang')
  library(RColorBrewer)
  mycolor = colorRampPalette(brewer.pal(11,'Blues'))(16)
  mycolor = mycolor[3:16]
  
  
  p = ggplot()+
    geom_tile(data = mean_df,aes(x = x,y = y,fill = cuts))+
    geom_polygon(data = world,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 1)+
    geom_polygon(data = xj,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 1)+
    scale_fill_manual(values = mycolor)+
    #facet_wrap(~type,nrow = 4)+
    coord_fixed(1.3)+
    #facet_wrap(~type,nrow = 3,scales = 'free')+
    theme_bw()
  
  return(output)
  
  
  
  
  
}
calc_long_term_no_considering_loss_contr <- function(
  
){
  input_data = list.files('/media/lenovo/jersey/Jersey/Projects/xinjiang_project/xinjiang_output_upload',
                          full.names = T)
  
  input_data = paste0(input_data,'/output')
  
  input_data = paste0(input_data,'/releas_by_source_noconsider_route_whole.csv')
  

  sou_names = as.data.frame(fread(input_data[1]))$sou_names
  
  i = 1:180
  import_contr_rate <- function(i){
    tmp = as.data.frame(fread(input_data[i]))
    tmp = tmp$contr_rate
    tmp = as.numeric(tmp)
    return(tmp)
  }
  
  ret_contr = do.call(cbind,lapply(i,import_contr_rate))
  mean_contr = apply(ret_contr,1,mean)
  
  contrdf = data.frame(sou_names,ret_contr)
  
  sortid = order(mean_contr,decreasing = T)
  
  retdf =data.frame(
    sou_names = sou_names[sortid],
    contr_rate = mean_contr[sortid]
  )
  
  fwrite(retdf,'/media/lenovo/jersey/Jersey/Projects/NC_mod_xinjiang/contr_noloss/long_term_noloss_contr.csv')
  

}
calc_pme_ato3_mod_verify<-function(
  
){
  source("/media/sdb5/Vapor_projcts/Vapor_tibet/R/calc_pme_in_io_mean.R")
  mode = 'ato'
  input = paste0('/home/share/R_project/xinjiang_vapor/cluster_shp',
                 '/',mode,'/')
  input_shps = input
  shp_mode = shp_management('ocean','ato')
  
  
  input_shps = list.files(input_shps,full.names = T,
                          pattern = '*.shp$')
  if(mode == 'ato'){
    input_shps = input_shps[1:4]
    input_shp_add = 'shp/adding_ato/adding_ato.shp'
    input_shps = c(input_shps,input_shp_add)
  }
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  
  global_pr = data_management('era5_pr_include_ocean')
  global_eva = data_management('global_era5_poten_evap')
  
  global_pr = raster::mask(global_pr,shp_mode)
  global_eva = raster::mask(global_eva,shp_mode)
 
  output_pme = 'NC_mod_xinjiang/era5_pme_sum'
  dir.create(output_pme)
  output_pme = paste0(output_pme,'/',mode)
  dir.create(output_pme)
  output_pme = paste0(output_pme,'/era5_pme_sum.csv')
  
  #######
  
  global_pr <<- global_pr
  global_eva <<- global_eva
  input_shps <<- input_shps
  shp_mode <<- shp_mode
  
  sub_mask_extract_sum_pr <-function(i){
    library(raster)
    tmpshp = shapefile(input_shps[i])
    
    tmppr = raster::mask(crop(global_pr,extent(shp_mode)),
                         shp_mode)
    
    tmppr = crop(tmppr,tmpshp)
    tmppr = as.list(tmppr)
    tmppr_sum = lapply(tmppr,cellStats,stat = sum,na.rm = T)
    tmppr_sum = do.call(c,tmppr_sum)
    
    return(tmppr_sum)
  }
  
  sub_mask_extract_sum_eva <-function(i){
    library(raster)
    tmpshp = shapefile(input_shps[i])
    
    tmppr = raster::mask(crop(global_eva,extent(shp_mode)),
                         shp_mode)
    
    tmppr = crop(tmppr,tmpshp)
    tmppr = as.list(tmppr)
    tmppr_sum = lapply(tmppr,cellStats,stat = sum,na.rm = T)
    tmppr_sum = do.call(c,tmppr_sum)
    
    return(tmppr_sum)
  }
  
  if(mode =='ato'){
    i= 1:4
  }else{
    i = 1:4
  }
  
  i <<-i
  library(doParallel)
  cl = makeCluster(max(i))
  clusterExport(cl,c('global_pr','input_shps','shp_mode'))
  ret_pr = parLapply(cl,i,sub_mask_extract_sum_pr)
  stopCluster(cl)
  
  ret_pr = do.call('cbind',ret_pr)
  len = ncol(ret_pr)
  colnames(ret_pr) = paste0(mode,1:len)
  
  library(doParallel)
  cl = makeCluster(max(i))
  clusterExport(cl,c('global_pr','input_shps','shp_mode'))
  ret_eva = parLapply(cl,i,sub_mask_extract_sum_eva)
  stopCluster(cl)
  
  ret_eva = do.call('cbind',ret_eva)
  len = ncol(ret_eva)
  colnames(ret_eva) = paste0(mode,1:len)
  
  ret_pme = ret_pr - ret_eva
  
  library(data.table)
  fwrite(ret_pme,output_pme)
  
}
calc_pme_ato3_raster <- function(
  
){
  source("/media/sdb5/Vapor_projcts/Vapor_tibet/R/calc_pme_in_io_mean.R")
  mode = 'ato'
  input = paste0('/home/share/R_project/xinjiang_vapor/cluster_shp',
                 '/',mode,'/')
  input_shps = input
  shp_mode = shp_management('ocean','ato')
  
  
  input_shps = list.files(input_shps,full.names = T,
                          pattern = '*.shp$')
  if(mode == 'ato'){
    input_shps = input_shps[1:4]
    input_shp_add = 'shp/adding_ato/adding_ato.shp'
    input_shps = c(input_shps,input_shp_add)
  }
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  
  global_pr = data_management('era5_pr_include_ocean')
  global_eva = data_management('global_era5_poten_evap')
  
  global_pr = crop(global_pr,shp_mode)
  global_eva = crop(global_eva,shp_mode)
  
  global_pr = raster::mask(global_pr,shp_mode)
  global_eva = raster::mask(global_eva,shp_mode)
  
  nato_pme = global_pr - global_eva
  #nato_pme = crop(nato_pme,extent(shp_mode))
  dir.create('NC_mod_xinjiang/era5_pme_ato_raster')
  output_pme = 'NC_mod_xinjiang/era5_pme_ato_raster/pme_whole.nc'
  writeRaster(nato_pme,output_pme,overwrite = T)
  
  
}
calc_pme_sst_in_ato13 <- function(
  
){
  # generate subs
  library(raster)
  input_cluster = paste0('cluster_shp/ato/ato',c(1,3),'.shp')
  ato13 = lapply(input_cluster,shapefile)
  ato1 = ato13[[1]]
  ato3 = ato13[[2]]
  
  ce1 = extent(ato1)
  ce11 = extent(ce1[1],ce1[2],ce1[3],20)
  ce12 = extent(ce1[1],ce1[2],20,ce1[4])
  ce3 = extent(ato1)
  ce31 = extent(ce3[1],ce3[2],ce3[3],20)
  ce32 = extent(ce3[1],ce3[2],20,ce3[4])
  
  ato11 = crop(ato1,ce1)
  ato12 = crop(ato1,ce1)
  
  # import raster
}
calc_pme_var_fun<-function(
  pmedf
){
  pmedf1 = pmedf
  colnames(pmedf1) = c('date','variable','value')
  pmedf245 = pmedf1[
    which(pmedf1$variable %in% c('SSP245_PME1',
                                 'SSP245_PME3')),]
  pmedf585 = pmedf1[
    which(pmedf1$variable %in% c('SSP585_PME1',
                                 'SSP585_PME3')),
  ]
  pmedf245$type = '(a) Regional mean standard indices under SSP245'
  pmedf585$type = '(b) Regional mean standard indices under SSP585'
  
  library(prophet)
  source('/home/share/R_project/xinjiang_vapor/cal_increasing_rate_whole.R')
  ir_tws245 = cal_increasing_rate_whole(mean_tws245,
                                        'TWS_245')
  ir_tws585 = cal_increasing_rate_whole(mean_tws585,
                                        'TWS_585')
  ir_pme245 = cal_increasing_rate_whole(
    pmedf245,
    'SSP245_PME'
  )
  ir_pme585 = cal_increasing_rate_whole(pmedf585,
                                        'SSP585_PME')
  return(list(ir_pme245,
              ir_pme585))
}
calc_tws_across_the_mid_lat_eurasia <- function(
  
){
  #hsr = shapefile('analysis_output/fig2/combine_sub_window.shp')
  source("/home/share/R_project/xinjiang_vapor/data_management.R")
  source("/home/share/R_project/xinjiang_vapor/shp_management.R")
  world = shp_management('world')
  world = crop(world,extent(-20,180,0,90))
  tws = data_management('grace')
  
  tws = mask(crop(tws,world),world)
  
  twsdf = as.data.frame(tws,xy = T)
  naid = which(is.na(twsdf[,3]))
  twsdf = twsdf[-naid,]
  loc_tws = twsdf[,1:2]
  twsdf = twsdf[,-c(1,2)]
  
  twsdf = t(twsdf)
  
  stand_trend_fun_tws <-function(i){
    x = twsdf[,i]
    x = ts(x,start = c(2003,1),frequency = 12)
    x = decompose(x)$trend
    x = x[-which(is.na(x))]
    
    x = x/(max(x)-min(x))
    return(x)
  }
  
  i = 1:ncol(twsdf)
  twsdf <<- twsdf
  i <<- i
  library(doParallel)
  cl = makeCluster(10)
  clusterExport(cl,c('i','twsdf'))
  system.time(tws_st <<- parLapply(cl,i,stand_trend_fun_tws))
  stopCluster(tws_st)  
  
  tws_st = do.call('cbind',tws_st)
  
  output_tws_st = 'NC_mod_xinjiang/svd_mca_analysis/tws_whole_st.csv'
  output_loc_tws = 'NC_mod_xinjiang/svd_mca_analysis/loc_whole_tws.csv'
  
  fwrite(loc_tws,output_loc_tws)
  fwrite(tws_st,output_tws_st)
    
  
  
}
calc_tws_by_area_china <- function(
  
){
  tws = data_management('grace')
  world = shp_management('world')
  china = shp_management('china')
  xj = china[china$NAME %in% '新疆',]
  ncp = china[china$NAME %in%
                c('北京','天津','河北','河南','山东'),]
  
  tws = mask(tws,world)
  
  sub_calc_xj <- function(){
    library(raster)
    
    tmp = raster::mask(crop(tws,xj),xj)
    tmpli = as.list(tmp)
    
    tmpdf = lapply(tmpli,cellStats,stat = 'sum',
                   na.rm = T)
    tmpdf = do.call(c,tmpdf)
    
    return(tmpdf)
  }
  sub_calc_ncp <- function(){
    library(raster)
    
    tmp = raster::mask(crop(tws,ncp),ncp)
    tmpli = as.list(tmp)
    
    tmpdf = lapply(tmpli,cellStats,stat = 'sum',
                   na.rm = T)
    tmpdf = do.call(c,tmpdf)
    
    return(tmpdf)
  }
  
  
  ret_xj = sub_calc_xj()
  ret_ncp = sub_calc_ncp()
  
  retdf = cbind(ret_xj,ret_ncp)
  
  colnames(retdf) = c('XJ','NCP')
  
  output = 'NC_mod_xinjiang/tws_by_china'
  dir.create(output)
  output1 = paste0(output,'/tws_full.csv')
  fwrite(retdf,output1)
  
  
  calc_year <- function(x){
    x = x[-c(169:174)]
    x = matrix(x,nrow = 12)
    x = apply(x,2,sum,na.rm = T)
    x = x/(max(x)-min(x))
    return(x)
  }
  
  ret_year = apply(retdf,2,calc_year)
  output2 = paste0(output,'/tws_year.csv')
  fwrite(ret_year,output2)
  
}
calc_tws_by_country <- function(
  
){
  tws = data_management('grace')
  world = shp_management('world')
  
  tws = mask(tws,world)
  
  freshwater = as.data.frame(fread('cfreshwater/freshwater_filter.csv'))
  countrys = freshwater$country
  inputs = paste0('NC_mod_xinjiang/freshwater/country_shp2/',countrys,'.shp')
  
  sub_calc <- function(i){
    library(raster)
    tmpshp = shapefile(inputs[i])
    tmp = raster::mask(crop(tws,tmpshp),tmpshp)
    tmpli = as.list(tmp)
    
    tmpdf = lapply(tmpli,cellStats,stat = 'sum',
                   na.rm = T)
    tmpdf = do.call(c,tmpdf)
    
    return(tmpdf)
  }
  
  inputs <<- inputs
  tws <- tws
  library(doParallel)
  i = 1:length(countrys)
  i <<- i
  cl = makeCluster(10)
  clusterExport(cl,c('i','inputs','tws'))
  ret = parLapply(cl,i,sub_calc)
  stopCluster(cl)
  
  retdf = do.call(cbind,ret)
  
  colnames(retdf) = countrys
  
  output = 'NC_mod_xinjiang/tws_by_country'
  dir.create(output)
  output1 = paste0(output,'/tws_full.csv')
  fwrite(retdf,output1)
  
  
  calc_year <- function(x){
    x = x[-c(169:174)]
    x = matrix(x,nrow = 12)
    x = apply(x,2,sum,na.rm = T)
    x = x/(max(x)-min(x))
    return(x)
  }
  
  ret_year = apply(retdf,2,calc_year)
  output2 = paste0(output,'/tws_year.csv')
  fwrite(ret_year,output2)
  
}
check_output_number<-function(
  
){
  fp = 'xinjiang[0-9]*'
  file = list.files('/media/sdb1/xinjiang_output_file',pattern = fp,full.names = T)
  
  output = paste0(file,'/output')
  output_box = 1
  for(i in 1:length(file)){
    tmp = list.files(output[i])
    print(length(tmp))
    if(length(tmp)==11){
      output_box  = c(output_box,output[i])
    }
  }
  output_box = output_box[-1]
  #print(length(output_box))
  return(output_box)
}

cluster_basedon_allpart <- function(
  mode = 'ato'
){
  library(raster)
  library(maps)
  library(maptools)
  library(ggplot2)
  library(reshape2)
  library(RColorBrewer)
  library(data.table)
  library(foreach)
  library(doParallel)
  library(parallel)
  library(snow)
  library(doParallel)
  library(snow)
  library(foreach)
  library(parallel)
  library(factoextra)
  library(vegan)
  library(dplyr)
  library(plyr)
  
  files = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
  if(mode == 'ato'){
    files = paste0(files,'/output/contr_released_ocean/')
    #shp = shp_management('ocean',mode)
  }else{
    files = paste0(files,'/output/contr_released_land/')
    #shp = shp_management('land',mode)
  }

  
  
  files = paste0(files,mode,'.csv')
  
  df = lapply(files,fread)
  
  df = do.call('rbind',df)
  
  loc = df[,1:2]
  
  #system.time(ca_clust <- cascadeKM(loc,1,10,iter = 1))
  #cal_best = as.numeric(which.max(ca_clust$results[2,]))
  if(mode != 'eu'){
    minlong = round(min(loc[,1]))-1
    maxlong = round(max(loc[,1]))+1
    midlong = round((maxlong - minlong)/2+minlong)
    
    minlat = round(min(loc[,2]))-1
    maxlat = round(max(loc[,2]))+1
    if(minlat <0){
      minlat = 0
    }
    midlat = round((maxlat - minlat)/2+minlat)
  }else{
    idless100 = which(loc[,1]<(-100))
    locless = loc[idless100,]
    loceu = loc[-idless100,]
    
    minlong = round(min(loceu[,1]))-1
    maxlong = round(max(loceu[,1]))+1
    thlong1 = round((maxlong - minlong)/3+minlong)
    thlong2 = round((maxlong - minlong)*2/3+minlong)
    
    minlat = round(min(loceu[,2]))-1
    maxlat = round(max(loceu[,2]))+1
    if(minlat <0){
      minlat = 0
    }
    
    minlong1 = -180
    maxlong1 = round(max(locless[,1]))+1
    minlat1 = round(min(locless[,2]))-1
    maxlat1 = round(max(locless[,2]))+1
  
  }
  
  library(rgeos)
  library(rgdal)
  library(raster)
  
  # border reset based on points
  reset_border <- function(loc,sx){
    id_loc1 = which(loc[,1]>=sx[1] &
                      loc[,1]<=sx[2]&
                      loc[,2]>=sx[3]&
                      loc[,2]<=sx[4])
    locx = loc[id_loc1,]
    
    minlong = min(locx[,1])
    maxlong = max(locx[,1])
    minlat = min(locx[,2])
    maxlat = max(locx[,2])
    
    sx = extent(minlong,maxlong,
                minlat,maxlat)
    return(sx)
  }
  
  if(mode != "eu"){
    s1 = extent(minlong,midlong,
                minlat,midlat)
    s2 = extent(minlong,midlong,
                midlat,maxlat)
    s3 = extent(midlong,maxlong,
                minlat,midlat)
    s4 = extent(midlong,maxlong,
                midlat,maxlat)
    
    s1 = reset_border(loc,s1)
    s2 = reset_border(loc,s2)
    s3 = reset_border(loc,s3)
    s4 = reset_border(loc,s4)
    
    
    pol1 = as(s1,'SpatialPolygons')
    pol2 = as(s2,'SpatialPolygons')
    pol3 = as(s3,'SpatialPolygons')
    pol4 = as(s4,'SpatialPolygons')
    
    crs(pol1) = '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'
    crs(pol2) = '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'
    crs(pol3) = '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'
    crs(pol4) = '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'
    
    output_shp = 'cluster_shp/'
    output_shp = paste0(output_shp,mode)
    dir.create(output_shp)
    
    outputname = paste0(mode,1:4,'.shp')
    output_shp = paste0(output_shp,'/',outputname)
    
    poly_list = list(pol1,pol2,pol3,pol4)
    for(i in 1:4){
      shapefile(poly_list[[i]],output_shp[i],overwrite = T)
    }
    
    # lable id
    poly_list <<- poly_list
  }else{
    s1 = extent(minlong,thlong1,
                minlat,maxlat)
    s2 = extent(thlong1,thlong2,
                minlat,maxlat)
    s3 = extent(thlong2,maxlong,
                minlat,maxlat)
    s4 = extent(minlong1,maxlong1,
                minlat1,maxlat1)
    
    
    #refit based on points 
    s1 = reset_border(loc,s1)
    s2 = reset_border(loc,s2)
    s3 = reset_border(loc,s3)
    s4 = reset_border(loc,s4)
    
    
    pol1 = as(s1,'SpatialPolygons')
    pol2 = as(s2,'SpatialPolygons')
    pol3 = as(s3,'SpatialPolygons')
    pol4 = as(s4,'SpatialPolygons')
    
    crs(pol1) = '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'
    crs(pol2) = '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'
    crs(pol3) = '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'
    crs(pol4) = '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'
    
    output_shp = 'cluster_shp/'
    output_shp = paste0(output_shp,mode)
    dir.create(output_shp)
    
    outputname = paste0(mode,1:4,'.shp')
    output_shp = paste0(output_shp,'/',outputname)
    
    poly_list = list(pol1,pol2,pol3,pol4)
    for(i in 1:4){
      shapefile(poly_list[[i]],output_shp[i],overwrite = T)
    }
    
    # lable id
    poly_list <<- poly_list
  }
  
  
  label_id <- function(x){
    library(data.table)
    library(raster)
    
    tmpdf = fread(x)
    tmploc = tmpdf[,1:2]
    tmpdf$region_label = NA
    
    regionlabel = 1:4
    for(i in 1:4){
      poly = poly_list[[i]]
      minlong = extent(poly)[1]
      maxlong = extent(poly)[2]
      minlat = extent(poly)[3]
      maxlat = extent(poly)[4]
      
      tmpid = which(tmploc[,1]<=maxlong & tmploc[,1]>=minlong &  tmploc[,2]<=maxlat &
         tmploc[,2]>=minlat)
      
      tmpdf$region_label[tmpid] = regionlabel[i]
    }
    
    fwrite(tmpdf,x)

  }
  
  
  cl = makeCluster(10)
  clusterExport(cl,c('poly_list',"files"))
  system.time(parLapply(cl,files,label_id))
  stopCluster(cl)
  
}

cluster_in_source <- function(
  input_data
){
  library(raster)
  library(maps)
  library(maptools)
  library(ggplot2)
  library(reshape2)
  library(RColorBrewer)
  library(data.table)
  library(foreach)
  library(doParallel)
  library(parallel)
  library(snow)
  cluster_sub<-function(
    input_sub
  ){
    library(doParallel)
    library(snow)
    library(foreach)
    library(parallel)
    library(factoextra)
    library(vegan)
    
    df = fread(paste0(input_sub,'/masked_var_whole_route_mid.csv'))
    df_full_for_cl <<- data.frame(df)
    
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    
    input_path = paste0(input_sub,'/contr_ocean')
    input_ocean = paste0(input_path,'/',oce_names,'.csv')
    output_ocean = paste0(input_sub,'/mean_cluster_route_ocean')
    dir.create(output_ocean)
    output_ocean = paste0(output_ocean,'/',oce_names,'.csv')
    
    
    
    for(i in 1:length(input_ocean)){
      tmp_df = fread(input_ocean[i])
      
      cl_m= tmp_df[,1:2]
      
      #ca_clust = cascadeKM(cl_m,1,10,iter = 100)
      #cal_best = as.numeric(which.max(ca_clust$results[2,]))
      
      cluster_mod = kmeans(cl_m,10)
      cluster = cluster_mod$cluster
      
      tmp_df$cluster = cluster
      clm = 1:10
      
      cl_li = list()
      for(j in 1:length(unique(cluster))){
        idt = which(tmp_df$cluster == clm[j])
        tmpdfs = as.data.frame(tmp_df[idt,])
        cl_li = c(cl_li,list(tmpdfs))
      }
      source('/home/share/R_project/xinjiang_vapor/mean_route_by_cl.R')
      ret_li <- lapply(cl_li,mean_route_by_cl)
      
      ret_li = do.call('rbind',ret_li)
      #print(ret_li)
      fwrite(ret_li,output_ocean[i])
      print(i)
    }
    
    # land 
    con_names = c('as','xj','eu','naf','na')
    input_path = paste0(input_sub,'/contr_land')
    input_land = paste0(input_path,'/',con_names,'.csv')
    output_land = paste0(input_sub,'/mean_cluster_route_land')
    dir.create(output_land)
    output_land = paste0(output_land,'/',con_names,'.csv')
    
    for(i in 1:length(input_land)){
      tmp_df = fread(input_land[i])
      
      cl_m= tmp_df[,1:2]
      
      #ca_clust = cascadeKM(cl_m,1,10,iter = 100)
      #cal_best = as.numeric(which.max(ca_clust$results[2,]))
      
      cluster_mod = kmeans(cl_m,10)
      cluster = cluster_mod$cluster
      
      tmp_df$cluster = cluster
      clm = 1:10
      
      cl_li = list()
      for(j in 1:length(unique(cluster))){
        idt = which(tmp_df$cluster == clm[j])
        tmpdfs = as.data.frame(tmp_df[idt,])
        cl_li = c(cl_li,list(tmpdfs))
      }
      source('/home/share/R_project/xinjiang_vapor/mean_route_by_cl.R')
      ret_li <- lapply(cl_li,mean_route_by_cl)
      
      ret_li = do.call('rbind',ret_li)
      fwrite(ret_li,output_land[i])
      print(i)
    }
    
    
  }
  sapply(input_data,cluster_sub)
}
cluster_sub<-function(
  input_contr,names
){
  # source file
  contr_df = fread(input_contr)
  contr_df = as.data.frame(contr_df)
  
  sum_contr_full = abs(sum(contr_df$contr_rate,na.rm = T))
  library(dplyr)
  #print(names)
  if(nrow(contr_df)>0){
    loc = contr_df[,1:2]
    colnames(loc) = c('long','lat')
    
    
    if(nrow(loc)<50){
      cluster = 1
      contr_df$cluster = cluster
      
      cal_mean_route <- function(x){
        library(dplyr)
        sum_rates = sum(x$contr_rate,na.rm = T)
        
        ids = which(df_full$type %in% x$type)
        df_sce = df_full[ids,]
        df_sce1 = df_sce %>%
          group_by(type) %>%
          mutate(date_id = row_number())
        
        df_sce$date_id = df_sce1$date_id
        rm(df_sce1)
        
        
        mean_fun<-function(x){
          library(cluster)
          x = as.character(x)
          trans_fun<-function(x){
            x = cbind(as.numeric(strsplit(x,'_')[[1]][1]),
                      as.numeric(strsplit(x,'_')[[1]][2]))
            return(x)
          }
          x = do.call('rbind',lapply(x,trans_fun))
          x = data.frame(long = x[,1],lat = x[,2])
          xm = kmeans(x,1)$center
          return(xm)
        }
        
        mean_fun2 <-function(x){
          xm = mean(x,na.rm = T)
          return(xm)
        }
        
        df_sce$longlat = paste0(df_sce$long,'_',df_sce$lat)
        
        #mean_route_loc = aggregate(df_sce$longlat,list(df_sce$date_id),mean_fun)
        #mean_route_loc = mean_route_loc$x
        mean_route_long = aggregate(df_sce$long,list(df_sce$date_id),mean_fun2)[,2]
        mean_route_lat = aggregate(df_sce$lat,list(df_sce$date_id),mean_fun2)[,2]
        mean_route_loc = cbind(mean_route_long,mean_route_lat)
        mean_route_height = aggregate(df_sce$height,list(df_sce$date_id),mean_fun2)[,2]
        
        
        sum_rates = c(sum_rates,rep(NA,length(mean_route_height)-1))
        
        mean_route_df = data.frame(
          long = mean_route_loc[,1],
          lat = mean_route_loc[,2],
          height = mean_route_height,
          contr_rates = sum_rates,
          cluster = x$cluster[1]
        )
        
        return(mean_route_df)
      }
      
      mean_route_li = cal_mean_route(contr_df)
      mean_route_li$source_name = names
      
    }else{
      loc = contr_df[,1:2]
      idname = which(sou_names == names)
      
      best_cl = best_cluster_mat[idname,mon]
      
      print(paste0(names,'_',best_cl))
      mean_best_cl = round(mean(best_cluster_mat[idname,],na.rm = T))
      
      if(is.na(best_cl)){
        best_cl = mean_best_cl
      }
      
      cluster = kmeans(loc,best_cl)
      cluster = cluster$cluster
      
      contr_df$cluster = cluster
      
      # calculation contr_rates for each cluster
      clm = 1:best_cl
      cl_li = list()
      #sum_contr_rates =1
      for(j in 1:length(unique(cluster))){
        idt = which(contr_df$cluster == clm[j])
        tmpdfs = as.data.frame(contr_df[idt,])
        cl_li = c(cl_li,list(tmpdfs))
      }
      
      cl_li <<- cl_li
      
      
      # adding time line label
      
      cal_mean_route <- function(x){
        library(dplyr)
        sum_rates = sum(x$contr_rate,na.rm = T)
        
        ids = which(df_full$type %in% x$type)
        df_sce = df_full[ids,]
        df_sce1 = df_sce %>%
          group_by(type) %>%
          mutate(date_id = row_number())
        
        df_sce$date_id = df_sce1$date_id
        rm(df_sce1)
        
        
        mean_fun<-function(x){
          library(cluster)
          x = as.character(x)
          trans_fun<-function(x){
            x = cbind(as.numeric(strsplit(x,'_')[[1]][1]),
                      as.numeric(strsplit(x,'_')[[1]][2]))
            return(x)
          }
          x = do.call('rbind',lapply(x,trans_fun))
          x = data.frame(long = x[,1],lat = x[,2])
          xm = kmeans(x,1)$center
          return(xm)
        }
        
        mean_fun2 <-function(x){
          xm = mean(x,na.rm = T)
          return(xm)
        }
        
        df_sce$longlat = paste0(df_sce$long,'_',df_sce$lat)
        
        #mean_route_loc = aggregate(df_sce$longlat,list(df_sce$date_id),mean_fun)
        #mean_route_loc = mean_route_loc$x
        mean_route_long = aggregate(df_sce$long,list(df_sce$date_id),mean_fun2)[,2]
        mean_route_lat = aggregate(df_sce$lat,list(df_sce$date_id),mean_fun2)[,2]
        mean_route_loc = cbind(mean_route_long,mean_route_lat)
        mean_route_height = aggregate(df_sce$height,list(df_sce$date_id),mean_fun2)[,2]
        
        
        sum_rates = c(sum_rates,rep(NA,length(mean_route_height)-1))
        
        mean_route_df = data.frame(
          long = mean_route_loc[,1],
          lat = mean_route_loc[,2],
          height = mean_route_height,
          contr_rates = sum_rates,
          cluster = x$cluster[1]
        )
        
        return(mean_route_df)
      }
      
      library(doParallel)
      #cl = makeCluster(15)
      #clusterExport(cl,c("cl_li","df_full"))
      #system.time(mean_route_li <- parLapply(cl,cl_li,cal_mean_route))
      #stopCluster(cl)
      mean_route_li = lapply(cl_li,cal_mean_route)
      mean_route_li = do.call('rbind',mean_route_li)
      
      mean_route_li$source_name = names
    }
    
  }else{
    mean_route_li = NA
  }
  
  return(mean_route_li)
  
  
  
}
cluster_traj_routes<-function(
  input_data
){
  library(dplyr)
  library(data.table)
  sub_cluster<-function(
    input_sub
  ){
    # based on contr_released file 
    print(input_sub)
    source('/home/share/R_project/xinjiang_vapor/cluster_sub.R')
    df = fread(paste0(input_sub,'/masked_var_whole_route_mid.csv'))
    df = as.data.frame(df)
    df_full <<- df
    
    # just calculation routes with contribution rates > 0.01
    con_names = c('as','xj','eu','naf','na')
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    sou_names = c(oce_names,con_names)
    sou_names <<- sou_names
    
    input_land = paste0(input_sub,'/contr_released_land')
    input_land = paste0(input_land,'/',con_names,'.csv')
    
    mon = as.numeric(substr(input_sub,46,47))
    mon <<- mon
    
    best_cluster_mat =fread('analysis_output/best_cluster_each_monh.csv')
    best_cluster_mat = as.matrix(best_cluster_mat)
    best_cluster_mat <<- best_cluster_mat
    
    cluster_fun_each_land<- function(i){
      source('/home/share/R_project/xinjiang_vapor/cluster_sub.R')
      library(data.table)
      if(file.exists(input_land[i])){
        contr_df <- cluster_sub(input_land[i],con_names[i])
        return(contr_df)  
      }
      
    }
    
    input_land <<- input_land
    con_names <<- con_names
    i = 1:length(con_names)
    #i <<- i
    #cl = makeCluster(5)
    #clusterExport(cl,c('i','df_full','input_land','con_names'))
    #system.time(contr_df_land <- parLapply(cl,i,cluster_fun_each_land))
    #stopCluster(cl)
    contr_df_land = lapply(i,cluster_fun_each_land)
    contr_df_land = do.call('rbind',contr_df_land)
    naid = which(is.na(contr_df_land[,1]))
    if(length(naid)!=0){
      contr_df_land = contr_df_land[-naid,]  
    }
    contr_df_land = contr_df_land[-naid,]
    print('pass here 1')
    
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    input_oce = paste0(input_sub,'/contr_released_ocean')
    input_oce = paste0(input_oce,'/',oce_names,'.csv')
    
    
    cluster_fun_each_oce<-function(i){
      source('/home/share/R_project/xinjiang_vapor/cluster_sub.R')
      library(data.table)
      if(file.exists(input_oce[i])){
        contr_df <- cluster_sub(input_oce[i],oce_names[i])
        return(contr_df)  
      }
      
    }
    
    i = 1:length(oce_names)
    #i <<- i
    #input_oce <<- input_oce
    #oce_names <<- oce_names
    
    #cl = makeCluster(4)
    #clusterExport(cl,c('i','df_full','input_oce','oce_names'))
    #system.time(contr_df_oce <- parLapply(cl,i,cluster_fun_each_oce))
    #stopCluster(cl)
    
    contr_df_oce = lapply(i, cluster_fun_each_oce)
    contr_df_oce = do.call('rbind',contr_df_oce)
    naid = which(is.na(contr_df_oce[,1]))
    if(length(naid)!=0){
      contr_df_oce = contr_df_oce[-naid,]  
    }
    
    
    contr_df = rbind(contr_df_oce,contr_df_land)
    print('pass here 2')
    output = paste0(input_sub,'/mean_route_released')
    dir.create(output)
    output = paste0(output,'/mean_route_released.csv')
    
    fwrite(contr_df,output)
    
  } 
  sapply(input_data,sub_cluster)
  
  
}
cluster_whole_time_traj<-function(
  
){
  input_files = list.files('/media/sdb1/xinjiang_output_file',
                           full.names = T)
  input = paste0(input_files,'/output/cluster_traj_loc.csv')
  
  df = lapply(input,fread)
  
  df = lapply(df,as.data.frame)
  
  df = do.call('rbind',df)
  
  set.seed(4321)
  cl = kmeans(df,20)
  
  cluster = cl$centers
  colnames(cluster) = c(paste0('long',1:38),
                        paste0('lat',1:38))
  
  long = cluster[,1:38]
  lat = cluster[,39:76]
  
  
  loc1 = data.frame(long = long[,1],
                    lat = lat[,1])
  loc1 <<- loc1
  con_names = c('as','eu','naf','na')
  oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
  sou_names = toupper(c(con_names,oce_names))
  
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  con_shp = lapply(con_names,shp_management,pattern = 'land')
  oce_shp = lapply(oce_names,shp_management,pattern = 'ocean')
  
  shp_li = c(con_shp,oce_shp)
  shp_li <<- shp_li
  
  
  determine_source<- function(i){
    dfsce = loc1
    coordinates(dfsce) = ~ long+lat
    proj4string(dfsce) = "+proj=longlat +datum=WGS84 +no_defs"
    
    df_m = over(dfsce,shp_li[[i]])
    df_land_index = which(!is.na(df_m[,1]))
    return(df_land_index)
  }
  
  i = 1:length(shp_li)
  
  ret_id = lapply(i,determine_source)
  
  routeid = 1:20
  
  longdf = data.frame(routeid,long)
  latdf = data.frame(routeid,lat)
  
  longdf$region = 'as'
  latdf$region = 'as'
  
  for(i in i){
    rowid = ret_id[[i]]
    longdf$region[rowid] = sou_names[i]
    latdf$region[rowid]= sou_names[i]
  }
  
  longdf$size = 1
  latdf$size = 1
  
  # import contr 
  input_contr_by_sou = 'analysis_output/contr_in_source_variance_new.csv'
  contr_by_sou = as.data.frame(fread(input_contr_by_sou))
  
  sou_names1 = toupper(contr_by_sou[,1])
  contr_by_sou = contr_by_sou[,-1]
  
  contr_by_sou_mean = apply(contr_by_sou,1,mean,na.rm= T)
  contr_by_sou_mean = as.numeric(contr_by_sou_mean)
  
  region_uni = as.character(unique(longdf$region))
  
  for(i in 1:length(region_uni)){
    tmp = region_uni[i]
    iddf = which(longdf$region == tmp)
    id2 = which(sou_names1 == tmp)
    contr = contr_by_sou_mean[id2]
    longdf$size[iddf] = contr
    latdf$size[iddf] = contr
  }
  
  
  longdf = reshape2::melt(longdf,c('routeid','region','size'))
  latdf = reshape2::melt(latdf,c('routeid','region','size'))
  
  retdf = data.frame(routeid = longdf$routeid,
                     region = longdf$region,
                     size = longdf$size,
                     variable = longdf$variable,
                     long = longdf$value,
                     lat = latdf$value)
  
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management("world")
  world = crop(world,extent(-180,180,0,90))
  
  xj = shp_management('xinjiang')
  
  library(RColorBrewer)
  mycolor = colorRampPalette(brewer.pal(11,'Spectral'))(6)
  
  
  library(ggplot2)
  # Trajectory Plot
  sizemanual = c('AS'= 2,
                 'EU'=1.5,
                 'ATO'=1,
                 "CS" = 0.5,
                 "MS" = 0.5,
                 'NA' = 0.25)
  #####
  p = ggplot()+
    geom_polygon(data = world,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 1)+
    geom_polygon(data = xj,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 1)+
    geom_path(data = retdf,aes(x = long,y = lat,
                                        group = routeid,
                                        color = region,
                                        size = region),
              arrow=arrow(angle=30,length=unit(0.1,"inches"),type="closed"))+
    scale_color_manual(values = mycolor)+
    scale_size_manual(values = sizemanual)+
    guides(color = guide_legend(title = 'Route'),
           size = guide_legend(title = 'Route'))+
    #facet_wrap(~routeid,nrow = 4)+
    theme_bw()
  #####
  p
  
  return(retdf)
  
  
}
cmip5_precip<-function(
  
){
  input = '/media/root/ERAin/2019-02-27-Computer_D_backup/CMIP5_downscale/'
  #model = list.files(input,full.names = T)
  model_name = list.files('/media/root/ERAin/Radom_window_code_building/Data/bcsnrd')
  model_name = tolower(model_name)
  
  model = paste0(input,model_name)
  
  model45 = paste0(model,'/rcp45/mon/r1i1p1/pr/')
  model85 = paste0(model,'/rcp85/mon/r1i1p1/pr/')
  xj = shp_management(pattern = 'xinjiang')
  
  ret_box45= 1
  ret_box85 = 1
  for(i in 1:length(model45)){
    files45 = list.files(model45[i],full.names = T)
    files85 = list.files(model85[i],full.names = T)
    
    files45_n = list.files(model45[i])
    files85_n = list.files(model85[i])
    
    startyear = as.numeric(substr(strsplit(files45_n,'_')[[1]][8],1,4))
    if(startyear == 2006){
      loc_202001 = length(2006:2020)*12-11
      loc_205012 = length(2006:2050)*12
    }else{
      loc_202001 = length(2006:2020)*12-11+1
      loc_205012 = length(2006:2050)*12+1
    }
    
    nc45 = stack(files45)
    nc85 = stack(files85)
    
    nc45 = nc45[[loc_202001:loc_205012]]
    nc85 = nc85[[loc_202001:loc_205012]]
    
    nc45 = crop(nc45,xj)
    nc45 = mask(nc45,xj)
    
    nc85 = crop(nc85,xj)
    nc85 = mask(nc85,xj)
    
    mean_cal<-function(x){
      xmean = cellStats(x,'mean')
      return(xmean)
    }
    tmp45 = lapply(as.list(nc45),mean_cal)
    tmp85 = lapply(as.list(nc85),mean_cal)
    
    nc45mean = do.call('c',tmp45)
    nc85mean = do.call('c',tmp85)
    
    ret_box45 = cbind(ret_box45,nc45mean)
    ret_box85 = cbind(ret_box85,nc85mean)
    
  }
  ret_box45 = ret_box45[,-1]
  ret_box85 = ret_box85[,-1]
  
  colnames(ret_box45) = model_name
  colnames(ret_box85) = model_name
  
  fwrite(ret_box45,'analysis_output/cmip45_pr.csv')
  fwrite(ret_box85,'analysis_output/cmip85_pr.csv')
  
}
cmip6_data_prepocess_procedure <-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/cmip6_preprocess_his.R')
  source('/home/share/R_project/xinjiang_vapor/cmip6_preprocess.R')
  mode = 'SST'
  cmip6_preprocess(mode)
  cmip6_preprocess_his(mode)
}
cmip6_extent_check <- function(
  
){
  
  library(raster)
  library(ncdf4)
  input = list.files('/media/root/Shen_drive1/CMIP6/',full.names = T)
  for(i in 1:2){
    files = list.files(input[i],full.names = T)
    files = paste0(files,'/historical')
    
    if(i ==1){
      for(j in 1:length(files)){
        f1 = list.files(files[i],full.names = T)[1]
        f1= stack(f1)
        print(extent(f1))
      }  
    }else if(i==2){
      for(j in 1:length(files)){
        f1 = list.files(files[i],full.names = T)[1]
        f1= stack(f1)
        print(extent(f1))
      }  
    }
    
  }
  
}
cmip6_preprocess_his <- function(
  mode = 'E'
){
  
  input_path = '/media/root/Shen_drive1/CMIP6/'
  input_path = paste0(input_path,'/',mode)
  
  model = list.files(input_path)
  files = list.files(input_path,full.names = T)
  
  files_ssp245 = paste0(files,'/historical')
  
  output_path = paste0('/media/root/Shen_drive1/CMIP6_reorder/',
                       mode)
  dir.create(output_path)
  
  output_path245 = paste0(output_path,'/historical')
 
  dir.create(output_path245)
  
  
  
  
  
  for(i in 2:length(files_ssp245)){
    if(model[i] != 'FGOALS-g3'){
      print(i)
      files_in_name2 = list.files(files_ssp245[i])
      files_in_full2 = list.files(files_ssp245[i],full.names = T)
      
      print(model[i])
      
      if(length(files_in_name2)==1){
        str_date = strsplit(files_in_name2,'_')[[1]][7]
        str_date = strsplit(str_date,'-')
        start_date = str_date[[1]][1]
        end_date = str_date[[1]][2]
        
        date = paste0(start_date,'_',end_date)
      }else{
        str_date = strsplit(files_in_name2[1],'_')[[1]][7]
        str_date = strsplit(str_date,'-')
        start_date = str_date[[1]][1]
        
        str_date = strsplit(files_in_name2[length(files_in_name2)],'_')[[1]][7]
        str_date = strsplit(str_date,'-')
        
        end_date = str_date[[1]][2]
        
        date = paste0(start_date,'_',end_date)
      }
      print(date)
      
      output_name = paste0('his','_',model[i],'_',date)
      output2 = paste0(output_path245,'/',output_name)
      library(raster)
      library(ncdf4)
      dat = try(stack(files_in_full2,varname = 'tos'),
                silent = T)
      if('try-error' %in% class(dat)){
        source('/home/share/R_project/xinjiang_vapor/nc_to_df.R')
        if(length(files_in_full2) == 1){
          dat = nc_open(files_in_full2)
          dat = nc_to_df(dat)
        }else{
          dat_box = 1
          for(j in 1:length(files_in_full2)){
            tmpdat = nc_open(files_in_full2[j])
            tmpdat = nc_to_df(tmpdat)
            if(j == 1){
              dat_box = cbind(dat_box,tmpdat)
            }else{
              tmpdat = tmpdat[,-c(1,2)]
              dat_box = cbind(dat_box,tmpdat)
            }
          }
          dat_box = dat_box[,-1]
          dat = dat_box
        }
        output_name = strsplit(output_name,'_')[[1]]
        final_name = substr(output_name[4],1,6)
        final_name = paste0(final_name,'.csv')
        output_name = paste0(output_name[1],'_',
                             output_name[2],'_',
                             output_name[3],'_',
                             final_name)
        
        output2 = paste0(output_path245,'/',output_name)
        library(data.table)
        fwrite(dat,output2)
        gc()
      }else{
        ex = extent(extent(dat)[1],extent(dat)[2],0,extent(dat)[4])
        dat = crop(dat,ex)
        dat = stack(dat)
        print(ex)
        
        writeRaster(dat,output2,format = 'CDF',overwrite = T)
        gc() 
      }
      
    }
    
  }
  
  
  
}
cmip6_preprocess <- function(
  mode = 'E'
){
  
  input_path = '/media/root/Shen_drive1/CMIP6/'
  input_path = paste0(input_path,'/',mode)
  
  model = list.files(input_path)
  files = list.files(input_path,full.names = T)
  
  files_ssp245 = paste0(files,'/ssp245')
  files_ssp585 = paste0(files,'/ssp585')
  
  output_path = paste0('/media/root/Shen_drive1/CMIP6_reorder/',
                       mode)
  dir.create(output_path)
  
  output_path245 = paste0(output_path,'/ssp245')
  output_path585 = paste0(output_path,'/ssp585')
  
  dir.create(output_path245)
  dir.create(output_path585)
  
  
  
  
  
  for(i in 4:length(files_ssp245)){
    if(model[i] != 'FGOALS-g3'){
      print(i)
      files_in_name2 = list.files(files_ssp245[i])
      files_in_full2 = list.files(files_ssp245[i],full.names = T)
      
      print(model[i])
      
      if(length(files_in_name2)==1){
        str_date = strsplit(files_in_name2,'_')[[1]][7]
        str_date = strsplit(str_date,'-')
        start_date = str_date[[1]][1]
        end_date = str_date[[1]][2]
        
        date = paste0(start_date,'_',end_date)
      }else{
        str_date = strsplit(files_in_name2[1],'_')[[1]][7]
        str_date = strsplit(str_date,'-')
        start_date = str_date[[1]][1]
        
        str_date = strsplit(files_in_name2[length(files_in_name2)],'_')[[1]][7]
        str_date = strsplit(str_date,'-')
        
        end_date = str_date[[1]][2]
        
        date = paste0(start_date,'_',end_date)
      }
      print(date)
      
      output_name = paste0('ssp245','_',model[i],'_',date)
      output2 = paste0(output_path245,'/',output_name)
      library(raster)
      library(ncdf4)
      dat = try(stack(files_in_full2,varname = 'tos'),
                 silent = T)
      if('try-error' %in% class(dat)){
        source('/home/share/R_project/xinjiang_vapor/nc_to_df.R')
        if(length(files_in_full2) == 1){
          dat = nc_open(files_in_full2)
          dat = nc_to_df(dat)
        }else{
          dat_box = 1
          for(j in 1:length(files_in_full2)){
            tmpdat = nc_open(files_in_full2[j])
            tmpdat = nc_to_df(tmpdat)
            if(j == 1){
              dat_box = cbind(dat_box,tmpdat)
            }else{
              tmpdat = tmpdat[,-c(1,2)]
              dat_box = cbind(dat_box,tmpdat)
            }
          }
          dat_box = dat_box[,-1]
          dat = dat_box
        }
        
        output_name = strsplit(output_name,'_')[[1]]
        final_name = substr(output_name[4],1,6)
        final_name = paste0(final_name,'.csv')
        output_name = paste0(output_name[1],'_',
                             output_name[2],'_',
                             output_name[3],'_',
                             final_name)
        
        output2 = paste0(output_path245,'/',output_name)
        library(data.table)
        fwrite(dat,output2)
        gc()
      }else{
        ex = extent(extent(dat)[1],extent(dat)[2],0,extent(dat)[4])
        dat = crop(dat,ex)
        print(ex)
        dat = stack(dat)
        writeRaster(dat,
                    output2,format = 'CDF',
                    overwrite = T)
        gc()
        
      }
      
      
      
      
      
      
      print('_________')
      
      files_in_name5 = list.files(files_ssp585[i])
      files_in_full5 = list.files(files_ssp585[i],full.names = T)
      
      if(length(files_in_name5)==1){
        str_date = strsplit(files_in_name5,'_')[[1]][7]
        str_date = strsplit(str_date,'-')
        start_date = str_date[[1]][1]
        end_date = str_date[[1]][2]
        
        date = paste0(start_date,'_',end_date)
      }else{
        str_date = strsplit(files_in_name5[1],'_')[[1]][7]
        str_date = strsplit(str_date,'-')
        start_date = str_date[[1]][1]
        
        str_date = strsplit(files_in_name5[length(files_in_name5)],'_')[[1]][7]
        str_date = strsplit(str_date,'-')
        
        end_date = str_date[[1]][2]
        
        date = paste0(start_date,'_',end_date)
      }
      
      print(date)
      
      output_name = paste0('ssp585','_',model[i],'_',date)
      output5 = paste0(output_path585,'/',output_name)
      library(raster)
      library(ncdf4)
      
      
      dat = try(stack(files_in_full5,varname = 'tos'),
                silent = T)
      if('try-error' %in% class(dat)){
        if(length(files_in_full5) == 1){
          dat = nc_open(files_in_full5)
          dat = nc_to_df(dat)
        }else{
          dat_box = 1
          for(j in 1:length(files_in_full5)){
            tmpdat = nc_open(files_in_full5[j])
            tmpdat = nc_to_df(tmpdat)
            if(j == 1){
              dat_box = cbind(dat_box,tmpdat)
            }else{
              tmpdat = tmpdat[,-c(1,2)]
              dat_box = cbind(dat_box,tmpdat)
            }
          }
          dat_box = dat_box[,-1]
          dat = dat_box
        }
        
        output_name = strsplit(output_name,'_')[[1]]
        final_name = substr(output_name[4],1,6)
        final_name = paste0(final_name,'.csv')
        output_name = paste0(output_name[1],'_',
                             output_name[2],'_',
                             output_name[3],'_',
                             final_name)
        output5 = paste0(output_path585,'/',output_name)
        library(data.table)
        fwrite(dat,output5)
        gc()
      }else{
        ex = extent(extent(dat)[1],extent(dat)[2],0,extent(dat)[4])
        dat = crop(dat,ex)
        dat = stack(dat)
        print(ex)
        writeRaster(dat,output5,format = 'CDF',overwrite = T)
        gc() 
      }
     
    }
    
  }
    
  
  
}
cmip6_unit_check <- function(
  
){
  
  library(raster)
  library(ncdf4)
  input = list.files('/media/root/Shen_drive1/CMIP6/',full.names = T)
  for(i in 1:2){
    files = list.files(input[i],full.names = T)
    files = paste0(files,'/historical')
    
    if(i ==1){
      for(j in 1:length(files)){
        f1 = list.files(files[i],full.names = T)[1]
        f1= nc_open(f1)
        print(f1$var$evspsbl$units)
      }  
    }else if(i==2){
      for(j in 1:length(files)){
        f1 = list.files(files[i],full.names = T)[1]
        f1= nc_open(f1)
        print(f1$var$pr$units)
      }  
    }

  }
  
}
codes_check <-function(
  
){
  input = '/home/share/R_project/xinjiang_vapor'
  files = list.files(input,pattern = '*.R$',full.names = T)
  a = '1'
  for(i in 1:length(files)){
    tmp = readLines(files[i])
    a = c(a,tmp)
  }
  a = a[-1]
  
  writeLines(a,'/home/share/R_project/xinjiang_vapor/full_codes')
}
combine_cmip6_data_his_ssp_sst <- function(
  attrs = 'SST'
){
  input_file = '/media/root/Shen_drive1/CMIP6_2003'
  
  #attr = c('E','Pr','T')
  
  input_file = paste0(input_file,'/',attrs)
  
  input_his = paste0(input_file,'/hist')
  input_ssp245 = paste0(input_file,'/ssp245')
  input_ssp585 = paste0(input_file,'/ssp585')
  
  hist_files = list.files(input_his)
  hist_files_full = list.files(input_his,full.names = T)
  
  ssp245_files = list.files(input_ssp245)
  ssp245_files_full = list.files(input_ssp245,full.names = T)
  
  ssp585_files = list.files(input_ssp585)
  ssp585_files_full = list.files(input_ssp585,full.names = T)
  
  i = 1:length(hist_files)
  
  i <<- i 
  hist_files <<- hist_files
  hist_files_full <<- hist_files_full
  ssp245_files <<- ssp245_files
  ssp245_files_full <<- ssp245_files_full
  ssp585_files <<- ssp585_files
  ssp585_files_full <<- ssp585_files_full
  
  dir.create('/media/root/Shen_drive1/CMIP6_combined')
  output = paste0('/media/root/Shen_drive1/CMIP6_combined',
                  '/',attrs)
  dir.create(output)
  
  output_his245 = paste0(output,'/hist_ssp245') # 2003-201412 201501-2050
  output_his585 = paste0(output,'/hist_ssp585')
  
  dir.create(output_his245)
  dir.create(output_his585)
  
  output_his245 <<- output_his245
  output_his585 <<- output_his585
  
  sub_combine_his_245 <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    
    tmpname = strsplit(hist_files[i],'_')[[1]][2]
    pattern = 'his245_'
    
    
    tmphis = try(stack(hist_files_full[i]),
                 silent = T)
    tmpssp = try(stack(ssp245_files_full[i]),
                 silent = T)
    if('try-error' %in% class(tmphis)|
       'try-error' %in% class(tmpssp)){
      tmphis = fread(hist_files_full[i])
      tmpssp = fread(ssp245_files_full[i])
      tmphis = as.data.frame(tmphis)
      tmpssp = as.data.frame(tmpssp)
      
      loc = tmphis[,1:2]
      tmphis = tmphis[,-c(1,2)]
      tmpssp = tmpssp[,-c(1,2)]
      
      tmpcombine = cbind(tmphis,tmpssp)
      tmpcombine = cbind(loc,tmpcombine)
      
      # area filter
      idloc = which(loc[,2]>=0)
      tmpcombine = tmpcombine[idloc,]
      
      outputname = paste0(pattern,tmpname,'_','200301_','205012.csv')
      output = paste0(output_his245,'/',outputname)
      
      fwrite(tmpcombine,output)
    }else{
      tmpcombine = stack(tmphis,tmpssp)
      outputname = paste0(pattern,tmpname,'_','200301_','205012.nc')
      
      output = paste0(output_his245,'/',outputname)
      
      writeRaster(tmpcombine,output,format = 'CDF',overwrite = T)
      
    }
    
    
  }
  
  sub_combine_his_585 <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    
    tmpname = strsplit(hist_files[i],'_')[[1]][2]
    pattern = 'his585_'
    
    
    tmphis = try(stack(hist_files_full[i]),
                 silent = T)
    tmpssp = try(stack(ssp585_files_full[i]),
                 silent = T)
    
    if('try-error' %in% class(tmphis)|
       'try-error' %in% class(tmpssp)){
      tmphis = fread(hist_files_full[i])
      tmpssp = fread(ssp585_files_full[i])
      
      tmphis = as.data.frame(tmphis)
      tmpssp = as.data.frame(tmpssp)
      
      loc = tmphis[,1:2]
      
      tmphis = tmphis[,-c(1,2)]
      tmpssp = tmpssp[,-c(1,2)]
      
      tmpcombine = cbind(loc,tmphis,tmpssp)
      
      #mask north hemisphere
      idloc = which(loc[,2]>=0)
      
      tmpcombine = tmpcombine[idloc,]
      
      outputname = paste0(pattern,tmpname,'_','200301_','205012.csv')
      output = paste0(output_his585,'/',outputname)
      
      fwrite(tmpcombine,output)
      
    }else{
      tmpcombine = stack(tmphis,tmpssp)
      outputname = paste0(pattern,tmpname,'_','200301_','205012.nc')
      
      output = paste0(output_his585,'/',outputname)
      
      writeRaster(tmpcombine,output,format = 'CDF',overwrite = T)
    }
    
    
    
  }

  library(doParallel)
  
  #cl = makeCluster(8)
  #clusterExport(cl,c("hist_files",'hist_files_full',"ssp245_files","ssp245_files_full",'i','output_ssp245'))
  #system.time(parLapply(cl,i,sub_combine_his_245))
  #stopCluster(cl)
  
  
  cl = makeCluster(8)
  clusterExport(cl,c("hist_files",'hist_files_full',"ssp585_files","ssp585_files_full",'i','output_ssp585'))
  system.time(parLapply(cl,i,sub_combine_his_585))
  stopCluster(cl)
  
  
  
}
combine_cmip6_data_his_ssp <- function(
  attrs = 'E'
){
  input_file = '/media/root/Shen_drive1/CMIP6_2003'
  
  #attr = c('E','Pr','T')
  
  input_file = paste0(input_file,'/',attrs)
  
  input_his = paste0(input_file,'/hist')
  input_ssp245 = paste0(input_file,'/ssp245')
  input_ssp585 = paste0(input_file,'/ssp585')
  
  hist_files = list.files(input_his)
  hist_files_full = list.files(input_his,full.names = T)
  
  ssp245_files = list.files(input_ssp245)
  ssp245_files_full = list.files(input_ssp245,full.names = T)
  
  ssp585_files = list.files(input_ssp585)
  ssp585_files_full = list.files(input_ssp585,full.names = T)
  
  i = 1:length(hist_files)
  
  i <<- i 
  hist_files <<- hist_files
  hist_files_full <<- hist_files_full
  ssp245_files <<- ssp245_files
  ssp245_files_full <<- ssp245_files_full
  ssp585_files <<- ssp585_files
  ssp585_files_full <<- ssp585_files_full
  
  dir.create('/media/root/Shen_drive1/CMIP6_combined')
  output = paste0('/media/root/Shen_drive1/CMIP6_combined',
                  '/',attrs)
  dir.create(output)
  
  output_his245 = paste0(output,'/hist_ssp245') # 2003-201412 201501-2050
  output_his585 = paste0(output,'/hist_ssp585')
  
  dir.create(output_his245)
  dir.create(output_his585)
  
  output_his245 <<- output_his245
  output_his585 <<- output_his585
  
  sub_combine_his_245 <- function(i){
    library(raster)
    library(ncdf4)
    
    tmpname = strsplit(hist_files[i],'_')[[1]][2]
    pattern = 'his245_'
    
    outputname = paste0(pattern,tmpname,'_','200301_','205012.nc')
    
    tmphis = stack(hist_files_full[i])
    tmpssp = stack(ssp245_files_full[i])
    
    tmpcombine = stack(tmphis,tmpssp)
    
    output = paste0(output_his245,'/',outputname)
    
    writeRaster(tmpcombine,output,format = 'CDF',overwrite = T)
    
  }
  
  sub_combine_his_585 <- function(i){
    library(raster)
    library(ncdf4)
    
    tmpname = strsplit(hist_files[i],'_')[[1]][2]
    pattern = 'his585_'
    
    outputname = paste0(pattern,tmpname,'_','200301_','205012.nc')
    
    tmphis = stack(hist_files_full[i])
    tmpssp = stack(ssp585_files_full[i])
    
    tmpcombine = stack(tmphis,tmpssp)
    
    output = paste0(output_his585,'/',outputname)
    
    writeRaster(tmpcombine,output,format = 'CDF',overwrite = T)
    
  }
  
  library(doParallel)
  
  #cl = makeCluster(8)
  #clusterExport(cl,c("hist_files",'hist_files_full',"ssp245_files","ssp245_files_full",'i','output_ssp245'))
  #system.time(parLapply(cl,i,sub_combine_his_245))
  #stopCluster(cl)
  
  
  cl = makeCluster(8)
  clusterExport(cl,c("hist_files",'hist_files_full',"ssp585_files","ssp585_files_full",'i','output_ssp585'))
  system.time(parLapply(cl,i,sub_combine_his_585))
  stopCluster(cl)
  
  
  
}
compare_data_cmip6_be_after <- function(
  
){
  input_cmip6_pj = 'analysis_output/cmip6_by_model/pme_proj/'
  input_cmip6 = 'analysis_output/cmip6_by_model/pme/'
  
  input_cmip6_pj = list.files(input_cmip6_pj,full.names = T)
  input_cmip6 = list.files(input_cmip6,full.names = T)
  
  cmip6_pj = lapply(lapply(input_cmip6_pj,fread),as.data.frame)
  cmip6 = lapply(lapply(input_cmip6,fread),as.data.frame)  
  
  i = 1:4
  for(i in i){
    tmppj = cmip6_pj[[i]]
    tmp= cmip6[[i]]
    
    trend_stand <- function(x){
      x = ts(x,start =c(2003,1),frequency = 12)
      x = decompose(x)$trend
      
      x = x[-which(is.na(x))]
      stx = (x-mean(x))/(max(x)-min(x))
      return(stx)      
    }
    
    tmppj = apply(tmppj,2,trend_stand)
    tmp = apply(tmp,2,trend_stand)
    
    meanpj = apply(tmppj,1,mean)
    meantmp = apply(tmp,1,mean)
    
    
    
  }
  
  
  
  
  
}
compare_long_term_contr <-function(
  
){
  setwd('/home/share/R_project/xinjiang_vapor')
  input_contr_by_sou = 'analysis_output/contr_in_source_variance_new.csv'
  contr_by_sou = as.data.frame(fread(input_contr_by_sou))
  
  sou_names = contr_by_sou[,1]
  contr_by_sou = contr_by_sou[,-1]
  
  contr_by_sou_mean = apply(contr_by_sou,1,mean,na.rm= T)
  contr_by_sou_mean = as.numeric(contr_by_sou_mean)
  
  sou_names[2]= 'ato'
  bar_df = data.frame(source = sou_names,
                      contr_rates = contr_by_sou_mean)
  
  contr_noloss = as.data.frame(
    fread('NC_mod_xinjiang/contr_noloss/long_term_noloss_contr.csv')
  )
  
  sou_names_new = contr_noloss$sou_names
  sou_names_new[13] = 'xj'
  
  i = 1:length(sou_names_new)
  match_by_name <- function(i){
    
    tmpid = which(sou_names == sou_names_new[i])
    retcontr = bar_df$contr_rates[tmpid]
    
    retdf = data.frame(
      sou_names = sou_names_new[i],
      CR_considering_loss = retcontr
    )
    print(retdf)
    return(retdf)
  }
  
  regroup_CR =lapply(i,match_by_name)
  regroup_CR = do.call(rbind,regroup_CR)
  
  bardf = data.frame(
    sou_names = regroup_CR$sou_names,
    CR_with_loss= regroup_CR$CR_considering_loss,
    CR_no_loss = contr_noloss$contr_rate
  )
  sous = toupper(bardf$sou_names)
  sous[which(sous == 'ATO')] = 'NATO'
  bardf$sou_names = toupper(bardf$sou_names)
  bardf$sou_names[which(bardf$sou_names == 'ATO')] = 'NATO'
  
  bardf = reshape2::melt(bardf,'sou_names')
  bardf$value = abs(bardf$value)
  
  bardf$label = paste0(
    round(bardf$value,1),'%'
  )
  bardf$label[which(bardf$sou_names %in%
                      c('BS','NA','IO',
                        'RS','PO','XJ'))] = ''
  
  bardf$sou_names = factor(bardf$sou_names,
                           levels = sous)
  fils = pal_lancet(alpha = 0.7)(9)[c(1,7)]
  fontsize = 12
  text_theme = theme(
    legend.text = element_text(size = fontsize,
                               color = 'black'),
    axis.text = element_text(size = fontsize,
                             color = 'black'),
    axis.title = element_text(size = fontsize,
                              color = 'black'),
    legend.title = element_text(size = fontsize,
                                color = 'black'),
    strip.text  = element_text(size = fontsize,
                               color = 'black') 
    
  )
  library(ggrepel)
  p = ggplot()+
    geom_bar(data = bardf,
             aes(x = sou_names,
                 y = value,
                 fill = variable),
             position = position_dodge2(0.8),
             stat = 'identity',
             width = 0.5)+
    geom_text(data  =bardf,
              aes(x = sou_names,
                  y = value +2,
                  label = label),
              size = 3.5,
              position = position_dodge2(0.8))+
    scale_fill_manual(values = fils)+
    theme_bw()+
    text_theme+
    guides(fill = guide_legend(title = ''))+
    theme(panel.grid = element_blank(),
          legend.position = 'bottom')+
    xlab('Water vapor source regions')+
    ylab('Water vapor contribution rates (%)')
  
  dir.create('NC_mod_xinjiang/add_longterm_contr_noloss')
  png('NC_mod_xinjiang/add_longterm_contr_noloss/fig.png',
      height = 12,
      width = 22,
      units = 'cm',
      res = 800)
  print(p)
  dev.off()
  
  
  
  
  
  
  
  
  
  
}
contr_bar_stat<-function(
  
){
  
  contr = fread('analysis_output/contr_in_source_variance_new.csv')
  contr = as.data.frame(contr)
  
  sou_names = contr[,1]
  contr = contr[,-1]
  
  sub_contr<-function(x){
    
    x = matrix(x,nrow = 12)
    mean_fun <-function(x){
      xm = mean(x,na.rm = T)
      return(xm)
    }
    xm = apply(x,1,mean_fun)
  }
  
  x = data.frame(x,x_mean = xmean)
  colnames(x) = c(paste0("year",2003:2017),'xmean')
  mon = factor(1:12)
  
  xm = data.frame(mon,x)
  xm = melt(xm,'mon')
  pbar = ggplot()+
    geom_tile(data = xm,aes(x = variable, y = mon,fill = value))+
    scale_fill_distiller(palette = 'Spectral')+
    theme_bw()+
    theme(
      panel.background = element_rect(fill = 'transparent'),
      axis.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      axis.title = element_text(color = 'black',size = 14,face = 'bold',hjust = 0.5),
      legend.position = 'bottom',
      legend.direction = 'horizontal',
      legend.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      legend.title = element_text(color = 'black',size = 14, face = 'bold',hjust = 0.5),
      strip.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5)
    )+
    guides(color = guide_legend(nrow = 1))
}
contribution_ratio_cal<-function(
  input_data
){
  
  sub_cal<-function(
    input_sub
  ){
    df = fread(paste0(input_sub,'/var_whole_route_mid.csv'))
    
    # ocean 
    id_ocean_p = paste0(input_sub,'/df_first_ocean')
    id_ocean_p = list.files(id_ocean_p,full.names = T)
    
    id_li = list()
    for(i in 1:length(id_ocean_p)){
      tmp = read.csv(id_ocean_p[i],header = T)
      tmp = tmp[,-1]
      tmp = as.vector(tmp)
      id_li = c(id_li,tmp)
    }
    
    # return full id
    
    group_id <- function(x){
      step = round(length(x) /100)
      ids = seq(1,length(x),step)
      ide = ids -1
      ide = ide[-1]
      ide = c(ide,length(x))
      xl = list()
      for(i in 1:length(ids)){
        stmp = ids[i]
        etmp = ide[i]
        tmp = x[stmp:etmp]
        xl[[i]] = tmp
      }
      return(xl)
    }
    
    xfull <<- df$type
    df_fullid <<- df$type
    
    for(i in 1:length(id_li)){
      
      tmpid = id_li[[i]]
      
      tmpid_g = group_id(tmpid)
      
      tmp_ret_id = lapply(tmpid_g,search_which_full)
      
      
      
      
      
      
    }
    
    
    
    
    
  }
}
convey_rate_plot<-function(
  
){
  input_convey =  input_con_mean = 'analysis_output/convey_rate_by_region_mean.csv'
  convey_rate = fread(input_convey)
  convey_rate = as.data.frame(convey_rate)
  
  sounames = convey_rate[,1]
  type = rep(c('north_jishui',
               'north_moun',
               'south_jishui',
               'south_moun'),each =12)
  
  convey_rate$type = type
  
  df = reshape2::melt(convey_rate,c('re_group','type'))
  #df$variable = as.numeric(df$variable)
  
  colnames(df) = c('Source_region','type','Date',
                   'value')
  
  
  p = ggplot()+
    geom_path(data = df,
              aes(x = Date,y = value,group = Source_region,
                  color= Source_region))+
    facet_wrap(~type,nrow = 2)
  
  
  
}
cor_analysis_annual_scale<-function(
  
){
  input = 'covar_analysis_data'
  input_pme_in_source = paste0(input,'/pme_in_source.csv')
  input_pme_targ_south = paste0(input,'/pme_in_target_south.csv')
  input_pme_targ_north = paste0(input,'/pme_in_target_north.csv')
  input_tws_targ_south = paste0(input,'/tws_in_target_south.csv')
  input_tws_targ_north = paste0(input,'/tws_in_target_north.csv')
  input_tws_in_source = paste0(input,'/tws_in_source.csv')
  input_prdf_source = paste0(input,'/pr_in_source.csv')
  
  
  pmedf = as.data.frame(fread(input_pme_in_source))
  prdf = as.data.frame(fread(input_prdf_source))
  pmedf_south = as.data.frame(fread(input_pme_targ_south))
  pmedf_north = as.data.frame(fread(input_pme_targ_north))
  tws_south = as.data.frame(fread(input_tws_targ_south))
  tws_north = as.data.frame(fread(input_tws_targ_north))
  twsdf = as.data.frame(fread(input_tws_in_source))
  
  naid = which(is.na(pmedf$pme1))
  pmedf = pmedf[-naid,]
  twsdf = twsdf[-naid,]
  prdf = prdf[-naid,]
  prdf = prdf[,-1]
  twsdf = twsdf[,-1]
  pmedf = pmedf[,-1]
  pmedf_south = pmedf_south[-naid,]
  pmedf_north = pmedf_north[-naid,]
  tws_south = tws_south[-naid,]
  tws_north = tws_north[-naid,]
  
  petar_south = pmedf_south$value
  petar_north = pmedf_north$value
  twstar_south = tws_south$value
  twstar_north = tws_north$value  
  
  to_annual<-function(x){
    x = c(rep(NA,6),x)
    x = matrix(x,nrow = 12)
    x = apply(x,2,sum,na.rm = T)
    return(as.numeric(x))
  }
  
  pme_ann = apply(pmedf,2,to_annual)
  petar_north_ann = to_annual(petar_north)
  petar_south_ann = to_annual(petar_south)
  tws_ann = apply(twsdf,2,to_annual)
  twstar_north_ann = to_annual(twstar_north)
  twstar_south_ann = to_annual(twstar_south)
  
  
  cor_north = 1
  cor_south = 1
  for(i in 1:ncol(pmedf)){
    tmp_south = max(ccf(pme_ann[,i],petar_south_ann)$acf)
    tmp_north = max(ccf(pme_ann[,i],petar_north_ann)$acf)
    
    cor_north = c(cor_north,tmp_north)
    cor_south = c(cor_south,tmp_south)
  }
  cor_north = cor_north[-1]
  cor_south = cor_south[-1]
  
  print(cor_north)
  print(cor_south)
  
  
}
cor_analysis_pr_and_pr_tws_<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/find_peak_valley_p_trial.R')
  library(data.table)
  input = 'covar_analysis_data'
  input_pme_in_source = paste0(input,'/pme_in_source.csv')
  input_pme_targ_south = paste0(input,'/pme_in_target_south.csv')
  input_pme_targ_north = paste0(input,'/pme_in_target_north.csv')
  input_tws_targ_south = paste0(input,'/tws_in_target_south.csv')
  input_tws_targ_north = paste0(input,'/tws_in_target_north.csv')
  
  pmedf = as.data.frame(fread(input_pme_in_source))
  pmedf_south = as.data.frame(fread(input_pme_targ_south))
  pmedf_north = as.data.frame(fread(input_pme_targ_north))
  tws_south = as.data.frame(fread(input_tws_targ_south))
  tws_north = as.data.frame(fread(input_tws_targ_north))
  
  naid = which(is.na(pmedf$pme1))
  pmedf = pmedf[-naid,]
  pmedf = pmedf[,-1]
  pmedf_south = pmedf_south[-naid,]
  pmedf_north = pmedf_north[-naid,]
  tws_south = tws_south[-naid,]
  tws_north = tws_north[-naid,]
  
  petar_south = pmedf_south$value
  petar_north = pmedf_north$value
  twstar_south = tws_south$value
  twstar_north = tws_north$value
  
  abid_south = find_peak_valley_p_trial(petar_south,0.5)
  abid_north = find_peak_valley_p_trial(petar_north,0.5)
  
  abid_north_start = c(1,abid_north)
  abid_south_start = c(1,abid_south)
  abid_north_end = c(abid_north,162)
  abid_south_end = c(abid_south,162)
  
  cor_box_outter = 1
  for(i in 1:length(abid_north_start)){
    tmpid = abid_north_start[i]:abid_north_end[i]
    tmpmat = pmedf[tmpid,]
    tmpnorth = petar_north[tmpid]
    
    cor_box = 1
    for(j in 1:ncol(tmpmat)){
      tmpcor = cor(tmpmat[,j],tmpnorth)  
      cor_box = c(cor_box,tmpcor)
    }
    
    cor_box = cor_box[-1]
    cor_box_outter = rbind(cor_box_outter,
                           cor_box)
  }
  cor_box_outter = cor_box_outter[-1,]
    
  # monthly analysis
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),
             '1 month')
  date = date[1:174]
  date = date[-naid]
  
  mon_cor_box_south = 1
  mon_cor_box_north = 1
  for(i in 1:ncol(pmedf)){
    
    tmppme = as.numeric(pmedf[,i])
    tmppme = c(rep(NA,6),tmppme)
    tmppme = matrix(tmppme,nrow = 12)
    
    tmppme_north =c(rep(NA,6), petar_north)
    tmppme_south = c(rep(NA,6),petar_south)
    
    tmppme_north = matrix(tmppme_north,nrow = 12)
    tmppme_south = matrix(tmppme_south,nrow = 12)
    
    cor_north_box = 1
    cor_south_box = 1
    for(j in 1:nrow(tmppme)){
      tmpid = which(is.na(tmppme[j,]))
      
      monpme = tmppme[j,]
      monpme_north = tmppme_north[j,]
      monpme_south = tmppme_south[j,]
      if(length(tmpid)>0){
        monpme = monpme[-tmpid]
        monpme_north = monpme_north[-tmpid]
        monpme_south = monpme_south[-tmpid]
      }
      
      
      moncor_north = max(ccf(monpme,monpme_north)$acf)
      moncor_south = max(ccf(monpme,monpme_south)$acf)
      
      cor_north_box = c(cor_north_box,
                        moncor_north)
      cor_south_box = c(cor_south_box,
                        moncor_south)
    }
    cor_north_box = cor_north_box[-1]
    cor_south_box = cor_south_box[-1]
    
    mon_cor_box_north = cbind(mon_cor_box_north,
                              cor_north_box)
    mon_cor_box_south = cbind(mon_cor_box_south,
                              cor_south_box)
    
  }
  mon_cor_box_north = mon_cor_box_north[,-1]
  mon_cor_box_south = mon_cor_box_south[,-1]
  
  cols = paste0(rep(c('as','ato','eu'),each = 4),
                rep(1:4,3))
  cols = cols[-c(3,12)]
  
  colnames(mon_cor_box_north) = cols
  colnames(mon_cor_box_south) = cols
  
  mon = toupper(month.abb)
  
  dfcor_north = data.frame(mon,mon_cor_box_north)
  dfcor_south = data.frame(mon,mon_cor_box_south)
  
  dfcor_northm = reshape2::melt(dfcor_north,'mon')
  dfcor_southm = reshape2::melt(dfcor_south,'mon')
  
  dfcor_northm$type = 'north'
  dfcor_southm$type = 'south'
  
  dfcor = rbind(dfcor_northm,
                dfcor_southm)
  dfcor$mon = factor(dfcor$mon,
                     levels = mon)
  
  dfcor$cuts = cut(dfcor$value,
                    breaks = seq(-1,1,0.25),
                    right = F
                    )
  p = ggplot()+
    geom_tile(data = dfcor,
              aes(x = variable,
                  y = mon,
                  fill = cuts))+
    scale_fill_brewer(palette = 'Spectral',
                      direction = -1)+
    theme_bw()+
    facet_wrap(~type,nrow = 1)
  
  p
  
  
  
  
}
cor_analysis_pr_tws <-function(
  pattern = 'north'
){
  trend_fun <-function(x){
    
    #xs = (x - mean(x))/(max(x)-min(x))
    
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    
    xt = as.numeric(xt)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }  
  
  # import tws
  input_tws = 'tws_in_target/'
  files_jishui = c('north_jishui','south_jishui')
  input_tws = paste0(input_tws,files_jishui,'.csv')
  
  north_tws = as.data.frame(fread(input_tws[1]))
  south_tws = as.data.frame(fread(input_tws[2]))
  
  north_tws = north_tws[,1]
  south_tws = south_tws[,1]
  
  north_tws = trend_fun(north_tws)
  south_tws = trend_fun(south_tws)
  
  naid = which(is.na(north_tws))
  
  if(pattern == 'north'){
    tws = north_tws[-naid]
  }else{
    tws = south_tws[-naid]
  }
  
  
  
  library(data.table)
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  source('/home/share/R_project/xinjiang_vapor/source_id_identify.R')
  
  pe_in_source = import_pe_in_source('era5_pr_mean',
                                     name = 'era5_pr_mean.csv')
  pe_in_source = pe_in_source[1:174,]
  
  eva_in_source = import_pe_in_source('era5_eva_mean',
                                      name = 'era5_eva_mean.csv')
  eva_in_source = eva_in_source[1:174,]
  # as,ato,eu
  colnames(eva_in_source) = paste0('eva',1:12)
  
  tws_in_source = import_pe_in_source('tws_in_source',
                                      name = 'tws_sum.csv')
  colnames(tws_in_source) = paste0('tws',1:12)
  
  
  #pe_in_source = pe_in_source
  #pe_in_source = tws_in_source
  
  if(pattern == 'north'){
    id_re = source_id_identify('north')
    pe_in_source = pe_in_source[,-id_re]
  }else{
    id_re = source_id_identify('south')
    pe_in_source = pe_in_source[,-id_re]
  }
  
  pe_t = apply(pe_in_source,2,trend_fun)
  naid = which(is.na(pe_t[,1]))
  pe_t = pe_t[-naid,]
  
  
  # cor analysis
  cor_box = 1
  for(i in 1:ncol(pe_t)){
    tmp = cor(pe_t[,i],tws)
    print(colnames(pe_t)[i])
    print(tmp)
    cor_box =c(cor_box,tmp)
  }
  cor_box = cor_box[-1]
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
}













cor_analysis_spei_tws<-function(
  pattern = 'north'
){
  trend_fun <-function(x){
    
    #xs = (x - mean(x))/(max(x)-min(x))
    
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    
    xt = as.numeric(xt)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }  
  # import tws
  input_tws = 'tws_in_target/'
  files_jishui = c('north_jishui','south_jishui')
  input_tws = paste0(input_tws,files_jishui,'.csv')
  
  north_tws = as.data.frame(fread(input_tws[1]))
  south_tws = as.data.frame(fread(input_tws[2]))
  
  north_tws = north_tws[-c(1:2),1]
  south_tws = south_tws[-c(1:2),1]
  
  north_tws = trend_fun(north_tws)
  south_tws = trend_fun(south_tws)
  
  naid = which(is.na(north_tws))
  
  if(pattern == 'north'){
    tws = north_tws[-naid]
  }else{
    tws = south_tws[-naid]
  }
  
  # import spei
  input_spei = 'spei3_in_source'
  input_spei = paste0(input_spei,'/',pattern,'.csv')
  spei = fread(input_spei)
  
  spei_df = as.data.frame(spei)
  colnames(spei_df) = paste0('spei',1:12)
  spei_df = spei_df[-c(1,2),]
  
  spei_df = apply(spei_df,2,trend_fun)
  
  if(pattern == 'north'){
    id_re = source_id_identify('north')
    spei_df = spei_df[,-id_re]
  }else{
    id_re = source_id_identify('south')
    spei_df = spei_df[,-id_re]
  }
  tmpid = which(is.na(spei_df[,1]))
  spei_df = spei_df[-tmpid,]
  
  cor_box = 1
  for(i in 1:ncol(spei_df)){
    
    tmpcor = cor(spei_df[,i],tws)
    print(colnames(spei_df)[i])
    print(tmpcor)
    cor_box = c(cor_box,tmpcor)
  }
  cor_box = cor_box[-1]
  
  
  df = data.frame(tws = tws,
                  spei_df)
  dfm = reshape2::melt(df,'tws')
  
  p = ggplot()+
    geom_point(data = dfm,aes(x = tws,y = value))+
    facet_wrap(~variable,scales = 'free',nrow = 2)+
    theme_bw()
  
  p
    
  
  
  
  
  
}
cor_analysis_sub_windowtws_atope<-function(
  mode = 'ato3'
){
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  if(mode == 'ato1'){
    pe_ato34 = pe_in_source$pr5
    pet_ato34 = pet_sum$pr5
    output_pme_trend = 'analysis_output/fig2/pme_ato1_trend.csv'
  }else if(mode =='ato2'){
    pe_ato34 = pe_in_source$pr6
    pet_ato34 = pet_sum$pr6
    output_pme_trend = 'analysis_output/fig2/pme_ato2_trend.csv'
  }else if(mode == 'ato3'){
    pe_ato34 = pe_in_source$pr7
    pet_ato34 = pet_sum$pr7
    output_pme_trend = 'analysis_output/fig2/pme_ato3_trend.csv'
  }else{
    pe_ato34 = pe_in_source$pr8
    pet_ato34 = pet_sum$pr8
    output_pme_trend = 'analysis_output/fig2/pme_ato4_trend.csv'
  }
  
  
  #pe_ato34 = pe_in_source$pr7
  #pet_ato34 = pet_sum$pr7
  
  pme_ato34 = pe_ato34 - pet_ato34
  
  trend_fun <-function(x){
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    
    xt = as.numeric(xt)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }
  
  
  pme_ato34 = trend_fun(pme_ato34)
  naid = which(is.na(pme_ato34))
  pme_ato34 = pme_ato34[-naid]
  
  write.csv(pme_ato34,output_pme_trend)
  
  input_tws_subwindow = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws_subs = read.csv(input_tws_subwindow,header = T)
  tws_subs = tws_subs[,-1]
  
  colnames(tws_subs) = paste0('subwindow',1:ncol(tws_subs))
  
  tws_subs = tws_subs[-naid,]
  
  input_sub_shp = paste0('sub_windows',
                         '/sub_window',1:19,'.shp')
  
  shp_list = list()
  tws_box = 1
  cor_box = 1
  id_box = 1
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  for(i in id_box){
    
    #tmpcor = cor(pme_ato34,tws_subs[,i])
    tmpcor = max(ccf(pme_ato34,tws_subs[,i])$acf)
    
    tmpshp = shapefile(input_sub_shp[i])
    shp_list = c(shp_list,tmpshp)
    tws_box = cbind(tws_box,tws_subs[,i])
    cor_box = c(cor_box,tmpcor)
    #print(tmpcor)
  }
  tws_box = tws_box[,-1]
  cor_box = cor_box[-1]
  shp_com = do.call('bind',shp_list)
  
  
  
  output_combine_sub = 'analysis_output/fig2/combine_sub_window.shp'
  output_combine_tws = 'analysis_output/fig2/combine_tws_subwindow.csv' 
  fwrite(tws_box,output_combine_tws)

  shapefile(shp_com,output_combine_sub,
            overwrite = T)
  
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),
             '1 month')
  date = date[1:174]
  date = date[-naid]
  
  linedf =1
  for(i in 1:ncol(tws_box)){
    tmpdf = cbind(date = date,
                       pme_ato34 = pme_ato34,
                       tws = tws_box[,i],
                       type = i)
    
    linedf= rbind(linedf,tmpdf)
  }
  linedf = linedf[-1,]
  
  linedf = as.data.frame(linedf)
  linedfm = reshape2::melt(linedf,c('date','type'))
  
  ret_box = list(pme_ato34,
                 tws_box,
                 shp_com,
                 cor_box)
  return(ret_box)
}
cor_analysis_sub_windowtws_atotas<-function(
  mode = 'ato3'
){
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  
  peva_subs = read.csv(
    'analysis_output/poten_eva_subwindow_2003_2017.csv',
    header = T
  )
  naid = which(is.na(peva_subs[,2]))
  peva_subs = peva_subs[-naid,-1]
  
  sst = read.csv('analysis_output/ato_mean_trend_sst.csv',
                 header =T)
  sst = sst[-naid,-1]
  
  
  input_tws_subwindow = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws_subs = read.csv(input_tws_subwindow,header = T)
  tws_subs = tws_subs[,-1]
  
  colnames(tws_subs) = paste0('subwindow',1:ncol(tws_subs))
  
  tws_subs = tws_subs[-naid,]
  
  input_sub_shp = paste0('sub_windows',
                         '/sub_window',1:19,'.shp')
  
  shp_list = list()
  tws_box = 1
  cor_box = 1
  id_box = 1
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  for(i in id_box){
    
    #tmpcor = cor(pme_ato34,tws_subs[,i])
    #tmpcor = max(ccf(sst[,2],tws_subs[,i])$acf)
    tmpcor = max(ccf(sst[,3],tws_subs[,i])$acf)
    tmpshp = shapefile(input_sub_shp[i])
    shp_list = c(shp_list,tmpshp)
    tws_box = cbind(tws_box,tws_subs[,i])
    cor_box = c(cor_box,tmpcor)
    print(tmpcor)
  }
  tws_box = tws_box[,-1]
  cor_box = cor_box[-1]
  shp_com = do.call('bind',shp_list)
  
  return(ret_box)
}
cor_analysis_whole_index <- function(
  
){
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  source('/home/share/R_project/xinjiang_vapor/source_id_identify.R')
  
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source
  
  #pe_in_source = import_pe_in_source('gpcc_pr_sum',
  #                                   name = 'gpcc_pr_sum.csv')
  #pe_in_source = pe_in_source[1:174,]
  
  eva_in_source = import_pe_in_source('era5_eva_sum',
                                      name = 'era5_eva_sum.csv')
  eva_in_source = eva_in_source
  colnames(eva_in_source) = paste0('eva',1:12)
  
  tws_in_source = import_pe_in_source('tws_in_source',
                                      name = 'tws_sum.csv')
  colnames(tws_in_source) = paste0('tws',1:12)
  
  
  eva_in_source = eva_in_source *30.5
  pe_in_source = pe_in_source * 30.5
  
  pe_minus_eva = pe_in_source - eva_in_source 
  colnames(pe_minus_eva) = paste0('pme',1:12)
  
  input_pr_intarget = list.files('era5_pr_in_target',
                                 full.names = T)[c(1,3)]
  input_eva_intarget = list.files('evaporation_in_target',
                                  full.names =T)[c(1,3)]
  
  pr_in_target = fread(input_pr_intarget[1])
  eva_in_target = fread(input_eva_intarget[1])
  
  pr_in_target= as.data.frame(pr_in_target)
  eva_in_target = as.data.frame(eva_in_target)
  
  pme_north = pr_in_target - eva_in_target
  
  pr_in_target = fread(input_pr_intarget[2])
  eva_in_target = fread(input_eva_intarget[2])
  
  pr_in_target= as.data.frame(pr_in_target)
  eva_in_target = as.data.frame(eva_in_target)
  
  pme_south = pr_in_target - eva_in_target
  
  
  trend_fun <-function(x){
    
    #xs = (x - mean(x))/(max(x)-min(x))
    
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    
    xt = as.numeric(xt)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }  
  
  pme_t = apply(pe_minus_eva,2,trend_fun)
  petar_south = trend_fun(pme_south$south_jishui)
  petar_north = trend_fun(pme_north$north_jishui)
  
  naid = which(is.na(pme_t[,1]))
  pmet = pme_t[-naid,]
  petar_north = petar_north[-naid]
  petar_south = petar_south[-naid]
  
  cor_north = 1
  cor_south = 1
  for(i in 1:ncol(pmedf)){
    tmp_south = max(ccf(pmet[,i],petar_south)$acf)
    tmp_north = max(ccf(pmet[,i],petar_north)$acf)
    
    cor_north = c(cor_north,tmp_north)
    cor_south = c(cor_south,tmp_south)
  }
  cor_north = cor_north[-1]
  cor_south = cor_south[-1]
  
  print(cor_north)
  print(cor_south)
  
  
  
}
cor_filter_fun <-function(
  ret_df
){
  cor2 = 1
  for(i in 1:10 ){
    cor1 = 1
    for(j in 1:8){
      tmpdf = ret_df[[i]][[1]][[j]][[2]]
      tmpcor = cor(tmpdf[,1],tmpdf[,2])
      cor1 = c(cor1,tmpcor)
    }
    cor1 = cor1[-1]
    cor2 = cbind(cor2,cor1)
  }
  cor2 = cor2[,-1]
  return(cor2)
}
cor_pme_tws_cmip6 <- function(
 df
){
  
  g1 = 1:10
  g2 = 11:20
  
  df1 = df[which(df$type %in% g1),]
  df2 = df[which(df$type %in% g2),]
  
  cor1_box = 1
  cor2_box = 1
  for(i in 1:10){
    tmpid1 = which(df1$type ==g1[i])
    tmpid2 = which(df2$type ==g2[i])
    
    tmpdf1 = df1[tmpid1,]
    tmpdf2 = df2[tmpid2,]
    
    cor1 = cor(tmpdf1$TWS,
               tmpdf1$value)
    
    cor2 = cor(tmpdf2$TWS,
               tmpdf2$value)
    
    cor1_box = c(cor1_box,
                 cor1)
    cor2_box = c(cor2_box,
                 cor2)
  }
  cor1_box = cor1_box[-1]
  cor2_box = cor2_box[-1]
  
  cor1_box = data.frame(
    x = 0.05,
    y = -0.20+0.05,
    cor = paste0('Cor: ',round(cor1_box,2)),
    type = 1:10
  )
  
  cor2_box = data.frame(
    x = 0.05,
    y = -0.20+0.05,
    cor = paste0('Cor: ',round(cor2_box,2)),
    type = 11:20
  )
  corbox = rbind(cor1_box,cor2_box)
  pbox = data.frame(
    x = 0.05,
    y = -0.23+0.02,
    cor = 'p<0.05',
    type = 1:20
  )
  
  return(list(corbox,pbox))
}
cor_tws_gdp <- function(
  pos_tws
){
  if(mode == 'gdp'){
    input = 'NC_mod_xinjiang/fig_impact_human/gdp.csv'
    type = 'GDP'
  }else{
    input = 'NC_mod_xinjiang/fig_impact_human/gdp_growth_ratio.csv'
    type = 'GDP_GR'
  }
  
  df = read.csv(input,header = T)
  
  countrys = df[,1]
  df = df[,-1]
  df = t(df)
  stand_fun <- function(x){
    x = as.numeric(x)
    x = (x-mean(x,na.rm = T))/(max(x,na.rm = T)-min(x,na.rm = T))
  }
  
  
  df = apply(df,2,stand_fun)
  i = 1:ncol(df)
  cor_fun_p <- function(i){
    tmp1 = pos_tws[,i]
    tmp2 = df[,i]
    tmp = cor.test(tmp1,tmp2)$p.value
    return(tmp)
  }
  
  cor_fun <- function(i){
    tmp1 = pos_tws[,i]
    tmp2 = df[,i]
    tmp = cor.test(tmp1,tmp2)$estimate
    return(tmp)
  }
  
  pv = do.call(c,lapply(i,cor_fun_p))
  corv = do.call(c,lapply(i, cor_fun))
  return(data.frame(p = pv,cor = corv))
}
correct_fut_pme_region1<- function(
  
){
  # import cmip6 pme
  input_pme = 'analysis_output/cmip6_by_model/pme'
  files = list.files(input_pme,
                     full.names = T)
  
  pme3ssp245 = as.data.frame(
    fread(files[1])
  )
  pme3ssp585 = as.data.frame(
    fread(files[2])
  )
  
  i = 1:ncol(pme3ssp245)
  
  models = colnames(pme3ssp245)
  
  input_coeff245 = 'analysis_output/bc_cmip6_region1/coeff/ssp245'
  input_coeff585 = 'analysis_output/bc_cmip6_region1/coeff/ssp585'
  input_diff245 = 'analysis_output/bc_cmip6_region1/diff/ssp245'
  input_diff585 = 'analysis_output/bc_cmip6_region1/diff/ssp585'
  
  input_coeff245 = paste0(input_coeff245,'/',models,'.csv')
  input_coeff585 = paste0(input_coeff585,'/',models,'.csv')
  input_diff245 = paste0(input_diff245,'/',models,'.csv')
  input_diff585 = paste0(input_diff585,'/',models,'.csv')
  
  proj245 <- function(i){
    tmp = pme3ssp245[,i]
    tmp = as.numeric(tmp)
    
    coeff = as.data.frame(fread(input_coeff245[i]))
    diff = as.data.frame(fread(input_diff245[i]))
    a = coeff$a
    b = coeff$b
    c = coeff$c
    d = coeff$d
    
    projpme = a+ b*tmp+c*I(tmp^2)+d*I(tmp^3)
    repdif = rep(diff$matdiff,48)
    
    projpme = projpme+ repdif
    return(projpme)
  }
  proj585 <- function(i){
    tmp = pme3ssp585[,i]
    tmp = as.numeric(tmp)
    
    coeff = as.data.frame(fread(input_coeff585[i]))
    diff = as.data.frame(fread(input_diff585[i]))
    a = coeff$a
    b = coeff$b
    c = coeff$c
    d = coeff$d
    
    projpme = a+ b*tmp+c*I(tmp^2)+d*I(tmp^3)
    repdif = rep(diff$matdiff,48)
    
    projpme = projpme+ repdif
    return(projpme)
  }
  
  proj_pme_245= do.call(cbind,
                        lapply(i,proj245))
  proj_pme_585 = do.call(cbind,
                         lapply(i,proj585))
  colnames(proj_pme_245) = models
  colnames(proj_pme_585) = models
  
  dir.create('analysis_output/cmip6_by_model/pme_proj')
  
  fwrite(proj_pme_245,'analysis_output/cmip6_by_model/pme_proj/region1_ssp245.csv')
  fwrite(proj_pme_585,'analysis_output/cmip6_by_model/pme_proj/region1_ssp585.csv')
  
}
correct_fut_pme_trend_backup<- function(
  
){
  # import cmip6 pme
  input_pme = 'analysis_output/cmip6_by_model/pme'
  files = list.files(input_pme,
                     full.names = T)
  
  pme3ssp245 = as.data.frame(
    fread(files[3])
  )
  pme3ssp585 = as.data.frame(
    fread(files[4])
  )
  
  i = 1:ncol(pme3ssp245)
  
  models = colnames(pme3ssp245)
  
  input_coeff245 = 'analysis_output/bc_cmip6_fut/coeff/ssp245'
  input_coeff585 = 'analysis_output/bc_cmip6_fut/coeff/ssp585'
  
  input_coeff245 = paste0(input_coeff245,'/coeff.csv')
  input_coeff585 = paste0(input_coeff585,'/coeff.csv')
  
  trend_stand <- function(x){
    x = ts(x,start =c(2003,1),frequency = 12)
    x = decompose(x)$trend
    
    x = x[-which(is.na(x))]
    x = (x-mean(x))/(max(x)-min(x))
    return(x)      
  }
  
  proj245 <- function(){
    tmp = pme3ssp245
    tmp = apply(tmp,2,trend_stand)
    colnames(tmp) = paste0('m',1:8)
    tmp = as.data.frame(tmp)
    
    coeff = as.data.frame(fread(input_coeff245))
    a = coeff$a
    b1 = coeff$b1
    b2 = coeff$b2
    b3 = coeff$b3
    b4 = coeff$b4
    b5 = coeff$b5
    b6 = coeff$b6
    b7 = coeff$b7
    b8 = coeff$b8
    
    
    projpme = a+ b1*tmp$m1+b2*tmp$m2+
      b3*tmp$m3+b4*tmp$m4+
      b5*tmp$m5+b6*tmp$m6+b7*tmp$m7+b8*tmp$m8
    return(projpme)
  }
  proj585 <- function(){
    tmp = pme3ssp585
    tmp = apply(tmp,2,trend_stand)
    colnames(tmp) = paste0('m',1:8)
    tmp = as.data.frame(tmp)
    coeff = as.data.frame(fread(input_coeff585))
    a = coeff$a
    b1 = coeff$b1
    b2 = coeff$b2
    b3 = coeff$b3
    b4 = coeff$b4
    b5 = coeff$b5
    b6 = coeff$b6
    b7 = coeff$b7
    b8 = coeff$b8
    
    
    projpme = a+ b1*tmp$m1+b2*tmp$m2+
      b3*tmp$m3+b4*tmp$m4+
      b5*tmp$m5+b6*tmp$m6+b7*tmp$m7+b8*tmp$m8
    return(projpme)
  }
  
  
  proj_pme_245= proj245()
  proj_pme_585 = proj585()
  
  proj_pme_245 = matrix(rep(proj_pme_245,8),ncol = 8,
                        byrow = F)
  proj_pme_585= matrix(rep(proj_pme_585,8),ncol = 8,
                       byrow = F)
  
  colnames(proj_pme_245) = models
  colnames(proj_pme_585) = models
  
  dir.create('analysis_output/cmip6_by_model/pme_proj_trend')
  
  fwrite(proj_pme_245,'analysis_output/cmip6_by_model/pme_proj_trend/region3_ssp245.csv')
  fwrite(proj_pme_585,'analysis_output/cmip6_by_model/pme_proj_trend/region3_ssp585.csv')
  
}
correct_fut_pme_trend<- function(
  
){
  # import cmip6 pme
  input_pme = 'analysis_output/cmip6_by_model/pme'
  files = list.files(input_pme,
                     full.names = T)
  
  pme3ssp245 = as.data.frame(
    fread(files[3])
  )
  pme3ssp585 = as.data.frame(
    fread(files[4])
  )
  
  i = 1:ncol(pme3ssp245)
  
  models = colnames(pme3ssp245)
  
  input_coeff245 = 'analysis_output/bc_cmip6_fut/coeff/ssp245'
  input_coeff585 = 'analysis_output/bc_cmip6_fut/coeff/ssp585'
  
  input_coeff245 = paste0(input_coeff245,'/coeff.csv')
  input_coeff585 = paste0(input_coeff585,'/coeff.csv')
  
  trend_stand <- function(x){
    x = ts(x,start =c(2003,1),frequency = 12)
    x = decompose(x)$trend
    
    x = x[-which(is.na(x))]
    x = (x-mean(x))/(max(x)-min(x))
    return(x)      
  }
  
  proj245 <- function(){
    tmp = pme3ssp245
    tmp = tmp[175:576,]
    tmp = apply(tmp,2,trend_stand)
    tmp = tmp[,c(1,5,8)]
    colnames(tmp) = paste0('m',1:3)
    tmp = as.data.frame(tmp)
    
    coeff = as.data.frame(fread(input_coeff245))
    a = coeff$a
    b1 = coeff$b1
    b2 = coeff$b2
    b3 = coeff$b3
    
    
    
    projpme = a+ b1*tmp$m1+b2*tmp$m2+
      b3*tmp$m3
    return(projpme)
  }
  proj585 <- function(){
    tmp = pme3ssp585
    tmp = tmp[175:576,]
    tmp = apply(tmp,2,trend_stand)
    tmp = tmp[,c(2,3,6)]
    colnames(tmp) = paste0('m',1:3)
    tmp = as.data.frame(tmp)
    coeff = as.data.frame(fread(input_coeff585))
    a = coeff$a
    b1 = coeff$b1
    b2 = coeff$b2
    b3 = coeff$b3
    
    
    
    projpme = a+ b1*tmp$m1+b2*tmp$m2+
      b3*tmp$m3
    return(projpme)
  }
  
  
  proj_pme_245= proj245()
  proj_pme_585 = proj585()
  
  proj_pme_245 = matrix(rep(proj_pme_245,8),ncol = 8,
                        byrow = F)
  proj_pme_585= matrix(rep(proj_pme_585,8),ncol = 8,
                       byrow = F)
  
  colnames(proj_pme_245) = models
  colnames(proj_pme_585) = models
  
  dir.create('analysis_output/cmip6_by_model/pme_proj_trend')
  
  fwrite(proj_pme_245,'analysis_output/cmip6_by_model/pme_proj_trend/region3_ssp245.csv')
  fwrite(proj_pme_585,'analysis_output/cmip6_by_model/pme_proj_trend/region3_ssp585.csv')
  
}
correct_fut_pme_trend1_backup<- function(
  
){
  # import cmip6 pme
  input_pme = 'analysis_output/cmip6_by_model/pme'
  files = list.files(input_pme,
                     full.names = T)
  
  pme3ssp245 = as.data.frame(
    fread(files[1])
  )
  pme3ssp585 = as.data.frame(
    fread(files[2])
  )
  
  i = 1:ncol(pme3ssp245)
  
  models = colnames(pme3ssp245)
  
  input_coeff245 = 'analysis_output/bc_cmip6_fut_reg1/coeff/ssp245'
  input_coeff585 = 'analysis_output/bc_cmip6_fut_reg1/coeff/ssp585'
  
  input_coeff245 = paste0(input_coeff245,'/coeff.csv')
  input_coeff585 = paste0(input_coeff585,'/coeff.csv')
  
  trend_stand <- function(x){
    x = ts(x,start =c(2003,1),frequency = 12)
    x = decompose(x)$trend
    
    x = x[-which(is.na(x))]
    x = (x-mean(x))/(max(x)-min(x))
    return(x)      
  }
  
  proj245 <- function(){
    tmp = pme3ssp245
    tmp = apply(tmp,2,trend_stand)
    colnames(tmp) = paste0('m',1:8)
    tmp = as.data.frame(tmp)
    coeff = as.data.frame(fread(input_coeff245))
    a = coeff$a
    b1 = coeff$b1
    b2 = coeff$b2
    b3 = coeff$b3
    b4 = coeff$b4
    b5 = coeff$b5
    b6 = coeff$b6
    b7 = coeff$b7
    b8 = coeff$b8
    
    
    projpme = a+ b1*tmp$m1+b2*tmp$m2+
      b3*tmp$m3+b4*tmp$m4+
      b5*tmp$m5+b6*tmp$m6+b7*tmp$m7+b8*tmp$m8
    
    return(projpme)
  }
  proj585 <- function(){
    tmp = pme3ssp585
    tmp = apply(tmp,2,trend_stand)
    colnames(tmp) = paste0('m',1:8)
    tmp = as.data.frame(tmp)
    coeff = as.data.frame(fread(input_coeff585))
    a = coeff$a
    b1 = coeff$b1
    b2 = coeff$b2
    b3 = coeff$b3
    b4 = coeff$b4
    b5 = coeff$b5
    b6 = coeff$b6
    b7 = coeff$b7
    b8 = coeff$b8
    
    
    projpme = a+ b1*tmp$m1+b2*tmp$m2+
      b3*tmp$m3+b4*tmp$m4+
      b5*tmp$m5+b6*tmp$m6+b7*tmp$m7+b8*tmp$m8
    
    return(projpme)
  }
  
  
  proj_pme_245= proj245()
  proj_pme_585 = proj585()
  
  proj_pme_245 = matrix(rep(proj_pme_245,8),ncol = 8,
                        byrow = F)
  proj_pme_585= matrix(rep(proj_pme_585,8),ncol = 8,
                       byrow = F)
  
  colnames(proj_pme_245) = models
  colnames(proj_pme_585) = models
  
  dir.create('analysis_output/cmip6_by_model/pme_proj_trend')
  
  fwrite(proj_pme_245,'analysis_output/cmip6_by_model/pme_proj_trend/region1_ssp245.csv')
  fwrite(proj_pme_585,'analysis_output/cmip6_by_model/pme_proj_trend/region1_ssp585.csv')
  
}
correct_fut_pme_trend1<- function(
  
){
  # import cmip6 pme
  input_pme = 'analysis_output/cmip6_by_model/pme'
  files = list.files(input_pme,
                     full.names = T)
  
  pme3ssp245 = as.data.frame(
    fread(files[1])
  )
  pme3ssp585 = as.data.frame(
    fread(files[2])
  )
  
  i = 1:ncol(pme3ssp245)
  
  models = colnames(pme3ssp245)
  
  input_coeff245 = 'analysis_output/bc_cmip6_fut_reg1/coeff/ssp245'
  input_coeff585 = 'analysis_output/bc_cmip6_fut_reg1/coeff/ssp585'
  
  input_coeff245 = paste0(input_coeff245,'/coeff.csv')
  input_coeff585 = paste0(input_coeff585,'/coeff.csv')
  
  trend_stand <- function(x){
    x = ts(x,start =c(2003,1),frequency = 12)
    x = decompose(x)$trend
    
    x = x[-which(is.na(x))]
    x = (x-mean(x))/(max(x)-min(x))
    return(x)      
  }
  
  proj245 <- function(){
    tmp = pme3ssp245
    tmp = tmp[175:576,]
    tmp = apply(tmp,2,trend_stand)
    tmp = tmp[,c(1,2,3)]
    colnames(tmp) = paste0('m',1:3)
    tmp = as.data.frame(tmp)
    coeff = as.data.frame(fread(input_coeff245))
    a = coeff$a
    b1 = coeff$b1
    b2 = coeff$b2
    b3 = coeff$b3
    
    
    
    projpme = a+ b1*tmp$m1+b2*tmp$m2+
      b3*tmp$m3
    
    return(projpme)
  }
  proj585 <- function(){
    tmp = pme3ssp585
    tmp = tmp[175:576,]
    tmp = apply(tmp,2,trend_stand)
    tmp = tmp[,c(1,3,6)]
    colnames(tmp) = paste0('m',1:3)
    tmp = as.data.frame(tmp)
    coeff = as.data.frame(fread(input_coeff585))
    a = coeff$a
    b1 = coeff$b1
    b2 = coeff$b2
    b3 = coeff$b3
    
    
    
    projpme = a+ b1*tmp$m1+b2*tmp$m2+
      b3*tmp$m3
    
    return(projpme)
  }
  
  
  proj_pme_245= proj245()
  proj_pme_585 = proj585()
  
  proj_pme_245 = matrix(rep(proj_pme_245,8),ncol = 8,
                        byrow = F)
  proj_pme_585= matrix(rep(proj_pme_585,8),ncol = 8,
                       byrow = F)
  
  colnames(proj_pme_245) = models
  colnames(proj_pme_585) = models
  
  dir.create('analysis_output/cmip6_by_model/pme_proj_trend')
  
  fwrite(proj_pme_245,'analysis_output/cmip6_by_model/pme_proj_trend/region1_ssp245.csv')
  fwrite(proj_pme_585,'analysis_output/cmip6_by_model/pme_proj_trend/region1_ssp585.csv')
  
}
correct_fut_pme<- function(
  
){
  # import cmip6 pme
  input_pme = 'analysis_output/cmip6_by_model/pme'
  files = list.files(input_pme,
                     full.names = T)
  
  pme3ssp245 = as.data.frame(
    fread(files[3])
  )
  pme3ssp585 = as.data.frame(
    fread(files[4])
  )
  
  i = 1:ncol(pme3ssp245)
  
  models = colnames(pme3ssp245)
  
  input_coeff245 = 'analysis_output/bc_cmip6/coeff/ssp245'
  input_coeff585 = 'analysis_output/bc_cmip6/coeff/ssp585'
  input_diff245 = 'analysis_output/bc_cmip6/diff/ssp245'
  input_diff585 = 'analysis_output/bc_cmip6/diff/ssp585'
  
  input_coeff245 = paste0(input_coeff245,'/',models,'.csv')
  input_coeff585 = paste0(input_coeff585,'/',models,'.csv')
  input_diff245 = paste0(input_diff245,'/',models,'.csv')
  input_diff585 = paste0(input_diff585,'/',models,'.csv')
  
  proj245 <- function(i){
    tmp = pme3ssp245[,i]
    tmp = as.numeric(tmp)
    
    coeff = as.data.frame(fread(input_coeff245[i]))
    diff = as.data.frame(fread(input_diff245[i]))
    a = coeff$a
    b = coeff$b
    c = coeff$c
    d = coeff$d
    
    projpme = a+ b*tmp+c*I(tmp^2)+d*I(tmp^3)
    repdif = rep(diff$matdiff,48)
    
    projpme = projpme+ repdif
    return(projpme)
  }
  proj585 <- function(i){
    tmp = pme3ssp585[,i]
    tmp = as.numeric(tmp)
    
    coeff = as.data.frame(fread(input_coeff585[i]))
    diff = as.data.frame(fread(input_diff585[i]))
    a = coeff$a
    b = coeff$b
    c = coeff$c
    d = coeff$d
    
    projpme = a+ b*tmp+c*I(tmp^2)+d*I(tmp^3)
    repdif = rep(diff$matdiff,48)
    
    projpme = projpme+ repdif
    return(projpme)
  }
  
  proj_pme_245= do.call(cbind,
                        lapply(i,proj245))
  proj_pme_585 = do.call(cbind,
                         lapply(i,proj585))
  colnames(proj_pme_245) = models
  colnames(proj_pme_585) = models
  
  dir.create('analysis_output/cmip6_by_model/pme_proj')
  
  fwrite(proj_pme_245,'analysis_output/cmip6_by_model/pme_proj/region3_ssp245.csv')
  fwrite(proj_pme_585,'analysis_output/cmip6_by_model/pme_proj/region3_ssp585.csv')
  
}
country_captial_select <- function(
  
){
  freshwater_use = as.data.frame(fread('NC_mod_xinjiang/inter_freshwater/full_df.csv'))
  freshwater_use$country[which(freshwater_use$country == 'Korea, Rep.')] = 'South Korea'
  freshwater_use$country[which(freshwater_use$country == 'Slovak Republic')] = 'Slovakia'
  freshwater_use$country[which(freshwater_use$country == 'Russian Federation')] = 'Russia'
  
  country = freshwater_use$country
  
  country_label <- as.data.frame(
    fread('/media/sdb5/Vapor_projcts/Vapor_tibet/main_plot_data/fig3/country_label.csv')
  )
  country_label = country_label[-which(country_label$name == 'Hong Kong'|
                                         country_label$name == 'Macau'),]
  country_label$latitude[which(country_label$name=='India')]=
    country_label$latitude[which(country_label$name=='India')]+2
  
  i = 1:length(country)
  loc_id_fun <- function(i){
    tmp = country[i]
    tmpid = which(country_label$name == tmp)
    if(length(tmpid)>0){
      return(tmpid)
    }
  }
  inid = do.call('c',lapply(i,loc_id_fun))
  
  country_label = country_label[inid,]
  source("/home/share/R_project/xinjiang_vapor/shp_management.R")
  world = shp_management('world')
  
  
  fontsize = 14
  text_theme= theme(
    axis.text = element_text(size = fontsize,
                             color = 'black'),
    axis.title = element_text(size = fontsize,
                              color = 'black'),
    legend.text =  element_text(size = fontsize,
                                color = 'black'),
    legend.title =  element_text(size = fontsize,
                                 color = 'black')
  )
  world = shp_management('world')
  p = ggplot()+
    geom_polygon(data = world,aes(x = long,
                                  y = lat,
                                  group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'transparent')+
    geom_point(data = country_label,
              aes(x = longitude,
                  y = latitude),
              size = 5,
              color  = 'blue',shape = 1)+
    theme_bw()+
    text_theme+
    theme(panel.grid = element_blank())
    
  
  
  
  
  
  
  
  
  
}
covar_pe_insource_and_pe_in_target<-function(
  pattern  = 'north'
){
  library(data.table)
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  source('/home/share/R_project/xinjiang_vapor/source_id_identify.R')
  
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  
  tas_in_source = import_pe_in_source('era5_tas_mean',
                                      name = 'era5_tas_mean.csv')
  
  #pe_in_source = import_pe_in_source('gpcc_pr_sum',
  #                                   name = 'gpcc_pr_sum.csv')
  #pe_in_source = pe_in_source[1:174,]
  
  eva_in_source = import_pe_in_source('era5_eva_sum',
                                      name = 'era5_eva_sum.csv')
  eva_in_source = eva_in_source[1:174,]
  # as,ato,eu
  colnames(eva_in_source) = paste0('eva',1:12)
  
  tws_in_source = import_pe_in_source('tws_in_source',
                                      name = 'tws_sum.csv')
  colnames(tws_in_source) = paste0('tws',1:12)
  
  
  eva_in_source = eva_in_source *30.5
  pe_in_source = pe_in_source * 30.5
  
  
  pe_minus_eva = pe_in_source - eva_in_source
  pe_minus_eva = pe_in_source - pet_sum
  colnames(pe_minus_eva) = paste0('pme',1:12)
  eva_minus_pe = eva_in_source - pe_in_source
  colnames(eva_minus_pe) = paste0('emp',1:12)
  
  
  # import pe in target
  input_pr_intarget = list.files('era5_pr_in_target',
                                 full.names = T)[c(1,3)]
  input_eva_intarget = list.files('poten_evap_in_target',
                                  full.names =T)[c(1,3)]
  
  if(pattern == 'north'){
    pr_in_target = fread(input_pr_intarget[1])
    eva_in_target = fread(input_eva_intarget[1])
    
    pr_in_target= as.data.frame(pr_in_target)
    eva_in_target = as.data.frame(eva_in_target)
    
    pe_in_target = pr_in_target - eva_in_target
    #pe_in_target = pr_in_target
  }else{
    pr_in_target = fread(input_pr_intarget[2])
    eva_in_target = fread(input_eva_intarget[2])
    
    pr_in_target= as.data.frame(pr_in_target)
    eva_in_target = as.data.frame(eva_in_target)
    
    pe_in_target = pr_in_target - eva_in_target
    #pe_in_target = pr_in_target
  }
  
  source('/home/share/R_project/xinjiang_vapor/spei_fun.R')
  spei_df = apply(pe_minus_eva,2,spei_fun)
  
  output_spei = 'spei3_in_source'
  dir.create(output_spei)
  output_spei = paste0(output_spei,'/',pattern,'.csv')
  print(output_spei)
  fwrite(spei_df,output_spei)
  
  
  
  if(pattern == 'north'){
    id_re = source_id_identify('north')
    eva_in_source = eva_in_source[,-id_re]
    pe_in_source = pe_in_source[,-id_re]
    pe_minus_eva = pe_minus_eva[,-id_re]
    eva_minus_pe = eva_minus_pe[,-id_re]
    tws_in_source = tws_in_source[,-id_re]
    spei_df = spei_df[,-id_re]
  }else{
    id_re = source_id_identify('south')
    eva_in_source = eva_in_source[,-id_re]
    pe_in_source = pe_in_source[,-id_re]
    pe_minus_eva = pe_minus_eva[,-id_re]
    eva_minus_pe = eva_minus_pe[,-id_re]
    tws_in_source = tws_in_source[,-id_re]
    spei_df = spei_df[,-id_re]
  }
  
  
  trend_fun <-function(x){
    
    #xs = (x - mean(x))/(max(x)-min(x))
    
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    
    xt = as.numeric(xt)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }  
  
  pe_t = apply(pe_in_source,2,trend_fun)
  eva_t = apply(eva_in_source,2,trend_fun)
  pme = apply(pe_minus_eva,2,trend_fun)
  emp = apply(eva_minus_pe,2,trend_fun)
  spei_t = apply(spei_df,2,trend_fun)
  tws_source_t = apply(tws_in_source,2,trend_fun)
  
  
  
  #cor_analysis(pe_t,eva_t)
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),
             '1 month')
  date = date[1:174]
  pe_df = data.frame(date,pe_t)
  eva_df = data.frame(date,eva_t)
  pme_df = data.frame(date,pme)
  emp_df = data.frame(date,emp)
  spei_t = data.frame(date,spei_t)
  tws_source_df = data.frame(date,tws_source_t)
  
  
  pe_dfm = reshape2::melt(pe_df,'date')
  eva_dfm = reshape2::melt(eva_df,'date')
  pme_dfm = reshape2::melt(pme_df,'date')
  emp_dfm = reshape2::melt(emp_df,'date')
  spei_dfm = reshape2::melt(spei_t,'date')
  tws_source_dfm = reshape2::melt(tws_source_df,'date')
  
  type = paste0(rep(c('as','ato','eu'),each = 4),
                rep(1:4,3))
  contype = rep(c('as','ato','eu'),each = 4)
  contype = contype[-id_re]
  type = type[-id_re]
  source('/home/share/R_project/xinjiang_vapor/source_id_by_convey_amount.R')
  ranks = source_id_by_convey_amount(pattern)
  print(type[ranks])
  type = rep(type,each = 174)
  contype = rep(contype,each = 174)
  
  pe_dfm$type = type
  eva_dfm$type = type
  pme_dfm$type = type
  emp_dfm$type = type
  tws_source_dfm$type = type
  spei_dfm$type = type
  
  pe_dfm$contype = contype
  eva_dfm$contype = contype
  pme_dfm$contype = contype
  emp_dfm$contype = contype
  tws_source_dfm$contype = contype
  spei_dfm$contype = contype
  
  # import tws
  input_tws = 'tws_in_target/'
  files_jishui = c('north_jishui','south_jishui')
  input_tws = paste0(input_tws,files_jishui,'.csv')
  
  north_tws = as.data.frame(fread(input_tws[1]))
  south_tws = as.data.frame(fread(input_tws[2]))
  
  north_tws = trend_fun(north_tws[,1])
  south_tws = trend_fun(south_tws[,1])
  
  pe_in_target = pe_in_target[1:174,]
  pe_in_target = trend_fun(pe_in_target)
  
  dfpe_in_target = data.frame(date,
                              pe_in_target = pe_in_target)
  
  if(pattern == 'north'){
    dftws = data.frame(date,
                       north_tws = north_tws)
    
    
  }else{
    dftws = data.frame(date,
                       south_tws = south_tws)
  }
  
  
  dftws = reshape2::melt(dftws,'date')
  dfpe_in_target = reshape2::melt(dfpe_in_target,
                                  'date')
  colnames(dftws) = c('date','variable2','value')
  colnames(dfpe_in_target) = c('date','variable2','value')
  
  #mean the index by continent
  mean_fun <- function(x){
    x = mean(x,na.rm = T)
  }
  
  pe_df_as = apply(
    cbind(pme_df$pme2),1,mean_fun
  )
  pe_df_ato = apply(cbind(pme_df$pme5,pme_df$pme6,
                          pme_df$pme7,pme_df$pme8),1,
                    mean_fun)
  
  pe_df_eu = apply(cbind(pme_df$pme10,pme_df$pme9),1,
                    mean_fun)
  
  pe_df_con_mean = data.frame(date,
                              as_mean = pe_df_as,
                              ato_mean = pe_df_ato,
                              eu_mean = pe_df_eu)
  pe_df_conm = reshape2::melt(pe_df_con_mean,
                              'date')
  type_con = rep(c('as','ato','eu'),each = 174)
  pe_df_conm$contype = type_con
  
  naid = which(is.na(dfpe_in_target$value))
  petar = dfpe_in_target$value[-naid]
  pe_df_con_mean = pe_df_con_mean[-naid,]
  date_sub = date[-naid]
  abrupt_id = find_peak_valley_p_trial(petar,0.1)
  
  abrupt_id = abrupt_id+6
  dfab = data.frame(
    date = date[abrupt_id],
    value = dfpe_in_target$value[abrupt_id]
  )
  output = 'covar_analysis_data'
  
  output_prdf_sour = paste0(output,'/pr_in_source.csv')
  
  output_pmedf_sour = paste0(output,'/pme_in_source.csv')
  output_pmedf_targ_north = paste0(output,'/pme_in_target_north.csv')
  output_pmedf_targ_south = paste0(output,'/pme_in_target_south.csv')
  output_tws_targ_north = paste0(output,'/tws_in_target_north.csv')
  output_tws_targ_south = paste0(output,'/tws_in_target_south.csv')
  output_tws_sour = paste0(output,'/tws_in_source.csv')
  dir.create(output)
  print(ncol(pme_df))
  fwrite(pe_df,output_prdf_sour)
  fwrite(pme_df,output_pmedf_sour)
  fwrite(tws_source_df,output_tws_sour)
  if(pattern == 'north'){
    fwrite(dfpe_in_target,output_pmedf_targ_north)
    fwrite(dftws,output_tws_targ_north)
  }else{
    fwrite(dfpe_in_target,output_pmedf_targ_south)
    fwrite(dftws,output_tws_targ_south)
  }
 
  
  library(ggplot2)
  pline = ggplot()+
    #geom_line(data = pe_dfm,aes(x = date,y = value,
    #                            color = variable,
    #                            linetype = variable),
    #          size = 0.5)+
    #geom_line(data = pe_df_conm,
    #          aes(x = date,y = value,
    #              color = variable),size = 0.5)+
    #geom_line(data = eva_dfm,aes(x = date,y = value,
    #                             color = variable))+
    
    geom_line(data = pme_dfm,aes(x = date,y = value,
                                color = variable))+
    #geom_line(data = spei_dfm,aes(x = date,y = value,
    #                             color = variable))+
    #geom_line(data = emp_dfm,aes(x = date,y = value,
    #                             color = variable))+
    geom_line(data = tws_source_dfm,aes(x = date,y = value,
                                        color = variable),
              linetype = 2)+
    #geom_line(data = dftws,aes(x =date,y = value,
    #                           color = variable2),
    #          linetype = 2,size = 2)+
    geom_line(data = dfpe_in_target,aes(
      x  =date,y = value,color = variable2
    ),size = 1.5)+
    #geom_point(data = dfab,
    #           aes(x = date,y = value),
    #           color = 'blue',shape = 1,size= 5)+
    #facet_wrap(~contype,ncol =3,scales = 'free')+
    facet_wrap(~type,ncol =3,scales = 'free')+
    theme_bw()+
    theme(legend.position = 'bottom')
  
  pline
  
    
  
  
  
  
}
covar_pe_insource_and_tws<-function(
  pattern  = 'north'
){
  library(data.table)
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  source('/home/share/R_project/xinjiang_vapor/source_id_identify.R')
  
  pe_in_source = import_pe_in_source('era5_pr_mean',
                                     name = 'era5_pr_mean.csv')
  pe_in_source = pe_in_source[1:174,]
  
  eva_in_source = import_pe_in_source('era5_eva_mean',
                                      name = 'era5_eva_mean.csv')
  eva_in_source = eva_in_source[1:174,]
  # as,ato,eu
  colnames(eva_in_source) = paste0('eva',1:12)
  
  tws_in_source = import_pe_in_source('tws_in_source',
                                      name = 'tws_sum.csv')
  colnames(tws_in_source) = paste0('tws',1:12)
  
  
  eva_in_source = eva_in_source *30.5
  pe_in_source = pe_in_source * 30.5
  
  
  pe_minus_eva = pe_in_source - eva_in_source 
  colnames(pe_minus_eva) = paste0('pme',1:12)
  eva_minus_pe = eva_in_source - pe_in_source
  colnames(eva_minus_pe) = paste0('emp',1:12)
  
  
  spei_df = apply(pe_minus_eva,2,spei_fun)

  output_spei = 'spei3_in_source'
  dir.create(output_spei)
  output_spei = paste0(output_spei,'/',pattern,'.csv')
  print(output_spei)
  fwrite(spei_df,output_spei)
  
  
  
  if(pattern == 'north'){
    id_re = source_id_identify('north')
    eva_in_source = eva_in_source[,-id_re]
    pe_in_source = pe_in_source[,-id_re]
    pe_minus_eva = pe_minus_eva[,-id_re]
    eva_minus_pe = eva_minus_pe[,-id_re]
    tws_in_source = tws_in_source[,-id_re]
    spei_df = spei_df[,-id_re]
  }else{
    id_re = source_id_identify('south')
    eva_in_source = eva_in_source[,-id_re]
    pe_in_source = pe_in_source[,-id_re]
    pe_minus_eva = pe_minus_eva[,-id_re]
    eva_minus_pe = eva_minus_pe[,-id_re]
    tws_in_source = tws_in_source[,-id_re]
    spei_df = spei_df[,-id_re]
  }
  
  
  trend_fun <-function(x){
    
    #xs = (x - mean(x))/(max(x)-min(x))
      
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    
    xt = as.numeric(xt)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }  
  
  pe_t = apply(pe_in_source,2,trend_fun)
  eva_t = apply(eva_in_source,2,trend_fun)
  pme = apply(pe_minus_eva,2,trend_fun)
  emp = apply(eva_minus_pe,2,trend_fun)
  spei_t = apply(spei_df,2,trend_fun)
  tws_source_t = apply(tws_in_source,2,trend_fun)
  
  
  
  cor_analysis(pe_t,eva_t)
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),
             '1 month')
  date = date[1:174]
  pe_df = data.frame(date,pe_t)
  eva_df = data.frame(date,eva_t)
  pme_df = data.frame(date,pme)
  emp_df = data.frame(date,emp)
  spei_t = data.frame(date,spei_t)
  tws_source_df = data.frame(date,tws_source_t)
  
  
  
  
  
  
  pe_dfm = reshape2::melt(pe_df,'date')
  eva_dfm = reshape2::melt(eva_df,'date')
  pme_dfm = reshape2::melt(pme_df,'date')
  emp_dfm = reshape2::melt(emp_df,'date')
  spei_dfm = reshape2::melt(spei_t,'date')
  tws_source_dfm = reshape2::melt(tws_source_df,'date')
  
  type = paste0(rep(c('as','ato','eu'),each = 4),
                rep(1:4,3))
  type = type[-id_re]
  source('/home/share/R_project/xinjiang_vapor/source_id_by_convey_amount.R')
  ranks = source_id_by_convey_amount(pattern)
  print(type[ranks])
  type = rep(type,each = 174)
  
  pe_dfm$type = type
  eva_dfm$type = type
  pme_dfm$type = type
  emp_dfm$type = type
  tws_source_dfm$type = type
  spei_dfm$type = type
  # import tws
  input_tws = 'tws_in_target/'
  files_jishui = c('north_jishui','south_jishui')
  input_tws = paste0(input_tws,files_jishui,'.csv')
  
  north_tws = as.data.frame(fread(input_tws[1]))
  south_tws = as.data.frame(fread(input_tws[2]))
  
  north_tws = trend_fun(north_tws[,1])
  south_tws = trend_fun(south_tws[,1])
  
  
  
  if(pattern == 'north'){
    dftws = data.frame(date,
                       north_tws = north_tws)
        
    
  }else{
    dftws = data.frame(date,
                       south_tws = south_tws)
  }
  
  
  dftws = reshape2::melt(dftws,'date')
  
  colnames(dftws) = c('date','variable2','value')
  
  
  
  
  
  library(ggplot2)
  pline = ggplot()+
    geom_line(data = pe_dfm,aes(x = date,y = value,
                                color = variable))+
    geom_line(data = eva_dfm,aes(x = date,y = value,
                                 color = variable))+
    
    #geom_line(data = pme_dfm,aes(x = date,y = value,
    #                             color = variable))+
    #geom_line(data = spei_dfm,aes(x = date,y = value,
    #                             color = variable))+
    #geom_line(data = emp_dfm,aes(x = date,y = value,
    #                             color = variable))+
    #geom_line(data = tws_source_dfm,aes(x = date,y = value,
    #                                    color = variable),
    #          linetype = 2)+
    #geom_line(data = dftws,aes(x =date,y = value,
    #                           color = variable2))+
    facet_wrap(~type,nrow =3,scales = 'free')+
    theme_bw()+
    theme(legend.position = 'bottom')
  
  pline
  
  
  
  
  
  
}
create_path_ava_cmd<-function(
  input_process= '/media/sdb1/Data2',
  date = '1219'
){
  # generate yeamon and prepare initial parameters
  #########
  path = '/media/sdb5'
  month = 1:12
  year = 2003:2017
  monstr= 1
  for(i in 1:12){
    if(month[i] < 10){
      mon = paste0('0',month[i])
    }else{
      mon = month[i]
    }
    monstr = c(monstr,mon)
  }
  monstr = monstr[-1]
  
  yeamon = paste0(rep(year,each = 12),rep(monstr,length(year)))
  sday = paste0(yeamon,'01')
  eday = paste0(yeamon,'10')
  
  file = paste0('xinjiang',yeamon) # includes options, available and output files
  #########
  # files already processed check
  
  files_check_id <-function(input){
    files = list.files(input)
    month = 1:12
    year = 2003:2017
    monstr= 1
    for(i in 1:12){
      if(month[i] < 10){
        mon = paste0('0',month[i])
      }else{
        mon = month[i]
      }
      monstr = c(monstr,mon)
    }
    monstr = monstr[-1]
    
    yeamon = paste0(rep(year,each = 12),rep(monstr,length(year)))
    
    filesfull = paste0('EI',substr(yeamon,3,6))
    
    idb = 1
    for(i in 1:length(files)){
      tmpid = which(filesfull == files[i])
      idb = c(idb,tmpid)
    }
    idb= idb[-1]
    return(idb)
  }
  
  id = files_check_id(input_process)
  
  # create AVAILABLE file
  datapath = list.files(input_process,full.names = T)
  dataname = list.files(input_process)
  
  fullpath = paste0('/media/sdb5/',file)
  ava_full_path = fullpath
  
  # ava with file
  ava_with_data = ava_full_path[id]
  ava_sday = sday[id]
  ava_eday = eday[id]
  ava_data_path = datapath
  cmd_python_ava = paste0('python2 /usr/local/flexpart_bk1/mkAVAIL_v7.py -s ',ava_sday,' -e ',ava_eday,' -m EI -p ',
                          ava_data_path, ' -a ',ava_with_data)
  
  writeLines(cmd_python_ava,'/media/sdb5/cmd_python_ava_genrate.sh')
  system('/media/sdb5/cmd_python_ava_genrate.sh')
  print("AVAILABLE file has been generated!")
  
  # create all pathnames
  pathnames = readLines('/usr/local/flexpart10/src2/pathnames')
  output_pathnames = '/media/sdb1/pathnames'
  dir.create(output_pathnames)
  
  output_pathnames = paste0(output_pathnames,'/','pathnames',substr(yeamon,3,6)) # all pathnames
  ava_pathnames = output_pathnames[id]
  full_options = paste0('/media/sdb5/',file,'/options/')
  ava_options = full_options[id]
  full_output = paste0('/media/sdb5/',file,'/output/')
  ava_output = full_output[id]
  ava_data_in = paste0(ava_data_path,'/')
  ava_AVA_in = paste0(ava_with_data,'/AVAILABLE')
  
  
  for(i in 1:length(ava_pathnames))
  {
    tmp = pathnames
    tmp[1] = ava_options[i]
    tmp[2] = ava_output[i]
    tmp[3] = ava_data_in[i]
    tmp[4] = ava_AVA_in[i]
    writeLines(tmp,ava_pathnames[i])
    print(ava_pathnames[i])
  }
  print("Pathnames has been generated!")
  
  cmd_date= paste0('cmd',date)
  group_pathnames<-function(pathnames,cmd_date){
    len_path = length(pathnames)
    step = len_path / 12
    groups = round(seq(1,len_path,step))
    groupe = groups - 1
    groupe = groupe[-1]
    groupe = c(groupe,len_path)
    
    command_sh = paste0('/media/sdb1/command_sh/',cmd_date)
    dir.create(command_sh)
    command_sh_name = paste0("command_sh_g",1:12,'.sh')
    command_sh_name = paste0(command_sh,'/',command_sh_name)
    
    output = '/media/sdb1'
    for (i in 1:length(groupe)){
      tmps = groups[i]
      tmpe = groupe[i]
      tmppath = pathnames[tmps:tmpe]
      print(tmppath)
      tmpcmd = paste0('/usr/local/flexpart10/src2/FLEXPART ',tmppath)
      
      writeLines(tmpcmd, command_sh_name[i])
    }
  }
  
  group_pathnames(ava_pathnames,cmd_date)
  # command 12 threads start at 18:35
  # command 12 threads end at 
  # total 15 files
}
crop_and_mask_pme_in_yrb <- function(
  
){
  # 1. setup the shapefile 
  yrb = shp_management(pattern = 'yrb')
  yrb <<- yrb 
  # 2. determine the data path and import data 
  # 2. mask data 
  ep = data_management_yrb('global_era5_poten_evap')
  pr = data_management_yrb('era5_pr_include_ocean')
  ep = as.list(ep)
  pr = as.list(pr)
  
  ep <<- ep
  pr <<- pr
  
  sub_crop_and_mask<-function(x){
    library(raster)
    tmp1 = crop(x,extent(yrb))
    tmp1 = mask(tmp1,yrb)
    return(tmp1)
  }
  
  library(doParallel)
  cl = makeCluster(4)
  clusterExport(cl,c('pr','yrb'))
  ret_pr = parLapply(cl,pr,sub_crop_and_mask)
  stopCluster(cl)
  
  ret_pr = do.call('stack',ret_pr)
  
  gc()
  library(doParallel)
  cl = makeCluster(4)
  clusterExport(cl,c('ep','yrb'))
  ret_ep = parLapply(cl,ep,sub_crop_and_mask)
  stopCluster(cl)
  gc()
  ret_ep = do.call('stack',ret_ep)
  
  output_mask_ep = '/media/sdb5/Vapor_projcts/Vapor_yellow_river/output/mask_ep_nc/mask_ep_nc.nc'
  output_mask_pr = '/media/sdb5/Vapor_projcts/Vapor_yellow_river/output/mask_pr_nc/mask_pr_nc.nc'
  
  writeRaster(ret_ep,output_mask_ep,format = 'CDF',overwrite = T)
  writeRaster(ret_pr,output_mask_pr,format = 'CDF',overwrite = T)
}
crop_and_mask_tws_in_yrb<-function(
  
){
  # 1. setup the shapefile 
  yrb = shp_management(pattern = 'yrb')
  yrb <<- yrb 
  # 2. determine the data path and import data 
  # 2. mask data 
  tws = data_management_yrb('grace')
  tws = as.list(tws)
  
  tws <<- tws
  
  sub_crop_and_mask<-function(x){
    library(raster)
    tmp1 = crop(x,extent(yrb))
    tmp1 = mask(tmp1,yrb)
    return(tmp1)
  }
  
  library(doParallel)
  cl = makeCluster(4)
  clusterExport(cl,c('tws'))
  ret_tws = parLapply(cl,tws,sub_crop_and_mask)
  stopCluster(cl)
  
  ret_tws = do.call('stack',ret_tws)
  
  gc()
  
  output_mask_tws = '/media/sdb5/Vapor_projcts/Vapor_yellow_river/output/mask_tws_nc'
  dir.create(output_mask_tws)
  output_mask_tws = paste0(output_mask_tws,'/mask_tws_nc.nc')
  
  writeRaster(ret_tws,output_mask_tws,format = 'CDF',overwrite = T)
  
}
crop_mask_tws_for_subwindows <- function(
  
){
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  library(raster)
  
  input = 'sub_windows'
  num = 1:19
  input = paste0(input,'/sub_window',num,'.shp')
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  input = input[id_box]
  
  tws = data_management('grace')
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  tws = crop(tws,world)
  tws = mask(tws,world)
  
  output = '/media/sdb5/Data/grace_tws_masked/'
  dir.create(output)
  
  filesname = paste0('SW_TWS',1:10,'.nc')
  output = paste0(output,filesname)
    
  for(i in 1:10){
    tmpshp = shapefile(input[i])
    crs(tmpshp) = crs(world)
    
    tmptws = crop(tws,tmpshp)
    tmptws = mask(tmptws,tmpshp)
    
    writeRaster(tmptws,output[i],format = 'CDF',
                overwrite = T)
    print(i)
  }
}
crop_shp_by_region<-function(
  
){
  
  mode = c('ocean','land','land')
  name = c('ato','as','eu')
  
  region = paste0('cluster_shp/',name[1],'/',name[1],1:4,'.shp')
  r1 = shapefile(region[1])
  r2 = shapefile(region[2])
  r3 = shapefile(region[3])
  r4 = shapefile(region[4])
  
  region = paste0('cluster_shp/',name[2],'/',name[2],1:4,'.shp')
  r5 = shapefile(region[1])
  r6 = shapefile(region[2])
  r7 = shapefile(region[3])
  r8 = shapefile(region[4])
  
  region = paste0('cluster_shp/',name[3],'/',name[3],1:4,'.shp')
  r9 = shapefile(region[1])
  r10 = shapefile(region[2])
  r11 = shapefile(region[3])
  r12 = shapefile(region[4])
  
  p = ggplot()+
    geom_polygon(data = world,aes(x = long,y = lat,group = group),
                 fill = 'grey80',alpha = 0.5,size = 0.5,color = 'black')+
    geom_polygon(data = r9,aes(x = long,y = lat,group = group),
                 fill = 'transparent',alpha = 0.5,size = 0.5,color = 'black')+
    geom_polygon(data = r10,aes(x = long,y = lat,group = group),
                 fill = 'transparent',alpha = 0.5,size = 0.5,color = 'black')+
    geom_polygon(data = r11,aes(x = long,y = lat,group = group),
                 fill = 'transparent',alpha = 0.5,size = 0.5,color = 'black')+
    geom_polygon(data = r12,aes(x = long,y = lat,group = group),
                 fill = 'transparent',alpha = 0.5,size = 0.5,color = 'black')
    
  
  
  for(i in 1:length(mode)){
    tmpshp = shp_management(mode[i],name[i])
    
    
    
    tmpshp1 = crop(tmpshp,r1)
    tmp
    
    
    
    
    
  }
  
  
  
  
  
}
data_management_yrb <-function(
  mode = 'gpcc'
){
  library(raster)
  library(ncdf4)
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  if(mode == 'gpcc'){
    #full date: X2001 - 2019
    
    input1 = '/media/sdb5/Data/gpcc_pr_monthly_025_2001_2010.nc'
    input2 = '/media/sdb5/Data/gpcc_pr_monthly_025_2011_2019.nc'
    data1 = stack(input1)
    data2 = stack(input2)
    
    data = stack(data1,data2)
    loc_200301 = length(2001:2003)*12-11
    loc_201712 = length(2001:2017)*12
    loc_dim = dim(data)[3]
    data = data[[loc_200301:loc_201712]]
    #data = data[[loc_200301:loc_dim]]
    
    xj= shp_management(pattern = 'yrb')
    #xj = shp_management(pattern = 'shamo')
    data = crop(data,xj)
    data = mask(data,xj)
    return(data)
  }else if(mode == 'gpcc_full'){
    #full date: X2001 - 2019
    
    input1 = '/media/sdb5/Data/gpcc_pr_monthly_025_2001_2010.nc'
    input2 = '/media/sdb5/Data/gpcc_pr_monthly_025_2011_2019.nc'
    data1 = stack(input1)
    data2 = stack(input2)
    
    data = stack(data1,data2)
    loc_200301 = length(2001:2003)*12-11
    loc_201712 = length(2001:2017)*12
    loc_dim = dim(data)[3]
    data = data[[loc_200301:loc_201712]]
    
    return(data)
  }else if(mode == 'grace'){
    #input = '/media/sdb5/Data/grace_fill_200204_202007.nc'
    input = '/media/sdb5/Data/grace_fill_200204_201706.nc'
    data = stack(input)
    loc_200301 = length(2002:2003)*12-11-3
    #loc_201712 = length(2002:2017)*12-3
    loc_dim = dim(data)[3]
    data = data[[loc_200301:loc_dim]]
    #data = data[[loc_200301:loc_dim]]
    
    #xj= shp_management(pattern = 'yrb')
    #xj = shp_management(pattern = 'shamo')
    #xj = shp_management(pattern = 'land',names ='as')
    #data = crop(data,xj)
    #data = mask(data,xj)
    
    return(data)
  }else if(mode == 'era5_tevapor'){
    input = '/media/sdb5/Data/era5_evapor'
    input = list.files(input,full.names = T)
    
    era5_tevapor = stack(input,varname = 'e')
    loc_200301 = length(1981:2003)*12-11
    loc_201712 = length(1981:2017)*12
    
    era5_tevapor = era5_tevapor[[loc_200301:loc_201712]]
    #xj= shp_management(pattern = 'yrb')
    xj = shp_management(pattern = 'shamo')
    
    data = crop(era5_tevapor,xj)
    data = mask(data,xj)
    
    return(data)
    
  }else if(mode == 'era5_temper'){
    input = '/media/sdb5/Data/era5_t'
    input = list.files(input,full.names = T)
    input = input[-1]
    
    era5_t = stack(input)
    loc_200301 = length(1981:2003)*12-11
    loc_201712 = length(1981:2017)*12
    
    era5_t = era5_t[[loc_200301:loc_201712]]
    #xj= shp_management(pattern = 'yrb')
    xj = shp_management(pattern = 'shamo')
    data = crop(era5_t,xj)
    data = mask(data,xj)
    
    return(data)
  }else if(mode == 'ndvi'){
    input = '/media/sdb5/Data/Global_NDVI_tif'
    input = list.files(input,full.names = T)
    # start 2000-02 end 2019-08
    ndvi = stack(input)
    
    loc200301 = length(2000:2003)*12-11-1
    loc201712 = length(2000:2017)*12-1
    
    ndvi = ndvi[[loc200301:loc201712]]
    #xj = shp_management(pattern = 'yrb')
    xj = shp_management(pattern = 'yrb')
    data = crop(ndvi,xj)
    data = mask(data,xj)
    return(data)
    
  }else if(mode == 'total_released'){
    input = 'analysis_output/total_released_03_17.csv'
    
    tt_re = read.csv(input,header = T)
    tt_re = tt_re[,-1]
    
    return(tt_re)
  }else if(mode == 'era5_pr_include_ocean'){
    input = '/media/sdb5/Data/era5_evapor_pr_include_ocean'
    input = list.files(input,full.names = T,
                       pattern = '*.nc$')
    var = 'tp'
    input = input[25:39]
    data = stack(input,varname = var)
    data = data *1000*30.5 #m to mm/month
  }
  else if(mode == 'global_era5_temperature'){
    input = '/media/sdb5/Data/era5_temperature_include_ocean'
    input = list.files(input,full.names = T,
                       pattern = '*.nc$')
    var = 't2m'
    input = input[25:39]
    data = stack(input,varname = var)
  }else if(mode == 'global_era5_sst'){
    input = '/media/sdb5/Data/era5_temperature_include_ocean'
    input = list.files(input,full.names = T,
                       pattern = '*.nc$')
    input = input[25:39]
    var = 'sst'
    data = stack(input,varname = var)
  }else if(mode == 'global_era5_poten_evap'){
    input = '/media/sdb5/Data/era5_potential_evap'
    input = list.files(input,full.names = T,
                       pattern = '*.nc$')
    input = input[25:39]
    data = stack(input)
    data = data * -1 * 1000 * 30.5 # to mm/month
  }else if(mode == 'global_cropland'){
    input = '/media/sdb5/Vapor_projcts/Vapor_yellow_river/Data/crop_land_rast/global_crop_land.tif'
    data = raster(input)
    
    shp = shp_management('yrb')
    data = crop(data,shp)
    data = mask(data,shp)
    
  }else if(mode == 'landuse_yrb'){
    input = '/media/sdb5/Vapor_projcts/Vapor_yellow_river/Data/GONG_GLASS_GLC'
    files = list.files(input,pattern = '*.tif$',full.names = T)
    files = stack(files)
  
    shp = shp_management('yrb')
    data = crop(files,shp)
    data = mask(data,shp)
  }else if(mode == 'global_landuse'){
    input = '/media/sdb5/Vapor_projcts/Vapor_yellow_river/Data/GONG_GLASS_GLC'
    files = list.files(input,pattern = '*.tif$',full.names = T)
    files = stack(files)
    return(files)
    #shp = shp_management('yrb')
    #data = crop(files,shp)
    #data = mask(data,shp)
  }else if(mode == 'gpp'){
    input_path = '/media/root/Shen_drive1/gpp_monthly'
    files = list.files(input_path,full.names = T)
    sid200301 = length(2000:2003)*12-11
    eid201512 = length(2000:2015)*12
    files = files[sid200301:eid201512]
    
    data = stack(files)
  }else if(mode == 'global_dem'){
    dem = raster('/media/sdb5/Vapor_projcts/Vapor_yellow_river/Data/dem/elev.0.5-deg.nc')
    
    data = dem
  }
  return(data)
}
data_management <-function(
  mode = 'gpcc'
){
  library(raster)
  library(ncdf4)
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  if(mode == 'gpcc'){
    #full date: X2001 - 2019
    
    input1 = '/media/sdb5/Data/gpcc_pr_monthly_025_2001_2010.nc'
    input2 = '/media/sdb5/Data/gpcc_pr_monthly_025_2011_2019.nc'
    data1 = stack(input1)
    data2 = stack(input2)
    
    data = stack(data1,data2)
    loc_200301 = length(2001:2003)*12-11
    loc_201712 = length(2001:2017)*12
    loc_dim = dim(data)[3]
    data = data[[loc_200301:loc_201712]]
    #data = data[[loc_200301:loc_dim]]
    
    xj= shp_management(pattern = 'xinjiang')
    #xj = shp_management(pattern = 'shamo')
    data = crop(data,xj)
    data = mask(data,xj)
    return(data)
  }else if(mode == 'gpcc_full'){
    #full date: X2001 - 2019
    
    input1 = '/media/sdb5/Data/gpcc_pr_monthly_025_2001_2010.nc'
    input2 = '/media/sdb5/Data/gpcc_pr_monthly_025_2011_2019.nc'
    data1 = stack(input1)
    data2 = stack(input2)
    
    data = stack(data1,data2)
    loc_200301 = length(2001:2003)*12-11
    loc_201712 = length(2001:2017)*12
    loc_dim = dim(data)[3]
    data = data[[loc_200301:loc_201712]]
    
    return(data)
  }else if(mode == 'grace'){
    #input = '/media/sdb5/Data/grace_fill_200204_202007.nc'
    input = '/media/sdb5/Data/grace_fill_200204_201706.nc'
    data = stack(input)
    loc_200301 = length(2002:2003)*12-11-3
    #loc_201712 = length(2002:2017)*12-3
    loc_dim = dim(data)[3]
    data = data[[loc_200301:loc_dim]]
    #data = data[[loc_200301:loc_dim]]
    
    #xj= shp_management(pattern = 'xinjiang')
    #xj = shp_management(pattern = 'shamo')
    #xj = shp_management(pattern = 'land',names ='as')
    #data = crop(data,xj)
    #data = mask(data,xj)
    
    return(data)
  }else if(mode == 'grace_new'){
    input = '/media/sdb5/Data/grace_fill_200204_202007.nc'
    #input = '/media/sdb5/Data/grace_fill_200204_201706.nc'
    data = stack(input)
    loc_200301 = length(2002:2003)*12-11-3
    #loc_201712 = length(2002:2017)*12-3
    loc_dim = dim(data)[3]
    data = data[[loc_200301:loc_dim]]
  }else if(mode == 'era5_tevapor'){
    input = '/media/sdb5/Data/era5_evapor'
    input = list.files(input,full.names = T)
    
    era5_tevapor = stack(input,varname = 'e')
    loc_200301 = length(1981:2003)*12-11
    loc_201712 = length(1981:2017)*12
    
    era5_tevapor = era5_tevapor[[loc_200301:loc_201712]]
    #xj= shp_management(pattern = 'xinjiang')
    xj = shp_management(pattern = 'shamo')
    
    data = crop(era5_tevapor,xj)
    data = mask(data,xj)
    
    return(data)
    
  }else if(mode == 'era5_temper'){
    input = '/media/sdb5/Data/era5_t'
    input = list.files(input,full.names = T)
    input = input[-1]
    
    era5_t = stack(input)
    loc_200301 = length(1981:2003)*12-11
    loc_201712 = length(1981:2017)*12
    
    era5_t = era5_t[[loc_200301:loc_201712]]
    #xj= shp_management(pattern = 'xinjiang')
    xj = shp_management(pattern = 'shamo')
    data = crop(era5_t,xj)
    data = mask(data,xj)
    
    return(data)
  }else if(mode == 'ndvi'){
    input = '/media/sdb5/Data/Global_NDVI_tif'
    input = list.files(input,full.names = T)
    # start 2000-02 end 2019-08
    ndvi = stack(input)
    
    loc200301 = length(2000:2003)*12-11-1
    loc201712 = length(2000:2017)*12-1
    
    ndvi = ndvi[[loc200301:loc201712]]
    #xj = shp_management(pattern = 'xinjiang')
    xj = shp_management(pattern = 'shamo')
    data = crop(ndvi,xj)
    data = mask(data,xj)
    return(data)
    
  }else if(mode == 'total_released'){
    input = 'analysis_output/total_released_03_17.csv'
    
    tt_re = read.csv(input,header = T)
    tt_re = tt_re[,-1]
    
    return(tt_re)
  }else if(mode == 'era5_pr_include_ocean'){
    input = '/media/sdb5/Data/era5_evapor_pr_include_ocean'
    input = list.files(input,full.names = T,
                       pattern = '*.nc$')
    var = 'tp'
    input = input[25:39]
    data = stack(input,varname = var)
    data = data *1000*30.5 #m to mm
  }else if(mode == 'era5_e_include_ocean'){
    input = '/media/sdb5/Data/era5_evapor_pr_include_ocean'
    input = list.files(input,full.names = T,
                       pattern = '*.nc$')
    var = 'e'
    input = input[25:39]
    data = stack(input,varname = var)
    data = data *1000*30.5 *-1 #m to mm
  }else if(mode == 'global_era5_temperature'){
    input = '/media/sdb5/Data/era5_temperature_include_ocean'
    input = list.files(input,full.names = T,
                       pattern = '*.nc$')
    var = 't2m'
    input = input[25:39]
    data = stack(input,varname = var)
  }else if(mode == 'global_era5_sst'){
    input = '/media/sdb5/Data/era5_temperature_include_ocean'
    input = list.files(input,full.names = T,
                       pattern = '*.nc$')
    input = input[25:39]
    var = 'sst'
    data = stack(input,varname = var)
  }else if(mode == 'global_era5_poten_evap'){
    input = '/media/sdb5/Data/era5_potential_evap'
    input = list.files(input,full.names = T,
                       pattern = '*.nc$')
    input = input[25:39]
    data = stack(input)
    data = data * -1 * 1000 * 30.5
  }else if(mode == 'crop_production_raster_yrb'){
    input = '/media/sdb5/Vapor_projcts/Vapor_yellow_river/Data/crop_production_yrb/crop_production_yrb.nc'
    data = stack(input) # time length 2003-2015
    
  }else if(mode =='tws_inyrbcroplands'){
    input = '/media/sdb5/Vapor_projcts/Vapor_yellow_river/Data/tws_in_yrbcroplands/tws_inyrbcroplands.nc'
    data = stack(input)
  }else if(mode == 'gldas_snow'){
    input = '/media/sdb5/Vapor_projcts/Vapor_tibet/Data/gldas'
    input = list.files(input,full.names = T)
    
    input = input[10:183]
    var = 'SnowDepth_inst'
    
    data = stack(input,varname = var)
    
  }else if(mode =='snow_cover'){
    input = 'Data/snow_cover_tif'
    files = list.files(input,full.names = T)
    data = stack(files)
    data = as.list(data)
    data1 = data[1:11]
    data2 = data[12:179]
    
    data_inter = (data1[[11]]+data2[[1]])/2
    
    data = c(data1,list(data_inter),data2)
    data = stack(data)
    return(data)
  }
  return(data)
}
    
declare_glob_var_fun_cloud<-function(
  input_sub
){
  
  df = fread(paste0(input_sub,'/var_whole_route_mid.csv'))
  df_cal_dep <<- df
  
}
declare_glob_var_fun<-function(
  input_sub
){
  source('/home/share/R_project/xinjiang_vapor/source_fun.R')
  source_fun()
  
  df = fread(paste0(input_sub,'/var_whole_route_mid.csv'))
  df_cal_dep <<- df
  
}
divide_full_as_each_type_cloud <- function(x)
{
  xs = x[1]
  xe = x[length(x)]
  
  
  xsl = which(xfull == xs)[1]
  xel = which(xfull == xe)
  xel = xel[length(xel)]
  #print(xfull)
  #print(xel)
  xes <<- xfull[xsl:xel]
  select_first_loc<-function(id){
    tmpmark = which(xes == id)
    return(tmpmark)
  }
  
  ret_box = lapply(x,select_first_loc)
  ret_box = do.call('c',ret_box)
  ret_box = ret_box+(xsl-1)
  #print(length(unique(ret_box)))
  return(ret_box)
  
}
divide_full_as_each_type <- function(x)
{
  xs = x[1]
  xe = x[length(x)]
  
  
  xsl = which(xfull == xs)[1]
  xel = which(xfull == xe)
  xel = xel[length(xel)]
  #print(xfull)
  #print(xel)
  xes <<- xfull[xsl:xel]
  select_first_loc<-function(id){
    tmpmark = which(xes == id)
    return(tmpmark)
  }
  
  ret_box = lapply(x,select_first_loc)
  ret_box = do.call('c',ret_box)
  ret_box = ret_box+(xsl-1)
  #print(length(unique(ret_box)))
  return(ret_box)
  
}
draw_cmip6_pmeato1 <- function(
  pme1ssp245,
  pme1era5,
  corpme1
){
  date = seq(as.Date('2003-01-01'),
             as.Date('2014-12-01'),
             '1 month')
  date = date[-c(1:6,139:144)]
  
  dfpme1cmip6 = data.frame(
    date = date,
    dateid = 1:132,
    pme1ssp245
  )
  dfpme1cmip6 = reshape2::melt(dfpme1cmip6,
                               c( 'date','dateid'))
  dfpme1cmip6$type = 'CMIP6_PME'
  
  dfpme1 = data.frame(
    date = date,
    dateid = 1:132,
    pme1era5
  )
  
  dfpme1= reshape2::melt(dfpme1,c('date','dateid'))
  dfpme1$type  = 'ERA5_PME'
  colnames(dfpme1)[3] = 'variable2'
  library(ggsci)
  col = pal_lancet(alpha = 0.8)(9)[c(1,7)]
  
  fontsize = 14
  text_theme = theme(
    legend.text = element_text(size = fontsize,
                               color = 'black'),
    axis.text = element_text(size = fontsize,
                             color = 'black'),
    axis.title = element_text(size = fontsize,
                              color = 'black'),
    legend.title = element_text(size = fontsize,
                                color = 'black'),
    strip.text  = element_text(size = fontsize,
                                color = 'black') 
    
  )
  library(scales)
  dfcor = data.frame(
    x = 51+30,
    y = 0.7,
    cor = round(corpme1$cors,2),
    p = scientific(corpme1$sig,digits = 2),
    variable= unique(dfpme1cmip6$variable)
  )
  
  dflabel = data.frame(
    x = 10,
    y = 0.7,
    label = paste0('(',letters[1:8],')'),
    variable= unique(dfpme1cmip6$variable)
  )
  
  dfcor$label = paste0(
    'cor: ',dfcor$cor,'(',dfcor$p,"<0.05",')'
  )
  
  dfcor$label[c(5,7)] = 
    paste0(
      'cor: ',dfcor$cor[c(5,7)],'(',dfcor$p[c(5,7)],">0.05",')'
    )
  
  
  
  pline1 = ggplot()+
    geom_line(data = dfpme1,
              aes(x =dateid,y = value,
                  color = type),
              size = 1.3)+
    geom_line(data = dfpme1cmip6,
              aes(x = dateid,y = value,
                  color = type),
              size = 1.3)+
    geom_text(data = dfcor,
              aes(x = x,y = y,label = label),
              size = 4,hjust = 0.5)+
    geom_text(data = dflabel,
              aes(x = x,y = y,label = label),
              size = 4,hjust = 0.5)+
    facet_wrap(~variable,nrow = 2)+
    scale_color_manual(values = col)+
    scale_x_continuous(breaks = seq(1,132,50),
                       labels = 
                         substr(as.character(
                           date[seq(1,132,50)]
                         ),1,4))+
    theme_bw()+
    text_theme+
    theme(panel.grid = element_blank(),
          legend.position = 'bottom')+
    guides(color = guide_legend(title = ''))+
    xlab('Time')+
    ylab("Indices")
  
  return(pline1)
}
draw_cmip6_pmeato3 <- function(
  pme1ssp245,
  pme1era5,
  corpme1
){
  date = seq(as.Date('2003-01-01'),
             as.Date('2014-12-01'),
             '1 month')
  date = date[-c(1:6,139:144)]
  
  dfpme1cmip6 = data.frame(
    date = date,
    dateid = 1:132,
    pme1ssp245
  )
  dfpme1cmip6 = reshape2::melt(dfpme1cmip6,
                               c( 'date','dateid'))
  dfpme1cmip6$type = 'CMIP6_PME'
  
  dfpme1 = data.frame(
    date = date,
    dateid = 1:132,
    pme1era5
  )
  
  dfpme1= reshape2::melt(dfpme1,c('date','dateid'))
  dfpme1$type  = 'ERA5_PME'
  colnames(dfpme1)[3] = 'variable2'
  library(ggsci)
  col = pal_lancet(alpha = 0.8)(9)[c(1,7)]
  
  fontsize = 14
  text_theme = theme(
    legend.text = element_text(size = fontsize,
                               color = 'black'),
    axis.text = element_text(size = fontsize,
                             color = 'black'),
    axis.title = element_text(size = fontsize,
                              color = 'black'),
    legend.title = element_text(size = fontsize,
                                color = 'black'),
    strip.text  = element_text(size = fontsize,
                               color = 'black') 
    
  )
  library(scales)
  dfcor = data.frame(
    x = 51+30,
    y = 0.7,
    cor = round(corpme1$cors,2),
    p = scientific(corpme1$sig,digits = 2),
    variable= unique(dfpme1cmip6$variable)
  )
  
  dflabel = data.frame(
    x = 10,
    y = 0.7,
    label = paste0('(',letters[1:8],')'),
    variable= unique(dfpme1cmip6$variable)
  )
  
  dfcor$label = paste0(
    'cor: ',dfcor$cor,'(',dfcor$p,">0.05",')'
  )
  
  
  
  pline1 = ggplot()+
    geom_line(data = dfpme1,
              aes(x =dateid,y = value,
                  color = type),
              size = 1.3)+
    geom_line(data = dfpme1cmip6,
              aes(x = dateid,y = value,
                  color = type),
              size = 1.3)+
    geom_text(data = dfcor,
              aes(x = x,y = y,label = label),
              size = 4,hjust = 0.5)+
    geom_text(data = dflabel,
              aes(x = x,y = y,label = label),
              size = 4,hjust = 0.5)+
    facet_wrap(~variable,nrow = 2)+
    scale_color_manual(values = col)+
    scale_x_continuous(breaks = seq(1,132,50),
                       labels = 
                         substr(as.character(
                           date[seq(1,132,50)]
                         ),1,4))+
    theme_bw()+
    text_theme+
    theme(panel.grid = element_blank(),
          legend.position = 'bottom')+
    guides(color = guide_legend(title = ''))+
    xlab('Time')+
    ylab("Indices")
  
  return(pline1)
}
draw_compare_pme_proj <- function(
  
){
  # import pme before 
  source('/home/share/R_project/xinjiang_vapor/import_pme_ato_fig4.R')
  pmedf = import_pme_ato_fig4(T)
  source("/home/share/R_project/xinjiang_vapor/import_pme_ato_correct.R")
  bcpmedf = import_pme_ato_correct(T)
  
  pmedf$col = 'Proj_PME'
  bcpmedf$col = 'BC_Proj_PME'
  
  idSSP2451 = which(pmedf$type %in% 
                     c("SSP245_PME1"))
  idSSP5851 = which(pmedf$type %in% 
                     c("SSP585_PME1"))
  idSSP2452 = which(pmedf$type %in% 
                      c("SSP245_PME3"))
  idSSP5852 = which(pmedf$type %in% 
                      c("SSP585_PME3"))
  
  pmedf$variable = '(a) PME in NATO1 under SSP245'
  pmedf$variable[idSSP5851] = '(b) PME in NATO1 under SSP585'
  pmedf$variable[idSSP2452] = '(c) PME in NATO3 under SSP245'
  pmedf$variable[idSSP5852] = '(d) PME in NATO3 under SSP585'
  
  bcpmedf$variable = '(a) PME in NATO1 under SSP245'
  bcpmedf$variable[idSSP5851] = '(b) PME in NATO1 under SSP585'
  bcpmedf$variable[idSSP2452] = '(c) PME in NATO3 under SSP245'
  bcpmedf$variable[idSSP5852] = '(d) PME in NATO3 under SSP585'
  
  col = pal_lancet()(9)[c(1,7)]
  lins = c('solid','dashed')
  
  dfline = rbind(pmedf,bcpmedf)
  years = 2018:2050
  
  segdfh = data.frame(
    x = years[c(1,14)],
    xend = years[c(14,33)],
    y = 3+1.4
  )
  segdfv = data.frame(
    x =years[c(1,14,33)],
    y = c(2.8+1.4),
    yend = 3.2+1.4
  )
  
  retvar1 = calc_pme_var_fun(pmedf)
  retvar2 = calc_pme_var_fun(bcpmedf)
  
  retvar1_245 = retvar1[[1]]
  retvar1_585 = retvar1[[2]]
  retvar2_245 = retvar2[[1]]
  retvar2_585 = retvar2[[2]]
  
  retvar1_245$y = 3.3+1.4
  retvar1_585$y = 3.3+1.4
  retvar2_245$y = 2.7+1.4
  retvar2_585$y = 2.7+1.4
  
  retvar1_245$col = 'Proj_PME'
  retvar1_585$col = 'Proj_PME'
  retvar2_245$col = 'BC_Proj_PME'
  retvar2_585$col = 'BC_Proj_PME'
  
  
  retvar1_245$variable = c(
    '(a) PME in NATO1 under SSP245',
    '(c) PME in NATO3 under SSP245',
    '(a) PME in NATO1 under SSP245',
    '(c) PME in NATO3 under SSP245'
  )
  retvar1_585$variable = c(
    '(b) PME in NATO1 under SSP585',
    '(d) PME in NATO3 under SSP585',
    '(b) PME in NATO1 under SSP585',
    '(d) PME in NATO3 under SSP585'
  )
  
  retvar2_245$variable = c(
    '(a) PME in NATO1 under SSP245',
    '(c) PME in NATO3 under SSP245',
    '(a) PME in NATO1 under SSP245',
    '(c) PME in NATO3 under SSP245'
  )
  retvar2_585$variable = c(
    '(b) PME in NATO1 under SSP585',
    '(d) PME in NATO3 under SSP585',
    '(b) PME in NATO1 under SSP585',
    '(d) PME in NATO3 under SSP585'
  )
  
  retvardf= rbind(retvar1_245,
                  retvar1_585,
                  retvar2_245,
                  retvar2_585)
  pline = ggplot()+
    geom_vline(xintercept = years[c(1,14,33)],
               linetype = 'dashed',
               color = 'black',
               size = 0.5)+
    geom_line(data = dfline,
              aes(x = date,
                  y = value,
                  color = col,
                  linetype = col),
              size = 1.3)+
    geom_segment(data = segdfh,
                 aes(x = x,xend = xend,
                     y = y,yend = y),
                 size = 0.5,
                 color = 'black',
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'))+
    geom_segment(data = segdfh,
                 aes(x = xend,xend = x,
                     y = y,yend = y),
                 size = 0.5,
                 color = 'black',
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'))+
    geom_segment(data = segdfv,
                 aes(x = x,xend = x,
                     y = y,yend = yend),
                 size = 0.5,
                 color = 'black')+
    geom_text(data = retvardf,
              aes(x = years[x],
                  y = y,
                  label = label,
                  color = col),
              size = 4,show.legend = F)+
    facet_wrap(~variable,nrow = 2)+
    theme_bw()+
    scale_color_manual(values = col)+
    scale_linetype_manual(values = lins)+
    scale_x_continuous(breaks = c(2018,2031,2050))+
    text_theme+
    guides(color = guide_legend(title = ''),
           linetype = guide_legend(title = ''))+
    theme(panel.grid = element_blank(),
          legend.position = 'bottom')+
    xlab('Time')+
    ylab('Indices')
    
  return(pline)
  
  
  
  
  
  
}
draw_compare_tws_proj<-function(
  
){
  input_twsproj245 = 'NC_mod_xinjiang/main_plot/fig_evaluate_pmecmip6/mean_tws245_trend_cali.csv'
  input_twsproj585 = 'NC_mod_xinjiang/main_plot/fig_evaluate_pmecmip6/mean_tws585_trend_cali.csv'
  input_tws245 = 'NC_mod_xinjiang/main_plot/fig_evaluate_pmecmip6/mean_tws245.csv'
  input_tws585 = 'NC_mod_xinjiang/main_plot/fig_evaluate_pmecmip6/mean_tws585.csv'
  
  twsproj245 = as.data.frame(fread(input_twsproj245))
  twsproj585 = as.data.frame(fread(input_twsproj585))
  tws245 = as.data.frame(fread(input_tws245))
  tws585 = as.data.frame(fread(input_tws585))
  
  
  source('/home/share/R_project/xinjiang_vapor/cal_increasing_rate.R')
  cr_tws245 = cal_increasing_rate_whole(tws245,'TWS_245')
  cr_tws585 = cal_increasing_rate_whole(tws585,'TWS_585')

  cr_pj245 = cal_increasing_rate_whole(twsproj245,'TWS_245')
  cr_pj585 = cal_increasing_rate_whole(twsproj585,'TWS_585')
  
  cr_tws245$y = 2.5+0.1
  cr_tws585$y = 2.5+0.1
  cr_pj245$y = 2.1+0.1
  cr_pj585$y = 2.1+0.1
  
  
  twsproj245$variable= 'Proj_SSP245_TWS'
  twsproj585$variable = 'Proj_SSP585_TWS'
  
  twsproj245$col = 'BC_Proj_TWS'
  twsproj585$col = 'BC_Proj_TWS'
  tws245$col = 'Proj_TWS'
  tws585$col = 'Proj_TWS'
  
  tws245_com = rbind(tws245,
                     twsproj245)
  tws585_com = rbind(tws585,
                     twsproj585)
  
  tws245_com$type = '(a) Mean-TWS-among-SWs under SSP245'
  
  tws585_com$type = '(b) Mean-TWS-among-SWs under SSP585'
  
  cr_tws245$type ='(a) Mean-TWS-among-SWs under SSP245'
  cr_tws585$type = '(b) Mean-TWS-among-SWs under SSP585'
  cr_pj245$type = '(a) Mean-TWS-among-SWs under SSP245'
  cr_pj585$type = '(b) Mean-TWS-among-SWs under SSP585'
  
  
  dftws = rbind(tws245_com,
                tws585_com)
  
  col = pal_lancet(alpha = 1)(9)[c(1,7)]
  lin = c('solid','dashed')
  fontsize = 14
  text_theme = theme(
    legend.text = element_text(size = fontsize,
                               color = 'black'),
    axis.text = element_text(size = fontsize,
                             color = 'black'),
    axis.title = element_text(size = fontsize,
                              color = 'black'),
    legend.title = element_text(size = fontsize,
                                color = 'black'),
    strip.text  = element_text(size = fontsize,
                               color = 'black') 
    
  )
  years = 2018:2050
  
  segdfh = data.frame(
    x = years[c(1,14)],
    xend = years[c(14,33)],
    y = 2.3+0.1
  )
  segdfv = data.frame(
    x = years[c(1,14,33)],
    y = 2.2+0.1,
    yend = 2.4+0.1
  )
  
  cr_tws245$col = 'Proj_TWS'
  cr_tws585$col = 'Proj_TWS'
  cr_pj245$col = 'BC_Proj_TWS'
  cr_pj585$col = 'BC_Proj_TWS'
  
  crdf = rbind(
    cr_tws245,cr_tws585,
    cr_pj245,cr_pj585
  )
  pline = ggplot()+
    geom_vline(xintercept = c(years[c(1,14,33)]),
               color = 'black',
               size = 0.5,
               linetype ='dashed')+
    geom_line(data = dftws,
              aes(x = date,y = value,
                  color = col,
                  linetype = col),
              size = 1.3)+
    geom_text(data = crdf,
              aes(x = years[x],y = y,
                  label = label,color = col),
              size = 5,show.legend = F)+
    scale_color_manual(values = col)+
    scale_linetype_manual(values = lin)+
    geom_segment(data = segdfh,
                 aes(x = x,xend = xend,
                     y = y,yend = y),
                 size = 0.5,
                 color = 'black',
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'))+
    geom_segment(data = segdfh,
                 aes(x = xend,xend = x,
                     y = y,yend = y),
                 size = 0.5,
                 color = 'black',
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'))+
    geom_segment(data = segdfv,
                 aes(x = x,xend = x,
                     y = y,yend = yend),
                 size = 0.5,
                 color = 'black')+
    
    theme_bw()+
    scale_x_continuous(breaks = c(2018,2031,2050))+
    facet_wrap(~type,nrow = 1)+
    text_theme+
    guides(color = guide_legend(title = ''),
           linetype = guide_legend(title = ''))+
    theme(panel.grid = element_blank(),
          legend.position = 'bottom')+
    xlab('Time')+
    ylab('Indices')
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
}
draw_multi_model_simu<- function(
  
){
  date = seq(
    as.Date('2003-01-01'),
    as.Date('2017-12-01'),
    '1 month'
  )
  date = date[-c(1:6,175:180)]
  
  input_train245 = 'analysis_output/bc_cmip6_fut/train/ssp245/train.csv'
  input_test245 = 'analysis_output/bc_cmip6_fut/test/ssp245/test.csv'
  input_full245 = 'analysis_output/bc_cmip6_fut/fullinorder/ssp245/full.csv' 
  
  train245 = as.data.frame(fread(input_train245))
  test245 = as.data.frame(fread(input_test245))
  full245 = as.data.frame(fread(input_full245))
  
  cor1 = cor(train245[,1],train245[,2])
  sig1 = cor.test(train245[,1],train245[,2])$p.value
  
  cor2 = cor(test245[,1],test245[,2])
  sig2 = cor.test(test245[,1],test245[,2])$p.value 
  
  cor3 = cor(full245[,1],full245[,2])
  sig3 = cor.test(full245[,1],full245[,2])$p.value
  
  sig1 = scientific(sig1,2)
  sig2 = scientific(sig2,2)
  sig3 = scientific(sig3,2)
  
  cordf = data.frame(
    cor = c(cor1,cor2,cor3),
    sig = c(sig1,sig2,sig3)
  )
  cordf$cor= round(cordf$cor,2)
  
  colnames(train245) = c("ERA5_PME",
                         'Linear_projected_PME')
  colnames(test245) =  c("ERA5_PME",
                         'Linear_projected_PME')
  colnames(full245) =  c("ERA5_PME",
                         'Linear_projected_PME')
  
  df1 = data.frame(
    dateid = 1:135,
    train245
  )
  df2 = data.frame(
    dateid = 136:168,
    test245
  )
  df3 = data.frame(
    dateid = 1:168,
    full245
  )
  
  df1 = reshape2::melt(df1,c('dateid'))
  df2 = reshape2::melt(df2,c('dateid'))
  df3 = reshape2::melt(df3,c('dateid'))
  df1$type = '(a) 80% randomly sampled train (Hist-SSP245)'
  df2$type = '(c) 20% randomly sampled test (Hist-SSP245)'
  df3$type = '(e) Sequential projected (Hist-SSP245)'
  
  
  df245 = rbind(df1,df2,df3)
  cor245 = cordf
  cor245$type = unique(df245$type)
  cor245$x =   c(85,156,100)
  cor245$y = c(0.55)
  
  cor245$label = paste0(
    'cor: ',cor245$cor,'(',cor245$sig,')')
  
  input_train585 = 'analysis_output/bc_cmip6_fut/train/ssp585/train.csv'
  input_test585 = 'analysis_output/bc_cmip6_fut/test/ssp585/test.csv'
  input_full585 = 'analysis_output/bc_cmip6_fut/fullinorder/ssp585/full.csv' 
  
  train585 = as.data.frame(fread(input_train585))
  test585 = as.data.frame(fread(input_test585))
  full585 = as.data.frame(fread(input_full585))
  
  cor1 = cor(train585[,1],train585[,2])
  sig1 = cor.test(train585[,1],train585[,2])$p.value
  
  cor2 = cor(test585[,1],test585[,2])
  sig2 = cor.test(test585[,1],test585[,2])$p.value 
  
  cor3 = cor(full585[,1],full585[,2])
  sig3 = cor.test(full585[,1],full585[,2])$p.value
  
  sig1 = scientific(sig1,2)
  sig2 = scientific(sig2,2)
  sig3 = scientific(sig3,2)
  
  cordf = data.frame(
    cor = c(cor1,cor2,cor3),
    sig = c(sig1,sig2,sig3)
  )
  cordf$cor= round(cordf$cor,2)
  
  colnames(train585) = c("ERA5_PME",
                         'Linear_projected_PME')
  colnames(test585) =  c("ERA5_PME",
                         'Linear_projected_PME')
  colnames(full585) =  c("ERA5_PME",
                         'Linear_projected_PME')
  
  df1 = data.frame(
    dateid = 1:135,
    train585
  )
  df2 = data.frame(
    dateid = 136:168,
    test585
  )
  df3 = data.frame(
    dateid = 1:168,
    full585
  )
  
  df1 = reshape2::melt(df1,c('dateid'))
  df2 = reshape2::melt(df2,c('dateid'))
  df3 = reshape2::melt(df3,c('dateid'))
  df1$type = '(b) 80% randomly sampled train (Hist-SSP585)'
  df2$type = '(d) 20% randomly sampled test (Hist-SSP585)'
  df3$type = '(f) Sequential projected (Hist-SSP585)'
  
  df585 = rbind(df1,df2,df3)
  cor585 = cordf
  cor585$type = unique(df585$type)
  cor585$x = c(85,156,100)
  cor585$y = c(0.55)
  
  cor585$label = paste0(
    'cor: ',cor585$cor,'(',cor585$sig,')')
  
  dfline = rbind(df245,df585)
  library(ggsci)
  col = pal_lancet()(9)[c(1,7)]
  fontsize = 14
  text_theme = theme(
    legend.text = element_text(size = fontsize,
                               color = 'black'),
    axis.text = element_text(size = fontsize,
                             color = 'black'),
    axis.title = element_text(size = fontsize,
                              color = 'black'),
    legend.title = element_text(size = fontsize,
                                color = 'black'),
    strip.text  = element_text(size = fontsize,
                               color = 'black') 
    
  )
  
  dftext = rbind(cor245,cor585)
  
  
  pline = ggplot()+
    geom_line(data = dfline,
              aes( x= dateid,
                   y = value,
                   color = variable),
              size = 1.3)+
    geom_text(data = dftext,
              aes(x = x,y = y,label = label),
              size = 5,hjust = 0)+
    facet_wrap(~type,nrow = 3,
               scale = 'free')+
    theme_bw()+
    theme(panel.grid = element_blank(),
          legend.position = 'bottom')+
    #scale_x_continuous(breaks = seq(1,168,50))+
    scale_color_manual(values = col)+
    guides(color = guide_legend(title = ''))+
    text_theme+
    xlab('Training/testing sequence')+
    ylab('Indices')
    
  
  
  
  
  
}
draw_multi_model_simu1<- function(
  
){
  date = seq(
    as.Date('2003-01-01'),
    as.Date('2017-12-01'),
    '1 month'
  )
  date = date[-c(1:6,175:180)]
  
  input_train245 = 'analysis_output/bc_cmip6_fut_reg1/train/ssp245/train.csv'
  input_test245 = 'analysis_output/bc_cmip6_fut_reg1/test/ssp245/test.csv'
  input_full245 = 'analysis_output/bc_cmip6_fut_reg1/fullinorder/ssp245/full.csv' 
  
  train245 = as.data.frame(fread(input_train245))
  test245 = as.data.frame(fread(input_test245))
  full245 = as.data.frame(fread(input_full245))
  
  cor1 = cor(train245[,1],train245[,2])
  sig1 = cor.test(train245[,1],train245[,2])$p.value
  
  cor2 = cor(test245[,1],test245[,2])
  sig2 = cor.test(test245[,1],test245[,2])$p.value 
  
  cor3 = cor(full245[,1],full245[,2])
  sig3 = cor.test(full245[,1],full245[,2])$p.value
  
  sig1 = scientific(sig1,2)
  sig2 = scientific(sig2,2)
  sig3 = scientific(sig3,2)
  
  cordf = data.frame(
    cor = c(cor1,cor2,cor3),
    sig = c(sig1,sig2,sig3)
  )
  cordf$cor= round(cordf$cor,2)
  
  colnames(train245) = c("ERA5_PME",
                         'Linear_projected_PME')
  colnames(test245) =  c("ERA5_PME",
                         'Linear_projected_PME')
  colnames(full245) =  c("ERA5_PME",
                         'Linear_projected_PME')
  
  df1 = data.frame(
    dateid = 1:135,
    train245
  )
  df2 = data.frame(
    dateid = 136:168,
    test245
  )
  df3 = data.frame(
    dateid = 1:168,
    full245
  )
  
  df1 = reshape2::melt(df1,c('dateid'))
  df2 = reshape2::melt(df2,c('dateid'))
  df3 = reshape2::melt(df3,c('dateid'))
  df1$type = '(a) 80% randomly sampled train (Hist-SSP245)'
  df2$type = '(c) 20% randomly sampled test (Hist-SSP245)'
  df3$type = '(e) Sequential projected (Hist-SSP245)'
  
  
  df245 = rbind(df1,df2,df3)
  cor245 = cordf
  cor245$type = unique(df245$type)
  cor245$x =   c(85,156,100)
  cor245$y = c(0.55)
  
  cor245$label = paste0(
    'cor: ',cor245$cor,'(',cor245$sig,')')
  
  input_train585 = 'analysis_output/bc_cmip6_fut_reg1/train/ssp585/train.csv'
  input_test585 = 'analysis_output/bc_cmip6_fut_reg1/test/ssp585/test.csv'
  input_full585 = 'analysis_output/bc_cmip6_fut_reg1/fullinorder/ssp585/full.csv' 
  
  train585 = as.data.frame(fread(input_train585))
  test585 = as.data.frame(fread(input_test585))
  full585 = as.data.frame(fread(input_full585))
  
  cor1 = cor(train585[,1],train585[,2])
  sig1 = cor.test(train585[,1],train585[,2])$p.value
  
  cor2 = cor(test585[,1],test585[,2])
  sig2 = cor.test(test585[,1],test585[,2])$p.value 
  
  cor3 = cor(full585[,1],full585[,2])
  sig3 = cor.test(full585[,1],full585[,2])$p.value
  
  sig1 = scientific(sig1,2)
  sig2 = scientific(sig2,2)
  sig3 = scientific(sig3,2)
  
  cordf = data.frame(
    cor = c(cor1,cor2,cor3),
    sig = c(sig1,sig2,sig3)
  )
  cordf$cor= round(cordf$cor,2)
  
  colnames(train585) = c("ERA5_PME",
                         'Linear_projected_PME')
  colnames(test585) =  c("ERA5_PME",
                         'Linear_projected_PME')
  colnames(full585) =  c("ERA5_PME",
                         'Linear_projected_PME')
  
  df1 = data.frame(
    dateid = 1:135,
    train585
  )
  df2 = data.frame(
    dateid = 136:168,
    test585
  )
  df3 = data.frame(
    dateid = 1:168,
    full585
  )
  
  df1 = reshape2::melt(df1,c('dateid'))
  df2 = reshape2::melt(df2,c('dateid'))
  df3 = reshape2::melt(df3,c('dateid'))
  df1$type = '(b) 80% randomly sampled train (Hist-SSP585)'
  df2$type = '(d) 20% randomly sampled test (Hist-SSP585)'
  df3$type = '(f) Sequential projected (Hist-SSP585)'
  
  df585 = rbind(df1,df2,df3)
  cor585 = cordf
  cor585$type = unique(df585$type)
  cor585$x = c(85,156,100)
  cor585$y = c(0.55)
  
  cor585$label = paste0(
    'cor: ',cor585$cor,'(',cor585$sig,')')
  
  dfline = rbind(df245,df585)
  library(ggsci)
  col = pal_lancet()(9)[c(1,7)]
  fontsize = 14
  text_theme = theme(
    legend.text = element_text(size = fontsize,
                               color = 'black'),
    axis.text = element_text(size = fontsize,
                             color = 'black'),
    axis.title = element_text(size = fontsize,
                              color = 'black'),
    legend.title = element_text(size = fontsize,
                                color = 'black'),
    strip.text  = element_text(size = fontsize,
                               color = 'black') 
    
  )
  
  dftext = rbind(cor245,cor585)
  
  
  pline = ggplot()+
    geom_line(data = dfline,
              aes( x= dateid,
                   y = value,
                   color = variable),
              size = 1.3)+
    geom_text(data = dftext,
              aes(x = x,y = y,label = label),
              size = 5,hjust = 0)+
    facet_wrap(~type,nrow = 3,
               scale = 'free')+
    theme_bw()+
    theme(panel.grid = element_blank(),
          legend.position = 'bottom')+
    #scale_x_continuous(breaks = seq(1,168,50))+
    scale_color_manual(values = col)+
    guides(color = guide_legend(title = ''))+
    text_theme+
    xlab('Training/testing sequence')+
    ylab('Indices')
  
  
  
  
  
  
}
era5_evapor<-function(
  mode = 'trend'
){
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  source('/home/share/R_project/xinjiang_vapor/trend_index.R')
  era5 = data_management(mode = 'era5_tevapor')
  
  era5_li = as.list(era5)
  era5_mean_ext<-function(x){
    xmean = cellStats(x,'mean')
    return(xmean)
  }
  
  
  era5_mean = lapply(era5_li,era5_mean_ext)
  era5_mean = do.call('c',era5_mean)
  era5_mean = -1*era5_mean*1000
  
  if(mode == 'trend'){
    era5_trend = trend_index(era5_mean,start = c(2003,1),fre = 12)
  }else{
    era5_trend = era5_mean
  }
  
 
  return(era5_trend)
  
}
era5_tmp<-function(
  mode = 'trend'
){
  era5t = data_management(mode = 'era5_temper')
  
  era5tb = 1
  for(i in 1:dim(era5t)[3]){
    tmp = cellStats(era5t[[i]],'mean')
    era5tb = c(era5tb,tmp)
  }
  era5tb = era5tb[-1]
  
  if(mode == 'trend'){
    era5tb = trend_index(era5tb,c(2003,1),12)
  }else{
    era5tb = era5tb
  }
  
  return(era5tb)
}
evaluate_cmip6_pmedata <-function(
  
){
  # import cmip6 pme
  input_pme = 'analysis_output/cmip6_by_model/pme'
  files = list.files(input_pme,
                     full.names = T)
  
  pme3ssp245 = as.data.frame(
    fread(files[3])
  )
  pme1ssp245 = as.data.frame(
    fread(files[1])
  )
  
  pme3ssp245 = pme3ssp245[1:144,]
  pme1ssp245 = pme1ssp245[1:144,]
  
  models = colnames(pme3ssp245)
  
  stand_pme <- function(x){
    x = ts(x,start = c(2003,1),frequency = 12)
    x = decompose(x)$trend
    x = x[-which(is.na(x))]
    
    
    x = (x-mean(x))/(max(x)-min(x))
    return(x)
  }
  
  pme3ssp245 = apply(pme3ssp245,2,stand_pme)
  pme1ssp245 = apply(pme1ssp245,2,stand_pme)
  
  
  # input pme era5
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:180,]
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:180,]
  
  era5_pme = pe_in_source[,c(5,7)] - pet_sum[,c(5,7)]
  era5_pme = as.matrix(era5_pme)
  era5_pme = era5_pme[1:180,]
  
  pme3era5 = era5_pme[,2]
  pme1era5 = era5_pme[,1]
  
  pme3era5 = pme3era5[1:144]
  pme1era5 = pme1era5[1:144]
  
  pme1era5 = stand_pme(pme1era5)
  pme3era5 = stand_pme(pme3era5)
  
  cor_analysis_pme3 <-function(i){
    tmp = pme3ssp245[,i]
    tmp = as.numeric(tmp)
    
    cors = cor(pme3era5,tmp)
    sig = cor.test(pme3era5,tmp)$p.value
    
    ret = data.frame(
      cors = cors,
      sig = sig
    )
    return(ret)
  }
  cor_analysis_pme1 <-function(i){
    tmp = pme1ssp245[,i]
    tmp = as.numeric(tmp)
    
    cors = cor(pme1era5,tmp)
    sig = cor.test(pme1era5,tmp)$p.value
    
    ret = data.frame(
      cors = cors,
      sig = sig
    )
    return(ret)
  }
  
  i = 1:8
  corpme1 = do.call(rbind,lapply(i,cor_analysis_pme1))
  corpme3 = do.call(rbind,lapply(i,cor_analysis_pme3))

  source("/home/share/R_project/xinjiang_vapor/draw_cmip6_pmeato1.R")
  p1 = draw_cmip6_pmeato1(
    pme1ssp245,pme1era5,corpme1
  )
  
  png('NC_mod_xinjiang/main_plot/fig_evaluate_pmecmip6/hist_pme1.png',
      height = 20,
      width = 25,
      units = 'cm',
      res = 800)
  print(p1)
  dev.off()
    
  
  source("/home/share/R_project/xinjiang_vapor/draw_cmip6_pmeato3.R")
  p2 = draw_cmip6_pmeato3(
    pme3ssp245,pme3era5,corpme3
  )
  
  png('NC_mod_xinjiang/main_plot/fig_evaluate_pmecmip6/hist_pme3.png',
      height = 20,
      width = 25,
      units = 'cm',
      res = 800)
  print(p2)
  dev.off()
  
  source("/home/share/R_project/xinjiang_vapor/draw_multi_model_simu.R")
  p3 = draw_multi_model_simu()
  png('NC_mod_xinjiang/main_plot/fig_evaluate_pmecmip6/multi_evalue_pme3.png',
      height = 25,
      width = 25,
      units = 'cm',
      res = 800)
  print(p3)
  dev.off()
  
  source("/home/share/R_project/xinjiang_vapor/draw_multi_model_simu1.R")
  p4 = draw_multi_model_simu1()
  png('NC_mod_xinjiang/main_plot/fig_evaluate_pmecmip6/multi_evalue_pme1.png',
      height = 25,
      width = 25,
      units = 'cm',
      res = 800)
  print(p4)
  dev.off()
  
  source("/home/share/R_project/xinjiang_vapor/draw_compare_tws_proj.R")
  p5 = draw_compare_tws_proj()
  png('NC_mod_xinjiang/main_plot/fig_evaluate_pmecmip6/compare_tws_proj.png',
      height = 15,
      width = 25,
      units = 'cm',
      res = 800)
  print(p5)
  dev.off()
  
  # draw compare pme 
  
  source("/home/share/R_project/xinjiang_vapor/draw_compare_pme_proj.R")
  p6 = draw_compare_pme_proj()
  png('NC_mod_xinjiang/main_plot/fig_evaluate_pmecmip6/compare_pme_proj.png',
      height = 22,
      width = 25,
      units = 'cm',
      res = 800)
  print(p6)
  dev.off()
  
  
}
evaluate_cmip6_pmedata1 <-function(
  
){
  # import cmip6 pme
  input_pme = 'analysis_output/cmip6_by_model/pme'
  files = list.files(input_pme,
                     full.names = T)
  
  pme3ssp245 = as.data.frame(
    fread(files[1])
  )
  pme3ssp585 = as.data.frame(
    fread(files[2])
  )
  
  loc201706 = length(2003:2017)*12-6
  pme3ssp245 = pme3ssp245[1:174,]
  pme3ssp585 = pme3ssp585[1:174,]
  
  models = colnames(pme3ssp245)
  
  stand_pme <- function(x){
    x = ts(x,start = c(2003,1),frequency = 12)
    x = decompose(x)$trend
    x = x[-which(is.na(x))]
    
    
    x = (x-mean(x))/(max(x)-min(x))
    return(x)
  }
  
  pme3ssp245 = apply(pme3ssp245,2,stand_pme)
  pme3ssp585 = apply(pme3ssp585,2,stand_pme)
  
  
  # input pme era5
  pme3era5 = as.data.frame(
    fread('analysis_output/fig2/pme_ato3_trend.csv')
  )
  pme3era5 = pme3era5[,2]
  
  cor_analysis245 <-function(i){
    tmp = pme3ssp245[,i]
    tmp = as.numeric(tmp)
    
    cors = cor(pme3era5,tmp)
    sig = cor.test(pme3era5,tmp)$p.value
    
    ret = data.frame(
      cors = cors,
      sig = sig
    )
    return(ret)
  }
  cor_analysis585 <-function(i){
    tmp = pme3ssp585[,i]
    tmp = as.numeric(tmp)
    
    cors = cor(pme3era5,tmp)
    sig = cor.test(pme3era5,tmp)$p.value
    
    ret = data.frame(
      cors = cors,
      sig = sig
    )
    return(ret)
  }
  
  i = 1:8
  cor245 = do.call(rbind,lapply(i,cor_analysis245))
  cor585 = do.call(rbind,lapply(i,cor_analysis585))
  
  bias_correct245 <- function(i){
    tmp = pme3ssp245[,i]
    tmp = as.numeric(tmp) 
    
    tmpb = lm(pme3era5~tmp+I(tmp^2))
    
    matera5 = matrix(c(rep(NA,6),pme3era5),
                     nrow = 12)
    matera5 = apply(matera5,1,mean,
                    na.rm = T)
    
    fits = tmpb$fitted.values
    matfits = matrix(c(rep(NA,6),fits),nrow = 12)
    matfits = apply(matfits,1,mean,
                    na.rm = T)
    
    matdiff = matera5 - matfits
    
    repdif = rep(matdiff,14)[-c(1:6)]
    
    revfits = fits + repdif
    matplot(cbind(revfits,fits))
    
    plot(pme3era5 - fits)
    
    hist(matfits)
  }
  
  
  
  
  
  
}
evaluate_pr_predicted_based_on_convey <- function(
  
){
  #input_gpcc and era5
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  gpcc_pr = paste0('gpcc_pr_in_target/',files,'.csv')
  era5_pr = paste0('era5_pr_in_target/',files,'.csv')
  
  gpcc_pr = do.call('cbind',lapply(gpcc_pr,fread))
  era5_pr = do.call('cbind',lapply(era5_pr,fread))
  
  #
  
}
extent_check_sst_df <- function(
  
){
  files = list.files('/media/root/Shen_drive1/CMIP6_combined',
                     full.names = T)[3]
  
  files = list.files(files,full.names = T)[1]
  files = list.files(files,full.names = T)
  
  model = list.files('/media/root/Shen_drive1/CMIP6/SST')
  for(i in 1:length(files)){
    tmp = try(stack(files[i]),silent = T)
    if('try-error' %in% class(tmp)){
      library(data.table)
      tmp = fread(files[i])
      tmp = as.data.frame(tmp)
      
      print(model[i])
      print(min(tmp[,1]))
      print(max(tmp[,1]))
      print(min(tmp[,2]))
      print(max(tmp[,2]))
     
    }else{
      print(extent(tmp))
    }
    print(i)
    
    
  }
  
}
extent_check_sst <- function(
  mode = 'ssp245'
){
  library(raster)
  library(data.table)
  files = list.files('/media/root/Shen_drive1/CMIP6_combined',
                     full.names = T)[3]
  
  if(mode !='ssp245'){
    files = list.files(files,full.names = T)[2]
  }else{
    files = list.files(files,full.names = T)[1]
  }
  
  files = list.files(files,full.names = T)
  
  model = list.files('/media/root/Shen_drive1/CMIP6/SST')
  for(i in 1:length(files)){
    tmp = try(stack(files[i]),silent = T)
    if('try-error' %in% class(tmp)){
      library(data.table)
      tmp = fread(files[i])
      tmp = as.data.frame(tmp)
      
      print(model[i])
      print(min(tmp[,1]))
      print(max(tmp[,1]))
      print(min(tmp[,2]))
      print(max(tmp[,2]))
      
      
      if(i == 6 |i ==7){
        id180 = which(tmp[,1]>=180)
        tmp[id180,1] = tmp[id180,1] -360
      }else{
        lt = -180
        id1 = which(tmp[,1]<=lt)
        tmp[id1,1] = tmp[id1,1]+360
        
      }
      
      fwrite(tmp,files[i])
    }else{
      if(i == 1){
        extent(tmp) = extent(-280,80,-90,90)
        tmp1 = crop(tmp,extent(-280,-180,-90,90))
        tmp2 = crop(tmp,extent(-180,80,-90,90))
        extent(tmp1) = extent(80,180,-90,90)
        
        tmp = merge(tmp1,tmp2)
        writeRaster(tmp,files[i],format = 'CDF',
                    overwrite = T)
      }else if(i == 3 | i ==5){
        tmp = try(stack(files[i]),silent = T)
        
        extent(tmp) = extent(-290,70,-90,90)
        tmp1 = crop(tmp,extent(-290,-180,-90,90))
        tmp2 = crop(tmp,extent(-180,70,-90,90))
        extent(tmp1) = extent(70,180,-90,90)
        
        tmp = merge(tmp2,tmp1)
        writeRaster(tmp,files[i],format = 'CDF',
                    overwrite = T)
        
      }else if(i ==8){
        tmp = try(stack(files[i]),silent = T)
        extent(tmp) = extent(0,360,-90,90)
        tmp1 = crop(tmp,extent(290,360,-90,90))
        tmp2 = crop(tmp,extent(0,290,-90,90))
        extent(tmp1) = extent(-70,0,-90,90)
        tmp = merge(tmp1,tmp2)
        extent(tmp) = extent(-180,180,-90,90)
        
        writeRaster(tmp,files[i],format = 'CDF',
                    overwrite = T)
      }
    }
    print(i)
    
    
  }
  
}
extract_mean_value_of_cmip6_over_ato13<-function(
  mode = 'ssp245'
){
  if(mode == 'ssp245'){
    input_cmip6_sst = list.files('/media/root/Shen_drive1/CMIP6_mask_sst',
                                 full.names = T)[1]

  }else{
    input_cmip6_sst = list.files('/media/root/Shen_drive1/CMIP6_mask_sst',
                                 full.names = T)[2]
    
  }
  
  input_sst1 = paste0(input_cmip6_sst,'/','region1')
  input_sst3 = paste0(input_cmip6_sst,'/region3')
  
  sst_files1 = list.files(input_sst1,full.names = T)
  sst_files3 = list.files(input_sst3,full.names = T)
  
  
  i <<- 1:8
  sst_files1 <<- sst_files1
  sst_files3 <<- sst_files3
  
  sub_cal_mean_sst1 <-function(i){
    library(raster)
    library(data.table)
    
    sst1 = try(stack(sst_files1[i]),silent = T)
    if('try-error' %in% class(sst1)){
      sst1 = fread(sst_files1[i])
      sst1 = as.data.frame(sst1)
      loc = sst1[,1:2]
      sstdf = sst1[,-c(1:2)]
      
      sstdfmean = apply(sstdf,2,mean,na.rm = T)
    }else{
      sstl1 = as.list(sst1)
      cell_fun <-function(x){
        xm = cellStats(x,'mean')
        return(xm)
      }
      sstdfmean = lapply(sstl1,cell_fun)
      sstdfmean = do.call('c',sstdfmean)
    }
    return(sstdfmean)
  }
  sub_cal_mean_sst3 <-function(i){
    library(raster)
    library(data.table)
    
    sst1 = try(stack(sst_files3[i]),silent = T)
    if('try-error' %in% class(sst1)){
      sst1 = fread(sst_files3[i])
      sst1 = as.data.frame(sst1)
      loc = sst1[,1:2]
      sstdf = sst1[,-c(1:2)]
      
      sstdfmean = apply(sstdf,2,mean,na.rm = T)
    }else{
      sstl1 = as.list(sst1)
      cell_fun <-function(x){
        xm = cellStats(x,'mean')
        return(xm)
      }
      sstdfmean = lapply(sstl1,cell_fun)
      sstdfmean = do.call('c',sstdfmean)
      
    }
    return(sstdfmean)
  }
  
  library(doParallel)
  cl = makeCluster(8)
  clusterExport(cl,c('i','sst_files1'))
  ret1 = parLapply(cl,i,sub_cal_mean_sst1)
  stopCluster(cl)
  
  
  library(doParallel)
  cl = makeCluster(8)
  clusterExport(cl,c('i','sst_files3'))
  ret3 = parLapply(cl,i,sub_cal_mean_sst3)
  stopCluster(cl)
  
  ret1 = do.call(cbind,ret1)
  ret3 = do.call(cbind,ret3)
  
  models = list.files('/media/root/Shen_drive1/CMIP6/SST')
  colnames(ret1) = models
  colnames(ret3) = models 
  
  dir.create('analysis_output/cmip6_by_model')
  dir.create('analysis_output/cmip6_by_model/sst')
  output = paste0('analysis_output/cmip6_by_model/sst/region',
                  c(1,3),'_',mode,'.csv')
  fwrite(ret1,output[1])
  fwrite(ret3,output[2])
}






extract_region_sum_value_of_pmeato13 <-function(
 mode = 'ssp245' 
){
  if(mode == 'ssp245'){
    input_pme = list.files(
      '/media/root/Shen_drive1/CMIP6_pme/ato/',
      full.names = T)[1]
  }else{
    input_pme = list.files(
      '/media/root/Shen_drive1/CMIP6_pme/ato/',
      full.names = T)[2]
  }
  
  input_pme1 = list.files(paste0(input_pme,'/region1'),
                          full.names = T)
  input_pme3 = list.files(paste0(input_pme,'/region3'),
                          full.names = T)
  
  
  i <<- 1:8
  input_pme1 <<- input_pme1
  input_pme3 <<- input_pme3
  
  sub_cal_sum_pme1<-function(i){
    library(raster)
    tmp = stack(input_pme1[i])
    
    tmp = as.list(tmp)
    
    cel_sum_fun <-function(x){
      sumx = cellStats(x,'sum')
      return(sumx)
    }
    
    retsum = lapply(tmp,cel_sum_fun)
    retsum = do.call('c',retsum)
    return(retsum)
  }
  
  sub_cal_sum_pme3<-function(i){
    library(raster)
    tmp = stack(input_pme3[i])
    
    tmp = as.list(tmp)
    
    cel_sum_fun <-function(x){
      sumx = cellStats(x,'sum')
      return(sumx)
    }
    
    retsum = lapply(tmp,cel_sum_fun)
    retsum = do.call('c',retsum)
    return(retsum)
  }
  
  library(doParallel)
  cl = makeCluster(8)
  clusterExport(cl,c('i','input_pme1'))
  ret1 = parLapply(cl,i,sub_cal_sum_pme1)
  stopCluster(cl)
  
  
  library(doParallel)
  cl = makeCluster(8)
  clusterExport(cl,c('i','input_pme3'))
  ret3 = parLapply(cl,i,sub_cal_sum_pme3)
  stopCluster(cl)
  
  
  ret1 = do.call('cbind',ret1)
  ret3 = do.call('cbind',ret3)
  
  models = list.files('/media/root/Shen_drive1/CMIP6/SST')
  colnames(ret1) = models
  colnames(ret3) = models 
  
  dir.create('analysis_output/cmip6_by_model')
  dir.create('analysis_output/cmip6_by_model/pme')
  output = paste0('analysis_output/cmip6_by_model/pme/region',
                  c(1,3),'_',mode,'.csv')
  
  fwrite(ret1,output[1])
  fwrite(ret3,output[2])
  
  
}
extract_snow_ice_landuse_tibet <-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  # import shp 
  tibet = shp_management('tibet')
  world = shp_management('world')
 
  ex_tibet = extent(tibet)
  minlat = ex_tibet[3]
  maxlat = ex_tibet[4]
  minlong = ex_tibet[1]
  maxlong = ex_tibet[2]
  
  ex_box = extent(minlong-30,maxlong+50,minlat-20,maxlat+20)
  source('/home/share/R_project/xinjiang_vapor/data_management_yrb.R')
  landuse = data_management_yrb(mode = 'global_landuse')
  landuse = mask(crop(landuse,tibet),tibet)
  
  landuse[!(landuse %in% 100)] = NA
  landuse = landuse[[22:34]]
  landuse = as.list(landuse)
  
  output = paste0('/media/sdb5/Vapor_projcts/Vapor_tibet/shp/glacier_by_year/',
                  'year_',2003:2015,'.shp')
  i = 1:length(landuse)
  i <<- i
  output <<- output 
  landuse <<- landuse
  sub_to_polygon<-function(i){
    library(raster)
    library(sf)
    library(maptools)
    library(dplyr)
    #library(gifski)
    x = landuse[[i]]
    xp = rasterToPolygons(x)
    shapefile(xp,output[i],
              overwrite = T)
    tmp_land_shp = st_read(output[i])
    tmp_land_shp = tmp_land_shp %>% group_by() %>% st_union()
    st_write(tmp_land_shp,output[i],
             append = FALSE)
  }
  
  library(doParallel)
  cl = makeCluster(5)
  clusterExport(cl,c('output','landuse','i'))
  parLapply(cl,i,sub_to_polygon)
  stopCluster(cl)
  
}
fig_mca_res_plot <- function(
  
){
  input_loc_pme = 'NC_mod_xinjiang/svd_mca_analysis/whole_land/loc_pme.csv'
  input_loc_tws = 'NC_mod_xinjiang/svd_mca_analysis/whole_land/loc_whole_tws.csv'
  
  input_modtws = 'NC_mod_xinjiang/svd_mca_analysis/whole_land/modu.csv'
  input_modpme = 'NC_mod_xinjiang/svd_mca_analysis/whole_land/modv.csv'
  
  input_tws_st = 'NC_mod_xinjiang/svd_mca_analysis/whole_land/ajs_full_mat.csv'
  input_pme_st = 'NC_mod_xinjiang/svd_mca_analysis/whole_land/bjs_full_mat.csv'

  loc_pme = as.data.frame(fread(input_loc_pme))
  loc_tws = as.data.frame(fread(input_loc_tws))
  colnames(loc_pme) = c('long','lat')
  colnames(loc_tws) = c('long','lat')
  
  loc_tws[,1] = loc_tws[,1]+0.125
  loc_tws[,2] = loc_tws[,2]+0.125
  
  modtws = as.data.frame(fread(input_modtws))
  modpme = as.data.frame(fread(input_modpme))
  tws_st = as.data.frame(fread(input_tws_st))
  pme_st = as.data.frame(fread(input_pme_st))
  
  modpme$variable[which(modpme$variable == 'Model_pme1')] = 
    'PME Mode 1'
  modpme$variable[which(modpme$variable == 'Model_pme2')] = 
    'PME Mode 2'
  modpme$variable[which(modpme$variable == 'Model_pme3')] = 
    'PME Mode 3'
  modpme$variable[which(modpme$variable == 'Model_pme4')] = 
    'PME Mode 4'
  
  modtws$variable[which(modtws$variable == 'Model_tws1')] = 
    'TWS Mode 1'
  modtws$variable[which(modtws$variable == 'Model_tws2')] = 
    'TWS Mode 2'
  modtws$variable[which(modtws$variable == 'Model_tws3')] = 
    'TWS Mode 3'
  modtws$variable[which(modtws$variable == 'Model_tws4')] = 
    'TWS Mode 4'
  
  modtws$levels = cut(modtws$value,
                      breaks = seq(-0.015,0.015,0.005))
  modpme$levels = cut(modpme$value,
                      breaks = seq(-0.015,0.015,0.005))  
  
  library(RColorBrewer)
  fils = colorRampPalette(brewer.pal(
    9,'Spectral'
  ))(6)
  
  #import world and 
  world = shp_management('world')
  ato = shp_management('ocean','ato')
  world = crop(world,extent(-180,180,0,90))
  world_oce = crop(world,extent(ato))
  world_eu = crop(world,extent(-20,180,0,90))
  
  
  fontsize = 14
  text_theme = theme(
    axis.text = element_text(size = fontsize,
                             color= 'black'),
    axis.title = element_text(size = fontsize,
                                color= 'black'),
    #axis.title.x = element_blank(),
    strip.text = element_text(size = fontsize,
                              color= 'black'),
    legend.text = element_text(size = fontsize,
                             color= 'black')
  )
  label_p2 = data.frame(
    x = 160,
    y = 10,
    label = paste0('(',letters[seq(3,12,3)],')'),
    variable = paste0('TWS ','Mode ',1:4)
  )
  label_p1 = data.frame(
    x = -120,
    y = 10,
    label = paste0('(',letters[seq(2,12,3)],')'),
    variable = paste0('PME ','Mode ',1:4)
  )
  
  cluster_traj_df = fread('analysis_output/fig2/cluster_traj_df.csv')
  cluster_traj_df = as.data.frame(cluster_traj_df)
  colnames(cluster_traj_df)[4] = 'variable2'
  cluster_traj_df$region[which(is.na(cluster_traj_df$region))]=
    'NA'
  route_col = pal_npg()(10)[4]
  route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
  
  route_col = colorRampPalette(brewer.pal(
    9,'Blues'
  ))(20)
  
  p1 = ggplot()+
    geom_polygon(data = world_oce,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 size = 0.5,
                 fill = 'transparent')+
    geom_tile(data = modpme,
              aes(x = long,y = lat,
                  fill = levels))+
    geom_text(data = label_p1,
              aes(x = x,y = y,
                  label = label),
              size = 4,color = 'black')+
    scale_fill_brewer(palette = 'Spectral')+
    #scale_fill_manual(values = fils)+
    #scale_color_manual(values= route_col)+
    theme_bw()+
    theme(panel.grid = element_blank(),
          legend.position = 'bottom')+
    guides(fill = guide_legend(title = '',
                               nrow = 2))+
    text_theme+
    xlab("Longitude")+
    ylab('Latitude')+
    facet_wrap(~variable,nrow = 4)
  
  
  
  
  p2 = ggplot()+
    geom_polygon(data = world_eu,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 size = 0.5,
                 fill = 'transparent')+
    geom_tile(data = modtws,
              aes(x = long,y = lat,
                  fill = levels))+
    
    geom_text(data = label_p2,
              aes(x = x,y = y,
                  label = label),
              size = 4,color = 'black')+
    scale_fill_brewer(palette = 'Spectral')+
    #scale_color_manual(values= route_col)+
    
    #scale_fill_manual(values = fils)+
    theme_bw()+
    theme(panel.grid = element_blank(),
          legend.position = 'bottom')+
    guides(fill = guide_legend(title = '',
                               nrow = 2))+
    
    text_theme+
    xlab("Longitude")+
    ylab('Latitude')+
    facet_wrap(~variable,nrow = 4)
  
  pme_st = t(pme_st)
  tws_st = t(tws_st)
  
  pme_st = pme_st[,1:4]
  tws_st = tws_st[,1:4]
  
  colnames(pme_st)= paste0('PME Mode ',1:4)
  colnames(tws_st) = paste0('TWS Mode ',1:4)
    
  cors_cal_fun<-function(i){
    tmp = cor(pme_st[,i],tws_st[,i])
    tmp.sig = cor.test(pme_st[,i],
                       tws_st[,i])$p.value
    retdf = data.frame(
      cor = tmp,
      sig = tmp.sig
    )
    return(retdf)
  }
  i = 1:4
  cors = lapply(i,cors_cal_fun)
  cors = do.call(rbind,cors)

  cors$sig = c('7.31e-52',
               '1.44e-49',
               '2.05e-78',
               '5.75e-77')
  
  cors$x = as.Date('2004-06-01')
  cors$y = 100
  
  
  covs = read.csv('NC_mod_xinjiang/svd_mca_analysis/whole_land/model_covs_weights.csv',
                  header = T)
  covs = covs[1:4,2]
  covs = round(covs *100,2)
  covs = paste0(covs,'%')
  cors$type = paste0("Mode ",1:4,' (',covs,')')
  
  label_line = data.frame(
    x = as.Date('2015-06-01'),
    y = -68,
    label = paste0('(',letters[seq(1,12,3)],')'),
    type = paste0("Mode ",1:4,' (',covs,')')
  )
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-06-01'),
             '1 month')
  date = date[-c(1:6,169:174)]
  
  dfpme_st = data.frame(
    date,
    pme_st
  )
  dftws_st = data.frame(
    date,
    tws_st
  )
  
  dfpme_st = reshape2::melt(dfpme_st,'date')
  dftws_st = reshape2::melt(dftws_st,'date')
  
  
  dfpme_st$type = rep(paste0("Mode ",1:4,' (',covs,')'),
                      each = 162)
  dftws_st$type = rep(paste0("Mode ",1:4,' (',covs,')'),
                      each = 162)
  dfpme_st$col = 'PME'
  dftws_st$col = 'TWS'
  dfline = rbind(dfpme_st,
                 dftws_st)
  
  
  
  library(ggsci)
  cols = pal_lancet(alpha = 1)(9)[c(1,7)]
  
  p3 = ggplot()+
    geom_line(data = dfline,
              aes(x = date,y= value,
                  color = col),
              size = 1.3)+
    geom_text(data = cors,
              aes(x = x,y = y,
                  label = paste0('cor: ',round(cor,2),'(',
                                 sig,')')),
              size = 4,
              color = 'black',
              hjust = 0)+
    geom_text(data = label_line,
              aes(x = x,y = y,
                  label = label),
              size = 4,color = 'black')+
    scale_color_manual(values = cols)+
    theme_bw()+
    theme(panel.grid = element_blank(),
          legend.position = 'bottom')+
    
    text_theme+
    guides(color = guide_legend(title = '',
                                nrow = 2))+
    facet_wrap(~type,nrow = 4)+
    scale_y_continuous(breaks = c(-100,-50,0,75,150))+
    xlab("Time")+
    ylab('Time coefficients')
  
  library(ggpubr)
  p3_leg = as_ggplot(get_legend(p3))
  p2_leg = as_ggplot(get_legend(p1))
  p12leg = plot_grid(p3_leg,
                  p2_leg,nrow = 1,
                  rel_widths = c(1,1),
                  rel_heights = c(1,1))
  p1 = p1+ theme(legend.position = 'none')
  p2 = p2+ theme(legend.position = 'none')
  p3 = p3+theme(legend.position = 'none')
  library(cowplot)
  p123 = plot_grid(
    p3,p1,p2,
    rel_heights = c(1,1,1),
    rel_widths = c(1,1,1),nrow =1
  )
  
  p123leg = plot_grid(p123,
                      p12leg,
                      ncol = 1,
                      rel_heights = c(10,1))
  dir.create('NC_mod_xinjiang/main_plot/fig_mca')
  png('NC_mod_xinjiang/main_plot/fig_mca/mca.png',
      height = 25,
      width = 25,
      units = 'cm',
      res = 800)
  print(p123leg)
  dev.off()
}
fig_nc_demonstrate_drought_impact_human_behavior <- function(
  tws_year,
  freshwater,
  pmeato3_year
){
  pmeato3 = pmeato3_year[,3]
  pmeato4 = pmeato3_year[,4]
  
  coeffdf = as.data.frame(
    fread('NC_mod_xinjiang/fig_human_impact/coeffdf.csv')
  )
  countrys = read.csv('NC_mod_xinjiang/fig_human_impact/countrys.csv',
                      header = T)
  countrys = as.character(countrys[,2])
  
  posid = which(coeffdf$coeff_freshwater_withdraw >= 0)
  
  pos_coeff = coeffdf[posid,]
  pos_country = countrys[posid]
  pos_tws = tws_year[,posid]
  pos_fresh = freshwater[,posid]
  
  cor_fun_p <- function(i){
    tmp1 = pos_tws[,i]
    tmp2 = pos_fresh[,i]
    tmp = cor.test(tmp1,tmp2)$p.value
    return(tmp)
  }
  cor_fun <- function(i){
    tmp1 = pos_tws[,i]
    tmp2 = pos_fresh[,i]
    tmp = cor.test(tmp1,tmp2)$estimate
    #tmp = max(ccf(tmp1,tmp2)$acf)
    return(tmp)
  }
  
  i = 1:ncol(pos_tws)
  pv = do.call('c',lapply(i,cor_fun_p))
  cors = do.call('c',lapply(i, cor_fun))

  #cors = cors[cvid]
  
  source("/home/share/R_project/xinjiang_vapor/import_country_longlat.R")
  country_loc = import_country_longlat(pos_country)
  country_code = country_loc$code
  country_loc2 = country_loc
  country_loc2$cor = cors
  country_loc2$p = pv
  
  country_loc2$sig = 'Not significant'
  country_loc2$sig[which(pv <0.05)] = 'Significant'
  color2 = pal_lancet(alpha = 0.7)(9)[c(1,7)]
  country_loc2$levels = cut(country_loc2$cor,
                            breaks = seq(-0.5,1,0.25))
  country_loc2$levels2 = cut(country_loc2$p,
                             breaks = c(0,0.01,0.05,0.1,0.25,
                                        0.5,1))
  
  
  size_scale = c('(0,0.2]'= 2,
                 '(0.2,0.4]' = 3,
                 '(0.4,0.6]' = 4,
                 '(0.6,0.8]' = 5,
                 '(0.8,1]' = 6,
                 '(1,1.2]' = 7)
  
  size_scale2 = c('(-0.5,-0.25]' = 3,
                  '(-0.25,0]'=2 ,
                  '(0,0.25]'= 2,
                 '(0.25,0.5]' = 3,
                 '(0.5,0.75]' = 4,
                 '(0.75,1]' = 5)
  color_scale2 = c('(-0.5,-0.25]' = color2[1],
                  '(-0.25,0]'=color2[1], 
                  '(0,0.25]'= color2[2],
                  '(0.25,0.5]' = color2[2],
                  '(0.5,0.75]' =color2[2], 
                  '(0.75,1]' = color2[2])
  
  size_scale1 = c('(0,0.01]' = 7,
                  '(0.01,0.05]'=6,
                  '(0.05,0.1]'= 5,
                  '(0.1,0.25]' = 4,
                  '(0.25,0.5]' = 3,
                  '(0.5,1]' = 2)
  
  color_scale1 = c('(0,0.01]' = color2[2],
                  '(0.01,0.05]'= color2[2],
                  '(0.05,0.1]'= color2[1],
                  '(0.1,0.25]' = color2[1],
                  '(0.25,0.5]' = color2[1],
                  '(0.5,1]' = color2[1])
  
  world = shp_management('world')
  world1 = crop(world,extent(-20,80,20,80))
  hsr1 = crop(hsr,extent(-20,80,20,80))
  
  country_loc2$shape = 'Non-significant'
  country_loc2$shape[which(pv <= 0.05)] = 'Significant'
  
  shapes = c('Non-significant' = '',
             'Significant' = '+')
  
  dfsub_label = data.frame(
    x = -12,
    y = 80,
    label = '(a)'
  )
  
    
  pmap1 = ggplot()+
    
    geom_tile(data = twsmmk_land,
              aes(x = long,y= lat,fill = cuts),
              alpha = 0.5,show.legend = F)+
    geom_polygon(data = world1,
                 aes(x =long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'transparent')+
    geom_polygon(data = hsr1,
                 aes(x =long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'transparent')+
    geom_point(data = country_loc2,
               aes(x = long,y= lat,
                   size =levels,
                   color = levels),
               shape = 16)+
    geom_point(data = country_loc2,
               aes(x = long,y= lat,
                   shape = shape),
               color = 'white',
               size = 6,show.legend = F)+
    geom_text(data = dfsub_label,
              aes(x = x,y =y,label = label),
              size = 5,color  = 'black')+
    scale_shape_manual(values =shapes)+
    scale_size_manual(values = size_scale2*2)+
    scale_color_manual(values = color_scale2)+
    scale_fill_manual(values = land_tws_mmk_pal,
                      guide = guide_legend(
                        title = '(a-b) TWS_MMK_trend',
                        title.position = 'top',
                        nrow = 2
                      ))+
    guides(color = guide_legend('(a) Relation between TWS and TFW',
                                title.position = 'top'),
           size = guide_legend('(a) Relation between TWS and TFW',
                                title.position = 'top'))+
    theme_bw()+
    xlim(-20,80)+
    ylim(20,80)+
    theme(panel.grid = element_blank(),
          legend.position = 'none')+
    xlab('Longitude')+
    ylab('Latitude')
  
  
  cvid = which(cors >= 0.3)
  pos_country1 = pos_country[cvid]
  pos_coeff = pos_coeff[cvid,]
  pos_tws = pos_tws[,cvid]
  pos_fresh = pos_fresh[,cvid]
  
  pos_twsdf = data.frame(year = 2003:2016,
                         pos_tws)
  pos_freshdf = data.frame(year = 2003:2016,
                           pos_fresh)
  pos_twsdf = reshape2::melt(pos_twsdf,'year')
  pos_freshdf = reshape2::melt(pos_freshdf,'year')
  
  pos_twsdf$type = 'TWS'
  pos_freshdf$type = 'TFW'
  linedf = rbind(pos_twsdf,pos_freshdf)
  
  dir.create('NC_mod_xinjiang/fig_impact_human')
  #write.csv(pos_country,'NC_mod_xinjiang/fig_impact_human/pos_country.csv')
  
  source("/home/share/R_project/xinjiang_vapor/import_gdp_df.R")
  gdprdf = import_gdp_df('gdpr')
  gdprdf = gdprdf[which(gdprdf$variable %in% pos_country1),]
  
  linedf = rbind(linedf,gdprdf)
  
  cols = pal_lancet()(9)[c(1,4,7)]
  
  vars = as.character(unique(linedf$variable))
  i = 1:length(vars)
  varsid = which(country_loc$country %in% vars)
  varscode = country_loc$code[varsid]
  
  vars = paste0('(',letters[3:17],') ',
                vars, '(',varscode,')')
  linedf$variable2 = rep(rep(vars,each = 14),3)
  
  pline = ggplot()+
    geom_line(data = linedf,aes(x = year,
                                y = value,
                                color = type),
              size = 1.3)+
    
    facet_wrap(~variable2,nrow = 3)+
    scale_color_manual(values = cols)+
    theme_bw()+
    theme(panel.grid = element_blank())
  pline
  
  
  # cors
  df_cors = data.frame(
    y = 1:23,
    ylabel = pos_country,
    x = cors
  )
  df_cors$levels = cut(df_cors$x,
                       breaks = seq(-0.5,1,0.25))
  df_cors$sig = 'Non-significant'
  pvid = which(pv < 0.05)
  df_cors$sig[pvid] = 'Significant'
  
  df_cors$code = country_code
  order = order(cors,decreasing = T)
  df_cors = df_cors[order,]
  df_cors$y = 1:23
  
  shapes = c('Non-significant' = '',
             'Significant' = '+')
  
  segside1v = data.frame(
    x = c(0.3,1),
    y = 22,
    yend = 23
  )
  segside1h = data.frame(
    x = c(0.3),
    xend = 1,
    y = 22.5
  )
  labeldf = data.frame(
    x =0.65,
    y = 23.5,
    label = paste0(round(15/23,2)*100,'%')
  )
  
  dflabel_side = data.frame(
    x = -0.5,y = 1,label = '(b)'
  )
  pside1 = ggplot()+
    geom_text(data = dflabel_side,
              aes(x = x,y  = y,
                  label = label),
              size = 5)+
    geom_vline(xintercept = 0,
               size = 0.5,
               linetype = 'dashed')+
    geom_vline(xintercept = 0.3,
               size = 0.5,
               linetype = 'dashed')+
    geom_vline(xintercept = 1,
               size = 0.5,
               linetype = 'dashed')+
    geom_point(data = df_cors,
               aes(x = x,y=y,
                   size = levels,
                   color = levels))+
    geom_point(data = df_cors,
               aes(x = x,y=y,shape = sig),
               size = 6,color = 'white')+
    scale_color_manual(values = color_scale2)+
    scale_size_manual(values = size_scale2*2)+
    scale_shape_manual(values = shapes)+
    scale_y_continuous(breaks = seq(1,23,1),
                       labels = country_code)+
    theme_bw()+
    geom_segment(
      data = segside1h,
      aes(x = x,y = y,xend = xend,yend = y),
      size = 0.5,
      arrow = arrow(20,unit(0.25,'cm'),type = 'closed')
    )+
    geom_segment(
      data = segside1h,
      aes(x = xend,y = y,xend = x,yend = y),
      size = 0.5,
      arrow = arrow(20,unit(0.25,'cm'),type = 'closed')
    )+
    geom_segment(
      data = segside1v,
      aes(x = x,y = y,xend = x,yend = yend),
      size = 0.5 )+
    geom_text(data = labeldf,
              aes(x = x,y = y,label = label),
              size = 5,
              color = 'black')+
    scale_x_continuous(breaks = c(0,0.3,1),
                       limits = c(-0.6,1.2))+
    theme(panel.grid = element_blank())
  
  
  fontsize = 14
  text_theme = theme(
    legend.text  = element_text(size = fontsize,
                             color= 'black'),
    
    axis.text = element_text(size = fontsize,
                             color= 'black'),
    axis.title.y = element_text(size = fontsize,
                                color= 'black'),
    axis.title.x = element_blank(),
    strip.text = element_text(size = fontsize,
                              color= 'black')
  )
  
  #pmap2 = pmap2+text_theme+theme(legend.position = 'none')
  pmap1 = pmap1+text_theme+theme(legend.position = 'none')
  pline= pline+text_theme+theme(legend.position = 'none')
  pside1 = pside1+text_theme+theme(legend.position = 'none')
  
  
  
  
  pline = pline + theme(axis.text.y = 
                          element_text(angle = 90,
                                       hjust = 0.5))+
    ylab('Indices')+
    scale_x_continuous(breaks = c(2004,2012))
  
  pside1 = pside1 + 
    theme(axis.title.y = element_blank())
  
  pcom2 = plot_grid(
    pmap1,pside1,
    rel_widths = c(2.5,1),
    rel_heights = c(3,3),
    nrow = 1
  )
  
  pcom3 =  plot_grid(
    pcom2,pline,
    rel_widths = c(1,1),
    rel_heights = c(1,1),
    ncol = 1,
    align ='l',
    axis = 'v'
  )
  
  
  
  png('NC_mod_xinjiang/main_plot/fig_impact_human/fig1.png',
      height = 27,
      width = 25,
      units = 'cm',
      res = 800)

  print(pcom3)
  dev.off()
  
  
  library(ggpubr)
  theme_leg = theme(legend.position = 'bottom')
  pmapleg = as_ggplot(get_legend(pmap1+theme_leg))
  plineleg = as_ggplot(get_legend(pline+theme_leg))
  psideleg = as_ggplot(get_legend(pside1+theme_leg))
  
  
  pmap2 = ggplot()+
    
    geom_tile(data = twsmmk_land,
              aes(x = long,y= lat,fill = cuts),
              alpha = 0.5,show.legend = T)+
    scale_fill_manual(values = land_tws_mmk_pal,
                      guide = guide_legend(
                        title = '(a) TWS_MMK_trend',
                        title.position = 'top',
                        nrow = 3
                      ))+
    theme_bw()+
    text_theme
  pmapleg2 = as_ggplot(get_legend(pmap2+theme_leg))
  
  png('NC_mod_xinjiang/main_plot/fig_impact_human/pmapleg.png',
      height = 27,
      width = 25,
      units = 'cm',
      res = 800)
  
  print(pmapleg)
  dev.off()
  
  png('NC_mod_xinjiang/main_plot/fig_impact_human/pmapleg2.png',
      height = 27,
      width = 25,
      units = 'cm',
      res = 800)
  
  print(pmapleg2)
  dev.off()
  
  png('NC_mod_xinjiang/main_plot/fig_impact_human/plineleg.png',
      height = 27,
      width = 25,
      units = 'cm',
      res = 800)
  
  print(plineleg)
  dev.off()
  
  
  
  
  
}
fig_nc_verify_impacts_freshwater_withdraw <- function(
  
){
  library(ggplot2)
  # import peo country 
  peo_country = as.data.frame(
    fread('NC_mod_xinjiang/fig_human_impact/peo_coun_rbind.csv'
    )
  )
  coeffdf = as.data.frame(
    fread('NC_mod_xinjiang/fig_human_impact/coeffdf.csv')
  )
  countrys = read.csv('NC_mod_xinjiang/fig_human_impact/countrys.csv',
                      header = T)
  countrys = as.character(countrys[,2])
  
  peoid = which(countrys %in% peo_country$country)
  
  coeff_neg = coeffdf[which(coeffdf$coeff_freshwater_withdraw <0),]
  #coeff_neg = coeffdf
  neg_country = countrys[which(coeffdf$coeff_freshwater_withdraw <0)]
  
  df_pmeato3 = data.frame(
    coeff = coeff_neg$coeff_pmeato3,
    type = '(b) coeff. PME-NATO3'
  )
  df_pmeato4 = data.frame(
    coeff = coeff_neg$coeff_pmeato4)
  
  zeroid = which(df_pmeato4$coeff == 0)
  df_pmeato4 = data.frame(coeff =df_pmeato4[-zeroid,],
                          type = '(c) coeff. PME-NATO4')
  
  df_fresh = data.frame(
    coeff = coeff_neg$coeff_freshwater_withdraw,
    type = '(a) coeff. TFW'
  )
  
  df_diff = abs(coeff_neg$coeff_freshwater_withdraw)-
    (abs(coeff_neg$coeff_pmeato3)+abs(coeff_neg$coeff_pmeato4))
  
  df_diff = data.frame(
    coeff = df_diff,
    type = '(d) abs(a) - (abs(b)+abs(c))'
  )
  
  df_coeff = rbind(df_fresh,df_pmeato3,df_pmeato4)
  df_coeff$group = df_coeff$type
  
  df_diff$group = 'TFW dominate'
  df_diff$group[which(df_diff$coeff<0)] = 'PME-NATO dominate'
  # bar plot
  library(ggsci)
  #al_lancet(alpha = 0.7)(9)[c(7,3,4,1)]
  fil = pal_lancet(alpha = 0.7)(9)[c(5,4,6)]
  fil1 = pal_lancet(alpha = 0.7)(9)[c(1,7)]
  fil1 = c('PME-NATO dominate' = fil1[1],
           'TFW dominate' = fil1[2],
           '(a) coeff. TFW' ='#79AF97FF', #fil[1],
           '(b) coeff. PME-NATO3' = fil[2],
           '(c) coeff. PME-NATO4' = fil[3])
  segh = data.frame(
    x = c(-1,0),
    xend = c(0,1),
    y = 12.5,
    yend = 12.5,
    type = '(d) abs(a) - (abs(b)+abs(c))'
  )
  segv = data.frame(
    x = c(-1,0,1),
    y = 11.75,
    yend = 13.25,
    type = '(d) abs(a) - (abs(b)+abs(c))'
  )
  
  labelbar =data.frame(
    x = c(-0.5,0.5),
    y = 13,
    label = c('22 (71%)','9 (29%)'),
    type = '(d) abs(a) - (abs(b)+abs(c))'
  )
  
  pbar = ggplot()+
    geom_vline(xintercept = 0,linetype = 'dashed')+
    geom_histogram(
      data = df_coeff,
      aes(x = coeff,fill = group),binwidth = 0.25,
      #fill = fil,
      center = 0.125
    )+
    geom_histogram(
      data = df_diff,
      aes(x = coeff,fill = group),binwidth = 0.25,
      center = 0.125
    )+
    geom_segment(
      data = segh,
      aes(x = x,xend = xend,y = y,yend = yend),
      size = 0.5,color= 'black',
      arrow = arrow(20,
                    length = unit(0.25,'cm'),
                    type = 'closed')
    )+
    geom_segment(
      data = segh,
      aes(x = xend,xend = x,y = y,yend = yend),
      size = 0.5,color= 'black',
      arrow = arrow(20,length = unit(0.25,'cm'),
                    type = 'closed')
    )+
    geom_segment(
      data = segv,
      aes(x = x,xend = x,y = y,yend = yend),
      size = 0.5,color= 'black'
    )+
    geom_text(
      data= labelbar,
      aes(x = x,y = y,label = label),
      size = 5,
      color = 'black'
    )+
    scale_fill_manual(values = fil1)+
    facet_wrap(~type,nrow = 1,
               scales = 'free_x')+
    theme_bw()+
    theme(legend.position = 'none',
          panel.grid = element_blank())+
    scale_x_continuous(breaks = seq(-1.2,1,0.6))+
    ylab('Number of regions')
  
  # plot map 
  peo_in_id = which(neg_country %in% 
                      peo_country$country)
  pme_country = neg_country[-peo_in_id]
  pme_country_type = coeff_neg[-peo_in_id,]
  pme_country = data.frame(
    country = pme_country,
    type = pme_country_type$type
  )
  peo_country$diff = round(df_diff$coeff[peo_in_id],2)
  pme_country$diff = round(df_diff$coeff[-peo_in_id],2)
  
  country_label <- as.data.frame(
    fread('/media/sdb5/Vapor_projcts/Vapor_tibet/main_plot_data/fig3/country_label.csv')
  )
  country_label = country_label[-which(country_label$name == 'Hong Kong'|
                                         country_label$name == 'Macau'),]
  country_label$latitude[which(country_label$name=='India')]=
    country_label$latitude[which(country_label$name=='India')]+2
  
  citys = shp_management('china_city')
  city_china = citys[citys$PINYIN %in%
                       c('Wulumuqi','Shijiazhuang'),]
  city_china = as.data.frame(city_china,xy = T)
  city_china1 = data.frame(
    country = c('NCP','XJ'),
    latitude = city_china$coords.x2,
    longitude = city_china$coords.x1,
    name = c('North China Plain','Xinjiang')
  )
  
  country_label = rbind(country_label,city_china1)
  
  pme_country$status = 'PMEATO dominated declines in TWS'
  peo_country$status = 'Total freshwater withdraw dominated declines in TWS'
  
  pos_country = rbind(
    pme_country[which(pme_country$type =='increasing_TWS'),],
    peo_country[which(peo_country$type =='pos_trend'),]
  )
  neg_country = rbind(
    pme_country[which(pme_country$type =='declining_TWS'),],
    peo_country[which(peo_country$type =='neg_trend'),]
  )
  
  i = 1:length(pos_country$country)
  ret_id_pos <- function(i){
    pos_coun_in = which(as.character(country_label$name) == as.character(pos_country$country)[i])
    return(pos_coun_in)
  }
  pos_coun_in = lapply(i,ret_id_pos)
  
  i = 1:length(neg_country$country)
  ret_id_neg <- function(i){
    neg_coun_in = which(as.character(country_label$name) == as.character(neg_country$country)[i])
    return(neg_coun_in)
  }
  neg_coun_in = lapply(i,ret_id_neg)
  
  pos_coun_in = do.call('c',pos_coun_in)
  neg_coun_in = do.call('c',neg_coun_in)
  
  pos_loc = data.frame(
    long = country_label$longitude[pos_coun_in],
    lat = country_label$latitude[pos_coun_in]
  )
  neg_loc = data.frame(
    long = country_label$longitude[neg_coun_in],
    lat = country_label$latitude[neg_coun_in]
  )
  
  pos_country = cbind(pos_country,pos_loc)
  neg_country = cbind(neg_country,neg_loc)
  
  pos_country$levels = cut(pos_country$diff,
                           breaks = c(seq(-1,1,0.25)))
  neg_country$levels = cut(neg_country$diff,
                            breaks = seq(-1,1,0.25))
  
  
  
  world = shp_management('world_country')
  world = crop(world,extent(-20,180,0,90))
  
  #pals = colorRampPalette(brewer.pal(9,'Spectral'))(8)
  pals = pal_lancet(alpha = 0.8)(9)[c(1,7)]
  cols = c('(-1,-0.75]' = pals[1],
           '(-0.75,-0.5]' = pals[1],
           '(-0.5,-0.25]' = pals[1],
           '(-0.25,0]' = pals[1],
           '(0,0.25]' = pals[2],
           '(0.25,0.5]' = pals[2],
           '(0.5,0.75]' = pals[2],
           '(0.75,1]' = pals[2])
  sizes =  c('(-1,-0.75]' = 5,
             '(-0.75,-0.5]' = 4,
             '(-0.5,-0.25]' = 3,
             '(-0.25,0]' = 2,
             '(0,0.25]' = 2,
             '(0.25,0.5]' = 3,
             '(0.5,0.75]' =4,
             '(0.75,1]' = 5)
  sizes2 = sizes -0.5
  
  land_tws_mmk_pal = colorRampPalette(
    brewer.pal(9,'YlOrRd'))(25)
  land_tws_mmk_pal = rev(land_tws_mmk_pal)
  land_tws_mmk_pal = land_tws_mmk_pal[seq(1,25,2)[1:11]]
  
  source("/home/share/R_project/xinjiang_vapor/import_tws_mmk.R")
  twsmmk_land = import_tws_mmk()
  
  library(ggnewscale)
  hsr = shapefile('analysis_output/fig2/combine_sub_window.shp')
  china = shp_management('china')
  
  peo_country_inorder = read.csv('NC_mod_xinjiang/fig_human_impact/countrys_inorder.csv',
                                 header = T)
  peo_country_inorder = as.character(peo_country_inorder[,2])
  peo_country_inorder[1] = 'Bosnia and Herzegovina'
  i = 1:length(peo_country_inorder)
  match_neg_country <- function(i){
    tmp = which(neg_country$country == 
                  peo_country_inorder[i])
    if(length(tmp)>0){
      retdf = data.frame(
        country = peo_country_inorder[i],
        long = neg_country$long[tmp],
        lat = neg_country$lat[tmp],
        label = letters[i+6]
      )
      return(retdf)
    }
  }
  match_pos_country <- function(i){
    tmp = which(pos_country$country == 
                  peo_country_inorder[i])
    if(length(tmp)>0){
      retdf = data.frame(
        country = peo_country_inorder[i],
        long = pos_country$long[tmp],
        lat = pos_country$lat[tmp],
        label = letters[i+6]
      )
      return(retdf)
    }
  }
  neg_label = do.call(rbind,lapply(i,match_neg_country))
  pos_label = do.call(rbind,lapply(i,match_pos_country))
  
  map_label1 = data.frame(
    x = 100,
    y = 85,
    label = c('(e) Regions where TWS decline')
  )
  map_label2 = data.frame(
    x = 100,
    y = 85,
    label = c('(f) Regions where TWS increase')
  )
  library(ggrepel)
  pmap1 = ggplot()+
    geom_tile(data = twsmmk_land,
              aes(x = long,y= lat,fill = cuts),
              alpha = 0.5)+
    geom_polygon(data = world,
                 aes(x = long,y = lat,
                     group = group),
                 size = 0.25,
                 fill = 'transparent',
                 color = 'black')+
    geom_polygon(data = china,
                 aes(x = long,y = lat,
                     group = group),
                 size = 0.25,
                 fill = 'transparent',
                 color = 'black')+
    geom_polygon(data = hsr,
                 aes(x = long,y = lat,
                     group = group),
                 size = 0.5,
                 fill = 'transparent',
                 color = 'black')+
    geom_point(data = neg_country,
               aes(x = long,y = lat,
                   color = levels,
                   size = levels),shape = 16)+
    geom_text_repel(data= neg_label,
                    aes(x = long,y = lat,
                        label = paste0('(',label,')')),
                    size = 5,
                    color = 'black',
                    bg.color = 'white',
                    force = F,
                    bg.r = 0.15,
                    nudge_x = 8)+
    geom_text_repel(data= map_label1,
                    aes(x = x,y = y,
                        label = label),
                    size = 5,
                    color = 'black',
                    bg.color = 'white',
                    force = F,
                    bg.r = 0.15,
                    hjust = 0)+
    scale_color_manual(values = cols)+
    scale_fill_manual(values = land_tws_mmk_pal,
                      guide = guide_legend(
                        title = '(e-f) TWS_MMK_trend',
                        title.position = 'top',
                        nrow = 3
                      ))+
    scale_size_manual(values = sizes*2.5)+
    theme_bw()+
    theme(legend.position = 'none',
          panel.grid = element_blank())+
    ylab('Latitude')
  
  
  pmap2 = ggplot()+
    geom_tile(data = twsmmk_land,
              aes(x = long,y= lat,fill = cuts),
              alpha = 0.5,show.legend = F)+
    geom_polygon(data = world,
                 aes(x = long,y = lat,
                     group = group),
                 size = 0.25,
                 fill = 'transparent',
                 color = 'black')+
    geom_polygon(data = china,
                 aes(x = long,y = lat,
                     group = group),
                 size = 0.25,
                 fill = 'transparent',
                 color = 'black')+
    geom_polygon(data = hsr,
                 aes(x = long,y = lat,
                     group = group),
                 size = 0.5,
                 fill = 'transparent',
                 color = 'black')+
    geom_point(data = pos_country,
               aes(x = long,y = lat,
                   color = levels,
                   size = levels),shape = 16)+
    geom_text_repel(data= pos_label,
                    aes(x = long,y = lat,
                        label = paste0('(',label,')')),
                    size = 5,
                    color = 'black',
                    bg.color = 'white',
                    force = F,
                    bg.r = 0.15,
                    nudge_x = 8)+
    geom_text_repel(data= map_label2,
                    aes(x = x,y = y,
                        label = label),
                    size = 5,
                    color = 'black',
                    bg.color = 'white',
                    force = F,
                    bg.r = 0.15,
                    hjust = 0)+
    scale_color_manual(values = cols,
                       guide = guide_legend(
                         title = 'abs(a)-(abs(b)+abs(c))',
                         title.position = 'top',
                         ncol = 1
                       ))+
    scale_fill_manual(values = land_tws_mmk_pal,
                      guide = guide_legend(
                        title = 'TWS_MMK',
                        title.position = 'top',
                        nrow = 3
                      ))+
    scale_size_manual(values = sizes*2,
                      guide = guide_legend(
                        title = 'abs(a)-(abs(b)+abs(c))',
                        title.position = 'top',
                        ncol = 1
                      ))+
    theme_bw()+
    theme(legend.position = 'none',
          panel.grid = element_blank())+
    ylab('Latitude')
  
  # import line 
  linedf = as.data.frame(fread(
    'NC_mod_xinjiang/fig_human_impact/tws_freshwater_df.csv'
  ))
  pmedf = as.data.frame(fread(
    'NC_mod_xinjiang/fig_human_impact/pmedf.csv'
  ))
  pmedf_pos = pmedf
  pmedf_neg = pmedf[,-3]
  linedf_pos = linedf[which(linedf$type =='Increasing_TWS'),]
  linedf_neg = linedf[which(linedf$type == 'Declining_TWS'),]
  colnames(linedf_neg)
  
  pmedf_neg$var = 'PME-NATO3'
  pmedf_pos = reshape2::melt(pmedf_pos,'year')
  pmedf_pos$var = rep(c('PME-NATO3','PME-NATO4'),
                      each = 14)
  pmedf_pos = pmedf_pos[,-2]
  
  linedf_pos$var[which(linedf_pos$var == 'tws')] = "TWS"
  linedf_pos$var[which(linedf_pos$var == 'freshwater_withdraw')] =
    'TFW'
  linedf_neg$var[which(linedf_neg$var == 'tws')] = "TWS"
  linedf_neg$var[which(linedf_neg$var == 'freshwater_withdraw')] =
    'TFW'
  
  
  line_col = pal_lancet(alpha = 0.7)(9)[c(7,5,6,4)]
  show_col(line_col)
  
  line_col = c('TWS'= line_col[1],
                 'TFW'= '#79AF97FF',
                 #line_col[2],
                 'PME-NATO3' = line_col[4],
                 'PME-NATO4' = line_col[3]
               )
  
  pline1 = ggplot()+
    geom_line(data = linedf_neg,
              aes(x = year,y = value,
                  color = var),
              size = 1.3)+
    geom_line(data = pmedf_neg,
              aes(x = year,y = pmeato3,
                  color = var),
              size = 1.3)+
    scale_color_manual(values = line_col)+
    facet_wrap(~variable,nrow = 1)+
    theme_bw()+
    theme(legend.position = 'none')+
    theme(panel.grid = element_blank())
  
  pline2 = ggplot()+
    geom_line(data = pmedf_pos,
              aes(x = year,y = value,
                  color = var),
              size = 1.3)+
    geom_line(data = linedf_pos,
              aes(x = year,y = value,
                  color = var),
              size = 2)+
    
    scale_color_manual(values = line_col)+
    facet_wrap(~variable,nrow = 1)+
    theme_bw()+
    theme(legend.position = 'none')+
    theme(panel.grid = element_blank())
 
  linedf_com = rbind(linedf_neg,linedf_pos)
  pmedf_neg1 = rbind(pmedf_neg,pmedf_neg,
                     pmedf_neg,pmedf_neg,
                     pmedf_neg)
  pmedf_neg1$variable = rep(unique(linedf_neg$variable),
                            each = 14)
  pmedf_pos1 = rbind(pmedf_pos,pmedf_pos,
                     pmedf_pos,pmedf_pos)
  pmedf_pos1$variable = rep(unique(linedf_pos$variable),
                            each = 28)
  
  
  line_neg_contrs = unique(pmedf_neg1$variable)
  line_pos_contrs = unique(pmedf_pos1$variable)
  line_contrs = c(
    as.character(line_neg_contrs),
    as.character(line_pos_contrs)
  )
  write.csv(line_contrs,'NC_mod_xinjiang/fig_human_impact/countrys_inorder.csv')
  line_contrs[1] = 'BosHerz'
  pmedf_neg1$variable[which(pmedf_neg1$variable == 'Bosnia.and.Herzegovina')]=
    'BosHerz'
  linedf_com$variable[which(linedf_com$variable == 'Bosnia.and.Herzegovina')]=
    'BosHerz'
  
  for(i in 1:length(line_contrs)){
    tmpid1 = which(pmedf_neg1$variable == line_contrs[i])
    if(length(tmpid1)>0){
      pmedf_neg1$variable[tmpid1] = paste0(
        '(',letters[i+6],') ',pmedf_neg1$variable[tmpid1]
      ) 
    }
 
    
    tmpid2 = which(pmedf_pos1$variable == line_contrs[i])
    if(length(tmpid2)>0){
      pmedf_pos1$variable[tmpid2] = paste0(
        '(',letters[i+6],') ',pmedf_pos1$variable[tmpid2]
      ) 
    }
    
    
    tmpid3 = which(linedf_com$variable == line_contrs[i])
    if(length(tmpid3)>0){
      linedf_com$variable[tmpid3] = paste0(
        '(',letters[i+6],') ',linedf_com$variable[tmpid3]
      ) 
    }
    print(tmpid3)
  }
  line_contrs = paste0('(',letters[7:15],') ',
                       line_contrs)
  
  
  pmedf_pos1$variable = factor(pmedf_pos1$variable,
                               levels = line_contrs)
  pmedf_neg1$variable = factor(pmedf_neg1$variable,
                               levels = line_contrs)
  linedf_com$variable = factor(linedf_com$variable,
                               levels = line_contrs)
  
  pline3 = ggplot()+
    geom_line(data = pmedf_pos1,
              aes(x = year,y = value,
                  color = var),
              size = 1.3)+
    geom_line(data = pmedf_neg1,
              aes(x = year,y = pmeato3,
                  color = var),
              size = 1.3)+
    geom_line(data = linedf_com,
              aes(x = year,y = value,
                  color = var),
              size = 2)+
    scale_color_manual(values = line_col)+
    facet_wrap(~variable,nrow = 3)+
    scale_x_continuous(breaks = c(2003,2009,2015),
                       labels = c('2003','09','15'))+
    theme_bw()+
    theme(legend.position = 'none')+
    theme(panel.grid = element_blank())
  
  fontsize = 14
  text_theme = theme(
    legend.text  = element_text(size = fontsize,
                             color= 'black'),
    legend.title  = element_text(size = fontsize,
                                color= 'black'),
    
    axis.text = element_text(size = fontsize,
                             color= 'black'),
    axis.title.y = element_text(size = fontsize,
                             color= 'black'),
    axis.title.x = element_blank(),
    strip.text = element_text(size = fontsize,
                             color= 'black')
  )
  pbar = pbar+text_theme
  pmap1 = pmap1+text_theme
  pmap2 = pmap2 + text_theme
  pline1 =  pline1+text_theme
  pline2 = pline2 + text_theme
  pline3 = pline3+ text_theme+
    theme(axis.title.y = element_blank())
  pmap2= pmap2+theme(legend.position = 'none')
  library(cowplot)
  pcombine1 = plot_grid(
    pmap1,pmap2,
    rel_widths = c(1,1),
    ncol = 1
  )
  pcombine2 = plot_grid(
    pcombine1,pline3,
    rel_widths = c(1,1),
    rel_heights = c(1,1),nrow = 1
  )
  
  pcombine3 = plot_grid(
    pbar,pcombine2,
    rel_widths = c(1,1),
    rel_heights = c(1,2),ncol = 1
  )
  
  pos_country2 = pos_country
  pos_country2 = rbind(pos_country2,
                       pos_country2[11,])
  pos_country2$diff[which(pos_country2$diff>0.5)[1]] = 
    pos_country2$diff[which(pos_country2$diff>0.5)[1]]+0.25
  pos_country2$levels = cut(pos_country2$diff,
                            breaks = c(seq(-1,1,0.25)))
  pmap3 = ggplot()+
    ######
    geom_tile(data = twsmmk_land,
                    aes(x = long,y= lat,fill = cuts),
                    alpha = 0.5,show.legend = F)+
    geom_polygon(data = world,
                 aes(x = long,y = lat,
                     group = group),
                 size = 0.25,
                 fill = 'transparent',
                 color = 'black')+
    geom_polygon(data = china,
                 aes(x = long,y = lat,
                     group = group),
                 size = 0.25,
                 fill = 'transparent',
                 color = 'black')+
    geom_polygon(data = hsr,
                 aes(x = long,y = lat,
                     group = group),
                 size = 0.5,
                 fill = 'transparent',
                 color = 'black')+
    geom_point(data = pos_country2,
               aes(x = long,y = lat,
                   color = levels,
                   size = levels),shape = 16)+
    geom_text_repel(data= pos_label,
                    aes(x = long,y = lat,
                        label = paste0('(',label,')')),
                    size = 5,
                    color = 'black',
                    bg.color = 'white',
                    force = F,
                    bg.r = 0.15,
                    nudge_x = 8)+
    scale_color_manual(values = cols,
                       guide = guide_legend(
                         title = '',
                         title.position = 'top',
                         ncol = 1
                       ))+
    scale_fill_manual(values = land_tws_mmk_pal,
                      guide = guide_legend(
                        title = 'TWS_MMK',
                        title.position = 'top',
                        nrow = 3
                      ))+
    scale_size_manual(values = sizes*2,
                      guide = guide_legend(
                        title = '',
                        title.position = 'top',
                        ncol = 1
                      ))+
    theme_bw()+
    theme(legend.position = 'none',
          panel.grid = element_blank())+
    ######
    ylab('Latitude')
  library(ggpubr)
  ppoint_legnd = as_ggplot(
    get_legend(pmap3 + text_theme+theme(legend.position = 'bottom')+
                 guides(color = guide_legend(
                   title = '(e-f) abs(a) - (abs(b)+abs(c))',
                   title.position = 'top',nrow = 2),
                   size = guide_legend(
                     title = '(e-f) abs(a) - (abs(b)+abs(c))',
                     title.position = 'top',nrow = 2)))
  )
  
  pline_legnd = as_ggplot(
    get_legend(pline3 + theme(legend.position = 'bottom')+
                 guides(color  =guide_legend(title = '(g-o) Normalized annual indices',
                                             title.position = 'top',nrow = 1)))
  )
  
  pbar_legend = as_ggplot(
    get_legend(pbar + theme(legend.position = 'bottom')+
                 guides(fill  =guide_legend(title = '(a-d) Coefficient for each factor',
                                             title.position = 'top',nrow = 1)))
  )
  
  pmap1_legnd = as_ggplot(
    get_legend(pmap1 + theme(legend.position = 'right'))
  )
  
  dir.create('NC_mod_xinjiang/main_plot')
  dir.create('NC_mod_xinjiang/main_plot/fig_human')
  
  png('NC_mod_xinjiang/main_plot/fig_human/fig_main.png',
      height = 27,
      width = 27,
      units = 'cm',
      res = 800)
  print(pcombine3)
  dev.off()
  
  png('NC_mod_xinjiang/main_plot/fig_human/line_leg.png',
      height = 27,
      width = 27,
      units = 'cm',
      res = 800)
  print(pline_legnd)
  dev.off()
  
  png('NC_mod_xinjiang/main_plot/fig_human/bar_leg.png',
      height = 27,
      width = 27,
      units = 'cm',
      res = 800)
  print(pbar_legend)
  dev.off()
  
  png('NC_mod_xinjiang/main_plot/fig_human/ppoint_legnd.png',
      height = 27,
      width = 27,
      units = 'cm',
      res = 800)
  print(ppoint_legnd)
  dev.off()
  
  png('NC_mod_xinjiang/main_plot/fig_human/pmap1_legnd.png',
      height = 27,
      width = 27,
      units = 'cm',
      res = 800)
  print(pmap1_legnd)
  dev.off()
}
fig1_plot_xinjiang_vapor <-function(
  
){
  # Fig 1 
  # (a) Long term Contribution Rates
  # (b) Study Area Regionalization 
  # (c) Monthly pattern of contribution 
  source('/home/share/R_project/xinjiang_vapor/calc_long_term_contri.R')
  #calc_long_term_contri()
  print('long term mean of contri. has been calculated')
  source('/home/share/R_project/xinjiang_vapor/calc_cluster_traj.R')
  print('calc of traj has been done!')
  #calc_cluster_traj()
  
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management("world")
  world = crop(world,extent(-180,180,0,90))
  
  xj = shp_management('xinjiang')
  
  
  
  # import data
  # fig 1a contribution and route
  input_long_term_contr = 'analysis_output/long_term_mean_contr_raster.csv'
  long_term_contr = fread(input_long_term_contr)
  long_term_contr = as.data.frame(long_term_contr)
  naid = which(is.na(long_term_contr$contr_rate))
  long_term_contr = long_term_contr[-naid,]
  source('/home/share/R_project/xinjiang_vapor/cluster_whole_time_traj.R')
  #cluster_traj_df = cluster_whole_time_traj()
  cluster_traj_df = fread('analysis_output/fig2/cluster_traj_df.csv')
  cluster_traj_df = as.data.frame(cluster_traj_df)
  # fig 1a sub
  input_contr_by_sou = 'analysis_output/contr_in_source_variance_new.csv'
  contr_by_sou = as.data.frame(fread(input_contr_by_sou))
  
  sou_names = contr_by_sou[,1]
  contr_by_sou = contr_by_sou[,-1]
  
  contr_by_sou_mean = apply(contr_by_sou,1,mean,na.rm= T)
  contr_by_sou_mean = as.numeric(contr_by_sou_mean)
  
  sou_names[2]= 'nato'
  bar_df = data.frame(source = sou_names,
                      contr_rates = contr_by_sou_mean)
  
  idorder = order(bar_df$contr_rates,decreasing = T)
  bar_df = bar_df[idorder,]
  bar_df$contr_rates[which(bar_df$contr_rates<0)] = 0
  
  # fig 1b study area dem
  dem = raster('dem/dem.nc')
  dem = crop(dem,xj)
  dem = as.data.frame(dem,xy = T)
  naid = which(is.na(dem$dem))
  dem = dem[-naid,]
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  south_xj = shp_management('xinjiang_south')
  north_xj = shp_management('xinjiang_north')
  
  xj = shp_management('xinjiang')
  ex_xinjiang = extent(xj)
  ex_xinjiang = round(ex_xinjiang)
  ex_xinjiang[c(1,3)] = ex_xinjiang[c(1,3)]-0.5
  ex_xinjiang[c(2,4)] = ex_xinjiang[c(2,4)]+0.5
  
  border = as(ex_xinjiang,'SpatialPolygons')
  crs(border) = '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'
  
  #ex_xinjinang_shp = as(ex_xinjiang,'SpatialPolygon')
  world_crop = crop(world,ex_xinjiang)
  china = shp_management('china')
  china_crop = crop(china,ex_xinjiang)
  # fig 
  
  # import shp
  ######
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management("world")
  world = crop(world,extent(-180,180,0,90))
  
  xj = shp_management('xinjiang')
  
  
  # color set
  
  # plot set 
  fontsize = 12
  plot_set = theme(panel.background = element_rect(fill = 'transparent',color = 'black'),
                   axis.text = element_text(face='bold',colour='black',size=fontsize,hjust=.5),
                   axis.title = element_text(face='bold',colour='black',size=fontsize,hjust=.5),
                   legend.position=c('bottom'),
                   legend.direction = c('horizontal'))
  
  # plot zone
  library(RColorBrewer)
  fillcolor = colorRampPalette(brewer.pal(11,'Blues'))(14)
  fillcolor = fillcolor[3:14]
  
  #lincolor = colorRampPalette(pal_lancet('lanonc',0.8)(9))(20)
  lincolor = colorRampPalette(brewer.pal(9,'Spectral'))(20)
  #lincolor = rev(lincolor)
  linecol_manual = c('AS' = lincolor[1],
                     'EU' = lincolor[2],
                     'ATO' = lincolor[3],
                     'CS' = lincolor[5],
                     'MS' = lincolor[6],
                     'NA' = lincolor[10])
  
  sizemanual = c('AS'= 2,
                 'EU'=1.5,
                 'ATO'=1,
                 "CS" = 0.5,
                 "MS" = 0.5,
                 'NA' = 0.25)
  
  cluster_traj_df$region = factor(cluster_traj_df$region,
                                  levels = c('AS',"EU",'ATO',
                                             "CS",'MS','NA'))
  p1 = ggplot()+
    #############
    geom_tile(data = long_term_contr,aes(x = x,y = y,fill = cuts),
              alpha = 0.5)+
    geom_polygon(data = world,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 0.5)+
    geom_polygon(data = xj,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 0.5)+
    geom_polygon(data = border,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 0.5)+
    geom_path(data = cluster_traj_df,aes(x = long,y = lat,
                                         group = routeid,
                                         color = factor(routeid)),
              size = 1,
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="closed"))+
    #scale_fill_gradientn(colors = mycolor)+
    scale_fill_manual(values = fillcolor)+
    scale_color_manual(values = lincolor)+
    #scale_size_manual(values = sizemanual)+
    #facet_wrap(~type,nrow = 4)+
    #coord_fixed(1.3)+
    guides(color = guide_legend(title= "Trajectory"),
           size = guide_legend(title= "Trajectory"),
           fill = guide_legend(title= "Contribution rate (1/10000000)"))+
    #facet_wrap(~type,nrow = 3,scales = 'free')+
    theme_bw()+
    plot_set+
    theme(legend.position = 'none')+
    xlab('Longitude')+
    ylab('Latitude')
  #############
    
  
  bar_df$source = toupper(bar_df$source)
  bar_df$source = factor(bar_df$source,levels = bar_df$source)
  barcolor = colorRampPalette(brewer.pal(11,'Spectral'))(14)
  #barcolor = colorRampPalette(pal_lancet('lanonc',1)(9))(13)
  barcolor = c('AS' = barcolor[1],
               'EU' = barcolor[2],
               'NATO' = barcolor[3],
               'NAF' = barcolor[4]) 
  bar_df = bar_df[1:4,]
  
  label_df = data.frame(
    x = bar_df$source,
    y = bar_df$contr_rates +5,
    z = paste0(round(bar_df$contr_rates,1),'%')
  )
  p1a = ggplot()+
    ######
    geom_bar(data = bar_df,aes(x = source, y = contr_rates,
                               fill = source),stat = 'identity',
             position = 'dodge',width = 0.6,alpha = 0.8)+
    scale_fill_manual(values = barcolor)+
    geom_text(data = label_df,
                    aes(x = x,y = y,label = z),
                    color = 'black',size = 3,hjust =0.5)+
    theme_bw()+
    plot_set+
    theme(
          legend.position = 'none',
          panel.border = element_rect(fill = 'transparent',
                                      color = 'transparent'),
          axis.title = element_text(size = 5,color = 'black',
                                    hjust = 0.5),
          panel.background = element_rect(fill = 'transparent',
                                          color = 'transparent'),
          panel.grid =element_blank(),
          axis.text = element_text(size = 5,color = 'black',hjust = 0.5),
          axis.line.x = element_line(color= 'black',size = 0.5))+
    xlab('Source region')+
    ylab('Contribution rate (%)')
    #scale_fill_aaas(0.5)+
    #scale_fill_lancet()+
  ######
  
  library(gridExtra)
  library(cowplot)
  
  p1combine =  ggdraw()+
    draw_plot(p1)+
    draw_plot(p1a, x = 0.07, y = 0.37,
              width = 0.3, height = 0.15)
  
  #p1combine
  
  # p2 spatial pattern of dem
  p1b = ggplot()+
    #####
    geom_tile(data = dem,aes(x = x,y = y,fill = dem),
              color = 'transparent')+  
    geom_polygon(data = south_xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = north_xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    
    geom_polygon(data = south_moun,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = north_moun,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    scale_fill_distiller(palette = 'Spectral')+
    geom_path(data = cluster_traj_df,aes(x = long,y = lat,
                                         group = routeid,
                                         color = factor(routeid)),
              size = 1,
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="closed"))+
    #scale_fill_gradientn(colors = mycolor)+
    #scale_fill_manual(values = fillcolor)+
    scale_color_manual(values = lincolor)+
    
    scale_x_continuous(limits = ex_xinjiang[1:2])+
    scale_y_continuous(limits = ex_xinjiang[3:4])+
    guides(color = 'none')+
    #coord_fixed(1.3)+
    theme_bw()+
    plot_set+
    theme(axis.title.y = element_blank())+
    theme(legend.position = 'none')+
    xlab('Longitude')+
    ylab('Latitude')
  #####
  
  # p3 variation of line
  input_long_term_contr = 'analysis_output/contr_in_source_variance_new.csv'
  contr_df = fread(input_long_term_contr)
  contr_df = as.data.frame(contr_df)

  sou_names = toupper(contr_df[,1])
  
  contr_df = contr_df[,-1]
  contr_df[10,] = 0
  contr_full_sum = apply(contr_df,2,sum,na.rm = T)
  contr_chos = contr_df[c(2,9,11),]
  contr_chos = apply(contr_chos,2,sum,na.rm = T)
  
  contr_chos = as.numeric(contr_chos)
  contr_full = as.numeric(contr_full_sum)

  ratio = contr_chos/ contr_full_sum * 100
  
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),
             '1 month')
  dfcontr = data.frame(date,contr_full,contr_chos)
  dfcontr = melt(dfcontr,'date')
  
  dfratio = data.frame(date,contr_chos,ratio)
  dfratio = dfratio[which(dfratio$ratio>=80),]
  
  dfratio$label = paste0(round(dfratio$ratio,1),
                         '%')
  
  
  dfratio90 = dfratio[which(dfratio$ratio>=90),]
  
  label_df2 = data.frame(
    x = as.Date('2015-01-01'),
    y = 18,
    label = paste0('')
  )
  library(ggrepel)
  line1c = pal_lancet(alpha = 1)(2)
  color_value = c('contr_full' = line1c[2],
                  'contr_chos' = line1c[1])
  p1c = ggplot()+
    geom_line(data= dfcontr,aes(x= date,y = value,
                                color = variable))+
    geom_point(data = dfratio,aes(x = date,y = contr_chos),
               size = 3,shape = 1,
               color = 'blue')+
    geom_text(data = label_df2,
                    aes(x = x,y = y,label = label),
                    color = 'blue',
                    size = 5)+
   # geom_text_repel(data = dfratio,aes(x = date,
    #                                   y = contr_chos,
    #                                   label = label),
    #                color = 'black',
    #                size = 3,
    #                check_overlap = T)+
               
    #scale_fill_manual(values= tilecolor)+
    #scale_fill_manual(values = barcolor)+
    #scale_y_continuous(position = 'right')+
    scale_color_manual(values =color_value,
                       labels = c('TCR','CR(AS+EU+NATO)'))+
    theme_bw()+
    plot_set+
    theme(legend.position = 'none')+
    xlab('Time (month)')+
    ylab('Contribution rate (continent scale)')
  
  
  
  p1ab = plot_grid(p1,p1b,align = 'h',
                   axis = 'tb',nrow = 1,
                   rel_widths = c(3,1.4),
                   rel_heights = c(1,1),labels = c('','(b)'),
                   label_x = c(0.10,0.15),
                   label_y = c(0.98,0.98))
  p1abc3 = plot_grid(p1ab,p1c,align = 'h',
                    axis = 'l',nrow = 2,
                    rel_widths = c(1,1),
                    rel_heights = c(1.3,1),labels = c('(a)','(c)'),
                    label_x = c(0.065,0.065),
                    label_y = c(0.965,0.98))
  
  p1a = p1a+
    theme(plot.background = element_rect(fill = 'transparent'),
          axis.text = element_text(size = 10,color = 'black',
                                   hjust = 0.5),
          axis.title = element_blank())
  
  p1abc_sub = ggdraw()+
    draw_plot(p1abc3)+
    draw_plot(p1a, x = 0.058, y = 0.57,
              width = 0.18, height = 0.19)
  
  
  png('main_plot/fig1/fig1abc5.png',
      height = 18,
      width = 25,
      units = 'cm',
      res = 800)
  print(p1abc_sub)
  dev.off()
  
  legend_theme = theme(legend.position = 'bottom',
                       legend.background = element_rect(fill = 'transparent',
                                                        color = 'transparent'),
                       legend.text = element_text(color = 'black',size = fontsize),
                       legend.title = element_text(color = 'black',size = fontsize,face = 'bold'))
                
  library(ggpubr)
  p1_legend = p1+
    legend_theme+
    guides(fill = guide_legend(title = 'Contribution rates of particles',nrow = 2),
           color = 'none')
  p1_legend = get_legend(p1_legend)
  p1_legend = as_ggplot(p1_legend)
  #
  png('main_plot/fig1/fig1a_legend.png',
      height = 18,
      width = 25,
      units = 'cm',
      res = 800)
  print(p1_legend)
  dev.off()
  
  p2_legend = p1b+
    legend_theme+
    guides(color = 'none',
           fill = guide_legend(title = 'DEM (m)',
                               label.position = 'right'))+
    theme(legend.text = element_text(color = 'black',size = 8))+
    theme(legend.title = element_text(color = 'black',size = 8,
                                      face = 'bold'))
  p2_legend = get_legend(p2_legend)
  p2_legend = as_ggplot(p2_legend)
  
  png('main_plot/fig1/fig1b_legend.png',
      height = 0.7,
      width = 7,
      units = 'cm',
      res = 800)
  print(p2_legend)
  dev.off()
  
  
  p3_legend = p1c +
    legend_theme+
    guides(color = guide_legend(title = 'Sum of contribution rates'))
  
  p3_legend = as_ggplot(get_legend(p3_legend))
  png('main_plot/fig1/fig1c_legend.png',
      height = 18,
      width = 25,
      units = 'cm',
      res = 800)
  print(p3_legend)
  dev.off()
  
  
    
  
  source('/home/share/R_project/xinjiang_vapor/traj_plot_fun.R')
  
  
  # p3 
  
  
  
  p1b+theme(legend.position = 'bottom')+legend_theme+
    #theme(legend.key.width = unit(2,'cm'))+
    guides(fill= guide_legend(title = 'DEM (m)',
                              keywidth = unit(2,'cm'),
                              label.position = 'bottom'),color = 'none')
  
  
  
  
  
  
  
  
  
  
  
}
fig2_backup_plot_tws_mmk<-function(
  
){
  library(ggnewscale)
  library(ggplot2)
  library(raster)
  
  # import world shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management('world')
  world = crop(world,extent(c(-180,180,0,90)))
  shp_as = shp_management('land','as')
  shp_eu = shp_management('land','eu')
  shp_naf = shp_management('land','naf')
  shp_as_eu = bind(shp_as,shp_eu,shp_naf)
  
  shp_oce = list.files('cluster_shp/ato',
                       full.names = T,
                       pattern = '*.shp$')[1:4]
  shp_oces = lapply(shp_oce,shapefile)
  shp_oce = do.call('bind',lapply(shp_oce,shapefile))
  # import sub windows 
  shp_com = shapefile('analysis_output/fig2/combine_sub_window.shp')
  input = paste0('sub_windows/sub_window',1:19,'.shp')
  shp_sep = lapply(input,shapefile) 
  # import tws land mmk
  #twsmmk_land = fread('analysis_output/fig2/tws_mmk_df.csv')
  #twsmmk_land = as.data.frame(twsmmk_land)
  twsmmk_land = raster('analysis_output/tws_mmk.nc')
  twsmmk_land = mask(twsmmk_land,shp_as_eu)
  
  mmksst = shapefile('analysis_output/fig2/sst_big0.shp')
  
  
  
  ex_as_ato = extent(shp_as_eu)
  ex_as_ato = extent(-50,ex_as_ato[2],ex_as_ato[3],
                     ex_as_ato[4])
  
  twsmmk_land = crop(twsmmk_land,ex_as_ato)
  twsmmk_land = as.data.frame(twsmmk_land,
                              xy = T)
  colnames(twsmmk_land) = c('long','lat',"value")
  lesszerotws = which(twsmmk_land$value<0)
  twsmmk_land = twsmmk_land[lesszerotws,]

  twsmmk_land$cuts = cut(twsmmk_land$value,
                         breaks = c(-700,seq(-20,0,2)))
  
  pme_ocean = raster('analysis_output/fig2/pme_ato_mmk.nc')
  pme_oceandf = as.data.frame(pme_ocean,xy = T)
  dfnaid = which(is.na(pme_oceandf[,3]))
  pme_oceandf = pme_oceandf[-dfnaid,]
  negid = which(pme_oceandf[,3]<0)
  pme_oceandf = pme_oceandf[negid,]
  
  colnames(pme_oceandf) = c('long','lat','value')
  pme_oceandf$cuts = cut(pme_oceandf$value,
                         breaks = c(-42,seq(-10,0,2)))
  library(ggnewscale)
  library(RColorBrewer)
  
  cobreaks = c(-700,-42,seq(-20,-12,2),
             seq(-10,0,1))
  
  land_tws_mmk_pal = colorRampPalette(
    brewer.pal(9,'YlOrRd'))(25)
  land_tws_mmk_pal = rev(land_tws_mmk_pal)
  land_tws_mmk_pal = land_tws_mmk_pal[seq(1,25,2)[1:11]]
  
  sea_pme_mmk_pal = colorRampPalette(
    brewer.pal(9,'YlOrRd')
  )(25)
  #sea_pme_mmk_pal = sea_pme_mmk_pal[1:]
  sea_pme_mmk_pal = rev(sea_pme_mmk_pal)
  sea_pme_mmk_pal = sea_pme_mmk_pal[seq(1,25,2)[c(2,7:11)]]
  
  # main plot
  fontsize = 12
  text_theme_set = theme(
    axis.text = element_text(
                             color = 'black',
                             size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
                               color = 'black',
                               size = fontsize),
    legend.title = element_text(
                                color = 'black',
                                size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  
  cluster_traj_df = fread('analysis_output/fig2/cluster_traj_df.csv')
  cluster_traj_df = as.data.frame(cluster_traj_df)
  route_col = pal_npg()(10)[4]
  route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
  
  route_col = colorRampPalette(brewer.pal(
    9,'Blues'
  ))(20)
  
  cur_df = as.data.frame(
    fread('analysis_output/fig4/current_df.csv')
  )
  
  idless50 = which(cur_df$lat <= 50)
  cur_df = cur_df[idless50,]
  
  idbig1 = which(cur_df$u>0 &
                   cur_df$v >0)
  idbig2 = which(cur_df$u<0 &
                   cur_df$v >0)
  
  cur_df1 = cur_df[idbig1,]
  cur_df2 = cur_df[idbig2,]
  
  cid1 = seq(1,nrow(cur_df1),30)
  cid2 = seq(1,nrow(cur_df2),200)
  
  cur_df1 = cur_df1[cid1,]
  cur_df2 = cur_df2[cid2,]
  
  
  cols_cur = c('#2988AE','#30376E')
  
  xj = shp_management('xinjiang')
  
  cal_center_point <- function(x){
    xm = extent(x)
    latm = round((xm[3]+xm[4])/2)
    longm = round((xm[1]+xm[2])/2)
    rm = data.frame(x = longm,y = latm)
    return(rm)
  }
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  dfhigh_label = lapply(shp_sep[id_box],cal_center_point)
  dfato_label = lapply(shp_oces,cal_center_point)
  
  
  dfhigh_label = do.call(rbind,dfhigh_label)
  dfato_label = do.call(rbind,dfato_label)
  
  dfhigh_label$label = paste0('(',letters[1:10],')')
  dfato_label$label = paste0('NATO',1:4)
  
  
  sst_col = pal_npg(alpha = 0.5)(9)[1]
  pmmk2 = ggplot()+
    ###############
    geom_polygon(data = world,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    
    geom_tile(data = twsmmk_land,
             aes(x = long,y= lat,fill = cuts))+
    geom_polygon(data = xj,
                 aes(x = long,y= lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    scale_fill_manual(values = land_tws_mmk_pal,
                      guide = guide_legend(
                        title = 'TWS_MMK',
                        title.position = 'top',
                        nrow = 2
                      ))+
    new_scale_fill()+
    geom_tile(data = pme_oceandf,
              aes(x = long,y = lat,fill = cuts))+
    scale_fill_manual(values = sea_pme_mmk_pal)+
    geom_path(data = cluster_traj_df,aes(x = long,y = lat,
                                         group = routeid,
                                         color = factor(
                                           routeid,
                                           levels = 1:20
                                         )),
              size = 1,
              linetype = 'solid',
              #color = route_col[5],
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="open"))+
    scale_color_manual(values = route_col,
                       guide = 'none')+
    geom_polygon(data = shp_com,
                 aes(x = long,y = lat,group =group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    #geom_polygon(data = mmksst,
    #             aes(x = long,y = lat,
    #                 group = group),
    #             fill =  land_tws_mmk_pal[5],
    #             #color = land_tws_mmk_pal[5],
    #             alpha = 0.1)+
    geom_text_repel(data = dfhigh_label,
              aes(x = x,y = y,label = label),
              size = 3.5,
              color = 'black',
              bg.color = 'white',
              bg.r = 0.25,
              force = F)+
    geom_segment(data = cur_df1,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.15,'cm'),
                               type = 'open'),
                 color = cols_cur[1])+
    geom_segment(data = cur_df2,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.2,'cm'),
                               type = 'open'),
                 color = cols_cur[2])+
    guides(fill = 
             guide_legend(title = 'PME_ATO_MMK',
                          title.position = 'top',
                          nrow = 2))+
    theme_bw()+
    text_theme_set+
    ###############
    xlab('Longitude')+
    ylab('Latitude')
  
  world_crop = crop(world,extent(shp_oce))
  pmmk_oce = ggplot()+
    
    geom_polygon(data = shp_oce,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    #geom_polygon(data = mmksst,
    #             aes(x = long,y = lat,
    #                 group = group),
    #             fill =  land_tws_mmk_pal[5],
                 #color = land_tws_mmk_pal[5],
    #             alpha = 0.1)+
    geom_tile(data = pme_oceandf,
              aes(x = long,y = lat,fill = cuts))+
    geom_text_repel(data = dfato_label,
                    aes(x = x,y = y,label = label),
                    size = 2.7,
                    color = 'black',
                    bg.color = 'white',
                    bg.r = 0.25,
                    force = F)+
    scale_fill_manual(values = sea_pme_mmk_pal,
                      guide = 'none')+
    xlim(c(extent(shp_oce)[1],
           extent(shp_oce)[2]))+
    
    theme_bw()+
    theme(
      axis.text = element_text(
        color = 'black',
        size = 10
      ),
      axis.title =  element_blank()
    )
    
  # line plot 
  source('/home/share/R_project/xinjiang_vapor/cor_analysis_sub_windowtws_atope.R')
  ret_box1 = cor_analysis_sub_windowtws_atope(mode ='ato1')
  ret_box2 = cor_analysis_sub_windowtws_atope(mode ='ato2')
  ret_box3 = cor_analysis_sub_windowtws_atope(mode ='ato3')
  ret_box4 = cor_analysis_sub_windowtws_atope(mode ='ato4')
  
  pme_oce = data.frame(
    PME_ATO1= ret_box1[[1]],
    PME_ATO3= ret_box3[[1]]
    #pme_ato3= ret_box3[[1]],
    #pme_ato4= ret_box4[[1]]
  )
  colnames_land = paste0('sub_window',1:10)
  twsland_df = as.data.frame(ret_box1[[2]])
  colnames(twsland_df) = paste0('HSW',1:10)
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),
             '1 month')
  date = date[1:174]
  date = date[-c(1:6,169:174)]
  
  pme_oce_df = data.frame(
    date = date,
    pme_oce
  )
  pme_oce_df = reshape2::melt(pme_oce_df,'date')
  
  colnames(twsland_df) = paste0('HSW',1:10)
  
  twsland_df1 = data.frame(
    date,
    twsland_df[,1:5]
  )
  twsland_df2 = data.frame(
    date = date,
    twsland_df[,6:10]
  )
  
  twsland_df1 = reshape2::melt(twsland_df1,'date')
  twsland_df2 = reshape2::melt(twsland_df2,'date')
  
  twsland_df1$type = twsland_df1$variable
  twsland_df2$type = twsland_df2$variable
  
  library(ggsci)
  #pals1 = pal_lancet(alpha = 1)(9)
  pals2 = pal_lancet(alpha = 0.8)(9)
  twscol = pals2[7]
  pmecol = c(pals2[1],pals2[3])
  
  twsland_df1$color = 'TWS'
  twsland_df2$color = 'TWS'
  pme_oce_df$color = pme_oce_df$variable
  
  pline1 = ggplot()+
    geom_line(data = twsland_df1,
              aes(x = date,y = value,
                  color = color),
              size = 2)+
    geom_line(data = pme_oce_df,
              aes(x = date,y= value,color = color)
              ,size = 1)+
    scale_color_manual(values = c(pmecol,twscol))+
    facet_wrap(~type,nrow = 1)+
    theme_bw()+
    text_theme_set
  
  pline2 = ggplot()+
    geom_line(data = twsland_df2,
              aes(x = date,y = value,
                  color = color),
              size = 2)+
    geom_line(data = pme_oce_df,
              aes(x = date,y= value,color = color)
              ,size = 1)+
    scale_color_manual(values = c(pmecol,twscol))+
    facet_wrap(~type,nrow = 1)+
    theme_bw()+
    text_theme_set
  
  Sub_name = paste0('HSW',1:10)
  # side point cor plot
  side_cor_df = data.frame(
    Sub_windows = paste0('HSW',1:10),
    ATO1_COR = ret_box1[[4]],
    ATO2_COR = ret_box2[[4]],
    ATO3_COR = ret_box3[[4]],
    ATO4_COR = ret_box4[[4]]
  )
  
  side_cor_df = reshape2::melt(side_cor_df,
                               'Sub_windows')
  side_cor_df$Sub_windows = 
    factor(side_cor_df$Sub_windows,
           levels = rev(Sub_name))
  
  point_pal = colorRampPalette(pal_lancet(alpha = 0.8)(9))(10)
  #point_pal = pals2[1:10]
  
  side_cor_df_mean = aggregate(side_cor_df$value,
                               list(side_cor_df$variable),
                               mean)
  colnames(side_cor_df_mean) = c("variable",
                                 'value')
  side_cor_df_mean$label = 
    round(side_cor_df_mean$value,2)
  
  library(ggrepel)
  pside = ggplot()+
    #############
    geom_point(data = side_cor_df,
               aes(y = variable,
                   x = value,
                   color = factor(Sub_windows,
                                  levels = Sub_name)),
               size = 9-4,
               shape = 1)+
    
    geom_point(data = side_cor_df,
               aes(y = variable,
                   x = value,
                   color = factor(Sub_windows,
                                  levels = Sub_name)),
               size = 8.75-4,
               shape = 1)+
    geom_point(data = side_cor_df,
               aes(y = variable,
                   x = value,
                   color = factor(Sub_windows,
                                  levels = Sub_name)),
               size = 9.25-4,
               shape = 1)+
    geom_point(data = side_cor_df,
               aes(y = variable,
                   x = value,
                   color = factor(Sub_windows,
                                  levels = Sub_name)),
               size = 8.50-4,
               shape = 1)+
    geom_text_repel(data = side_cor_df_mean,
                    aes(y = variable,
                        x = value,
                        label = label),
                    nudge_y = 0.25,
                    size = 4,
                    hjust = 0.5)+
    #############
    scale_y_discrete(labels = c('ATO1','ATO2','ATO3','ATO4'))+
    theme_bw()+
    text_theme_set+
    #scale_size_manual('',values = c(3,5,7,9,11))+
    #scale_size_continuous(range = c(1,15))+
    scale_color_manual('',values = point_pal)+
    guides(color = guide_legend(title = 'Cross Correlation',
                                title.position = 'top'))
  
  
  
  library(cowplot)
  pline1 = pline1+theme(legend.position = 'none')
  pline2 = pline2+theme(legend.position = 'none')
  pmmk2 = pmmk2 +theme(legend.position = 'none')
  
  pline1 = pline1+
    theme(axis.text.y = element_text(hjust = 0.5,
                                     angle = 90))
  
  pline2 = pline2+
    theme(axis.text.y = element_text(hjust = 0.5,
                                     angle = 90))
  pmmk2 = pmmk2+
    theme(axis.text.y = element_text(hjust = 0.5,
                                     angle = 90))
  
  
  dfsubs_line1 = data.frame(
    x = rep(as.Date('2005-01-01'),5),
    y = rep(-0.45,5),
    label = paste0('(',letters[1:5],')'),
    type = paste0('HSW',1:5)
  )
  
  dfsubs_line2 = data.frame(
    x = rep(as.Date('2005-01-01'),5),
    y = rep(-0.45,5),
    label = paste0('(',letters[8:12],')'),
    type = paste0('HSW',6:10)
  )
  
  
  dfsubs_tws = data.frame(
    x = -175,
    y = 80,
    label = "(g)"
  )
  
  dfside = data.frame(
    x = 0.75,
    y = 'ATO4',
    label = '(f)'
  )
  
  pline1 = pline1+
    geom_text(data = dfsubs_line1,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black')+ylab('Indices')+
    xlab('Time (month)')
     #+theme(axis.title.x = element_blank())
  
  pline2 = pline2+
    geom_text(data = dfsubs_line2,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black')+xlab('Time (month)')+ylab('Indices')
   #+theme(axis.title.x = element_blank())
  
  pmmk2 = pmmk2+
    geom_text(data = dfsubs_tws,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black')
 
  
  
  p1 = plot_grid(pline1,pmmk2,pline2,
            align = 'hv',
            axis = 'lr',
            rel_widths = c(1,1,1),
            rel_heights = c(3,6,3),
            ncol = 1)
  pside = pside+theme(
    #axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_text(face = 'bold',
                               color= 'black',
                               size = fontsize,
                               hjust = 0.5,
                               angle = 90),
    #axis.text.y = element_blank(),
    legend.position = 'none')+
    xlab('Cross correlation')

  
  p12 = plot_grid(p1,pside,
                  align = 'v',
                  axis = 'b',
                  rel_widths = c(6,2),
                  rel_heights = c(1,1),
                  nrow = 1)
  
  library(gridExtra)
  p123 = ggdraw()+
    draw_plot(p12)+
    draw_plot(pmmk_oce,x = 0.08, y = 0.33,
              width = 0.16, height = 0.22)
  
  
  legend_line = get_legend(pline1+
                             theme(legend.position = 'bottom')+
                             guides(color = guide_legend(nrow = 1,
                                                         title = 'Indices',
                                                         title.position = 'top')))
  
  legend_map = get_legend(pmmk2+
                            theme(legend.position = 'bottom'))
  
  legend_side = get_legend(pside+
                             theme(legend.position = 'bottom'))
  
  library(ggpubr)
  legend_line = as_ggplot(legend_line)
  legend_map = as_ggplot(legend_map)
  legend_side = as_ggplot(legend_side)
  
  legend_line = legend_line+
    theme(plot.margin = unit(rep(0,4),'cm'))
  legend_map = legend_map+
    theme(plot.margin = unit(rep(0,4),'cm'))
  legend_side = legend_side+
    theme(plot.margin = unit(rep(0,4),'cm'))
  
  
  
  legs1 = plot_grid(legend_side,legend_line,
                    nrow = 1,
                    rel_heights = c(1,1))
  
  p4 = plot_grid(
    p123,legend_map,legs1,
    ncol = 1,
    rel_heights = c(10,1,1)
  )
  
  png('main_plot/fig2/fig2_final_mod3.png',
      height = 26,
      width = 27,
      units = 'cm',
      res = 800)
  print(p4)
  dev.off()
  
  
  png('main_plot/fig2/leg1.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(legend_line)
  dev.off()
  
  png('main_plot/fig2/leg2.png',
      height = 20,
      width = 30,
      units = 'cm',
      res = 800)
  print(legend_map)
  dev.off()
  
  png('main_plot/fig2/leg3.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(legend_side)
  dev.off()
  
  
}
fig2_line_plot_significance <- function(
  
){
  source('/home/share/R_project/xinjiang_vapor/cor_analysis_sub_windowtws_atope.R')
  ret_box1 = cor_analysis_sub_windowtws_atope(mode ='ato1')
  ret_box2 = cor_analysis_sub_windowtws_atope(mode ='ato2')
  ret_box3 = cor_analysis_sub_windowtws_atope(mode ='ato3')
  ret_box4 = cor_analysis_sub_windowtws_atope(mode ='ato4')
  
  pme_oce = data.frame(
    PME_ATO1= ret_box1[[1]],
    PME_ATO3= ret_box3[[1]]
    #pme_ato3= ret_box3[[1]],
    #pme_ato4= ret_box4[[1]]
  )
  colnames_land = paste0('sub_window',1:10)
  twsland_df = as.data.frame(ret_box1[[2]])
  colnames(twsland_df) = paste0('HSW',1:10)
  
  cor1 = 1
  cor2 = 1
  for(i in 1:ncol(twsland_df)){
    tmpcor1 = cor.test(pme_oce[,1],
                       twsland_df[,i])$p.value
    tmpcor2 = cor.test(pme_oce[,2],
                       twsland_df[,i])$p.value
    cor1 = c(cor1,tmpcor1)
    cor2 = c(cor2,tmpcor2)
  }
  
  cor1 = cor1[-1]
  cor2 = cor2[-1]
  retdf = data.frame(
    pme1_cor_sig = cor1,
    pme3_cor_sig = cor2
  )
  
  retdf$pme1_cor_sig = scientific(retdf$pme1_cor_sig,
                                  digits = 2)
  retdf$pme3_cor_sig = scientific(retdf$pme3_cor_sig,
                                  digits = 2)
  
  fwrite(retdf,'NC_mod_xinjiang/fig2_add_sig/fig2_add_sig.csv')
  
  
  
  
  
  
  
}
fig2_plot_xinjiang_vapor <- function(
  
){
  #1. import cluster in each ocean
  input_source_cluster_shp = list.files('cluster_shp',
                                        full.names = T)
  input_source_cluster_shp = lapply(input_source_cluster_shp,
                                    list.files,
                                    full.names = T,
                                    pattern = '*.shp$')
  input_cluster_shp = do.call('c',input_source_cluster_shp)
  input_cluster_shp = input_cluster_shp[-c(9,10)]
    
  shp_list = lapply(input_cluster_shp,shapefile)
  shp_eu1_as2 = do.call('bind',shp_list[c(2,7,9)])
  
  shp_combine = do.call('bind',shp_list)
  
  world = shp_management('world')
  world = crop(world,extent(c(-180,180,0,90)))
  
  pmap = ggplot()+
    geom_polygon(data = world,aes(x = long,y = lat,
                                  group = group),
                 fill = 'grey50',
                 color = 'black',
                 size = 0.5)+
    geom_polygon(data = shp_eu1_as2,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    geom_path(data = cluster_traj_df,aes(x = long,y = lat,
                                         group = routeid,
                                         color = factor(routeid)),
              size = 1,
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="closed"))
  
  
  # 
  
  
  
  
  
  
  
    
  
  
}
fig3_abnormal_phenomana <- function(
  
){
  # cal sub windows pme 
  source('/home/share/R_project/xinjiang_vapor/cal_mean_tws_for_subwindow.R')
  #cal_mean_pme_for_subwindow()
  library(data.table)
  library(ggplot2)
  
  pme_subs <-fread('analysis_output/pme_subwindow_2003_2017.csv')
  tws_subs <- fread('analysis_output/tws_subwindow_2003_2017.csv')
  input_pme_oce = c(
    'analysis_output/fig2/pme_ato1_trend.csv',
    'analysis_output/fig2/pme_ato2_trend.csv',
    'analysis_output/fig2/pme_ato3_trend.csv',
    'analysis_output/fig2/pme_ato4_trend.csv'
  )
  
  pme_oce <-lapply(lapply(input_pme_oce,
                             fread),
                    as.data.frame)
  
  pme_oce = data.frame(
    pme_ato1 = pme_oce[[1]][,2],
    pme_ato2 = pme_oce[[2]][,2],
    pme_ato3 = pme_oce[[3]][,2],
    pme_ato4 = pme_oce[[4]][,2]
  )
  
  pme_subs = as.data.frame(pme_subs)
  tws_subs = as.data.frame(tws_subs)
  
  pme_subs = pme_subs[,-1]
  tws_subs = tws_subs[,-1]
  
  naid = which(is.na(pme_subs[,1]))
  pme_subs = pme_subs[-naid,]
  tws_subs = tws_subs[-naid,]
  
  cor_box = 1
  for(i in 1:ncol(pme_subs)){
    tmpcor = max(ccf(pme_subs[,i],
                     tws_subs[,i])$acf)
    
    cor_box = c(cor_box,tmpcor)  
  }
  cor_box =cor_box[-1]
  
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),
             '1 month')
  date = date[1:174]
  date = date[-naid]
  
  colnames(pme_subs) = paste0('SW',1:19)
  colnames(tws_subs)   = paste0('SW',1:19)
  
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  pme_subs = pme_subs[,id_box]
  tws_subs = tws_subs[,id_box]
  pme_subs_df = data.frame(
    date = date,
    pme_subs
  )
  tws_subs_df = data.frame(
    date = date,
    tws_subs
  )
  
  pme_df = reshape2::melt(pme_subs_df,'date')
  tws_df = reshape2::melt(tws_subs_df,'date')
  
  pme_df$type = 'pme'
  tws_df$type = 'TWS'
  
  pme_tws_df = rbind(pme_df,tws_df)
  df1 = data.frame(variable = pme_df$variable,
                   pme = pme_df$value,
                   tws = tws_df$value)
  pline = ggplot()+
    geom_point(data = df1,
              aes(x  = pme,y = tws),
              color = 'blue',
              size = 3,
              shape = 1)+
    facet_wrap(~variable,nrow = 4)+
    theme_bw()
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  }
fig3_plot<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/spatio_tws_evolu.R')
  spatio_tws_evolu()
}
fig3_pme_content_analysis<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  
  pmeato = pe_in_source[,5:8]- pet_sum[,5:8]
  
  input_era5_pr = list.files('era5_pr_in_target',
                             full.names = T)#[c(1,3)]
  input_eva_intarget = list.files('poten_evap_in_target',
                                  full.names =T)#[c(1,3)]
  
  era5_pr = lapply(lapply(input_era5_pr,fread),
                   as.data.frame)
  eva = lapply(lapply(input_eva_intarget,fread),
               as.data.frame)
  
  era5_pr = do.call('cbind',era5_pr)
  eva = do.call('cbind',eva)

  era5_pr = era5_pr[1:174,]
  eva = eva[1:174,]
  pmeato = pmeato[1:174,]
  #era5_pr = apply(era5_pr,1,sum)
  #eva = apply(eva,1,sum)
  
  era5_pme = era5_pr - eva
  
  #tws = apply(tws,1,sum)
  
  stand_fun <-function(x){
    
    x = ts(x,start = c(2003,1),
           frequency = 12)
    xt = decompose(x)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    x = xt
    
    x = (x -mean(x,na.rm = T))/(max(x,na.rm = T)-
                                  min(x,na.rm = T))
    return(x)
  }
  
  #era5_pme = stand_fun(era5_pme)
  #tws = stand_fun(tws)
  
  era5_pme = apply(era5_pme,2,stand_fun)
  pmeato = apply(pmeato,2,stand_fun)
  
  # pr structure analysis 
  
  
  
  
  
  
  
  
  
  
}
fig4_projection_of_tws_subs_version2 <- function(
  
){
  library(ggplot2)
  library(raster)
  input_tws = 'analysis_output/fig4/project_tws'
  input_tws = list.files(input_tws,full.names = T)
  
  
  tws245_maxmin = as.data.frame(fread(input_tws[1]))
  tws245_mean = as.data.frame(
    fread(input_tws[2])
  )
  
  tws585_maxmin = as.data.frame(
    fread(input_tws[3])
  )
  tws585_mean = as.data.frame(
    fread(input_tws[4])
  )
  
  colnames(tws245_mean) = c('date',
                            'variable',
                            'value')
  colnames(tws585_mean) = c('date',
                            'variable',
                            'value')
  
  tws245_mean$type = 'SSP245_TWS'
  tws585_mean$type = 'SSP585_TWS'
  tws245_maxmin$type = 'SSP245_TWS'
  tws585_maxmin$type = 'SSP585_TWS'
  
  sub_to_year_fun <- function(df){
    year = 2018:2050
    var  = paste0('SW',1:10)
    value = 1
    type = as.character(unique(df$type))
    for(i in 1:10){
      tmpid = which(df$variable %in% var[i])
      x = c(df[tmpid,3],rep(NA,6))
      xm = matrix(x,nrow = 12)
      
      xm = apply(xm,2,sum,na.rm = T)
      value = c(value,xm)
    }
    value = value[-1]
    retdf = data.frame(
      date = year,
      variable = rep(var,each = length(year)),
      value = value,
      type = type
    )
    return(retdf)
  }
  sub_to_year_fun_maxmin <- function(df){
    year = 2018:2050
    var  = paste0('SW',1:10)
    max = 1
    min = 1
    type = as.character(unique(df$type))
    for(i in 1:10){
      
      tmpid = which(df$variable %in% var[i])
      x = c(df[tmpid,3],rep(NA,6))
      xm = matrix(x,nrow = 12)
      xm = apply(xm,2,sum,na.rm = T)
      #xm = stand_fun(xm)
      max = c(max,xm)
      
      x = c(df[tmpid,4],rep(NA,6))
      xm = matrix(x,nrow = 12)
      xm = apply(xm,2,sum,na.rm = T)
      #xm = stand_fun(xm)
      min = c(min,xm)
    }
    max =max[-1]
    min = min[-1]
    retdf = data.frame(
      date = year,
      variable = rep(var,each = length(year)),
      max = max,
      min = min,
      type = type
    )
    return(retdf)
  }
  tws245_mean = sub_to_year_fun(tws245_mean)
  tws585_mean = sub_to_year_fun(tws585_mean)
  tws245_maxmin = sub_to_year_fun_maxmin(tws245_maxmin)
  tws585_maxmin = sub_to_year_fun_maxmin(tws585_maxmin)
  
  source('/home/share/R_project/xinjiang_vapor/cal_increasing_rate.R')
  cr245 = cal_increasing_rate(tws245_mean)
  cr585 = cal_increasing_rate(tws585_mean)
  
  cr245_whole = cr245[[2]]
  cr585_whole = cr585[[2]]
  cr245 = cr245[[1]]
  cr585 = cr585[[1]]
  
  df = rbind(tws245_mean,tws585_mean)
  df$variable = factor(df$variable,
                       levels = paste0("SW",1:10))
  df2 = rbind(tws245_maxmin,tws585_maxmin)
  df2$variable = factor(df2$variable,
                        levels = paste0('SW',1:10))
  
  source('/home/share/R_project/xinjiang_vapor/import_pme_ato_fig4.R')
  pmedf = import_pme_ato_fig4(T)

  library(ggsci)
  col1 = pal_lancet(alpha = 0.8)(9)
  library(RColorBrewer)
  a = colorRampPalette(col1)(20)
  pals2 = pal_lancet(alpha = 0.8)(9)
  pals2 = colorRampPalette(pals2)(40)
  twscol = c('SSP245_TWS' = '#E2746E',
             'SSP585_TWS' = '#C12C44')
  pmecol = c('SSP245_PME1' = '#0B94B2',
             'SSP585_PME1' = '#2988AE',
             'SSP245_PME3' = '#00468B',
             'SSP585_PME3' = '#30376E')
  cols = c(twscol,pmecol)
  
  library(Rmisc)
  
  pathdf1 = data.frame(
    x = c(2018,2031,2031,2050),
    xend = c(2031,2050,2018,2031),
    y = c(4.5,4.5,4.5,4.5)-1+0.5
  )
  pathdf2 = data.frame(
    x = c(2018,2031,2050),
    y = rep(4.2,3)-1+0.5,
    yend = rep(4.8,3)-1+0.5
  )
  pathdf3 = data.frame(
    x = c(2018,2031,2031,2050),
    xend = c(2031,2050,2018,2031),
    y = rep(-4.5,2)+0.5
  )
  pathdf4 = data.frame(
    x = c(2018,2031,2050),
    y = c(-4.8,-4.8,-4.8)+0.5,
    yend = c(-4.2,-4.2,-4.2)
  )
  pathdf11 = pathdf1
  pathdf21 = pathdf2
  pathdf31 = pathdf3
  pathdf41 = pathdf4
  pathdf12 = pathdf1
  pathdf22 = pathdf2
  pathdf32 = pathdf3
  pathdf42 = pathdf4
  
  
  pathdf11$type = '(a) Regional mean standard indices under SSP245'
  pathdf21$type = '(a) Regional mean standard indices under SSP245'
  pathdf31$type = '(a) Regional mean standard indices under SSP245'
  pathdf41$type = '(a) Regional mean standard indices under SSP245'
  
  pathdf12$type = '(b) Regional mean standard indices under SSP585'
  pathdf22$type = '(b) Regional mean standard indices under SSP585'
  pathdf32$type = '(b) Regional mean standard indices under SSP585'
  pathdf42$type = '(b) Regional mean standard indices under SSP585'
  
  pathdfc1 = rbind(pathdf11,
                  pathdf12,
                  pathdf31,
                  pathdf32)
  pathdfc2 = rbind(pathdf21,
                   pathdf22,
                   pathdf41,
                   pathdf42)
  
  
  cr245$y = 5.3-1+0.5
  cr585$y = 3.6-1+0.5
  year = 2018:2050
  cr245$x = year[cr245$x]
  cr585$x = year[cr585$x]
  
  cr245$variable = factor(cr245$variable,
                          levels = paste0('SW',1:10))
  cr585$variable = factor(cr585$variable,
                          levels = paste0('SW',1:10))
  
  pline1 = ggplot()+
    #geom_ribbon(data = df2,aes(x = date,
    #                           ymax = max,
    #                           ymin = min),
    #            fill = '#87CEFA',
    #            alpha = 0.5)+
    geom_text(data = cr245,
              aes(x = x, y = y,label = label),
              size = 3.5,
              color = '#E2746E',
              fontface = 'bold')+
    geom_text(data = cr585,
              aes(x = x,y = y , label = label),
              size = 3.5,
              color = '#C12C44',
              fontface = 'bold')+
    geom_vline(xintercept = 2031,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_vline(xintercept = 2018,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_vline(xintercept = 2050,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_line(data = pmedf,
              aes(x = date,
                  y = value,
                  color = type),
              size = 1,
              alpha = 0.8)+
    geom_segment(data = pathdf1,
                 aes(x = x,xend =xend,
                     y = y,yend = y),
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'),
                 size = 0.5)+
    geom_segment(data = pathdf2,
                 aes(x = x,xend =x,
                     y = y,yend = yend),
                 size = 0.5)+
    geom_line(data = df,aes(x = date,
                             y = value,
                             color = type),
              size = 1)+
    
    #scale_fill_manual(values= fills)+
    scale_y_continuous(limits = c(-3,6),
                       position = 'left')+
    
    scale_color_manual(values = cols)+
    facet_wrap(~variable,ncol = 2)+
    theme_bw()+
    theme(legend.position = 'none')+
    ylab('Standardized indices')
  
  library(data.table)
  
  
  source('/home/share/R_project/xinjiang_vapor/cal_mean_tws_among_windows.R')
  mean_tws245 = cal_mean_tws_among_windows(tws245_mean,
                                           mode = 'mean')
  mean_tws585 = cal_mean_tws_among_windows(tws585_mean,
                                           mode = 'mean')
  mean_maxmin_tws245 = cal_mean_tws_among_windows(tws245_maxmin,
                                                  mode = 'max')

  mean_maxmin_tws585 = cal_mean_tws_among_windows(tws585_maxmin,
                                                  mode = 'max')
  mean_tws245$type = '(a) Regional mean standard indices under SSP245'
  mean_tws585$type = '(b) Regional mean standard indices under SSP585'
  
  pmedf1 = pmedf
  colnames(pmedf1) = c('date','variable','value')
  pmedf245 = pmedf1[
    which(pmedf1$variable %in% c('SSP245_PME1',
                                 'SSP245_PME3')),]
  pmedf585 = pmedf1[
    which(pmedf1$variable %in% c('SSP585_PME1',
                                 'SSP585_PME3')),
  ]
  pmedf245$type = '(a) Regional mean standard indices under SSP245'
  pmedf585$type = '(b) Regional mean standard indices under SSP585'
  
  library(prophet)
  ir_tws245 = cal_increasing_rate_whole(mean_tws245,
                                        'TWS_245')
  ir_tws585 = cal_increasing_rate_whole(mean_tws585,
                                        'TWS_585')
  ir_pme245 = cal_increasing_rate_whole(
    pmedf245,
    'SSP245_PME'
  )
  ir_pme585 = cal_increasing_rate_whole(pmedf585,
                                        'SSP585_PME')
  crytws= 4.8-0.2
  crypme1 = -4.5+0.5+0.6
  crypme2 = -5+0.5-0.3
  ir_tws245$y = crytws
  ir_tws585$y = crytws
  ir_pme245$y = c(crypme1,crypme2)
  ir_pme585$y =  c(crypme1,crypme2)
  
  ir_tws245$type = '(a) Regional mean standard indices under SSP245'
  ir_pme245$type = '(a) Regional mean standard indices under SSP245'
  ir_tws585$type = '(b) Regional mean standard indices under SSP585'
  ir_pme585$type = '(b) Regional mean standard indices under SSP585'
  
  irdf = rbind(ir_tws245,ir_pme245,
               ir_tws585,ir_pme585)
  irdf$x = year[irdf$x]
  
  # import pme ato mmk
  input_ato1 = 'analysis_output/fig4/ato_mmk_ssp245.nc'
  input_ato2 = 'analysis_output/fig4/ato_mmk_ssp585.nc'
  
  ato245 = raster(input_ato1)
  ato585 = raster(input_ato2)
  #aim 0.25
  rs = raster(nrow = 329,ncol = 626)
  extent(rs) = extent(c(-127.25,29.25,0,82.25))
  ato245r = resample(ato245,rs)
  ato585r = resample(ato585,rs)
  
  ato245df = as.data.frame(ato245r,
                           xy = T)
  ato585df = as.data.frame(ato585r,
                           xy = T)
  
  colnames(ato245df) = c('long','lat','SSP245-PME-MMK')
  colnames(ato585df) = c('long','lat','SSP585-PME-MMK')
  
  dfato1 = reshape2::melt(ato245df,
                          c('long','lat'))
  dfato2 = reshape2::melt(ato585df,
                          c('long','lat'))
  
  idless0 = which(dfato1$value < 0)
  idless02 = which(dfato2$value <0)
  
  dfato1 = dfato1[idless0,]
  dfato2 = dfato2[idless02,]
  
  dfato1$type = '(c) SSP245'
  dfato2$type = '(d) SSP585'
  
  dfato = rbind(dfato1,dfato2)
  dfato$cuts = cut(dfato$value,
                   breaks = c(-13,seq(-4,0,1)))
  
  fillato = colorRampPalette(
    brewer.pal(9,'YlOrRd')
  )(25)
  #sea_pme_mmk_pal = sea_pme_mmk_pal[1:]
  fillato = rev(fillato)
  fillato = fillato[seq(1,25,5)]
  
  
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  worlddf = fortify(world)
  worlddf1 = worlddf
  worlddf2 = worlddf
  
  worlddf1$type = '(c) SSP245'
  worlddf2$type = "(d) SSP585"
  worlddf = rbind(worlddf1,worlddf2)
  
  
  input_twsmmk = 'analysis_output/fig4/tws_subs_mmk/tws_mmk_subs_era5model.csv'
  twsmmk = fread(input_twsmmk)
  
  colnames(twsmmk) = c('long','lat',
                       '(c) SSP245','(d) SSP585')
  twsmmk = reshape2::melt(twsmmk,c('long','lat'))
  twsmmk$type = twsmmk$variable
  
  idless0 = which(twsmmk$value <0)
  twsmmk = twsmmk[idless0,]
  
  twsmmk$cuts = cut(twsmmk$value,
                    breaks = c(-63,seq(-10,0,1)))
  
  filltwsmmk = colorRampPalette(
    brewer.pal(9,'YlOrRd')
  )(25)
  filltwsmmk = rev(filltwsmmk)
  filltwsmmk = filltwsmmk[seq(1,25,2)][1:11]
  
  input_subs = 'sub_windows'
  num = 1:19
  input_subs = paste0(input_subs,'/sub_window',num,'.shp')
  
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  input_subs = input_subs[id_box]
  subs_shp = lapply(input_subs,shapefile)
  subs_shp = do.call('bind',subs_shp)
  subs_shp1 = fortify(subs_shp)
  subs_shp2 = fortify(subs_shp)
  
  subs_shp1$type = '(c) SSP245'
  subs_shp2$type = '(d) SSP585'
  subs_shp = rbind(subs_shp1,subs_shp2)
    
  xj = shp_management('xinjiang')
  xjdf = fortify(xj)
  xjdf1 = xjdf
  xjdf2 = xjdf
  xjdf1$type = '(c) SSP245'
  xjdf2$type = '(d) SSP585'
  xjdf = rbind(xjdf1,xjdf2)

  library(ggnewscale)
  
  ato1 = shapefile('cluster_shp/ato/ato1.shp')
  ato3 = shapefile('cluster_shp/ato/ato3.shp')
  
  cur_df = as.data.frame(
    fread('analysis_output/fig4/current_df.csv')
  )
  
  idless50 = which(cur_df$lat <= 50)
  cur_df = cur_df[idless50,]
  
  idbig1 = which(cur_df$u>0 &
                   cur_df$v >0)
  idbig2 = which(cur_df$u<0 &
                   cur_df$v >0)
  
  cur_df1 = cur_df[idbig1,]
  cur_df2 = cur_df[idbig2,]
  
  cid1 = seq(1,nrow(cur_df1),30)
  cid2 = seq(1,nrow(cur_df2),200)
  
  cur_df1 = cur_df1[cid1,]
  cur_df2 = cur_df2[cid2,]
  cur_df1$type = '(c) SSP245'
  cur_df11 = cur_df1
  cur_df2$type = '(c) SSP245'
  cur_df21 = cur_df2
  cur_df11$type = '(d) SSP585'
  cur_df21$type = '(d) SSP585'
  
  cur_df1 = rbind(cur_df1,cur_df11)
  cur_df2 = rbind(cur_df2,cur_df21)
  
  abline_df = data.frame(
    x = rep(c(2018,2031,2050),2),
    y = rep(c(-5,-5,-5),2),
    yend = rep(c(5,5,5),2),
    type = rep(c('(a) Regional mean standard indices under SSP245',
                 '(b) Regional mean standard indices under SSP585'),
               each =  3))  
  
  
  pline_whole = ggplot()+
    ###########
  geom_line(data = mean_tws245,
            aes(x = date,y = value,
                color = variable),
            size = 1.5)+
    geom_line(data = mean_tws585,
              aes(x = date,y = value,
                  color = variable),
              size = 1.5)+
    geom_line(data = pmedf245,
              aes(x = date,y = value,
                  color = variable),
              size = 1)+
    geom_line(data = pmedf585,
              aes(x = date,y = value,
                  color = variable),
              size = 1)+
    geom_segment(data = abline_df,
                 aes(x = x,xend = x,
                     y = y,yend = yend),
                 linetype = 'dashed',
                 size = 0.5)+
    geom_segment(data = pathdfc1,
                 aes(x = x,xend =xend,
                     y = y,yend = y),
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'),
                 size = 0.5)+
    geom_segment(data = pathdfc2,
                 aes(x = x,xend =x,
                     y = y,yend = yend),
                 size = 0.5)+
    geom_text(data = irdf,
              aes(x = x,y = y,label = label,
                  color = variable),
              size = 4,
              fontface = 'bold')+
    scale_color_manual(values = cols)+
    facet_wrap(~type,nrow = 1)+
    theme_bw()+
    theme(legend.position = 'none')
  #############
  
  cluster_traj_df = fread('analysis_output/fig2/cluster_traj_df.csv')
  cluster_traj_df = as.data.frame(trajs)
  route_col = pal_npg()(10)[4]
  route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
  
  route_col = colorRampPalette(brewer.pal(
    9,'Blues'
  ))(20)
  
  pmap = ggplot()+
    ###########
    geom_tile(data = dfato,
            aes(x = long,
                y = lat,
                fill = cuts),
            color = 'transparent')+
    scale_fill_manual(values = fillato,
                      guide = guide_legend(
                        title = 'PME-ATO-MMK',
                        title.position = 'top',
                        nrow = 2
                      ))+
    new_scale_fill()+
    geom_tile(data = twsmmk,
              aes(x = long,
                  y = lat,
                  fill = cuts),
              color = 'transparent')+
    
    scale_fill_manual(values = filltwsmmk,
                      guide = guide_legend(
                        title = 'TWS-MMK',
                        title.position = 'top',
                        nrow = 2
                      ))+
    geom_segment(data = cur_df1,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.15,'cm'),
                               type = 'open'),
                 color = cols[4])+
    geom_segment(data = cur_df2,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.2,'cm'),
                               type = 'open'),
                 color = cols[6])+
    
    geom_polygon(data = worlddf,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_polygon(data = xjdf,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_path(data = cluster_traj_df,aes(x = long,y = lat,
                                         group = routeid,
                                         color = factor(
                                           routeid,
                                           levels = 1:20
                                         )),
              size = 0.5,
              linetype = 'solid',
              #color = route_col[5],
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="open"))+
    scale_color_manual(values = route_col,
                       guide = 'none')+
    geom_polygon(data = subs_shp,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    
    facet_wrap(~type,ncol = 1,
               scales = 'free')+
    #coord_sf()+
    theme_bw()+
    ###########
    theme(legend.position = 'none')+
    ylab('Latitude')
  
  world_crop = crop(world,
                    extent(-5,125,30,60))
  
  subs_label = data.frame(
    x = c(10,
          rep(30,3),
          rep(50,2),
          rep(70,2),
          rep(90,1),
          rep(110,1)),
    y = c(35,
          seq(35,60,10),
          seq(35,50,10),
          seq(35,50,10),
          45,
          40),
    label = paste0('SW',1:10)
  )
  
  pmap2= ggplot()+
    ##########
  geom_polygon(data = subs_shp,
               aes(x = long,
                   y = lat,
                   group = group),
               color = 'black',
               fill = 'transparent',
               size = 0.5)+
    geom_text(data = subs_label,
              aes(x = x,y =y ,label = label),
              size = 2.3,
              fontface = 'bold')+
    #coord_sf()+
    theme_void()+
    coord_fixed(1.3)+
    ###########
  theme(
    plot.background = element_rect(
      fill = 'white'
    )
  )
  
  
  # mmk analysis statistic for each subs and ato13
  input_mean_mmk = 'analysis_output/fig4/bars_mmk_mean'
  input1 = paste0(input_mean_mmk,'/','substws_mmk245.csv')
  input2 = paste0(input_mean_mmk,'/','substws_mmk585.csv')
  
  input3 = paste0(input_mean_mmk,'/',
                  'pme_mmk_ssp245.csv')
  input4 = paste0(input_mean_mmk,'/',
                  'pme_mmk_ssp585.csv')
  
  substws_mmk245 = as.data.frame(fread(input1))
  substws_mmk585 = as.data.frame(fread(input2))
  pme_mmk245 = as.data.frame(fread(input3))
  pme_mmk585 = as.data.frame(fread(input4))
  
  dfmmk_mean245 = rbind(substws_mmk245,pme_mmk245)
  dfmmk_mean585 = rbind(substws_mmk585,
                        pme_mmk585)
  
  fillbar = colorRampPalette(pal_npg()(9))(12)
  fillbar2 = colorRampPalette(brewer.pal(10,'Spectral'))(12)
  
  label_df1 =data.frame(
    y = dfmmk_mean245$Region,
    x = abs(dfmmk_mean245$MMK)-1,
    labels = round(dfmmk_mean245$MMK,1)
  )
  
  label_df2 =data.frame(
    y = dfmmk_mean585$Region,
    x = abs(dfmmk_mean585$MMK)-1,
    labels = round(dfmmk_mean585$MMK,1)
  )
  
  order245 = order(abs(dfmmk_mean245$MMK),
                   decreasing = T)
  order585 = order(abs(dfmmk_mean585$MMK),
                   decreasing = T)
  subs1 = dfmmk_mean245$Region[order245]
  subs2 = dfmmk_mean585$Region[order585]
  
  dfmmk_mean245$Region = 
    factor(dfmmk_mean245$Region,
           levels = subs1)
  dfmmk_mean585$Region = 
    factor(dfmmk_mean585$Region,
           levels = subs2)
  
  label_df1$y = factor(label_df1$y
                       ,levels = subs1)
  label_df2$y = factor(label_df2$y,
                       levels = subs2)
  
  pbar1 = ggplot()+
    ##############
  geom_bar(data = dfmmk_mean245,
           aes(x = abs(MMK),y = Region,
               fill = Region),
           stat = 'identity',
           position = "dodge",
           width = 0.8,alpha = 0.8)+
    geom_text(data = label_df1,
              aes(x = x,y = y, label = labels),
              color = 'black',size = 3,hjust =0.5)+
    scale_x_continuous(breaks = c(0,1,2,3,4),
                       labels =c(0,-1,-2,-3,-4))+
    scale_fill_manual(values = fillbar)+
    theme_bw()+
    theme(
      legend.position = 'none',
      panel.border = element_rect(fill = 'transparent',
                                  color = 'transparent'),
      axis.title = element_text(size = 10,color = 'black',
                                hjust = 0.5),
      panel.background = element_rect(fill = 'transparent',
                                      color = 'transparent'),
      panel.grid =element_blank(),
      axis.text = element_text(size = 5,color = 'black',hjust = 0.5),
      axis.line.x = element_line(color= 'black',size = 0.5))+
    ##############
  xlab('Regions')+
    ylab('MMK')
  
  pbar2 = ggplot()+
    ##############
  geom_bar(data = dfmmk_mean585,
           aes(x = abs(MMK) ,y =Region,
               fill = Region),
           stat = 'identity',
           position = "dodge",
           width = 0.8,alpha = 0.8)+
    geom_text(data = label_df2,
              aes(x = x,y = y, label = labels),
              color = 'black',size = 3,hjust =0.5)+
    scale_x_continuous(breaks = c(0,2,4,6,8),
                       labels =c(0,-2,-4,-6,-8))+
    scale_fill_manual(values = fillbar)+
    theme_bw()+
    theme(
      legend.position = 'none',
      panel.border = element_rect(fill = 'transparent',
                                  color = 'transparent'),
      axis.title = element_text(size = 5,color = 'black',
                                hjust = 0.5),
      panel.background = element_rect(fill = 'transparent',
                                      color = 'transparent'),
      panel.grid =element_blank(),
      axis.text = element_text(size = 5,color = 'black',hjust = 0.5),
      axis.line.x = element_line(color= 'black',size = 0.5))+
    xlab('Regions')+
    ylab('MMK')
  ##############
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  re_axis_title = 
    theme(axis.title.x = element_blank())
  axis_angel = theme(
    axis.text.x = element_text(
      color = 'black',
      size = fontsize,
      angle = 15)
  )
  
  pline1 = pline1+text_theme_set+re_axis_title
  #+axis_angel
  pline_whole = pline_whole+text_theme_set+re_axis_title
  pmap = pmap+text_theme_set+re_axis_title
  
  pline12 = pline1+theme(axis.title = element_blank())
  pmap = pmap+theme(axis.title = element_blank())
  pline_whole = pline_whole+theme(axis.title = element_blank())
  
  pline_whole = pline_whole+
    theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),'cm'),
          strip.text = element_blank())
  pmap = pmap+
    theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),'cm'),
          strip.text = element_blank())
  pline12 = pline12+
    theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),'cm'),
          strip.text = element_blank())
  
  library(cowplot)
  p1 = plot_grid(pline_whole,pmap,
                 align = 'hv',
                 axis = 'lr',
                 rel_widths = c(1,1),
                 rel_heights = c(3,6),
                 ncol = 1)
  
  p12 = plot_grid(p1,pline12,
                 align = 'hv',
                 axis = 'lr',
                 rel_widths = c(2,1.5),
                 rel_heights = c(1,1),
                 nrow = 1)
  
  pbar1 = pbar1+
    theme(
      axis.title = element_blank(),
      axis.text.y = element_text(
        size = 9,color = 'black'
      ),
      axis.text.x = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      plot.background = element_rect(
        fill= 'transparent',
        color = 'transparent'
      )
      
    )
  pbar2 = pbar2+
    theme(
      axis.title = element_blank(),
      axis.text.y = element_text(
        size = 9,color = 'black'
      ),
      axis.text.x = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      plot.background  = element_rect(
        fill= 'transparent',
        color = 'transparent'
      )
    )
  
 p123 = ggdraw()+
    draw_plot(p12)+
    draw_plot(pbar1,x = 0.06, y = 0.352,
              width = 0.11, height = 0.22)+
    draw_plot(pbar2,x = 0.06, y = 0.02,
              width = 0.11, height = 0.22)+
    draw_plot(pmap2,x = 0.404, y = 0.329,
              width = 0.16, height = 0.15)+
    draw_plot(pmap2,x = 0.404, y = -0.007,
              width = 0.16, height = 0.15)
  
  png('main_plot/fig4/fig4_final7.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(p123)
  dev.off()
  
  legend_set = theme(
    legend.position = 'bottom'
  )
  library(ggpubr)
  pline1_legend = as_ggplot(
    get_legend(pline1+legend_set+
                 guides(color = guide_legend(
                   title = '',
                   title.position = 'top'
                 )))
  )
  
  pmap_legend = as_ggplot(
    get_legend(pmap+legend_set))
    
  png('main_plot/fig4/pmap_legend.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(pmap_legend)
  dev.off()
  
  png('main_plot/fig4/pline1_legend.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(pline1_legend)
  dev.off()
  
    
  
}









fig4_projection_of_tws_subs_version3 <- function(
  
){
  library(ggplot2)
  library(raster)
  input_tws = 'analysis_output/fig4/project_tws'
  input_tws = list.files(input_tws,full.names = T)
  
  
  tws245_maxmin = as.data.frame(fread(input_tws[1]))
  tws245_mean = as.data.frame(
    fread(input_tws[2])
  )
  
  tws585_maxmin = as.data.frame(
    fread(input_tws[3])
  )
  tws585_mean = as.data.frame(
    fread(input_tws[4])
  )
  
  colnames(tws245_mean) = c('date',
                            'variable',
                            'value')
  colnames(tws585_mean) = c('date',
                            'variable',
                            'value')
  
  tws245_mean$type = 'SSP245_TWS'
  tws585_mean$type = 'SSP585_TWS'
  tws245_maxmin$type = 'SSP245_TWS'
  tws585_maxmin$type = 'SSP585_TWS'
  
  sub_to_year_fun <- function(df){
    year = 2018:2050
    var  = paste0('SW',1:10)
    value = 1
    type = as.character(unique(df$type))
    for(i in 1:10){
      tmpid = which(df$variable %in% var[i])
      x = c(df[tmpid,3],rep(NA,6))
      xm = matrix(x,nrow = 12)
      
      xm = apply(xm,2,sum,na.rm = T)
      value = c(value,xm)
    }
    value = value[-1]
    retdf = data.frame(
      date = year,
      variable = rep(var,each = length(year)),
      value = value,
      type = type
    )
    return(retdf)
  }
  sub_to_year_fun_maxmin <- function(df){
    year = 2018:2050
    var  = paste0('SW',1:10)
    max = 1
    min = 1
    type = as.character(unique(df$type))
    for(i in 1:10){
      
      tmpid = which(df$variable %in% var[i])
      x = c(df[tmpid,3],rep(NA,6))
      xm = matrix(x,nrow = 12)
      xm = apply(xm,2,sum,na.rm = T)
      #xm = stand_fun(xm)
      max = c(max,xm)
      
      x = c(df[tmpid,4],rep(NA,6))
      xm = matrix(x,nrow = 12)
      xm = apply(xm,2,sum,na.rm = T)
      #xm = stand_fun(xm)
      min = c(min,xm)
    }
    max =max[-1]
    min = min[-1]
    retdf = data.frame(
      date = year,
      variable = rep(var,each = length(year)),
      max = max,
      min = min,
      type = type
    )
    return(retdf)
  }
  tws245_mean = sub_to_year_fun(tws245_mean)
  tws585_mean = sub_to_year_fun(tws585_mean)
  tws245_maxmin = sub_to_year_fun_maxmin(tws245_maxmin)
  tws585_maxmin = sub_to_year_fun_maxmin(tws585_maxmin)
  
  source('/home/share/R_project/xinjiang_vapor/cal_increasing_rate.R')
  cr245 = cal_increasing_rate(tws245_mean)
  cr585 = cal_increasing_rate(tws585_mean)
  
  cr245_whole = cr245[[2]]
  cr585_whole = cr585[[2]]
  cr245 = cr245[[1]]
  cr585 = cr585[[1]]
  
  df = rbind(tws245_mean,tws585_mean)
  df$variable = factor(df$variable,
                       levels = paste0("HSW",1:10))
  df2 = rbind(tws245_maxmin,tws585_maxmin)
  df2$variable = factor(df2$variable,
                        levels = paste0('HSW',1:10))
  
  source('/home/share/R_project/xinjiang_vapor/import_pme_ato_fig4.R')
  pmedf = import_pme_ato_fig4(T)
  
  library(ggsci)
  col1 = pal_lancet(alpha = 0.8)(9)
  library(RColorBrewer)
  a = colorRampPalette(col1)(20)
  pals2 = pal_lancet(alpha = 0.8)(9)
  pals2 = colorRampPalette(pals2)(40)
  twscol = c('SSP245_TWS' = '#E2746E',
             'SSP585_TWS' = '#C12C44')
  pmecol = c('SSP245_PME1' = '#0B94B2',
             'SSP585_PME1' = '#2988AE',
             'SSP245_PME3' = '#00468B',
             'SSP585_PME3' = '#30376E')
  cols = c(twscol,pmecol)
  
  library(Rmisc)
  
  pathdf1 = data.frame(
    x = c(2018,2031,2031,2050),
    xend = c(2031,2050,2018,2031),
    y = c(4.5,4.5,4.5,4.5)-1+0.5
  )
  pathdf2 = data.frame(
    x = c(2018,2031,2050),
    y = rep(4.2,3)-1+0.5,
    yend = rep(4.8,3)-1+0.5
  )
  pathdf3 = data.frame(
    x = c(2018,2031,2031,2050),
    xend = c(2031,2050,2018,2031),
    y = rep(-4.5,2)+0.5
  )
  pathdf4 = data.frame(
    x = c(2018,2031,2050),
    y = c(-4.8,-4.8,-4.8)+0.5,
    yend = c(-4.2,-4.2,-4.2)
  )
  pathdf11 = pathdf1
  pathdf21 = pathdf2
  pathdf31 = pathdf3
  pathdf41 = pathdf4
  pathdf12 = pathdf1
  pathdf22 = pathdf2
  pathdf32 = pathdf3
  pathdf42 = pathdf4
  
  
  pathdf11$type = '(a) Regional mean standard indices under SSP245'
  pathdf21$type = '(a) Regional mean standard indices under SSP245'
  pathdf31$type = '(a) Regional mean standard indices under SSP245'
  pathdf41$type = '(a) Regional mean standard indices under SSP245'
  
  pathdf12$type = '(b) Regional mean standard indices under SSP585'
  pathdf22$type = '(b) Regional mean standard indices under SSP585'
  pathdf32$type = '(b) Regional mean standard indices under SSP585'
  pathdf42$type = '(b) Regional mean standard indices under SSP585'
  
  pathdfc1 = rbind(pathdf11,
                   pathdf12,
                   pathdf31,
                   pathdf32)
  pathdfc2 = rbind(pathdf21,
                   pathdf22,
                   pathdf41,
                   pathdf42)
  
  
  cr245$y = 5.3-1+0.5
  cr585$y = 3.6-1+0.5
  year = 2018:2050
  cr245$x = year[cr245$x]
  cr585$x = year[cr585$x]
  
  cr245$variable = factor(cr245$variable,
                          levels = paste0('SW',1:10))
  cr585$variable = factor(cr585$variable,
                          levels = paste0('SW',1:10))
  
  pline1 = ggplot()+
    #geom_ribbon(data = df2,aes(x = date,
    #                           ymax = max,
    #                           ymin = min),
    #            fill = '#87CEFA',
    #            alpha = 0.5)+
    geom_text(data = cr245,
              aes(x = x, y = y,label = label),
              size = 3.5,
              color = '#E2746E',
              fontface = 'bold')+
    geom_text(data = cr585,
              aes(x = x,y = y , label = label),
              size = 3.5,
              color = '#C12C44',
              fontface = 'bold')+
    geom_vline(xintercept = 2031,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_vline(xintercept = 2018,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_vline(xintercept = 2050,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_line(data = pmedf,
              aes(x = date,
                  y = value,
                  color = type),
              size = 1,
              alpha = 0.8)+
    geom_segment(data = pathdf1,
                 aes(x = x,xend =xend,
                     y = y,yend = y),
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'),
                 size = 0.5)+
    geom_segment(data = pathdf2,
                 aes(x = x,xend =x,
                     y = y,yend = yend),
                 size = 0.5)+
    geom_line(data = df,aes(x = date,
                            y = value,
                            color = type),
              size = 1)+
    
    #scale_fill_manual(values= fills)+
    scale_y_continuous(limits = c(-3,6),
                       position = 'left')+
    
    scale_color_manual(values = cols)+
    facet_wrap(~variable,ncol = 2)+
    theme_bw()+
    theme(legend.position = 'none')+
    ylab('Standardized indices')
  
  library(data.table)
  
  
  source('/home/share/R_project/xinjiang_vapor/cal_mean_tws_among_windows.R')
  mean_tws245 = cal_mean_tws_among_windows(tws245_mean,
                                           mode = 'mean')
  mean_tws585 = cal_mean_tws_among_windows(tws585_mean,
                                           mode = 'mean')
  mean_maxmin_tws245 = cal_mean_tws_among_windows(tws245_maxmin,
                                                  mode = 'max')
  
  mean_maxmin_tws585 = cal_mean_tws_among_windows(tws585_maxmin,
                                                  mode = 'max')
  mean_tws245$type = '(a) Regional mean standard indices under SSP245'
  mean_tws585$type = '(b) Regional mean standard indices under SSP585'
  
  pmedf1 = pmedf
  colnames(pmedf1) = c('date','variable','value')
  pmedf245 = pmedf1[
    which(pmedf1$variable %in% c('SSP245_PME1',
                                 'SSP245_PME3')),]
  pmedf585 = pmedf1[
    which(pmedf1$variable %in% c('SSP585_PME1',
                                 'SSP585_PME3')),
    ]
  pmedf245$type = '(a) Regional mean standard indices under SSP245'
  pmedf585$type = '(b) Regional mean standard indices under SSP585'
  
  library(prophet)
  ir_tws245 = cal_increasing_rate_whole(mean_tws245,
                                        'TWS_245')
  ir_tws585 = cal_increasing_rate_whole(mean_tws585,
                                        'TWS_585')
  ir_pme245 = cal_increasing_rate_whole(
    pmedf245,
    'SSP245_PME'
  )
  ir_pme585 = cal_increasing_rate_whole(pmedf585,
                                        'SSP585_PME')
  crytws= 4.8-0.2
  crypme1 = -4.5+0.5+0.6
  crypme2 = -5+0.5-0.3
  ir_tws245$y = crytws
  ir_tws585$y = crytws
  ir_pme245$y = c(crypme1,crypme2)
  ir_pme585$y =  c(crypme1,crypme2)
  
  ir_tws245$type = '(a) Regional mean standard indices under SSP245'
  ir_pme245$type = '(a) Regional mean standard indices under SSP245'
  ir_tws585$type = '(b) Regional mean standard indices under SSP585'
  ir_pme585$type = '(b) Regional mean standard indices under SSP585'
  
  irdf = rbind(ir_tws245,ir_pme245,
               ir_tws585,ir_pme585)
  irdf$x = year[irdf$x]
  
  # import pme ato mmk
  input_ato1 = 'analysis_output/fig4/ato_mmk_ssp245.nc'
  input_ato2 = 'analysis_output/fig4/ato_mmk_ssp585.nc'
  
  ato245 = raster(input_ato1)
  ato585 = raster(input_ato2)
  #aim 0.25
  rs = raster(nrow = 329,ncol = 626)
  extent(rs) = extent(c(-127.25,29.25,0,82.25))
  ato245r = resample(ato245,rs)
  ato585r = resample(ato585,rs)
  
  ato245df = as.data.frame(ato245r,
                           xy = T)
  ato585df = as.data.frame(ato585r,
                           xy = T)
  
  colnames(ato245df) = c('long','lat','SSP245-PME-MMK')
  colnames(ato585df) = c('long','lat','SSP585-PME-MMK')
  
  dfato1 = reshape2::melt(ato245df,
                          c('long','lat'))
  dfato2 = reshape2::melt(ato585df,
                          c('long','lat'))
  
  idless0 = which(dfato1$value < 0)
  idless02 = which(dfato2$value <0)
  
  dfato1 = dfato1[idless0,]
  dfato2 = dfato2[idless02,]
  
  dfato1$type = '(c) SSP245'
  dfato2$type = '(d) SSP585'
  
  dfato = rbind(dfato1,dfato2)
  dfato$cuts = cut(dfato$value,
                   breaks = c(-13,seq(-4,0,1)))
  
  fillato = colorRampPalette(
    brewer.pal(9,'YlOrRd')
  )(25)
  #sea_pme_mmk_pal = sea_pme_mmk_pal[1:]
  fillato = rev(fillato)
  fillato = fillato[seq(1,25,5)]
  
  
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  worlddf = fortify(world)
  worlddf1 = worlddf
  worlddf2 = worlddf
  
  worlddf1$type = '(c) SSP245'
  worlddf2$type = "(d) SSP585"
  worlddf = rbind(worlddf1,worlddf2)
  
  
  input_twsmmk = 'analysis_output/fig4/tws_subs_mmk/tws_mmk_subs_era5model.csv'
  twsmmk = fread(input_twsmmk)
  
  colnames(twsmmk) = c('long','lat',
                       '(c) SSP245','(d) SSP585')
  twsmmk = reshape2::melt(twsmmk,c('long','lat'))
  twsmmk$type = twsmmk$variable
  
  idless0 = which(twsmmk$value <0)
  twsmmk = twsmmk[idless0,]
  
  twsmmk$cuts = cut(twsmmk$value,
                    breaks = c(-63,seq(-10,0,1)))
  
  filltwsmmk = colorRampPalette(
    brewer.pal(9,'YlOrRd')
  )(25)
  filltwsmmk = rev(filltwsmmk)
  filltwsmmk = filltwsmmk[seq(1,25,2)][1:11]
  
  input_subs = 'sub_windows'
  num = 1:19
  input_subs = paste0(input_subs,'/sub_window',num,'.shp')
  
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  input_subs = input_subs[id_box]
  subs_shp = lapply(input_subs,shapefile)
  subs_shp = do.call('bind',subs_shp)
  subs_shp1 = fortify(subs_shp)
  subs_shp2 = fortify(subs_shp)
  
  subs_shp1$type = '(c) SSP245'
  subs_shp2$type = '(d) SSP585'
  subs_shp = rbind(subs_shp1,subs_shp2)
  
  xj = shp_management('xinjiang')
  xjdf = fortify(xj)
  xjdf1 = xjdf
  xjdf2 = xjdf
  xjdf1$type = '(c) SSP245'
  xjdf2$type = '(d) SSP585'
  xjdf = rbind(xjdf1,xjdf2)
  
  library(ggnewscale)
  
  ato1 = shapefile('cluster_shp/ato/ato1.shp')
  ato3 = shapefile('cluster_shp/ato/ato3.shp')
  
  cur_df = as.data.frame(
    fread('analysis_output/fig4/current_df.csv')
  )
  
  idless50 = which(cur_df$lat <= 50)
  cur_df = cur_df[idless50,]
  
  idbig1 = which(cur_df$u>0 &
                   cur_df$v >0)
  idbig2 = which(cur_df$u<0 &
                   cur_df$v >0)
  
  cur_df1 = cur_df[idbig1,]
  cur_df2 = cur_df[idbig2,]
  
  cid1 = seq(1,nrow(cur_df1),30)
  cid2 = seq(1,nrow(cur_df2),200)
  
  cur_df1 = cur_df1[cid1,]
  cur_df2 = cur_df2[cid2,]
  cur_df1$type = '(c) SSP245'
  cur_df11 = cur_df1
  cur_df2$type = '(c) SSP245'
  cur_df21 = cur_df2
  cur_df11$type = '(d) SSP585'
  cur_df21$type = '(d) SSP585'
  
  cur_df1 = rbind(cur_df1,cur_df11)
  cur_df2 = rbind(cur_df2,cur_df21)
  
  abline_df = data.frame(
    x = rep(c(2018,2031,2050),2),
    y = rep(c(-5,-5,-5),2),
    yend = rep(c(5,5,5),2),
    type = rep(c('(a) Regional mean standard indices under SSP245',
                 '(b) Regional mean standard indices under SSP585'),
               each =  3))  
  
  
  pline_whole = ggplot()+
    ###########
  geom_line(data = mean_tws245,
            aes(x = date,y = value,
                color = variable),
            size = 1.5)+
    geom_line(data = mean_tws585,
              aes(x = date,y = value,
                  color = variable),
              size = 1.5)+
    geom_line(data = pmedf245,
              aes(x = date,y = value,
                  color = variable),
              size = 1)+
    geom_line(data = pmedf585,
              aes(x = date,y = value,
                  color = variable),
              size = 1)+
    geom_segment(data = abline_df,
                 aes(x = x,xend = x,
                     y = y,yend = yend),
                 linetype = 'dashed',
                 size = 0.5)+
    geom_segment(data = pathdfc1,
                 aes(x = x,xend =xend,
                     y = y,yend = y),
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'),
                 size = 0.5)+
    geom_segment(data = pathdfc2,
                 aes(x = x,xend =x,
                     y = y,yend = yend),
                 size = 0.5)+
    geom_text(data = irdf,
              aes(x = x,y = y,label = label,
                  color = variable),
              size = 4,
              fontface = 'bold')+
    scale_color_manual(values = cols)+
    facet_wrap(~type,nrow = 1)+
    theme_bw()+
    theme(legend.position = 'none')
  #############
  
  cluster_traj_df = fread('analysis_output/fig2/cluster_traj_df.csv')
  cluster_traj_df = as.data.frame(trajs)
  route_col = pal_npg()(10)[4]
  route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
  
  route_col = colorRampPalette(brewer.pal(
    9,'Blues'
  ))(20)
  
  pmap = ggplot()+
    ###########
  geom_tile(data = dfato,
            aes(x = long,
                y = lat,
                fill = cuts),
            color = 'transparent')+
    scale_fill_manual(values = fillato,
                      guide = guide_legend(
                        title = 'PME-ATO-MMK',
                        title.position = 'top',
                        nrow = 2
                      ))+
    new_scale_fill()+
    geom_tile(data = twsmmk,
              aes(x = long,
                  y = lat,
                  fill = cuts),
              color = 'transparent')+
    
    scale_fill_manual(values = filltwsmmk,
                      guide = guide_legend(
                        title = 'TWS-MMK',
                        title.position = 'top',
                        nrow = 2
                      ))+
    geom_segment(data = cur_df1,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.15,'cm'),
                               type = 'open'),
                 color = cols[4])+
    geom_segment(data = cur_df2,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.2,'cm'),
                               type = 'open'),
                 color = cols[6])+
    
    geom_polygon(data = worlddf,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_polygon(data = xjdf,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_path(data = cluster_traj_df,aes(x = long,y = lat,
                                         group = routeid,
                                         color = factor(
                                           routeid,
                                           levels = 1:20
                                         )),
              size = 0.5,
              linetype = 'solid',
              #color = route_col[5],
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="open"))+
    scale_color_manual(values = route_col,
                       guide = 'none')+
    geom_polygon(data = subs_shp,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    
    facet_wrap(~type,ncol = 1,
               scales = 'free')+
    #coord_sf()+
    theme_bw()+
    ###########
  theme(legend.position = 'none')+
    ylab('Latitude')
  
  world_crop = crop(world,
                    extent(-5,125,30,60))
  
  subs_label = data.frame(
    x = c(10,
          rep(30,3),
          rep(50,2),
          rep(70,2),
          rep(90,1),
          rep(110,1)),
    y = c(35,
          seq(35,60,10),
          seq(35,50,10),
          seq(35,50,10),
          45,
          40),
    label = paste0('SW',1:10)
  )
  
  pmap2= ggplot()+
    ##########
  geom_polygon(data = subs_shp,
               aes(x = long,
                   y = lat,
                   group = group),
               color = 'black',
               fill = 'transparent',
               size = 0.5)+
    geom_text(data = subs_label,
              aes(x = x,y =y ,label = label),
              size = 2.3,
              fontface = 'bold')+
    #coord_sf()+
    theme_void()+
    coord_fixed(1.3)+
    ###########
  theme(
    plot.background = element_rect(
      fill = 'white'
    )
  )
  
  
  # mmk analysis statistic for each subs and ato13
  input_mean_mmk = 'analysis_output/fig4/bars_mmk_mean'
  input1 = paste0(input_mean_mmk,'/','substws_mmk245.csv')
  input2 = paste0(input_mean_mmk,'/','substws_mmk585.csv')
  
  input3 = paste0(input_mean_mmk,'/',
                  'pme_mmk_ssp245.csv')
  input4 = paste0(input_mean_mmk,'/',
                  'pme_mmk_ssp585.csv')
  
  substws_mmk245 = as.data.frame(fread(input1))
  substws_mmk585 = as.data.frame(fread(input2))
  pme_mmk245 = as.data.frame(fread(input3))
  pme_mmk585 = as.data.frame(fread(input4))
  
  dfmmk_mean245 = rbind(substws_mmk245,pme_mmk245)
  dfmmk_mean585 = rbind(substws_mmk585,
                        pme_mmk585)
  
  fillbar = colorRampPalette(pal_npg()(9))(12)
  fillbar2 = colorRampPalette(brewer.pal(10,'Spectral'))(12)
  
  label_df1 =data.frame(
    y = dfmmk_mean245$Region,
    x = abs(dfmmk_mean245$MMK)-1,
    labels = round(dfmmk_mean245$MMK,1)
  )
  
  label_df2 =data.frame(
    y = dfmmk_mean585$Region,
    x = abs(dfmmk_mean585$MMK)-1,
    labels = round(dfmmk_mean585$MMK,1)
  )
  
  order245 = order(abs(dfmmk_mean245$MMK),
                   decreasing = T)
  order585 = order(abs(dfmmk_mean585$MMK),
                   decreasing = T)
  subs1 = dfmmk_mean245$Region[order245]
  subs2 = dfmmk_mean585$Region[order585]
  
  dfmmk_mean245$Region = 
    factor(dfmmk_mean245$Region,
           levels = subs1)
  dfmmk_mean585$Region = 
    factor(dfmmk_mean585$Region,
           levels = subs2)
  
  label_df1$y = factor(label_df1$y
                       ,levels = subs1)
  label_df2$y = factor(label_df2$y,
                       levels = subs2)
  
  pbar1 = ggplot()+
    ##############
  geom_bar(data = dfmmk_mean245,
           aes(x = abs(MMK),y = Region,
               fill = Region),
           stat = 'identity',
           position = "dodge",
           width = 0.8,alpha = 0.8)+
    geom_text(data = label_df1,
              aes(x = x,y = y, label = labels),
              color = 'black',size = 3,hjust =0.5)+
    scale_x_continuous(breaks = c(0,1,2,3,4),
                       labels =c(0,-1,-2,-3,-4))+
    scale_fill_manual(values = fillbar)+
    theme_bw()+
    theme(
      legend.position = 'none',
      panel.border = element_rect(fill = 'transparent',
                                  color = 'transparent'),
      axis.title = element_text(size = 10,color = 'black',
                                hjust = 0.5),
      panel.background = element_rect(fill = 'transparent',
                                      color = 'transparent'),
      panel.grid =element_blank(),
      axis.text = element_text(size = 5,color = 'black',hjust = 0.5),
      axis.line.x = element_line(color= 'black',size = 0.5))+
    ##############
  xlab('Regions')+
    ylab('MMK')
  
  pbar2 = ggplot()+
    ##############
  geom_bar(data = dfmmk_mean585,
           aes(x = abs(MMK) ,y =Region,
               fill = Region),
           stat = 'identity',
           position = "dodge",
           width = 0.8,alpha = 0.8)+
    geom_text(data = label_df2,
              aes(x = x,y = y, label = labels),
              color = 'black',size = 3,hjust =0.5)+
    scale_x_continuous(breaks = c(0,2,4,6,8),
                       labels =c(0,-2,-4,-6,-8))+
    scale_fill_manual(values = fillbar)+
    theme_bw()+
    theme(
      legend.position = 'none',
      panel.border = element_rect(fill = 'transparent',
                                  color = 'transparent'),
      axis.title = element_text(size = 5,color = 'black',
                                hjust = 0.5),
      panel.background = element_rect(fill = 'transparent',
                                      color = 'transparent'),
      panel.grid =element_blank(),
      axis.text = element_text(size = 5,color = 'black',hjust = 0.5),
      axis.line.x = element_line(color= 'black',size = 0.5))+
    xlab('Regions')+
    ylab('MMK')
  ##############
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  re_axis_title = 
    theme(axis.title.x = element_blank())
  axis_angel = theme(
    axis.text.x = element_text(
      color = 'black',
      size = fontsize,
      angle = 15)
  )
  
  pline1 = pline1+text_theme_set+re_axis_title
  #+axis_angel
  pline_whole = pline_whole+text_theme_set+re_axis_title
  pmap = pmap+text_theme_set+re_axis_title
  
  pline12 = pline1+theme(axis.title = element_blank())
  pmap = pmap+theme(axis.title = element_blank())
  pline_whole = pline_whole+theme(axis.title = element_blank())
  
  pline_whole = pline_whole+
    theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),'cm'),
          strip.text = element_blank())
  pmap = pmap+
    theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),'cm'),
          strip.text = element_blank())
  pline12 = pline12+
    theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),'cm'),
          strip.text = element_blank())
  
  library(cowplot)
  p1 = plot_grid(pline_whole,pmap,
                 align = 'hv',
                 axis = 'lr',
                 rel_widths = c(1,1),
                 rel_heights = c(3,6),
                 ncol = 1)
  
  p12 = plot_grid(p1,pline12,
                  align = 'hv',
                  axis = 'lr',
                  rel_widths = c(2,1.5),
                  rel_heights = c(1,1),
                  nrow = 1)
  
  pbar1 = pbar1+
    theme(
      axis.title = element_blank(),
      axis.text.y = element_text(
        size = 9,color = 'black'
      ),
      axis.text.x = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      plot.background = element_rect(
        fill= 'transparent',
        color = 'transparent'
      )
      
    )
  pbar2 = pbar2+
    theme(
      axis.title = element_blank(),
      axis.text.y = element_text(
        size = 9,color = 'black'
      ),
      axis.text.x = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      plot.background  = element_rect(
        fill= 'transparent',
        color = 'transparent'
      )
    )
  
  p123 = ggdraw()+
    draw_plot(p12)+
    draw_plot(pbar1,x = 0.06, y = 0.352,
              width = 0.11, height = 0.22)+
    draw_plot(pbar2,x = 0.06, y = 0.02,
              width = 0.11, height = 0.22)+
    draw_plot(pmap2,x = 0.404, y = 0.329,
              width = 0.16, height = 0.15)+
    draw_plot(pmap2,x = 0.404, y = -0.007,
              width = 0.16, height = 0.15)
  
  png('main_plot/fig4/fig4_final7.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(p123)
  dev.off()
  
  legend_set = theme(
    legend.position = 'bottom'
  )
  library(ggpubr)
  pline1_legend = as_ggplot(
    get_legend(pline1+legend_set+
                 guides(color = guide_legend(
                   title = '',
                   title.position = 'top'
                 )))
  )
  
  pmap_legend = as_ggplot(
    get_legend(pmap+legend_set))
  
  png('main_plot/fig4/pmap_legend.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(pmap_legend)
  dev.off()
  
  png('main_plot/fig4/pline1_legend.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(pline1_legend)
  dev.off()
  
  
  
}



fig4_projection_of_tws_subs_version4_proj_trend <- function(
  
){
  library(ggplot2)
  library(raster)
  input_tws = 'analysis_output/fig4/project_tws_proj_trend'
  input_tws = list.files(input_tws,full.names = T)
  
  
  tws245_maxmin = as.data.frame(fread(input_tws[1]))
  tws245_mean = as.data.frame(
    fread(input_tws[2])
  )
  
  tws585_maxmin = as.data.frame(
    fread(input_tws[3])
  )
  tws585_mean = as.data.frame(
    fread(input_tws[4])
  )
  
  colnames(tws245_mean) = c('date',
                            'variable',
                            'value')
  colnames(tws585_mean) = c('date',
                            'variable',
                            'value')
  
  tws245_mean$type = 'SSP245_TWS'
  tws585_mean$type = 'SSP585_TWS'
  tws245_maxmin$type = 'SSP245_TWS'
  tws585_maxmin$type = 'SSP585_TWS'
  
  
  sub_to_year_fun <- function(df){
    year = 2018:2050
    var  = paste0('SW',1:10)
    value = 1
    type = as.character(unique(df$type))
    for(i in 1:10){
      tmpid = which(df$variable %in% var[i])
      x = c(df[tmpid,3],rep(NA,6))
      xm = matrix(x,nrow = 12)
      
      xm = apply(xm,2,sum,na.rm = T)
      value = c(value,xm)
    }
    value = value[-1]
    retdf = data.frame(
      date = year,
      variable = rep(var,each = length(year)),
      value = value,
      type = type
    )
    return(retdf)
  }
  sub_to_year_fun_maxmin <- function(df){
    year = 2018:2050
    var  = paste0('SW',1:10)
    max = 1
    min = 1
    type = as.character(unique(df$type))
    for(i in 1:10){
      
      tmpid = which(df$variable %in% var[i])
      x = c(df[tmpid,3],rep(NA,6))
      xm = matrix(x,nrow = 12)
      xm = apply(xm,2,sum,na.rm = T)
      #xm = stand_fun(xm)
      max = c(max,xm)
      
      x = c(df[tmpid,4],rep(NA,6))
      xm = matrix(x,nrow = 12)
      xm = apply(xm,2,sum,na.rm = T)
      #xm = stand_fun(xm)
      min = c(min,xm)
    }
    max =max[-1]
    min = min[-1]
    retdf = data.frame(
      date = year,
      variable = rep(var,each = length(year)),
      max = max,
      min = min,
      type = type
    )
    return(retdf)
  }
  tws245_mean = sub_to_year_fun(tws245_mean)
  tws585_mean = sub_to_year_fun(tws585_mean)
  tws245_maxmin = sub_to_year_fun_maxmin(tws245_maxmin)
  tws585_maxmin = sub_to_year_fun_maxmin(tws585_maxmin)
  
  source('/home/share/R_project/xinjiang_vapor/cal_increasing_rate.R')
  cr245 = cal_increasing_rate(tws245_mean)
  cr585 = cal_increasing_rate(tws585_mean)
  
  cr245_whole = cr245[[2]]
  cr585_whole = cr585[[2]]
  cr245 = cr245[[1]]
  cr585 = cr585[[1]]
  
  df = rbind(tws245_mean,tws585_mean)
  df$variable = paste0('H',df$variable)
  df$variable = factor(df$variable,
                       levels = paste0("HSW",1:10))
  df2 = rbind(tws245_maxmin,tws585_maxmin)
  df2$variable = factor(df2$variable,
                        levels = paste0('HSW',1:10))
  
  source('/home/share/R_project/xinjiang_vapor/import_pme_ato_fig4.R')
  pmedf = import_pme_ato_fig4(T)
  
  library(ggsci)
  col1 = pal_lancet(alpha = 0.8)(9)
  library(RColorBrewer)
  a = colorRampPalette(col1)(20)
  pals2 = pal_lancet(alpha = 0.8)(9)
  pals2 = colorRampPalette(pals2)(40)
  twscol = c('SSP245_TWS' = '#E2746E',
             'SSP585_TWS' = '#C12C44')
  pmecol = c('SSP245_PME1' = '#0B94B2',
             'SSP585_PME1' = '#2988AE',
             'SSP245_PME3' = '#00468B',
             'SSP585_PME3' = '#30376E')
  cols = c(twscol,pmecol)
  
  library(Rmisc)
  
  pathdf1 = data.frame(
    x = c(2018,2031,2031,2050),
    xend = c(2031,2050,2018,2031),
    y = c(4.5,4.5,4.5,4.5)-1+0.5
  )
  pathdf2 = data.frame(
    x = c(2018,2031,2050),
    y = rep(4.2,3)-1+0.5,
    yend = rep(4.8,3)-1+0.5
  )
  pathdf3 = data.frame(
    x = c(2018,2031,2031,2050),
    xend = c(2031,2050,2018,2031),
    y = rep(-4.5,2)+0.5
  )
  pathdf4 = data.frame(
    x = c(2018,2031,2050),
    y = c(-4.8,-4.8,-4.8)+0.5,
    yend = c(-4.2,-4.2,-4.2)
  )
  pathdf11 = pathdf1
  pathdf21 = pathdf2
  pathdf31 = pathdf3
  pathdf41 = pathdf4
  pathdf12 = pathdf1
  pathdf22 = pathdf2
  pathdf32 = pathdf3
  pathdf42 = pathdf4
  
  
  pathdf11$type = '(a) Regional mean standard indices under SSP245'
  pathdf21$type = '(a) Regional mean standard indices under SSP245'
  pathdf31$type = '(a) Regional mean standard indices under SSP245'
  pathdf41$type = '(a) Regional mean standard indices under SSP245'
  
  pathdf12$type = '(b) Regional mean standard indices under SSP585'
  pathdf22$type = '(b) Regional mean standard indices under SSP585'
  pathdf32$type = '(b) Regional mean standard indices under SSP585'
  pathdf42$type = '(b) Regional mean standard indices under SSP585'
  
  pathdfc1 = rbind(pathdf11,
                   pathdf12,
                   pathdf31,
                   pathdf32)
  pathdfc2 = rbind(pathdf21,
                   pathdf22,
                   pathdf41,
                   pathdf42)
  
  
  cr245$y = 5.3-1+0.5
  cr585$y = 3.6-1+0.5
  year = 2018:2050
  cr245$x = year[cr245$x]
  cr585$x = year[cr585$x]
  
  cr245$variable = paste0('H',cr245$variable)
  cr585$variable = paste0('H',cr585$variable)
  
  cr245$variable = factor(cr245$variable,
                          levels = paste0('HSW',1:10))
  cr585$variable = factor(cr585$variable,
                          levels = paste0('HSW',1:10))
  
  pline1 = ggplot()+
    #geom_ribbon(data = df2,aes(x = date,
    #                           ymax = max,
    #                           ymin = min),
    #            fill = '#87CEFA',
    #            alpha = 0.5)+
    geom_text(data = cr245,
              aes(x = x, y = y,label = label),
              size = 3.5,
              color = '#E2746E',
              fontface = 'bold')+
    geom_text(data = cr585,
              aes(x = x,y = y , label = label),
              size = 3.5,
              color = '#C12C44',
              fontface = 'bold')+
    geom_vline(xintercept = 2031,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_vline(xintercept = 2018,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_vline(xintercept = 2050,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_line(data = pmedf,
              aes(x = date,
                  y = value,
                  color = type),
              size = 1,
              alpha = 0.8)+
    geom_segment(data = pathdf1,
                 aes(x = x,xend =xend,
                     y = y,yend = y),
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'),
                 size = 0.5)+
    geom_segment(data = pathdf2,
                 aes(x = x,xend =x,
                     y = y,yend = yend),
                 size = 0.5)+
    geom_line(data = df,aes(x = date,
                            y = value,
                            color = type),
              size = 1)+
    
    #scale_fill_manual(values= fills)+
    scale_y_continuous(limits = c(-3,6),
                       position = 'left')+
    
    scale_color_manual(values = cols)+
    facet_wrap(~variable,ncol = 2)+
    theme_bw()+
    theme(legend.position = 'none')+
    ylab('Normalized indices')
  
  library(data.table)
  
  
  source('/home/share/R_project/xinjiang_vapor/cal_mean_tws_among_windows.R')
  mean_tws245 = cal_mean_tws_among_windows(tws245_mean,
                                           mode = 'mean')
  mean_tws585 = cal_mean_tws_among_windows(tws585_mean,
                                           mode = 'mean')
  
  fwrite(mean_tws245,'NC_mod_xinjiang/main_plot/fig_evaluate_pmecmip6/mean_tws245_trend_cali.csv')
  fwrite(mean_tws585,'NC_mod_xinjiang/main_plot/fig_evaluate_pmecmip6/mean_tws585_trend_cali.csv')
  
  
  
  mean_maxmin_tws245 = cal_mean_tws_among_windows(tws245_maxmin,
                                                  mode = 'max')
  
  mean_maxmin_tws585 = cal_mean_tws_among_windows(tws585_maxmin,
                                                  mode = 'max')
  mean_tws245$type = '(a) Regional mean standard indices under SSP245'
  mean_tws585$type = '(b) Regional mean standard indices under SSP585'
  
  pmedf1 = pmedf
  colnames(pmedf1) = c('date','variable','value')
  pmedf245 = pmedf1[
    which(pmedf1$variable %in% c('SSP245_PME1',
                                 'SSP245_PME3')),]
  pmedf585 = pmedf1[
    which(pmedf1$variable %in% c('SSP585_PME1',
                                 'SSP585_PME3')),
  ]
  pmedf245$type = '(a) Regional mean standard indices under SSP245'
  pmedf585$type = '(b) Regional mean standard indices under SSP585'
  
  library(prophet)
  source('/home/share/R_project/xinjiang_vapor/cal_increasing_rate_whole.R')
  ir_tws245 = cal_increasing_rate_whole(mean_tws245,
                                        'TWS_245')
  ir_tws585 = cal_increasing_rate_whole(mean_tws585,
                                        'TWS_585')
  ir_pme245 = cal_increasing_rate_whole(
    pmedf245,
    'SSP245_PME'
  )
  ir_pme585 = cal_increasing_rate_whole(pmedf585,
                                        'SSP585_PME')
  crytws= 4.8-0.2
  crypme1 = -4.5+0.5+0.6
  crypme2 = -5+0.5-0.3
  
  ir_tws245$y = crytws
  ir_tws585$y = crytws
  ir_pme245$y = c(crypme1,crypme2)
  ir_pme585$y =  c(crypme1,crypme2)
  
  ir_tws245$type = '(a) Regional mean standard indices under SSP245'
  ir_pme245$type = '(a) Regional mean standard indices under SSP245'
  ir_tws585$type = '(b) Regional mean standard indices under SSP585'
  ir_pme585$type = '(b) Regional mean standard indices under SSP585'
  
  irdf = rbind(ir_tws245,ir_pme245,
               ir_tws585,ir_pme585)
  irdf$x = year[irdf$x]
  
  # import pme ato mmk
  input_ato1 = 'analysis_output/fig4/ato_mmk_ssp245.nc'
  input_ato2 = 'analysis_output/fig4/ato_mmk_ssp585.nc'
  
  ato245 = raster(input_ato1)
  ato585 = raster(input_ato2)
  #aim 0.25
  rs = raster(nrow = 329,ncol = 626)
  extent(rs) = extent(c(-127.25,29.25,0,82.25))
  ato245r = resample(ato245,rs)
  ato585r = resample(ato585,rs)
  
  ato245df = as.data.frame(ato245r,
                           xy = T)
  ato585df = as.data.frame(ato585r,
                           xy = T)
  
  colnames(ato245df) = c('long','lat','SSP245-PME-MMK')
  colnames(ato585df) = c('long','lat','SSP585-PME-MMK')
  
  dfato1 = reshape2::melt(ato245df,
                          c('long','lat'))
  dfato2 = reshape2::melt(ato585df,
                          c('long','lat'))
  
  idless0 = which(dfato1$value < 0)
  idless02 = which(dfato2$value <0)
  
  dfato1 = dfato1[idless0,]
  dfato2 = dfato2[idless02,]
  
  dfato1$type = '(c) SSP245'
  dfato2$type = '(d) SSP585'
  
  dfato = rbind(dfato1,dfato2)
  dfato$cuts = cut(dfato$value,
                   breaks = c(-13,seq(-4,0,1)))
  
  fillato = colorRampPalette(
    brewer.pal(9,'YlOrRd')
  )(25)
  #sea_pme_mmk_pal = sea_pme_mmk_pal[1:]
  fillato = rev(fillato)
  fillato = fillato[seq(1,25,5)]
  
  
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  worlddf = fortify(world)
  worlddf1 = worlddf
  worlddf2 = worlddf
  
  worlddf1$type = '(c) SSP245'
  worlddf2$type = "(d) SSP585"
  worlddf = rbind(worlddf1,worlddf2)
  
  
  input_twsmmk = 'analysis_output/fig4/tws_subs_mmk/tws_mmk_subs_era5model.csv'
  twsmmk = fread(input_twsmmk)
  
  colnames(twsmmk) = c('long','lat',
                       '(c) SSP245','(d) SSP585')
  twsmmk = reshape2::melt(twsmmk,c('long','lat'))
  twsmmk$type = twsmmk$variable
  
  idless0 = which(twsmmk$value <0)
  twsmmk = twsmmk[idless0,]
  
  twsmmk$cuts = cut(twsmmk$value,
                    breaks = c(-63,seq(-10,0,1)))
  
  filltwsmmk = colorRampPalette(
    brewer.pal(9,'YlOrRd')
  )(25)
  filltwsmmk = rev(filltwsmmk)
  filltwsmmk = filltwsmmk[seq(1,25,2)][1:11]
  
  input_subs = 'sub_windows'
  num = 1:19
  input_subs = paste0(input_subs,'/sub_window',num,'.shp')
  
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  input_subs = input_subs[id_box]
  subs_shp = lapply(input_subs,shapefile)
  subs_shp = do.call('bind',subs_shp)
  subs_shp1 = fortify(subs_shp)
  subs_shp2 = fortify(subs_shp)
  
  subs_shp1$type = '(c) SSP245'
  subs_shp2$type = '(d) SSP585'
  subs_shp = rbind(subs_shp1,subs_shp2)
  
  xj = shp_management('xinjiang')
  xjdf = fortify(xj)
  xjdf1 = xjdf
  xjdf2 = xjdf
  xjdf1$type = '(c) SSP245'
  xjdf2$type = '(d) SSP585'
  xjdf = rbind(xjdf1,xjdf2)
  
  library(ggnewscale)
  
  ato1 = shapefile('cluster_shp/ato/ato1.shp')
  ato3 = shapefile('cluster_shp/ato/ato3.shp')
  
  cur_df = as.data.frame(
    fread('analysis_output/fig4/current_df.csv')
  )
  
  idless50 = which(cur_df$lat <= 50)
  cur_df = cur_df[idless50,]
  
  idbig1 = which(cur_df$u>0 &
                   cur_df$v >0)
  idbig2 = which(cur_df$u<0 &
                   cur_df$v >0)
  
  cur_df1 = cur_df[idbig1,]
  cur_df2 = cur_df[idbig2,]
  
  cid1 = seq(1,nrow(cur_df1),30)
  cid2 = seq(1,nrow(cur_df2),200)
  
  cur_df1 = cur_df1[cid1,]
  cur_df2 = cur_df2[cid2,]
  cur_df1$type = '(c) SSP245'
  cur_df11 = cur_df1
  cur_df2$type = '(c) SSP245'
  cur_df21 = cur_df2
  cur_df11$type = '(d) SSP585'
  cur_df21$type = '(d) SSP585'
  
  cur_df1 = rbind(cur_df1,cur_df11)
  cur_df2 = rbind(cur_df2,cur_df21)
  
  abline_df = data.frame(
    x = rep(c(2018,2031,2050),2),
    y = rep(c(-5,-5,-5),2),
    yend = rep(c(5,5,5),2),
    type = rep(c('(a) Regional mean standard indices under SSP245',
                 '(b) Regional mean standard indices under SSP585'),
               each =  3))  
  
  
  pline_whole = ggplot()+
    ###########
  geom_line(data = mean_tws245,
            aes(x = date,y = value,
                color = variable),
            size = 1.5)+
    geom_line(data = mean_tws585,
              aes(x = date,y = value,
                  color = variable),
              size = 1.5)+
    geom_line(data = pmedf245,
              aes(x = date,y = value,
                  color = variable),
              size = 1)+
    geom_line(data = pmedf585,
              aes(x = date,y = value,
                  color = variable),
              size = 1)+
    geom_segment(data = abline_df,
                 aes(x = x,xend = x,
                     y = y,yend = yend),
                 linetype = 'dashed',
                 size = 0.5)+
    geom_segment(data = pathdfc1,
                 aes(x = x,xend =xend,
                     y = y,yend = y),
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'),
                 size = 0.5)+
    geom_segment(data = pathdfc2,
                 aes(x = x,xend =x,
                     y = y,yend = yend),
                 size = 0.5)+
    geom_text(data = irdf,
              aes(x = x,y = y,label = label,
                  color = variable),
              size = 4,
              fontface = 'bold')+
    scale_color_manual(values = cols)+
    facet_wrap(~type,nrow = 1)+
    theme_bw()+
    theme(legend.position = 'none')
  #############
  
  cluster_traj_df = fread('analysis_output/fig2/cluster_traj_df.csv')
  cluster_traj_df = as.data.frame(cluster_traj_df)
  route_col = pal_npg()(10)[4]
  route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
  
  route_col = colorRampPalette(brewer.pal(
    9,'Blues'
  ))(20)
  
  pmap = ggplot()+
    ###########
    geom_tile(data = dfato,
            aes(x = long,
                y = lat,
                fill = cuts),
            color = 'transparent')+
    scale_fill_manual(values = fillato,
                      guide = guide_legend(
                        title = 'PME-ATO-MMK',
                        title.position = 'top',
                        nrow = 2
                      ))+
    new_scale_fill()+
    geom_tile(data = twsmmk,
              aes(x = long,
                  y = lat,
                  fill = cuts),
              color = 'transparent')+
    
    scale_fill_manual(values = filltwsmmk,
                      guide = guide_legend(
                        title = 'TWS-MMK',
                        title.position = 'top',
                        nrow = 2
                      ))+
    geom_segment(data = cur_df1,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.15,'cm'),
                               type = 'open'),
                 color = cols[4])+
    geom_segment(data = cur_df2,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.2,'cm'),
                               type = 'open'),
                 color = cols[6])+
    
    geom_polygon(data = worlddf,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_polygon(data = xjdf,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_path(data = cluster_traj_df,aes(x = long,y = lat,
                                         group = routeid,
                                         color = factor(
                                           routeid,
                                           levels = 1:20
                                         )),
              size = 0.5,
              linetype = 'solid',
              #color = route_col[5],
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="open"))+
    scale_color_manual(values = route_col,
                       guide = 'none')+
    geom_polygon(data = subs_shp,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    
    facet_wrap(~type,ncol = 1,
               scales = 'free')+
    #coord_sf()+
    theme_bw()+
    ###########
  theme(legend.position = 'none')+
    ylab('Latitude')
  
  world_crop = crop(world,
                    extent(-5,125,30,60))
  
  subs_label = data.frame(
    x = c(10,
          rep(30,3),
          rep(50,2),
          rep(70,2),
          rep(90,1),
          rep(110,1)),
    y = c(35,
          seq(35,60,10),
          seq(35,50,10),
          seq(35,50,10),
          45,
          40),
    label = paste0('SW',1:10)
  )
  
  pmap2= ggplot()+
    ##########
  geom_polygon(data = subs_shp,
               aes(x = long,
                   y = lat,
                   group = group),
               color = 'black',
               fill = 'transparent',
               size = 0.5)+
    geom_text(data = subs_label,
              aes(x = x,y =y ,label = label),
              size = 2.3,
              fontface = 'bold')+
    #coord_sf()+
    theme_void()+
    coord_fixed(1.3)+
    ###########
  theme(
    plot.background = element_rect(
      fill = 'white'
    )
  )
  
  
  # mmk analysis statistic for each subs and ato13
  input_mean_mmk = 'analysis_output/fig4/bars_mmk_mean'
  input1 = paste0(input_mean_mmk,'/','substws_mmk245.csv')
  input2 = paste0(input_mean_mmk,'/','substws_mmk585.csv')
  
  input3 = paste0(input_mean_mmk,'/',
                  'pme_mmk_ssp245.csv')
  input4 = paste0(input_mean_mmk,'/',
                  'pme_mmk_ssp585.csv')
  
  substws_mmk245 = as.data.frame(fread(input1))
  substws_mmk585 = as.data.frame(fread(input2))
  pme_mmk245 = as.data.frame(fread(input3))
  pme_mmk585 = as.data.frame(fread(input4))
  
  dfmmk_mean245 = rbind(substws_mmk245,pme_mmk245)
  dfmmk_mean585 = rbind(substws_mmk585,
                        pme_mmk585)
  
  fillbar = colorRampPalette(pal_npg()(9))(12)
  fillbar2 = colorRampPalette(brewer.pal(10,'Spectral'))(12)
  
  label_df1 =data.frame(
    y = dfmmk_mean245$Region,
    x = abs(dfmmk_mean245$MMK)-1,
    labels = round(dfmmk_mean245$MMK,1)
  )
  
  label_df2 =data.frame(
    y = dfmmk_mean585$Region,
    x = abs(dfmmk_mean585$MMK)-1,
    labels = round(dfmmk_mean585$MMK,1)
  )
  
  order245 = order(abs(dfmmk_mean245$MMK),
                   decreasing = T)
  order585 = order(abs(dfmmk_mean585$MMK),
                   decreasing = T)
  subs1 = dfmmk_mean245$Region[order245]
  subs2 = dfmmk_mean585$Region[order585]
  
  dfmmk_mean245$Region = 
    factor(dfmmk_mean245$Region,
           levels = subs1)
  dfmmk_mean585$Region = 
    factor(dfmmk_mean585$Region,
           levels = subs2)
  
  label_df1$y = factor(label_df1$y
                       ,levels = subs1)
  label_df2$y = factor(label_df2$y,
                       levels = subs2)
  
  pbar1 = ggplot()+
    ##############
  geom_bar(data = dfmmk_mean245,
           aes(x = abs(MMK),y = Region,
               fill = Region),
           stat = 'identity',
           position = "dodge",
           width = 0.8,alpha = 0.8)+
    geom_text(data = label_df1,
              aes(x = x,y = y, label = labels),
              color = 'black',size = 3,hjust =0.5)+
    scale_x_continuous(breaks = c(0,1,2,3,4),
                       labels =c(0,-1,-2,-3,-4))+
    scale_fill_manual(values = fillbar)+
    theme_bw()+
    theme(
      legend.position = 'none',
      panel.border = element_rect(fill = 'transparent',
                                  color = 'transparent'),
      axis.title = element_text(size = 10,color = 'black',
                                hjust = 0.5),
      panel.background = element_rect(fill = 'transparent',
                                      color = 'transparent'),
      panel.grid =element_blank(),
      axis.text = element_text(size = 5,color = 'black',hjust = 0.5),
      axis.line.x = element_line(color= 'black',size = 0.5))+
    ##############
  xlab('Regions')+
    ylab('MMK')
  
  pbar2 = ggplot()+
    ##############
  geom_bar(data = dfmmk_mean585,
           aes(x = abs(MMK) ,y =Region,
               fill = Region),
           stat = 'identity',
           position = "dodge",
           width = 0.8,alpha = 0.8)+
    geom_text(data = label_df2,
              aes(x = x,y = y, label = labels),
              color = 'black',size = 3,hjust =0.5)+
    scale_x_continuous(breaks = c(0,2,4,6,8),
                       labels =c(0,-2,-4,-6,-8))+
    scale_fill_manual(values = fillbar)+
    theme_bw()+
    theme(
      legend.position = 'none',
      panel.border = element_rect(fill = 'transparent',
                                  color = 'transparent'),
      axis.title = element_text(size = 5,color = 'black',
                                hjust = 0.5),
      panel.background = element_rect(fill = 'transparent',
                                      color = 'transparent'),
      panel.grid =element_blank(),
      axis.text = element_text(size = 5,color = 'black',hjust = 0.5),
      axis.line.x = element_line(color= 'black',size = 0.5))+
    xlab('Regions')+
    ylab('MMK')
  ##############
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  re_axis_title = 
    theme(axis.title.x = element_blank())
  axis_angel = theme(
    axis.text.x = element_text(
      color = 'black',
      size = fontsize,
      angle = 15)
  )
  
  pline1 = pline1+text_theme_set+re_axis_title
  #+axis_angel
  pline_whole = pline_whole+text_theme_set+re_axis_title
  pmap = pmap+text_theme_set+re_axis_title
  
  pline12 = pline1+theme(axis.title = element_blank())
  pmap = pmap+theme(axis.title = element_blank())
  pline_whole = pline_whole+theme(axis.title = element_blank())
  
  pline_whole = pline_whole+
    theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),'cm'),
          strip.text = element_blank())
  pmap = pmap+
    theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),'cm'),
          strip.text = element_blank())
  pline12 = pline12+
    theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),'cm'),
          strip.text = element_blank())
  
  library(cowplot)
  p1 = plot_grid(pline_whole,pmap,
                 align = 'hv',
                 axis = 'lr',
                 rel_widths = c(1,1),
                 rel_heights = c(3,6),
                 ncol = 1)
  
  p12 = plot_grid(p1,pline12,
                  align = 'hv',
                  axis = 'lr',
                  rel_widths = c(2,1.5),
                  rel_heights = c(1,1),
                  nrow = 1)
  
  pbar1 = pbar1+
    theme(
      axis.title = element_blank(),
      axis.text.y = element_text(
        size = 9,color = 'black'
      ),
      axis.text.x = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      plot.background = element_rect(
        fill= 'transparent',
        color = 'transparent'
      )
      
    )
  pbar2 = pbar2+
    theme(
      axis.title = element_blank(),
      axis.text.y = element_text(
        size = 9,color = 'black'
      ),
      axis.text.x = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      plot.background  = element_rect(
        fill= 'transparent',
        color = 'transparent'
      )
    )
  
  p123 = ggdraw()+
    draw_plot(p12)+
    draw_plot(pbar1,x = 0.06, y = 0.352,
              width = 0.11, height = 0.22)+
    draw_plot(pbar2,x = 0.06, y = 0.02,
              width = 0.11, height = 0.22)+
    draw_plot(pmap2,x = 0.404, y = 0.329,
              width = 0.16, height = 0.15)+
    draw_plot(pmap2,x = 0.404, y = -0.007,
              width = 0.16, height = 0.15)
  
  png('main_plot/fig4/fig4_final_projected_trend.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(p123)
  dev.off()
  
  legend_set = theme(
    legend.position = 'bottom'
  )
  library(ggpubr)
  pline1_legend = as_ggplot(
    get_legend(pline1+legend_set+
                 guides(color = guide_legend(
                   title = '',
                   title.position = 'top'
                 )))
  )
  
  pmap_legend = as_ggplot(
    get_legend(pmap+legend_set))
  
  png('main_plot/fig4/pmap_legend_proj_trend.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(pmap_legend)
  dev.off()
  
  png('main_plot/fig4/pline1_legend_proj_trend.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(pline1_legend)
  dev.off()
  
  
  
}



fig4_projection_of_tws_subs_version4_proj <- function(
  
){
  library(ggplot2)
  library(raster)
  input_tws = 'analysis_output/fig4/project_tws_proj'
  input_tws = list.files(input_tws,full.names = T)
  
  
  tws245_maxmin = as.data.frame(fread(input_tws[1]))
  tws245_mean = as.data.frame(
    fread(input_tws[2])
  )
  
  tws585_maxmin = as.data.frame(
    fread(input_tws[3])
  )
  tws585_mean = as.data.frame(
    fread(input_tws[4])
  )
  
  colnames(tws245_mean) = c('date',
                            'variable',
                            'value')
  colnames(tws585_mean) = c('date',
                            'variable',
                            'value')
  
  tws245_mean$type = 'SSP245_TWS'
  tws585_mean$type = 'SSP585_TWS'
  tws245_maxmin$type = 'SSP245_TWS'
  tws585_maxmin$type = 'SSP585_TWS'
  
  sub_to_year_fun <- function(df){
    year = 2018:2050
    var  = paste0('SW',1:10)
    value = 1
    type = as.character(unique(df$type))
    for(i in 1:10){
      tmpid = which(df$variable %in% var[i])
      x = c(df[tmpid,3],rep(NA,6))
      xm = matrix(x,nrow = 12)
      
      xm = apply(xm,2,sum,na.rm = T)
      value = c(value,xm)
    }
    value = value[-1]
    retdf = data.frame(
      date = year,
      variable = rep(var,each = length(year)),
      value = value,
      type = type
    )
    return(retdf)
  }
  sub_to_year_fun_maxmin <- function(df){
    year = 2018:2050
    var  = paste0('SW',1:10)
    max = 1
    min = 1
    type = as.character(unique(df$type))
    for(i in 1:10){
      
      tmpid = which(df$variable %in% var[i])
      x = c(df[tmpid,3],rep(NA,6))
      xm = matrix(x,nrow = 12)
      xm = apply(xm,2,sum,na.rm = T)
      #xm = stand_fun(xm)
      max = c(max,xm)
      
      x = c(df[tmpid,4],rep(NA,6))
      xm = matrix(x,nrow = 12)
      xm = apply(xm,2,sum,na.rm = T)
      #xm = stand_fun(xm)
      min = c(min,xm)
    }
    max =max[-1]
    min = min[-1]
    retdf = data.frame(
      date = year,
      variable = rep(var,each = length(year)),
      max = max,
      min = min,
      type = type
    )
    return(retdf)
  }
  tws245_mean = sub_to_year_fun(tws245_mean)
  tws585_mean = sub_to_year_fun(tws585_mean)
  tws245_maxmin = sub_to_year_fun_maxmin(tws245_maxmin)
  tws585_maxmin = sub_to_year_fun_maxmin(tws585_maxmin)
  
  source('/home/share/R_project/xinjiang_vapor/cal_increasing_rate.R')
  cr245 = cal_increasing_rate(tws245_mean)
  cr585 = cal_increasing_rate(tws585_mean)
  
  cr245_whole = cr245[[2]]
  cr585_whole = cr585[[2]]
  cr245 = cr245[[1]]
  cr585 = cr585[[1]]
  
  df = rbind(tws245_mean,tws585_mean)
  df$variable = paste0('H',df$variable)
  df$variable = factor(df$variable,
                       levels = paste0("HSW",1:10))
  df2 = rbind(tws245_maxmin,tws585_maxmin)
  df2$variable = factor(df2$variable,
                        levels = paste0('HSW',1:10))
  
  source('/home/share/R_project/xinjiang_vapor/import_pme_ato_fig4.R')
  pmedf = import_pme_ato_fig4(T)
  
  library(ggsci)
  col1 = pal_lancet(alpha = 0.8)(9)
  library(RColorBrewer)
  a = colorRampPalette(col1)(20)
  pals2 = pal_lancet(alpha = 0.8)(9)
  pals2 = colorRampPalette(pals2)(40)
  twscol = c('SSP245_TWS' = '#E2746E',
             'SSP585_TWS' = '#C12C44')
  pmecol = c('SSP245_PME1' = '#0B94B2',
             'SSP585_PME1' = '#2988AE',
             'SSP245_PME3' = '#00468B',
             'SSP585_PME3' = '#30376E')
  cols = c(twscol,pmecol)
  
  library(Rmisc)
  
  pathdf1 = data.frame(
    x = c(2018,2031,2031,2050),
    xend = c(2031,2050,2018,2031),
    y = c(4.5,4.5,4.5,4.5)-1+0.5
  )
  pathdf2 = data.frame(
    x = c(2018,2031,2050),
    y = rep(4.2,3)-1+0.5,
    yend = rep(4.8,3)-1+0.5
  )
  pathdf3 = data.frame(
    x = c(2018,2031,2031,2050),
    xend = c(2031,2050,2018,2031),
    y = rep(-4.5,2)+0.5
  )
  pathdf4 = data.frame(
    x = c(2018,2031,2050),
    y = c(-4.8,-4.8,-4.8)+0.5,
    yend = c(-4.2,-4.2,-4.2)
  )
  pathdf11 = pathdf1
  pathdf21 = pathdf2
  pathdf31 = pathdf3
  pathdf41 = pathdf4
  pathdf12 = pathdf1
  pathdf22 = pathdf2
  pathdf32 = pathdf3
  pathdf42 = pathdf4
  
  
  pathdf11$type = '(a) Regional mean standard indices under SSP245'
  pathdf21$type = '(a) Regional mean standard indices under SSP245'
  pathdf31$type = '(a) Regional mean standard indices under SSP245'
  pathdf41$type = '(a) Regional mean standard indices under SSP245'
  
  pathdf12$type = '(b) Regional mean standard indices under SSP585'
  pathdf22$type = '(b) Regional mean standard indices under SSP585'
  pathdf32$type = '(b) Regional mean standard indices under SSP585'
  pathdf42$type = '(b) Regional mean standard indices under SSP585'
  
  pathdfc1 = rbind(pathdf11,
                   pathdf12,
                   pathdf31,
                   pathdf32)
  pathdfc2 = rbind(pathdf21,
                   pathdf22,
                   pathdf41,
                   pathdf42)
  
  
  cr245$y = 5.3-1+0.5
  cr585$y = 3.6-1+0.5
  year = 2018:2050
  cr245$x = year[cr245$x]
  cr585$x = year[cr585$x]
  
  cr245$variable = paste0('H',cr245$variable)
  cr585$variable = paste0('H',cr585$variable)
  
  cr245$variable = factor(cr245$variable,
                          levels = paste0('HSW',1:10))
  cr585$variable = factor(cr585$variable,
                          levels = paste0('HSW',1:10))
  
  pline1 = ggplot()+
    #geom_ribbon(data = df2,aes(x = date,
    #                           ymax = max,
    #                           ymin = min),
    #            fill = '#87CEFA',
    #            alpha = 0.5)+
    geom_text(data = cr245,
              aes(x = x, y = y,label = label),
              size = 3.5,
              color = '#E2746E',
              fontface = 'bold')+
    geom_text(data = cr585,
              aes(x = x,y = y , label = label),
              size = 3.5,
              color = '#C12C44',
              fontface = 'bold')+
    geom_vline(xintercept = 2031,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_vline(xintercept = 2018,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_vline(xintercept = 2050,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_line(data = pmedf,
              aes(x = date,
                  y = value,
                  color = type),
              size = 1,
              alpha = 0.8)+
    geom_segment(data = pathdf1,
                 aes(x = x,xend =xend,
                     y = y,yend = y),
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'),
                 size = 0.5)+
    geom_segment(data = pathdf2,
                 aes(x = x,xend =x,
                     y = y,yend = yend),
                 size = 0.5)+
    geom_line(data = df,aes(x = date,
                            y = value,
                            color = type),
              size = 1)+
    
    #scale_fill_manual(values= fills)+
    scale_y_continuous(limits = c(-3,6),
                       position = 'left')+
    
    scale_color_manual(values = cols)+
    facet_wrap(~variable,ncol = 2)+
    theme_bw()+
    theme(legend.position = 'none')+
    ylab('Normalized indices')
  
  library(data.table)
  
  
  source('/home/share/R_project/xinjiang_vapor/cal_mean_tws_among_windows.R')
  mean_tws245 = cal_mean_tws_among_windows(tws245_mean,
                                           mode = 'mean')
  mean_tws585 = cal_mean_tws_among_windows(tws585_mean,
                                           mode = 'mean')
  mean_maxmin_tws245 = cal_mean_tws_among_windows(tws245_maxmin,
                                                  mode = 'max')
  
  mean_maxmin_tws585 = cal_mean_tws_among_windows(tws585_maxmin,
                                                  mode = 'max')
  mean_tws245$type = '(a) Regional mean standard indices under SSP245'
  mean_tws585$type = '(b) Regional mean standard indices under SSP585'
  
  pmedf1 = pmedf
  colnames(pmedf1) = c('date','variable','value')
  pmedf245 = pmedf1[
    which(pmedf1$variable %in% c('SSP245_PME1',
                                 'SSP245_PME3')),]
  pmedf585 = pmedf1[
    which(pmedf1$variable %in% c('SSP585_PME1',
                                 'SSP585_PME3')),
  ]
  pmedf245$type = '(a) Regional mean standard indices under SSP245'
  pmedf585$type = '(b) Regional mean standard indices under SSP585'
  
  library(prophet)
  source('/home/share/R_project/xinjiang_vapor/cal_increasing_rate_whole.R')
  ir_tws245 = cal_increasing_rate_whole(mean_tws245,
                                        'TWS_245')
  ir_tws585 = cal_increasing_rate_whole(mean_tws585,
                                        'TWS_585')
  ir_pme245 = cal_increasing_rate_whole(
    pmedf245,
    'SSP245_PME'
  )
  ir_pme585 = cal_increasing_rate_whole(pmedf585,
                                        'SSP585_PME')
  crytws= 4.8-0.2
  crypme1 = -4.5+0.5+0.6
  crypme2 = -5+0.5-0.3
  ir_tws245$y = crytws
  ir_tws585$y = crytws
  ir_pme245$y = c(crypme1,crypme2)
  ir_pme585$y =  c(crypme1,crypme2)
  
  ir_tws245$type = '(a) Regional mean standard indices under SSP245'
  ir_pme245$type = '(a) Regional mean standard indices under SSP245'
  ir_tws585$type = '(b) Regional mean standard indices under SSP585'
  ir_pme585$type = '(b) Regional mean standard indices under SSP585'
  
  irdf = rbind(ir_tws245,ir_pme245,
               ir_tws585,ir_pme585)
  irdf$x = year[irdf$x]
  
  # import pme ato mmk
  input_ato1 = 'analysis_output/fig4/ato_mmk_ssp245.nc'
  input_ato2 = 'analysis_output/fig4/ato_mmk_ssp585.nc'
  
  ato245 = raster(input_ato1)
  ato585 = raster(input_ato2)
  #aim 0.25
  rs = raster(nrow = 329,ncol = 626)
  extent(rs) = extent(c(-127.25,29.25,0,82.25))
  ato245r = resample(ato245,rs)
  ato585r = resample(ato585,rs)
  
  ato245df = as.data.frame(ato245r,
                           xy = T)
  ato585df = as.data.frame(ato585r,
                           xy = T)
  
  colnames(ato245df) = c('long','lat','SSP245-PME-MMK')
  colnames(ato585df) = c('long','lat','SSP585-PME-MMK')
  
  dfato1 = reshape2::melt(ato245df,
                          c('long','lat'))
  dfato2 = reshape2::melt(ato585df,
                          c('long','lat'))
  
  idless0 = which(dfato1$value < 0)
  idless02 = which(dfato2$value <0)
  
  dfato1 = dfato1[idless0,]
  dfato2 = dfato2[idless02,]
  
  dfato1$type = '(c) SSP245'
  dfato2$type = '(d) SSP585'
  
  dfato = rbind(dfato1,dfato2)
  dfato$cuts = cut(dfato$value,
                   breaks = c(-13,seq(-4,0,1)))
  
  fillato = colorRampPalette(
    brewer.pal(9,'YlOrRd')
  )(25)
  #sea_pme_mmk_pal = sea_pme_mmk_pal[1:]
  fillato = rev(fillato)
  fillato = fillato[seq(1,25,5)]
  
  
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  worlddf = fortify(world)
  worlddf1 = worlddf
  worlddf2 = worlddf
  
  worlddf1$type = '(c) SSP245'
  worlddf2$type = "(d) SSP585"
  worlddf = rbind(worlddf1,worlddf2)
  
  
  input_twsmmk = 'analysis_output/fig4/tws_subs_mmk/tws_mmk_subs_era5model.csv'
  twsmmk = fread(input_twsmmk)
  
  colnames(twsmmk) = c('long','lat',
                       '(c) SSP245','(d) SSP585')
  twsmmk = reshape2::melt(twsmmk,c('long','lat'))
  twsmmk$type = twsmmk$variable
  
  idless0 = which(twsmmk$value <0)
  twsmmk = twsmmk[idless0,]
  
  twsmmk$cuts = cut(twsmmk$value,
                    breaks = c(-63,seq(-10,0,1)))
  
  filltwsmmk = colorRampPalette(
    brewer.pal(9,'YlOrRd')
  )(25)
  filltwsmmk = rev(filltwsmmk)
  filltwsmmk = filltwsmmk[seq(1,25,2)][1:11]
  
  input_subs = 'sub_windows'
  num = 1:19
  input_subs = paste0(input_subs,'/sub_window',num,'.shp')
  
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  input_subs = input_subs[id_box]
  subs_shp = lapply(input_subs,shapefile)
  subs_shp = do.call('bind',subs_shp)
  subs_shp1 = fortify(subs_shp)
  subs_shp2 = fortify(subs_shp)
  
  subs_shp1$type = '(c) SSP245'
  subs_shp2$type = '(d) SSP585'
  subs_shp = rbind(subs_shp1,subs_shp2)
  
  xj = shp_management('xinjiang')
  xjdf = fortify(xj)
  xjdf1 = xjdf
  xjdf2 = xjdf
  xjdf1$type = '(c) SSP245'
  xjdf2$type = '(d) SSP585'
  xjdf = rbind(xjdf1,xjdf2)
  
  library(ggnewscale)
  
  ato1 = shapefile('cluster_shp/ato/ato1.shp')
  ato3 = shapefile('cluster_shp/ato/ato3.shp')
  
  cur_df = as.data.frame(
    fread('analysis_output/fig4/current_df.csv')
  )
  
  idless50 = which(cur_df$lat <= 50)
  cur_df = cur_df[idless50,]
  
  idbig1 = which(cur_df$u>0 &
                   cur_df$v >0)
  idbig2 = which(cur_df$u<0 &
                   cur_df$v >0)
  
  cur_df1 = cur_df[idbig1,]
  cur_df2 = cur_df[idbig2,]
  
  cid1 = seq(1,nrow(cur_df1),30)
  cid2 = seq(1,nrow(cur_df2),200)
  
  cur_df1 = cur_df1[cid1,]
  cur_df2 = cur_df2[cid2,]
  cur_df1$type = '(c) SSP245'
  cur_df11 = cur_df1
  cur_df2$type = '(c) SSP245'
  cur_df21 = cur_df2
  cur_df11$type = '(d) SSP585'
  cur_df21$type = '(d) SSP585'
  
  cur_df1 = rbind(cur_df1,cur_df11)
  cur_df2 = rbind(cur_df2,cur_df21)
  
  abline_df = data.frame(
    x = rep(c(2018,2031,2050),2),
    y = rep(c(-5,-5,-5),2),
    yend = rep(c(5,5,5),2),
    type = rep(c('(a) Regional mean standard indices under SSP245',
                 '(b) Regional mean standard indices under SSP585'),
               each =  3))  
  
  
  pline_whole = ggplot()+
    ###########
  geom_line(data = mean_tws245,
            aes(x = date,y = value,
                color = variable),
            size = 1.5)+
    geom_line(data = mean_tws585,
              aes(x = date,y = value,
                  color = variable),
              size = 1.5)+
    geom_line(data = pmedf245,
              aes(x = date,y = value,
                  color = variable),
              size = 1)+
    geom_line(data = pmedf585,
              aes(x = date,y = value,
                  color = variable),
              size = 1)+
    geom_segment(data = abline_df,
                 aes(x = x,xend = x,
                     y = y,yend = yend),
                 linetype = 'dashed',
                 size = 0.5)+
    geom_segment(data = pathdfc1,
                 aes(x = x,xend =xend,
                     y = y,yend = y),
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'),
                 size = 0.5)+
    geom_segment(data = pathdfc2,
                 aes(x = x,xend =x,
                     y = y,yend = yend),
                 size = 0.5)+
    geom_text(data = irdf,
              aes(x = x,y = y,label = label,
                  color = variable),
              size = 4,
              fontface = 'bold')+
    scale_color_manual(values = cols)+
    facet_wrap(~type,nrow = 1)+
    theme_bw()+
    theme(legend.position = 'none')
  #############
  
  cluster_traj_df = fread('analysis_output/fig2/cluster_traj_df.csv')
  cluster_traj_df = as.data.frame(cluster_traj_df)
  route_col = pal_npg()(10)[4]
  route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
  
  route_col = colorRampPalette(brewer.pal(
    9,'Blues'
  ))(20)
  
  pmap = ggplot()+
    ###########
  geom_tile(data = dfato,
            aes(x = long,
                y = lat,
                fill = cuts),
            color = 'transparent')+
    scale_fill_manual(values = fillato,
                      guide = guide_legend(
                        title = 'PME-ATO-MMK',
                        title.position = 'top',
                        nrow = 2
                      ))+
    new_scale_fill()+
    geom_tile(data = twsmmk,
              aes(x = long,
                  y = lat,
                  fill = cuts),
              color = 'transparent')+
    
    scale_fill_manual(values = filltwsmmk,
                      guide = guide_legend(
                        title = 'TWS-MMK',
                        title.position = 'top',
                        nrow = 2
                      ))+
    geom_segment(data = cur_df1,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.15,'cm'),
                               type = 'open'),
                 color = cols[4])+
    geom_segment(data = cur_df2,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.2,'cm'),
                               type = 'open'),
                 color = cols[6])+
    
    geom_polygon(data = worlddf,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_polygon(data = xjdf,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_path(data = cluster_traj_df,aes(x = long,y = lat,
                                         group = routeid,
                                         color = factor(
                                           routeid,
                                           levels = 1:20
                                         )),
              size = 0.5,
              linetype = 'solid',
              #color = route_col[5],
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="open"))+
    scale_color_manual(values = route_col,
                       guide = 'none')+
    geom_polygon(data = subs_shp,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    
    facet_wrap(~type,ncol = 1,
               scales = 'free')+
    #coord_sf()+
    theme_bw()+
    ###########
  theme(legend.position = 'none')+
    ylab('Latitude')
  
  world_crop = crop(world,
                    extent(-5,125,30,60))
  
  subs_label = data.frame(
    x = c(10,
          rep(30,3),
          rep(50,2),
          rep(70,2),
          rep(90,1),
          rep(110,1)),
    y = c(35,
          seq(35,60,10),
          seq(35,50,10),
          seq(35,50,10),
          45,
          40),
    label = paste0('SW',1:10)
  )
  
  pmap2= ggplot()+
    ##########
  geom_polygon(data = subs_shp,
               aes(x = long,
                   y = lat,
                   group = group),
               color = 'black',
               fill = 'transparent',
               size = 0.5)+
    geom_text(data = subs_label,
              aes(x = x,y =y ,label = label),
              size = 2.3,
              fontface = 'bold')+
    #coord_sf()+
    theme_void()+
    coord_fixed(1.3)+
    ###########
  theme(
    plot.background = element_rect(
      fill = 'white'
    )
  )
  
  
  # mmk analysis statistic for each subs and ato13
  input_mean_mmk = 'analysis_output/fig4/bars_mmk_mean'
  input1 = paste0(input_mean_mmk,'/','substws_mmk245.csv')
  input2 = paste0(input_mean_mmk,'/','substws_mmk585.csv')
  
  input3 = paste0(input_mean_mmk,'/',
                  'pme_mmk_ssp245.csv')
  input4 = paste0(input_mean_mmk,'/',
                  'pme_mmk_ssp585.csv')
  
  substws_mmk245 = as.data.frame(fread(input1))
  substws_mmk585 = as.data.frame(fread(input2))
  pme_mmk245 = as.data.frame(fread(input3))
  pme_mmk585 = as.data.frame(fread(input4))
  
  dfmmk_mean245 = rbind(substws_mmk245,pme_mmk245)
  dfmmk_mean585 = rbind(substws_mmk585,
                        pme_mmk585)
  
  fillbar = colorRampPalette(pal_npg()(9))(12)
  fillbar2 = colorRampPalette(brewer.pal(10,'Spectral'))(12)
  
  label_df1 =data.frame(
    y = dfmmk_mean245$Region,
    x = abs(dfmmk_mean245$MMK)-1,
    labels = round(dfmmk_mean245$MMK,1)
  )
  
  label_df2 =data.frame(
    y = dfmmk_mean585$Region,
    x = abs(dfmmk_mean585$MMK)-1,
    labels = round(dfmmk_mean585$MMK,1)
  )
  
  order245 = order(abs(dfmmk_mean245$MMK),
                   decreasing = T)
  order585 = order(abs(dfmmk_mean585$MMK),
                   decreasing = T)
  subs1 = dfmmk_mean245$Region[order245]
  subs2 = dfmmk_mean585$Region[order585]
  
  dfmmk_mean245$Region = 
    factor(dfmmk_mean245$Region,
           levels = subs1)
  dfmmk_mean585$Region = 
    factor(dfmmk_mean585$Region,
           levels = subs2)
  
  label_df1$y = factor(label_df1$y
                       ,levels = subs1)
  label_df2$y = factor(label_df2$y,
                       levels = subs2)
  
  pbar1 = ggplot()+
    ##############
  geom_bar(data = dfmmk_mean245,
           aes(x = abs(MMK),y = Region,
               fill = Region),
           stat = 'identity',
           position = "dodge",
           width = 0.8,alpha = 0.8)+
    geom_text(data = label_df1,
              aes(x = x,y = y, label = labels),
              color = 'black',size = 3,hjust =0.5)+
    scale_x_continuous(breaks = c(0,1,2,3,4),
                       labels =c(0,-1,-2,-3,-4))+
    scale_fill_manual(values = fillbar)+
    theme_bw()+
    theme(
      legend.position = 'none',
      panel.border = element_rect(fill = 'transparent',
                                  color = 'transparent'),
      axis.title = element_text(size = 10,color = 'black',
                                hjust = 0.5),
      panel.background = element_rect(fill = 'transparent',
                                      color = 'transparent'),
      panel.grid =element_blank(),
      axis.text = element_text(size = 5,color = 'black',hjust = 0.5),
      axis.line.x = element_line(color= 'black',size = 0.5))+
    ##############
  xlab('Regions')+
    ylab('MMK')
  
  pbar2 = ggplot()+
    ##############
  geom_bar(data = dfmmk_mean585,
           aes(x = abs(MMK) ,y =Region,
               fill = Region),
           stat = 'identity',
           position = "dodge",
           width = 0.8,alpha = 0.8)+
    geom_text(data = label_df2,
              aes(x = x,y = y, label = labels),
              color = 'black',size = 3,hjust =0.5)+
    scale_x_continuous(breaks = c(0,2,4,6,8),
                       labels =c(0,-2,-4,-6,-8))+
    scale_fill_manual(values = fillbar)+
    theme_bw()+
    theme(
      legend.position = 'none',
      panel.border = element_rect(fill = 'transparent',
                                  color = 'transparent'),
      axis.title = element_text(size = 5,color = 'black',
                                hjust = 0.5),
      panel.background = element_rect(fill = 'transparent',
                                      color = 'transparent'),
      panel.grid =element_blank(),
      axis.text = element_text(size = 5,color = 'black',hjust = 0.5),
      axis.line.x = element_line(color= 'black',size = 0.5))+
    xlab('Regions')+
    ylab('MMK')
  ##############
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  re_axis_title = 
    theme(axis.title.x = element_blank())
  axis_angel = theme(
    axis.text.x = element_text(
      color = 'black',
      size = fontsize,
      angle = 15)
  )
  
  pline1 = pline1+text_theme_set+re_axis_title
  #+axis_angel
  pline_whole = pline_whole+text_theme_set+re_axis_title
  pmap = pmap+text_theme_set+re_axis_title
  
  pline12 = pline1+theme(axis.title = element_blank())
  pmap = pmap+theme(axis.title = element_blank())
  pline_whole = pline_whole+theme(axis.title = element_blank())
  
  pline_whole = pline_whole+
    theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),'cm'),
          strip.text = element_blank())
  pmap = pmap+
    theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),'cm'),
          strip.text = element_blank())
  pline12 = pline12+
    theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),'cm'),
          strip.text = element_blank())
  
  library(cowplot)
  p1 = plot_grid(pline_whole,pmap,
                 align = 'hv',
                 axis = 'lr',
                 rel_widths = c(1,1),
                 rel_heights = c(3,6),
                 ncol = 1)
  
  p12 = plot_grid(p1,pline12,
                  align = 'hv',
                  axis = 'lr',
                  rel_widths = c(2,1.5),
                  rel_heights = c(1,1),
                  nrow = 1)
  
  pbar1 = pbar1+
    theme(
      axis.title = element_blank(),
      axis.text.y = element_text(
        size = 9,color = 'black'
      ),
      axis.text.x = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      plot.background = element_rect(
        fill= 'transparent',
        color = 'transparent'
      )
      
    )
  pbar2 = pbar2+
    theme(
      axis.title = element_blank(),
      axis.text.y = element_text(
        size = 9,color = 'black'
      ),
      axis.text.x = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      plot.background  = element_rect(
        fill= 'transparent',
        color = 'transparent'
      )
    )
  
  p123 = ggdraw()+
    draw_plot(p12)+
    draw_plot(pbar1,x = 0.06, y = 0.352,
              width = 0.11, height = 0.22)+
    draw_plot(pbar2,x = 0.06, y = 0.02,
              width = 0.11, height = 0.22)+
    draw_plot(pmap2,x = 0.404, y = 0.329,
              width = 0.16, height = 0.15)+
    draw_plot(pmap2,x = 0.404, y = -0.007,
              width = 0.16, height = 0.15)
  
  png('main_plot/fig4/fig4_final_projected.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(p123)
  dev.off()
  
  legend_set = theme(
    legend.position = 'bottom'
  )
  library(ggpubr)
  pline1_legend = as_ggplot(
    get_legend(pline1+legend_set+
                 guides(color = guide_legend(
                   title = '',
                   title.position = 'top'
                 )))
  )
  
  pmap_legend = as_ggplot(
    get_legend(pmap+legend_set))
  
  png('main_plot/fig4/pmap_legend_proj.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(pmap_legend)
  dev.off()
  
  png('main_plot/fig4/pline1_legend_proj.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(pline1_legend)
  dev.off()
  
  
  
}



fig4_projection_of_tws_subs_version4 <- function(
  
){
  library(ggplot2)
  library(raster)
  input_tws = 'analysis_output/fig4/project_tws'
  input_tws = list.files(input_tws,full.names = T)
  
  
  tws245_maxmin = as.data.frame(fread(input_tws[1]))
  tws245_mean = as.data.frame(
    fread(input_tws[2])
  )
  
  tws585_maxmin = as.data.frame(
    fread(input_tws[3])
  )
  tws585_mean = as.data.frame(
    fread(input_tws[4])
  )
  
  colnames(tws245_mean) = c('date',
                            'variable',
                            'value')
  colnames(tws585_mean) = c('date',
                            'variable',
                            'value')
  
  tws245_mean$type = 'SSP245_TWS'
  tws585_mean$type = 'SSP585_TWS'
  tws245_maxmin$type = 'SSP245_TWS'
  tws585_maxmin$type = 'SSP585_TWS'
  
  
  sub_to_year_fun <- function(df){
    year = 2018:2050
    var  = paste0('SW',1:10)
    value = 1
    type = as.character(unique(df$type))
    for(i in 1:10){
      tmpid = which(df$variable %in% var[i])
      x = c(df[tmpid,3],rep(NA,6))
      xm = matrix(x,nrow = 12)
      
      xm = apply(xm,2,sum,na.rm = T)
      value = c(value,xm)
    }
    value = value[-1]
    retdf = data.frame(
      date = year,
      variable = rep(var,each = length(year)),
      value = value,
      type = type
    )
    return(retdf)
  }
  sub_to_year_fun_maxmin <- function(df){
    year = 2018:2050
    var  = paste0('SW',1:10)
    max = 1
    min = 1
    type = as.character(unique(df$type))
    for(i in 1:10){
      
      tmpid = which(df$variable %in% var[i])
      x = c(df[tmpid,3],rep(NA,6))
      xm = matrix(x,nrow = 12)
      xm = apply(xm,2,sum,na.rm = T)
      #xm = stand_fun(xm)
      max = c(max,xm)
      
      x = c(df[tmpid,4],rep(NA,6))
      xm = matrix(x,nrow = 12)
      xm = apply(xm,2,sum,na.rm = T)
      #xm = stand_fun(xm)
      min = c(min,xm)
    }
    max =max[-1]
    min = min[-1]
    retdf = data.frame(
      date = year,
      variable = rep(var,each = length(year)),
      max = max,
      min = min,
      type = type
    )
    return(retdf)
  }
  tws245_mean = sub_to_year_fun(tws245_mean)
  tws585_mean = sub_to_year_fun(tws585_mean)
  tws245_maxmin = sub_to_year_fun_maxmin(tws245_maxmin)
  tws585_maxmin = sub_to_year_fun_maxmin(tws585_maxmin)
  
  source('/home/share/R_project/xinjiang_vapor/cal_increasing_rate.R')
  cr245 = cal_increasing_rate(tws245_mean)
  cr585 = cal_increasing_rate(tws585_mean)
  
  cr245_whole = cr245[[2]]
  cr585_whole = cr585[[2]]
  cr245 = cr245[[1]]
  cr585 = cr585[[1]]
  
  df = rbind(tws245_mean,tws585_mean)
  df$variable = paste0('H',df$variable)
  df$variable = factor(df$variable,
                       levels = paste0("HSW",1:10))
  df2 = rbind(tws245_maxmin,tws585_maxmin)
  df2$variable = factor(df2$variable,
                        levels = paste0('HSW',1:10))
  
  source('/home/share/R_project/xinjiang_vapor/import_pme_ato_fig4.R')
  pmedf = import_pme_ato_fig4(T)
  
  library(ggsci)
  col1 = pal_lancet(alpha = 0.8)(9)
  library(RColorBrewer)
  a = colorRampPalette(col1)(20)
  pals2 = pal_lancet(alpha = 0.8)(9)
  pals2 = colorRampPalette(pals2)(40)
  twscol = c('SSP245_TWS' = '#E2746E',
             'SSP585_TWS' = '#C12C44')
  pmecol = c('SSP245_PME1' = '#0B94B2',
             'SSP585_PME1' = '#2988AE',
             'SSP245_PME3' = '#00468B',
             'SSP585_PME3' = '#30376E')
  cols = c(twscol,pmecol)
  
  library(Rmisc)
  
  pathdf1 = data.frame(
    x = c(2018,2031,2031,2050),
    xend = c(2031,2050,2018,2031),
    y = c(4.5,4.5,4.5,4.5)-1+0.5
  )
  pathdf2 = data.frame(
    x = c(2018,2031,2050),
    y = rep(4.2,3)-1+0.5,
    yend = rep(4.8,3)-1+0.5
  )
  pathdf3 = data.frame(
    x = c(2018,2031,2031,2050),
    xend = c(2031,2050,2018,2031),
    y = rep(-4.5,2)+0.5
  )
  pathdf4 = data.frame(
    x = c(2018,2031,2050),
    y = c(-4.8,-4.8,-4.8)+0.5,
    yend = c(-4.2,-4.2,-4.2)
  )
  pathdf11 = pathdf1
  pathdf21 = pathdf2
  pathdf31 = pathdf3
  pathdf41 = pathdf4
  pathdf12 = pathdf1
  pathdf22 = pathdf2
  pathdf32 = pathdf3
  pathdf42 = pathdf4
  
  
  pathdf11$type = '(a) Regional mean standard indices under SSP245'
  pathdf21$type = '(a) Regional mean standard indices under SSP245'
  pathdf31$type = '(a) Regional mean standard indices under SSP245'
  pathdf41$type = '(a) Regional mean standard indices under SSP245'
  
  pathdf12$type = '(b) Regional mean standard indices under SSP585'
  pathdf22$type = '(b) Regional mean standard indices under SSP585'
  pathdf32$type = '(b) Regional mean standard indices under SSP585'
  pathdf42$type = '(b) Regional mean standard indices under SSP585'
  
  pathdfc1 = rbind(pathdf11,
                   pathdf12,
                   pathdf31,
                   pathdf32)
  pathdfc2 = rbind(pathdf21,
                   pathdf22,
                   pathdf41,
                   pathdf42)
  
  
  cr245$y = 5.3-1+0.5
  cr585$y = 3.6-1+0.5
  year = 2018:2050
  cr245$x = year[cr245$x]
  cr585$x = year[cr585$x]
  
  cr245$variable = paste0('H',cr245$variable)
  cr585$variable = paste0('H',cr585$variable)
  
  cr245$variable = factor(cr245$variable,
                          levels = paste0('HSW',1:10))
  cr585$variable = factor(cr585$variable,
                          levels = paste0('HSW',1:10))
  
  pline1 = ggplot()+
    #geom_ribbon(data = df2,aes(x = date,
    #                           ymax = max,
    #                           ymin = min),
    #            fill = '#87CEFA',
    #            alpha = 0.5)+
    geom_text(data = cr245,
              aes(x = x, y = y,label = label),
              size = 3.5,
              color = '#E2746E',
              fontface = 'bold')+
    geom_text(data = cr585,
              aes(x = x,y = y , label = label),
              size = 3.5,
              color = '#C12C44',
              fontface = 'bold')+
    geom_vline(xintercept = 2031,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_vline(xintercept = 2018,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_vline(xintercept = 2050,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_line(data = pmedf,
              aes(x = date,
                  y = value,
                  color = type),
              size = 1,
              alpha = 0.8)+
    geom_segment(data = pathdf1,
                 aes(x = x,xend =xend,
                     y = y,yend = y),
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'),
                 size = 0.5)+
    geom_segment(data = pathdf2,
                 aes(x = x,xend =x,
                     y = y,yend = yend),
                 size = 0.5)+
    geom_line(data = df,aes(x = date,
                            y = value,
                            color = type),
              size = 1)+
    
    #scale_fill_manual(values= fills)+
    scale_y_continuous(limits = c(-3,6),
                       position = 'left')+
    
    scale_color_manual(values = cols)+
    facet_wrap(~variable,ncol = 2)+
    theme_bw()+
    theme(legend.position = 'none')+
    ylab('Normalized indices')
  
  library(data.table)
  
  
  source('/home/share/R_project/xinjiang_vapor/cal_mean_tws_among_windows.R')
  mean_tws245 = cal_mean_tws_among_windows(tws245_mean,
                                           mode = 'mean')
  mean_tws585 = cal_mean_tws_among_windows(tws585_mean,
                                           mode = 'mean')
  
  fwrite(mean_tws245,'NC_mod_xinjiang/main_plot/fig_evaluate_pmecmip6/mean_tws245.csv')
  fwrite(mean_tws585,'NC_mod_xinjiang/main_plot/fig_evaluate_pmecmip6/mean_tws585.csv')
  
  mean_maxmin_tws245 = cal_mean_tws_among_windows(tws245_maxmin,
                                                  mode = 'max')
  
  mean_maxmin_tws585 = cal_mean_tws_among_windows(tws585_maxmin,
                                                  mode = 'max')
  mean_tws245$type = '(a) Regional mean standard indices under SSP245'
  mean_tws585$type = '(b) Regional mean standard indices under SSP585'
  
  pmedf1 = pmedf
  colnames(pmedf1) = c('date','variable','value')
  pmedf245 = pmedf1[
    which(pmedf1$variable %in% c('SSP245_PME1',
                                 'SSP245_PME3')),]
  pmedf585 = pmedf1[
    which(pmedf1$variable %in% c('SSP585_PME1',
                                 'SSP585_PME3')),
    ]
  pmedf245$type = '(a) Regional mean standard indices under SSP245'
  pmedf585$type = '(b) Regional mean standard indices under SSP585'
  
  library(prophet)
  source('/home/share/R_project/xinjiang_vapor/cal_increasing_rate_whole.R')
  ir_tws245 = cal_increasing_rate_whole(mean_tws245,
                                        'TWS_245')
  ir_tws585 = cal_increasing_rate_whole(mean_tws585,
                                        'TWS_585')
  ir_pme245 = cal_increasing_rate_whole(
    pmedf245,
    'SSP245_PME'
  )
  ir_pme585 = cal_increasing_rate_whole(pmedf585,
                                        'SSP585_PME')
  crytws= 4.8-0.2
  crypme1 = -4.5+0.5+0.6
  crypme2 = -5+0.5-0.3
  ir_tws245$y = crytws
  ir_tws585$y = crytws
  ir_pme245$y = c(crypme1,crypme2)
  ir_pme585$y =  c(crypme1,crypme2)
  
  ir_tws245$type = '(a) Regional mean standard indices under SSP245'
  ir_pme245$type = '(a) Regional mean standard indices under SSP245'
  ir_tws585$type = '(b) Regional mean standard indices under SSP585'
  ir_pme585$type = '(b) Regional mean standard indices under SSP585'
  
  irdf = rbind(ir_tws245,ir_pme245,
               ir_tws585,ir_pme585)
  irdf$x = year[irdf$x]
  
  # import pme ato mmk
  input_ato1 = 'analysis_output/fig4/ato_mmk_ssp245.nc'
  input_ato2 = 'analysis_output/fig4/ato_mmk_ssp585.nc'
  
  ato245 = raster(input_ato1)
  ato585 = raster(input_ato2)
  #aim 0.25
  rs = raster(nrow = 329,ncol = 626)
  extent(rs) = extent(c(-127.25,29.25,0,82.25))
  ato245r = resample(ato245,rs)
  ato585r = resample(ato585,rs)
  
  ato245df = as.data.frame(ato245r,
                           xy = T)
  ato585df = as.data.frame(ato585r,
                           xy = T)
  
  colnames(ato245df) = c('long','lat','SSP245-PME-MMK')
  colnames(ato585df) = c('long','lat','SSP585-PME-MMK')
  
  dfato1 = reshape2::melt(ato245df,
                          c('long','lat'))
  dfato2 = reshape2::melt(ato585df,
                          c('long','lat'))
  
  idless0 = which(dfato1$value < 0)
  idless02 = which(dfato2$value <0)
  
  dfato1 = dfato1[idless0,]
  dfato2 = dfato2[idless02,]
  
  dfato1$type = '(c) SSP245'
  dfato2$type = '(d) SSP585'
  
  dfato = rbind(dfato1,dfato2)
  dfato$cuts = cut(dfato$value,
                   breaks = c(-13,seq(-4,0,1)))
  
  fillato = colorRampPalette(
    brewer.pal(9,'YlOrRd')
  )(25)
  #sea_pme_mmk_pal = sea_pme_mmk_pal[1:]
  fillato = rev(fillato)
  fillato = fillato[seq(1,25,5)]
  
  
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  worlddf = fortify(world)
  worlddf1 = worlddf
  worlddf2 = worlddf
  
  worlddf1$type = '(c) SSP245'
  worlddf2$type = "(d) SSP585"
  worlddf = rbind(worlddf1,worlddf2)
  
  
  input_twsmmk = 'analysis_output/fig4/tws_subs_mmk/tws_mmk_subs_era5model.csv'
  twsmmk = fread(input_twsmmk)
  
  colnames(twsmmk) = c('long','lat',
                       '(c) SSP245','(d) SSP585')
  twsmmk = reshape2::melt(twsmmk,c('long','lat'))
  twsmmk$type = twsmmk$variable
  
  idless0 = which(twsmmk$value <0)
  twsmmk = twsmmk[idless0,]
  
  twsmmk$cuts = cut(twsmmk$value,
                    breaks = c(-63,seq(-10,0,1)))
  
  filltwsmmk = colorRampPalette(
    brewer.pal(9,'YlOrRd')
  )(25)
  filltwsmmk = rev(filltwsmmk)
  filltwsmmk = filltwsmmk[seq(1,25,2)][1:11]
  
  input_subs = 'sub_windows'
  num = 1:19
  input_subs = paste0(input_subs,'/sub_window',num,'.shp')
  
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  input_subs = input_subs[id_box]
  subs_shp = lapply(input_subs,shapefile)
  subs_shp = do.call('bind',subs_shp)
  subs_shp1 = fortify(subs_shp)
  subs_shp2 = fortify(subs_shp)
  
  subs_shp1$type = '(c) SSP245'
  subs_shp2$type = '(d) SSP585'
  subs_shp = rbind(subs_shp1,subs_shp2)
  
  xj = shp_management('xinjiang')
  xjdf = fortify(xj)
  xjdf1 = xjdf
  xjdf2 = xjdf
  xjdf1$type = '(c) SSP245'
  xjdf2$type = '(d) SSP585'
  xjdf = rbind(xjdf1,xjdf2)
  
  library(ggnewscale)
  
  ato1 = shapefile('cluster_shp/ato/ato1.shp')
  ato3 = shapefile('cluster_shp/ato/ato3.shp')
  
  cur_df = as.data.frame(
    fread('analysis_output/fig4/current_df.csv')
  )
  
  idless50 = which(cur_df$lat <= 50)
  cur_df = cur_df[idless50,]
  
  idbig1 = which(cur_df$u>0 &
                   cur_df$v >0)
  idbig2 = which(cur_df$u<0 &
                   cur_df$v >0)
  
  cur_df1 = cur_df[idbig1,]
  cur_df2 = cur_df[idbig2,]
  
  cid1 = seq(1,nrow(cur_df1),30)
  cid2 = seq(1,nrow(cur_df2),200)
  
  cur_df1 = cur_df1[cid1,]
  cur_df2 = cur_df2[cid2,]
  cur_df1$type = '(c) SSP245'
  cur_df11 = cur_df1
  cur_df2$type = '(c) SSP245'
  cur_df21 = cur_df2
  cur_df11$type = '(d) SSP585'
  cur_df21$type = '(d) SSP585'
  
  cur_df1 = rbind(cur_df1,cur_df11)
  cur_df2 = rbind(cur_df2,cur_df21)
  
  abline_df = data.frame(
    x = rep(c(2018,2031,2050),2),
    y = rep(c(-5,-5,-5),2),
    yend = rep(c(5,5,5),2),
    type = rep(c('(a) Regional mean standard indices under SSP245',
                 '(b) Regional mean standard indices under SSP585'),
               each =  3))  
  
  
  pline_whole = ggplot()+
    ###########
  geom_line(data = mean_tws245,
            aes(x = date,y = value,
                color = variable),
            size = 1.5)+
    geom_line(data = mean_tws585,
              aes(x = date,y = value,
                  color = variable),
              size = 1.5)+
    geom_line(data = pmedf245,
              aes(x = date,y = value,
                  color = variable),
              size = 1)+
    geom_line(data = pmedf585,
              aes(x = date,y = value,
                  color = variable),
              size = 1)+
    geom_segment(data = abline_df,
                 aes(x = x,xend = x,
                     y = y,yend = yend),
                 linetype = 'dashed',
                 size = 0.5)+
    geom_segment(data = pathdfc1,
                 aes(x = x,xend =xend,
                     y = y,yend = y),
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'),
                 size = 0.5)+
    geom_segment(data = pathdfc2,
                 aes(x = x,xend =x,
                     y = y,yend = yend),
                 size = 0.5)+
    geom_text(data = irdf,
              aes(x = x,y = y,label = label,
                  color = variable),
              size = 4,
              fontface = 'bold')+
    scale_color_manual(values = cols)+
    facet_wrap(~type,nrow = 1)+
    theme_bw()+
    theme(legend.position = 'none')
  #############
  
  cluster_traj_df = fread('analysis_output/fig2/cluster_traj_df.csv')
  cluster_traj_df = as.data.frame(cluster_traj_df)
  route_col = pal_npg()(10)[4]
  route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
  
  route_col = colorRampPalette(brewer.pal(
    9,'Blues'
  ))(20)
  
  pmap = ggplot()+
    ###########
  geom_tile(data = dfato,
            aes(x = long,
                y = lat,
                fill = cuts),
            color = 'transparent')+
    scale_fill_manual(values = fillato,
                      guide = guide_legend(
                        title = 'PME-ATO-MMK',
                        title.position = 'top',
                        nrow = 2
                      ))+
    new_scale_fill()+
    geom_tile(data = twsmmk,
              aes(x = long,
                  y = lat,
                  fill = cuts),
              color = 'transparent')+
    
    scale_fill_manual(values = filltwsmmk,
                      guide = guide_legend(
                        title = 'TWS-MMK',
                        title.position = 'top',
                        nrow = 2
                      ))+
    geom_segment(data = cur_df1,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.15,'cm'),
                               type = 'open'),
                 color = cols[4])+
    geom_segment(data = cur_df2,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.2,'cm'),
                               type = 'open'),
                 color = cols[6])+
    
    geom_polygon(data = worlddf,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_polygon(data = xjdf,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_path(data = cluster_traj_df,aes(x = long,y = lat,
                                         group = routeid,
                                         color = factor(
                                           routeid,
                                           levels = 1:20
                                         )),
              size = 0.5,
              linetype = 'solid',
              #color = route_col[5],
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="open"))+
    scale_color_manual(values = route_col,
                       guide = 'none')+
    geom_polygon(data = subs_shp,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    
    facet_wrap(~type,ncol = 1,
               scales = 'free')+
    #coord_sf()+
    theme_bw()+
    ###########
  theme(legend.position = 'none')+
    ylab('Latitude')
  
  world_crop = crop(world,
                    extent(-5,125,30,60))
  
  subs_label = data.frame(
    x = c(10,
          rep(30,3),
          rep(50,2),
          rep(70,2),
          rep(90,1),
          rep(110,1)),
    y = c(35,
          seq(35,60,10),
          seq(35,50,10),
          seq(35,50,10),
          45,
          40),
    label = paste0('SW',1:10)
  )
  
  pmap2= ggplot()+
    ##########
  geom_polygon(data = subs_shp,
               aes(x = long,
                   y = lat,
                   group = group),
               color = 'black',
               fill = 'transparent',
               size = 0.5)+
    geom_text(data = subs_label,
              aes(x = x,y =y ,label = label),
              size = 2.3,
              fontface = 'bold')+
    #coord_sf()+
    theme_void()+
    coord_fixed(1.3)+
    ###########
  theme(
    plot.background = element_rect(
      fill = 'white'
    )
  )
  
  
  # mmk analysis statistic for each subs and ato13
  input_mean_mmk = 'analysis_output/fig4/bars_mmk_mean'
  input1 = paste0(input_mean_mmk,'/','substws_mmk245.csv')
  input2 = paste0(input_mean_mmk,'/','substws_mmk585.csv')
  
  input3 = paste0(input_mean_mmk,'/',
                  'pme_mmk_ssp245.csv')
  input4 = paste0(input_mean_mmk,'/',
                  'pme_mmk_ssp585.csv')
  
  substws_mmk245 = as.data.frame(fread(input1))
  substws_mmk585 = as.data.frame(fread(input2))
  pme_mmk245 = as.data.frame(fread(input3))
  pme_mmk585 = as.data.frame(fread(input4))
  
  dfmmk_mean245 = rbind(substws_mmk245,pme_mmk245)
  dfmmk_mean585 = rbind(substws_mmk585,
                        pme_mmk585)
  
  fillbar = colorRampPalette(pal_npg()(9))(12)
  fillbar2 = colorRampPalette(brewer.pal(10,'Spectral'))(12)
  
  label_df1 =data.frame(
    y = dfmmk_mean245$Region,
    x = abs(dfmmk_mean245$MMK)-1,
    labels = round(dfmmk_mean245$MMK,1)
  )
  
  label_df2 =data.frame(
    y = dfmmk_mean585$Region,
    x = abs(dfmmk_mean585$MMK)-1,
    labels = round(dfmmk_mean585$MMK,1)
  )
  
  order245 = order(abs(dfmmk_mean245$MMK),
                   decreasing = T)
  order585 = order(abs(dfmmk_mean585$MMK),
                   decreasing = T)
  subs1 = dfmmk_mean245$Region[order245]
  subs2 = dfmmk_mean585$Region[order585]
  
  dfmmk_mean245$Region = 
    factor(dfmmk_mean245$Region,
           levels = subs1)
  dfmmk_mean585$Region = 
    factor(dfmmk_mean585$Region,
           levels = subs2)
  
  label_df1$y = factor(label_df1$y
                       ,levels = subs1)
  label_df2$y = factor(label_df2$y,
                       levels = subs2)
  
  pbar1 = ggplot()+
    ##############
  geom_bar(data = dfmmk_mean245,
           aes(x = abs(MMK),y = Region,
               fill = Region),
           stat = 'identity',
           position = "dodge",
           width = 0.8,alpha = 0.8)+
    geom_text(data = label_df1,
              aes(x = x,y = y, label = labels),
              color = 'black',size = 3,hjust =0.5)+
    scale_x_continuous(breaks = c(0,1,2,3,4),
                       labels =c(0,-1,-2,-3,-4))+
    scale_fill_manual(values = fillbar)+
    theme_bw()+
    theme(
      legend.position = 'none',
      panel.border = element_rect(fill = 'transparent',
                                  color = 'transparent'),
      axis.title = element_text(size = 10,color = 'black',
                                hjust = 0.5),
      panel.background = element_rect(fill = 'transparent',
                                      color = 'transparent'),
      panel.grid =element_blank(),
      axis.text = element_text(size = 5,color = 'black',hjust = 0.5),
      axis.line.x = element_line(color= 'black',size = 0.5))+
    ##############
  xlab('Regions')+
    ylab('MMK')
  
  pbar2 = ggplot()+
    ##############
  geom_bar(data = dfmmk_mean585,
           aes(x = abs(MMK) ,y =Region,
               fill = Region),
           stat = 'identity',
           position = "dodge",
           width = 0.8,alpha = 0.8)+
    geom_text(data = label_df2,
              aes(x = x,y = y, label = labels),
              color = 'black',size = 3,hjust =0.5)+
    scale_x_continuous(breaks = c(0,2,4,6,8),
                       labels =c(0,-2,-4,-6,-8))+
    scale_fill_manual(values = fillbar)+
    theme_bw()+
    theme(
      legend.position = 'none',
      panel.border = element_rect(fill = 'transparent',
                                  color = 'transparent'),
      axis.title = element_text(size = 5,color = 'black',
                                hjust = 0.5),
      panel.background = element_rect(fill = 'transparent',
                                      color = 'transparent'),
      panel.grid =element_blank(),
      axis.text = element_text(size = 5,color = 'black',hjust = 0.5),
      axis.line.x = element_line(color= 'black',size = 0.5))+
    xlab('Regions')+
    ylab('MMK')
  ##############
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  re_axis_title = 
    theme(axis.title.x = element_blank())
  axis_angel = theme(
    axis.text.x = element_text(
      color = 'black',
      size = fontsize,
      angle = 15)
  )
  
  pline1 = pline1+text_theme_set+re_axis_title
  #+axis_angel
  pline_whole = pline_whole+text_theme_set+re_axis_title
  pmap = pmap+text_theme_set+re_axis_title
  
  pline12 = pline1+theme(axis.title = element_blank())
  pmap = pmap+theme(axis.title = element_blank())
  pline_whole = pline_whole+theme(axis.title = element_blank())
  
  pline_whole = pline_whole+
    theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),'cm'),
          strip.text = element_blank())
  pmap = pmap+
    theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),'cm'),
          strip.text = element_blank())
  pline12 = pline12+
    theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),'cm'),
          strip.text = element_blank())
  
  library(cowplot)
  p1 = plot_grid(pline_whole,pmap,
                 align = 'hv',
                 axis = 'lr',
                 rel_widths = c(1,1),
                 rel_heights = c(3,6),
                 ncol = 1)
  
  p12 = plot_grid(p1,pline12,
                  align = 'hv',
                  axis = 'lr',
                  rel_widths = c(2,1.5),
                  rel_heights = c(1,1),
                  nrow = 1)
  
  pbar1 = pbar1+
    theme(
      axis.title = element_blank(),
      axis.text.y = element_text(
        size = 9,color = 'black'
      ),
      axis.text.x = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      plot.background = element_rect(
        fill= 'transparent',
        color = 'transparent'
      )
      
    )
  pbar2 = pbar2+
    theme(
      axis.title = element_blank(),
      axis.text.y = element_text(
        size = 9,color = 'black'
      ),
      axis.text.x = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      plot.background  = element_rect(
        fill= 'transparent',
        color = 'transparent'
      )
    )
  
  p123 = ggdraw()+
    draw_plot(p12)+
    draw_plot(pbar1,x = 0.06, y = 0.352,
              width = 0.11, height = 0.22)+
    draw_plot(pbar2,x = 0.06, y = 0.02,
              width = 0.11, height = 0.22)+
    draw_plot(pmap2,x = 0.404, y = 0.329,
              width = 0.16, height = 0.15)+
    draw_plot(pmap2,x = 0.404, y = -0.007,
              width = 0.16, height = 0.15)
  
  png('main_plot/fig4/fig4_final10.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(p123)
  dev.off()
  
  legend_set = theme(
    legend.position = 'bottom'
  )
  library(ggpubr)
  pline1_legend = as_ggplot(
    get_legend(pline1+legend_set+
                 guides(color = guide_legend(
                   title = '',
                   title.position = 'top'
                 )))
  )
  
  pmap_legend = as_ggplot(
    get_legend(pmap+legend_set))
  
  png('main_plot/fig4/pmap_legend.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(pmap_legend)
  dev.off()
  
  png('main_plot/fig4/pline1_legend.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(pline1_legend)
  dev.off()
  
  
  
}



fig4_projection_of_tws_subs <- function(
 
){
  library(ggplot2)
  library(raster)
  input_tws = 'analysis_output/fig4/project_tws'
  input_tws = list.files(input_tws,full.names = T)
  
  
  tws245_maxmin = as.data.frame(fread(input_tws[1]))
  tws245_mean = as.data.frame(
    fread(input_tws[2])
  )
  
  tws585_maxmin = as.data.frame(
    fread(input_tws[3])
  )
  tws585_mean = as.data.frame(
    fread(input_tws[4])
  )
  
  colnames(tws245_mean) = c('date',
                            'variable',
                            'value')
  colnames(tws585_mean) = c('date',
                            'variable',
                            'value')
  
  tws245_mean$type = 'SSP245_TWS'
  tws585_mean$type = 'SSP585_TWS'
  tws245_maxmin$type = 'SSP245_TWS'
  tws585_maxmin$type = 'SSP585_TWS'
  
  sub_to_year_fun <- function(df){
    year = 2018:2050
    var  = paste0('SW',1:10)
    value = 1
    type = as.character(unique(df$type))
    for(i in 1:10){
      tmpid = which(df$variable %in% var[i])
      x = c(df[tmpid,3],rep(NA,6))
      xm = matrix(x,nrow = 12)
      
      xm = apply(xm,2,sum,na.rm = T)
      value = c(value,xm)
    }
    value = value[-1]
    retdf = data.frame(
      date = year,
      variable = rep(var,each = length(year)),
      value = value,
      type = type
    )
    return(retdf)
  }
  sub_to_year_fun_maxmin <- function(df){
    year = 2018:2050
    var  = paste0('SW',1:10)
    max = 1
    min = 1
    type = as.character(unique(df$type))
    for(i in 1:10){
    
      tmpid = which(df$variable %in% var[i])
      x = c(df[tmpid,3],rep(NA,6))
      xm = matrix(x,nrow = 12)
      xm = apply(xm,2,sum,na.rm = T)
      #xm = stand_fun(xm)
      max = c(max,xm)
      
      x = c(df[tmpid,4],rep(NA,6))
      xm = matrix(x,nrow = 12)
      xm = apply(xm,2,sum,na.rm = T)
      #xm = stand_fun(xm)
      min = c(min,xm)
    }
    max =max[-1]
    min = min[-1]
    retdf = data.frame(
      date = year,
      variable = rep(var,each = length(year)),
      max = max,
      min = min,
      type = type
    )
    return(retdf)
  }
  tws245_mean = sub_to_year_fun(tws245_mean)
  tws585_mean = sub_to_year_fun(tws585_mean)
  tws245_maxmin = sub_to_year_fun_maxmin(tws245_maxmin)
  tws585_maxmin = sub_to_year_fun_maxmin(tws585_maxmin)
  
  source('/home/share/R_project/xinjiang_vapor/cal_increasing_rate.R')
  cr245 = cal_increasing_rate(tws245_mean)
  cr585 = cal_increasing_rate(tws585_mean)
  
  cr245_whole = cr245[[2]]
  cr585_whole = cr585[[2]]
  cr245 = cr245[[1]]
  cr585 = cr585[[1]]
  
  
  id1 = which(tws245_mean$variable %in%
               paste0('SW',1:5))
  
  id2 = which(tws245_mean$variable %in%
                paste0('SW',6:10))
  
  df1 = rbind(tws245_mean[id1,],tws585_mean[id1,])
  df1$variable = factor(df1$variable,
                        levels = paste0('SW',1:5))
  
  df2 = rbind(tws245_maxmin[id1,],
              tws585_maxmin[id1,])
  df2$variable = factor(df2$variable,
                        levels = paste0('SW',1:5))
  source('/home/share/R_project/xinjiang_vapor/import_pme_ato_fig4.R')
  pmedf = import_pme_ato_fig4(T)
  
  idcr1 = which(cr245$variable %in% 
                  paste0('SW',1:5))
  idcr2 = which(cr245$variable %in% 
                  paste0('SW',6:10))
  idcr3 = which(cr245_whole$variable %in%
                  paste0('SW',1:5))
  idcr4 = which(cr245_whole$variable %in%
                  paste0('SW',6:10))
  
  
  cr245_1 = cr245[idcr1,]
  cr245_2 = cr245[idcr2,]
  cr245_whole1 = cr245_whole[idcr3,]
  cr245_whole2 = cr245_whole[idcr4,]
  
  cr585_1 = cr585[idcr1,]
  cr585_2 = cr585[idcr2,]
  cr585_whole1 = cr585_whole[idcr3,]
  cr585_whole2 = cr585_whole[idcr4,]
  
  library(ggsci)
  col1 = pal_lancet(alpha = 0.8)(9)
  library(RColorBrewer)
  a = colorRampPalette(col1)(20)
  pals2 = pal_lancet(alpha = 0.8)(9)
  pals2 = colorRampPalette(pals2)(40)
  twscol = c('SSP245_TWS' = '#E2746E',
             'SSP585_TWS' = '#C12C44')
  pmecol = c('SSP245_PME1' = '#0B94B2',
             'SSP585_PME1' = '#2988AE',
             'SSP245_PME3' = '#00468B',
             'SSP585_PME3' = '#30376E')
  cols = c(twscol,pmecol)
  
  library(Rmisc)
  
  pathdf1 = data.frame(
    x = c(2018,2031,2031,2050),
    xend = c(2031,2050,2018,2031),
    y = c(4.5,4.5,4.5,4.5)-1+0.5
  )
  pathdf2 = data.frame(
    x = c(2018,2031,2050),
    y = rep(4.2,3)-1+0.5,
    yend = rep(4.8,3)-1+0.5
  )
  pathdf3 = data.frame(
    x = c(2018,2031,2031,2050),
    xend = c(2031,2050,2018,2031),
    y = rep(-4.5,2)
  )
  pathdf4 = data.frame(
    x = c(2018,2031,2050),
    y = c(-4.8,-4.8,-4.8),
    yend = c(-4.2,-4.2,-4.2)
  )
  
  cr245_1$y = 5.3-1+0.5
  cr585_1$y = 3.6-1+0.5
  cr245_whole1$y = -3.3
  cr585_whole1$y = -3.7
  
  crdf1 = rbind(cr245_1,
                cr585_1)
  year = 2018:2050
  crdf1$x = year[crdf1$x]
  
  cr245_1$x = year[cr245_1$x]
  cr585_1$x = year[cr585_1$x]
  
  cr245_whole1$x = year[cr245_whole1$x]
  cr585_whole1$x = year[cr585_whole1$x]
  
  pline1 = ggplot()+
    
    geom_ribbon(data = df2,aes(x = date,
                               ymax = max,
                               ymin = min),
                fill = '#87CEFA',
                alpha = 0.5)+
    geom_text(data = cr245_1,
              aes(x = x, y = y,label = label),
              size = 4,
              color = '#E2746E')+
    geom_text(data = cr585_1,
              aes(x = x,y = y , label = label),
              size = 4,
              color = '#C12C44')+
    
    geom_vline(xintercept = 2031,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_vline(xintercept = 2018,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_vline(xintercept = 2050,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_line(data = pmedf,
              aes(x = date,
                y = value,
                  color = type),
              size = 1,
              alpha = 0.8)+
    geom_segment(data = pathdf1,
                 aes(x = x,xend =xend,
                     y = y,yend = y),
                 arrow = arrow(angle=30,
                                    unit('0.25','cm'),
                               type = 'closed'),
                 size = 0.5)+
    geom_segment(data = pathdf3,
                 aes(x = x,xend =xend,
                     y = y,yend = y),
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'),
                 size = 0.5)+
    geom_segment(data = pathdf2,
                 aes(x = x,xend =x,
                     y = y,yend = yend),
                 size = 0.5)+
    geom_segment(data = pathdf4,
                 aes(x = x,xend =x,
                     y = y,yend = yend),
                 size = 0.5)+
    geom_line(data = df1,aes(x = date,
                             y = value,
                             color = type),
              size = 1)+
    
    #scale_fill_manual(values= fills)+
    scale_y_continuous(limits = c(-6,5))+
    scale_color_manual(values = cols)+
    facet_wrap(~variable,nrow = 1)+
    theme_bw()+
    theme(legend.position = 'none')+
    ylab('Standardized indices')
  
  library(data.table)
 
  
  #dir.create('main_plot/fig4')
  png('main_plot/fig4/pline1_test.png',
      height = 6,
      width = 25,
      units =  'cm',
      res = 800)
  print(pline1)
  dev.off()
  
  
  df1 = rbind(tws245_mean[id2,],tws585_mean[id2,])
  df1$variable = factor(df1$variable,
                        levels = paste0('SW',6:10))
  
  df2 = rbind(tws245_maxmin[id2,],
              tws585_maxmin[id2,])
  df2$variable = factor(df2$variable,
                        levels = paste0('SW',6:10))
  
  
  cr245_2$y = 5.3-1+0.5
  cr585_2$y = 3.6-1+0.5
  cr245_whole2$y = -3.3
  cr585_whole2$y = -3.7
  
  
  crdf2 = rbind(cr245_2,
                cr585_2)
  year = 2018:2050
  crdf2$x = year[crdf2$x]
  
  cr245_2$x  = year[cr245_2$x]
  cr585_2$x  = year[cr585_2$x]
  cr245_whole2$x = year[cr245_whole2$x]
  cr585_whole2$x = year[cr585_whole2$x]
  
  pline2 = ggplot()+
    geom_ribbon(data = df2,aes(x = date,
                               ymax = max,
                               ymin = min),
                fill = '#87CEFA',
                alpha = 0.5)+
    
    geom_text(data = cr245_2,
              aes(x = x, y = y,label = label),
              size = 4,
              color = '#E2746E')+
    geom_text(data = cr585_2,
              aes(x = x,y = y , label = label),
              size = 4,
              color = '#C12C44')+
    
    geom_vline(xintercept = 2031,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_vline(xintercept = 2018,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_vline(xintercept = 2050,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_segment(data = pathdf1,
                 aes(x = x,xend =xend,
                     y = y,yend = y),
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'),
                 size = 0.5)+
    geom_segment(data = pathdf3,
                 aes(x = x,xend =xend,
                     y = y,yend = y),
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'),
                 size = 0.5)+
    geom_segment(data = pathdf2,
                 aes(x = x,xend =x,
                     y = y,yend = yend),
                 size = 0.5)+
    geom_segment(data = pathdf4,
                 aes(x = x,xend =x,
                     y = y,yend = yend),
                 size = 0.5)+
    geom_line(data = pmedf,
              aes(x = date,
                  y = value,
                  color = type),
              size = 1,
              alpha = 0.8)+
    geom_line(data = df1,aes(x = date,
                             y = value,
                             color = type),
              size = 1.5)+
    scale_y_continuous(limits = c(-6,5))+
    #scale_fill_manual(values= fills)+
    scale_color_manual(values = cols)+
    facet_wrap(~variable,nrow = 1)+
    theme_bw()+
    theme(legend.position = 'none')+
    ylab('Standardized indices')
  
  #dir.create('main_plot/fig4')
  png('main_plot/fig4/pline2_test.png',
      height = 6,
      width = 25,
      units =  'cm',
      res = 800)
  print(pline2)
  dev.off()
  
  # import pme ato mmk
  input_ato1 = 'analysis_output/fig4/ato_mmk_ssp245.nc'
  input_ato2 = 'analysis_output/fig4/ato_mmk_ssp585.nc'
  
  ato245 = raster(input_ato1)
  ato585 = raster(input_ato2)
  #aim 0.25
  rs = raster(nrow = 329,ncol = 626)
  extent(rs) = extent(c(-127.25,29.25,0,82.25))
  ato245r = resample(ato245,rs)
  ato585r = resample(ato585,rs)
  
  ato245df = as.data.frame(ato245r,
                           xy = T)
  ato585df = as.data.frame(ato585r,
                           xy = T)
  
  colnames(ato245df) = c('long','lat','SSP245-PME-MMK')
  colnames(ato585df) = c('long','lat','SSP585-PME-MMK')

  dfato1 = reshape2::melt(ato245df,
                          c('long','lat'))
  dfato2 = reshape2::melt(ato585df,
                          c('long','lat'))
  
  idless0 = which(dfato1$value < 0)
  idless02 = which(dfato2$value <0)
  
  dfato1 = dfato1[idless0,]
  dfato2 = dfato2[idless02,]
  
  dfato1$type = 'SSP245'
  dfato2$type = 'SSP585'
  
  dfato = rbind(dfato1,dfato2)
  dfato$cuts = cut(dfato$value,
                   breaks = c(-13,seq(-4,0,1)))
  
  fillato = colorRampPalette(
    brewer.pal(9,'YlOrRd')
  )(25)
  #sea_pme_mmk_pal = sea_pme_mmk_pal[1:]
  fillato = rev(fillato)
  fillato = fillato[seq(1,25,5)]
  
  
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  input_twsmmk = 'analysis_output/fig4/tws_subs_mmk/tws_mmk_subs_era5model.csv'
  twsmmk = fread(input_twsmmk)
  
  colnames(twsmmk) = c('long','lat',
                       'SSP245','SSP585')
  twsmmk = reshape2::melt(twsmmk,c('long','lat'))
  twsmmk$type = twsmmk$variable
  
  idless0 = which(twsmmk$value <0)
  twsmmk = twsmmk[idless0,]
  
  twsmmk$cuts = cut(twsmmk$value,
                    breaks = c(-63,seq(-10,0,1)))
  
  filltwsmmk = colorRampPalette(
    brewer.pal(9,'YlOrRd')
  )(25)
  filltwsmmk = rev(filltwsmmk)
  filltwsmmk = filltwsmmk[seq(1,25,2)][1:11]
  
  input_subs = 'sub_windows'
  num = 1:19
  input_subs = paste0(input_subs,'/sub_window',num,'.shp')
  
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  input_subs = input_subs[id_box]
  subs_shp = lapply(input_subs,shapefile)
  subs_shp = do.call('bind',subs_shp)
  
  xj = shp_management('xinjiang')
  library(ggnewscale)
  
  ato1 = shapefile('cluster_shp/ato/ato1.shp')
  ato3 = shapefile('cluster_shp/ato/ato3.shp')
  
  cur_df = as.data.frame(
    fread('analysis_output/fig4/current_df.csv')
  )
  
  idless50 = which(cur_df$lat <= 50)
  cur_df = cur_df[idless50,]
  
  idbig1 = which(cur_df$u>0 &
                   cur_df$v >0)
  idbig2 = which(cur_df$u<0 &
                   cur_df$v >0)
  
  cur_df1 = cur_df[idbig1,]
  cur_df2 = cur_df[idbig2,]
  
  cid1 = seq(1,nrow(cur_df1),20)
  cid2 = seq(1,nrow(cur_df2),200)
  
  cur_df1 = cur_df1[cid1,]
  cur_df2 = cur_df2[cid2,]
  
  pmap = ggplot()+
    ###########
    geom_tile(data = dfato,
              aes(x = long,
                  y = lat,
                  fill = cuts),
              color = 'transparent')+
    scale_fill_manual(values = fillato,
                      guide = guide_legend(
                        title = 'PME-ATO-MMK',
                        title.position = 'top'
                      ))+
    new_scale_fill()+
    geom_tile(data = twsmmk,
              aes(x = long,
                  y = lat,
                  fill = cuts),
              color = 'transparent')+
    
    scale_fill_manual(values = filltwsmmk,
                      guide = guide_legend(
                        title = 'TWS-MMK',
                        title.position = 'top'
                      ))+
    geom_segment(data = cur_df1,
                 aes(x = long,y = lat,
                     xend = long+u,
                    yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.15,'cm'),
                               type = 'open'),
                 color = cols[4])+
    geom_segment(data = cur_df2,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.2,'cm'),
                               type = 'open'),
                 color = cols[6])+
    
    geom_polygon(data = world,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_polygon(data = xj,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_polygon(data = subs_shp,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    facet_wrap(~type,nrow = 1,
               scales = 'free')+
    #coord_sf()+
    theme_bw()+
    ###########
    theme(legend.position = 'bottom')+
    ylab('Latitude')
  
  world_crop = crop(world,
                    extent(-5,125,30,60))
  
  subs_label = data.frame(
    x = c(10,
          rep(30,3),
          rep(50,2),
          rep(70,2),
          rep(90,1),
          rep(110,1)),
    y = c(35,
          seq(35,60,10),
          seq(35,50,10),
          seq(35,50,10),
          45,
          40),
    label = paste0('SW',1:10)
  )
  
  pmap2= ggplot()+
    ##########
    geom_polygon(data = subs_shp,
                aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_text(data = subs_label,
              aes(x = x,y =y ,label = label),
              size = 2.5,
              fontface = 'bold')+
    #coord_sf()+
    theme_void()+
    coord_fixed(1.3)+
    ###########
    theme(
      plot.background = element_rect(
        fill = 'white'
      )
    )
  
  
  # mmk analysis statistic for each subs and ato13
  input_mean_mmk = 'analysis_output/fig4/bars_mmk_mean'
  input1 = paste0(input_mean_mmk,'/','substws_mmk245.csv')
  input2 = paste0(input_mean_mmk,'/','substws_mmk585.csv')
  
  input3 = paste0(input_mean_mmk,'/',
                   'pme_mmk_ssp245.csv')
  input4 = paste0(input_mean_mmk,'/',
                   'pme_mmk_ssp585.csv')
  
  substws_mmk245 = as.data.frame(fread(input1))
  substws_mmk585 = as.data.frame(fread(input2))
  pme_mmk245 = as.data.frame(fread(input3))
  pme_mmk585 = as.data.frame(fread(input4))
  
  dfmmk_mean245 = rbind(substws_mmk245,pme_mmk245)
  dfmmk_mean585 = rbind(substws_mmk585,
                        pme_mmk585)
  
  fillbar = colorRampPalette(pal_npg()(9))(12)
  fillbar2 = colorRampPalette(brewer.pal(10,'Spectral'))(12)
  
  label_df1 =data.frame(
    y = dfmmk_mean245$Region,
    x = abs(dfmmk_mean245$MMK)-1,
    labels = round(dfmmk_mean245$MMK,1)
  )
  
  label_df2 =data.frame(
    y = dfmmk_mean585$Region,
    x = abs(dfmmk_mean585$MMK)-1,
    labels = round(dfmmk_mean585$MMK,1)
  )
  
  order245 = order(abs(dfmmk_mean245$MMK),
                decreasing = T)
  order585 = order(abs(dfmmk_mean585$MMK),
                   decreasing = T)
  subs1 = dfmmk_mean245$Region[order245]
  subs2 = dfmmk_mean585$Region[order585]
  
  dfmmk_mean245$Region = 
    factor(dfmmk_mean245$Region,
           levels = subs1)
  dfmmk_mean585$Region = 
    factor(dfmmk_mean585$Region,
           levels = subs2)
  
  label_df1$y = factor(label_df1$y
                       ,levels = subs1)
  label_df2$y = factor(label_df2$y,
                       levels = subs2)
  
  pbar1 = ggplot()+
  ##############
    geom_bar(data = dfmmk_mean245,
             aes(x = abs(MMK),y = Region,
                 fill = Region),
             stat = 'identity',
             position = "dodge",
             width = 0.8,alpha = 0.8)+
    geom_text(data = label_df1,
              aes(x = x,y = y, label = labels),
              color = 'black',size = 3,hjust =0.5)+
    scale_x_continuous(breaks = c(0,1,2,3,4),
                       labels =c(0,-1,-2,-3,-4))+
    scale_fill_manual(values = fillbar)+
    theme_bw()+
    theme(
      legend.position = 'none',
      panel.border = element_rect(fill = 'transparent',
                                  color = 'transparent'),
      axis.title = element_text(size = 10,color = 'black',
                                hjust = 0.5),
      panel.background = element_rect(fill = 'transparent',
                                      color = 'transparent'),
      panel.grid =element_blank(),
      axis.text = element_text(size = 5,color = 'black',hjust = 0.5),
      axis.line.x = element_line(color= 'black',size = 0.5))+
    ##############
    xlab('Regions')+
    ylab('MMK')
  
  pbar2 = ggplot()+
    ##############
    geom_bar(data = dfmmk_mean585,
             aes(x = abs(MMK) ,y =Region,
                 fill = Region),
             stat = 'identity',
             position = "dodge",
             width = 0.8,alpha = 0.8)+
    geom_text(data = label_df2,
              aes(x = x,y = y, label = labels),
              color = 'black',size = 3,hjust =0.5)+
    scale_x_continuous(breaks = c(0,2,4,6,8),
                       labels =c(0,-2,-4,-6,-8))+
    scale_fill_manual(values = fillbar)+
    theme_bw()+
    theme(
      legend.position = 'none',
      panel.border = element_rect(fill = 'transparent',
                                  color = 'transparent'),
      axis.title = element_text(size = 5,color = 'black',
                                hjust = 0.5),
      panel.background = element_rect(fill = 'transparent',
                                      color = 'transparent'),
      panel.grid =element_blank(),
      axis.text = element_text(size = 5,color = 'black',hjust = 0.5),
      axis.line.x = element_line(color= 'black',size = 0.5))+
    xlab('Regions')+
    ylab('MMK')
  ##############
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  re_axis_title = 
    theme(axis.title.x = element_blank())
  axis_angel = theme(
    axis.text.x = element_text(
      color = 'black',
      size = fontsize,
      angle = 15)
  )
  pline1 = pline1+text_theme_set+re_axis_title+
    axis_angel
  pline2 = pline2+text_theme_set+re_axis_title+
    axis_angel
  pmap = pmap+text_theme_set+re_axis_title
  
  library(cowplot)
  p1 = plot_grid(pline1,pmap,pline2,
                 align = 'hv',
                 axis = 'lr',
                 rel_widths = c(1,1,1),
                 rel_heights = c(3,6,3),
                 ncol = 1)
  
  pbar1 = pbar1+
    theme(
      axis.title = element_blank(),
      axis.text = element_text(
        size = 10,color = 'black'
      ),
      plot.background = element_rect(
        fill= 'transparent',
        color = 'transparent'
      )
      
    )
  pbar2 = pbar2+
    theme(
      axis.title = element_blank(),
      axis.text = element_text(
        size = 10,color = 'black'
      ),
      plot.background  = element_rect(
        fill= 'transparent',
        color = 'transparent'
      )
    )
  
  p12 = ggdraw()+
    draw_plot(p1)+
    draw_plot(pbar1,x = 0.062, y = 0.29,
              width = 0.11, height = 0.3)+
    draw_plot(pbar2,x = 0.54, y = 0.29,
              width = 0.11, height = 0.3)+
    draw_plot(pmap2,x = 0.353, y = 0.26,
              width = 0.16, height = 0.15)+
    draw_plot(pmap2,x = 0.833, y = 0.26,
              width = 0.16, height = 0.15)
  
  png('main_plot/fig4/fig4_final4.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(p12)
  dev.off()
  
  
}









figs_big_scale_exploration_cor_tws_tws <- function(
  
){
  # analyze the relation between XJ and AS,EU,ATO
  
  # map plot 
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  # import cluster shps 
  input_cluster = 'cluster_shp'
  input_cluster = list.files(input_cluster,
                             full.names = T)
  input_ato = list.files(input_cluster[2],
                         full.names = T,
                         pattern = '*.shp$')[1:4]
  
  input_as = list.files(input_cluster[1],
                        full.names = T,
                        pattern = '*.shp$')
  input_eu = list.files(input_cluster[3],
                        full.names = T,
                        pattern = '*.shp$')[1:3]
  
  shp_ato = do.call('bind',lapply(input_ato,
                                  shapefile))
  shp_as = do.call('bind',
                   lapply(input_as,
                          shapefile))
  shp_eu = do.call('bind',
                   lapply(input_eu,
                          shapefile))
  
  shp_ato1 = fortify(shp_ato)
  shp_as1 = fortify(shp_as)
  shp_eu1 = fortify(shp_eu)
  
  shp_ato1$type = 1
  shp_as1$type = 3
  shp_eu1$type = 2
  
  shp_df = rbind(shp_ato1,shp_as1,
                 shp_eu1)
  
  # import trajectory
  trajs = fread('analysis_output/fig2/cluster_traj_df.csv')
  trajs = as.data.frame(trajs)
  route_col = pal_npg()(10)[4]
  route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  south_xj = shp_management('xinjiang_south')
  north_xj = shp_management('xinjiang_north')
  xj = shp_management('xinjiang')
  pmaps = ggplot()+
    geom_polygon(data = world,
                 aes(x = long,y =lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'grey80',
                 alpha = 0.8)+
    geom_polygon(data = shp_df,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_polygon(data = south_xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = north_xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    
    geom_polygon(data = south_moun,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = north_moun,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    
    geom_path(data = trajs,aes(x = long,y = lat,
                               group = routeid,
                               color = factor(routeid,
                                              levels = 1:20)),
              size = 1,
              #color = route_col,
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="open"))+    
    scale_color_manual(values = route_col)+
    facet_wrap(~type,ncol = 1,scales = 'free')+
    guides(color = FALSE)+
    theme_bw()
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  pmaps = pmaps + text_theme_set
  pmaps = pmaps+theme(
    strip.text = element_blank()
  )+xlab('Longitude')+ylab('Latitude')
  
  cal_center_point <- function(x){
    xm = extent(x)
    latm = round((xm[3]+xm[4])/2)
    longm = round((xm[1]+xm[2])/2)
    rm = data.frame(x = longm,y = latm)
    return(rm)
  }
  shp_ato_se = lapply(input_ato[1:4],shapefile)
  df_ato_label = lapply(shp_ato_se,
                        cal_center_point)
  df_ato_label = do.call('rbind',df_ato_label)
  df_ato_label$label =paste0('ATO',1:4)
  
  
  pmap1 = ggplot()+
    
    geom_polygon(data = shp_ato1,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_text(data = df_ato_label,
              aes(x = x,y = y,
                  label = label),
              size = 3,
              color = 'black')+
    theme_void()+
    coord_fixed(1.3)
  
  shp_eu_se = lapply(input_eu[1:3],shapefile)
  df_eu_label = lapply(shp_eu_se,
                       cal_center_point)
  df_eu_label = do.call('rbind',df_eu_label)
  df_eu_label$label =paste0('EU',1:3)
  
  pmap2 = ggplot()+
    geom_polygon(data = shp_eu1,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_text(data = df_eu_label,
              aes(x = x,y = y,
                  label = label),
              size = 3,
              color = 'black')+
    theme_void()+
    coord_fixed(1.3)
  
  shp_as_se = lapply(input_as,shapefile)
  df_as_label = lapply(shp_as_se,
                       cal_center_point)
  df_as_label = do.call('rbind',df_as_label)
  df_as_label$label =paste0('AS',1:4)
  
  pmap3 = ggplot()+
    geom_polygon(data = shp_as1,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_text(data = df_as_label,
              aes(x = x,y = y,
                  label = label),
              size = 3,
              color = 'black')+
    theme_void()+
    coord_fixed(1.3)
  
  # cor plot 
  tws_in_source = import_pe_in_source('tws_in_source',
                                      name = 'tws_sum.csv')
  colnames(tws_in_source) = paste0('tws',1:12)
  colnames(tws_in_source) = paste0('pme',1:12)
  twsdf = tws_in_source[,1:11]
  
  input_tws = 'tws_in_target/'
  files_jishui = c('north_jishui','south_jishui')
  input_tws = paste0(input_tws,files_jishui,'.csv')
  
  north_tws = as.data.frame(fread(input_tws[1]))
  south_tws = as.data.frame(fread(input_tws[2]))
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  twsdf = apply(twsdf,2,trend_fun)
  north_tws = trend_fun(north_tws)
  south_tws = trend_fun(south_tws)
  
  cor1box = 1
  cor2box = 1
  for(i in 1:11){
    cor1 = cor(twsdf[,i],north_tws)
    cor2 = cor(twsdf[,i],south_tws)
    #cor1 = max(ccf(twsdf[,i],north_tws)$acf)
    #cor2 = max(ccf(twsdf[,i],south_tws)$acf)
    cor1box = c(cor1box,cor1)
    cor2box = c(cor2box,cor2)
  }
  cor1box = cor1box[-1]
  cor2box = cor2box[-1]
  
  cordf = data.frame(
    x = paste0(rep(c('AS','ATO','EU'),each = 4)
               ,rep(1:4,3))[-12],
    Cor_North = cor1box,
    Cor_South = cor2box
  )
  cordf3 = cordf[1:4,]
  cordf1 = cordf[5:8,]
  cordf2 = cordf[9:11,]
  
  cordf1 = reshape2::melt(cordf1,'x')
  cordf2 = reshape2::melt(cordf2,'x')
  cordf3 = reshape2::melt(cordf3,'x')
  
  cordf1$type = 1
  cordf2$type = 2
  cordf3$type = 3
  
  cordf =rbind(cordf1,cordf2,cordf3)
  
  pals = pal_lancet(alpha = 0.8)(9)
  pcor = ggplot()+
    geom_bar(data  =cordf,
             aes(x = x,y = value,
                 fill = variable),
             stat = 'identity',
             position = 'dodge',
             width = 0.8)+
    geom_text(data = cordf,
              aes(x = x,y = value*1.2,
                  label = round(value,2)),
              size = 4,
              color = 'black',
              position = position_dodge2(0.8))+
    scale_fill_manual(values = pals[c(1,7)])+
    facet_wrap(~type,ncol = 1,scales = 'free')+
    theme_bw()+
    xlab('Source Regions')
  
  pcor = pcor+text_theme_set+
    theme(
      strip.text = element_blank(),
      axis.title.y = element_blank(),
      legend.position = 'none'
    )
  
  pcor = pcor+theme(
    plot.margin = unit(rep(0.1,4),'cm')
  )
  pmaps = pmaps+theme(
    plot.margin = unit(rep(0.1,4),'cm')
  )
  # adding (a)
  subs_df1 = data.frame(
    x = rep(-175,3),
    y = rep(80,3),
    label = c('(a)','(c)','(e)'),
    type = c(1,2,3)
  )  
  subs_df2 = data.frame(
    x = c('ATO1','EU1','AS1'),
    y = c(0.9,0.2,0.25),
    label = c('(b)','(d)','(f)'),
    type = c(1,2,3)
  ) 
  
  pmaps  = pmaps+
    geom_text(data = subs_df1,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black')
  
  pcor = pcor+
    geom_text(data = subs_df2,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black')
  
  # assemble plots
  library(cowplot)
  p12 = plot_grid(pmaps,
                  pcor,
                  rel_widths = c(3,1.5),
                  rel_heights = c(1,1),
                  nrow = 1)
  
  output = 'main_plot/SI/big_scale_tws_tws_cor/figs.png'
  dir.create('main_plot/SI/big_scale_tws_tws_cor')
  
  p123 = ggdraw()+
    draw_plot(p12)+
    draw_plot(pmap1,x =0.05,y = 0.72 ,
              height = 0.1,width = 0.13)+
    draw_plot(pmap2,x = 0.05,y = 0.38,
              height = 0.1,width = 0.13)+
    draw_plot(pmap3,x= 0.05,y = 0.06,
              height =0.1,width = 0.13)
  
  
  png(output,
      width = 25,
      height =22,
      units = 'cm',
      res = 800)
  print(p123)
  dev.off()
  
  
  
  
}
figs_big_scale_exploration_cor <- function(
  
){
  # analyze the relation between XJ and AS,EU,ATO
  
  # map plot 
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  # import cluster shps 
  input_cluster = 'cluster_shp'
  input_cluster = list.files(input_cluster,
                             full.names = T)
  input_ato = list.files(input_cluster[2],
                         full.names = T,
                         pattern = '*.shp$')[1:4]
  
  input_as = list.files(input_cluster[1],
                         full.names = T,
                         pattern = '*.shp$')
  input_eu = list.files(input_cluster[3],
                         full.names = T,
                         pattern = '*.shp$')[1:3]
  
  shp_ato = do.call('bind',lapply(input_ato,
                                  shapefile))
  shp_as = do.call('bind',
                   lapply(input_as,
                          shapefile))
  shp_eu = do.call('bind',
                   lapply(input_eu,
                          shapefile))
  
  shp_ato1 = fortify(shp_ato)
  shp_as1 = fortify(shp_as)
  shp_eu1 = fortify(shp_eu)
  
  shp_ato1$type = 1
  shp_as1$type = 3
  shp_eu1$type = 2
  
  shp_df = rbind(shp_ato1,shp_as1,
                 shp_eu1)
  
  # import trajectory
  trajs = fread('analysis_output/fig2/cluster_traj_df.csv')
  trajs = as.data.frame(trajs)
  route_col = pal_npg()(10)[4]
  route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  south_xj = shp_management('xinjiang_south')
  north_xj = shp_management('xinjiang_north')
  xj = shp_management('xinjiang')
  pmaps = ggplot()+
    geom_polygon(data = world,
                 aes(x = long,y =lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'grey80',
                 alpha = 0.8)+
    geom_polygon(data = shp_df,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_polygon(data = south_xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = north_xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    
    geom_polygon(data = south_moun,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = north_moun,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    
    geom_path(data = trajs,aes(x = long,y = lat,
                              group = routeid,
                              color = factor(routeid,
                                             levels = 1:20)),
              size = 1,
              #color = route_col,
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="open"))+    
    scale_color_manual(values = route_col)+
    facet_wrap(~type,ncol = 1,scales = 'free')+
    guides(color = FALSE)+
    theme_bw()
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  pmaps = pmaps + text_theme_set
  pmaps = pmaps+theme(
    strip.text = element_blank()
  )+xlab('Longitude')+ylab('Latitude')
  
  cal_center_point <- function(x){
    xm = extent(x)
    latm = round((xm[3]+xm[4])/2)
    longm = round((xm[1]+xm[2])/2)
    rm = data.frame(x = longm,y = latm)
    return(rm)
  }
  shp_ato_se = lapply(input_ato[1:4],shapefile)
  df_ato_label = lapply(shp_ato_se,
                        cal_center_point)
  df_ato_label = do.call('rbind',df_ato_label)
  df_ato_label$label =paste0('ATO',1:4)
  
  
  pmap1 = ggplot()+
    
    geom_polygon(data = shp_ato1,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_text(data = df_ato_label,
              aes(x = x,y = y,
                  label = label),
              size = 3,
              color = 'black')+
    theme_void()+
    coord_fixed(1.3)
  
  shp_eu_se = lapply(input_eu[1:3],shapefile)
  df_eu_label = lapply(shp_eu_se,
                       cal_center_point)
  df_eu_label = do.call('rbind',df_eu_label)
  df_eu_label$label =paste0('EU',1:3)
  
  pmap2 = ggplot()+
    geom_polygon(data = shp_eu1,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_text(data = df_eu_label,
              aes(x = x,y = y,
                  label = label),
              size = 3,
              color = 'black')+
    theme_void()+
    coord_fixed(1.3)
  
  shp_as_se = lapply(input_as,shapefile)
  df_as_label = lapply(shp_as_se,
                       cal_center_point)
  df_as_label = do.call('rbind',df_as_label)
  df_as_label$label =paste0('AS',1:4)
  
  pmap3 = ggplot()+
    geom_polygon(data = shp_as1,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_text(data = df_as_label,
              aes(x = x,y = y,
                  label = label),
              size = 3,
              color = 'black')+
    theme_void()+
    coord_fixed(1.3)
  
  # cor plot 
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pe_in_source = pe_in_source * 30.5
  
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  pe_minus_eva = pe_in_source - pet_sum
  colnames(pe_minus_eva) = paste0('pme',1:12)
  pmedf = pe_minus_eva[,1:11]
  
  input_tws = 'tws_in_target/'
  files_jishui = c('north_jishui','south_jishui')
  input_tws = paste0(input_tws,files_jishui,'.csv')
  
  north_tws = as.data.frame(fread(input_tws[1]))
  south_tws = as.data.frame(fread(input_tws[2]))
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  pmedf = apply(pmedf,2,trend_fun)
  north_tws = trend_fun(north_tws)
  south_tws = trend_fun(south_tws)
  
  cor1box = 1
  cor2box = 1
  for(i in 1:11){
    cor1 = cor(pmedf[,i],north_tws)
    cor2 = cor(pmedf[,i],south_tws)
    #cor1 = max(ccf(pmedf[,i],north_tws)$acf)
    #cor2 = max(ccf(pmedf[,i],south_tws)$acf)
    cor1box = c(cor1box,cor1)
    cor2box = c(cor2box,cor2)
  }
  cor1box = cor1box[-1]
  cor2box = cor2box[-1]
  
  cordf = data.frame(
    x = paste0(rep(c('AS','ATO','EU'),each = 4)
               ,rep(1:4,3))[-12],
    Cor_North = cor1box,
    Cor_South = cor2box
  )
  cordf3 = cordf[1:4,]
  cordf1 = cordf[5:8,]
  cordf2 = cordf[9:11,]
  
  cordf1 = reshape2::melt(cordf1,'x')
  cordf2 = reshape2::melt(cordf2,'x')
  cordf3 = reshape2::melt(cordf3,'x')
  
  cordf1$type = 1
  cordf2$type = 2
  cordf3$type = 3
  
  cordf =rbind(cordf1,cordf2,cordf3)
  
  pals = pal_lancet(alpha = 0.8)(9)
  pcor = ggplot()+
    geom_bar(data  =cordf,
             aes(x = x,y = value,
                 fill = variable),
             stat = 'identity',
             position = 'dodge',
             width = 0.8)+
    geom_text(data = cordf,
              aes(x = x,y = value*1.2,
                  label = round(value,2)),
              size = 4,
              color = 'black',
              position = position_dodge2(0.8))+
    scale_fill_manual(values = pals[c(1,7)])+
    facet_wrap(~type,ncol = 1,scales = 'free')+
    theme_bw()+
    xlab('Source Regions')
  
  pcor = pcor+text_theme_set+
    theme(
      strip.text = element_blank(),
      axis.title.y = element_blank(),
      legend.position = 'none'
    )
  
  pcor = pcor+theme(
    plot.margin = unit(rep(0.1,4),'cm')
  )
  pmaps = pmaps+theme(
    plot.margin = unit(rep(0.1,4),'cm')
  )
  
  
  
  # adding (a)
  subs_df1 = data.frame(
    x = rep(-175,3),
    y = rep(80,3),
    label = c('(a)','(c)','(e)'),
    type = c(1,2,3)
  )  
  subs_df2 = data.frame(
    x = c('ATO1','EU1','AS1'),
    y = c(0.9,0.2,0.25),
    label = c('(b)','(d)','(f)'),
    type = c(1,2,3)
  ) 
  
  pmaps  = pmaps+
    geom_text(data = subs_df1,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black')
  
  pcor = pcor+
    geom_text(data = subs_df2,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black')
  
  # assemble plots
  library(cowplot)
  p12 = plot_grid(pmaps,
                  pcor,
                  rel_widths = c(3,1.5),
                  rel_heights = c(1,1),
                  nrow = 1)
  
  output = 'main_plot/SI/big_scale_pme_tws_cor/figs.png'
  #dir.create('main_plot/SI/big_scale_pme_tws_cor')
  png(output,
      width = 25,
      height =22,
      units = 'cm',
      res = 800)
  print(p12)
  dev.off()
  
  p123 = ggdraw()+
    draw_plot(p12)+
    draw_plot(pmap1,x =0.05,y = 0.72 ,
              height = 0.1,width = 0.13)+
    draw_plot(pmap2,x = 0.05,y = 0.38,
              height = 0.1,width = 0.13)+
    draw_plot(pmap3,x= 0.05,y = 0.06,
              height =0.1,width = 0.13)
  
 
  png(output,
      width = 25,
      height =22,
      units = 'cm',
      res = 800)
  print(p123)
  dev.off()
  
  
    
    
  
  
}
figs_big_scale_exploration_pme_pme_cor <- function(
  
){
  # analyze the relation between XJ and AS,EU,ATO
  
  # map plot 
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  # import cluster shps 
  input_cluster = 'cluster_shp'
  input_cluster = list.files(input_cluster,
                             full.names = T)
  input_ato = list.files(input_cluster[2],
                         full.names = T,
                         pattern = '*.shp$')[1:4]
  
  input_as = list.files(input_cluster[1],
                        full.names = T,
                        pattern = '*.shp$')[c(2,4)]
  input_eu = list.files(input_cluster[3],
                        full.names = T,
                        pattern = '*.shp$')[1:3]
  
  shp_ato = do.call('bind',lapply(input_ato,
                                  shapefile))
  shp_as = do.call('bind',
                   lapply(input_as,
                          shapefile))
  shp_eu = do.call('bind',
                   lapply(input_eu,
                          shapefile))
  
  shp_ato1 = fortify(shp_ato)
  shp_as1 = fortify(shp_as)
  shp_eu1 = fortify(shp_eu)
  
  shp_ato1$type = 1
  shp_as1$type = 3
  shp_eu1$type = 2
  
  shp_df = rbind(shp_ato1,shp_as1,
                 shp_eu1)
  
  # import trajectory
  trajs = fread('analysis_output/fig2/cluster_traj_df.csv')
  trajs = as.data.frame(trajs)
  route_col = pal_npg()(10)[4]
  route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  south_xj = shp_management('xinjiang_south')
  north_xj = shp_management('xinjiang_north')
  xj = shp_management('xinjiang')
  pmaps = ggplot()+
    geom_polygon(data = world,
                 aes(x = long,y =lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'grey80',
                 alpha = 0.8)+
    geom_polygon(data = shp_df,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_polygon(data = south_xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = north_xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    
    geom_polygon(data = south_moun,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = north_moun,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    
    geom_path(data = trajs,aes(x = long,y = lat,
                               group = routeid,
                               color = factor(routeid,
                                              levels = 1:20)),
              size = 1,
              #color = route_col,
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="open"))+    
    scale_color_manual(values = route_col)+
    facet_wrap(~type,ncol = 1,scales = 'free')+
    guides(color = FALSE)+
    theme_bw()
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  pmaps = pmaps + text_theme_set
  pmaps = pmaps+theme(
    strip.text = element_blank()
  )+xlab('Longitude')+ylab('Latitude')
  
  cal_center_point <- function(x){
    xm = extent(x)
    latm = round((xm[3]+xm[4])/2)
    longm = round((xm[1]+xm[2])/2)
    rm = data.frame(x = longm,y = latm)
    return(rm)
  }
  shp_ato_se = lapply(input_ato[1:4],shapefile)
  df_ato_label = lapply(shp_ato_se,
                        cal_center_point)
  df_ato_label = do.call('rbind',df_ato_label)
  df_ato_label$label =paste0('ATO',1:4)
  
  
  pmap1 = ggplot()+
    
    geom_polygon(data = shp_ato1,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_text(data = df_ato_label,
              aes(x = x,y = y,
                  label = label),
              size = 3,
              color = 'black')+
    theme_void()+
    coord_fixed(1.3)
  
  shp_eu_se = lapply(input_eu[1:3],shapefile)
  df_eu_label = lapply(shp_eu_se,
                       cal_center_point)
  df_eu_label = do.call('rbind',df_eu_label)
  df_eu_label$label =paste0('EU',1:3)
  
  pmap2 = ggplot()+
    geom_polygon(data = shp_eu1,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_text(data = df_eu_label,
              aes(x = x,y = y,
                  label = label),
              size = 3,
              color = 'black')+
    theme_void()+
    coord_fixed(1.3)
  
  shp_as_se = lapply(input_as,shapefile)
  df_as_label = lapply(shp_as_se,
                       cal_center_point)
  df_as_label = do.call('rbind',df_as_label)
  df_as_label$label =paste0('AS',1:2)
  
  pmap3 = ggplot()+
    geom_polygon(data = shp_as1,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_text(data = df_as_label,
              aes(x = x,y = y,
                  label = label),
              size = 3,
              color = 'black')+
    theme_void()+
    coord_fixed(1.3)
  
  # cor plot 
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pe_in_source = pe_in_source * 30.5
  
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  pe_minus_eva = pe_in_source - pet_sum
  colnames(pe_minus_eva) = paste0('pme',1:12)
  pmedf = pe_minus_eva[,1:11]
  
  tws_in_source = import_pe_in_source('tws_in_source',
                                      name = 'tws_sum.csv')
  colnames(tws_in_source) = paste0('tws',1:12)
  tws_in_source = tws_in_source[,1:11]
  tws_in_source  =as.data.frame(tws_in_source)
  
  input_pr_intarget = list.files('era5_pr_in_target',
                                 full.names = T)[c(1,3)]
  input_eva_intarget = list.files('poten_evap_in_target',
                                  full.names =T)[c(1,3)]
  prtar = lapply(lapply(input_pr_intarget,fread),
                 as.data.frame)
  evatar = lapply(lapply(input_eva_intarget,fread),
                  as.data.frame)
  
  prtar = do.call('cbind',prtar)
  evatar = do.call('cbind',evatar)
  
  #prtar = apply(prtar,1,sum,na.rm =T)
  #evatar = apply(evatar,1,sum,na.rm = T)
  
  pmetar = prtar-evatar
  pmetar = pmetar[1:174,]
  
  input_tws = 'tws_in_target/'
  input_tws = list.files(input_tws,
                         full.names = T)[c(1,3)]
  
  twstar = lapply(lapply(input_tws,
                         fread),
                  as.data.frame)
  twstar = do.call('cbind',twstar)
  
  #twstar = apply(twstar,1,sum,na.rm = T)
  
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  pmedf = apply(pmedf,2,trend_fun)
  twsdf = apply(tws_in_source,2,trend_fun)
  #pmetar = trend_fun(pmetar)
  #twstar = trend_fun(twstar)
  north_pme = trend_fun(pmetar[,1])
  north_tws = trend_fun(twstar[,1])
  south_pme = trend_fun(pmetar[,2])
  south_tws = trend_fun(twstar[,2])
  
  twsdf = twsdf[,-c(1,3,5:8)]
  pmedf = pmedf[,5:8]
  
  corpme_nor = 1
  corpme_sou = 1
  for(i in 1:ncol(pmedf)){
    tmpcor_nor = cor(pmedf[,i],north_tws)
    #tmpcor_nor = max(ccf(pmedf[,i],north_tws)$acf)
    corpme_nor = c(corpme_nor,tmpcor_nor)
    
    tmpcor_sou = cor(pmedf[,i],south_tws)
    #tmpcor_sou = max(ccf(pmedf[,i],south_tws)$acf)
    corpme_sou = c(corpme_sou,tmpcor_sou)
  }
  corpme_nor = corpme_nor[-1]
  corpme_sou = corpme_sou[-1]
  
  cordf1 = data.frame(
    x = paste0('ATO',1:4),
    COR_PME_TWS_North = corpme_nor,
    COR_PME_TWS_South = corpme_sou,
    type = 1
  )
  
  cortws_nor = 1
  cortws_sou = 1
  for(i in 1:ncol(twsdf)){
    tmpcor_nor = cor(twsdf[,i],north_tws)
    #tmpcor_nor = max(ccf(twsdf[,i],north_tws)$acf)
    cortws_nor = c(cortws_nor,tmpcor_nor)
    
    tmpcor_sou = cor(twsdf[,i],south_tws)
    #tmpcor_sou = max(ccf(twsdf[,i],south_tws)$acf)
    cortws_sou = c(cortws_sou,tmpcor_sou)
    
  }
  cortws_nor = cortws_nor[-1]
  cortws_sou = cortws_sou[-1]
  
  
  cordf2 = data.frame(
    x = c(paste0('AS',1:2),paste0('EU',1:3)),
    COR_TWS_TWS_North = cortws_nor,
    COR_TWS_TWS_South = cortws_sou,
    type = c(rep(3,2),rep(2,3))
  )
  
  cordf1 = reshape2::melt(cordf1,c('x','type'))
  cordf2 = reshape2::melt(cordf2,c('x','type'))
  cordf = rbind(cordf1,cordf2)
  
  
  pals = pal_lancet(alpha = 0.8)(9)
  
  pals = c('COR_PME_TWS_North' = pals[1],
           'COR_PME_TWS_South' = pals[4],
           'COR_TWS_TWS_North' = pals[6],
           'COR_TWS_TWS_South' = pals[7])
  
  pcor = ggplot()+
    geom_bar(data  =cordf,
             aes(x = x,y = value,
                 fill = variable),
             stat = 'identity',
             position = 'dodge',
             width = 0.8)+
    geom_text(data = cordf,
              aes(x = x,y = value*1.2,
                  label = round(value,2)),
              size = 4,
              position = position_dodge2(0.8),
              color = 'black')+
    scale_fill_manual(values = pals)+
    facet_wrap(~type,ncol = 1,scales = 'free')+
    theme_bw()+
    xlab('Source Regions')
  
  pcor = pcor+text_theme_set+
    theme(
      strip.text = element_blank(),
      axis.title.y = element_blank(),
      legend.position = 'none'
    )
  
  pcor = pcor+theme(
    plot.margin = unit(rep(0.1,4),'cm')
  )
  pmaps = pmaps+theme(
    plot.margin = unit(rep(0.1,4),'cm')
  )
  
  
  
  # adding (a)
  subs_df1 = data.frame(
    x = rep(-175,3),
    y = rep(80,3),
    label = c('(a)','(c)','(e)'),
    type = c(1,2,3)
  )  
  subs_df2 = data.frame(
    x = c('ATO1','EU1','AS2'),
    y = c(0.9,-0.26,1.1),
    label = c('(b)','(d)','(f)'),
    type = c(1,2,3)
  ) 
  
  pmaps  = pmaps+
    geom_text(data = subs_df1,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black')
  
  pcor = pcor+
    geom_text(data = subs_df2,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black')
  
  # assemble plots
  library(cowplot)
  p12 = plot_grid(pmaps,
                  pcor,
                  rel_widths = c(3,1.5),
                  rel_heights = c(1,1),
                  nrow = 1)
  
  output = 'main_plot/SI/big_scale_pme_tws_tws_cor/figs1.png'
  dir.create('main_plot/SI/big_scale_pme_tws_tws_cor')
  
  p123 = ggdraw()+
    draw_plot(p12)+
    draw_plot(pmap1,x =0.05,y = 0.72 ,
              height = 0.1,width = 0.13)+
    draw_plot(pmap2,x = 0.05,y = 0.38,
              height = 0.1,width = 0.13)+
    draw_plot(pmap3,x= 0.05,y = 0.06,
              height =0.1,width = 0.13)
  
  
  leg1 = as_ggplot(get_legend(
    pcor+guides(fill = guide_legend(
      title = 'Pearson Correlation Coefficients',
      title.position = 'top',nrow = 1
    ))+theme(legend.position = 'bottom')
  ))
  
  leg1  =leg1+theme(plot.margin = unit(rep(0,4),'cm'))
  
  p1234 = plot_grid(
    p123,leg1,
    ncol = 1,
    rel_heights = c(10,1)
  )
  
  
  png(output,
      width = 25,
      height =22,
      units = 'cm',
      res = 800)
  print(p1234)
  dev.off()
  
  
  
  
  
  
}
figs_big_scale_exploration_pme_pme_single_cor <- function(
  
){
  # analyze the relation between XJ and AS,EU,ATO
  
  # map plot 
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  # import cluster shps 
  input_cluster = 'cluster_shp'
  input_cluster = list.files(input_cluster,
                             full.names = T)
  input_ato = list.files(input_cluster[2],
                         full.names = T,
                         pattern = '*.shp$')[1:4]
  
  input_as = list.files(input_cluster[1],
                        full.names = T,
                        pattern = '*.shp$')[c(2,4)]
  input_eu = list.files(input_cluster[3],
                        full.names = T,
                        pattern = '*.shp$')[1:3]
  
  shp_ato = do.call('bind',lapply(input_ato,
                                  shapefile))
  shp_as = do.call('bind',
                   lapply(input_as,
                          shapefile))
  shp_eu = do.call('bind',
                   lapply(input_eu,
                          shapefile))
  
  shp_ato1 = fortify(shp_ato)
  shp_as1 = fortify(shp_as)
  shp_eu1 = fortify(shp_eu)
  
  shp_ato1$type = 1
  shp_as1$type = 3
  shp_eu1$type = 2
  
  shp_df = rbind(shp_ato1,shp_as1,
                 shp_eu1)
  
  # import trajectory
  trajs = fread('analysis_output/fig2/cluster_traj_df.csv')
  trajs = as.data.frame(trajs)
  route_col = pal_npg()(10)[4]
  route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  south_xj = shp_management('xinjiang_south')
  north_xj = shp_management('xinjiang_north')
  xj = shp_management('xinjiang')
  pmaps = ggplot()+
    geom_polygon(data = world,
                 aes(x = long,y =lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'grey80',
                 alpha = 0.8)+
    geom_polygon(data = shp_df,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_polygon(data = south_xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = north_xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    
    geom_polygon(data = south_moun,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = north_moun,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    
    geom_path(data = trajs,aes(x = long,y = lat,
                               group = routeid,
                               color = factor(routeid,
                                              levels = 1:20)),
              size = 1,
              #color = route_col,
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="open"))+    
    scale_color_manual(values = route_col)+
    facet_wrap(~type,ncol = 1,scales = 'free')+
    guides(color = FALSE)+
    theme_bw()
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  pmaps = pmaps + text_theme_set
  pmaps = pmaps+theme(
    strip.text = element_blank()
  )+xlab('Longitude')+ylab('Latitude')
  
  cal_center_point <- function(x){
    xm = extent(x)
    latm = round((xm[3]+xm[4])/2)
    longm = round((xm[1]+xm[2])/2)
    rm = data.frame(x = longm,y = latm)
    return(rm)
  }
  shp_ato_se = lapply(input_ato[1:4],shapefile)
  df_ato_label = lapply(shp_ato_se,
                        cal_center_point)
  df_ato_label = do.call('rbind',df_ato_label)
  df_ato_label$label =paste0('ATO',1:4)
  
  
  pmap1 = ggplot()+
    
    geom_polygon(data = shp_ato1,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_text(data = df_ato_label,
              aes(x = x,y = y,
                  label = label),
              size = 3,
              color = 'black')+
    theme_void()+
    coord_fixed(1.3)
  
  shp_eu_se = lapply(input_eu[1:3],shapefile)
  df_eu_label = lapply(shp_eu_se,
                       cal_center_point)
  df_eu_label = do.call('rbind',df_eu_label)
  df_eu_label$label =paste0('EU',1:3)
  
  pmap2 = ggplot()+
    geom_polygon(data = shp_eu1,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_text(data = df_eu_label,
              aes(x = x,y = y,
                  label = label),
              size = 3,
              color = 'black')+
    theme_void()+
    coord_fixed(1.3)
  
  shp_as_se = lapply(input_as,shapefile)
  df_as_label = lapply(shp_as_se,
                       cal_center_point)
  df_as_label = do.call('rbind',df_as_label)
  df_as_label$label =paste0('AS',1:2)
  
  pmap3 = ggplot()+
    geom_polygon(data = shp_as1,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_text(data = df_as_label,
              aes(x = x,y = y,
                  label = label),
              size = 3,
              color = 'black')+
    theme_void()+
    coord_fixed(1.3)
  
  # cor plot 
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pe_in_source = pe_in_source * 30.5
  
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  pe_minus_eva = pe_in_source - pet_sum
  colnames(pe_minus_eva) = paste0('pme',1:12)
  pmedf = pe_minus_eva[,1:11]
  
  tws_in_source = import_pe_in_source('tws_in_source',
                                      name = 'tws_sum.csv')
  colnames(tws_in_source) = paste0('tws',1:12)
  tws_in_source = tws_in_source[,1:11]
  tws_in_source  =as.data.frame(tws_in_source)
  
  input_pr_intarget = list.files('era5_pr_in_target',
                                 full.names = T)[c(1,3)]
  input_eva_intarget = list.files('poten_evap_in_target',
                                  full.names =T)[c(1,3)]
  prtar = lapply(lapply(input_pr_intarget,fread),
                 as.data.frame)
  evatar = lapply(lapply(input_eva_intarget,fread),
                  as.data.frame)
  
  prtar = do.call('cbind',prtar)
  evatar = do.call('cbind',evatar)
  
  #prtar = apply(prtar,1,sum,na.rm =T)
  #evatar = apply(evatar,1,sum,na.rm = T)
  
  pmetar = prtar-evatar
  pmetar = pmetar[1:174,]
  
  input_tws = 'tws_in_target/'
  input_tws = list.files(input_tws,
                         full.names = T)[c(1,3)]
  
  twstar = lapply(lapply(input_tws,
                         fread),
                  as.data.frame)
  twstar = do.call('cbind',twstar)
  
  #twstar = apply(twstar,1,sum,na.rm = T)
  
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  pmedf = apply(pmedf,2,trend_fun)
  twsdf = apply(tws_in_source,2,trend_fun)
  #pmetar = trend_fun(pmetar)
  #twstar = trend_fun(twstar)
  north_pme = trend_fun(pmetar[,1])
  north_tws = trend_fun(twstar[,1])
  south_pme = trend_fun(pmetar[,2])
  south_tws = trend_fun(twstar[,2])
  
  #twsdf = twsdf[,-c(1,3,5:8)]
  pmedf = pmedf[,-c(1,3)]
  
  corpme_nor = 1
  corpme_sou = 1
  for(i in 1:ncol(pmedf)){
    tmpcor_nor = cor(pmedf[,i],north_pme)
    #tmpcor_nor = max(ccf(pmedf[,i],north_pme,
    #                     lag.max = 3)$acf)
    corpme_nor = c(corpme_nor,tmpcor_nor)
    
    tmpcor_sou = cor(pmedf[,i],south_pme)
    #tmpcor_sou = max(ccf(pmedf[,i],south_pme,
    #                     lag.max = 3)$acf)
    corpme_sou = c(corpme_sou,tmpcor_sou)
  }
  corpme_nor = corpme_nor[-1]
  corpme_sou = corpme_sou[-1]
  
  cordf1 = data.frame(
    x = c(paste0("AS",1:2),paste0('ATO',1:4),
          paste0('EU',1:3)),
    COR_PME_PME_North = corpme_nor,
    COR_PME_PME_South = corpme_sou,
    type = c(rep(3,2),rep(1,4),rep(2,3))
  )
  
  cordf1 = reshape2::melt(cordf1,c('x','type'))
  #cordf2 = reshape2::melt(cordf2,c('x','type'))
  cordf = cordf1
  
  
  pals = pal_lancet(alpha = 0.8)(9)
  
  pals = c('COR_PME_PME_North' = pals[1],
           'COR_PME_PME_South' = pals[7])
  
  pcor = ggplot()+
    geom_bar(data  = cordf,
             aes(x = x,y = value,
                 fill = variable),
             stat = 'identity',
             position = 'dodge',
             width = 0.8)+
    geom_text(data = cordf,
              aes(x = x,y = value*1.2,
                  label = round(value,2)),
              size = 4,
              position = position_dodge2(0.8),
              color = 'black')+
    scale_fill_manual(values = pals)+
    facet_wrap(~type,ncol = 1,scales = 'free')+
    theme_bw()+
    xlab('Source Regions')
  
  pcor = pcor+text_theme_set+
    theme(
      strip.text = element_blank(),
      axis.title.y = element_blank(),
      legend.position = 'none'
    )
  
  pcor = pcor+theme(
    plot.margin = unit(rep(0.1,4),'cm')
  )
  pmaps = pmaps+theme(
    plot.margin = unit(rep(0.1,4),'cm')
  )
  
  
  
  # adding (a)
  subs_df1 = data.frame(
    x = rep(-175,3),
    y = rep(80,3),
    label = c('(a)','(c)','(e)'),
    type = c(1,2,3)
  )  
  subs_df2 = data.frame(
    x = c('ATO1','EU1','AS1'),
    y = c(0.9,0.15,1.1),
    label = c('(b)','(d)','(f)'),
    type = c(1,2,3)
  ) 
  
  pmaps  = pmaps+
    geom_text(data = subs_df1,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black')
  
  pcor = pcor+
    geom_text(data = subs_df2,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black')
  
  # assemble plots
  library(cowplot)
  p12 = plot_grid(pmaps,
                  pcor,
                  rel_widths = c(3,1.5),
                  rel_heights = c(1,1),
                  nrow = 1)
  
  output = 'main_plot/SI/big_scale_pme_pme_cor/figs1.png'
  dir.create('main_plot/SI/big_scale_pme_pme_cor')
  
  p123 = ggdraw()+
    draw_plot(p12)+
    draw_plot(pmap1,x =0.05,y = 0.72 ,
              height = 0.1,width = 0.13)+
    draw_plot(pmap2,x = 0.05,y = 0.38,
              height = 0.1,width = 0.13)+
    draw_plot(pmap3,x= 0.05,y = 0.06,
              height =0.1,width = 0.13)
  
  library(ggpubr)
  pleg = as_ggplot(get_legend(pcor+
                                theme(legend.position = 'bottom')+
                                guides(fill = guide_legend(
                                  title = 'Pearson Corrleation Coefficients',
                                  title.position = 'top',
                                  nrow = 1
                                ))))
  pleg = pleg+
    theme(plot.margin = 
          unit(rep(0,4),'cm'))
  
  p123 = plot_grid(p123,
                   pleg,
                   rel_heights = c(10,1),
                   ncol =1)
  
  
  
  png(output,
      width = 25,
      height =22,
      units = 'cm',
      res = 800)
  print(p123)
  dev.off()
  
  
  
  
  
  
}
figs_cmip6_tws_pme_cor <- function(
  
){
  library(ggplot2)
  library(raster)
  input_tws = 'analysis_output/fig4/project_tws'
  input_tws = list.files(input_tws,full.names = T)
  
  tws245_mean = as.data.frame(
    fread(input_tws[2])
  )
  tws585_mean = as.data.frame(
    fread(input_tws[4])
  )
  
  colnames(tws245_mean) = c('date',
                            'variable',
                            'value')
  colnames(tws585_mean) = c('date',
                            'variable',
                            'value')
  
  tws245_mean$type = 'SSP245_TWS'
  tws585_mean$type = 'SSP585_TWS'
  
  source('/home/share/R_project/xinjiang_vapor/import_pme_ato_fig4.R')
  pmedf = import_pme_ato_fig4(F)
  
  SSP245_PME1 = pmedf$value[which(pmedf$type =='SSP245_PME1')]
  SSP245_PME3 = pmedf$value[which(pmedf$type =='SSP245_PME3')]
  SSP585_PME1 = pmedf$value[which(pmedf$type =='SSP585_PME1')]
  SSP585_PME3 = pmedf$value[which(pmedf$type =='SSP585_PME3')]
  
  df245_1 = data.frame(
    TWS = tws245_mean$value,
    PME1 = SSP245_PME1,
    type = tws245_mean$variable
  )
  df245_2 = data.frame(
    TWS = tws245_mean$value,
    PME3 = SSP245_PME3,
    type = tws245_mean$variable
  )
  
  df245_1 = reshape2::melt(df245_1,c('TWS','type'))
  df245_2 = reshape2::melt(df245_2,c('TWS','type'))
  
  df245_1$type = rep(1:10,each = 390)
  df245_2$type = rep(11:20,each = 390)
  df245 = rbind(df245_1,df245_2)
  
  retcor = cor_pme_tws_cmip6(df245)
  cordf245 = retcor[[1]]
  pdf245 = retcor[[2]]
  
  df585_1 = data.frame(
    TWS = tws585_mean$value,
    PME1 = SSP585_PME1,
    type = tws585_mean$variable
  )
  df585_2 = data.frame(
    TWS = tws585_mean$value,
    PME3 = SSP585_PME3,
    type = tws585_mean$variable
  )
  
  df585_1 = reshape2::melt(df585_1,c('TWS','type'))
  df585_2 = reshape2::melt(df585_2,c('TWS','type'))
  
  df585_1$type = rep(1:10,each = 390)
  df585_2$type = rep(11:20,each = 390)
  df585 = rbind(df585_1,df585_2)
  
  
  subsdf = data.frame(
    x = -0.25,
    y = 0.25,
    label = paste0('(',letters[1:20],')'),
    type = 1:20
  )
  
  
  
  
  p1 = ggplot()+
    geom_point(data = df245,
               aes(x = TWS,y = value,
                   color = variable),
               size = 3.25,
               shape = 1)+
    geom_point(data = df245,
               aes(x = TWS,y = value,
                   color = variable),
               size = 3,
               shape = 1)+
    geom_abline(intercept = 0,slope = 1)+
    geom_text(data = cordf245,
              aes(x = x,y =y,label = cor),
              hjust = 0,
              size = 4,
              color = 'black')+
    geom_text(data = pdf245,
              aes(x = x,y = y,label = cor),
              hjust = 0,
              size = 4,
              color = 'black')+
    geom_text(data = subsdf,
              aes(x = x,y = y,label = label),
              hjust  =0,
              size = 4,
              color = 'black')+
    facet_wrap(~type,nrow = 4)+
    ylim(-0.25,0.25)+
    xlim(-0.25,0.25)+
    theme_bw()+
    xlab("Projected TWS")+
    ylab('PME')
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  p1 = p1+text_theme_set+
    theme(legend.position = 'bottom',
          strip.text =element_blank())+
    guides(color = guide_legend(title = '',
                                nrow = 1))
  
  output = 'main_plot/SI/cor_pme_tws_fut/'
  dir.create(output)
  output1 = paste0(output,'/figs10.png')
  png(output1,
      height = 20,
      width = 25,
      units = 'cm',
      res = 800)
  print(p1)
  dev.off()
  
  
  retcor = cor_pme_tws_cmip6(df585)
  cordf585 = retcor[[1]]
  pdf585 = retcor[[2]]
  
  cordf585$y = cordf585$y-0.02
  cordf585$y = cordf585$y+0.02
  p2 = ggplot()+
    geom_point(data = df585,
               aes(x = TWS,y = value,
                   color = variable),
               size = 3.25,
               shape = 1)+
    geom_point(data = df585,
               aes(x = TWS,y = value,
                   color = variable),
               size = 3,
               shape = 1)+
    geom_abline(intercept = 0,slope = 1)+
    geom_text(data = cordf585,
              aes(x = x,y =y,label = cor),
              hjust = 0,
              size = 4,
              color = 'black')+
    geom_text(data = pdf585,
              aes(x = x,y = y,label = cor),
              hjust = 0,
              size = 4,
              color = 'black')+
    geom_text(data = subsdf,
              aes(x = x,y = y,label = label),
              hjust  =0,
              size = 4,
              color = 'black')+
    facet_wrap(~type,nrow = 4)+
    ylim(-0.25,0.25)+
    xlim(-0.25,0.25)+
    theme_bw()+
    xlab("Projected TWS")+
    ylab('PME')
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  p2 = p2+text_theme_set+
    theme(legend.position = 'bottom',
          strip.text =element_blank())+
    guides(color = guide_legend(title = '',
                                nrow = 1))
  
  output = 'main_plot/SI/cor_pme_tws_fut/'
  dir.create(output)
  output1 = paste0(output,'/figs11.png')
  png(output1,
      height = 20,
      width = 25,
      units = 'cm',
      res = 800)
  print(p2)
  dev.off()

}


figs_cor_analysis_pme_ato <- function(
  
){
  input_pme = list.files('analysis_output/cmip6_by_model/pme',
                         full.names = T)
  input_sst = list.files('analysis_output/cmip6_by_model/sst',
                         full.names = T)
  
  
  pme = lapply(lapply(input_pme,fread),as.data.frame)
  sst = lapply(lapply(input_sst,fread),as.data.frame)
  
  
  cmip6_trend_ts <- function(x){
    x = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(x)$trend
    
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    xm = (xt-mean(xt,na.rm = T))/
      (max(xt,na.rm=T)-min(xt,na.rm = T))
    return(xm)
  }
  
  type = c('ATO1_SSP245','ATO1_SSP585',
                'ATO3_SSP245','ATO3_SSP585')
  
  cor1 = 1
  p = 1
  
  dfpmeb = list()
  dfsstb = list()
  for(i in 1:4){
    pme[[i]] = apply(pme[[i]],2,cmip6_trend_ts)
    sst[[i]] = apply(sst[[i]],2,cmip6_trend_ts)
    
    pme_mean = apply(pme[[i]] ,1,mean)
    sst_mean = apply( sst[[i]],1,mean)
    
    tmp = cor.test(pme_mean,
                   sst_mean)
    cor1 = c(cor1,tmp$estimate)
    p = c(p,tmp$p.value)
    
    date = seq(as.Date('2003-01-01'),
               as.Date('2050-12-01'),
               '1 month')
    date = date[-c(1:6,571:576)]
    dfpme = data.frame(date,pme_mean)
    dfsst = data.frame(date,sst_mean)
    
    dfpme = reshape2::melt(dfpme,'date')
    dfsst = reshape2::melt(dfsst,'date')
    
    dfpme$type = type[i]
    dfsst$type = type[i]
    
    dfpmeb[[i]] = dfpme
    dfsstb[[i]] = dfsst
    
  }
  cor1 = cor1[-1]
  p = p[-1]
  
  cordf = data.frame(
    x = as.Date('2005-01-01'),
    y = -0.5,
    label = paste0("Pearson's R: ",round(cor,2)),
    type = type
  )
  
  pdf = data.frame(
    x = as.Date('2005-01-01'),
    y = -0.6,
    label = paste0("p.value: ",format(p, scientific = TRUE)),
    type = type
  )
  
  dflabel = data.frame(
    x = as.Date('2003-07-01'),
    y = 0.6,
    label = paste0('(',letters[1:4],')'),
    type = type
  )
  
  dfsstb = do.call(rbind,dfsstb)
  dfpmeb = do.call(rbind,dfpmeb)
  
  dfpmeb$variable = 'PME'
  dfsstb$variable = 'SST'
  
  cols = pal_lancet(alpha = 0.8)(9)
  cols = c("PME"=cols[1],
           "SST"= cols[2])
  
  
  pline = ggplot()+
    geom_line(data = dfpmeb,aes(x = date,y= value,
                                color = variable),
              size = 1)+
    geom_line(data = dfsstb,aes(x = date,y= value,
                                color = variable),
              size = 1)+
    scale_color_manual(values = cols)+
    facet_wrap(~type,nrow = 2)+
    theme_bw()
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  pline = pline+text_theme_set+
    theme(strip.text = element_blank())
  
  pline = pline+
    geom_text(data = dflabel,
              aes(x = x,y = y,label = label),
              size = 4,
              color= 'black')+
    guides(color = guide_legend(
      title= 'Standardized Indices',
      title.position = 'left',
      nrow = 1
    ),linetype = guide_legend(
      title= 'Standardized Indices',
      title.position = 'left',
      nrow = 1
    ))+
    xlab('Date')+
    ylab('Standardized Indices')
  
  cordf = rbind(cordf,pdf)
  
  pline =pline+
    geom_text(data = cordf,
              aes(x = x,y = y,label = label),
              color= 'black',size = 4,hjust = 0)
  
  output = 'main_plot/SI/figs_cor_cmip6_pmeato_sst/'
  dir.create(output)
  output = paste0(output,'/figs.png')
  
  png(output,
      height = 18,
      width = 26,
      units = 'cm',
      res = 800)
  print(pline)
  dev.off()
    
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
}
figs_cor_matrix_plot_withsig<-function(
  
){
  
  input_tws_subwindow = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws_subs = read.csv(input_tws_subwindow,header = T)
  tws_subs = tws_subs[,-1]
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  tws_subs = tws_subs[,id_box]
  
  naid= which(is.na(tws_subs[,1]))
  tws_subs = tws_subs[-naid,]
  colnames(tws_subs) = paste0('HSR\n',1:10)
  
  input_tws = 'tws_in_target/'
  input_tws = list.files(input_tws,
                         full.names = T)[c(1,3)]
  
  twsxj = do.call('cbind',lapply(
    lapply(input_tws,fread),as.data.frame
  ))
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  twsxj = apply(twsxj,2,trend_fun)
  colnames(twsxj) = c('North_XJ','South_XJ')
  
  twsdf = data.frame(
    tws_subs,
    twsxj
  )
  
  
  library(ggcor)
  library(vegan)
  library(dplyr)
  
  cordf = fortify_cor(tws_subs,type = 'upper',
                      show.diag = TRUE,
                      cor.test = T,
                      cluster_type = "all")
  
  
  cor_analze_xj_window <- function(xj,tws_subs,mode = 'North_XJ'){
    cor = 1
    p = 1
    for(i in 1:ncol(tws_subs)){
      tes = cor.test(tws_subs[,i],xj)
      cor = c(cor,tes$estimate)
      p = c(p,tes$p.value)
    }
    cor = cor[-1]
    p = p[-1]
    
    cols= colnames(tws_subs)
    ret = data.frame(
      spec = mode,
      env = cols,
      r = cor,
      p = p
    )
    return(ret)
  }
  
  ret1 = cor_analze_xj_window(twsxj[,1],tws_subs,
                              mode = 'North_XJ')
  ret2 = cor_analze_xj_window(twsxj[,2],tws_subs,
                              mode = 'South_XJ')
  
  
  mantel = rbind(ret1,ret2)
  mantel = mantel %>%
    mutate(r = cut(r, breaks = c(-Inf, 0.25, 0.5, 0.75,1),
                   labels = c("<0.25", "0.25-0.5", "0.5-0.75",
                              "0.75-1"),
                   right = FALSE),
           p.value = cut(p, breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
                         labels = c("<0.001", "0.001-0.01", "0.01-0.05", ">=0.05"),
                         right = FALSE))
  ps = data.frame(
    x = cordf$.row.names[which(cordf$r!=1)],
    y = cordf$.col.names[which(cordf$r!=1)],
    pvalue=cordf$p.value[which(cordf$r!=1)]
  )
  ps$pvalue = cut(ps$pvalue,
                  breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
                  labels = c("***", "**", "*", "x"),
                  right = FALSE)
  
  
  p1<-quickcor(tws_subs, type = "upper",
               fixed.xy = F) + 
    geom_square(inherit.aes = T,
                aes(fill = cut(r,
                               breaks = seq(0,1,0.1))))+
    anno_link(mantel, 
              mapping = aes(color = r,
                            size = r)) +
    scale_size_manual(values = c(1.5, 3)) +
    geom_diag_label(angle = 0,geom = "text", 
                    remove.axis = TRUE)
  p1
  
  
  p2<-p1+scale_fill_brewer(palette = 'Spectral',
                           direction = -1)
  
  pals = pal_lancet(alpha = 0.8)(9)[c(1,7)]
  #自定义连线
  p3<-p2+scale_color_manual(values=pals)
  p3
  #定义图例标题
  p3 = p3+guides(
    size=guide_legend(title="Pearson's R XJ~HSRs",
                      override.aes = list(size=3),
                      order=1,title.position = 'top'),
    colour=guide_legend(title="Pearson's R XJ~HSRs",
                        override.aes = list(size=3),
                        order=1,title.position = 'top'),
    fill=guide_legend(title="Pearson's R among HSRs",order=3,
                      title.position = 'top'))
  
  ######
  source("/home/share/R_project/xinjiang_vapor/figs_covar_twsxj_twssubs2.R")
  p4 = figs_covar_twsxj_twssubs2()
  #p4 =p4+coord_fixed(1.5)
  p4 = p4+theme(
    #plot.margin = unit(rep(0.1,4),'cm'),
    legend.position = 'bottom',
    legend.background = element_rect(fill = 'transparent',
                                     color= 'transparent')
  )
  
  p4 = p4+
    xlab('Date')+
    ylab("Standardized Indices")+
    theme(axis.title.x = element_blank())
  
  p4 = p4+
    guides(color = guide_legend(
      title.position = 'top',
      title = 'Standardized Indices',
      nrow= 3
    ),
    linetype =guide_legend(
      title.position = 'top',
      title = 'Standardized Indices',
      nrow = 3
    ) )
  p4leg = as_ggplot(get_legend(p4))
  
  p4leg = p4leg+theme(plot.margin = unit(rep(0.2,4),'cm'))
  p4 = p4+theme(legend.position = 'none')
  
  
  p3 = p3+theme(
    #plot.margin = unit(rep(0.1,4),'cm'),
    legend.position = 'bottom',
    legend.background = element_rect(fill = 'transparent',
                                     color= 'transparent')
  )
  
  p3leg = as_ggplot(get_legend(p3))
  p3leg = p3leg+theme(plot.margin = unit(rep(0.2,4),'cm'))
  p3 = p3+theme(legend.position = 'none')
  
  
  
  p34 = plot_grid(
    p3,p4,
    nrow = 1,
    rel_widths = c(1,1.2),
    rel_heights = c(1,1)
    #align = 'tb',
    # axis = 'h'
    
  )
  
  p34leg = plot_grid(
    p3leg,p4leg,nrow = 1
  )
  
  
  p34l = plot_grid(
    p34,
    p3leg,
    ncol = 1,
    rel_heights = c(11,1),
    align = 'none',
    axis = 'none'
  )
  
  
  p34l2 = ggdraw()+
    draw_plot(p34l)+
    draw_plot(p4leg,x = 0.7,y = 0.15,
              width = 0.3,height = 0.2)
  
  output = 'main_plot/SI/explore_cor_xj_subs'
  dir.create(output)
  output = paste0(output,'/cor_xj_subs6.png')
  png(output,
      height = 19,
      width = 26,
      units = 'cm',
      res = 800)
  print(p34l2)
  dev.off()
  
}
figs_cor_matrix_plot<-function(
  
){
  
  input_tws_subwindow = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws_subs = read.csv(input_tws_subwindow,header = T)
  tws_subs = tws_subs[,-1]
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  tws_subs = tws_subs[,id_box]
  
  naid= which(is.na(tws_subs[,1]))
  tws_subs = tws_subs[-naid,]
  colnames(tws_subs) = paste0('HSR\n',1:10)
  
  input_tws = 'tws_in_target/'
  input_tws = list.files(input_tws,
                         full.names = T)[c(1,3)]
  
  twsxj = do.call('cbind',lapply(
    lapply(input_tws,fread),as.data.frame
  ))
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  twsxj = apply(twsxj,2,trend_fun)
  colnames(twsxj) = c('North_XJ','South_XJ')
  
  twsdf = data.frame(
    tws_subs,
    twsxj
  )
  

  library(ggcor)
  library(vegan)
  library(dplyr)
  
  cordf = fortify_cor(tws_subs,type = 'upper',
                      show.diag = TRUE,
                      cor.test = T,
                      cluster_type = "all")
  
  
  cor_analze_xj_window <- function(xj,tws_subs,mode = 'North_XJ'){
    cor = 1
    p = 1
    for(i in 1:ncol(tws_subs)){
      tes = cor.test(tws_subs[,i],xj)
      cor = c(cor,tes$estimate)
      p = c(p,tes$p.value)
    }
    cor = cor[-1]
    p = p[-1]
    
    cols= colnames(tws_subs)
    ret = data.frame(
      spec = mode,
      env = cols,
      r = cor,
      p = p
    )
    return(ret)
  }
  
  ret1 = cor_analze_xj_window(twsxj[,1],tws_subs,
                              mode = 'North_XJ')
  ret2 = cor_analze_xj_window(twsxj[,2],tws_subs,
                              mode = 'South_XJ')
  

  mantel = rbind(ret1,ret2)
  mantel = mantel %>%
    mutate(r = cut(r, breaks = c(-Inf, 0.25, 0.5, 0.75,1),
                   labels = c("<0.25", "0.25-0.5", "0.5-0.75",
                              "0.75-1"),
                   right = FALSE),
           p.value = cut(p, breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
                         labels = c("<0.001", "0.001-0.01", "0.01-0.05", ">=0.05"),
                         right = FALSE))
  ps = data.frame(
    x = cordf$.row.names[which(cordf$r!=1)],
    y = cordf$.col.names[which(cordf$r!=1)],
    pvalue=cordf$p.value[which(cordf$r!=1)]
  )
  ps$pvalue = cut(ps$pvalue,
                    breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
                    labels = c("***", "**", "*", "x"),
                    right = FALSE)
  
  
  p1<-quickcor(tws_subs, type = "upper",
               fixed.xy = F) + 
    geom_square(inherit.aes = T,
                aes(fill = cut(r,
                               breaks = seq(0,1,0.1))))+
    anno_link(mantel, 
              mapping = aes(color = r,
                            size = r)) +
    scale_size_manual(values = c(1.5, 3)) +
    geom_diag_label(angle = 0,geom = "text", 
                    remove.axis = TRUE)
  p1
  
  
  p2<-p1+scale_fill_brewer(palette = 'Spectral',
                           direction = -1)
    
  pals = pal_lancet(alpha = 0.8)(9)[c(1,7)]
  #自定义连线
  p3<-p2+scale_color_manual(values=pals)
  p3
  #定义图例标题
  p3 = p3+guides(
            size=guide_legend(title="Pearson's R XJ~HSRs",
                              override.aes = list(size=3),
                              order=1,title.position = 'top'),
            colour=guide_legend(title="Pearson's R XJ~HSRs",
                                override.aes = list(size=3),
                                order=1,title.position = 'top'),
            fill=guide_legend(title="Pearson's R among HSRs",order=3,
                              title.position = 'top'))

  ######
  
  p4 = figs_covar_twsxj_twssubs()
  #p4 =p4+coord_fixed(1.5)
  p4 = p4+theme(
    #plot.margin = unit(rep(0.1,4),'cm'),
    legend.position = 'bottom',
    legend.background = element_rect(fill = 'transparent',
                                     color= 'transparent')
  )
  
  p4 = p4+
    xlab('Date')+
    ylab("Standardized Indices")+
    theme(axis.title.x = element_blank())
  
  p4 = p4+
    guides(color = guide_legend(
      title.position = 'top',
      title = 'Standardized Indices',
      nrow= 3
    ),
    linetype =guide_legend(
      title.position = 'top',
      title = 'Standardized Indices',
      nrow = 3
    ) )
  p4leg = as_ggplot(get_legend(p4))
  
  p4leg = p4leg+theme(plot.margin = unit(rep(0.2,4),'cm'))
  p4 = p4+theme(legend.position = 'none')
  
  
  p3 = p3+theme(
    #plot.margin = unit(rep(0.1,4),'cm'),
    legend.position = 'bottom',
    legend.background = element_rect(fill = 'transparent',
                                     color= 'transparent')
  )
  
  p3leg = as_ggplot(get_legend(p3))
  p3leg = p3leg+theme(plot.margin = unit(rep(0.2,4),'cm'))
  p3 = p3+theme(legend.position = 'none')
  

  
  p34 = plot_grid(
    p3,p4,
    nrow = 1,
    rel_widths = c(1,1.2),
    rel_heights = c(1,1)
    #align = 'tb',
   # axis = 'h'
    
  )
  
  p34leg = plot_grid(
    p3leg,p4leg,nrow = 1
  )
  
  
  p34l = plot_grid(
    p34,
    p3leg,
    ncol = 1,
    rel_heights = c(11,1),
    align = 'none',
    axis = 'none'
  )
  
  
  p34l2 = ggdraw()+
    draw_plot(p34l)+
    draw_plot(p4leg,x = 0.7,y = 0.15,
              width = 0.3,height = 0.2)
  
  output = 'main_plot/SI/explore_cor_xj_subs'
  dir.create(output)
  output = paste0(output,'/cor_xj_subs6.png')
  png(output,
      height = 19,
      width = 26,
      units = 'cm',
      res = 800)
  print(p34l2)
  dev.off()
  
}
figs_covar_pme13_tws_cmip6_his <- function(
  
){
  # import pme1234 
  input_sst = list.files('analysis_output/cmip6_by_model/sst',
                         full.names = T)
  input_pme = list.files('analysis_output/cmip6_by_model/pme',
                         full.names = T)
  
  sst = lapply(lapply(input_sst,fread),as.data.frame)
  pme = lapply(lapply(input_pme,fread),as.data.frame)
  
  sst_trend = sst
  pme_trend = pme
  #sst_trend = lapply(sst,trend_fun)
  #pme_trend = lapply(pme,trend_fun)
  
  sst1_ssp245 = sst_trend[[1]]
  sst1_ssp585 = sst_trend[[2]]
  sst3_ssp245 = sst_trend[[3]]
  sst3_ssp585 = sst_trend[[4]]
  
  pme1_ssp245 = pme_trend[[1]]
  pme1_ssp585 = pme_trend[[2]]
  pme3_ssp245 = pme_trend[[3]]
  pme3_ssp585 = pme_trend[[4]]
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(sst1_ssp245) = modelnames
  colnames(sst1_ssp585) = modelnames
  colnames(sst3_ssp245) = modelnames
  colnames(sst3_ssp585) = modelnames
  
  colnames(pme1_ssp245) = modelnames
  colnames(pme1_ssp585) = modelnames
  colnames(pme3_ssp245) = modelnames
  colnames(pme3_ssp585) = modelnames
  
  sst1_ssp245 <<- sst1_ssp245
  sst1_ssp585 <<- sst1_ssp585
  sst3_ssp245 <<- sst3_ssp245
  sst3_ssp585 <<- sst3_ssp585
  
  pme1_sst245 <<- pme1_ssp245
  pme3_ssp245 <<- pme3_ssp245
  pme1_ssp585 <<- pme1_ssp585
  pme3_ssp585 <<- pme3_ssp585
  
  pme1_pj245 = as.matrix(pme1_ssp245[1:174,])
  pme3_pj245 = as.matrix(pme3_ssp245[1:174,])
  pme1_pj585 = as.matrix(pme1_ssp585[1:174,])
  pme3_pj585 = as.matrix(pme3_ssp585[1:174,])
  source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
  pme1_pj245 = trend_fun(pme1_pj245)
  pme3_pj245 = trend_fun(pme3_pj245)
  
  naid = which(is.na(pme3_pj245[,1]))
  pme3_pj245 = pme3_pj245[-naid,]
  pme1_pj245 = pme1_pj245[-naid,]
  
  pme1_pj585 = trend_fun(pme1_pj585)
  pme3_pj585 = trend_fun(pme3_pj585)
  
  naid = which(is.na(pme3_pj585[,1]))
  pme3_pj585 = pme3_pj585[-naid,]
  pme1_pj585 = pme1_pj585[-naid,]
  
  pme1_pj245 = apply(pme1_pj245,1,mean)
  pme3_pj245 = apply(pme3_pj245,1,mean)
  pme1_pj585 = apply(pme1_pj585,1,mean)
  pme3_pj585 = apply(pme3_pj585,1,mean)
  
  pmedf = data.frame(
    PME_ATO1_SSP245 = pme1_pj245,
    PME_ATO1_SSP585 = pme1_pj585,
    PME_ATO3_SSP245 = pme3_pj245,
    PME_ATO3_SSP585 = pme3_pj585
  )
  
  subs_tws = as.data.frame(fread('analysis_output/tws_subwindow_2003_2017.csv'))
  subs_tws = subs_tws[,-1]
  
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  subs_tws = subs_tws[,id_box]
  subs_tws = subs_tws[-naid,]
  colnames(subs_tws) = paste0('HSR',1:10)
  
  cor2 = data.frame(cor1 =NA,type = '1')
  p2 = data.frame(p1 =NA,type = '1')
  for(i in 1:ncol(subs_tws)){
    cor1 = 1
    p1 = 1
    for(j in 1:ncol(pmedf)){
      cort = cor.test(subs_tws[,i],pmedf[,j])
      tmpcor = round(cort$estimate,2)
      p = cort$p.value
      
      p1 = c(p1,p)
      cor1 = c(cor1,tmpcor)
    }
    cor1 = cor1[-1]
    p1 = p1[-1]
    
    cor1 = data.frame(cor1,type = paste0('HSR',i))
    p1 = data.frame(p1,type = paste0('HSR',i))
    
    cor2 = rbind(cor2,cor1)
    p2 = rbind(p2,p1)
  }
  cor2 = cor2[-1,]
  p2 = p2[-1,]
  
  date = seq(as.Date('2003-01-01'),as.Date('2017-12-01'),'1 month')
  date = date[1:174]
  date = date[-naid]
  
  pmedf$date = date
  pmedf = reshape2::melt(pmedf,'date')
  
  subs_tws$date= date
  subs_tws = reshape2::melt(subs_tws,'date')
  
  subs_tws$type = subs_tws$variable
  subs_tws$col = 'TWS'
  pmedf$col = pmedf$variable
  
  pals = pal_lancet(alpha = 0.8)(9)
  pals = colorRampPalette(pals)(20)[c(6:9,16)]
  
  p2$label = 'p>0.05'
  p2$label[which(p2$p1<0.05)] = 'p<0.05'
  
  corpdf = data.frame(
    x = as.Date(date[3]),
    y = rep(c(-0.3,-0.4,-0.5,-0.6),10),
    label = paste0('R: ',cor2$cor1,' ',p2$label),
    col = rep(as.character(unique(pmedf$col)),10),
    type = cor2$type
  )
  labeldf = data.frame(
    x = as.Date(date[3]),
    y = 0.6,
    label = paste0('(',letters[1:10],')'),
    type = paste0('HSR',1:10)
  )
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  p = ggplot()+
    geom_line(data = subs_tws,aes(x = date,y =value,color = col),
              size = 1.2)+
    geom_line(data = pmedf,aes(x = date,y =value,color = col),
              size = 1.2)+
    geom_text(data = corpdf,aes(x = x,y=y,label=label,color = col),
              size = 4.5,hjust = 0)+
    geom_text(data = labeldf,aes(x = x,y = y,label = label),color = 'black',
              size = 4.5,hjust = 0)+
    scale_color_manual(values = pals)+
    facet_wrap(~type,nrow = 2)+
    guides(color = guide_legend(title = 'Normalized indices',
                               title.position = 'top'))+
    theme_bw()+
    xlab('Time (month)')+
    ylab('Normalized indices')+text_theme_set
    
  dir.create('main_plot/SI/cor_covar_anlysis_pme13_twssubs')
  output = 'main_plot/SI/cor_covar_anlysis_pme13_twssubs/figs3.png'
  png(output,
      height = 20,
      width = 30,
      units = 'cm',
      res = 800)
  print(p)
  dev.off()
    
  
  
  
  
  
}
figs_covar_sst_pme1234_cmip6 <- function(
  
){
  input_sst = list.files('analysis_output/cmip6_by_model/sst',
                         full.names = T)
  input_pme = list.files('analysis_output/cmip6_by_model/pme',
                         full.names = T)
  
  
  
  sst = lapply(lapply(input_sst,fread),as.data.frame)
  pme = lapply(lapply(input_pme,fread),as.data.frame)
  
  sst_trend = sst
  pme_trend = pme
  #sst_trend = lapply(sst,trend_fun)
  #pme_trend = lapply(pme,trend_fun)
  
  sst1_ssp245 = sst_trend[[1]]
  sst1_ssp585 = sst_trend[[2]]
  sst3_ssp245 = sst_trend[[3]]
  sst3_ssp585 = sst_trend[[4]]
  
  pme1_ssp245 = pme_trend[[1]]
  pme1_ssp585 = pme_trend[[2]]
  pme3_ssp245 = pme_trend[[3]]
  pme3_ssp585 = pme_trend[[4]]
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(sst1_ssp245) = modelnames
  colnames(sst1_ssp585) = modelnames
  colnames(sst3_ssp245) = modelnames
  colnames(sst3_ssp585) = modelnames
  
  colnames(pme1_ssp245) = modelnames
  colnames(pme1_ssp585) = modelnames
  colnames(pme3_ssp245) = modelnames
  colnames(pme3_ssp585) = modelnames
  
  sst1_ssp245 <<- sst1_ssp245
  sst1_ssp585 <<- sst1_ssp585
  sst3_ssp245 <<- sst3_ssp245
  sst3_ssp585 <<- sst3_ssp585
  
  pme1_sst245 <<- pme1_ssp245
  pme3_ssp245 <<- pme3_ssp245
  pme1_ssp585 <<- pme1_ssp585
  pme3_ssp585 <<- pme3_ssp585
  
  pme1_pj245 = as.matrix(pme1_ssp245[175:576,])
  pme3_pj245 = as.matrix(pme3_ssp245[175:576,])
  
  source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
  pme1_pj245 = trend_fun(pme1_pj245)
  pme3_pj245 = trend_fun(pme3_pj245)
  
  naid = which(is.na(pme3_pj245[,1]))
  pme3_pj245 = pme3_pj245[-naid,]
  pme1_pj245 = pme1_pj245[-naid,]
  
  pme1_pj585 = as.matrix(pme1_ssp585[175:576,])
  pme3_pj585 = as.matrix(pme3_ssp585[175:576,])
  
  source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
  pme1_pj585 = trend_fun(pme1_pj585)
  pme3_pj585 = trend_fun(pme3_pj585)
  
  naid = which(is.na(pme3_pj585[,1]))
  pme3_pj585 = pme3_pj585[-naid,]
  pme1_pj585 = pme1_pj585[-naid,]
  
  
  pme1_mean245 = apply(pme1_pj245,1,mean)
  pme3_mean245 = apply(pme3_pj245,1,mean)
  pme1_mean585 = apply(pme1_pj585,1,mean)
  pme3_mean585 = apply(pme3_pj585,1,mean)
  sst1_pj245 = as.matrix(sst1_ssp245[175:576,])
  sst3_pj245 = as.matrix(sst3_ssp245[175:576,])
  
  source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
  sst1_pj245 = trend_fun(sst1_pj245)
  sst3_pj245 = trend_fun(sst3_pj245)
  
  naid = which(is.na(sst3_pj245[,1]))
  sst3_pj245 = sst3_pj245[-naid,]
  sst1_pj245 = sst1_pj245[-naid,]
  
  sst1_pj585 = as.matrix(sst1_ssp585[175:576,])
  sst3_pj585 = as.matrix(sst3_ssp585[175:576,])
  
  source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
  sst1_pj585 = trend_fun(sst1_pj585)
  sst3_pj585 = trend_fun(sst3_pj585)
  
  naid = which(is.na(sst3_pj585[,1]))
  sst3_pj585 = sst3_pj585[-naid,]
  sst1_pj585 = sst1_pj585[-naid,]
  
  
  sst1_mean245 = apply(sst1_pj245,1,mean)
  sst3_mean245 = apply(sst3_pj245,1,mean)
  sst1_mean585 = apply(sst1_pj585,1,mean)
  sst3_mean585 = apply(sst3_pj585,1,mean)
  
  pmedf = data.frame(
    pme1_mean245,pme1_mean585,
    pme3_mean245,pme3_mean585
  )
  sstdf = data.frame(
    sst1_mean245,sst1_mean585,
    sst3_mean245,sst3_mean585
  )
  
  cors = 1
  ps = 1
  for(i in 1:ncol(pmedf)){
    cor = cor.test(pmedf[,i],sstdf[,i])
    p = cor$p.value
    cor = cor$estimate
    cors = c(cors,cor)
    ps  =c(ps,p)
  }
  cors = cors[-1]
  ps = ps[-1]
  
  
  date = seq(as.Date('2018-01-01'),as.Date('2050-12-01'),'1 month')
  date = date[-naid]
  
  pmedf1 = data.frame(date,pmedf)
  sstdf1 = data.frame(date,sstdf)
  
  pmedf1 = reshape2::melt(pmedf1,'date')
  sstdf1 = reshape2::melt(sstdf1,'date')
  
  pmedf1$col = 'PME'
  sstdf1$col = 'SST'
  pmedf1$type = rep(c('ATO1-SSP245','ATO1-SSP585','ATO3-SSP245','ATO3-SSP585'),each = 390)
  sstdf1$type = pmedf1$type
  
  pal1 = pal_lancet(alpha = 0.8)(9)[c(1,7)]
  
  cordf = data.frame(
    x = as.Date('2019-01-01'),
    y = -0.5,
    label = paste0('Pearson R: ',round(cors,2)),
    type = c('ATO1-SSP245','ATO1-SSP585','ATO3-SSP245','ATO3-SSP585')
  )
  
  pdf = data.frame(
    x = as.Date('2019-01-01'),
    y = -0.6,
    label = paste0('p.value: ',format(ps,2)),
    type =c('ATO1-SSP245','ATO1-SSP585','ATO3-SSP245','ATO3-SSP585')
  )
  
  labdf = data.frame(
    x = as.Date('2019-01-01'),
    y = 0.6,
    label = paste0('(',letters[1:4],')'),
    type = c('ATO1-SSP245','ATO1-SSP585','ATO3-SSP245','ATO3-SSP585')
  )
  
  
  p = ggplot()+
    geom_line(data = pmedf1,aes(x =date,y = value, color = col),
              size = 1.5)+
    geom_line(data = sstdf1,aes(x = date,y = value,color = col),
              size = 1.5)+
    geom_text(data = cordf,aes(x = x,y = y,label = label),
              color = 'black',size = 4,hjust = 0)+
    geom_text(data = pdf,aes(x = x,y = y,label = label),
              color = 'black',size = 4,hjust = 0)+
    geom_text(data = labdf,aes(x = x,y = y,label = label),
              color = 'black',size = 4)+
    scale_color_manual(values = pal1)+
    facet_wrap(~type,nrow = 2)+
    theme_bw()
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  p = p + text_theme_set+
    theme(legend.title = element_blank())+
    xlab('Time (month)')+
    ylab('Normalized indices')
  
  output = 'main_plot/SI/figs_cor_cmip6_pmeato_sst/'
  dir.create(output)
  output = paste0(output,'/figs3.png')
  
  png(output,
      height = 24,
      width = 26,
      units = 'cm',
      res = 800)
  print(p)
  dev.off()
  
  
}
figs_covar_sst_pme1234 <- function(
  
){
  # cor plot 
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pe_in_source = pe_in_source * 30.5
  
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  pe_minus_eva = pe_in_source - pet_sum
  colnames(pe_minus_eva) = paste0('PME',1:12)
  pmedf = pe_minus_eva[,1:11]
  
  pmedf = pmedf[,c(5:8)]
  pmedf$PME13 = pmedf[,1]+pmedf[,3]
  pmedf$PME24 = pmedf[,2]+pmedf[,4]
  
  colnames(pmedf) = c(paste0("ATO",1:4),'ATO13','ATO24')
  
  input_sst = list.files('era5_sst_mean/ato/',
                         full.names = T)
  input_sst = lapply(input_sst,list.files,full.names = T)
  
  sst = lapply(lapply(input_sst,fread),as.data.frame)
  sst = do.call(cbind,sst)[1:174,]
  sst$SST13 = (sst[,1]+sst[,3])/2
  sst$SST24 = (sst[,2]+sst[,4])/2
  

  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  pmedf = apply(pmedf,2,trend_fun)
  sstdf = apply(sst,2,trend_fun)
  colnames(sstdf) = c(paste0("ATO",1:4),'ATO13','ATO24')
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),'1 month')[1:174]
  date = date[-c(1:6,169:174)]
  
  dfsst = data.frame(date = date,
                     sstdf)
  dfpme = data.frame(date = date,
                     pmedf)
  
  dfsst = reshape2::melt(dfsst,'date')
  dfpme = reshape2::melt(dfpme,'date')
  
  dfsst$type = dfsst$variable
  dfpme$type = dfpme$variable
  
  dfsst$variable = 'SST'
  dfpme$variable = 'PME'
  
  cols = pal_lancet(alpha = 0.8)(10)
  cols = c('PME'= cols[1],
           'SST' = cols[7])
  
  
  pline =ggplot()+
    geom_line(data = dfsst,
              aes(x = date,y = value,
                  color = variable,
                  linetype = variable),
              size = 1)+
    geom_line(data = dfpme,
              aes(x = date,y = value,
                  color = variable,
                  linetype = variable),
              size = 1)+
    scale_color_manual(values = cols)+
    facet_wrap(~type,nrow = 2)+
    theme_bw()
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  pline = pline+text_theme_set+
    theme(strip.text = element_blank())
  
  dflabel = data.frame(
    x = as.Date('2003-07-01'),
    y = 0.6,
    label = paste0('(',letters[3:8],')'),
    type = c(paste0('ATO',1:4),'ATO13','ATO24')
  )
  
  pline = pline+
    geom_text(data = dflabel,
              aes(x = x,y = y,label = label),
              size = 4,
              color= 'black')+
    guides(color = guide_legend(
      title= 'Standardized Indices',
      title.position = 'top',
      nrow = 3
    ),linetype = guide_legend(
      title= 'Standardized Indices',
      title.position = 'top',
      nrow = 3
    ))+
    xlab('Date')+
    ylab('Standardized Indices')
  
  
  cor = 1
  p = 1
  pmedf = as.data.frame(pmedf)
  sstdf = as.data.frame(sstdf)
  for(i in 1:ncol(pmedf)){
    tmp1 = cor.test(pmedf[,i],
                    sstdf[,i])
    
    p = c(p,tmp1$p.value)
    tmp1 = max(ccf(pmedf[,i],sstdf[,i])$acf)
    
    cor = c(cor,tmp1)
    
  }
  cor = cor[-1]
  p = p [-1]
  
  cordf = data.frame(
    x = as.Date('2005-01-01'),
    y = -0.5,
    label = paste0("Cross Pearson's correlation: ",round(cor,2)),
    type = c(paste0('ATO',1:4),'ATO13','ATO24')
  )
  
  pdf = data.frame(
    x = as.Date('2005-01-01'),
    y = -0.6,
    label = paste0("p.value: ",format(p, scientific = TRUE)),
    type = c(paste0('ATO',1:4),'ATO13','ATO24')
  )
  
  cordf = rbind(cordf,pdf)
  
  pline =pline+
    geom_text(data = cordf,
              aes(x = x,y = y,label = label),
              color= 'black',size = 4,hjust = 0)
  
  
  
  pmap = figs_sst_mmk()
  
  mapleg = as_ggplot(get_legend(pmap))
  mapleg = mapleg+theme(
    plot.margin = unit(rep(0,4),'cm')
  )
  lleg = as_ggplot(get_legend(pline+
                                theme(legend.position = 'bottom')))
  lleg = lleg+theme(
    plot.margin = unit(rep(0,4),'cm')
  )
  
  pmap = pmap+theme(legend.position = 'none',
                    axis.text.y = element_text(
                      angle = 90,hjust = 0.5
                    ),
                    axis.title.x = element_blank())+
    ylab('Latitude')
  pline = pline+theme(legend.position = 'none',
                      axis.text.y = element_text(
                        angle = 90,hjust = 0.5
                      ))
  
  pcoms = plot_grid(
    pmap,pline,
    ncol = 1,
    rel_heights = c(1,1.5),
    align = 'lr',
    axis = 'h'
  )
  
  legs = plot_grid(
    mapleg,lleg,nrow = 1,
    align = 't'
  )
  
  pcoms = plot_grid(pcoms,legs,ncol = 1,
                    rel_heights = c(10,1),
                    align = 'r')
  output = 'main_plot/SI/figs_cor_era5_pmeato_sst/'
  dir.create(output)
  output = paste0(output,'/figs2.png')
  
  png(output,
      height = 24,
      width = 26,
      units = 'cm',
      res = 800)
  print(pcoms)
  dev.off()
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
}



















figs_covar_twssubs_pme24_withsig <- function(
  
){
  input_tws_subwindow = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws_subs = read.csv(input_tws_subwindow,header = T)
  tws_subs = tws_subs[,-1]
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  tws_subs = tws_subs[,id_box]
  
  naid= which(is.na(tws_subs[,1]))
  tws_subs = tws_subs[-naid,]
  colnames(tws_subs) = paste0('SW',1:10)
  
  # cor plot 
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pe_in_source = pe_in_source * 30.5
  
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  pe_minus_eva = pe_in_source - pet_sum
  colnames(pe_minus_eva) = paste0('PME',1:12)
  pmedf = pe_minus_eva[,1:11]
  
  pmedf = pmedf[,c(6,8)]
  
  colnames(pmedf) = paste0('PME_ATO',c(2,4))
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  pmedf = apply(pmedf,2,trend_fun)
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),'1 month')[1:174]
  date = date[-c(1:6,169:174)]
  
  dfsubs = data.frame(date = date,
                      tws_subs)
  dfpme = data.frame(date = date,
                     pmedf)
  
  dfsubs = reshape2::melt(dfsubs,'date')
  dfpme = reshape2::melt(dfpme,'date')
  
  dfsubs$type = dfsubs$variable
  dfsubs$variable = 'TWS_SWs'
  
  
  cols = pal_lancet(alpha = 0.8)(10)
  cols = c('PME_ATO2'= cols[1],
           'PME_ATO4' = cols[4],
           'TWS_SWs' = cols[7])
  
  
  pline =ggplot()+
    geom_line(data = dfsubs,
              aes(x = date,y = value,
                  color = variable,
                  linetype = variable))+
    geom_line(data = dfpme,
              aes(x = date,y = value,
                  color = variable,
                  linetype = variable))+
    scale_color_manual(values = cols)+
    facet_wrap(~type,nrow = 2)+
    theme_bw()
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  pline = pline+text_theme_set+
    theme(strip.text = element_blank())
  
  dflabel = data.frame(
    x = as.Date('2005-01-01'),
    y = -0.6,
    label = paste0('(',letters[1:10],')'),
    type = paste0('SW',1:10)
  )
  
  pline = pline+
    geom_text(data = dflabel,
              aes(x = x,y = y,label = label),
              size = 4,
              color= 'black')+
    guides(color = guide_legend(
      title= 'Standardized Indices',
      title.position = 'top',
      nrow = 1
    ),linetype = guide_legend(
      title= 'Standardized Indices',
      title.position = 'top',
      nrow = 1
    ))+
    xlab('Date')+
    ylab('Standardized Indices')
  
  
  cor_analze_pme_window <- function(xj,tws_subs,mode = 'North_XJ'){
    cor = 1
    p = 1
    for(i in 1:ncol(tws_subs)){
      tes = max(ccf(tws_subs[,i],xj)$acf)
      cor = c(cor,tes)
      
      tmpp = cor.test(tws_subs[,i],xj)$p.value
      p = c(p,tmpp)
      
    }
    cor = cor[-1]
    p = p[-1]
    
    cols= colnames(tws_subs)
    ret = data.frame(
      variable = mode,
      type = cols,
      r = cor,
      p = p
    )
    return(ret)
  }
  
  
  cor1 = cor_analze_pme_window(pmedf[,1],
                               tws_subs,
                               mode = 'PME_ATO2')
  
  cor2 = cor_analze_pme_window(pmedf[,2],
                               tws_subs,
                               mode = 'PME_ATO4')
  
  corp1 = cor1
  corp2 = cor2
  
  corp1$y = -0.55
  corp2$y = -0.65
  
  corp1$x = as.Date('2010-01-01')
  corp2$x = as.Date('2010-01-01')
  
  corp = rbind(corp1,corp2)
  corp$label = paste0(
    'p:',scientific(corp$p,2),'<0.05'
  )
  corp$label[1] = paste0(
    'p:',scientific(corp$p[1],2),'>0.05'
  )
  
  cor1$y = 0.6
  cor2$y = 0.5
  cordf = rbind(cor1,cor2)
  
  cordf$label = paste0('Cross PR: ',
                       round(cordf$r,2))
  
  
  cordf$x = as.Date('2009-03-01')
  
  pline =pline+
    geom_text(data = cordf,
              aes(x = x,y = y,label = label,
                  color  =variable),size = 4,hjust = 0)+
    geom_text(data = corp,
              aes(x = x,y = y,label = label,
                  color  =variable),size = 4,hjust = 0.5)
  
  
  
  
  output = 'main_plot/SI/figs_covar_pme24/'
  dir.create(output)
  output = paste0(output,'/figs2.png')
  
  png(output,
      height = 18,
      width = 26,
      units = 'cm',
      res = 800)
  print(pline)
  dev.off()
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
}



















figs_covar_twssubs_pme24 <- function(
  
){
  input_tws_subwindow = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws_subs = read.csv(input_tws_subwindow,header = T)
  tws_subs = tws_subs[,-1]
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  tws_subs = tws_subs[,id_box]
  
  naid= which(is.na(tws_subs[,1]))
  tws_subs = tws_subs[-naid,]
  colnames(tws_subs) = paste0('SW',1:10)
  
  # cor plot 
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pe_in_source = pe_in_source * 30.5
  
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  pe_minus_eva = pe_in_source - pet_sum
  colnames(pe_minus_eva) = paste0('PME',1:12)
  pmedf = pe_minus_eva[,1:11]
  
  pmedf = pmedf[,c(6,8)]
  
  colnames(pmedf) = paste0('PME_ATO',c(2,4))
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  pmedf = apply(pmedf,2,trend_fun)
 
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),'1 month')[1:174]
  date = date[-c(1:6,169:174)]
  
  dfsubs = data.frame(date = date,
                      tws_subs)
  dfpme = data.frame(date = date,
                     pmedf)
  
  dfsubs = reshape2::melt(dfsubs,'date')
  dfpme = reshape2::melt(dfpme,'date')
  
  dfsubs$type = dfsubs$variable
  dfsubs$variable = 'TWS_SWs'
  
  
  cols = pal_lancet(alpha = 0.8)(10)
  cols = c('PME_ATO2'= cols[1],
           'PME_ATO4' = cols[4],
           'TWS_SWs' = cols[7])
  
  
  pline =ggplot()+
    geom_line(data = dfsubs,
              aes(x = date,y = value,
                  color = variable,
                  linetype = variable))+
    geom_line(data = dfpme,
              aes(x = date,y = value,
                  color = variable,
                  linetype = variable))+
    scale_color_manual(values = cols)+
    facet_wrap(~type,nrow = 2)+
    theme_bw()
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  pline = pline+text_theme_set+
    theme(strip.text = element_blank())
  
  dflabel = data.frame(
    x = as.Date('2005-01-01'),
    y = -0.6,
    label = paste0('(',letters[1:10],')'),
    type = paste0('SW',1:10)
  )
  
  pline = pline+
    geom_text(data = dflabel,
              aes(x = x,y = y,label = label),
              size = 4,
              color= 'black')+
    guides(color = guide_legend(
      title= 'Standardized Indices',
      title.position = 'top',
      nrow = 1
    ),linetype = guide_legend(
      title= 'Standardized Indices',
      title.position = 'top',
      nrow = 1
    ))+
    xlab('Date')+
    ylab('Standardized Indices')
  
  
  cor_analze_pme_window <- function(xj,tws_subs,mode = 'North_XJ'){
    cor = 1
    p = 1
    for(i in 1:ncol(tws_subs)){
      tes = max(ccf(tws_subs[,i],xj)$acf)
      cor = c(cor,tes)
    }
    cor = cor[-1]
    p = p[-1]
    
    cols= colnames(tws_subs)
    ret = data.frame(
      variable = mode,
      type = cols,
      r = cor
    )
    return(ret)
  }
  
  
  cor1 = cor_analze_pme_window(pmedf[,1],
                               tws_subs,
                               mode = 'PME_ATO2')
  
  cor2 = cor_analze_pme_window(pmedf[,2],
                               tws_subs,
                               mode = 'PME_ATO4')
  
  cor1$y = 0.6
  cor2$y = 0.5
  cordf = rbind(cor1,cor2)
  
  cordf$label = paste0('Cross PR: ',
                       round(cordf$r,2))
  
  cordf$x = as.Date('2009-03-01')
  
  pline =pline+
    geom_text(data = cordf,
              aes(x = x,y = y,label = label,
                  color  =variable),size = 4,hjust = 0)
  

  
  output = 'main_plot/SI/figs_covar_pme24/'
  dir.create(output)
  output = paste0(output,'/figs.png')
  
  png(output,
      height = 18,
      width = 26,
      units = 'cm',
      res = 800)
  print(pline)
  dev.off()
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
   
}



















figs_covar_twsxj_twssubs <-function(
  
){
  
  input_tws_subwindow = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws_subs = read.csv(input_tws_subwindow,header = T)
  tws_subs = tws_subs[,-1]
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  tws_subs = tws_subs[,id_box]
  
  naid= which(is.na(tws_subs[,1]))
  tws_subs = tws_subs[-naid,]
  colnames(tws_subs) = paste0('HSR',1:10)
  
  input_tws = 'tws_in_target/'
  input_tws = list.files(input_tws,
                         full.names = T)[c(1,3)]
  
  twsxj = do.call('cbind',lapply(
    lapply(input_tws,fread),as.data.frame
  ))
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  twsxj = apply(twsxj,2,trend_fun)
  colnames(twsxj) = c('TWS_North_XJ','TWS_South_XJ')
  
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),'1 month')[1:174]
  date = date[-c(1:6,169:174)]
  
  dfsubs = data.frame(date = date,
                      tws_subs)
  dfxj = data.frame(
    date = date,
    twsxj
  )
  
  dfsubs = reshape2::melt(dfsubs,'date')
  dfxj = reshape2::melt(dfxj,'date')
  
  dfsubs$type = factor(dfsubs$variable,
                       levels = paste0('HSR',1:10))
  dfsubs$variable = 'TWS_HSRs'
  
  cols = pal_lancet(alpha = 0.8)(9)
  
  cols = c('TWS_HSRs' = cols[7],
           'TWS_North_XJ' = cols[1],
           'TWS_South_XJ' = cols[4])
  
  cor_analze_xj_window <- function(xj,tws_subs,mode = 'North_XJ'){
    cor = 1
    p = 1
    for(i in 1:ncol(tws_subs)){
      tes = cor.test(tws_subs[,i],xj)
      cor = c(cor,tes$estimate)
      p = c(p,tes$p.value)
    }
    cor = cor[-1]
    p = p[-1]
    
    cols= colnames(tws_subs)
    ret = data.frame(
      spec = mode,
      env = cols,
      r = cor,
      p = p
    )
    return(ret)
  }
  
  ret1 = cor_analze_xj_window(twsxj[,1],tws_subs,
                              mode = 'TWS_North_XJ')
  ret2 = cor_analze_xj_window(twsxj[,2],tws_subs,
                              mode = 'TWS_South_XJ')
  
  ret1$y = 0.6
  ret2$y = 0.4
  cordf = rbind(ret1,ret2)
  cordf$x = as.Date('2010-01-01')
  
  cordf$label = paste0("R: ",
                       round(cordf$r,2))
  
  cordf$type = cordf$env
  cordf$variable = cordf$spec
 
  pcovar = ggplot()+
    geom_line(data = dfsubs,
              aes(x = date,y= value,
                  color = variable,
                  linetype = variable),
              size = 1)+
    geom_line(data = dfxj,
              aes(x = date,y= value,
                  color = variable,
                  linetype = variable),
              size = 1)+
    geom_text(data = cordf,
              aes(x=x,y = y,label = label,
                  color = variable),
              size = 4,hjust = 0)+
    scale_color_manual(values = cols)+
    facet_wrap(~type,nrow = 3)+
    theme_bw()
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  pcovar = pcovar+text_theme_set
  
  
  subsdf = data.frame(
    x = as.Date('2005-01-01'),
    y = -0.45,
    label = paste0('(',letters[2:11],')'),
    type = paste0('HSR',1:10)
  )
  
  pcovar = pcovar+
    geom_text(data = subsdf,
              aes(x=x,y = y,label = label),
              color = 'black',
              size = 4,hjust = 0)
  
  return(pcovar)
  
  
  
  
  
  
  
}
figs_covar_twsxj_twssubs2 <-function(
  
){
  
  input_tws_subwindow = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws_subs = read.csv(input_tws_subwindow,header = T)
  tws_subs = tws_subs[,-1]
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  tws_subs = tws_subs[,id_box]
  
  naid= which(is.na(tws_subs[,1]))
  tws_subs = tws_subs[-naid,]
  colnames(tws_subs) = paste0('HSR',1:10)
  
  input_tws = 'tws_in_target/'
  input_tws = list.files(input_tws,
                         full.names = T)[c(1,3)]
  
  twsxj = do.call('cbind',lapply(
    lapply(input_tws,fread),as.data.frame
  ))
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  twsxj = apply(twsxj,2,trend_fun)
  colnames(twsxj) = c('TWS_North_XJ','TWS_South_XJ')
  
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),'1 month')[1:174]
  date = date[-c(1:6,169:174)]
  
  dfsubs = data.frame(date = date,
                      tws_subs)
  dfxj = data.frame(
    date = date,
    twsxj
  )
  
  dfsubs = reshape2::melt(dfsubs,'date')
  dfxj = reshape2::melt(dfxj,'date')
  
  dfsubs$type = factor(dfsubs$variable,
                       levels = paste0('HSR',1:10))
  dfsubs$variable = 'TWS_HSRs'
  
  cols = pal_lancet(alpha = 0.8)(9)
  
  cols = c('TWS_HSRs' = cols[7],
           'TWS_North_XJ' = cols[1],
           'TWS_South_XJ' = cols[4])
  
  cor_analze_xj_window <- function(xj,tws_subs,mode = 'North_XJ'){
    cor = 1
    p = 1
    for(i in 1:ncol(tws_subs)){
      tes = cor.test(tws_subs[,i],xj)
      cor = c(cor,tes$estimate)
      p = c(p,tes$p.value)
    }
    cor = cor[-1]
    p = p[-1]
    
    cols= colnames(tws_subs)
    ret = data.frame(
      spec = mode,
      env = cols,
      r = cor,
      p = p
    )
    return(ret)
  }
  
  ret1 = cor_analze_xj_window(twsxj[,1],tws_subs,
                              mode = 'TWS_North_XJ')
  ret2 = cor_analze_xj_window(twsxj[,2],tws_subs,
                              mode = 'TWS_South_XJ')
  corp1 = ret1
  corp2 = ret2
  corp = rbind(corp1,corp2)
  
  sigs = rep('*',nrow(corp))
  id = which(corp$p >0.05)
  sigs[id] = ''
  
  ret1$y = 0.6
  ret2$y = 0.4
  
  
  
  cordf = rbind(ret1,ret2)
  cordf$x = as.Date('2009-01-01')
  
  cordf$label = paste0("R: ",
                       round(cordf$r,2),' ',sigs)
  
  cordf$type = cordf$env
  cordf$variable = cordf$spec
  
  pcovar = ggplot()+
    geom_line(data = dfsubs,
              aes(x = date,y= value,
                  color = variable,
                  linetype = variable),
              size = 1)+
    geom_line(data = dfxj,
              aes(x = date,y= value,
                  color = variable,
                  linetype = variable),
              size = 1)+
    geom_text(data = cordf,
              aes(x=x,y = y,label = label,
                  color = variable),
              size = 4,hjust = 0)+
    scale_color_manual(values = cols)+
    facet_wrap(~type,nrow = 3)+
    theme_bw()
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  pcovar = pcovar+text_theme_set
  
  
  subsdf = data.frame(
    x = as.Date('2005-01-01'),
    y = -0.45,
    label = paste0('(',letters[2:11],')'),
    type = paste0('HSR',1:10)
  )
  
  pcovar = pcovar+
    geom_text(data = subsdf,
              aes(x=x,y = y,label = label),
              color = 'black',
              size = 4,hjust = 0)
  
  return(pcovar)
  
  
  
  
  
  
  
}
figs_generate_sub_windows <- function(
  
  ){
    source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
    library(ggsci)
    library(RColorBrewer)
    library(ggrepel)
    library(ggpubr)
    library(gridExtra)
    library(cowplot)
    library(data.table)
    library(raster)
    # maps of subwindows 
    # cor analysis 
    input = paste0('sub_windows/sub_window',1:19,'.shp')
    shp = lapply(input,shapefile)
    
    world = shp_management('world')
    world = crop(world,extent(-180,180,0,90))
    
    pe_in_source = import_pe_in_source('era5_pr_sum',
                                       name = 'era5_pr_sum.csv')
    pe_in_source = pe_in_source[1:174,]
    pe_in_source = pe_in_source * 30.5
    
    pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
    pet_sum = pet_sum[1:174,]
    pe_minus_eva = pe_in_source - pet_sum
    colnames(pe_minus_eva) = paste0('pme',1:12)
    pmedf = pe_minus_eva[,5:8]
    
    trend_fun<-function(x){
      xs = ts(x,start = c(2003,1),frequency = 12)
      xt = decompose(xs)$trend
      naid = which(is.na(xt))
      xt = xt[-naid]
      
      stand_fun <- function(xt){
        xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                        min(xt,na.rm = T))
        return(xm)
      }
      xm = stand_fun(xt)
      return(xm)
    }
    
    pmedf = apply(pmedf,2,trend_fun)
    
    
    input_tws_subwindow = 'analysis_output/tws_subwindow_2003_2017.csv'
    tws_subs = read.csv(input_tws_subwindow,header = T)
    tws_subs = tws_subs[,-1]
    
    colnames(tws_subs) = paste0('subwindow',1:ncol(tws_subs))
    naid = which(is.na(tws_subs[,1]))
    tws_subs = tws_subs[-naid,]
    
    cor1 = 1
    cor2 = 1
    cor3 = 1
    cor4 = 1
    lag1 = 1
    lag2 = 1
    lag3 = 1
    lag4 = 1
    for(i in 1:ncol(tws_subs)){
      #tmpcor1 = cor(pmedf[,1],tws_subs[,i])
      #tmpcor2 = cor(pmedf[,2],tws_subs[,i])
      #tmpcor3 = cor(pmedf[,3],tws_subs[,i])
      #tmpcor4 = cor(pmedf[,4],tws_subs[,i])
      
      tmpcor1 = ccf(pmedf[,1],tws_subs[,i])
      tmpcor2 = ccf(pmedf[,2],tws_subs[,i])
      tmpcor3 = ccf(pmedf[,3],tws_subs[,i])
      tmpcor4 = ccf(pmedf[,4],tws_subs[,i])
      
      tmplag1 = tmpcor1$lag
      tmplag2 = tmpcor2$lag
      tmplag3 = tmpcor3$lag
      tmplag4 = tmpcor4$lag
      
      maxcor1 = max(tmpcor1$acf)
      maxcor2 = max(tmpcor2$acf)
      maxcor3 = max(tmpcor3$acf)
      maxcor4 = max(tmpcor4$acf)
      
      id1 = which.max(tmpcor1$acf)
      id2 = which.max(tmpcor2$acf)
      id3 = which.max(tmpcor3$acf)
      id4 = which.max(tmpcor4$acf)
      
      
      tmplag1 = tmplag1[id1]
      tmplag2 = tmplag2[id2]
      tmplag3 = tmplag3[id3]
      tmplag4 = tmplag4[id4]
      
      if(maxcor3>0.4){
        print(i)
      }
      cor1 = c(cor1,maxcor1)
      cor2 = c(cor2,maxcor2)
      cor3 = c(cor3,maxcor3)
      cor4 = c(cor4,maxcor4)
      
      
      lag1 = c(lag1,tmplag1)
      lag2 = c(lag2,tmplag2)
      lag3 = c(lag3,tmplag3)
      lag4 = c(lag4,tmplag4)
      
    }
    cor1 = cor1[-1]
    cor2 = cor2[-1]
    cor3 = cor3[-1]
    cor4 = cor4[-1]
    lag1 = lag1[-1]
    lag2 = lag2[-1]
    lag3 = lag3[-1]
    lag4 = lag4[-1]
    
    id_box = c(4,7,8,9,10,11,13,14,17,19)
    shphigh = do.call(bind,shp[id_box])
    shplow = do.call(bind,shp[-id_box])
    
    
    atoshp = list.files('cluster_shp/ato',
                        full.names = T,
                        pattern = '*.shp$')[1:4]
    atoshp = lapply(atoshp,shapefile)
    cal_center_point <- function(x){
      xm = extent(x)
      latm = round((xm[3]+xm[4])/2)
      longm = round((xm[1]+xm[2])/2)
      rm = data.frame(x = longm,y = latm)
      return(rm)
    }
    
    dfhigh_label = lapply(shp[id_box],cal_center_point)
    dflow_label = lapply(shp[-id_box],cal_center_point)
    dfato_label = lapply(atoshp,cal_center_point)
    
    
    dfhigh_label = do.call(rbind,dfhigh_label)
    dflow_label = do.call(rbind,dflow_label)
    dfato_label = do.call(rbind,dfato_label)
    
    dfhigh_label$label = paste0('HSR','\n',1:10)
    dflow_label$label = paste0('LSR','\n',1:9)
    dfato_label$label = paste0('ATO',1:4)
    
    dfato_label$y[4] = dfato_label$y[4]+15
    dflabel = rbind(dfhigh_label,
                    dflow_label,
                    dfato_label)
    
    
    
    
    pals = pal_lancet(alpha = 0.8)(9)
    
    atoshp =do.call(bind,atoshp)
    trajs = fread('analysis_output/fig2/cluster_traj_df.csv')
    trajs = as.data.frame(trajs)
    route_col = pal_npg()(10)[4]
    route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
    
    
    
    psubs = ggplot()+
      geom_polygon(data = world,aes(x = long,y= lat,
                                    group= group),
                   size = 0.5,
                   color = 'black',
                   fill = 'grey80',
                   alpha= 0.8)+
      geom_path(data = trajs,aes(x = long,y = lat,
                                 group = routeid,
                                 color = factor(routeid,
                                                levels = 1:20)),
                size = 1,
                #color = route_col,
                arrow=arrow(angle=30,length=unit(0.11,"inches"),
                            type="open"))+   
      scale_color_manual(values = route_col)+
      geom_polygon(data = atoshp,aes(x = long,y= lat,
                                    group= group),
                   size = 0.5,
                   color = 'black',
                   fill = 'white',
                   alpha= 0.5)+
      geom_polygon(data = shplow,aes(x = long,y= lat,
                                    group= group),
                   size = 0.5,
                   color = pals[4],
                   fill = pals[4],
                   alpha = 0.3)+
      geom_polygon(data = shphigh,aes(x = long,y = lat,
                                      group = group),
                   size = 0.5,
                   color = pals[7],
                   fill = pals[7],
                   alpha = 0.3)+
      geom_text_repel(data = dflabel,
                aes(x = x,y = y,label = label),
                size = 3.5,
                color = 'black',
                bg.color = 'white',
                bg.r =0.25,
                force = F)+
      theme_bw()
    
    dfcor = rbind(cor1,cor2,cor3,cor4)
    dfcorh = dfcor[,id_box]
    dfcorl = dfcor[,-id_box]
    
    colnames(dfcorh) = paste0('HSR',1:ncol(dfcorh))
    colnames(dfcorl) = paste0('LSR',1:ncol(dfcorl))
    
    dfcorh = data.frame(
      ATO = paste0('ATO',1:4),
      dfcorh
    )
    
    dfcorh = reshape2::melt(dfcorh,'ATO')
    
    
    dfcorl = data.frame(
      ATO = paste0('ATO',1:4),
      dfcorl
    )
    
    dfcorl = reshape2::melt(dfcorl,'ATO')
    
    dfcorh$type = 1
    dfcorl$type = 2
  
    dfcor = rbind(dfcorh,dfcorl)
    
    dfcor$cuts = cut(dfcor$value,
                     breaks = seq(-0.3,0.9,0.1))
    
    fil = colorRampPalette(brewer.pal(10,'Spectral'))(12)
    fil = rev(fil)
    library(ggrepel)
    ptile = ggplot()+
      geom_tile(data = dfcor,
                aes(y = ATO,x = variable,
                    fill = cuts))+
      geom_text_repel(data = dfcor,
                aes(x = variable,
                    y = ATO,
                    label = round(value,1)),
                size = 4,
                color = 'black',
                bg.color = 'white',
                bg.r= 0.25,
                force = F)+
      scale_fill_manual(values = fil)+
      scale_x_discrete(breaks = c(paste0('HSR',seq(1,10,2)),
                                  paste0('LSR',seq(1,9,2))))+
      facet_wrap(~type,nrow = 1,scales = 'free_x')+
      theme_bw()
    
    
    dflags = rbind(lag1,lag2,lag3,lag4)
    dflagsh = dflags[,id_box]
    dflagsh = cbind(dflagsh,rep(NA,4),rep(NA,4))
    dflagsl = dflags[,-id_box]
    
    colnames(dflagsh) = paste0('HSR',1:ncol(dflagsh))
    colnames(dflagsl) = paste0('LSR',1:ncol(dflagsl))
    
    
    dflags = cbind(dflagsh,dflagsl)
    #dflags = dflagsh
    dflags = data.frame(
      ATO = 1:4,
      dflags
    )
    dflags = reshape2::melt(dflags,'ATO')
    
    
    col = pal_npg(alpha = 0.8)(10)
    col = colorRampPalette(col)(19)
    
    g1h = c(max(dflagsh[1,],na.rm = T),min(dflagsh[1,],na.rm = T))
    g1l = c(max(dflagsl[1,]),min(dflagsl[1,]))
    g2h = c(max(dflagsh[2,],na.rm = T),min(dflagsh[2,],na.rm = T))
    g2l = c(max(dflagsl[2,]),min(dflagsl[2,]))
    g3h = c(max(dflagsh[3,],na.rm = T),min(dflagsh[3,],na.rm = T))
    g3l = c(max(dflagsl[3,]),min(dflagsl[3,]))
    g4h = c(max(dflagsh[4,],na.rm = T),min(dflagsh[4,],na.rm = T))
    g4l = c(max(dflagsl[4,]),min(dflagsl[4,]))
    
    g1 = rbind(g1h,g2h,g3h,g4h)
    g2 = rbind(g1l,g2l,g3l,g4l)
    
    colnames(g1) =c('max','min')
    colnames(g2) = c('max','min')
    
    lagtextdf = data.frame(
      x = rep('HSR6',4),
      y = 24,
      label = paste0('Lags scale: ',g1[,2],'~',g1[,1]),
      ATO = c(1,2,3,4)
    )
    
    lagtextdf2 = data.frame(
      x = rep('LSR5',4),
      y = 24,
      label = paste0('Lags scale: ',g2[,2],'~',g2[,1]),
      ATO = c(1,2,3,4)
    )
    
    lagtextdf = rbind(lagtextdf,lagtextdf2)
    
    
    
    dfseg = data.frame(
      x = rep(c('HSR1','HSR10','LSR1','LSR9'),4),
      xend = rep(c('HSR10','HSR1','LSR9','LSR1'),4),
      y = 22,
      yend = 22,
      ATO = rep(1:4,each = 4)
    )
    
    dfseg2 = data.frame(
      x = rep(c("HSR1",'HSR10','LSR1','LSR9'),4),
      y = 20,
      yend = 24,
      ATO = rep(1:4,each = 4)
    )
    
    plag = ggplot()+
      geom_bar(data = dflags,
               aes(x = variable,y = value,
                   fill = variable),
               stat = 'identity',
               width = 0.8,
               alpha = 0.8,
               color = 'white')+
      scale_fill_manual(values = col)+
      scale_x_discrete(breaks = c(paste0('HSR',c(1,10)),
                                  paste0('LSR',c(1,9))),
                       labels = c(paste0('HSR',c(1)),10,
                                  paste0('LSR',c(1)),9))+
      geom_text(data = lagtextdf,
                aes(x = x,y = y,label = label),
                size = 3.5,
                color = 'black')+
      geom_segment(data = dfseg,
                   aes(x = x,xend = xend,y=y,
                       yend =yend),size = 0.5,color = 'black',
                   arrow = arrow(angle = 30,unit(0.1,'cm'),
                                 type = 'closed'))+
      geom_segment(data = dfseg2,
                   aes(x = x,xend = x,y = y,
                       yend = yend),
                   size = 0.5,
                   color = 'black')+
      facet_wrap(~ATO,nrow = 4)+
      theme_bw()
    
    
    fontsize = 12
    ##########
    text_theme_set = theme(
      axis.text = element_text(
        color = 'black',
        size = fontsize),
      axis.title = element_text(face = 'bold',
                                color = 'black',
                                size = fontsize),
      legend.text = element_text(
        color = 'black',
        size = fontsize),
      legend.title = element_text(
        color = 'black',
        size = fontsize),
      legend.position = 'none',
      strip.text = element_text(
        color = 'black',
        size = fontsize)
    )
    ##########
    psubs = psubs+text_theme_set+
      xlab('Longitude')+
      ylab('Latitude')+
      theme(
        axis.text.y = element_text(angle = 90,hjust = 0.5)
      )
    
    ptile = ptile+text_theme_set+
      theme(strip.text = element_blank(),
            legend.position = 'none',
            axis.title.x = element_blank(),
            axis.text.y = element_text(angle = 90,hjust = 0.5))+
      ylab('Cross correlation')
    
    plag = plag+text_theme_set+
      xlab('SWs')+
      theme(axis.title.y = element_blank(),
            strip.text = element_blank())
    
    p12 = plot_grid(ptile,
                    psubs,
                    ncol = 1,
                    rel_widths = c(1,1),
                    rel_heights = c(1,1),
                    axis = 'v',
                    align = 'lr'
                    )
    
    p123 = plot_grid(
      p12,plag,
      nrow = 1,
      rel_widths = c(3,1.5),
      rel_heights = c(1,1)
    )
    
    
    p1leg = ptile+theme(
      legend.position = 'bottom'
    )+guides(fill = guide_legend(
      title = 'Cross correlation',
      title.position = 'top',
      nrow = 4
    ))
    
    p1leg = as_ggplot(get_legend(p1leg))
    p1leg = p1leg+theme(plot.margin = unit(rep(0,4),'cm'))
    
    p2leg = plag+theme(
      legend.position = 'bottom'
    )+guides(fill = guide_legend(
      title = 'Max cross correlation lags',
      title.position = 'top',
      nrow = 4
    ))
    
    p2leg = as_ggplot(get_legend(p2leg))
    p2leg = p2leg+theme(plot.margin = unit(rep(0,4),'cm'))
    
    p12leg= plot_grid(
      p1leg,p2leg,
      nrow = 1,
      rel_widths = c(1,1),
      rel_heights = c(1,1)
    )
    
    p123_withleg = plot_grid(
      p123,p12leg,
      ncol = 1,
      rel_heights = c(10,2),
      scale = c(1,0.8)
    )
    
    dir.create('main_plot/SI/generate_sub_windows')
    output = 'main_plot/SI/generate_sub_windows/figs2.png'
    png(output,
        height = 26,
        width = 27,
        units = 'cm',
        res = 800)
    print(p123_withleg)
    dev.off()
    
    
}






figs_generate_sub_windows2 <- function(
  
){
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(ggsci)
  library(RColorBrewer)
  library(ggrepel)
  library(ggpubr)
  library(gridExtra)
  library(cowplot)
  library(data.table)
  library(raster)
  # maps of subwindows 
  # cor analysis 
  input = paste0('sub_windows/sub_window',1:19,'.shp')
  shp = lapply(input,shapefile)
  
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pe_in_source = pe_in_source * 30.5
  
  pet_sum = import_pe_in_source('era5_pet_sum',
                                'era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  pe_minus_eva = pe_in_source - pet_sum
  colnames(pe_minus_eva) = paste0('pme',1:12)
  pmedf = pe_minus_eva[,5:8]
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  pmedf = apply(pmedf,2,trend_fun)
  
  
  input_tws_subwindow = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws_subs = read.csv(input_tws_subwindow,header = T)
  tws_subs = tws_subs[,-1]
  
  colnames(tws_subs) = paste0('subwindow',1:ncol(tws_subs))
  naid = which(is.na(tws_subs[,1]))
  tws_subs = tws_subs[-naid,]
  
  cor1 = 1
  cor2 = 1
  cor3 = 1
  cor4 = 1
  p1 = 1
  p2 = 1
  p3 = 1
  p4 = 1
  
  lag1 = 1
  lag2 = 1
  lag3 = 1
  lag4 = 1
  for(i in 1:ncol(tws_subs)){
    #tmpcor1 = cor(pmedf[,1],tws_subs[,i])
    #tmpcor2 = cor(pmedf[,2],tws_subs[,i])
    #tmpcor3 = cor(pmedf[,3],tws_subs[,i])
    #tmpcor4 = cor(pmedf[,4],tws_subs[,i])
    
    tmpp1 = cor.test(pmedf[,1],tws_subs[,i])$p.value
    tmpp2 = cor.test(pmedf[,2],tws_subs[,i])$p.value
    tmpp3 = cor.test(pmedf[,3],tws_subs[,i])$p.value
    tmpp4 = cor.test(pmedf[,4],tws_subs[,i])$p.value
    
    tmpcor1 = ccf(pmedf[,1],tws_subs[,i])
    tmpcor2 = ccf(pmedf[,2],tws_subs[,i])
    tmpcor3 = ccf(pmedf[,3],tws_subs[,i])
    tmpcor4 = ccf(pmedf[,4],tws_subs[,i])
    
    tmplag1 = tmpcor1$lag
    tmplag2 = tmpcor2$lag
    tmplag3 = tmpcor3$lag
    tmplag4 = tmpcor4$lag
    
    maxcor1 = max(tmpcor1$acf)
    maxcor2 = max(tmpcor2$acf)
    maxcor3 = max(tmpcor3$acf)
    maxcor4 = max(tmpcor4$acf)
    
    id1 = which.max(tmpcor1$acf)
    id2 = which.max(tmpcor2$acf)
    id3 = which.max(tmpcor3$acf)
    id4 = which.max(tmpcor4$acf)
    
    
    tmplag1 = tmplag1[id1]
    tmplag2 = tmplag2[id2]
    tmplag3 = tmplag3[id3]
    tmplag4 = tmplag4[id4]
    
    if(maxcor3>0.4){
      print(i)
    }
    
    p1 = c(p1,tmpp1)
    p2 = c(p2,tmpp2)
    p3 = c(p3,tmpp3)
    p4 = c(p4,tmpp4)
    
    cor1 = c(cor1,maxcor1)
    cor2 = c(cor2,maxcor2)
    cor3 = c(cor3,maxcor3)
    cor4 = c(cor4,maxcor4)
    
    
    lag1 = c(lag1,tmplag1)
    lag2 = c(lag2,tmplag2)
    lag3 = c(lag3,tmplag3)
    lag4 = c(lag4,tmplag4)
    
  }
  cor1 = cor1[-1]
  cor2 = cor2[-1]
  cor3 = cor3[-1]
  cor4 = cor4[-1]
  lag1 = lag1[-1]
  lag2 = lag2[-1]
  lag3 = lag3[-1]
  lag4 = lag4[-1]
  p1 = p1[-1]
  p2 = p2[-1]
  p3 = p3[-1]
  p4 = p4[-1]
  
  
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  shphigh = do.call(bind,shp[id_box])
  shplow = do.call(bind,shp[-id_box])
  
  
  atoshp = list.files('cluster_shp/ato',
                      full.names = T,
                      pattern = '*.shp$')[1:4]
  atoshp = lapply(atoshp,shapefile)
  cal_center_point <- function(x){
    xm = extent(x)
    latm = round((xm[3]+xm[4])/2)
    longm = round((xm[1]+xm[2])/2)
    rm = data.frame(x = longm,y = latm)
    return(rm)
  }
  
  dfhigh_label = lapply(shp[id_box],cal_center_point)
  dflow_label = lapply(shp[-id_box],cal_center_point)
  dfato_label = lapply(atoshp,cal_center_point)
  
  
  dfhigh_label = do.call(rbind,dfhigh_label)
  dflow_label = do.call(rbind,dflow_label)
  dfato_label = do.call(rbind,dfato_label)
  
  dfhigh_label$label = paste0('HSR','\n',1:10)
  dflow_label$label = paste0('LSR','\n',1:9)
  dfato_label$label = paste0('ATO',1:4)
  
  dfato_label$y[4] = dfato_label$y[4]+15
  dflabel = rbind(dfhigh_label,
                  dflow_label,
                  dfato_label)
  
  
  
  
  pals = pal_lancet(alpha = 0.8)(9)
  
  atoshp =do.call(bind,atoshp)
  trajs = fread('analysis_output/fig2/cluster_traj_df.csv')
  trajs = as.data.frame(trajs)
  route_col = pal_npg()(10)[4]
  route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
  
  
  
  psubs = ggplot()+
    geom_polygon(data = world,aes(x = long,y= lat,
                                  group= group),
                 size = 0.5,
                 color = 'black',
                 fill = 'grey80',
                 alpha= 0.8)+
    geom_path(data = trajs,aes(x = long,y = lat,
                               group = routeid,
                               color = factor(routeid,
                                              levels = 1:20)),
              size = 1,
              #color = route_col,
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="open"))+   
    scale_color_manual(values = route_col)+
    geom_polygon(data = atoshp,aes(x = long,y= lat,
                                   group= group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha= 0.5)+
    geom_polygon(data = shplow,aes(x = long,y= lat,
                                   group= group),
                 size = 0.5,
                 color = pals[4],
                 fill = pals[4],
                 alpha = 0.3)+
    geom_polygon(data = shphigh,aes(x = long,y = lat,
                                    group = group),
                 size = 0.5,
                 color = pals[7],
                 fill = pals[7],
                 alpha = 0.3)+
    geom_text_repel(data = dflabel,
                    aes(x = x,y = y,label = label),
                    size = 3.5,
                    color = 'black',
                    bg.color = 'white',
                    bg.r =0.25,
                    force = F)+
    theme_bw()
  
  dfcor = rbind(cor1,cor2,cor3,cor4)
  dfp = rbind(p1,p2,p3,p4)
  dfcorh = dfcor[,id_box]
  dfcorl = dfcor[,-id_box]
  dfph = dfp[,id_box]
  dfpl = dfp[,-id_box]
  
  
  colnames(dfcorh) = paste0('HSR',1:ncol(dfcorh))
  colnames(dfcorl) = paste0('LSR',1:ncol(dfcorl))
  colnames(dfph) = paste0('HSR',1:ncol(dfph))
  colnames(dfpl) = paste0('LSR',1:ncol(dfpl))
  
  dfcorh = data.frame(
    ATO = paste0('ATO',1:4),
    dfcorh
  )
  dfcorh = reshape2::melt(dfcorh,'ATO')
  
  dfcorl = data.frame(
    ATO = paste0('ATO',1:4),
    dfcorl
  )
  
  dfcorl = reshape2::melt(dfcorl,'ATO')
  
  dfph = data.frame(
    ATO = paste0("ATO",1:4),
    dfph
  )
  dfph = reshape2::melt(dfph,'ATO')
  
  dfpl = data.frame(
    ATO = paste0("ATO",1:4),
    dfpl
  )
  dfpl = reshape2::melt(dfpl,'ATO')
  
  dfcorh$type = 1
  dfcorl$type = 2
  dfph$type = 1
  dfpl$type = 1
  
  
  dfcor = rbind(dfcorh,dfcorl)
  dfp = rbind(dfph,dfpl)
  
  sig_mark = rep("*",nrow(dfp))
  nosig = which(dfp$value > 0.05)
  sig_mark[nosig] = ''
    
  dfcor$label = paste0(
    round(dfcor$value,1),'\n',sig_mark)
  dfcor$cuts = cut(dfcor$value,
                   breaks = seq(-0.3,0.9,0.1))
  
  fil = colorRampPalette(brewer.pal(10,'Spectral'))(12)
  fil = rev(fil)
  library(ggrepel)
  ptile = ggplot()+
    geom_tile(data = dfcor,
              aes(y = ATO,x = variable,
                  fill = cuts))+
    geom_text_repel(data = dfcor,
                    aes(x = variable,
                        y = ATO,
                        label = label),
                    size = 4,
                    color = 'black',
                    bg.color = 'white',
                    bg.r= 0.25,
                    force = F)+
    scale_fill_manual(values = fil)+
    scale_x_discrete(breaks = c(paste0('HSR',seq(1,10,2)),
                                paste0('LSR',seq(1,9,2))))+
    facet_wrap(~type,nrow = 1,scales = 'free_x')+
    theme_bw()
  
  
  dflags = rbind(lag1,lag2,lag3,lag4)
  dflagsh = dflags[,id_box]
  dflagsh = cbind(dflagsh,rep(NA,4),rep(NA,4))
  dflagsl = dflags[,-id_box]
  
  colnames(dflagsh) = paste0('HSR',1:ncol(dflagsh))
  colnames(dflagsl) = paste0('LSR',1:ncol(dflagsl))
  
  
  dflags = cbind(dflagsh,dflagsl)
  #dflags = dflagsh
  dflags = data.frame(
    ATO = 1:4,
    dflags
  )
  dflags = reshape2::melt(dflags,'ATO')
  
  
  col = pal_npg(alpha = 0.8)(10)
  col = colorRampPalette(col)(19)
  
  g1h = c(max(dflagsh[1,],na.rm = T),min(dflagsh[1,],na.rm = T))
  g1l = c(max(dflagsl[1,]),min(dflagsl[1,]))
  g2h = c(max(dflagsh[2,],na.rm = T),min(dflagsh[2,],na.rm = T))
  g2l = c(max(dflagsl[2,]),min(dflagsl[2,]))
  g3h = c(max(dflagsh[3,],na.rm = T),min(dflagsh[3,],na.rm = T))
  g3l = c(max(dflagsl[3,]),min(dflagsl[3,]))
  g4h = c(max(dflagsh[4,],na.rm = T),min(dflagsh[4,],na.rm = T))
  g4l = c(max(dflagsl[4,]),min(dflagsl[4,]))
  
  g1 = rbind(g1h,g2h,g3h,g4h)
  g2 = rbind(g1l,g2l,g3l,g4l)
  
  colnames(g1) =c('max','min')
  colnames(g2) = c('max','min')
  
  lagtextdf = data.frame(
    x = rep('HSR6',4),
    y = 24,
    label = paste0('Lags scale: ',g1[,2],'~',g1[,1]),
    ATO = c(1,2,3,4)
  )
  
  lagtextdf2 = data.frame(
    x = rep('LSR5',4),
    y = 24,
    label = paste0('Lags scale: ',g2[,2],'~',g2[,1]),
    ATO = c(1,2,3,4)
  )
  
  lagtextdf = rbind(lagtextdf,lagtextdf2)
  
  
  
  dfseg = data.frame(
    x = rep(c('HSR1','HSR10','LSR1','LSR9'),4),
    xend = rep(c('HSR10','HSR1','LSR9','LSR1'),4),
    y = 22,
    yend = 22,
    ATO = rep(1:4,each = 4)
  )
  
  dfseg2 = data.frame(
    x = rep(c("HSR1",'HSR10','LSR1','LSR9'),4),
    y = 20,
    yend = 24,
    ATO = rep(1:4,each = 4)
  )
  
  plag = ggplot()+
    geom_bar(data = dflags,
             aes(x = variable,y = value,
                 fill = variable),
             stat = 'identity',
             width = 0.8,
             alpha = 0.8,
             color = 'white')+
    scale_fill_manual(values = col)+
    scale_x_discrete(breaks = c(paste0('HSR',c(1,10)),
                                paste0('LSR',c(1,9))),
                     labels = c(paste0('HSR',c(1)),10,
                                paste0('LSR',c(1)),9))+
    geom_text(data = lagtextdf,
              aes(x = x,y = y,label = label),
              size = 3.5,
              color = 'black')+
    geom_segment(data = dfseg,
                 aes(x = x,xend = xend,y=y,
                     yend =yend),size = 0.5,color = 'black',
                 arrow = arrow(angle = 30,unit(0.1,'cm'),
                               type = 'closed'))+
    geom_segment(data = dfseg2,
                 aes(x = x,xend = x,y = y,
                     yend = yend),
                 size = 0.5,
                 color = 'black')+
    facet_wrap(~ATO,nrow = 4)+
    theme_bw()
  
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  psubs = psubs+text_theme_set+
    xlab('Longitude')+
    ylab('Latitude')+
    theme(
      axis.text.y = element_text(angle = 90,hjust = 0.5)
    )
  
  ptile = ptile+text_theme_set+
    theme(strip.text = element_blank(),
          legend.position = 'none',
          axis.title.x = element_blank(),
          axis.text.y = element_text(angle = 90,hjust = 0.5))+
    ylab('Cross correlation')
  
  plag = plag+text_theme_set+
    xlab('SWs')+
    theme(axis.title.y = element_blank(),
          strip.text = element_blank())
  
  p12 = plot_grid(ptile,
                  psubs,
                  ncol = 1,
                  rel_widths = c(1,1),
                  rel_heights = c(1,1),
                  axis = 'v',
                  align = 'lr'
  )
  
  p123 = plot_grid(
    p12,plag,
    nrow = 1,
    rel_widths = c(3,1.5),
    rel_heights = c(1,1)
  )
  
  
  p1leg = ptile+theme(
    legend.position = 'bottom'
  )+guides(fill = guide_legend(
    title = 'Cross correlation',
    title.position = 'top',
    nrow = 4
  ))
  
  p1leg = as_ggplot(get_legend(p1leg))
  p1leg = p1leg+theme(plot.margin = unit(rep(0,4),'cm'))
  
  p2leg = plag+theme(
    legend.position = 'bottom'
  )+guides(fill = guide_legend(
    title = 'Max cross correlation lags',
    title.position = 'top',
    nrow = 4
  ))
  
  p2leg = as_ggplot(get_legend(p2leg))
  p2leg = p2leg+theme(plot.margin = unit(rep(0,4),'cm'))
  
  p12leg= plot_grid(
    p1leg,p2leg,
    nrow = 1,
    rel_widths = c(1,1),
    rel_heights = c(1,1)
  )
  
  p123_withleg = plot_grid(
    p123,p12leg,
    ncol = 1,
    rel_heights = c(10,2),
    scale = c(1,0.8)
  )
  
  dir.create('main_plot/SI/generate_sub_windows')
  output = 'main_plot/SI/generate_sub_windows/figs3.png'
  png(output,
      height = 26,
      width = 27,
      units = 'cm',
      res = 800)
  print(p123_withleg)
  dev.off()
  
  
}






figs_sst_mmk <- function(
  
  ){
    input = 'analysis_output/fig2/sst_mmk.csv'
    
    sstmmk = as.data.frame(fread(input))
    
    sstdf = reshape2::melt(sstmmk,
                           c('long','lat'))
    
    sstdf$cuts = cut(sstdf$value,
                     breaks = c(-20,seq(-6,8,2)))
    
    
    sstdf$type = 1
    
    pme_ocean = raster('analysis_output/fig2/pme_ato_mmk.nc')
    pme_oceandf = as.data.frame(pme_ocean,xy = T)
    dfnaid = which(is.na(pme_oceandf[,3]))
    pme_oceandf = pme_oceandf[-dfnaid,]
    negid = which(pme_oceandf[,3]<0)
    pme_oceandf = pme_oceandf[negid,]
    
    colnames(pme_oceandf) = c('long','lat','value')
    pme_oceandf$cuts = cut(pme_oceandf$value,
                           breaks = c(-42,seq(-10,0,2)))
    sea_pme_mmk_pal = colorRampPalette(
      brewer.pal(9,'YlOrRd')
    )(25)
    #sea_pme_mmk_pal = sea_pme_mmk_pal[1:]
    sea_pme_mmk_pal = rev(sea_pme_mmk_pal)
    sea_pme_mmk_pal = sea_pme_mmk_pal[seq(1,25,2)[c(2,7:11)]]
    
    pme_oceandf$type = 2
    
    ex = c(min(sstdf$long)-5,max(sstdf$long)+5,
           0,max(sstdf$lat)+5)
    ex = extent(ex)
    
    world = shp_management('world')
    world = crop(world,ex)
    
    atos = list.files('cluster_shp/ato',
                      full.names = T,
                      pattern = '*.shp$')[1:4]
    atos = do.call(bind,lapply(atos,shapefile))
    
    atoshp = list.files('cluster_shp/ato',
                        full.names = T,
                        pattern = '*.shp$')[1:4]
    atoshp = lapply(atoshp,shapefile)
    cal_center_point <- function(x){
      xm = extent(x)
      latm = round((xm[3]+xm[4])/2)
      longm = round((xm[1]+xm[2])/2)
      rm = data.frame(x = longm,y = latm)
      return(rm)
    }
    dfato_label = lapply(atoshp,cal_center_point)
    dfato_label = do.call(rbind,dfato_label)
    dfato_label$label = paste0('ATO',1:4)
    
    cur_df = as.data.frame(
      fread('analysis_output/fig4/current_df.csv')
    )
    
    idless50 = which(cur_df$lat <= 50)
    cur_df = cur_df[idless50,]
    
    idbig1 = which(cur_df$u>0 &
                     cur_df$v >0)
    idbig2 = which(cur_df$u<0 &
                     cur_df$v >0)
    
    cur_df1 = cur_df[idbig1,]
    cur_df2 = cur_df[idbig2,]
    
    cid1 = seq(1,nrow(cur_df1),30)
    cid2 = seq(1,nrow(cur_df2),200)
    
    cur_df1 = cur_df1[cid1,]
    cur_df2 = cur_df2[cid2,]
    
    
    cols_cur = c('#2988AE','#30376E')
    
    psstmmk = ggplot()+
      geom_polygon(data = world,
                   aes(x = long,y = lat,group =group),
                   fill = 'grey80',
                   alpha = 0.5,
                   color = 'black',
                   size = 0.5)+
      geom_tile(data = sstdf,
                aes(x = long,y = lat,
                    fill = cuts))+
      scale_fill_brewer(palette = 'Spectral',
                        guide = guide_legend(
                          title = 'SST_MMK_Trend',
                          title.position = 'top',
                          nrow = 3
                        ),direction = -1)+
      new_scale_fill()+
      geom_tile(data = pme_oceandf,
                aes(x = long,y = lat,
                    fill = cuts))+
      scale_fill_manual(values = sea_pme_mmk_pal,
                        guide = guide_legend(
                          title = 'PME_MMK_Trend',
                          title.position = 'top',
                          nrow = 3
                        ))+
      geom_polygon(data = atos,
                   aes(x = long,y = lat,group =group),
                   fill = 'transparent',
                   #alpha = 0.5,
                   color = 'black',
                   size = 0.5)+
      geom_segment(data = cur_df1,
                   aes(x = long,y = lat,
                       xend = long+u,
                       yend = lat+v),
                   arrow = arrow(angle = 20,unit(0.15,'cm'),
                                 type = 'open'),
                   color = cols_cur[1])+
      geom_segment(data = cur_df2,
                   aes(x = long,y = lat,
                       xend = long+u,
                       yend = lat+v),
                   arrow = arrow(angle = 20,unit(0.2,'cm'),
                                 type = 'open'),
                   color = cols_cur[2])+
      geom_text_repel(data = dfato_label,
                      aes(x = x,y = y,label = label),
                      size = 3.5,
                      color = 'black',
                      bg.color = 'white',
                      bg.r =0.25,
                      force = F)+
      facet_wrap(~type,nrow = 1)+
      theme_bw()
    
    fontsize = 12
    ##########
    text_theme_set = theme(
      axis.text = element_text(
        color = 'black',
        size = fontsize),
      axis.title = element_text(face = 'bold',
                                color = 'black',
                                size = fontsize),
      legend.text = element_text(
        color = 'black',
        size = fontsize),
      legend.title = element_text(
        color = 'black',
        size = fontsize),
      legend.position = 'bottom',
      strip.text = element_text(
        color = 'black',
        size = fontsize)
    )
    ##########
    
    psstmmk = psstmmk + text_theme_set+
      theme(strip.text = element_blank())
    
    dfsubs= data.frame(
      x = c(-130,-130),
      y = c(5,5),
      label = c('(a)','(b)'),
      type = c(1,2)
    )
    
    psstmmk = psstmmk+
      geom_text(data = dfsubs,
                aes(x = x,y = y,label = label),
                size=4,
                color = 'black')
    
    return(psstmmk)
  
  
  
}
figs_variation_analysis_pme_pmexj <-function(
  
){
  library(ggsci)
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pe_in_source = pe_in_source * 30.5
  
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  pe_minus_eva = pe_in_source - pet_sum
  colnames(pe_minus_eva) = paste0('pme',1:12)
  pmedf = pe_minus_eva[,1:11]
  
  
  
  
  tws_in_source = import_pe_in_source('tws_in_source',
                                      name = 'tws_sum.csv')
  colnames(tws_in_source) = paste0('tws',1:12)
  tws_in_source = tws_in_source[,1:11]
  tws_in_source  =as.data.frame(tws_in_source)
  
  input_pr_intarget = list.files('era5_pr_in_target',
                                 full.names = T)[c(1,3)]
  input_eva_intarget = list.files('poten_evap_in_target',
                                  full.names =T)[c(1,3)]
  
  
  
  prtar = lapply(lapply(input_pr_intarget,fread),
                 as.data.frame)
  evatar = lapply(lapply(input_eva_intarget,fread),
                  as.data.frame)
  
  prtar = do.call('cbind',prtar)
  evatar = do.call('cbind',evatar)
  
  #prtar = apply(prtar,1,sum,na.rm =T)
  #evatar = apply(evatar,1,sum,na.rm = T)
  
  pmetar = prtar-evatar
  #pmetar = prtar
  pmetar = pmetar[1:174,]
  
  input_tws = 'tws_in_target/'
  input_tws = list.files(input_tws,
                         full.names = T)[c(1,3)]
  
  twstar = lapply(lapply(input_tws,
                         fread),
                  as.data.frame)
  twstar = do.call('cbind',twstar)
  
  #twstar = apply(twstar,1,sum,na.rm = T)
  
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  pmedf = apply(pmedf,2,trend_fun)
  twsdf = apply(tws_in_source,2,trend_fun)
  #pmetar = trend_fun(pmetar)
  #twstar = trend_fun(twstar)
  north_pme = trend_fun(pmetar[,1])
  north_tws = trend_fun(twstar[,1])
  south_pme = trend_fun(pmetar[,2])
  south_tws = trend_fun(twstar[,2])
  
  #twsdf = twsdf[,-c(1,3,5:8)]
  pmedf = pmedf[,-c(1,3)]
  
  corpme_nor = 1
  corpme_sou = 1
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),
             '1 month')[1:174]
  date = date[-c(1:6,169:174)]
  #date = 1:162+100
  names = c(paste0('AS',1:2),
            paste0('ATO',1:4),
            paste0('EU',1:3))
  colnames(pmedf) = c(paste0('AS',1:2),
                      paste0('ATO',1:4),
                      paste0('EU',1:3))
  
  pmedf = data.frame(date = date,
                     pmedf)

  pmedf1 = reshape2::melt(pmedf,'date')
  pmedf1$type = pmedf1$variable
  pmedf1$type = factor(pmedf1$type,
                       levels = c(paste0(
                         'ATO',1:4
                       ),paste0('EU',1:3),
                       paste0('AS',1:2)))
  pmedf1$variable = 'PME_Source'
  
  pmetar = data.frame(
    date = rep(date,9),
    North_PME = rep(north_pme,9)
  )
  
  pmetar1 = reshape2::melt(pmetar,c('date'))
  
  
  pals = pal_lancet(alpha = 0.8)(9)
  
  pals1 = c('North_PME'=pals[1],
           'PME_Source' = pals[7])
  
  
  pline1 = ggplot()+
    geom_line(data =pmedf1,
               aes(x = date,y =value,
                   color = variable),
               size = 1)+
    geom_line(data = pmetar1,
              aes(x = date, y = value,
                  color = variable),
              size = 1.5)+
    scale_color_manual(values = pals1)+
    facet_wrap(~type,nrow= 3)+
    theme_bw()+
    theme(legend.position = 'bottom')+
    guides(color = guide_legend(title = 'Standardized Indices',
                                title.position = 'left',
                                nrow = 1))+
    xlab("Date")+
    ylab('Standardized Indices')

  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  pline1 = pline1+text_theme_set
  pline1 = pline1+theme(
    legend.position = 'bottom'
  )
  
  subsdf = data.frame(
    x = rep(as.Date('2003-08-01'),9),
    y = 0.7,
    label = paste0('(',letters[1:9],')'),
    type = c(paste0('ATO',1:4),paste0('EU',1:3),
             paste0('AS',1:2))
  )
  
  pline1 = pline1+
    geom_text(data = subsdf,aes(x = x,y = y,label = label),
              size = 4,color ='black',hjust = 0)
  
  output = 'main_plot/SI/variation_analysis_pme_pmexj'
  dir.create(output)
  output1 = paste0(output,'/figs_north2.png')
  
  png(output1,
      width = 26,
      height = 26,
      res = 800,
      units = 'cm')
  print(pline1)
  dev.off()
  
  pmetar2 = data.frame(
    date = date,
    South_PME = south_pme
  )
  
  pmetar2 = reshape2::melt(pmetar2,c('date'))
  
  
  pals = pal_lancet(alpha = 0.8)(9)
  
  pals1 = c('South_PME'=pals[1],
            'PME_Source' = pals[7])
  
  pline2 = ggplot()+
    geom_line(data =pmedf1,
              aes(x = date,y =value,
                  color = variable),
              size = 1)+
    geom_line(data = pmetar2,
              aes(x = date, y = value,
                  color = variable),
              size = 1.5)+
    scale_color_manual(values = pals1)+
    facet_wrap(~type,nrow= 3)+
    theme_bw()+
    theme(legend.position = 'bottom')+
    guides(color = guide_legend(title = 'Standardized Indices',
                                title.position = 'left',
                                nrow = 1))+
    xlab("Date")+
    ylab('Standardized Indices')
  
  pline2 = pline2+text_theme_set
  pline2 = pline2+theme(
    legend.position = 'bottom'
  )
  
  subsdf = data.frame(
    x = rep(as.Date('2003-08-01'),9),
    y = 0.7,
    label = paste0('(',letters[1:9],')'),
    type = c(paste0('ATO',1:4),paste0('EU',1:3),
            paste0('AS',1:2))
  )
  
  
  pline2 = pline2+
    geom_text(data = subsdf,aes(x = x,y = y,label = label),
              size = 4,color ='black',hjust = 0)
  
  output2 = paste0(output,'/figs_south2.png')
  
  png(output2,
      width = 26,
      height = 26,
      res = 800,
      units = 'cm')
  print(pline2)
  dev.off()
  
  
}
figs_variation_analysis_pme_tws_twsxj <-function(
  
){
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pe_in_source = pe_in_source * 30.5
  
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  pe_minus_eva = pe_in_source - pet_sum
  colnames(pe_minus_eva) = paste0('pme',1:12)
  pmedf = pe_minus_eva[,1:11]
  
  tws_in_source = import_pe_in_source('tws_in_source',
                                      name = 'tws_sum.csv')
  colnames(tws_in_source) = paste0('tws',1:12)
  tws_in_source = tws_in_source[,1:11]
  tws_in_source  =as.data.frame(tws_in_source)
  
  input_pr_intarget = list.files('era5_pr_in_target',
                                 full.names = T)[c(1,3)]
  input_eva_intarget = list.files('poten_evap_in_target',
                                  full.names =T)[c(1,3)]
  prtar = lapply(lapply(input_pr_intarget,fread),
                 as.data.frame)
  evatar = lapply(lapply(input_eva_intarget,fread),
                  as.data.frame)
  
  prtar = do.call('cbind',prtar)
  evatar = do.call('cbind',evatar)
  
  #prtar = apply(prtar,1,sum,na.rm =T)
  #evatar = apply(evatar,1,sum,na.rm = T)
  
  pmetar = prtar-evatar
  pmetar = prtar
  pmetar = pmetar[1:174,]
  
  input_tws = 'tws_in_target/'
  input_tws = list.files(input_tws,
                         full.names = T)[c(1,3)]
  
  twstar = lapply(lapply(input_tws,
                         fread),
                  as.data.frame)
  twstar = do.call('cbind',twstar)
  
  #twstar = apply(twstar,1,sum,na.rm = T)
  
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  pmedf = apply(pmedf,2,trend_fun)
  twsdf = apply(tws_in_source,2,trend_fun)
  #pmetar = trend_fun(pmetar)
  #twstar = trend_fun(twstar)
  north_pme = trend_fun(pmetar[,1])
  north_tws = trend_fun(twstar[,1])
  south_pme = trend_fun(pmetar[,2])
  south_tws = trend_fun(twstar[,2])
  
  twsdf = twsdf[,-c(1,3,5:8)]
  pmedf = pmedf[,5:8]
  
  corpme_nor = 1
  corpme_sou = 1
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),
             '1 month')[1:174]
  date = date[-c(1:6,169:174)]
  #date = 1:162+100
  names = c(paste0('AS',1:2),
            paste0('ATO',1:4),
            paste0('EU',1:3))
  
  
  colnames(pmedf) = c(paste0('ATO',1:4))
  colnames(twsdf) = c(paste0('AS',1:2),
                      paste0('EU',1:3))
  pmedf = cbind(pmedf,twsdf)
  
  pmedf = data.frame(date = date,
                     pmedf)
  
  pmedf1 = reshape2::melt(pmedf,'date')
  pmedf1$type = pmedf1$variable
  
  pmedf1$variable = c(rep('PME_ATO',162*4),
                      rep('TWS_Land',162*2),
                      rep('TWS_Land',162*3))
                          
  pmedf1$type = factor(pmedf1$type,
                       levels = c(paste0(
                         'ATO',1:4
                       ),paste0('EU',1:3),
                       paste0('AS',1:2)))
  
  pmetar = data.frame(
    date = rep(date,9),
    North_TWS = rep(north_tws,9)
  )
  
  pmetar1 = reshape2::melt(pmetar,c('date'))
  
  
  pals = pal_lancet(alpha = 0.8)(9)
  
  pals1 = c('PME_ATO' = pals[1],
            'TWS_Land' = pals[6],
            'North_TWS' = pals[7])
  
  
  pline1 = ggplot()+
    geom_line(data =pmedf1,
              aes(x = date,y =value,
                  color = variable),
              size = 1)+
    geom_line(data = pmetar1,
              aes(x = date, y = value,
                  color = variable),
              size = 1.5)+
    scale_color_manual(values = pals1)+
    facet_wrap(~type,nrow= 3)+
    theme_bw()+
    theme(legend.position = 'bottom')+
    guides(color = guide_legend(title = 'Standardized Indices',
                                title.position = 'left',
                                nrow = 1))+
    xlab("Date")+
    ylab('Standardized Indices')
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  pline1 = pline1+text_theme_set
  pline1 = pline1+theme(
    legend.position = 'bottom'
  )
  
  subsdf = data.frame(
    x = rep(as.Date('2003-08-01'),9),
    y = 0.7,
    label = paste0('(',letters[1:9],')'),
    type = c(paste0('ATO',1:4),paste0('EU',1:3),
             paste0('AS',1:2))
  )
  
  
  pline1 = pline1+
    geom_text(data = subsdf,aes(x = x,y = y,label = label),
              size = 4,color ='black',hjust = 0)
  
  output = 'main_plot/SI/variation_analysis_pme_tws_tws'
  dir.create(output)
  output1 = paste0(output,'/figs_north.png')
  
  png(output1,
      width = 26,
      height = 26,
      res = 800,
      units = 'cm')
  print(pline1)
  dev.off()
  
  pmetar2 = data.frame(
    date = rep(date,9),
    South_TWS = rep(south_tws,9)
  )
  
  pmetar2 = reshape2::melt(pmetar2,c('date'))
  
  
  pals = pal_lancet(alpha = 0.8)(9)
  
  pals1 = c('PME_ATO' = pals[1],
            'TWS_Land' = pals[6],
            'South_TWS' = pals[7])
  
  
  pline2 = ggplot()+
    geom_line(data =pmedf1,
              aes(x = date,y =value,
                  color = variable),
              size = 1)+
    geom_line(data = pmetar2,
              aes(x = date, y = value,
                  color = variable),
              size = 1.5)+
    scale_color_manual(values = pals1)+
    facet_wrap(~type,nrow= 3)+
    theme_bw()+
    theme(legend.position = 'bottom')+
    guides(color = guide_legend(title = 'Standardized Indices',
                                title.position = 'left',
                                nrow = 1))+
    xlab("Date")+
    ylab('Standardized Indices')
  
  pline2 = pline2+text_theme_set
  pline2 = pline2+theme(
    legend.position = 'bottom'
  )
  
  subsdf = data.frame(
    x = rep(as.Date('2003-08-01'),9),
    y = 0.7,
    label = paste0('(',letters[1:9],')'),
    type =  c(paste0('ATO',1:4),
              paste0('EU',1:3),
              paste0('AS',1:2))
  )
  
  
  pline2 = pline2+
    geom_text(data = subsdf,aes(x = x,y = y,label = label),
              size = 4,color ='black',hjust = 0)
  
  output2 = paste0(output,'/figs_south.png')
  
  png(output2,
      width = 26,
      height = 26,
      res = 800,
      units = 'cm')
  print(pline2)
  dev.off()
  
  
}
figs1_plot_xinjiang_vapor<-function(
  
){
  
}
figs1_trajectories_animate <-function(
  
){
  require(chron)
  require(gganimate)
  require(ggplot2)
  require(reshape2)
  library(data.table)
  
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management("world")
  world = crop(world,extent(-180,180,0,90))
  
  xj = shp_management('xinjiang')
  
  source('/home/share/R_project/xinjiang_vapor/cluster_whole_time_traj.R')
  #cluster_traj_df = cluster_whole_time_traj()
  cluster_traj_df = fread('analysis_output/fig2/cluster_traj_df.csv')
  cluster_traj_df = as.data.frame(cluster_traj_df)
  
  df2 = cluster_traj_df
  df2$time = factor(df2$variable,
                    levels = paste0('long',1:38),
                   labels = paste0('Simulating Time: ',seq(0,222,6),'h'))
  df2$time_h = factor(df2$variable,
                      levels = paste0('long',1:38),
                      labels =as.numeric(seq(0,222,6)))
  
  df2$time_h = as.numeric(df2$time_h)
  df2$time_h = as.numeric(df2$time_h)*6-6
  
  #df2m = reshape2::melt(df2,c('time','time_h','long','lat','routeid'))
  library(RColorBrewer)
  library(ggplot2)
  lincolor = colorRampPalette(brewer.pal(9,'Spectral'))(20)
  fontsize = 12
  plot_set = theme(panel.background = element_rect(fill = 'transparent',color = 'black'),
                   axis.text = element_text(face='bold',colour='black',size=fontsize,hjust=.5),
                   axis.title = element_text(face='bold',colour='black',size=fontsize,hjust=.5),
                   legend.position=c('bottom'),
                   legend.direction = c('horizontal'))
  
  p1 = ggplot()+
    #############
    geom_polygon(data = world,aes(x = long,y = lat,group = group),
               fill = 'transparent',color = 'black',
               size = 0.5)+
    geom_polygon(data = xj,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 0.5)+
    geom_path(data = df2,aes(x = long,y = lat,
                                         group = routeid,
                                         color = factor(routeid)),
              size = 1,
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="closed"))+
    #scale_fill_gradientn(colors = mycolor)+
    #scale_fill_manual(values = fillcolor)+
    scale_color_manual(values = lincolor)+
    #scale_size_manual(values = sizemanual)+
    #facet_wrap(~type,nrow = 4)+
    #coord_fixed(1.3)+
    guides(color = guide_legend(title= "Trajectory"))+
           #size = guide_legend(title= "Trajectory"),
           #fill = guide_legend(title= "Contribution rate (1/10000000)"))+
    #facet_wrap(~time,nrow = 3,scales = 'free')+
    
    theme_bw()+
    plot_set+
    theme(legend.position = 'none')+
    xlab('Longitude')+
    ylab('Latitude')
  #############
  
  p2 = p1+transition_reveal(along = time_h)
  anim_save('/home/share/R_project/xinjiang_vapor/main_plot/fig1_ani/p2.gif',p2,
            width = 20,
            height = 15,
            units = 'cm',
           res = 300
  )
  
  
  
  
}
figs1_validation_of_contribution<-function(
  
){
  
  input_contr_by_sou = 'analysis_output/contr_in_source_variance_new.csv'
  contr_by_sou = as.data.frame(fread(input_contr_by_sou))
  
  sou_names = contr_by_sou[,1]
  sou_names[13] = 'NAM'
  contr_by_sou = contr_by_sou[,-1]
  
  contr_by_sou[10,]= abs(contr_by_sou[10,])
  
  contr_sum = apply(contr_by_sou,2,sum,
                    na.rm = T)
  
  # input_pr_in_target
  input_era5_pr = list.files('era5_pr_in_target',
                                 full.names = T)
  input_gpcc_pr = list.files('gpcc_pr_in_target',
                             full.names = T)
  
  era5_pr = lapply(lapply(input_era5_pr,fread),
                   as.data.frame)
  gpcc_pr = lapply(lapply(input_gpcc_pr,fread),
                   as.data.frame)
  
  era5_pr = do.call('cbind',era5_pr)
  gpcc_pr = do.call('cbind',gpcc_pr)
  
  era5_pr = apply(era5_pr,1,sum)
  gpcc_pr = apply(gpcc_pr,1,sum)
  
  stand_fun <-function(x){
    
    x = ts(x,start = c(2003,1),
           frequency = 12)
    xt = decompose(x)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    x = xt
    
    x = (x -mean(x,na.rm = T))/(max(x,na.rm = T)-
                                  min(x,na.rm = T))
    return(x)
  }
  
  contr_sum = stand_fun(contr_sum)
  era5_pr = stand_fun(era5_pr)
  gpcc_pr = stand_fun(gpcc_pr)
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),
             '1 month')
  dates = date[-c(1:6,175:180)]
  date = 1:168+100
  
  df1 = data.frame(
    date = date,
    Sum_Contr_Rate = contr_sum,
    ERA5_Pr = era5_pr,
    GPCC_Pr = gpcc_pr
  )
  df2 = df1[,-1]

  df1 = reshape2::melt(df1,'date')
  df2 = reshape2::melt(df2,'Sum_Contr_Rate')
  
  df1$type = 1
  df2$type = 2
  
  dfabline = data.frame(
    x =0,
    slope = 1,
    type = 2
  )
  
  pcom = ggplot()+
    geom_line(data = df1,aes(x = date,y = value,
                             color = variable,
                             linetype = variable),
              size = 1.5)+
    geom_point(data = df2,aes(x = Sum_Contr_Rate,
                              y = value,
                              color = variable),
               size = 3,
               shape = 1)+
    geom_point(data = df2,aes(x = Sum_Contr_Rate,
                              y = value,
                              color = variable),
               size = 3.25,
               shape = 1)+
    geom_abline(data = dfabline,
                aes(intercept = x,
                    slope = slope),
                size = 1,
                color = 'black')+
    facet_wrap(~type,nrow = 1,
               scales = 'free_x')+
    scale_color_npg()+
    scale_x_continuous(breaks = c(seq(-0.5,0.5,0.25),
                                  seq(101,268,50)),
                       labels = c(seq(-0.5,0.5,0.25),
                                  substr(dates[seq(1,168,50)],1,4)))+
    theme_bw()
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  pcom = pcom+text_theme_set+
    guides(color = guide_legend(
      title = ''),
      linetype = guide_legend(
        title = ''))+
    theme(strip.text = element_blank(),
          legend.position = 'bottom')
  
  # adding df
  subsdf = data.frame(
    x = c(101,-0.45),
    y = c(0.6,0.60),
    label = c('(a)','(b)'),
    type = c(1,2)
  )
  
  pcom = pcom+
    geom_text(data = subsdf,
              aes(x =x,y= y,label = label),
              size = 4,
              color = 'black')
  pcom = pcom+
    xlab('Date')+
    ylab('Standardized Indices')
  
  # cor test 
  cor1 = cor.test(contr_sum,era5_pr,p=0.01)
  cor2 = cor.test(contr_sum,gpcc_pr)
  
  cor1in = cor1$conf.int
  cor2in = cor2$conf.int
  
  cor1e = cor1$estimate
  cor2e = cor2$estimate
  
  cordf1 = data.frame(
    x = c('Cor_ERA5','Cor_GPCC'),
    y50 = c(cor1e,cor2e),
    y95 = c(cor1in[2],cor2in[2]),
    y05 = c(cor1in[1],cor2in[1])
  )
  
  fil1 = pal_npg()(9)[2:3]
  pbox = ggplot()+
    geom_bar(data = cordf1,
             aes(x = x,
                 y = y50,
                 fill = x),
             stat = 'identity',
             position = 'dodge',
             color = 'white',
             width = 0.8)+
    geom_text(data = cordf1,
              aes(x = x,
                  y = y50-0.1,
                  label = round(y50,2)),
              size = 4,
              color = 'black')+
    scale_fill_manual(values = fil1)+
    theme_void()+
    theme(
      legend.position = 'none',
      axis.line.x = element_line(size = 0.5,color = 'black'),
      axis.title.x = element_text(size = 11,
                                  color = 'black')
    )+
    xlab('Corre. Coeff. (p <0.05)')
  
  library(cowplot)
  pcom1 = ggdraw()+
    draw_plot(pcom)+
    draw_plot(pbox,x = 0.86, y = 0.30,
              width = 0.11, height = 0.24)
  
  output = 'main_plot/SI/figs1_validation_contri'
  dir.create(output)
  output = paste0(output,'/figs1.png')
  
  png(output,
      height = 10,
      width = 25,
      units = 'cm',
      res = 800)
  print(pcom1)
  dev.off()
  
}



figs10_plot_ver2 <- function(
  
){
  source('/home/share/R_project/xinjiang_vapor/import_importance_data_figs1011.R')
  retbox = import_importance_data_figs1011()
  imp245 = retbox[[1]]
  imp585 = retbox[[2]]
  
  imp245$type = 'SSP245'
  imp585$type = 'SSP585'
  
  imp245 = reshape2::melt(imp245,c('SWs','type','PME'))
  imp585 = reshape2::melt(imp585,c('SWs','type','PME'))
  
  
  imp245$type = '(a) SSP245'
  imp585$type ='(b) SSP585'
  
  labeldf = data.frame(
    x = c('SW1'),
    y = rep(10,1),
    label = c('(a)'),
    type = c('(a) SSP245')
  )
  
  text_df1 = data.frame(
    x = c(imp245$SWs),
    y = c(imp245$value),
    type = c(imp245$type)
  )
  
  library(ggsci)
  p10 = ggplot()+
    geom_bar(data = imp245,
             aes(x = SWs,
                 y = value,
                 fill = PME),
             stat = 'identity',
             position = 'dodge',
             color = 'white',
             width = 0.8)+
    geom_text(data = labeldf,
              aes(x = x,y = y,
                  label = label),
              color = 'black',
              size = 4)+
    geom_text(data = text_df1,
              aes(x = x,y = y+0.2,
                  label = round(y,2)),
              position = position_dodge2(0.8),
              size = 4,
              color = 'black')+
    #facet_wrap(~type,nrow = 1)+
    scale_fill_lancet(alpha = 0.8)+
    theme_bw()+
    ylab('IncNodePurity')
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  p10 = p10+
    text_theme_set+
    theme(strip.text = element_blank(),
          axis.title.x = element_blank(),
          legend.position = 'none')
  
  source('/home/share/R_project/xinjiang_vapor/import_IncMSE_data_figs1011.R')
  
  imsedf = import_IncMSE_data_figs1011()
  imse245 = imsedf[[1]]
  imse585 = imsedf[[2]]
  
  
  imse245$type = 'SSP245'
  imse585$type = 'SSP585'
  
  imse245 = reshape2::melt(imse245,c('SWs','type','PME'))
  imse585 = reshape2::melt(imse585,c('SWs','type','PME'))
  
  
  imse245$type = '(c) SSP245'
  imse585$type ='(d) SSP585'
  
  labeldf = data.frame(
    x = c('SW1'),
    y = rep(12,1),
    label = c('(b)'),
    type = c('(c) SSP245')
  )
  
  text_df1 = data.frame(
    x = c(imse245$SWs),
    y = c(imse245$value),
    type = c(imse245$type)
  )
  
  library(ggsci)
  p11 = ggplot()+
    geom_bar(data = imse245,
             aes(x = SWs,
                 y = value,
                 fill = PME),
             stat = 'identity',
             position = 'dodge',
             color = 'white',
             width = 0.8)+
    geom_text(data = labeldf,
              aes(x = x,y = y,
                  label = label),
              color = 'black',
              size = 4)+
    geom_text(data = text_df1,
              aes(x = x,y = y+0.2,
                  label = round(y,2)),
              position = position_dodge2(0.8),
              size = 4,
              color = 'black')+
    #facet_wrap(~type,nrow = 1)+
    scale_fill_lancet(alpha = 0.8)+
    theme_bw()+
    ylab('IncMSE (%)')
  
  
  p11 = p11+text_theme_set+
    theme(strip.text = element_blank(),
          axis.title.x = element_blank(),
          legend.position = 'none')
  
  p10 = p10+scale_y_continuous(
    breaks = seq(0,8,2),
    labels = paste0(seq(0,8,2),'.0')
  )
  p11 = p11+scale_y_continuous(
    breaks = seq(0,12,2),
    labels = paste0(seq(0,12,2),'.0')
  )
  
  library(cowplot)
  p12 = plot_grid(
    p10,p11,
    align = 'tb',
    axis = 'h',
    rel_widths = c(1,1),
    rel_heights = c(1,1),
    nrow = 1
  )
  
  library(ggpubr)
  p12legend = as_ggplot(get_legend(
    p10+theme(legend.position = 'bottom')+
      guides(fill = guide_legend(title = ''))
  ))
  p12legend = p12legend+
    theme(plot.margin = unit(c(0,0,0,0),'cm'))
  p123 = plot_grid(
    p12,p12legend,
    ncol = 1,
    rel_heights = c(10,1)
  )
  dir.create('main_plot/SI/importance_matrix')
  png('main_plot/SI/importance_matrix/fig91.png',
      height = 15,
      width = 24,
      units = 'cm',
      res = 800)
  print(p123)
  dev.off()
  
  
  
  
}
figs10_plot <- function(
  
){
  source('/home/share/R_project/xinjiang_vapor/import_importance_data_figs1011.R')
  retbox = import_importance_data_figs1011()
  imp245 = retbox[[1]]
  imp585 = retbox[[2]]
  
  imp245$type = 'SSP245'
  imp585$type = 'SSP585'
  
  imp245 = reshape2::melt(imp245,c('SWs','type','PME'))
  imp585 = reshape2::melt(imp585,c('SWs','type','PME'))
  
  
  imp245$type = '(a) SSP245'
  imp585$type ='(b) SSP585'
  
  labeldf = data.frame(
    x = c('SW1','SW1'),
    y = rep(10,2),
    label = c('(a)','(b)'),
    type = c('(a) SSP245','(b) SSP585')
  )
  
  text_df1 = data.frame(
    x = c(imp245$SWs,imp585$SWs),
    y = c(imp245$value,imp585$value),
    type = c(imp245$type,imp585$type)
  )
  
  library(ggsci)
  p10 = ggplot()+
    geom_bar(data = imp245,
             aes(x = SWs,
                 y = value,
                 fill = PME),
             stat = 'identity',
             position = 'dodge',
             color = 'white',
             width = 0.8)+
    geom_bar(data = imp585,
             aes(x = SWs,
                 y = value,
                 fill = PME),
             stat = 'identity',
             position = 'dodge',
             color = 'white',
             width = 0.8)+
    geom_text(data = labeldf,
              aes(x = x,y = y,
                  label = label),
              color = 'black',
              size = 4)+
    geom_text(data = text_df1,
                    aes(x = x,y = y+0.2,
                        label = round(y,2)),
                    position = position_dodge2(0.8),
                    size = 4,
                    color = 'black')+
    facet_wrap(~type,nrow = 1)+
    scale_fill_lancet(alpha = 0.8)+
    theme_bw()+
    ylab('IncNodePurity')
    
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  p10 = p10+
      text_theme_set+
    theme(strip.text = element_blank(),
          axis.title.x = element_blank(),
          legend.position = 'none')
  
  source('/home/share/R_project/xinjiang_vapor/import_IncMSE_data_figs1011.R')
  
  imsedf = import_IncMSE_data_figs1011()
  imse245 = imsedf[[1]]
  imse585 = imsedf[[2]]
  
  
  imse245$type = 'SSP245'
  imse585$type = 'SSP585'
  
  imse245 = reshape2::melt(imse245,c('SWs','type','PME'))
  imse585 = reshape2::melt(imse585,c('SWs','type','PME'))
  
  
  imse245$type = '(c) SSP245'
  imse585$type ='(d) SSP585'
  
  labeldf = data.frame(
    x = c('SW1','SW1'),
    y = rep(12,2),
    label = c('(c)','(d)'),
    type = c('(c) SSP245','(d) SSP585')
  )
  
  text_df1 = data.frame(
    x = c(imse245$SWs,imse585$SWs),
    y = c(imse245$value,imse585$value),
    type = c(imse245$type,imse585$type)
  )
  
  library(ggsci)
  p11 = ggplot()+
    geom_bar(data = imse245,
             aes(x = SWs,
                 y = value,
                 fill = PME),
             stat = 'identity',
             position = 'dodge',
             color = 'white',
             width = 0.8)+
    geom_bar(data = imse585,
             aes(x = SWs,
                 y = value,
                 fill = PME),
             stat = 'identity',
             position = 'dodge',
             color = 'white',
             width = 0.8)+
    geom_text(data = labeldf,
              aes(x = x,y = y,
                  label = label),
              color = 'black',
              size = 4)+
    geom_text(data = text_df1,
              aes(x = x,y = y+0.2,
                  label = round(y,2)),
              position = position_dodge2(0.8),
              size = 4,
              color = 'black')+
    facet_wrap(~type,nrow = 1)+
    scale_fill_lancet(alpha = 0.8)+
    theme_bw()+
    ylab('IncMSE (%)')
  
  
  p11 = p11+text_theme_set+
    theme(strip.text = element_blank(),
          axis.title.x = element_blank(),
          legend.position = 'none')
  
  p10 = p10+scale_y_continuous(
    breaks = seq(0,8,2),
    labels = paste0(seq(0,8,2),'.0')
  )
  p11 = p11+scale_y_continuous(
    breaks = seq(0,12,2),
    labels = paste0(seq(0,12,2),'.0')
  )
  
  library(cowplot)
  p12 = plot_grid(
    p10,p11,
    align = 'lr',
    axis = 'h',
    rel_widths = c(1,1),
    rel_heights = c(1,1),
    ncol = 1
  )
  
  library(ggpubr)
  p12legend = as_ggplot(get_legend(
    p10+theme(legend.position = 'bottom')+
      guides(fill = guide_legend(title = ''))
  ))
  p12legend = p12legend+
    theme(plot.margin = unit(c(0,0,0,0),'cm'))
  p123 = plot_grid(
    p12,p12legend,
    ncol = 1,
    rel_heights = c(10,1)
  )
  dir.create('main_plot/SI/importance_matrix')
  png('main_plot/SI/importance_matrix/fig9.png',
      height = 20,
      width = 24,
      units = 'cm',
      res = 800)
  print(p123)
  dev.off()
  
  
  
  
}
figs2_monthly_contribution<-function(
  
){
  input_contr_by_sou = 'analysis_output/contr_in_source_variance_new.csv'
  contr_by_sou = as.data.frame(fread(input_contr_by_sou))
  
  sou_names = contr_by_sou[,1]
  sou_names[13] = 'NAM'
  contr_by_sou = contr_by_sou[,-1]
  
  contr_by_sou[10,]= abs(contr_by_sou[10,])

  monthly_median <- function(x){
    xm = matrix(x,nrow = 12)
    xm = apply(xm,1,median,na.rm= T)
    return(xm)
  }
  monthly_max <- function(x){
    xm = matrix(x,nrow = 12)
    xm = apply(xm,1,max,na.rm= T)
    return(xm)
  }
  monthly_min <- function(x){
    xm = matrix(x,nrow = 12)
    xm = apply(xm,1,min,na.rm= T)
    return(xm)
  }
  monthly_q25 <- function(x){
    xm = matrix(x,nrow = 12)
    xm = apply(xm,1,quantile,
               na.rm= T,
               probs = 0.25)
    return(xm)
  }
  monthly_q75 <- function(x){
    xm = matrix(x,nrow = 12)
    xm = apply(xm,1,quantile,
               na.rm= T,
               probs = 0.75)
    return(xm)
  }
  
  mean_box = apply(contr_by_sou,1,monthly_mean)
  min_box = apply(contr_by_sou,1,monthly_min)
  max_box = apply(contr_by_sou,1,monthly_max)
  q25_box = apply(contr_by_sou,1,monthly_q25)
  q75_box = apply(contr_by_sou,1,monthly_q75)
    
  colnames(mean_box) = toupper(sou_names)
  colnames(min_box) = toupper(sou_names)
  colnames(max_box) = toupper(sou_names)
  colnames(q25_box) = toupper(sou_names)
  colnames(q75_box) = toupper(sou_names)
  
  date = toupper(month.abb)
  #date = 1:12
  dfmean = data.frame(
    date,
    mean_box
  )
  
  dfmin = data.frame(
    date = date,
    min_box
  )
  
  dfmax =data.frame(
    date   = date,
    max_box
  )
  
  df25 = data.frame(
    date = date,
    q25_box
  )
  
  df75 = data.frame(
    date = date,
    q75_box
  )
  
  
  
  dfmean = reshape2::melt(dfmean,'date')
  dfmin = reshape2::melt(dfmin,'date')
  dfmax = reshape2::melt(dfmax,'date')
  df25 = reshape2::melt(df25,'date')
  df75 = reshape2::melt(df75,'date')
  
  
  
  dfmaxmin = data.frame(
    date = dfmin$date,
    variable = dfmin$variable,
    max = dfmax$value,
    min = dfmin$value,
    y25 = df25$value,
    y75 = df75$value,
    mean = dfmean$value
  )
  
  
  
  cols = colorRampPalette(
    brewer.pal(9,'Set1')
  )(13)
  cols = colorRampPalette(
    pal_npg()(9)
  )(13)
  
  idsort = order(apply(contr_by_sou,1,mean,
                      na.rm = T),
                decreasing = T)
  mean_contr = sort(apply(contr_by_sou,1,mean,
                           na.rm = T),
                     decreasing = T)
  sous = toupper(sou_names)[idsort]
  
  sous1 = sous[1:3]
  sous2 = sous[4:13]
  
  dfg1 = dfmaxmin[which(dfmaxmin$variable
                       %in% sous1),]
  dfg2 = dfmaxmin[which(dfmaxmin$variable
                       %in% sous2),]
  
  dfmaxmin$variable = factor(dfmaxmin$variable,
                             levels = sous)
  
  dfg1$variable = factor(dfg1$variable,
                         levels = sous1)
  dfg2$variable = factor(dfg2$variable,
                         levels = sous2)
  dates1 = date[1:5]
  dates2 = date[6:12]
  
  dfg1$date = factor(dfg1$date,
                     levels = date)
  dfg2$date = factor(dfg2$date,
                     levels = date)
  library(ggsci)
  pmonth1 = ggplot()+
    geom_boxplot(data = dfg1,
      aes(x = date,
          ymin = min, 
          lower = y25, 
          middle = mean, 
          upper = y75, 
          ymax = max,
          fill = variable),
                 stat = "identity")+
    scale_fill_manual(values = cols[1:3])+
    scale_x_discrete(breaks = date[seq(1,12,3)])+
    facet_wrap(~variable,nrow = 1)+
    theme_bw()
  library(ggsci)
  pmonth2 = ggplot()+
    geom_boxplot(data = dfg2,
                 aes(x = date,
                     ymin = min, 
                     lower = y25, 
                     middle = mean, 
                     upper = y75, 
                     ymax = max,
                     fill = variable),
                 stat = "identity")+
    scale_fill_manual(values = cols[4:13])+
    scale_x_discrete(breaks = date[seq(1,12,3)])+
    facet_wrap(~variable,nrow = 2,
               scales = 'free')+
    theme_bw()
  
  pmonth3 = ggplot()+
    geom_boxplot(data = dfmaxmin,
                 aes(x = date,
                     ymin = min, 
                     lower = y25, 
                     middle = mean, 
                     upper = y75, 
                     ymax = max,
                     fill = variable),
                 stat = "identity")+
    scale_fill_manual(values = cols,
                      guide = guide_legend(
                        title = 'Continent',
                        title.position = 'top',
                        nrow = 1
                      ))+
    scale_x_discrete(breaks = date[seq(1,12,3)])+
    facet_wrap(~variable,nrow = 2,
               scales = 'free')+
    theme_bw()
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  dftext1 = data.frame(
    x = rep('JAN',3),
    y = rep(50,3),
    label = paste0('(',letters[1:3],')'),
    variable = sous1
  )
  dftext2 = data.frame(
    x = rep('JAN',10),
    y = c(12.5,8,5,11.5,4.5,
          5,3,1,1.25,1.1),
    label = paste0('(',letters[4:13],')'),
    variable = sous2
  )
  
  mean_contr = as.numeric(mean_contr)
  mean_contr = round(mean_contr,2)
  dftext3 = data.frame(
    x = rep('APR',3),
    y = rep(50,3),
    label = paste0("MCR: ",mean_contr[1:3],'%'),
    variable = sous1
  )
  
  dftext4 = data.frame(
    x = rep('APR',10),
    y = c(12.5,8,5,11.5,4.5,
          5,3,1,1.25,1.1),
    label = paste0("MCR: ",mean_contr[4:13],'%'),
    variable = sous2
  )
  pmonth1 = pmonth1+text_theme_set
  pmonth2 = pmonth2+text_theme_set
  pmonth3 = pmonth3+text_theme_set
  
  pmonth1 = pmonth1+
    geom_text(data = dftext1,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black',
              hjust = 0)+
    geom_text(data = dftext3,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black',
              hjust = 0)
  pmonth2 = pmonth2+
    geom_text(data = dftext2,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black',
              hjust =0)+
    geom_text(data = dftext4,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black',
              hjust = 0)
  
  
  comb_set = theme(
    legend.position = 'none',
    axis.title = element_blank(),
    strip.text = element_blank()
  )
  
  pmonth1 = pmonth1+comb_set
  pmonth2 = pmonth2+comb_set
  
  pmon = plot_grid(
    pmonth1,
    pmonth2,
    ncol =1,
    align = 'lr',
    axis = 'hv',
    rel_widths = c(1,1),
    rel_heights = c(1,2)
  )
  
  plegend = as_ggplot(
    get_legend(pmonth3+
                 theme(legend.position = 'bottom'))
  )
  
  plegend = plegend+
    theme(plot.margin = unit(c(0,0,0,0),'cm'))
  
  pmon_leg = plot_grid(
    pmon,
    plegend,
    ncol = 1,
    rel_heights = c(10,1),
    rel_widths = c(1,1)
  )
  
  output = 'main_plot/SI/monthly_contribution/'
  dir.create(output)
  output = paste0(output,'figs2.png')
  
  png(output,
      height = 22,
      width = 26,
      units = 'cm',
      res = 800)
  print(pmon_leg)
  dev.off()
  
}




figs3_pme_local_tws <- function(
  
){
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  
  pmeato = pe_in_source[,5:8]- pet_sum[,5:8]
  
  input_era5_pr = list.files('era5_pr_in_target',
                             full.names = T)[c(1,3)]
  input_eva_intarget = list.files('poten_evap_in_target',
                                  full.names =T)[c(1,3)]
  
  input_tws = 'tws_in_target/'
  input_tws = list.files(input_tws,
                         full.names = T)[c(1,3)]
  
  
  era5_pr = lapply(lapply(input_era5_pr,fread),
                   as.data.frame)
  eva = lapply(lapply(input_eva_intarget,fread),
                   as.data.frame)
  tws = lapply(lapply(input_tws,fread),
               as.data.frame)
  
  era5_pr = do.call('cbind',era5_pr)
  eva = do.call('cbind',eva)
  tws = do.call('cbind',tws)
  
  era5_pr = era5_pr[1:174,]
  eva = eva[1:174,]
  pmeato = pmeato[1:174,]
  #era5_pr = apply(era5_pr,1,sum)
  #eva = apply(eva,1,sum)
  
  era5_pme = era5_pr - eva
  
  #tws = apply(tws,1,sum)
  
  stand_fun <-function(x){
    
    x = ts(x,start = c(2003,1),
           frequency = 12)
    xt = decompose(x)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    x = xt
    
    x = (x -mean(x,na.rm = T))/(max(x,na.rm = T)-
                                  min(x,na.rm = T))
    return(x)
  }
  
  #era5_pme = stand_fun(era5_pme)
  #tws = stand_fun(tws)
  
  era5_pme = apply(era5_pme,2,stand_fun)
  era5_pr = apply(era5_pr,2,stand_fun)
  pmeato = apply(pmeato,2,stand_fun)
  tws  =apply(tws,2,stand_fun)
  
  df1 = data.frame(
    PME_North = era5_pme[,1],
    PME_ATO1 = pmeato[,1],
    PME_ATO2 = pmeato[,2],
    PME_ATO3 = pmeato[,3],
    PME_ATO4 = pmeato[,4]
  )
  df2 = data.frame(
    PME_South = era5_pme[,2],
    PME_ATO1 = pmeato[,1],
    PME_ATO2 = pmeato[,2],
    PME_ATO3 = pmeato[,3],
    PME_ATO4 = pmeato[,4]
  )
  
  df1m = reshape2::melt(df1,'PME_North')
  df2m = reshape2::melt(df2,'PME_South')
  
  p1 = ggplot()+
    geom_point(data = df1m,
               aes(x = PME_North,
                   y = value,
                   color = variable),
               shape = 1,
               size = 3)+
    geom_abline(intercept = 0,
                slope = 1,
                color = 'black',
                size = 0.5)+
    geom_abline(intercept = 0,
                slope = -1,
                color = 'black',
                size = 0.5)+
    facet_wrap(~variable,nrow = 1)+
    theme_bw()
  p2 = ggplot()+
    geom_point(data = df1m,
               aes(x = PME_Sorth,
                   y = value,
                   color = variable),
               shape = 1,
               size = 3)+
    geom_abline(intercept = 0,
                slope = 1,
                color = 'black',
                size = 0.5)+
    geom_abline(intercept = 0,
                slope = -1,
                color = 'black',
                size = 0.5)+
    facet_wrap(~variable,nrow = 1)+
    theme_bw()
  
  date = 1:162+100
  dates = seq(as.Date('2003-01-01'),
              as.Date('2017-12-01'),
              '1 month')[1:174]
  dates = dates[-c(1:6,169:174)]
  
  colnames(pmeato) = paste0('PME_ATO',1:4)
  
  df3 = data.frame(
    date = date,
    TWS_North = tws[,1],
    PME_North = era5_pme[,1],
    pmeato
  )
  df4 = data.frame(
    TWS_North = tws[,1],
    PME_North = era5_pme[,1],
    pmeato
  )
  df3m= reshape2::melt(df3,'date')
  df4m = reshape2::melt(df4,'TWS_North')
  
  df3m$type = 1
  df4m$type = 2
  p2 = ggplot()+
    geom_line(data = df3m,
              aes(x = date,y = value,
                  color =variable),
              size = 1.5)+
    geom_point(data = df4m,aes(x = TWS_North,
                               y = value,
                               color = variable))+
    scale_color_npg()+
    facet_wrap(~type,nrow = 1,
               scales ='free_x')+
    theme_bw()
  
  
}
figs8_plot <- function(
  
){
  # content 
  # validation of training peariod
  source('/home/share/R_project/xinjiang_vapor/import_validate_tws_sws.R')
  source('/home/share/R_project/xinjiang_vapor/import_validate_tws_sws585.R')
  ret245 = import_validate_tws_sws245()
  ret585 = import_validate_tws_sws585()
  
  df245 = ret245[[1]]
  dfcor245 = ret245[[2]]
  df585 = ret585[[1]]
  dfcor585 = ret585[[2]]
  
  dfcor245$group = seq(2,20,2)
  dfcor585$group = seq(2,20,2)
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-06-01'),
             '1 month')
  
  reid = c(1:6,167:172)
  date = date[-reid]
  
  dfline245 = data.frame(
    date = (1:162)+100,
    df245,
    date_label = date
  )
  dfline585 = data.frame(
    date = (1:162)+100,
    df585,
    date_label = date
  )
  
  dfline245$group = rep(seq(1,20,2),each = 162)
  dfline585$group = rep(seq(1,20,2),each = 162)
  df245$group = rep(seq(2,20,2),each = 162)
  df585$group = rep(seq(2,20,2),each = 162)
  
  dflin245m = reshape2::melt(dfline245,
                            c('date','date_label',
                              'SWs','type','group'))
  dflin585m = reshape2::melt(dfline585,
                             c('date','date_label',
                               'SWs','type','group'))
  colnames = colnames(df245) 
  colnames[4] = 'type'
  colnames(df245) = colnames
  colnames(df585) = colnames
  
  pal1 = pal_lancet(alpha = 0.8)(9)
  pal1 = colorRampPalette(pal1)(30)
  cols = c('TWS_OBS'= pal1[1],
           'TWS_PROJ'= pal1[12],
           'Validation' = pal1[10],
           'Train' = pal1[13])
  
  dfabline1 = data.frame(
    x = c(rep(1,10),rep(113,10),
          rep(162,10))+100,
    group = rep(seq(1,20,2),3)
  )
  dfabline2 = data.frame(
    x = c(rep(0,10)),
    slope = rep(1,10),
    group = seq(2,20,2)
  )
  
  x = c(0,0.15,0.1,-0.25,0,0.1,
        0.1,0,0,0.1)
  y = c(-0.3,-0.25,-0.2,-0.5,
        -0.3,-0.3,-0.25,-0.25,
        -0.4,-0.4)
  
  dfcor245$x = x
  dfcor585$x = x
  
  dfcor245$y = y+0.1
  dfcor585$y = y+0.1
  
  dfcor245$label = paste0('Cor: ',
                          round(dfcor245$Cor,2))
  dfcor585$label = paste0('Cor: ',
                          round(dfcor585$Cor,2))
  
  dfp245 = dfcor245
  dfp585 = dfcor585
  
  dfp245$y = y
  dfp585$y = y
  
  dfp245$label = c('p<0.05')
  dfp585$label = c('p<0.05')
  
  pathdf = data.frame(
    x = rep(c(1,113,113,162),10)+100,
    xend = rep(c(113,1,162,113),10)+100,
    y = rep(rep(0.63,4),10),
    yend = rep(rep(0.63,4),10),
    group = rep(seq(1,20,2),each = 4)
  )
  
  pathdf2 = data.frame(
    x = rep(c(1,113,162),10)+100,
    y = rep(rep(0.60,3),10),
    yend = rep(rep(0.68,3),10),
    group = rep(seq(1,20,2),each = 3)
  )
  
  perioddf= data.frame(
    x = rep(c(56.5,137.5),10)+100,
    y = rep(c(0.68,0.68),10),
    label = rep(c('TP',
                  'VP'),
                10),
    group = rep(seq(1,20,2),each = 2)
  )
  
  subdf = data.frame(
    x = rep(5,10)+100,
    y = c(-0.45,-0.45,-0.3,-0.45,
          -0.3,-0.3,-0.3,-0.3,
          -0.45,-0.45),
    label = paste0('(',letters[seq(1,20,2)],')'),
    group = seq(1,20,2)
  )
  subdf2 = data.frame(
    x = c(-0.55,-0.5,-0.4,-0.6,
          -0.4,-0.5,-0.4,-0.5,
          -0.5,-0.5),
    y = c(0.3,0.35,0.45,0.25,
          0.5,0.45,0.5,0.45,
          0.23,0.3),
    label = paste0('(',letters[seq(2,20,2)],')'),
    group = seq(2,20,2)
  )
  subdf = rbind(subdf,subdf2)
  ps8 = ggplot()+
    ############
    geom_line(data = dflin245m,
              aes(x = date,y = value,
                  color = variable),
              size = 1.5)+
    geom_point(data = df245,
               aes(x = TWS_OBS,y = TWS_PROJ,
                   color = type),
               shape = 1,
               size = 3)+
    geom_point(data = df245,
               aes(x = TWS_OBS,y = TWS_PROJ,
                   color = type),
               shape = 1,
               size = 3.25)+
    geom_point(data = df245,
               aes(x = TWS_OBS,y = TWS_PROJ,
                   color = type),
               shape = 1,
               size = 2.85)+
    geom_vline(data = dfabline1,
               aes(xintercept = x),
               size = 0.5,
               linetype = 'dashed',
               color = 'black')+
    geom_abline(data = dfabline2,
                aes(intercept = x,
                    slope = slope),
                size = 1,
                color = 'black')+
    geom_text(data = subdf,
              aes(x = x,y = y,label = label),
              color = 'black',
              size = 5,
              hjust = 0)+
    geom_text(data= dfcor245,
              aes(x = x,y = y,label = label),
              color = 'black',
              size = 4,
              hjust = 0)+
    geom_text(data= dfp245,
              aes(x = x,y = y,label = label),
              color = 'black',
              size = 4,
              hjust = 0)+
    geom_text(data= perioddf,
            aes(x = x,y = y,label = label),
            color = 'black',
            size = 4,
            hjust = 0.5)+
    geom_segment(data = pathdf,
                 aes(x = x,xend = xend,
                     y = y,yend = y),
                 color = 'black',
                 size = 0.5,
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'))+
    geom_segment(data = pathdf2,
                  aes(x = x,xend = x,
                      y = y,yend = yend),
                  color = 'black',
                  size = 0.5)+
    scale_color_manual(values = cols)+
    scale_x_continuous(breaks = 
                         c(seq(-0.5,0.5,0.25),
                           seq(101,262,50)),
                       labels = c(
                         seq(-0.5,0.5,0.25),
                         substr(date[seq(1,162,50)],
                                1,4)
                       ))+
    facet_wrap(~group,nrow = 5,scales = 'free')+
    theme_bw()
    ############
    
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  ps8 = ps8+text_theme_set+
    theme(
      strip.text = element_blank(),
      axis.title = element_blank()
    )+
    guides(color = guide_legend(nrow = 1,title = ''))
  
  dir.create('main_plot/SI/figS8')
  
  png('main_plot/SI/figS8/fig8.png',
      height = 25,
      width = 27,
      units = 'cm',
      res = 800)
  print(ps8)
  dev.off()
  
  ### 
  # Fig S9 validation and train period for ssp585
  ps9 = ggplot()+
    ############
  geom_line(data = dflin585m,
            aes(x = date,y = value,
                color = variable),
            size = 1.5)+
    geom_point(data = df585,
               aes(x = TWS_OBS,y = TWS_PROJ,
                   color = type),
               shape = 1,
               size = 3)+
    geom_point(data = df585,
               aes(x = TWS_OBS,y = TWS_PROJ,
                   color = type),
               shape = 1,
               size = 3.25)+
    geom_point(data = df585,
               aes(x = TWS_OBS,y = TWS_PROJ,
                   color = type),
               shape = 1,
               size = 2.85)+
    geom_vline(data = dfabline1,
               aes(xintercept = x),
               size = 0.5,
               linetype = 'dashed',
               color = 'black')+
    geom_abline(data = dfabline2,
                aes(intercept = x,
                    slope = slope),
                size = 1,
                color = 'black')+
    geom_text(data = subdf,
              aes(x = x,y = y,label = label),
              color = 'black',
              size = 5,
              hjust = 0)+
    geom_text(data= dfcor585,
              aes(x = x,y = y,label = label),
              color = 'black',
              size = 4,
              hjust = 0)+
    geom_text(data= dfp585,
              aes(x = x,y = y,label = label),
              color = 'black',
              size = 4,
              hjust = 0)+
    geom_text(data= perioddf,
              aes(x = x,y = y,label = label),
              color = 'black',
              size = 4,
              hjust = 0.5)+
    geom_segment(data = pathdf,
                 aes(x = x,xend = xend,
                     y = y,yend = y),
                 color = 'black',
                 size = 0.5,
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'))+
    geom_segment(data = pathdf2,
                 aes(x = x,xend = x,
                     y = y,yend = yend),
                 color = 'black',
                 size = 0.5)+
    scale_color_manual(values = cols)+
    scale_x_continuous(breaks = 
                         c(seq(-0.5,0.5,0.25),
                           seq(101,262,50)),
                       labels = c(
                         seq(-0.5,0.5,0.25),
                         substr(date[seq(1,162,50)],
                                1,4)
                       ))+
    facet_wrap(~group,nrow = 5,scales = 'free')+
    theme_bw()
  ############
  
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  ps9 = ps9+text_theme_set+
    theme(
      strip.text = element_blank(),
      axis.title = element_blank()
    )+
    guides(color = guide_legend(nrow = 1,title = ''))
  
  dir.create('main_plot/SI/figS9')
  
  png('main_plot/SI/figS9/figs9.png',
      height = 25,
      width = 27,
      units = 'cm',
      res = 800)
  print(ps9)
  dev.off()
  
  
  
  
  
  
  
  
}































filter_cmip6_data_to_date_sst <- function(
  attrs = 'SST'
){
  input_file = '/media/root/Shen_drive1/CMIP6_reorder'
  
  #attr = c('E','Pr','T')
  
  input_file = paste0(input_file,'/',attrs)
  
  input_his = paste0(input_file,'/historical')
  input_ssp245 = paste0(input_file,'/ssp245')
  input_ssp585 = paste0(input_file,'/ssp585')
  
  
  hist_files = list.files(input_his)
  hist_files_full = list.files(input_his,
                               full.names = T)
  
  ssp245_files = list.files(input_ssp245)
  ssp245_files_full = list.files(input_ssp245,full.names = T)
  
  ssp585_files = list.files(input_ssp585)
  ssp585_files_full = list.files(input_ssp585,full.names = T)
  
  i = 1:length(hist_files)
  
  #declare global variables
  i <<- i 
  hist_files <<- hist_files
  hist_files_full <<- hist_files_full
  ssp245_files <<- ssp245_files
  ssp245_files_full <<- ssp245_files_full
  ssp585_files <<- ssp585_files
  ssp585_files_full <<- ssp585_files_full
  
  dir.create('/media/root/Shen_drive1/CMIP6_2003')
  output = paste0('/media/root/Shen_drive1/CMIP6_2003',
                  '/',attrs)
  dir.create(output)
  
  output_his = paste0(output,'/hist')
  output_ssp245 = paste0(output,'/ssp245')
  output_ssp585 = paste0(output,'/ssp585')
  
  dir.create(output_his)
  dir.create(output_ssp245)
  dir.create(output_ssp585)
  
  output_his <<- output_his
  output_ssp245 <<- output_ssp245
  output_ssp585 <<- output_ssp585
  
  sub_filter_his <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    
    tmp = hist_files[i]
    tmpmode = strsplit(tmp,'_')[[1]][1]
    tmpname = strsplit(tmp,'_')[[1]][2]
    startdate = as.numeric(substr(strsplit(tmp,'_')[[1]][3],1,4))
    enddate = as.numeric(substr(strsplit(tmp,'_')[[1]][4],1,4))
    
    tmpfull = hist_files_full[i]
    tmps = try(stack(tmpfull),silent = T)
    if('try-error' %in% class(tmps)){
      tmps = fread(tmpfull)
      tmps = as.data.frame(tmps)
      
      loc = tmps[,1:2]
      tmps = tmps[,-c(1,2)]
      
      aim = length(startdate:2003)*12-11
      dim = ncol(tmps)
      
      tmps = tmps[,aim:dim]
      tmps = cbind(loc,tmps)
      
      output_name = paste0(tmpmode,'_',tmpname,'_','200301','_',enddate,'.csv')
      output_tmps = paste0(output_his,'/',output_name)
      
      fwrite(tmps,
             output_tmps)
    }else{
      aim = length(startdate:2003)*12-11
      dim = dim(tmps)[3]
      
      tmps = tmps[[aim:dim]]
      
      output_name = paste0(tmpmode,'_',tmpname,'_','200301','_',enddate,'.nc')
      output_tmps = paste0(output_his,'/',output_name)
      
      writeRaster(tmps,output_tmps,format='CDF',overwrite = T)
      
    }
    
    
  }
  
  sub_filter_ssp245 <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    
    tmp = ssp245_files[i]
    tmpmode = strsplit(tmp,'_')[[1]][1]
    tmpname = strsplit(tmp,'_')[[1]][2]
    startdate = as.numeric(substr(strsplit(tmp,'_')[[1]][3],1,4))
    enddate = as.numeric(substr(strsplit(tmp,'_')[[1]][4],1,4))
    
    tmpfull = ssp245_files_full[i]
    tmps = try(stack(tmpfull),silent = T)
    
    if('try-error' %in% class(tmps)){
      tmps = fread(tmpfull)
      tmps = as.data.frame(tmps)
      
      loc = tmps[,1:2]
      tmps = tmps[,-c(1,2)]
      
      aim = length(startdate:2050)*12
      tmps = tmps[,1:aim]
      
      output_name = paste0(tmpmode,'_',tmpname,'_',startdate,'_',2050,'.csv')
      output_tmps = paste0(output_ssp245,'/',output_name)
      
      tmps = cbind(loc,tmps)
      fwrite(tmps,output_tmps)
      
    }else{
      aim = length(startdate:2050)*12
      tmps = tmps[[1:aim]]
      
      output_name = paste0(tmpmode,'_',tmpname,'_',startdate,'_',2050,'.nc')
      output_tmps = paste0(output_ssp245,'/',output_name)
      
      writeRaster(tmps,output_tmps,format='CDF',overwrite = T)
      
    }
    
    
    
  }
  
  sub_filter_ssp585 <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    
    tmp = ssp585_files[i]
    tmpmode = strsplit(tmp,'_')[[1]][1]
    tmpname = strsplit(tmp,'_')[[1]][2]
    startdate = as.numeric(substr(strsplit(tmp,'_')[[1]][3],1,4))
    enddate = as.numeric(substr(strsplit(tmp,'_')[[1]][4],1,4))
    
    tmpfull = ssp585_files_full[i]
    tmps = try(stack(tmpfull),silent = T)
    
    if('try-error' %in% class(tmps)){
      tmps = fread(tmpfull)
      tmps = as.data.frame(tmps)
      loc = tmps[,1:2]
      tmps = tmps[,-c(1,2)]
      
      aim = length(startdate:2050)*12
      tmps = tmps[,1:aim]
      
      tmps = cbind(loc,tmps)
      output_name = paste0(tmpmode,'_',tmpname,'_',startdate,'_',2050,'.csv')
      output_tmps = paste0(output_ssp585,'/',output_name)
      
      fwrite(tmps,output_tmps)
      
    }else{
      aim = length(startdate:2050)*12
      
      tmps = tmps[[1:aim]]
      
      output_name = paste0(tmpmode,'_',tmpname,'_',startdate,'_',2050,'.nc')
      output_tmps = paste0(output_ssp585,'/',output_name)
      
      writeRaster(tmps,output_tmps,format='CDF',overwrite = T)
      
    }
    
    
  }
  
  
  
  library(doParallel)
  print('hist start')
  cl = makeCluster(8)
  clusterExport(cl,c("hist_files","hist_files_full",'i','output_his'))
  system.time(parLapply(cl,i,sub_filter_his))
  stopCluster(cl)
  
  print('ssp245 start')
  cl = makeCluster(8)
  clusterExport(cl,c("ssp245_files","ssp245_files_full",'i','output_ssp245'))
  system.time(parLapply(cl,i,sub_filter_ssp245))
  stopCluster(cl)
  
  print('ssp585 start')
  cl = makeCluster(8)
  clusterExport(cl,c("ssp585_files","ssp585_files_full",'i','output_ssp585'))
  system.time(parLapply(cl,i,sub_filter_ssp585))
  stopCluster(cl)
  
  print(paste0('pass','_',attrs))
  
}
filter_cmip6_data_to_date <- function(
  attrs = 'E'
){
  input_file = '/media/root/Shen_drive1/CMIP6_reorder'
  
  #attr = c('E','Pr','T')
  
  input_file = paste0(input_file,'/',attrs)
  
  input_his = paste0(input_file,'/historical')
  input_ssp245 = paste0(input_file,'/ssp245')
  input_ssp585 = paste0(input_file,'/ssp585')
  
  
  hist_files = list.files(input_his)
  hist_files_full = list.files(input_his,full.names = T)
  
  ssp245_files = list.files(input_ssp245)
  ssp245_files_full = list.files(input_ssp245,full.names = T)
  
  ssp585_files = list.files(input_ssp585)
  ssp585_files_full = list.files(input_ssp585,full.names = T)
  
  i = 1:length(hist_files)
  
  #declare global variables
  i <<- i 
  hist_files <<- hist_files
  hist_files_full <<- hist_files_full
  ssp245_files <<- ssp245_files
  ssp245_files_full <<- ssp245_files_full
  ssp585_files <<- ssp585_files
  ssp585_files_full <<- ssp585_files_full
  
  dir.create('/media/root/Shen_drive1/CMIP6_2003')
  output = paste0('/media/root/Shen_drive1/CMIP6_2003',
                  '/',attrs)
  dir.create(output)
  
  output_his = paste0(output,'/hist')
  output_ssp245 = paste0(output,'/ssp245')
  output_ssp585 = paste0(output,'/ssp585')
  
  dir.create(output_his)
  dir.create(output_ssp245)
  dir.create(output_ssp585)
  
  output_his <<- output_his
  output_ssp245 <<- output_ssp245
  output_ssp585 <<- output_ssp585
  
  sub_filter_his <- function(i){
    library(raster)
    library(ncdf4)
    
    tmp = hist_files[i]
    tmpmode = strsplit(tmp,'_')[[1]][1]
    tmpname = strsplit(tmp,'_')[[1]][2]
    startdate = as.numeric(substr(strsplit(tmp,'_')[[1]][3],1,4))
    enddate = as.numeric(substr(strsplit(tmp,'_')[[1]][4],1,4))
    
    tmpfull = hist_files_full[i]
    tmps = stack(tmpfull)
    
    aim = length(startdate:2003)*12-11
    dim = dim(tmps)[3]
    
    tmps = tmps[[aim:dim]]
    
    output_name = paste0(tmpmode,'_',tmpname,'_','200301','_',enddate,'.nc')
    output_tmps = paste0(output_his,'/',output_name)
    
    writeRaster(tmps,output_tmps,format='CDF',overwrite = T)
    
  }
  
  sub_filter_ssp245 <- function(i){
    library(raster)
    library(ncdf4)
    
    tmp = ssp245_files[i]
    tmpmode = strsplit(tmp,'_')[[1]][1]
    tmpname = strsplit(tmp,'_')[[1]][2]
    startdate = as.numeric(substr(strsplit(tmp,'_')[[1]][3],1,4))
    enddate = as.numeric(substr(strsplit(tmp,'_')[[1]][4],1,4))
    
    tmpfull = ssp245_files_full[i]
    tmps = stack(tmpfull)
    
    aim = length(startdate:2050)*12
    tmps = tmps[[1:aim]]
    
    output_name = paste0(tmpmode,'_',tmpname,'_',startdate,'_',2050,'.nc')
    output_tmps = paste0(output_ssp245,'/',output_name)
    
    writeRaster(tmps,output_tmps,format='CDF',overwrite = T)
    
  }
  
  sub_filter_ssp585 <- function(i){
    library(raster)
    library(ncdf4)
    
    tmp = ssp585_files[i]
    tmpmode = strsplit(tmp,'_')[[1]][1]
    tmpname = strsplit(tmp,'_')[[1]][2]
    startdate = as.numeric(substr(strsplit(tmp,'_')[[1]][3],1,4))
    enddate = as.numeric(substr(strsplit(tmp,'_')[[1]][4],1,4))
    
    tmpfull = ssp585_files_full[i]
    tmps = stack(tmpfull)
    
    aim = length(startdate:2050)*12
    
    tmps = tmps[[1:aim]]
    
    output_name = paste0(tmpmode,'_',tmpname,'_',startdate,'_',2050,'.nc')
    output_tmps = paste0(output_ssp585,'/',output_name)
    
    writeRaster(tmps,output_tmps,format='CDF',overwrite = T)
    
  }
  
  
  
  library(doParallel)
  #cl = makeCluster(8)
  #clusterExport(cl,c("hist_files","hist_files_full",'i','output_his'))
  #system.time(parLapply(cl,i,sub_filter_his))
  #stopCluster(cl)
  
  #cl = makeCluster(8)
  #clusterExport(cl,c("ssp245_files","ssp245_files_full",'i','output_ssp245'))
  #system.time(parLapply(cl,i,sub_filter_ssp245))
  #stopCluster(cl)
  
  
  cl = makeCluster(8)
  clusterExport(cl,c("ssp585_files","ssp585_files_full",'i','output_ssp585'))
  system.time(parLapply(cl,i,sub_filter_ssp585))
  stopCluster(cl)
  
  print(paste0('pass','_',attrs))
  
}
filter_country_by_hsr_windows <- function(
  
){
  hsr = shapefile('analysis_output/fig2/combine_sub_window.shp')
  country_label <- as.data.frame(
    fread('/media/sdb5/Vapor_projcts/Vapor_tibet/main_plot_data/fig3/country_label.csv')
  )
  country_label = country_label[-which(country_label$name == 'Hong Kong'|
                                         country_label$name == 'Macau'),]
  country_label$latitude[which(country_label$name=='India')]=
    country_label$latitude[which(country_label$name=='India')]+2
  
  
  freshwater = as.data.frame(fread('NC_mod_xinjiang/freshwater/freshwater_filter.csv'))
  country = freshwater[,1]
  
  inid = which(country_label$name %in% country)
  
  coun_df = country_label[inid,]
  coun_df1 = coun_df
  
  coordinates(coun_df1) = ~longitude + latitude
  df_m = over(coun_df1, hsr)
  df_index = which(!is.na(df_m))
  df_m = coun_df1[df_index,]
  
  coun_dfin = as.data.frame(df_m,xy = T)
  
  coun_dfnoin = coun_df1[-df_index,]
  coun_dfnoin = as.data.frame(coun_dfnoin,xy = T)
  
  fwrite(coun_dfnoin,'NC_mod_xinjiang/freshwater/loc_dfnoin_hsr.csv')
  fwrite(coun_dfin,'NC_mod_xinjiang/freshwater/loc_in_hsr.csv')
  
  
  
}
find_not_in_index <- function(
  input_sub
){

  df = fread(paste0(input_sub,'/var_whole_route_mid.csv'))
  
  mask_id_land_p = list.files(paste0(input_sub,'/df_first_land'),full.names = T)
  mask_id_ocean_p = list.files(paste0(input_sub,'/df_first_ocean'),full.names = T)
  
  import_id_mask <- function(x){
    tmp = read.csv(x,header = T)
    tmp = tmp[,-1]
    return(tmp)
  }
  id_land = lapply(mask_id_land_p,import_id_mask)
  id_ocean = lapply(mask_id_ocean_p,import_id_mask)
  
  id_land = do.call('c',id_land)
  id_ocean = do.call('c',id_ocean)
  
  
  ids =c(id_land,id_ocean)
  ids = sort(ids)
  xfull <<- df$type
  df_fullid <<- df$type
  group_id <- function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  idsl = group_id(ids)
  source('/home/share/R_project/xinjiang_vapor/search_which_not_in.R')
  system.time(ret_full_id <- lapply(idsl, search_which_not_in))
  ret_full_id = do.call('c',ret_full_id)
  
  df_re_lack = df[ret_full_id,]
  
  output_path = paste0(input_sub,'/masked_var_whole_route_mid.csv')
  fwrite(df_re_lack,output_path)
}
find_peak_valley_p_trial <-function(
  index,
  tell_final = 0.01
){
  
  
  
  index = as.numeric(index)
  # 1. select #points by slope initially
  source('/home/share/R_project/xinjiang_vapor/slope_select.R')
  tp_box = slope_select(index)
  
  #plot(index)
  ##points(tp_box,index[tp_box],col = 'red')#
  #break
  #return(tp_box);break
  #break
  
  ##print(length(tp_box))
  index_tp = index[tp_box]
  tp_box2 = tp_box
  
  id_list = list()
  for(i in 1:length(tp_box)){
    temp_id = tp_box[i]
    id_group = 1
    for(j in 1:length(tp_box2)){
      temp_id2 = tp_box2[j]
      diff = abs(temp_id2 -temp_id)
      
      if(diff <= 2 & diff !=0){
        id_group =c(id_group,tp_box2[j])
      }
    } 
    id_group = id_group[-1]
    
    if(length(id_group)>0){
      id_group = c(temp_id,id_group)  
      id_group = sort(id_group)
      id_list[[i]] = id_group
    }
  }
  
  if(length(id_list) ==0){
    
  }else{
    re_id_box = 1
    id_keep = 1
    for(i in 1:length(id_list)){
      temp_id = id_list[[i]]
      ##print(temp_id)
      if(length(temp_id)==0){
        
      }else if(length(temp_id)==2){
        if(temp_id[1]>2){
          index_1 = index[temp_id[1]-2]
          index_2 = index[temp_id[1]]
          index_3 = index[temp_id[2]]
          index_4 = index[temp_id[2]+2]
          
          diff32 = index_3 - index_2
          diff41 = index_4 - index_1
          diff = diff41/diff32
          
          
          if(diff < 0 & abs(diff) >1 & abs(index_4)>abs(index_2)){
            re_id_box = c(re_id_box,temp_id)
          }else{
            
          }
        }
        
        
      }else{
        index_temp = index[temp_id]
        mean_box = mean(index_temp)
        diff = abs(index_temp - mean_box)
        
        temp_loc = which(diff == max(diff))
        temp_id = temp_id[temp_loc]
        id_keep = c(id_keep,temp_id)
        ###print(id_keep)
      }
      
    }
    
    re_id_box = re_id_box[-1]
    re_id_box = unique(re_id_box)
    id_keep = id_keep[-1]
    id_keep = unique(id_keep)
    #return(id_list)
    #(re_id_box);break
    
    re_keep_box = 1
    for(i in 1:length(re_id_box)){
      temp_re = which(id_keep == re_id_box[i])
      re_keep_box =c(re_keep_box,temp_re)
    }
    
    re_keep_box = re_keep_box[-1]
    id_keep = id_keep[-re_keep_box]
    
    #print(id_keep)
    ##print(re_id_box)
    
    re_box = 1
    for(i in 1:length(re_id_box)){
      temp_re = which(tp_box == re_id_box[i])
      re_box = c(re_box,temp_re)
    }
    re_box = re_box[-1]
    print(tp_box[re_box])
    ##print(re_box)
    #tp_box = tp_box[-re_box]
    
    #plot(index,type = 'b')
    #points(tp_box,index[tp_box],col = 'red')
    tp_box2 = tp_box
    #print(tp_box)
    #print(re_box)
    #break
    
    re_too_close = 1
    for(i in 1:(length(tp_box)-1)){
      
      tell = abs(index[tp_box[i]]-index[tp_box[i+1]])
      #print(tell)
      if(tell <tell_final){
        re_too_close = c(re_too_close,i)
      }
      
    }
    #print(re_too_close)
    #plot(index,type='l')
    #points(tp_box,index[tp_box],col = 'red',cex = 2)
    
    re_too_close = re_too_close[-1]
    if(length(re_too_close) !=0){
      #print(re_too_close)
      tp_box = tp_box[-re_too_close]
      
    }
    ##print(tp_box)
    ##print(tp_box2)
  }
  
  #plot(index,type='l')
  #points(tp_box,index[tp_box],col = 'red',cex = 2)
  
  
  return(tp_box)
  
}




























adjust_extent_cmip6_hist_ssp585<-function(
  
){
  
  files = list.files('/media/root/Shen_drive1/CMIP6_combined',full.names = T)
  
  for(i in c(1,2,4)){
    f1 = files[i]
    f1 = list.files(f1,full.names = T)
    print(i)
    for(j in 2){
      f2 = list.files(f1[j],full.names = T)
      
      for(z in 1:length(f2)){
        library(raster)
        library(ncdf4)
        tmp = stack(f2[z])
        extent(tmp) = extent(0,360,0,90)
        
        e1 = extent(0,180,0,90)
        e2 = extent(180,360,0,90)
        
        tmp1 = crop(tmp,e1)
        tmp2 = crop(tmp,e2)
        
        extent(tmp2) = extent(-180,0,0,90)
        
        tmp = merge(tmp2,tmp1)
        writeRaster(tmp,f2[z],format = 'CDF',overwrite = T)
      }
      
    }
    
    
    
  }
  
  
  
  
}
adjust_extent_cmip6_sst<-function(
  
){
  
  files = list.files('/media/root/Shen_drive1/CMIP6_combined',
                     full.names = T)
  
  for(i in 3){
    f1 = files[i]
    f1 = list.files(f1,full.names = T)
    print(i)
    for(j in 1:2){
      f2 = list.files(f1[j],full.names = T)
      
      for(z in 1:length(f2)){
        library(raster)
        library(ncdf4)
        tmp = try(stack(f2[z]),
                  silent = T)
        
        if('try-error' %in% class(tmp)){
          tmp = fread(f2[z])
          tmp = as.data.frame(tmp)
          
          loc = tmp[,1:2]
          
          minlong = min(loc[,1])
          minlat = min(loc[,2])
          maxlong = max(loc[,1])
          maxlat = max(loc[,2])
          
          diflong = minlong -()
          
          coordinates(tmp1) = ~long+lat
          gridded(tmp1) = T
          
          tmp1 = raster(tmp1)
          ggplot()+
            geom_point(data = tmp1,
                      aes(x = long,
                          y = lat,
                          color = value),
                      shape = 2)
            
        }
        extent(tmp) = extent(0,360,0,90)
        
        e1 = extent(0,180,0,90)
        e2 = extent(180,360,0,90)
        
        tmp1 = crop(tmp,e1)
        tmp2 = crop(tmp,e2)
        
        extent(tmp2) = extent(-180,0,0,90)
        
        tmp = merge(tmp2,tmp1)
        writeRaster(tmp,f2[z],format = 'CDF',overwrite = T)
      }
      
    }
    
    
    
  }
  
  
  
  
}
adjust_extent_cmip6<-function(
  
){
  
  files = list.files('/media/root/Shen_drive1/CMIP6_combined',full.names = T)
  
  for(i in 1:3){
    f1 = files[i]
    f1 = list.files(f1,full.names = T)
    print(i)
    for(j in 1:2){
      f2 = list.files(f1[j],full.names = T)
      
      for(z in 1:length(f2)){
        library(raster)
        library(ncdf4)
        tmp = stack(f2[z])
        extent(tmp) = extent(0,360,0,90)
        
        e1 = extent(0,180,0,90)
        e2 = extent(180,360,0,90)
        
        tmp1 = crop(tmp,e1)
        tmp2 = crop(tmp,e2)
        
        extent(tmp2) = extent(-180,0,0,90)
        
        tmp = merge(tmp2,tmp1)
        writeRaster(tmp,f2[z],format = 'CDF',overwrite = T)
      }
      
    }
    
        
    
  }
  
  
  
  
}
analyze_contr_monthly_var_rel_new<-function(
  
){
  library(data.table)
  # files contr in source
  files = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
  files_name = list.files('/media/sdb1/xinjiang_output_file')
  
  files = paste0(files,'/output/contr_by_source_released_new')
  files = list.files(files,full.names = T)
  
  yearmon = paste0('year',substr(files_name,9,14))
  
  oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
  con_names = c('as','xj','eu','naf','na')
  
  sou_names = c(oce_names,con_names)
  
  tmp_df = 1
  for(i in 1:length(files)){
    
    tmp = fread(files[i])
    tmp = as.data.frame(tmp)
    tmpname = tmp[,1]
    if(length(tmpname) == length(sou_names)){
      tmp_df = cbind(tmp_df,tmp[,2]*100)
    }else{
      tmp_value = tmp[1,]
      for(j in 1:length(sou_names)){
        tmpid = which(tmpname == sou_names[j])
        #print(tmpid)
        if(length(tmpid) == 0){
          tmp_re = c(sou_names[j],NA)
          tmp_value = rbind(tmp_value,tmp_re)
          #print(tmp_value)
        }else{
          #print(tmp[tmpid,])
          tmp_value = rbind(tmp_value,tmp[tmpid,])
          #print(tmp_value)
        }
      }
      #tmp_value = as.data.frame(tmp_value)
      tmp_value[,2] = as.numeric(tmp_value[,2])
      tmp_value = tmp_value[-1,]
      tmp_df = cbind(tmp_df,tmp_value[,2]*100)
    }
  }
  tmp_df = tmp_df[,-1]
  
  df = tmp_df
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),
             '1 month')
  
  trend_cal <- function(x){
    naid = which(is.na(x))
    x[naid] = 0
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    return(xt)
  }
  
  dft = apply(df,1,trend_cal)
  nid = which(is.na(dft[,1]))
  
  date_m = date[-nid]
  dft = dft[-nid,]
  
  dft = t(dft)
  rownames(dft) = sou_names
  colnames(dft) = yearmon[-nid]
  dft = data.frame(sou_names,dft)
  
  colnames(df) = yearmon
  df = data.frame(sou_names,df)
  
  
  library(reshape2)
  dfm = melt(df,'sou_names')
  dftm = melt(dft,'sou_names')
  
  
  dfm$date = rep(date,each = length(sou_names))
  dftm$date = rep(date_m,each = length(sou_names))
  dir.create('analysis_output')
  fwrite(df,'analysis_output/contr_in_source_variance_new.csv')
  fwrite(dft,'analysis_output/contr_in_source_tr_new.csv')
  
  return(tmp_df)
  
  
  
}


analyze_contr_monthly_var<-function(
  
){
  # files contr in source
  files = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
  files_name = list.files('/media/sdb1/xinjiang_output_file')
  
  files = paste0(files,'/output/contr_by_source')
  files = list.files(files,full.names = T)
  
  yearmon = paste0('year',substr(files_name,9,14))
  
  oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
  con_names = c('as','xj','eu','naf','na')
  
  sou_names = c(oce_names,con_names)
  
  tmp_df = 1
  for(i in 1:length(files)){
    tmp = fread(files[i])
    tmp = as.data.frame(tmp)
    tmpname = tmp[,1]
    if(length(tmpname) == length(sou_names)){
      tmp_df = cbind(tmp_df,tmp[,2]*100)
    }else{
      tmp_value = 1
      for(j in 1:length(sou_names)){
          tmpid = which(tmpname == sou_names[j])
          if(length(tmpid) == 0){
            tmp_re = c(sou_names[j],NA)
            tmp_value = rbind(tmp_value,tmp_re)
            #print(tmp_value)
          }else{
            tmp_value = rbind(tmp_value,tmp[tmpid,])
            #print(tmp_value)
          }
      }
      tmp_value[,2] = as.numeric(tmp_value[,2])
      tmp_value = tmp_value[-1,]
      tmp_df = cbind(tmp_df,tmp_value[,2]*100)
    }
  }
  tmp_df = tmp_df[,-1]
  
  df = tmp_df
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),
             '1 month')
  
  trend_cal <- function(x){
    naid = which(is.na(x))
    x[naid] = 0
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    return(xt)
  }
  
  dft = apply(df,1,trend_cal)
  nid = which(is.na(dft[,1]))
  
  date_m = date[-nid]
  dft = dft[-nid,]
  
  dft = t(dft)
  rownames(dft) = sou_names
  colnames(dft) = yearmon[-nid]
  dft = data.frame(sou_names,dft)
  
  colnames(df) = yearmon
  df = data.frame(sou_names,df)
  
  
  library(reshape2)
  dfm = melt(df,'sou_names')
  dftm = melt(dft,'sou_names')
  
  
  dfm$date = rep(date,each = length(sou_names))
  dftm$date = rep(date_m,each = length(sou_names))
  dir.create('analysis_output')
  fwrite(df,'contr_in_source_variance.csv')
  fwrite(dft,'contr_in_source_tr.csv')
  
  return(tmp_df)
  
  
  
}

df = tmp_df
date = seq(as.Date('2003-01-01'),
           as.Date('2017-12-01'),
           '1 month')

trend_cal <- function(x){
  naid = which(is.na(x))
  x[naid] = 0
  xt = ts(x,start = c(2003,1),frequency = 12)
  xt = decompose(xt)$trend
  return(xt)
}

dft = apply(df,1,trend_cal)
nid = which(is.na(dft[,1]))

date_m = date[-nid]
dft = dft[-nid,]

dft = t(dft)
rownames(dft) = sou_names
colnames(dft) = yearmon[-nid]
dft = data.frame(sou_names,dft)

colnames(df) = yearmon
df = data.frame(sou_names,df)


library(reshape2)
dfm = melt(df,'sou_names')
dftm = melt(dft,'sou_names')


dfm$date = rep(date,each = length(sou_names))
dftm$date = rep(date_m,each = length(sou_names))
which(is.na(dfm$value))


p = ggplot()+
  geom_line(data = dfm,aes(x= date,y = value,color = sou_names))


oce_df = dftm[1,]
for(i in 1:length(oce_names)){
  ocetmp = which(dftm$sou_names == oce_names[i])
  ocetmp = dftm[ocetmp,]
  oce_df = rbind(oce_df,ocetmp)
}

oce_df = oce_df[-1,]

con_df = dftm[1,]
for(i in 1:length(con_names)){
  contmp = which(dftm$sou_names == con_names[i])
  contmp = dftm[contmp,]
  con_df = rbind(con_df,contmp)
}

con_df = con_df[-1,]
naid_con = which(con_df$sou_names =='na')
con_df = con_df[-naid_con,]

p_con = ggplot()+
  geom_line(data = con_df,aes(x= date,y = value,color = sou_names))+
  facet_wrap(~sou_names,nrow = 2,scales = 'free')+theme_bw()+
  theme(
    panel.background = element_rect(fill = 'transparent'),
    axis.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
    axis.title = element_text(color = 'black',size = 14,face = 'bold',hjust = 0.5),
    legend.position = 'bottom',
    legend.direction = 'horizontal',
    legend.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
    legend.title = element_text(color = 'black',size = 14, face = 'bold',hjust = 0.5),
    strip.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5)
  )+
  guides(fill = guide_legend(nrow = 1))+
  xlab('Date (month)')+
  ylab('Contribution Ratio (%)')


png('plot/contr_con_monthly_var_line.png',
    height = 20,
    width = 21,
    units = 'cm',
    res = 800)
print(p_con)
dev.off()

p_oce = ggplot()+
  geom_line(data = oce_df,aes(x= date,y = value,color = sou_names))+
  facet_wrap(~sou_names,nrow = 4,scales = 'free')+theme_bw()+
  theme(
    panel.background = element_rect(fill = 'transparent'),
    axis.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
    axis.title = element_text(color = 'black',size = 14,face = 'bold',hjust = 0.5),
    legend.position = 'bottom',
    legend.direction = 'horizontal',
    legend.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
    legend.title = element_text(color = 'black',size = 14, face = 'bold',hjust = 0.5),
    strip.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5)
  )+
  guides(color = guide_legend(nrow = 1))+
  xlab('Date (month)')+
  ylab('Contribution Ratio (%)')


png('plot/contr_oce_monthly_var_line.png',
    height = 20,
    width = 21,
    units = 'cm',
    res = 800)
print(p_oce)
dev.off()






anunal_pattern_analysis<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/anunal_pattern_cal.R')
  # gpcc 
  source('/home/share/R_project/xinjiang_vapor/gpcc_pr_in_xinjiang.R')
  gpcc_full = gpcc_pr_in_xinjiang(mode = 'full')
  gpcc_anu = anunal_pattern_cal(gpcc_full)
  # gws
  source('/home/share/R_project/xinjiang_vapor/gws_in_xinjiang.R')
  gws_full = gws_in_xinjiang(mode = 'full')
  gws_anu = anunal_pattern_cal(gws_full,'grace')
  # era5_evpor
  source('/home/share/R_project/xinjiang_vapor/era5_evapor.R')
  eva_full = era5_evapor(mode = 'full')
  eva_anu = anunal_pattern_cal(eva_full)
  # era5_temper
  source('/home/share/R_project/xinjiang_vapor/era5_temper.R')
  t_full = era5_tmp(mode = 'full')
  t_anu = anunal_pattern_cal(t_full)
  # ndvi 
  source('/home/share/R_project/xinjiang_vapor/ndvi_in_xinjiang.R')
  ndvi_full = ndvi_in_xinjiang(mode = 'full')
  ndvi_anu = anunal_pattern_cal(ndvi_full)
  
  year = 2003:2017
  gpcc_anu = stand_fun(gpcc_anu)
  gws_anu = stand_fun(gws_anu)
  eva_anu = stand_fun(eva_anu)
  t_anu = stand_fun(t_anu)
  ndvi_anu = stand_fun(ndvi_anu)
  
  ep = gpcc_anu-eva_anu
  
  d = data.frame(year,gpcc_anu,gws_anu)
  
  dm = reshape2::melt(d,'year')
  
  dm$year = factor(dm$year,levels = year)
  
  p = ggplot()+
    geom_line(data = dm,aes(x = year,y = value, color = variable,group = variable))+
    theme_bw()+
    theme(
      panel.background = element_rect(fill = 'transparent'),
      axis.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      axis.title = element_text(color = 'black',size = 14,face = 'bold',hjust = 0.5),
      legend.position = 'bottom',
      legend.direction = 'horizontal',
      legend.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      legend.title = element_text(color = 'black',size = 14, face = 'bold',hjust = 0.5),
      strip.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5)
    )+
    guides(color = guide_legend(nrow = 1))+
    xlab('Date (month)')+
    ylab('Index')
  
  p
}
anunal_pattern_cal<-function(
  index,mode = 'others'
){
  
  #start = 2003-01-01
  #end = 2017-12-01
  if(mode == 'grace'){
    index = c(index,rep(NA,6))
  }
  indexm = matrix(index,nrow = 12)
  
  mean_fun<-function(x){
    tmp = mean(x,na.rm = T)
  }
  indexm = apply(indexm,2,mean_fun)
  return(indexm)
  
}
back_chose_within_boundury<-function(
  input_data
){
  
  # aim to back choosing the particles released in xinjiang Area
  sub_choose<-function(
    input_sub
  ){
    print(input_sub)
    
    df = fread(paste0(input_sub,'/alldates_output.csv'))
    # df = as.data.frame(df)
    # data_structure
    # c('long','lat','height','ep','type')
    
    # Calculation of total released in Xinjiang Extent
    shp_path = '/usr/local/flexpart_bk1/shp/Xinjiang_border.shp'
    xinjiang_shp = shapefile(shp_path)
    ## crop releasing zone
    dfc = df
    coordinates(dfc) = ~ long+lat
    proj4string(dfc) = "+proj=longlat +datum=WGS84 +no_defs"
    df_m = over(dfc,xinjiang_shp)
    df_index = which(!is.na(df_m[,1]))
    df_m = dfc[df_index,]
    df_xinjiang = as.data.frame(df_m,xy = T)
    #back chosing id
    id_inzone = unique(df_xinjiang$type)
    rm(df_xinjiang)
    rm(df_m)
    rm(dfc)
    
    
    
    gc()
    print('Accomplish first gc')
    
    group_id_vector<-function(x){
      step = round(length(x) /100)
      ids = seq(1,length(x),step)
      ide = ids -1
      ide = ide[-1]
      ide = c(ide,length(x))
      xl = list()
      for(i in 1:length(ids)){
        stmp = ids[i]
        etmp = ide[i]
        tmp = x[stmp:etmp]
        xl[[i]] = tmp
      }
      return(xl)
    }
    idl = group_id_vector(id_inzone)

    df_fullid <<- df$type
    back_chose_pal<-function(x){
      mats = min(which(df_fullid == x[1]))
      mate = max(which(df_fullid == x[length(x)]))
      
      df_sce <<- df_fullid[mats:mate]
      x<<-x
      back_chose_sec<-function(id){
        tmpid = which(df_sce == id)
        return(tmpid)
      }
      #print(x[1])
      ret_id = lapply(x,back_chose_sec)
      
      ret_id = do.call('c',ret_id)
      #cl = makeCluster(3)
      #clusterExport(cl,c('df_sce','x'))
      #system.time(
      #  ret_id <- parLapply(cl,x,back_chose_sec)
      #)
      #stopCluster(cl)
      #ret_id = do.call('c',ret_id)
      #print(mats)
      ret_id = ret_id+mats-1
      return(ret_id)
    }
  
    system.time(whole_id <- lapply(idl,back_chose_pal))
    whole_id = do.call('c',whole_id)
    
    gc()
    print('Accomplish second gc ')
    
    df_released_inxinjiang = df[whole_id,]
    rm(df)
    output = paste0(input_sub,'/df_released_inxinjiang.csv')
    fwrite(df_released_inxinjiang,output)
  }
  
  sapply(input_data,sub_choose)
}
better_cluster_determine<-function(
  
){
  # month 1:12
  input_data = list.files('/media/sdb1/xinjiang_output_file',full.names = T)[1:12]
  
  input_data = paste0(input_data,'/output')
  
  sub_better<-function(input_sub){
    print(input_sub)
    con_names = c('as','xj','eu','naf','na')
    input_land = paste0(input_sub,'/contr_released_land')
    input_land = paste0(input_land,'/',con_names,'.csv')
    
    input_land <<- input_land
    cluster_better_con_fun<-function(i){
      library(factoextra)
      library(vegan)
      library(data.table)
      if(file.exists(input_land[i])){
        tmpdf = fread(input_land[i])
        if(nrow(tmpdf)>15){
          tmpdf = as.data.frame(tmpdf)
          loc = tmpdf[,1:2]
          ca_clust = cascadeKM(loc,1,15,iter = 100)
          cal_best = as.numeric(which.max(ca_clust$results[2,]))
          cluster_best_con = cal_best
        }else{
          tmpdf = as.data.frame(tmpdf)
          cluster_best_con = 1
        }
        
      }else{
        cluster_best_con = NA
      }
      return(cluster_best_con)
    }
    
    i = 1:length(input_land)
    i <<- i
    
    library(doParallel)
    cl = makeCluster(5)
    clusterExport(cl,c('input_land','i'))
    system.time(ret_con <- parLapply(cl,i,cluster_better_con_fun))
    stopCluster(cl)
    
    ret_con = do.call('c',ret_con)
    
    
    
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    input_oce = paste0(input_sub,'/contr_released_ocean')
    input_oce = paste0(input_oce,'/',oce_names,'.csv')
    input_oce <<- input_oce
    
    cluster_best_oce_fun<-function(i){
      library(factoextra)
      library(vegan)
      library(data.table)
      if(file.exists(input_oce[i])){
        tmpdf = fread(input_oce[i])
        if(nrow(tmpdf)>15){
          tmpdf = as.data.frame(tmpdf)
          loc = tmpdf[,1:2]
          ca_clust = cascadeKM(loc,1,15,iter = 100)
          cal_best = as.numeric(which.max(ca_clust$results[2,]))
          cluster_best_oce = cal_best 
        }else{
          tmpdf = as.data.frame(tmpdf)
          cluster_best_oce = 1
        }
        
      }else{
        cluster_best_oce = NA
      }
      return(cluster_best_oce)
    }
    
    i = 1:length(input_oce)
    i <<- i 
    
    library(doParallel)
    cl = makeCluster(8)
    clusterExport(cl,c('input_oce','i'))
    system.time(ret_oce <- parLapply(cl,i,cluster_best_oce_fun))
    stopCluster(cl)
    
    ret_oce = do.call('c',ret_oce)
    
    ret = c(ret_oce,ret_con)
    return(ret)
  }
  
  better_cluster = lapply(input_data,sub_better)
  
  better_cluster = do.call('cbind',better_cluster)
  
  return(better_cluster)
}
cal_contri_rate<-function(
  input_data 
){
  library(raster)
  library(maps)
  library(maptools)
  library(ggplot2)
  library(reshape2)
  library(RColorBrewer)
  library(data.table)
  library(foreach)
  library(doParallel)
  library(parallel)
  library(snow)
  
  
  sub_cal_contri<-function(
    input_sub
  ){
    # import total relased in xinjiang 
    input_tr = paste0(input_sub,'/totoal_release_in_xinjiang') 
    input_tr = paste0(input_tr, '/total_released.csv')
    
    tr = read.csv(input_tr,header = T)
    tr = tr[1,2]
    
    # cal by oceans
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    
    input_path = paste0(input_sub,'/contr_ocean')
    input_ocean = paste0(input_path,'/',oce_names,'.csv')
    
    rate_ocean_b = 1
    for(i in 1:length(input_ocean)){
      tmp_df = fread(input_ocean[i])
      tmprate = sum(tmp_df$varep_insource)/tr
      tmprate_bp = tmp_df$varep_insource /tr
      
      
      tmp_df$contr_rate = tmprate_bp
      fwrite(tmp_df,input_ocean[i])
      
      rate_ocean_b = c(rate_ocean_b,tmprate)
    }
    rate_ocean_b = rate_ocean_b[-1]
    
    
    # cal by lands 
    con_names = c('as','xj','eu','naf','na')
    input_land = paste0(input_sub,'/contr_land')
    input_land = paste0(input_land,'/',con_names,'.csv')
    
    rate_land_b = 1
    for(i in 1:length(input_land)){
      tmp_df = fread(input_land[i])
      if(con_names[i] == 'xj'){
        tmprate = sum(tmp_df$varep_insource[which(tmp_df$varep_insource<0)])/tr
        tmprate = abs(tmprate)
        tmprate_bp = tmp_df$varep_insource /tr
        
      }else{
        tmprate = sum(tmp_df$varep_insource)/tr
        tmprate_bp = tmp_df$varep_insource /tr
        
      }
      
      tmp_df$contr_rate = tmprate_bp
      fwrite(tmp_df,input_land[i])
      
      rate_land_b = c(rate_land_b,tmprate)
    }
    rate_land_b = rate_land_b[-1]
    
    source_names = c(oce_names,con_names)
    rates = c(rate_ocean_b,rate_land_b)
    
    contr_df = data.frame(source_names,rates)
    
    output_contr = paste0(input_sub,'/contr_by_source')
    dir.create(output_contr)
    output_contr = paste0(output_contr,'/contri_each_source.csv')
    
    fwrite(contr_df,output_contr)
    
    
    
    
    
  }
  sapply(input_data,sub_cal_contri)
}
cal_contri_rate2<-function(
  input_data 
){
  library(raster)
  library(maps)
  library(maptools)
  library(ggplot2)
  library(reshape2)
  library(RColorBrewer)
  library(data.table)
  library(foreach)
  library(doParallel)
  library(parallel)
  library(snow)
  
  
  sub_cal_contri<-function(
    input_sub
  ){
    # import total relased in xinjiang 
    
    # cal by oceans
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    
    input_path = paste0(input_sub,'/contr_released_ocean')
    input_ocean = paste0(input_path,'/',oce_names,'.csv')
    
    rate_ocean_b = 1
    nid = 1
    for(i in 1:length(input_ocean)){
      if(file.exists(input_ocean[i])){
        tmp_df = fread(input_ocean[i])
        if(nrow(tmp_df)>0){
          tmprate = sum(tmp_df$contr_rate)
          rate_ocean_b = c(rate_ocean_b,tmprate)
          nid = c(nid,i)
        }
      }
    }
    rate_ocean_b = rate_ocean_b[-1]
    nid = nid[-1]
    oce_names = oce_names[nid]
    
    # cal by lands 
    con_names = c('as','xj','eu','naf','na')
    input_land = paste0(input_sub,'/contr_released_land')
    input_land = paste0(input_land,'/',con_names,'.csv')
    
    rate_land_b = 1
    nid = 1
    for(i in 1:length(input_land)){
      if(file.exists(input_land[i])){
        tmp_df = fread(input_land[i])
        if(nrow(tmp_df)>0){
          tmprate = sum(tmp_df$contr_rate)
          rate_land_b = c(rate_land_b,tmprate)  
          nid = c(nid,i)
        }  
      }
    }
    rate_land_b = rate_land_b[-1]
    nid =nid[-1]
    con_names = con_names[nid]
    
    source_names = c(oce_names,con_names)
    rates = c(rate_ocean_b,rate_land_b)
    
    contr_df = data.frame(source_names,rates)
    
    output_contr = paste0(input_sub,'/contr_by_source_released_new')
    dir.create(output_contr)
    output_contr = paste0(output_contr,'/contri_each_source.csv')
    
    fwrite(contr_df,output_contr)
    
  }
  sapply(input_data,sub_cal_contri)
}
cal_convey_amount_based_on_era5_eva <-function(
  
){
  
  target = c('north_jishui','north_moun','south_jishui','south_moun')
  sources = c('as','ato','eu')
  
  sources = paste0(rep(sources,each = 4),'_',1:4)
  target = rep(target,each = 12)
  sources = rep(sources,4)
  tar_sou = paste0(target,'_',sources)
  
  tar_sou <<- tar_sou
  library(data.table)
  sub_cal<-function(tar_sou){
    # input era5 ep sum
    tar_sou_full = tar_sou
    tar_sou = strsplit(tar_sou,'_')[[1]]
    
    source = paste0(tar_sou[1],'_',tar_sou[2])
    mode = tar_sou[3]
    reg_id = as.numeric(tar_sou[4])
    
    input_path = paste0('era5_eva_sum/',mode)
    
    input_path = list.files(input_path,full.names = T)
    input_path = list.files(input_path,full.names = T)
    
    input_path = input_path[reg_id]
    
    # input convey_rate 
    input_con_min = 'analysis_output/convey_rate_by_region_min.csv'
    input_con_max = 'analysis_output/convey_rate_by_region_max.csv'
    input_con_mean = 'analysis_output/convey_rate_by_region_mean.csv'
    
    
    # import data
    
    ep_sum = fread(input_path)
    ep_sum = ep_sum$ERA5
    
    con_min = fread(input_con_min)
    con_max = fread(input_con_max)
    con_mean = fread(input_con_mean)
    
    group_id = con_min$re_group
    group_id = which(group_id ==tar_sou_full)
    
    con_min = as.numeric(con_min[group_id,-1])
    con_max = as.numeric(con_max[group_id,-1])
    con_mean = as.numeric(con_mean[group_id,-1])
    
    con_min = rep(con_min,(length(ep_sum)/12))
    con_max = rep(con_max,(length(ep_sum)/12))
    con_mean = rep(con_mean,(length(ep_sum)/12))
    
    ep_sum_min = ep_sum * con_min
    ep_sum_max = ep_sum * con_max
    ep_sum_mean = ep_sum * con_mean
    
    return(cbind(ep_sum_min,ep_sum_max,ep_sum_mean))
  }
  
  
  ret = lapply(tar_sou,sub_cal)
  
  match_min <-function(x){
    return(x[,1])
  }
  
  match_max <-function(x){
    return(x[,2])
  }
  
  match_mean <-function(x){
    return(x[,3])
  }
  
  
  ret_min = lapply(ret,match_min)
  ret_max = lapply(ret,match_max)
  ret_mean = lapply(ret,match_mean)
  
  ret_min = do.call(cbind,ret_min)
  ret_max = do.call(cbind,ret_max)
  ret_mean = do.call(cbind,ret_mean)  
  
  colnames(ret_min) = tar_sou
  colnames(ret_max) = tar_sou
  colnames(ret_mean) = tar_sou
  
  output = 'convey_amount_based_era5_eva_in_target'
  dir.create(output)
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  
  
  output_min = paste0(output,'/min')
  output_max = paste0(output,'/max')
  output_mean = paste0(output,'/mean')
  
  dir.create(output_min)
  dir.create(output_max)
  dir.create(output_mean)
  
  output_min = paste0(output_min,'/',files,'.csv')
  output_max = paste0(output_max,'/',files,'.csv')
  output_mean = paste0(output_mean,'/',files,'.csv')
  
  ret_north_jishui_min = ret_min[,1:12]
  ret_north_jishui_max = ret_max[,1:12]
  ret_north_jishui_mean = ret_mean[,1:12]
  
  fwrite(ret_north_jishui_min,output_min[2])
  fwrite(ret_north_jishui_max,output_max[2])
  fwrite(ret_north_jishui_mean,output_mean[2])
  
  ret_north_moun_min = ret_min[,13:24]
  ret_north_moun_max = ret_max[,13:24]
  ret_north_moun_mean = ret_mean[,13:24]
  
  fwrite(ret_north_moun_min,output_min[1])
  fwrite(ret_north_moun_max,output_max[1])
  fwrite(ret_north_moun_mean,output_mean[1])
  
  ret_south_jishui_min = ret_min[,25:36]
  ret_south_jishui_max = ret_max[,25:36]
  ret_south_jishui_mean = ret_mean[,25:36]
  
  fwrite(ret_south_jishui_min,output_min[4])
  fwrite(ret_south_jishui_max,output_max[4])
  fwrite(ret_south_jishui_mean,output_mean[4])
  
  ret_south_moun_min = ret_min[,37:48]
  ret_south_moun_max = ret_max[,37:48]
  ret_south_moun_mean = ret_mean[,37:48]
  
  fwrite(ret_south_moun_min,output_min[3])
  fwrite(ret_south_moun_max,output_max[3])
  fwrite(ret_south_moun_mean,output_mean[3])
  
  
  
  # 
  
  
  
  # structure:
  
  north_jishui_min  =apply(ret_min[,1:12],1,sum)
  north_moun_min = apply(ret_min[,13:24],1,sum)
  south_jishui_min = apply(ret_min[,25:36],1,sum)
  south_moun_min = apply(ret_min[,37:48],1,sum)
  
  north_jishui_max  =apply(ret_max[,1:12],1,sum)
  north_moun_max = apply(ret_max[,13:24],1,sum)
  south_jishui_max = apply(ret_max[,25:36],1,sum)
  south_moun_max = apply(ret_max[,37:48],1,sum)
  
  north_jishui_mean  =apply(ret_mean[,1:12],1,sum)
  north_moun_mean = apply(ret_mean[,13:24],1,sum)
  south_jishui_mean = apply(ret_mean[,25:36],1,sum)
  south_moun_mean = apply(ret_mean[,37:48],1,sum)
  
  north_jishui_df = data.frame(min = north_jishui_min,
                               max = north_jishui_max,
                               mean = north_jishui_mean,
                               type = 'North_plain')
  north_moun_df = data.frame(min = north_moun_min,
                             max = north_moun_max,
                             mean = north_moun_mean,
                             type = 'North_mountain')
  south_jishui_df = data.frame(min = south_jishui_min,
                               max = south_jishui_max,
                               mean = south_jishui_mean,
                               type = 'South_plain')
  south_moun_df = data.frame(min = south_moun_min,
                             max = south_moun_max,
                             mean = south_moun_mean,
                             type = 'South_mountain')
  
  
  
  
  
  
}
cal_convey_amount_based_on_era5_pe <-function(
  
){
  
  target = c('north_jishui','north_moun','south_jishui','south_moun')
  sources = c('as','ato','eu')
  
  sources = paste0(rep(sources,each = 4),'_',1:4)
  target = rep(target,each = 12)
  sources = rep(sources,4)
  tar_sou = paste0(target,'_',sources)
  
  tar_sou <<- tar_sou
  library(data.table)
  sub_cal<-function(tar_sou){
    # input era5 ep sum
    tar_sou_full = tar_sou
    tar_sou = strsplit(tar_sou,'_')[[1]]
    
    source = paste0(tar_sou[1],'_',tar_sou[2])
    mode = tar_sou[3]
    reg_id = as.numeric(tar_sou[4])
    
    input_path = paste0('era5_pe_sum/',mode)
    
    input_path = list.files(input_path,full.names = T)
    input_path = list.files(input_path,full.names = T)
    
    input_path = input_path[reg_id]
    
    # input convey_rate 
    input_con_min = 'analysis_output/convey_rate_by_region_min.csv'
    input_con_max = 'analysis_output/convey_rate_by_region_max.csv'
    input_con_mean = 'analysis_output/convey_rate_by_region_mean.csv'
    
    
    # import data
    
    ep_sum = fread(input_path)
    ep_sum = ep_sum$ERA5
    
    con_min = fread(input_con_min)
    con_max = fread(input_con_max)
    con_mean = fread(input_con_mean)
    
    group_id = con_min$re_group
    group_id = which(group_id ==tar_sou_full)
    
    con_min = as.numeric(con_min[group_id,-1])
    con_max = as.numeric(con_max[group_id,-1])
    con_mean = as.numeric(con_mean[group_id,-1])
    
    con_min = rep(con_min,(length(ep_sum)/12))
    con_max = rep(con_max,(length(ep_sum)/12))
    con_mean = rep(con_mean,(length(ep_sum)/12))
    
    ep_sum_min = ep_sum * con_min
    ep_sum_max = ep_sum * con_max
    ep_sum_mean = ep_sum * con_mean
    
    return(cbind(ep_sum_min,ep_sum_max,ep_sum_mean))
  }
  
  
  ret = lapply(tar_sou,sub_cal)
  
  match_min <-function(x){
    return(x[,1])
  }
  
  match_max <-function(x){
    return(x[,2])
  }
  
  match_mean <-function(x){
    return(x[,3])
  }
  
  
  ret_min = lapply(ret,match_min)
  ret_max = lapply(ret,match_max)
  ret_mean = lapply(ret,match_mean)
  
  ret_min = do.call(cbind,ret_min)
  ret_max = do.call(cbind,ret_max)
  ret_mean = do.call(cbind,ret_mean)  
  
  colnames(ret_min) = tar_sou
  colnames(ret_max) = tar_sou
  colnames(ret_mean) = tar_sou
  
  output = 'convey_amount_based_era5_pe_in_target'
  dir.create(output)
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  
  
  output_min = paste0(output,'/min')
  output_max = paste0(output,'/max')
  output_mean = paste0(output,'/mean')
  
  dir.create(output_min)
  dir.create(output_max)
  dir.create(output_mean)
  
  output_min = paste0(output_min,'/',files,'.csv')
  output_max = paste0(output_max,'/',files,'.csv')
  output_mean = paste0(output_mean,'/',files,'.csv')
  
  ret_north_jishui_min = ret_min[,1:12]
  ret_north_jishui_max = ret_max[,1:12]
  ret_north_jishui_mean = ret_mean[,1:12]
  
  fwrite(ret_north_jishui_min,output_min[2])
  fwrite(ret_north_jishui_max,output_max[2])
  fwrite(ret_north_jishui_mean,output_mean[2])
  
  ret_north_moun_min = ret_min[,13:24]
  ret_north_moun_max = ret_max[,13:24]
  ret_north_moun_mean = ret_mean[,13:24]
  
  fwrite(ret_north_moun_min,output_min[1])
  fwrite(ret_north_moun_max,output_max[1])
  fwrite(ret_north_moun_mean,output_mean[1])
  
  ret_south_jishui_min = ret_min[,25:36]
  ret_south_jishui_max = ret_max[,25:36]
  ret_south_jishui_mean = ret_mean[,25:36]
  
  fwrite(ret_south_jishui_min,output_min[4])
  fwrite(ret_south_jishui_max,output_max[4])
  fwrite(ret_south_jishui_mean,output_mean[4])
  
  ret_south_moun_min = ret_min[,37:48]
  ret_south_moun_max = ret_max[,37:48]
  ret_south_moun_mean = ret_mean[,37:48]
  
  fwrite(ret_south_moun_min,output_min[3])
  fwrite(ret_south_moun_max,output_max[3])
  fwrite(ret_south_moun_mean,output_mean[3])
  
  
  
  # 
  
  
  
  # structure:
  
  north_jishui_min  =apply(ret_min[,1:12],1,sum)
  north_moun_min = apply(ret_min[,13:24],1,sum)
  south_jishui_min = apply(ret_min[,25:36],1,sum)
  south_moun_min = apply(ret_min[,37:48],1,sum)
  
  north_jishui_max  =apply(ret_max[,1:12],1,sum)
  north_moun_max = apply(ret_max[,13:24],1,sum)
  south_jishui_max = apply(ret_max[,25:36],1,sum)
  south_moun_max = apply(ret_max[,37:48],1,sum)
  
  north_jishui_mean  =apply(ret_mean[,1:12],1,sum)
  north_moun_mean = apply(ret_mean[,13:24],1,sum)
  south_jishui_mean = apply(ret_mean[,25:36],1,sum)
  south_moun_mean = apply(ret_mean[,37:48],1,sum)
  
  north_jishui_df = data.frame(min = north_jishui_min,
                               max = north_jishui_max,
                               mean = north_jishui_mean,
                               type = 'North_plain')
  north_moun_df = data.frame(min = north_moun_min,
                             max = north_moun_max,
                             mean = north_moun_mean,
                             type = 'North_mountain')
  south_jishui_df = data.frame(min = south_jishui_min,
                               max = south_jishui_max,
                               mean = south_jishui_mean,
                               type = 'South_plain')
  south_moun_df = data.frame(min = south_moun_min,
                             max = south_moun_max,
                             mean = south_moun_mean,
                             type = 'South_mountain')
  
  
  
  
  
  
}
cal_convey_amount_based_on_era5 <-function(
  
){
  
  target = c('north_jishui','north_moun','south_jishui','south_moun')
  sources = c('as','ato','eu')
  
  sources = paste0(rep(sources,each = 4),'_',1:4)
  target = rep(target,each = 12)
  sources = rep(sources,4)
  tar_sou = paste0(target,'_',sources)
  
  tar_sou <<- tar_sou
  library(data.table)
  sub_cal<-function(tar_sou){
    # input era5 ep sum
    tar_sou_full = tar_sou
    tar_sou = strsplit(tar_sou,'_')[[1]]
    
    source = paste0(tar_sou[1],'_',tar_sou[2])
    mode = tar_sou[3]
    reg_id = as.numeric(tar_sou[4])
    
    input_path = paste0('era5_ep_sum/',mode)
    
    input_path = list.files(input_path,full.names = T)
    input_path = list.files(input_path,full.names = T)
    
    input_path = input_path[reg_id]
    
    # input convey_rate 
    input_con_min = 'analysis_output/convey_rate_by_region_min.csv'
    input_con_max = 'analysis_output/convey_rate_by_region_max.csv'
    input_con_mean = 'analysis_output/convey_rate_by_region_mean.csv'
    
    
    # import data
    
    ep_sum = fread(input_path)
    ep_sum = ep_sum$ERA5
    
    con_min = fread(input_con_min)
    con_max = fread(input_con_max)
    con_mean = fread(input_con_mean)
    
    group_id = con_min$re_group
    group_id = which(group_id ==tar_sou_full)
    
    con_min = as.numeric(con_min[group_id,-1])
    con_max = as.numeric(con_max[group_id,-1])
    con_mean = as.numeric(con_mean[group_id,-1])
    
    con_min = rep(con_min,(length(ep_sum)/12))
    con_max = rep(con_max,(length(ep_sum)/12))
    con_mean = rep(con_mean,(length(ep_sum)/12))
    
    ep_sum_min = ep_sum * con_min
    ep_sum_max = ep_sum * con_max
    ep_sum_mean = ep_sum * con_mean
    
    return(cbind(ep_sum_min,ep_sum_max,ep_sum_mean))
  }
  
  
  ret = lapply(tar_sou,sub_cal)
  
  match_min <-function(x){
    return(x[,1])
  }
  
  match_max <-function(x){
    return(x[,2])
  }
  
  match_mean <-function(x){
    return(x[,3])
  }
  
  
  ret_min = lapply(ret,match_min)
  ret_max = lapply(ret,match_max)
  ret_mean = lapply(ret,match_mean)
  
  ret_min = do.call(cbind,ret_min)
  ret_max = do.call(cbind,ret_max)
  ret_mean = do.call(cbind,ret_mean)  
  
  colnames(ret_min) = tar_sou
  colnames(ret_max) = tar_sou
  colnames(ret_mean) = tar_sou
  
  output = 'convey_amount_based_era5_in_target'
  dir.create(output)
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  
  
  output_min = paste0(output,'/min')
  output_max = paste0(output,'/max')
  output_mean = paste0(output,'/mean')
  
  dir.create(output_min)
  dir.create(output_max)
  dir.create(output_mean)
  
  output_min = paste0(output_min,'/',files,'.csv')
  output_max = paste0(output_max,'/',files,'.csv')
  output_mean = paste0(output_mean,'/',files,'.csv')
  
  ret_north_jishui_min = ret_min[,1:12]
  ret_north_jishui_max = ret_max[,1:12]
  ret_north_jishui_mean = ret_mean[,1:12]
  
  fwrite(ret_north_jishui_min,output_min[2])
  fwrite(ret_north_jishui_max,output_max[2])
  fwrite(ret_north_jishui_mean,output_mean[2])
  
  ret_north_moun_min = ret_min[,13:24]
  ret_north_moun_max = ret_max[,13:24]
  ret_north_moun_mean = ret_mean[,13:24]
  
  fwrite(ret_north_moun_min,output_min[1])
  fwrite(ret_north_moun_max,output_max[1])
  fwrite(ret_north_moun_mean,output_mean[1])
  
  ret_south_jishui_min = ret_min[,25:36]
  ret_south_jishui_max = ret_max[,25:36]
  ret_south_jishui_mean = ret_mean[,25:36]
  
  fwrite(ret_south_jishui_min,output_min[4])
  fwrite(ret_south_jishui_max,output_max[4])
  fwrite(ret_south_jishui_mean,output_mean[4])
  
  ret_south_moun_min = ret_min[,37:48]
  ret_south_moun_max = ret_max[,37:48]
  ret_south_moun_mean = ret_mean[,37:48]
  
  fwrite(ret_south_moun_min,output_min[3])
  fwrite(ret_south_moun_max,output_max[3])
  fwrite(ret_south_moun_mean,output_mean[3])
  
  
  
  # 
  
  
  
  # structure:
  
  north_jishui_min  =apply(ret_min[,1:12],1,sum)
  north_moun_min = apply(ret_min[,13:24],1,sum)
  south_jishui_min = apply(ret_min[,25:36],1,sum)
  south_moun_min = apply(ret_min[,37:48],1,sum)
  
  north_jishui_max  =apply(ret_max[,1:12],1,sum)
  north_moun_max = apply(ret_max[,13:24],1,sum)
  south_jishui_max = apply(ret_max[,25:36],1,sum)
  south_moun_max = apply(ret_max[,37:48],1,sum)
  
  north_jishui_mean  =apply(ret_mean[,1:12],1,sum)
  north_moun_mean = apply(ret_mean[,13:24],1,sum)
  south_jishui_mean = apply(ret_mean[,25:36],1,sum)
  south_moun_mean = apply(ret_mean[,37:48],1,sum)
  
  north_jishui_df = data.frame(min = north_jishui_min,
                               max = north_jishui_max,
                               mean = north_jishui_mean,
                               type = 'North_plain')
  north_moun_df = data.frame(min = north_moun_min,
                             max = north_moun_max,
                             mean = north_moun_mean,
                             type = 'North_mountain')
  south_jishui_df = data.frame(min = south_jishui_min,
                               max = south_jishui_max,
                               mean = south_jishui_mean,
                               type = 'South_plain')
  south_moun_df = data.frame(min = south_moun_min,
                             max = south_moun_max,
                             mean = south_moun_mean,
                             type = 'South_mountain')
  
  
  
  
  
  
}
cal_convey_by_region_based_on_cmip6 <-function(
  mode = 'hist_ssp245'
){
  
  # input ep of cmip6
  mode <<- mode
  model_name = c('ACCESS-ESM1-5','BCC-CSM2-MR',
                 'CanESM5','GFDL-ESM4','IPSL-CM6A-LR',
                 'MIROC6','MRI-ESM2-0','NorESM2-LM')
  model_name <<- model_name
  
  input = 'cmip6_ep_sum_by_model'
  input = paste0(input,'/',mode)
  input2 = paste0(input,'/',model_name)
  input3 = paste0(input2,'/ep_sum.csv')
  
  input_cmip <<- input3
  
  target_region = paste0(c('north','north','south','south'),
                         '_',c('jishui','moun','jishui',"moun"))
  # define outptu
  output = 'convey_amount_based_on_cmip6_in_target'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output_max = paste0(output,'/','max')
  output_min = paste0(output,'/','min')
  output_mean = paste0(output,'/','mean')
  
  dir.create(output_max)
  dir.create(output_min)
  dir.create(output_mean)
  
  output_max = paste0(output_max,'/',model_name)
  output_min = paste0(output_min,'/',model_name)
  output_mean = paste0(output_mean,'/',model_name)
  
  lapply(output_max,dir.create)
  lapply(output_min,dir.create)
  lapply(output_mean,dir.create)
  
  output_max <<- output_max
  output_min <<- output_min
  output_mean <<- output_mean
  
  
  sub_cal_convey <-function(target_region){
    
    # import convey rate
    input_mean = 'analysis_output/convey_rate_by_region_mean.csv'
    input_max = 'analysis_output/convey_rate_by_region_max.csv'
    input_min ='analysis_output/convey_rate_by_region_min.csv' 
    
    con_rate_mean = fread(input_mean)
    con_rate_max = fread(input_max)
    con_rate_min = fread(input_min)
    
    group = con_rate_mean[,1]
    
    con_rate_mean = con_rate_mean[,-1]
    con_rate_max = con_rate_max[,-1]
    con_rate_min = con_rate_min[,-1]
    
    if(target_region == 'north_jishui'){
      con_rate_mean = con_rate_mean[1:12,]
      con_rate_max = con_rate_max[1:12,]
      con_rate_min = con_rate_min[1:12,]
    }else if(target_region =='north_moun'){
      con_rate_mean = con_rate_mean[13:24,]
      con_rate_max = con_rate_max[13:24,]
      con_rate_min = con_rate_min[13:24,]
    }else if(target_region =='south_jishui'){
      con_rate_mean = con_rate_mean[25:36,]
      con_rate_max = con_rate_max[25:36,]
      con_rate_min = con_rate_min[25:36,]
    }else if(target_region =='south_moun'){
      con_rate_mean = con_rate_mean[37:48,]
      con_rate_max = con_rate_max[37:48,]
      con_rate_min = con_rate_min[37:48,]
    }
    
    con_rate_mean = t(con_rate_mean)
    con_rate_max = t(con_rate_max)
    con_rate_min = t(con_rate_min)
    
    
    eps = lapply(input_cmip,fread)
    eps = lapply(eps,as.data.frame)
    
    as_negative_zero <-function(x){
      
      sub_as_neg <-function(x){
        x  = as.numeric(x)
        idneg = which(x <0)
        x[idneg] = 0
        return(x)
      }
      x = apply(x,2,sub_as_neg)
      return(x)
    }
    
    eps = lapply(eps,as_negative_zero)
    eps<<-eps
    
    con_rate_min <<- con_rate_min
    con_rate_max <<- con_rate_max
    con_rate_mean <<- con_rate_mean
    
    
    j = 1:8
    j <<- j
    
    cal_fun<-function(subeps,j){
      
      if(mode =='hist_ssp245'){
        i = 1:12
        cols = paste0(rep(c('as','ato','eu'),each = 4),
                      1:4)
      }else{
        i = 1:11
        cols = paste0(rep(c('as','ato','eu'),each = 4),
                      1:4)
        cols = cols[-12]
      }
      
      subeps <<- subeps
      
      calc_by_col_min<-function(i){
        rep_len = nrow(subeps)/12
        
        tmprate_min = con_rate_min[,i]
        tmprate_min = as.numeric(tmprate_min)
        tmprate_min = rep(tmprate_min,rep_len)

        tmpeps = subeps[,i]
        
        tmpeps_min = tmpeps * tmprate_min
        return(tmpeps_min)
        
      }
      calc_by_col_max<-function(i){
        rep_len = nrow(subeps)/12
        
        tmprate_max = con_rate_max[,i]
        tmprate_max = as.numeric(tmprate_max)
        tmprate_max = rep(tmprate_max,rep_len)
        
        tmpeps = subeps[,i]
        
        tmpeps_max = tmpeps * tmprate_max
        return(tmpeps_max)
        
      }
      calc_by_col_mean<-function(i){
        rep_len = nrow(subeps)/12
        
        tmprate_mean = con_rate_mean[,i]
        tmprate_mean = as.numeric(tmprate_mean)
        tmprate_mean = rep(tmprate_mean,rep_len)
        
        tmpeps = subeps[,i]
        
        tmpeps_mean = tmpeps * tmprate_mean
        return(tmpeps_mean)
        
      }
      
      ret_min = lapply(i,calc_by_col_min)
      ret_max = lapply(i,calc_by_col_max)
      ret_mean = lapply(i,calc_by_col_mean)
      
      ret_min = do.call(cbind,ret_min)
      ret_max = do.call(cbind,ret_max)
      ret_mean = do.call(cbind,ret_mean)
      
      
      colnames(ret_min) = cols
      colnames(ret_max) = cols
      colnames(ret_mean) = cols
          
      tmpoutput_min = paste0(output_min[j],'/',
                             target_region,'.csv')
      tmpoutput_max = paste0(output_max[j],'/',
                             target_region,'.csv')
      tmpoutput_mean = paste0(output_mean[j],'/',
                              target_region,'.csv')
      
      print(tmpoutput_max)
      print(tmpoutput_min)
      print(tmpoutput_mean)
      print(ret_min)
      fwrite(ret_min,tmpoutput_min)
      fwrite(ret_max,tmpoutput_max)
      fwrite(ret_mean,tmpoutput_mean)
      
    }
    
    mapply(cal_fun,eps,j)
  
  }
  
  lapply(target_region,sub_cal_convey)
  
  
  
}
cal_convey_rate_by_region <- function(
  input_file
){
  sub_cal<-function(input){
    input_north = paste0(input,'/output/combine_uptake_rel_by_region/north')
    input_south = paste0(input,'/output/combine_uptake_rel_by_region/south')
    
    input_north_file = list.files(input_north)
    input_south_file = list.files(input_south)
    
    input_north = list.files(input_north,full.names = T)
    input_south = list.files(input_south,full.names = T)
    
    output = paste0(input,'/output/convey_rate_by_region.csv')
    
    inputs = c(input_north,input_south)
    
    groups = c(
      paste0('north_jishui_',c('as','ato','eu')),
      paste0('north_moun_',c('as','ato','eu')),
      paste0('south_jishui_',c('as','ato','eu')),
      paste0('south_moun_',c('as','ato','eu'))
    )
    
    convey_box = 1
    for(i in 1:length(inputs)){
    
      tmpdf = fread(inputs[i])
      if(nrow(tmpdf)==0){
        tmp_convey = data.frame(
          up_region = 1:4,
          convey_rate =0,
          groups = paste0(groups[i],'_',1:4)
        )
      }else{
        tmp_rel = aggregate(tmpdf$release,list(tmpdf$region_id),sum)
        tmp_up = aggregate(tmpdf$uptake,list(tmpdf$region_id),sum)
        
        
        tmp_convey = data.frame(up_region= tmp_rel[,1],
                                convey_rate = abs(tmp_rel[,2])/tmp_up[,2])
        print(tmp_convey)
        
        id = tmp_rel$Group.1
        if(length(id)<4){
          idfull = 1:4
          reid = which(idfull %in% id)
          idfull = idfull[-reid]
          
          rel_lack = rep(0,length(idfull))
          add_mat = data.frame(up_region = idfull,
                               convey_rate = rel_lack)
          tmp_convey = rbind(tmp_convey,add_mat)
          
          reorder = order(tmp_convey[,1])
          tmp_convey = tmp_convey[reorder,]
        }
        
        tmp_convey$groups = paste0(groups[i],'_',tmp_convey$up_region)
        
      }
      convey_box = rbind(convey_box,tmp_convey) 
    }
    convey_box = convey_box[-1,]
    fwrite(convey_box,output)
  }
    
  
  sapply(input_file,sub_cal)
}
cal_convey_rate_by_type <- function(
  
){
  # type only inclues asia, europe, ato, bs
  
  # 1. determine cluster and label df
  outter_cluster_basedon_allpart()
  # 2. calculated uptake rates within each squared region
  source('/home/share/R_project/xinjiang_vapor/cal_uptake_ratio_in_each_squared_region.R')
  mode = c('ato','as','eu')
  system.time(sapply(mode,cal_uptake_ratio_in_each_squared_region))
  
}
cal_dep_by_as_bu_xinjiang_cloud<-function(
  input_ocean_type, # denote land 
  names_o,
  pattern = 'as_bu_xinjiang'
){
  
  type = fread(input_ocean_type)
  type = type[,-1]
  
  ids = as.data.frame(type)[,1]
  xfull <<- df_cal_dep$type
  df_fullid <<- df_cal_dep$type
  names_o <<- names_o # ocean_name
  
  
  group_id <- function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  idsl = group_id(ids)
  # trans df_cal_dep to df_in_ocean / df_in_land
  system.time(df_in<-lapply(idsl,divide_full_as_each_type_cloud))
  df_in = do.call('c',df_in)
  df_cal_dep <<- df_cal_dep[df_in,]
  xfull <<- df_cal_dep$type
  df_fullid <<- df_cal_dep$type
  
  #source('/home/share/R_project/xinjiang_vapor/mask_via_each_ocean_for_contri_cal.R')
  mas_df=mask_via_each_ocean_for_contri_cal_cloud(df_cal_dep,names_o,pattern = pattern)
  input_tmp_masdf = 'tmp/tmp_mas_df.csv'
  fwrite(mas_df,input_tmp_masdf)
  rm(mas_df)
  source('~/search_which_full_as_bu_xinjiang_cloud.R')
  ret_li = lapply(idsl,search_which_full_as_bu_xinjiang_cloud)
  ret_li_source = do.call('rbind',ret_li)
  rm(ret_li)
  rm(df_cal_dep)
  return(ret_li_source)
  
}
cal_dep_by_as_bu_xinjiang<-function(
  input_ocean_type, # denote land 
  names_o,
  pattern = 'as_bu_xinjiang'
){
  
  type = fread(input_ocean_type)
  type = type[,-1]
  
  ids = as.data.frame(type)[,1]
  xfull <<- df_cal_dep$type
  df_fullid <<- df_cal_dep$type
  names_o <<- names_o # ocean_name
  
  
  group_id <- function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  idsl = group_id(ids)
  # trans df_cal_dep to df_in_ocean / df_in_land
  system.time(df_in<-lapply(idsl,divide_full_as_each_type))
  df_in = do.call('c',df_in)
  df_cal_dep <<- df_cal_dep[df_in,]
  xfull <<- df_cal_dep$type
  df_fullid <<- df_cal_dep$type
  
  source('/home/share/R_project/xinjiang_vapor/mask_via_each_ocean_for_contri_cal.R')
  mas_df=mask_via_each_ocean_for_contri_cal(df_cal_dep,names_o,pattern = pattern)
  input_tmp_masdf = 'tmp/tmp_mas_df.csv'
  fwrite(mas_df,input_tmp_masdf)
  rm(mas_df)
  source('/home/share/R_project/xinjiang_vapor/search_which_full_as_bu_xinjiang.R')
  ret_li = lapply(idsl,search_which_full_as_bu_xinjiang)
  ret_li_source = do.call('rbind',ret_li)
  rm(ret_li)
  rm(df_cal_dep)
  return(ret_li_source)
  
}
cal_dep_by_each_source_type_cloud <- function(
  input_data
){
  library(raster)
  library(maps)
  library(maptools)
  library(ggplot2)
  library(reshape2)
  library(RColorBrewer)
  library(data.table)
  library(foreach)
  library(doParallel)
  library(parallel)
  library(snow)
  # source refers to ocean
  sub_cal_dep<-function(
    input_sub
  ){
    # full dep data frame import
    source('~/declare_glob_var_fun_cloud.R')
    declare_glob_var_fun_cloud(input_sub)
    
    # calc_by_ocean
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    
    input_ocean_type = paste0(input_sub,'/df_first_ocean')
    input_ocean_type = paste0(input_ocean_type,'/',oce_names,'.csv')
    source('~/cal_dep_by_ocean.R')
    # shp 
    print('cal_dep_by_each_source_type: start ocean')
    output_path = paste0(input_sub,'/contr_ocean')
    dir.create(output_path)
    output_ocean = paste0(output_path,'/',oce_names,'.csv')
    source('~/cal_dep_by_ocean_cloud.R')
    for(i in 1:length(input_ocean_type)){
      source('~/declare_glob_var_fun_cloud.R')
      declare_glob_var_fun_cloud(input_sub)
      tmpdf = cal_dep_by_ocean_cloud(input_ocean_type[i],oce_names[i])
      fwrite(tmpdf,output_ocean[i])
      rm(tmpdf)
      gc()
      #li = ls()
      #re1 = which(li != "input_sub" & li !='declare_glob_var_fun')
      #rm(list = li[re1])
      print(i)
    }
    print('cal_dep_by_each_source_type: end ocean')
    print('cal_dep_by_each_source_type: start land')
    # lands but asia 
    con_names = c('as','xj','eu','naf','na')
    input_land_type = paste0(input_sub,'/df_first_land')
    input_land_type = paste0(input_land_type,'/',con_names,'.csv')
    
    output_path = paste0(input_sub,'/contr_land')
    dir.create(output_path)
    output_land = paste0(output_path,'/',con_names,'.csv')
    
    for(i in 1:length(input_land_type)){
      source('~/declare_glob_var_fun_cloud.R')
      declare_glob_var_fun_cloud(input_sub)
      if(con_names[i] == 'as'){
        source('~/cal_dep_by_as_bu_xinjiang_cloud.R')
        # as bu xinjiang
        tmpdf = cal_dep_by_as_bu_xinjiang_cloud(input_land_type[i],names_o = 'as',pattern = 'as_bu_xinjiang')
        
      }else if(con_names[i] == 'xj'){
        tmpdf = cal_dep_by_as_bu_xinjiang_cloud(input_land_type[i],names_o = 'xj',pattern = 'xinjiang')
      }else{
        source('~/cal_dep_by_land_cloud.R')
        tmpdf= cal_dep_by_land_cloud(input_land_type[i],con_names[i])
      }
      fwrite(tmpdf,output_land[i])
      rm(tmpdf)
      #li = ls()
      #re1 = which(li != "input_sub" & li !='declare_glob_var_fun')
      #rm(list = li[re1])
      gc()
      print(i)
    }
    print('cal_dep_by_each_source_type: end land')
    
    
    # xinjiang
    
    
    
  }
  
  
  sapply(input_data,sub_cal_dep)
  
}
cal_dep_by_each_source_type <- function(
  input_data
){
  library(raster)
  library(maps)
  library(maptools)
  library(ggplot2)
  library(reshape2)
  library(RColorBrewer)
  library(data.table)
  library(foreach)
  library(doParallel)
  library(parallel)
  library(snow)
  # source refers to ocean
  sub_cal_dep<-function(
    input_sub
  ){
    # full dep data frame import
    source('/home/share/R_project/xinjiang_vapor/declare_glob_var_fun.R')
    declare_glob_var_fun(input_sub)
    
    # calc_by_ocean
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    
    input_ocean_type = paste0(input_sub,'/df_first_ocean')
    input_ocean_type = paste0(input_ocean_type,'/',oce_names,'.csv')
    source('/home/share/R_project/xinjiang_vapor/cal_dep_by_ocean.R')
    # shp 
    print('cal_dep_by_each_source_type: start ocean')
    output_path = paste0(input_sub,'/contr_ocean')
    dir.create(output_path)
    output_ocean = paste0(output_path,'/',oce_names,'.csv')
  
    for(i in 1:length(input_ocean_type)){
      source('/home/share/R_project/xinjiang_vapor/declare_glob_var_fun.R')
      declare_glob_var_fun(input_sub)
      tmpdf = cal_dep_by_ocean(input_ocean_type[i],oce_names[i])
      fwrite(tmpdf,output_ocean[i])
      rm(tmpdf)
      gc()
      #li = ls()
      #re1 = which(li != "input_sub" & li !='declare_glob_var_fun')
      #rm(list = li[re1])
      print(i)
    }
    print('cal_dep_by_each_source_type: end ocean')
    print('cal_dep_by_each_source_type: start land')
    # lands but asia 
    con_names = c('as','xj','eu','naf','na')
    input_land_type = paste0(input_sub,'/df_first_land')
    input_land_type = paste0(input_land_type,'/',con_names,'.csv')
    
    output_path = paste0(input_sub,'/contr_land')
    dir.create(output_path)
    output_land = paste0(output_path,'/',con_names,'.csv')
    
    for(i in 1:length(input_land_type)){
      source('/home/share/R_project/xinjiang_vapor/declare_glob_var_fun.R')
      declare_glob_var_fun(input_sub)
      if(con_names[i] == 'as'){
        source('/home/share/R_project/xinjiang_vapor/cal_dep_by_as_bu_xinjiang.R')
        # as bu xinjiang
        tmpdf = cal_dep_by_as_bu_xinjiang(input_land_type[i],names_o = 'as',pattern = 'as_bu_xinjiang')
        
      }else if(con_names[i] == 'xj'){
        tmpdf = cal_dep_by_as_bu_xinjiang(input_land_type[i],names_o = 'xj',pattern = 'xinjiang')
      }else{
        tmpdf= cal_dep_by_land(input_land_type[i],con_names[i])
      }
      fwrite(tmpdf,output_land[i])
      rm(tmpdf)
      #li = ls()
      #re1 = which(li != "input_sub" & li !='declare_glob_var_fun')
      #rm(list = li[re1])
      gc()
      print(i)
    }
    print('cal_dep_by_each_source_type: end land')
    
    
    # xinjiang
    
  
  
  }
  
  
  sapply(input_data,sub_cal_dep)
  
}
cal_dep_by_land_cloud<-function(
  input_ocean_type, # denote land 
  names_o,
  pattern = 'combine_land'
){
  
  type = fread(input_ocean_type)
  type = type[,-1]
  
  ids = as.data.frame(type)[,1]
  xfull <<- df_cal_dep$type
  df_fullid <<- df_cal_dep$type
  names_o <<- names_o # ocean_name
  
  
  group_id <- function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  idsl = group_id(ids)
  # trans df_cal_dep to df_in_ocean / df_in_land
  system.time(df_in<-lapply(idsl,divide_full_as_each_type_cloud))
  df_in = do.call('c',df_in)
  df_cal_dep <<- df_cal_dep[df_in,]
  xfull <<- df_cal_dep$type
  df_fullid <<- df_cal_dep$type
  
  
  mas_df=mask_via_each_ocean_for_contri_cal_cloud(df_cal_dep,names_o,pattern = 'land')
  input_tmp_masdf = 'tmp/tmp_mas_df.csv'
  fwrite(mas_df,input_tmp_masdf)
  rm(mas_df)
  
  mas_df_route=mask_via_each_ocean_for_contri_cal_cloud(df_cal_dep,names_o,pattern = pattern)
  input_tmp_masdfr = 'tmp/tmp_mas_df_r.csv'
  fwrite(mas_df_route,input_tmp_masdfr)
  rm(mas_df_route)
  
  source('~/search_which_full_acc1_cloud.R')
  ret_li = lapply(idsl,search_which_full_acc1_cloud)
  ret_li = do.call('rbind',ret_li)
  
  rm(df_cal_dep)
  return(ret_li)
  
}
cal_dep_by_land<-function(
  input_ocean_type, # denote land 
  names_o,
  pattern = 'combine_land'
){
  
  type = fread(input_ocean_type)
  type = type[,-1]
  
  ids = as.data.frame(type)[,1]
  xfull <<- df_cal_dep$type
  df_fullid <<- df_cal_dep$type
  names_o <<- names_o # ocean_name
  
  
  group_id <- function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  idsl = group_id(ids)
  # trans df_cal_dep to df_in_ocean / df_in_land
  system.time(df_in<-lapply(idsl,divide_full_as_each_type))
  df_in = do.call('c',df_in)
  df_cal_dep <<- df_cal_dep[df_in,]
  xfull <<- df_cal_dep$type
  df_fullid <<- df_cal_dep$type
  
  
  mas_df=mask_via_each_ocean_for_contri_cal(df_cal_dep,names_o,pattern = 'land')
  input_tmp_masdf = 'tmp/tmp_mas_df.csv'
  fwrite(mas_df,input_tmp_masdf)
  rm(mas_df)
  
  mas_df_route=mask_via_each_ocean_for_contri_cal(df_cal_dep,names_o,pattern = pattern)
  input_tmp_masdfr = 'tmp/tmp_mas_df_r.csv'
  fwrite(mas_df_route,input_tmp_masdfr)
  rm(mas_df_route)
  
  source('/home/share/R_project/xinjiang_vapor/search_which_full_acc1.R')
  ret_li = lapply(idsl,search_which_full_acc1)
  ret_li = do.call('rbind',ret_li)
  
  rm(df_cal_dep)
  return(ret_li)
  
}
cal_dep_by_ocean_cloud<-function(
  input_ocean_type, names_o,
  pattern = 'combine_ocean'
){
  
  type = fread(input_ocean_type)
  type = type[,-1]
  
  ids = as.data.frame(type)[,1]
  xfull <<- df_cal_dep$type
  df_fullid <<- df_cal_dep$type
  names_o <<- names_o # ocean_name
  
  
  group_id <- function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  idsl = group_id(ids)
  # trans df_cal_dep to df_in_ocean / df_in_land
  source('~/divide_full_as_each_type_cloud.R')
  system.time(df_in<-lapply(idsl,divide_full_as_each_type_cloud))
  df_in = do.call('c',df_in)
  df_cal_dep <<- df_cal_dep[df_in,]
  xfull <<- df_cal_dep$type
  df_fullid <<- df_cal_dep$type
  
  
  
  source('~/mask_via_each_ocean_for_contri_cal_cloud.R')
  mas_df = mask_via_each_ocean_for_contri_cal_cloud(df_cal_dep,names_o,pattern = 'ocean')
  input_tmp_masdf = 'tmp/tmp_mas_df.csv'
  fwrite(mas_df,input_tmp_masdf)
  rm(mas_df)
  
  mas_df_route = mask_via_each_ocean_for_contri_cal_cloud(df_cal_dep,names_o,pattern = pattern)
  input_tmp_masdfr = 'tmp/tmp_mas_df_r.csv'
  fwrite(mas_df_route,input_tmp_masdfr)
  rm(mas_df_route)
  #dir.create('tmp')
  
  
  
  source('~/search_which_full_acc1_cloud.R')
  ret_li = lapply(idsl,search_which_full_acc1_cloud)
  ret_li = do.call('rbind',ret_li)
  
  rm(df_cal_dep)
  return(ret_li)
  
  
}
cal_dep_by_ocean<-function(
  input_ocean_type, names_o,
  pattern = 'combine_ocean'
){
  
  type = fread(input_ocean_type)
  type = type[,-1]
  
  ids = as.data.frame(type)[,1]
  xfull <<- df_cal_dep$type
  df_fullid <<- df_cal_dep$type
  names_o <<- names_o # ocean_name
  
  
  group_id <- function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  idsl = group_id(ids)
  # trans df_cal_dep to df_in_ocean / df_in_land
  source('/home/share/R_project/xinjiang_vapor/divide_full_as_each_type.R')
  system.time(df_in<-lapply(idsl,divide_full_as_each_type))
  df_in = do.call('c',df_in)
  df_cal_dep <<- df_cal_dep[df_in,]
  xfull <<- df_cal_dep$type
  df_fullid <<- df_cal_dep$type
  
  
  
  source('/home/share/R_project/xinjiang_vapor/mask_via_each_ocean_for_contri_cal.R')
  mas_df = mask_via_each_ocean_for_contri_cal(df_cal_dep,names_o,pattern = 'ocean')
  input_tmp_masdf = 'tmp/tmp_mas_df.csv'
  fwrite(mas_df,input_tmp_masdf)
  rm(mas_df)
  
  mas_df_route = mask_via_each_ocean_for_contri_cal(df_cal_dep,names_o,pattern = pattern)
  input_tmp_masdfr = 'tmp/tmp_mas_df_r.csv'
  fwrite(mas_df_route,input_tmp_masdfr)
  rm(mas_df_route)
  #dir.create('tmp')
  
  
  
  source('/home/share/R_project/xinjiang_vapor/search_which_full_acc1.R')
  ret_li = lapply(idsl,search_which_full_acc1)
  ret_li = do.call('rbind',ret_li)
  
  rm(df_cal_dep)
  return(ret_li)
  

}
cal_dp_sub_pal<-function(
  x
){
  # sub function of main cal dp whole route mpi
  # to calculate the variation of vapor alongside the transimision route
  library(foreach)
  library(doParallel)
  library(parallel)
  library(snow)
  
  
  idx <<- unique(x$type)
  x <<- x
  pal_cal_by_id <- function(id){
    tmpr = which(x$type == id)
    tmpm = x[tmpr,]
    
    # calculate the variance
    nrows = nrow(tmpm)
    nrowsec = nrows -1
    
    tmpme = tmpm[2:nrows,]
    tmpms = tmpm[1:nrowsec,]
    
    midlong = (tmpme$long + tmpms$long)/2
    midlat = (tmpme$lat + tmpms$lat)/2
    midhei = (tmpme$height + tmpms$height)/2
    
    varep = tmpme$ep - tmpms$ep
    ret_m = data.frame(long = midlong,lat = midlat,height = midhei,varep = varep,
                       type = tmpme$type)
    return(ret_m)
  }
  
  
  ret_mid = lapply(idx,pal_cal_by_id)
  ret_m = do.call('rbind',ret_mid)
  
  #cl = makeCluster(4)
  #clusterExport(cl,c('x','idx'))
  #system.time(
  #  ret_mid <- parLapply(cl,idx,pal_cal_by_id)
  #)
  #stopCluster(cl)
  
  
  return(ret_m)
  
  
  
}
cal_ep_in_source_region<-function(
  mode = 'ato'
){
  
  #mode = c('ato','as','eu')
  #ssp = c('hist','245','585')
  # calculation e minus p based on CMIP6 ss245 and ssp 585
  
  source('/home/share/R_project/xinjiang_vapor/outter_mask_crop_cmip6.R')
  outter_mask_crop_cmip6()
  
  # import and cal the sum of ep in each sub-regions 
  source('/home/share/R_project/xinjiang_vapor/cal_sum_ep.R')
  mode = c('ato','as','eu')
  cal_sum_ep(mode[1])
  mode = c('ato','as','eu')
  cal_sum_ep(mode[2])
  mode = c('ato','as','eu')
  cal_sum_ep(mode[3])
}
cal_eva_in_each_region_based_cmip6 <-function(
  cmip6_model,
  pattern = 'hist_ssp245'
){
  # input_shp
  #
  source('/home/share/R_project/xinjiang_vapor/import_cmip6_combined_.R')
  cmip6_eva = import_cmip6_combined(pattern,'E',cmip6_model)
  cmip6_eva = cmip6_eva *86400 *30.5
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  
  south = shp_management('xinjiang_south')
  north = shp_management('xinjiang_north')
  
  crs(south) = crs(south_moun)
  crs(north) = crs(north_moun)
  
  output = 'eva_in_target_cmip6'
  dir.create(output)
  
  output = paste0(output,'/',pattern)
  dir.create(output)
  
  output = paste0(output,'/',cmip6_model)
  dir.create(output)
  
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  output = paste0(output,'/',files,'.csv')
  
  # cal north
  cal_pr_sum <-function(cmip6_eva,full_shp,shp_moun){
    cmip6_full = crop(cmip6_eva,full_shp)
    
    cmip6_moun = mask(cmip6_full,shp_moun)
    cmip6_moun = as.list(cmip6_moun)
    
    cmip6_full = mask(cmip6_full,full_shp)
    cmip6_full = as.list(cmip6_full)
    
    sum_fun <- function(x){
      xs = cellStats(x,sum,na.rm = T)
      return(xs)
    }
    
    moun_sum = lapply(cmip6_moun,sum_fun)
    full_sum = lapply(cmip6_full,sum_fun)
    
    moun_sum = do.call('c',moun_sum)
    full_sum = do.call('c',full_sum)
    
    jishui_sum = full_sum -moun_sum
    
    return(cbind(moun_sum,jishui_sum))
  }
  
  north_df = cal_pr_sum(cmip6_eva,north,north_moun)
  south_df = cal_pr_sum(cmip6_eva,south,south_moun)
  
  north_moun = data.frame(north_moun =north_df[,1])
  north_jishui = data.frame(north_jishui = north_df[,2])
  
  south_moun = data.frame(south_moun =south_df[,1])
  south_jishui = data.frame(south_jishui = south_df[,2])
  
  fwrite(north_moun,output[1])
  fwrite(north_jishui,output[2])
  fwrite(south_moun,output[3])
  fwrite(south_jishui,output[4])
  
  
  
  
}
cal_evaporation_in_each_region_based_era5 <-function(
  
){
  # input_shp
  
  ear5_eva = data_management(mode = 'era5_e_include_ocean')
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  
  south = shp_management('xinjiang_south')
  north = shp_management('xinjiang_north')
  
  crs(south) = crs(south_moun)
  crs(north) = crs(north_moun)
  
  output = 'evaporation_in_target'
  dir.create(output)
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  output = paste0(output,'/',files,'.csv')
  
  # cal north
  cal_pr_sum <-function(ear5_eva,full_shp,shp_moun){
    era5_full = crop(ear5_eva,full_shp)
    
    era5_moun = mask(era5_full,shp_moun)
    era5_moun = as.list(era5_moun)
    
    era5_full = mask(era5_full,full_shp)
    era5_full = as.list(era5_full)
    
    sum_fun <- function(x){
      xs = cellStats(x,sum,na.rm = T)
      return(xs)
    }
    
    moun_sum = lapply(era5_moun,sum_fun)
    full_sum = lapply(era5_full,sum_fun)
    
    moun_sum = do.call('c',moun_sum)
    full_sum = do.call('c',full_sum)
    
    jishui_sum = full_sum -moun_sum
    
    return(cbind(moun_sum,jishui_sum))
  }
  
  north_df = cal_pr_sum(ear5_eva,north,north_moun)
  south_df = cal_pr_sum(ear5_eva,south,south_moun)
  
  north_moun = data.frame(north_moun =north_df[,1])
  north_jishui = data.frame(north_jishui = north_df[,2])
  
  south_moun = data.frame(south_moun =south_df[,1])
  south_jishui = data.frame(south_jishui = south_df[,2])
  
  fwrite(north_moun,output[1])
  fwrite(north_jishui,output[2])
  fwrite(south_moun,output[3])
  fwrite(south_jishui,output[4])
  
  
  
  
}
cal_increasing_rate_pmedf <- function(df){
  
  id = c('SSP245_PME1','SSP245_PME3',
         'SSP585_PME1','SSP585_PME3')
  c1 = 1
  c2 = 1
  for(i in 1:4){
    tmpid = which(df$type %in% id[i])
    tmpdf = df[tmpid,3]
    
    c12 = (tmpdf[14]- tmpdf[1])/(abs(tmpdf[1]))
    c23 = (tmpdf[33] - tmpdf[1])/abs(tmpdf[1])
    
    c1 = c(c1,round(c12))
    c2 = c(c2,round(c23))
    
  }
  c1 = c1[-1]
  c2 = c2[-1]
  
  retdf1 = data.frame(
    x = rep(7,10),
    label = paste0(c1[1]),
    type = id
  )
  retdf2 = data.frame(
    x = rep(23,10),
    label = paste0(c2,'%'),
    type = id
  )
}
cal_increasing_rate_whole <- function(df,
                                      mode = 'TWS_245')
{
  library(cpm)
  
  if(mode == 'TWS_245'){
    ids = c('SSP245_TWS')
  }else if(mode =='TWS_585'){
    ids = c('SSP585_TWS')
  
  }else if(mode =='SSP245_PME'){
    
    ids = c('SSP245_PME1',
                 'SSP245_PME3')
    
  }else if(mode =='SSP585_PME'){
    ids = c('SSP585_PME1',
            'SSP585_PME3')
  }
  
  c1 = 1
  c2 = 1
  #c3 = 1
  for(i in 1:length(ids)){
    tmpid = which(df$variable == ids[i])
    tmpdf2 = df[tmpid,3]
    
    date = 2018:2050
    pv = data.frame(
      ds = seq(as.Date('2018-01-01'),
               as.Date('2050-01-01'),
               '1 year'),
      y = tmpdf2
    )
    
    #i = 6
    m <- prophet(pv, changepoint.prior.scale = 1.5,
                 n.changepoints = 2)
    forecast <- predict(m, pv)
    plot(m, forecast)+add_changepoints_to_plot(m)
    tmpid = which(pv$ds == m$changepoints[1])
    print(tmpid)
    
    tmp12 = (tmpdf2[tmpid]-tmpdf2[1])/abs(tmpdf2[1])*100
    tmp23 = (tmpdf2[33]-tmpdf2[tmpid])/abs(tmpdf2[1])*100
    #tmp13 = (tmpdf2[33] - tmpdf2[1])/abs(tmpdf2[1])
    diff1 = (tmpdf2[tmpid]-tmpdf2[1])
    diff2 = (tmpdf2[33]-tmpdf2[tmpid])
    #print(mmkTrend(tmpdf2[1:tmpid])$Zc)
    #print(mmkTrend(tmpdf2[tmpid:33])$Zc)
    #print(tmp23)
    c1 = c(c1,round(tmp12))
    c2 = c(c2,round(tmp23))
    #c3 = c(c3,round(tmp13))
    #print(tmp23)
    #print(tmp12)
    #print(tmp13)
  }
  c1 = c1[-1]
  c2 = c2[-1]
  #c3 = c3[-1]
  
  idbig1 = which(c1>0)
  idbig2 = which(c2>0)
  c1[idbig1] = paste0('+',c1[idbig1])
  c2[idbig2] = paste0('+',c2[idbig2])
  
  print(c1)
  retdf1 = data.frame(
    x = rep(7,length(ids)),
    label = paste0('VR: ',c1,'%'),
    variable = ids
  )
  retdf2 = data.frame(
    x = rep(23,length(ids)),
    label = paste0('VR: ',c2,'%'),
    variable = ids
  )
  
  retdf = rbind(retdf1,retdf2)
  
  return(retdf)

  
  
}
cal_increasing_rate <- function(df)
{
  library(cpm)
  c1 = 1
  c2 = 1
  c3 = 1
  ids = paste0('SW',1:10)
  
  for(i in 1:length(ids)){
    tmpid = which(df$variable == ids[i])
    tmpdf2 = df[tmpid,3]
    
    date = 2018:2050
    pv = data.frame(
      ds = seq(as.Date('2018-01-01'),
               as.Date('2050-01-01'),
               '1 year'),
      y = tmpdf2
    )
    
    #i = 6
    #m <- prophet(pv, changepoint.prior.scale = 1.5,
    #             n.changepoints = 2)
    #forecast <- predict(m, pv)
    #plot(m, forecast)+add_changepoints_to_plot(m)
    #tmpid = which(pv$ds == m$changepoints[1])
    #print(tmpid)
    tmpid = 14
    
    tmp12 = (tmpdf2[tmpid]-tmpdf2[1])/abs(tmpdf2[1])*100
    tmp23 = (tmpdf2[33]-tmpdf2[tmpid])/abs(tmpdf2[tmpid])*100
    #tmp13 = (tmpdf2[33] - tmpdf2[1])/abs(tmpdf2[1])
    
    #print(mmkTrend(tmpdf2[1:tmpid])$Zc)
    #print(mmkTrend(tmpdf2[tmpid:33])$Zc)
    #print(tmp23)
    c1 = c(c1,round(tmp12))
    c2 = c(c2,round(tmp23))
    #print(tmp23)
    #print(tmp12)
    #print(tmp13)
  }
  c1 = c1[-1]
  c2 = c2[-1]
  c3 = c3[-1]
  
  idbig1 = which(c1>0)
  idbig2 = which(c2>0)
  c1[idbig1] = paste0('+',c1[idbig1])
  c2[idbig2] = paste0('+',c2[idbig2])
  
  retdf1 = data.frame(
    x = rep(7,10),
    label = paste0('VR: ',c1,'%'),
    variable = paste0('SW',1:10)
  )
  retdf2 = data.frame(
    x = rep(23,10),
    label = paste0('VR: ',c2,'%'),
    variable = paste0('SW',1:10)
  )
  retdf3 = data.frame(
    x = rep(17,10),
    label = paste0(c3,'%'),
    variable = paste0('SW',1:10)
  )
  
  
  retdf = rbind(retdf1,retdf2)
  
  return(list(retdf,retdf3))
  
  
}
cal_mean_e_in_source_based_on_era5 <- function(
  
){
  mode = c('ato','as','eu')
  ###
  source('/home/share/R_project/xinjiang_vapor/sub_cal_mean_eva_in_source.R')
  source('/home/share/R_project/xinjiang_vapor/mask_era5_eva.R')
  
  mask_era5_eva('ato')
  mask_era5_eva('as')
  mask_era5_eva('eu')
  
  mode = c('ato','as','eu')
  system.time(lapply(mode,sub_cal_mean_eva_in_source))
  
  
}
cal_mean_p_in_source_based_on_era5 <- function(
  
){
  mode = c('as','ato','eu')
  source('/home/share/R_project/xinjiang_vapor/sub_cal_mean_pr_in_source.R')
  system.time(lapply(mode,sub_cal_mean_pr_in_source))
  
  
}
cal_mean_peva_for_subwindow <- function(
  
){
  input = 'sub_windows'
  num = 1:19
  input = paste0(input,'/sub_window',num,'.shp')
  
  # tas
  tws = data_management('global_era5_poten_evap')
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  tws = crop(tws,world)
  tws = mask(tws,world)
  
  sub_cal_sum <-function(x){
    x = cellStats(x,'sum')
    return(x)
  }
  trend_fun <-function(x){
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    
    xt = as.numeric(xt)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }
  
  tws_sumt_box = 1
  for(i in 1:19){
    tmpshp = shapefile(input[i])
    crs(tmpshp) = crs(world)
    
    tmptws = crop(tws,tmpshp)
    tmptws = mask(tmptws,tmpshp)
    
    tmptws = as.list(tmptws)
    
    tws_sum = lapply(tmptws,sub_cal_sum)
    tws_sum = do.call('c',tws_sum)
    
    tws_sum = tws_sum[1:174]
    
    tws_sumt = trend_fun(tws_sum)
    
    tws_sumt_box = cbind(tws_sumt_box,tws_sumt)
    print(i)
  }
  
  tws_sumt_box = tws_sumt_box[,-1]
  
  write.csv(tws_sumt_box,
            'analysis_output/poten_eva_subwindow_2003_2017.csv')
  
  
  
}
cal_mean_pme_for_subwindow <- function(
  
){
  input = 'sub_windows'
  num = 1:19
  input = paste0(input,'/sub_window',num,'.shp')
  
  # t
  pr = data_management('era5_pr_include_ocean')
  peva = data_management('global_era5_poten_evap')
  
  pme = pr - peva
  
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  pme = crop(pme,world)
  pme = mask(pme,world)
  
  sub_cal_sum <-function(x){
    x = cellStats(x,'sum')
    return(x)
  }
  trend_fun <-function(x){
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    
    xt = as.numeric(xt)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }
  
  pme_sumt_box = 1
  for(i in 1:19){
    tmpshp = shapefile(input[i])
    crs(tmpshp) = crs(world)
    
    tmppme = crop(pme,tmpshp)
    tmppme = mask(tmppme,tmpshp)
    
    tmppme = as.list(tmppme)
    
    pme_sum = lapply(tmppme,sub_cal_sum)
    pme_sum = do.call('c',pme_sum)
    
    pme_sum = pme_sum[1:174]
    
    pme_sumt = trend_fun(pme_sum)
    
    pme_sumt_box = cbind(pme_sumt_box,pme_sumt)
    print(i)
  }
  
  pme_sumt_box = pme_sumt_box[,-1]
  
  write.csv(pme_sumt_box,
            'analysis_output/pme_subwindow_2003_2017.csv')
  
  
  
}
cal_mean_sst_in_source_based_on_era5<-function(
  
){
  mode = c('as','ato','eu')
  source('/home/share/R_project/xinjiang_vapor/mask_era5_sst.R')
  mask_era5_sst(mode[2])
  
  source('/home/share/R_project/xinjiang_vapor/sub_cal_mean_sst_in_source.R')
  sub_cal_mean_sst_in_source(mode[2])
  
  
  
  
}
cal_mean_tas_for_subwindow <- function(
  
){
  input = 'sub_windows'
  num = 1:19
  input = paste0(input,'/sub_window',num,'.shp')
  
  # tas
  tws = data_management('global_era5_temperature')
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  tws = crop(tws,world)
  tws = mask(tws,world)
  
  sub_cal_sum <-function(x){
    x = cellStats(x,'mean')
    return(x)
  }
  trend_fun <-function(x){
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    
    xt = as.numeric(xt)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }
  
  tws_sumt_box = 1
  for(i in 1:19){
    tmpshp = shapefile(input[i])
    crs(tmpshp) = crs(world)
    
    tmptws = crop(tws,tmpshp)
    tmptws = mask(tmptws,tmpshp)
    
    tmptws = as.list(tmptws)
    
    tws_sum = lapply(tmptws,sub_cal_sum)
    tws_sum = do.call('c',tws_sum)
    
    tws_sum = tws_sum[1:174]
    
    tws_sumt = trend_fun(tws_sum)
    
    tws_sumt_box = cbind(tws_sumt_box,tws_sumt)
    print(i)
  }
  
  tws_sumt_box = tws_sumt_box[,-1]
  
  write.csv(tws_sumt_box,
            'analysis_output/tas_subwindow_2003_2017.csv')
  
  
  
}
cal_mean_temerature_in_source_based_on_era5<-function(
  
){
  mode = c('as','ato','eu')
  source('/home/share/R_project/xinjiang_vapor/mask_era5_temperature.R')
  mask_era5_temperature(mode[1])
  mask_era5_temperature(mode[2])
  mask_era5_temperature(mode[3])
  
  source('/home/share/R_project/xinjiang_vapor/sub_cal_mean_tas_in_source.R')
  lapply(mode,sub_cal_mean_tas_in_source)
  
  
  
  
}
cal_mean_tws_among_windows<-function(
  df,mode = 'mean'
){
  
  id = paste0('SW',1:10)
  if(mode == 'mean'){
    valbox = 1
    for(i in 1:length(id)){
      tmpid = which(df$variable == id[i])
      subval = df[tmpid,3]
      valbox = cbind(valbox,subval)
      date = df[tmpid,1]
      type = df[tmpid,4]
    }
    valbox = valbox[,-1]
    meanbox = apply(valbox,1,mean,na.rm = T)
    meandf = data.frame(
      date = date,
      type = '(a) Mean-TWS-among-SWs',
      value = meanbox,
      variable = type
    )
  }else{
    valbox_max = 1
    valbox_min = 1
    for(i in 1:length(id)){
      tmpid = which(df$variable == id[i])
      subval1 = df[tmpid,3]
      subval2 = df[tmpid,4]
      
      valbox_max = cbind(valbox_max,subval1)
      valbox_min = cbind(valbox_min,subval2)
      
      date = df[tmpid,1]
      type = df[tmpid,5]
    }
    valbox_max = valbox_max[,-1]
    valbox_min = valbox_min[,-1]
    
    valbox_max = apply(valbox_max,1,max,na.rm = T)
    valbox_min = apply(valbox_min,1,min,na.rm = T)
    meandf = data.frame(
      date = date,
      type = '(a) Mean-TWS-among-SWs',
      max = valbox_max,
      min = valbox_min,
      variable = type
    )
  }

  return(meandf)
  
  
}
cal_mean_tws_for_subwindow <- function(
  
){
  input = 'sub_windows'
  num = 1:19
  input = paste0(input,'/sub_window',num,'.shp')
  
  
  # tws
  tws = data_management('grace')
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  tws = crop(tws,world)
  tws = mask(tws,world)
  
  sub_cal_sum <-function(x){
    x = cellStats(x,'sum')
    return(x)
  }
  trend_fun <-function(x){
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    
    xt = as.numeric(xt)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }
  
  tws_sumt_box = 1
  for(i in 1:19){
    tmpshp = shapefile(input[i])
    crs(tmpshp) = crs(world)
    
    tmptws = crop(tws,tmpshp)
    tmptws = mask(tmptws,tmpshp)
    
    tmptws = as.list(tmptws)
    
    tws_sum = lapply(tmptws,sub_cal_sum)
    tws_sum = do.call('c',tws_sum)
    
    tws_sumt = trend_fun(tws_sum)
    
    tws_sumt_box = cbind(tws_sumt_box,tws_sumt)
    print(i)
  }
  
  tws_sumt_box = tws_sumt_box[,-1]
  
  write.csv(tws_sumt_box,'analysis_output/tws_subwindow_2003_2017.csv')
  
  
  
}
cal_mean_tws_monthly_sum_subwins <-function(
  
){
  input_tws_mean = 'analysis_output/fig3/twsmean_mon.csv'
  
  tws_mean = fread(input_tws_mean)
  tws_mean = as.data.frame(tws_mean)
  
  naidtws = which(is.na(tws_mean$JAN))
  tws_mean = tws_mean[-naidtws,]
  
  loc = tws_mean[,1:2]
  loc <<- loc
  
  tws_mean = tws_mean[,-c(1,2)]
  tws_mean <<- tws_mean
  
  #input_shp
  input = 'sub_windows'
  num = 1:19
  input = paste0(input,'/sub_window',num,'.shp')
  
  subs = lapply(input,shapefile)
  subs <<- subs
  sub_cal_mean <-function(i){
    library(raster)
    tmptws = data.frame(
      long = loc[,1],
      lat = loc[,2],
      tws_mean[,i]
    )
    coordinates(tmptws) = ~long+lat
    gridded(tmptws) = T
    tmptws = raster(tmptws)
    tmptws <<- tmptws
    cell_mean_stat <- function(x){
      crops = crop(tmptws,x)  
      masks = mask(crops,x)
      xmean = cellStats(masks,'mean')
      return(xmean)
    }
    
    subs_mean = lapply(subs,cell_mean_stat)
    subs_mean = do.call('c',subs_mean)
    return(subs_mean)
  }
  
  i <<- 1:12
  library(doParallel)
  cl = makeCluster(12)
  clusterExport(cl,c('i','subs','loc','tws_mean'))
  ret_tws_mean = parLapply(cl,i,sub_cal_mean)
  stopCluster(cl)
  
  ret_tws_mean = do.call('cbind',ret_tws_mean)
  colnames(ret_tws_mean) = toupper(month.abb)
  
  df = data.frame(
    SW = paste0('SW',1:19),
    ret_tws_mean
  )
  dfm = reshape2::melt(df,'SW')
  
  dfm$cuts = cut(dfm$value,
                 breaks = seq(-10,10,2))
  dfm$SW = factor(dfm$SW,
                  levels = paste0('SW',1:19))
  ptile = ggplot()+
    geom_tile(data = dfm,aes(x = SW,
                             y = variable,
                             fill = cuts))+
    scale_fill_brewer(palette = 'Spectral')+
    theme_bw()
  
  
}
cal_month_mean_pme_ato <-function(
  
){
  input_pr_ato  = list.files('/media/sdb5/Data/era5_pr_masked/ato',
                             full.names = T)
  input_pr_ato = do.call('c',lapply(input_pr_ato,list.files,
                                    full.names = T))
  
  input_pet_ato = list.files('/media/sdb5/Data/era5_pet_masked/ato',
                             full.names = T)
  input_pet_ato = do.call('c',
                          lapply(input_pet_ato,
                                 list.files,
                                 full.names = T))
  
  pr_ato = lapply(input_pr_ato,stack)
  pet_ato = lapply(input_pet_ato,stack)
  
  pr_ato = do.call('merge',pr_ato)
  pr_ato = pr_ato*30.5
  pet_ato = do.call('merge',pet_ato)
  
  pme_ato = pr_ato - pet_ato
  
  cal_ana_fun<-function(x){
    x = x-mean(x,na.rm = T)
    return(x)
  }
  beginCluster(14)
  pme_ato = clusterR(pme_ato,calc,args = list(fun= cal_ana_fun))
  endCluster()
  
  janid = seq(1,180,12)
  febid = seq(2,180,12)
  marid = seq(3,180,12)
  aprid = seq(4,180,12)
  mayid = seq(5,180,12)
  junid = seq(6,180,12)
  julid = seq(7,180,12)
  augid = seq(8,180,12)
  sepid = seq(9,180,12)
  octid = seq(10,180,12)
  novid = seq(11,180,12)
  decid = seq(12,180,12)
  
  monid = list(janid,febid,marid,aprid,
               mayid,junid,julid,augid,
               sepid,octid,novid,decid)
  
  
  pme_ato <<- pme_ato 
  monid <<- monid
  
  cell_mean_fun_pme <-function(i){
    tmpid = monid[[i]]
    tmppme = pme_ato[[tmpid]]
    
    
    tmppmedf = as.data.frame(tmppme,
                             xy = T)
    loc = tmppmedf[,1:2]
    tmppmedf = tmppmedf[,-c(1,2)]
    
    tmppmedfmean = apply(tmppmedf,1,mean
                       ,na.rm = T)
    retbox = cbind(loc,tmppmedfmean)
    return(retbox)
  }
 
  i = 1:length(monid)
  mon_mean_box = lapply(i,cell_mean_fun_pme)
  
  
  Zpmemean1 = mon_mean_box[[1]]
  pmemean2 = mon_mean_box[[2]][,3]
  pmemean3 = mon_mean_box[[3]][,3]
  pmemean4 = mon_mean_box[[4]][,3]
  pmemean5 = mon_mean_box[[5]][,3]
  pmemean6 = mon_mean_box[[6]][,3]
  pmemean7 = mon_mean_box[[7]][,3]
  pmemean8 = mon_mean_box[[8]][,3]
  pmemean9 = mon_mean_box[[9]][,3]
  pmemean10 = mon_mean_box[[10]][,3]
  pmemean11 = mon_mean_box[[11]][,3]
  pmemean12 = mon_mean_box[[12]][,3]
  
  pmemean_mon = cbind(pmemean1,
                     pmemean2,
                     pmemean3,
                     pmemean4,
                     pmemean5,
                     pmemean6,
                     pmemean7,
                     pmemean8,
                     pmemean9,
                     pmemean10,
                     pmemean11,
                     pmemean12)
  
  
  colnames(pmemean_mon) = c('long','lat',
                           toupper(month.abb))
  dir.create('analysis_output/fig3')
  output = 'analysis_output/fig3/pmemean_mon.csv'
  
  fwrite(pmemean_mon,output)
}
cal_month_mmk_pme_ato <-function(
  
){
  input_pr_ato  = list.files('/media/sdb5/Data/era5_pr_masked/ato',
                             full.names = T)
  input_pr_ato = do.call('c',lapply(input_pr_ato,list.files,
                                    full.names = T))
  
  input_pet_ato = list.files('/media/sdb5/Data/era5_pet_masked/ato',
                             full.names = T)
  input_pet_ato = do.call('c',
                          lapply(input_pet_ato,
                                 list.files,
                                 full.names = T))
  
  pr_ato = lapply(input_pr_ato,stack)
  pet_ato = lapply(input_pet_ato,stack)
  
  pr_ato = do.call('merge',pr_ato)
  pr_ato = pr_ato*30.5
  pet_ato = do.call('merge',pet_ato)
  
  pme_ato = pr_ato - pet_ato

  janid = seq(1,180,12)
  febid = seq(2,180,12)
  marid = seq(3,180,12)
  aprid = seq(4,180,12)
  mayid = seq(5,180,12)
  junid = seq(6,180,12)
  julid = seq(7,180,12)
  augid = seq(8,180,12)
  sepid = seq(9,180,12)
  octid = seq(10,180,12)
  novid = seq(11,180,12)
  decid = seq(12,180,12)
  
  monid = list(janid,febid,marid,aprid,
               mayid,junid,julid,augid,
               sepid,octid,novid,decid)
  
  
  pme_ato <<- pme_ato 
  monid <<- monid
  
  cell_mmk_fun_pme <-function(i){
    tmpid = monid[[i]]
    tmppme = pme_ato[[tmpid]]
    
    
    tmppmedf = as.data.frame(tmppme,
                             xy = T)
    loc = tmppmedf[,1:2]
    tmppmedf = tmppmedf[,-c(1,2)]
    j <<- 1:nrow(tmppmedf)
    tmppmedf <<- tmppmedf
    sub_mmk <-function(j){
      source('/home/share/R_project/xinjiang_vapor/mmk_fundf.R')
      tmp = as.numeric(tmppmedf[j,])
      ret = mmk_fundf(tmp)
      return(ret)
    }
    
    cl = makeCluster(14)
    clusterExport(cl,c('tmppmedf','j'))
    tmppmedfmmk = parLapply(cl,j,sub_mmk)
    stopCluster(cl)
    
    tmppmedfmmk = do.call('c',tmppmedfmmk)
    retbox = cbind(loc,tmppmedfmmk)
    gc()
    return(retbox)
  }
  
  i = 1:length(monid)
  mon_mmk_box = lapply(i,cell_mmk_fun_pme)
  
  
  Zpmemmk1 = mon_mmk_box[[1]]
  pmemmk2 = mon_mmk_box[[2]][,3]
  pmemmk3 = mon_mmk_box[[3]][,3]
  pmemmk4 = mon_mmk_box[[4]][,3]
  pmemmk5 = mon_mmk_box[[5]][,3]
  pmemmk6 = mon_mmk_box[[6]][,3]
  pmemmk7 = mon_mmk_box[[7]][,3]
  pmemmk8 = mon_mmk_box[[8]][,3]
  pmemmk9 = mon_mmk_box[[9]][,3]
  pmemmk10 = mon_mmk_box[[10]][,3]
  pmemmk11 = mon_mmk_box[[11]][,3]
  pmemmk12 = mon_mmk_box[[12]][,3]
  
  pmemmk_mon = cbind(pmemmk1,
                      pmemmk2,
                      pmemmk3,
                      pmemmk4,
                      pmemmk5,
                      pmemmk6,
                      pmemmk7,
                      pmemmk8,
                      pmemmk9,
                      pmemmk10,
                      pmemmk11,
                      pmemmk12)
  
  
  colnames(pmemmk_mon) = c('long','lat',
                            toupper(month.abb))
  dir.create('analysis_output/fig3')
  output = 'analysis_output/fig3/pmemmk_mon.csv'
  
  fwrite(pmemmk_mon,output)
}
cal_pe_in_each_region_based_era5 <-function(
  
){
  # input_shp
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  
  input_pr = 'era5_pr_in_target/'
  input_pr = paste0(input_pr,files,'.csv')
  
  input_ev = 'evaporation_in_target/'
  input_ev = paste0(input_ev,files,'.csv')
  
  output = 'precp_minus_evapor_in_target'
  dir.create(output)
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  output = paste0(output,'/',files,'.csv')
  
  
  for(i in 1:4){
    
    pr = as.data.frame(fread(input_pr[i]))
    ev = as.data.frame(fread(input_ev[i]))
    
    pe = pr[,1] - ev[,1]
    pe = data.frame(pe)
    fwrite(pe,output[i])
  }
  
  
  
}
cal_ponte_evap_in_each_region_based_era5 <-function(
  
){
  # input_shp
  
  ear5_eva = data_management(mode = 'global_era5_poten_evap')
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  
  south = shp_management('xinjiang_south')
  north = shp_management('xinjiang_north')
  
  crs(south) = crs(south_moun)
  crs(north) = crs(north_moun)
  
  output = 'poten_evap_in_target'
  dir.create(output)
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  output = paste0(output,'/',files,'.csv')
  
  # cal north
  cal_pr_sum <-function(ear5_eva,full_shp,shp_moun){
    era5_full = crop(ear5_eva,full_shp)
    
    era5_moun = mask(era5_full,shp_moun)
    era5_moun = as.list(era5_moun)
    
    era5_full = mask(era5_full,full_shp)
    era5_full = as.list(era5_full)
    
    sum_fun <- function(x){
      xs = cellStats(x,sum,na.rm = T)
      return(xs)
    }
    
    moun_sum = lapply(era5_moun,sum_fun)
    full_sum = lapply(era5_full,sum_fun)
    
    moun_sum = do.call('c',moun_sum)
    full_sum = do.call('c',full_sum)
    
    jishui_sum = full_sum -moun_sum
    
    return(cbind(moun_sum,jishui_sum))
  }
  
  north_df = cal_pr_sum(ear5_eva,north,north_moun)
  south_df = cal_pr_sum(ear5_eva,south,south_moun)
  
  north_moun = data.frame(north_moun =north_df[,1])
  north_jishui = data.frame(north_jishui = north_df[,2])
  
  south_moun = data.frame(south_moun =south_df[,1])
  south_jishui = data.frame(south_jishui = south_df[,2])
  
  fwrite(north_moun,output[1])
  fwrite(north_jishui,output[2])
  fwrite(south_moun,output[3])
  fwrite(south_jishui,output[4])
  
  
  
  
}
cal_pr_in_each_region_based_era5 <-function(
  
){
  # input_shp
  
  era5_pr = data_management(mode = 'era5_pr_include_ocean')
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  
  south = shp_management('xinjiang_south')
  north = shp_management('xinjiang_north')
  
  crs(south) = crs(south_moun)
  crs(north) = crs(north_moun)
  
  output = 'era5_pr_in_target'
  dir.create(output)
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  output = paste0(output,'/',files,'.csv')

  # cal north
  cal_pr_sum <-function(era5_pr,full_shp,shp_moun){
    era5_full = crop(era5_pr,full_shp)
    
    era5_moun = mask(era5_full,shp_moun)
    era5_moun = as.list(era5_moun)
    
    era5_full = mask(era5_full,full_shp)
    era5_full = as.list(era5_full)
    
    sum_fun <- function(x){
      xs = cellStats(x,sum,na.rm = T)
      return(xs)
    }
    
    moun_sum = lapply(era5_moun,sum_fun)
    full_sum = lapply(era5_full,sum_fun)
    
    moun_sum = do.call('c',moun_sum)
    full_sum = do.call('c',full_sum)
    
    jishui_sum = full_sum -moun_sum
    
    return(cbind(moun_sum,jishui_sum))
  }
  
  north_df = cal_pr_sum(era5_pr,north,north_moun)
  south_df = cal_pr_sum(era5_pr,south,south_moun)
  
  north_moun = data.frame(north_moun =north_df[,1])
  north_jishui = data.frame(north_jishui = north_df[,2])
  
  south_moun = data.frame(south_moun =south_df[,1])
  south_jishui = data.frame(south_jishui = south_df[,2])
  
  fwrite(north_moun,output[1])
  fwrite(north_jishui,output[2])
  fwrite(south_moun,output[3])
  fwrite(south_jishui,output[4])
  
  
  
  
}
cal_pr_in_each_region_based_gpcc <-function(
  
){
  # input_shp
  
  gpcc_pr = data_management(mode = 'gpcc_full')
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  
  south = shp_management('xinjiang_south')
  north = shp_management('xinjiang_north')
  
  crs(south) = crs(south_moun)
  crs(north) = crs(north_moun)
  
  output = 'gpcc_pr_in_target'
  dir.create(output)
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  output = paste0(output,'/',files,'.csv')
  
  # cal north
  cal_pr_sum <-function(gpcc_pr,full_shp,shp_moun){
    gpcc_full = crop(gpcc_pr,full_shp)
    
    gpcc_moun = mask(gpcc_full,shp_moun)
    gpcc_moun = as.list(gpcc_moun)
    
    gpcc_full = mask(gpcc_full,full_shp)
    gpcc_full = as.list(gpcc_full)
    
    sum_fun <- function(x){
      xs = cellStats(x,sum,na.rm = T)
      return(xs)
    }
    
    moun_sum = lapply(gpcc_moun,sum_fun)
    full_sum = lapply(gpcc_full,sum_fun)
    
    moun_sum = do.call('c',moun_sum)
    full_sum = do.call('c',full_sum)
    
    jishui_sum = full_sum -moun_sum
    
    return(cbind(moun_sum,jishui_sum))
  }
  
  north_df = cal_pr_sum(gpcc_pr,north,north_moun)
  south_df = cal_pr_sum(gpcc_pr,south,south_moun)
  
  north_moun = data.frame(north_moun =north_df[,1])
  north_jishui = data.frame(north_jishui = north_df[,2])
  
  south_moun = data.frame(south_moun =south_df[,1])
  south_jishui = data.frame(south_jishui = south_df[,2])
  
  fwrite(north_moun,output[1])
  fwrite(north_jishui,output[2])
  fwrite(south_moun,output[3])
  fwrite(south_jishui,output[4])
  
  
  
  
}
cal_released_by_type<-function(
  mas_df
){
  mas_df = as.data.frame(mas_df)
  varep <<- mas_df$varep
  type <<- mas_df$type
  sub_cal_released_fun<-function(x){
    tyid = which(type == x)
    tmp = varep[tyid]
    tmps = abs(sum(tmp[which(tmp<0)]))
    return(c(tmps,x))
  }
  
  cl = makeCluster(15)
  clusterExport(cl,c('varep','type'))
  released = parLapply(cl,type,sub_cal_released_fun)
  stopCluster(cl)
  
  re_df = do.call('rbind',released)
  sum_fun_neg<-function(x){
    xs = sum(x[which(x <0)])
  }
  type = as.list(unique(mas_df$type))
  
  
  
  
  return(re_df)
}
cal_released_in_xinjiang_jishui<-function(
  input_path
){
  # calcluation of jishui released vapor in xinjiang
  sub_cal<-function(input){
    library(data.table)
    library(doParallel)
    library(dplyr)
    
    print(paste0('start ',input))
    input_df = paste0(input,'/masked_var_whole_route_mid.csv') 
    df = fread(input_df)
    
    # 1. import shp
    source('/home/share/R_project/xinjiang_vapor/shp_management.R')
    shp_north = shp_management('xinjiang_south')
    ex = extent(shp_north)
    # 2. fileter with shp
    id = which(df[,1]>=ex[1] &
               df[,1]<=ex[2] &
               df[,2]>=ex[3] &
               df[,2]<=ex[4])
    
    df = df[id,]
    
    loc = df[,1:2]
    loc$type = df$type
    
    source('/home/share/R_project/xinjiang_vapor/mask_points_for_south_xinjiang.R')
    system.time(id_south <- mask_points_for_south_xinjiang(loc,pattern = 'xinjiang_jishui_south'))
    
    df_south_in_mountain = df[id_south,]
    df_south_in_jishui = df[-id_south,]
    
    cal_release<-function(x){
      re = sum(x[which(x<0)])
      return(re)
    }
    
    re_in_jishui = aggregate(df_south_in_jishui$varep,
                             list(df_south_in_jishui$type),cal_release)
    re_in_moun = aggregate(df_south_in_mountain$varep,
                           list(df_south_in_mountain$type),cal_release)
    
    id0 = which(re_in_jishui[,2]==0)
    re_in_jishui = re_in_jishui[-id0,]
    colnames(re_in_jishui) = c('type','release')
    
    id0 = which(re_in_moun[,2]==0)
    re_in_moun = re_in_moun[-id0,]
    colnames(re_in_moun) = c('type','release')
    
    output = paste0(input,'/xinjiang_release')
    output_south = paste0(output,'/south')
    
    dir.create(output)
    dir.create(output_south)
    
    output_south_jishui = paste0(output_south,'/jishui_re.csv')
    output_south_moun = paste0(output_south,'/moun_re.csv')
    
    fwrite(re_in_jishui,output_south_jishui)
    fwrite(re_in_moun,output_south_moun)
    
    print(paste0('pass South'))
    gc()
    ##### 
    # North
    df = fread(input_df)
    
    # 1. import shp
    source('/home/share/R_project/xinjiang_vapor/shp_management.R')
    shp_north = shp_management('xinjiang_north')
    ex = extent(shp_north)
    # 2. fileter with shp
    id = which(df[,1]>=ex[1] &
                 df[,1]<=ex[2] &
                 df[,2]>=ex[3] &
                 df[,2]<=ex[4])
    
    df = df[id,]
    
    loc = df[,1:2]
    loc$type = df$type
    
    source('/home/share/R_project/xinjiang_vapor/mask_points_for_south_xinjiang.R')
    system.time(id_north <- mask_points_for_south_xinjiang(loc,pattern = 'xinjiang_jishui_north'))
    
    df_north_in_mountain = df[id_north,]
    df_north_in_jishui = df[-id_north,]
    
    re_in_jishui = aggregate(df_north_in_jishui$varep,
                             list(df_north_in_jishui$type),cal_release)
    re_in_moun = aggregate(df_north_in_mountain$varep,
                           list(df_north_in_mountain$type),cal_release)
    
    id0 = which(re_in_jishui[,2]==0)
    re_in_jishui = re_in_jishui[-id0,]
    colnames(re_in_jishui) = c('type','release')
    
    id0 = which(re_in_moun[,2]==0)
    re_in_moun = re_in_moun[-id0,]
    colnames(re_in_moun) = c('type','release')
  
    output_north = paste0(output,'/north')
    dir.create(output_north)
    
    output_north_jishui = paste0(output_north,'/jishui_re.csv')
    output_north_moun = paste0(output_north,'/moun_re.csv')
    
    fwrite(re_in_jishui,output_north_jishui)
    fwrite(re_in_moun,output_north_moun)
    gc()
    print(paste0('pass North'))
    print(paste0('pass ',input))
  }  
  
  lapply(input_path,sub_cal)
  
  
  
  
}
cal_snowmelt_in_each_region_based_era5 <-function(
  
){
  # input_shp
  
  era5_sm = data_management(mode = 'era5_snowmelt')
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  
  south = shp_management('xinjiang_south')
  north = shp_management('xinjiang_north')
  
  crs(south) = crs(south_moun)
  crs(north) = crs(north_moun)
  
  output = 'snowmelt_in_target'
  dir.create(output)
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  output = paste0(output,'/',files,'.csv')
  
  # cal north
  cal_pr_sum <-function(era5_sm,full_shp,shp_moun){
    era5_full = crop(era5_sm,full_shp)
    
    era5_moun = mask(era5_full,shp_moun)
    era5_moun = as.list(era5_moun)
    
    era5_full = mask(era5_full,full_shp)
    era5_full = as.list(era5_full)
    
    sum_fun <- function(x){
      xs = cellStats(x,sum,na.rm = T)
      return(xs)
    }
    
    moun_sum = lapply(era5_moun,sum_fun)
    full_sum = lapply(era5_full,sum_fun)
    
    moun_sum = do.call('c',moun_sum)
    full_sum = do.call('c',full_sum)
    
    jishui_sum = full_sum -moun_sum
    
    return(cbind(moun_sum,jishui_sum))
  }
  
  north_df = cal_pr_sum(era5_sm,north,north_moun)
  south_df = cal_pr_sum(era5_sm,south,south_moun)
  
  north_moun = data.frame(north_moun =north_df[,1])
  north_jishui = data.frame(north_jishui = north_df[,2])
  
  south_moun = data.frame(south_moun =south_df[,1])
  south_jishui = data.frame(south_jishui = south_df[,2])
  
  fwrite(north_moun,output[1])
  fwrite(north_jishui,output[2])
  fwrite(south_moun,output[3])
  fwrite(south_jishui,output[4])
  
  
  
  
}
cal_subs_tws_his_annual_loss <- function(
  
){
  input_tws = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws = fread(input_tws)
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  tws = as.data.frame(tws)
  tws = tws[,-1]
  twsdf = tws[,id_box]
  colnames(twsdf) = paste0('SW',1:10)
  twsdf <<- twsdf

  twsdf = apply(twsdf,1,mean)
  twsdf= twsdf[1:168]
  
  twsm = matrix(twsdf,nrow = 12)
  twsm = apply(twsm,2,sum,na.rm= T)
  
  tws= (twsm[14]-twsm[1])/abs(twsm[1])
  
}
cal_sum_ep_in_source_based_on_era5 <- function(
  
){
  mode = c('ato','as','eu')
  ###
  source('/home/share/R_project/xinjiang_vapor/mask_era5_e_pr.R')
  system.time(lapply(mode,mask_era5_e_pr))
  
  mode = c('ato','as','eu')
  source('/home/share/R_project/xinjiang_vapor/sub_cal_sum_ep_in_source.R')
  system.time(lapply(mode,sub_cal_sum_ep_in_source))
  
  
}
cal_sum_ep_hist_ssp585 <- function(
  mode = 'ato'
){
  mode <<- mode
  # 1. input file 
  input_file = '/media/root/Shen_drive1/CMIP6_e-p'
  input_file = paste0(input_file,'/',mode)
  
  input_ssp245 = paste0(input_file,'/','hist_ssp245')
  input_ssp585 = paste0(input_file,'/','hist_ssp585')
  
  input_ssp245 = paste0(input_ssp245,'/region',1:4)
  input_ssp585 = paste0(input_ssp585,'/region',1:4)
  
  
  input_ssp245 <<- input_ssp245
  input_ssp585 <<- input_ssp585
  
  i = 1:4
  
  output = 'cmip6_ep_sum'
  dir.create(output)
  
  output = paste0(output,'/',mode)
  
  dir.create(output)
  
  output245 = paste0(output,'/hist_ssp245')
  output585 = paste0(output,'/hist_ssp585')
  
  dir.create(output245)
  dir.create(output585)
  
  output245 = paste0(output245,'/region',1:4)
  output585 = paste0(output585,'/region',1:4)
  
  lapply(output245,dir.create)
  lapply(output585,dir.create)
  
  output245 = paste0(output245,'/sum_ep.csv')
  output585 = paste0(output585,'/sum_ep.csv')
  
  output245 <<- output245
  output585 <<- output585
  
  model_name = list.files('/media/root/Shen_drive1/CMIP6_combined/E/hist_ssp245')
  
  model_name_extract<-function(x){
    x = strsplit(x,'_')[[1]][2]
    return(x)
  }
  
  model_name= sapply(model_name,model_name_extract)
  model_name = as.character(model_name)
  
  model_name <<- model_name
  
  
  sub_cal_sum_ep<-function(i){
    tmpinput245 = list.files(input_ssp245[i],full.names = T)
    tmpinput585 = list.files(input_ssp585[i],full.names = T)
    
    tmpinput245 <<- tmpinput245
    tmpinput585 <<- tmpinput585
    
    j = 1:length(tmpinput585)
    j <<- j
    
    
    
    sub2_cal_sum_ep_ssp585 <- function(j){
      library(raster)
      library(ncdf4)
      library(doParallel)
      tmp = stack(tmpinput585[j])
      tmp = as.list(tmp)
      
      sum_fun <- function(x){
        x = cellStats(x,'sum',na.rm = T)
      }
      
      tmps = lapply(tmp,sum_fun)
      tmps = do.call('c',tmps)
      return(tmps)
    }
    
    
    if(mode =='eu' & i == 4){
      tmpb = 1
      for(j in j){
        if(j == 3){
          library(data.table)
          tmpdf = fread(tmpinput585[3])
          tmpdf = tmpdf[,-c(1,2)]
          sum_fun2 <- function(x){
            x = sum(x,na.rm = T)
          }
          
          tmpdf = apply(tmpdf,2,sum_fun2)
          tmpdf = as.numeric(tmpdf)
        }else{
          tmpdf = sub2_cal_sum_ep_ssp585(j)
        }
        tmpb = cbind(tmpb,tmpdf)
      }
      tmpb = tmpb[,-1]
      colnames(tmpb) = model_name
      fwrite(tmpb,output585[i])
    }else{
      library(doParallel)
      cl = makeCluster(8)
      clusterExport(cl,c('tmpinput585','j'))
      ret = parLapply(cl,j,sub2_cal_sum_ep_ssp585)
      stopCluster(cl)
      
      ret = do.call('cbind',ret)
      
      colnames(ret) = model_name
      fwrite(ret,output585[i])
    }
    
    
    
    
  }
  
  
  sub_cal_sum_ep(1)
  sub_cal_sum_ep(2)
  sub_cal_sum_ep(3)
  sub_cal_sum_ep(4)
  
  print(paste0('pass ',mode))
}
cal_sum_ep <- function(
  mode = 'ato'
){
  mode <<- mode
  # 1. input file 
  input_file = '/media/root/Shen_drive1/CMIP6_e-p'
  input_file = paste0(input_file,'/',mode)
  
  input_ssp245 = paste0(input_file,'/','hist_ssp245')
  input_ssp585 = paste0(input_file,'/','hist_ssp585')

  input_ssp245 = paste0(input_ssp245,'/region',1:4)
  input_ssp585 = paste0(input_ssp585,'/region',1:4)
  
  
  input_ssp245 <<- input_ssp245
  input_ssp585 <<- input_ssp585
  
  i = 1:4
  
  output = 'cmip6_ep_sum'
  dir.create(output)
  
  output = paste0(output,'/',mode)
  
  dir.create(output)
  
  output245 = paste0(output,'/hist_ssp245')
  output585 = paste0(output,'/hist_ssp585')
  
  dir.create(output245)
  dir.create(output585)
  
  output245 = paste0(output245,'/region',1:4)
  output585 = paste0(output585,'/region',1:4)
  
  lapply(output245,dir.create)
  lapply(output585,dir.create)
  
  output245 = paste0(output245,'/sum_ep.csv')
  output585 = paste0(output585,'/sum_ep.csv')
  
  output245 <<- output245
  output585 <<- output585
  
  model_name = list.files('/media/root/Shen_drive1/CMIP6_combined/E/hist_ssp245')
  
  model_name_extract<-function(x){
    x = strsplit(x,'_')[[1]][2]
    return(x)
  }
  
  model_name= sapply(model_name,model_name_extract)
  model_name = as.character(model_name)
  
  model_name <<- model_name
  
  
  sub_cal_sum_ep<-function(i){
    tmpinput245 = list.files(input_ssp245[i],full.names = T)
    tmpinput585 = list.files(input_ssp585[i],full.names = T)
    
    tmpinput245 <<- tmpinput245
    tmpinput585 <<- tmpinput585
    
    j = 1:length(tmpinput245)
    j <<- j
    
    sub2_cal_sum_ep_ssp245 <- function(j){
      library(raster)
      library(ncdf4)
      library(doParallel)
      tmp = stack(tmpinput245[j])
      tmp = as.list(tmp)
      
      sum_fun <- function(x){
        x = cellStats(x,'sum',na.rm = T)
      }
      
      tmps = lapply(tmp,sum_fun)
      tmps = do.call('c',tmps)
      return(tmps)
    }
    
    sub2_cal_sum_ep_ssp585 <- function(j){
      library(raster)
      library(ncdf4)
      library(doParallel)
      tmp = stack(tmpinput585[j])
      tmp = as.list(tmp)
      
      sum_fun <- function(x){
        x = cellStats(x,'sum',na.rm = T)
      }
      
      tmps = lapply(tmp,sum_fun)
      tmps = do.call('c',tmps)
      return(tmps)
    }
    
    if(mode =='eu' & i == 4){
      tmpb = 1
      for(j in j){
        if(j == 3){
          library(data.table)
          tmpdf = fread(tmpinput245[3])
          tmpdf = tmpdf[,-c(1,2)]
          sum_fun2 <- function(x){
            x = sum(x,na.rm = T)
          }
          
          tmpdf = apply(tmpdf,2,sum_fun2)
          tmpdf = as.numeric(tmpdf)
        }else{
          tmpdf = sub2_cal_sum_ep_ssp245(j)
        }
        tmpb = cbind(tmpb,tmpdf)
      }
      tmpb = tmpb[,-1]
      colnames(tmpb) = model_name
      fwrite(tmpb,output245[i])
    }else{
      library(doParallel)
      cl = makeCluster(8)
      clusterExport(cl,c('tmpinput245','j'))
      ret = parLapply(cl,j,sub2_cal_sum_ep_ssp245)
      stopCluster(cl)
      
      ret = do.call('cbind',ret)
      
      colnames(ret) = model_name
      fwrite(ret,output245[i])
      
      
    }
    
    if(mode =='eu' & i == 4){
      tmpb = 1
      for(j in j){
        if(j == 3){
          library(data.table)
          tmpdf = fread(tmpinput585[3])
          tmpdf = tmpdf[,-c(1,2)]
          sum_fun2 <- function(x){
            x = sum(x,na.rm = T)
          }
          
          tmpdf = apply(tmpdf,2,sum_fun2)
          tmpdf = as.numeric(tmpdf)
        }else{
          tmpdf = sub2_cal_sum_ep_ssp585(j)
        }
        tmpb = cbind(tmpb,tmpdf)
      }
      tmpb = tmpb[,-1]
      colnames(tmpb) = model_name
      fwrite(tmpb,output585[i])
    }else{
      library(doParallel)
      cl = makeCluster(8)
      clusterExport(cl,c('tmpinput585','j'))
      ret = parLapply(cl,j,sub2_cal_sum_ep_ssp585)
      stopCluster(cl)
      
      ret = do.call('cbind',ret)
      
      colnames(ret) = model_name
      fwrite(ret,output585[i])
    }
    
    
    
    
  }
  
  
  sub_cal_sum_ep(1)
  sub_cal_sum_ep(2)
  sub_cal_sum_ep(3)
  sub_cal_sum_ep(4)
  
  print(paste0('pass ',mode))
}
cal_sum_eva_in_source_based_on_era5 <- function(
  
){
  mode = c('ato','as','eu')
  ### calculation of precipitation on
  source('/home/share/R_project/xinjiang_vapor/mask_era5_eva.R')
  mask_era5_eva('ato')
  mask_era5_eva('as')
  mask_era5_eva('eu')
  
  #mode = c('ato','as','eu')
  source('/home/share/R_project/xinjiang_vapor/sub_cal_sum_eva_in_source.R')
  system.time(lapply(mode,sub_cal_sum_eva_in_source))
  
  
}
cal_sum_p_in_source_based_on_era5 <- function(
  
){
  mode = c('ato','as','eu')
  ### calculation of precipitation on
  source('/home/share/R_project/xinjiang_vapor/mask_era5_p.R')
  source('/home/share/R_project/xinjiang_vapor/sub_cal_sum_pr_in_source.R')
  
  mask_era5_p('ato')
  mask_era5_p('as')
  mask_era5_p('eu')
  
  mode = c('ato','as','eu')
  system.time(lapply(mode,sub_cal_sum_pr_in_source))
  
  
}
cal_sum_p_in_source_based_on_gpcc <- function(
  
){
  mode = c('ato','as','eu')
  ### calculation of precipitation on
  source('/home/share/R_project/xinjiang_vapor/sub_cal_sum_pr_in_source_based_gpcc.R')
  source('/home/share/R_project/xinjiang_vapor/mask_gpcc_p.R')
  
  mask_gpcc_p('ato')
  mask_gpcc_p('as')
  mask_gpcc_p('eu')
  
  mode = c('ato','as','eu')
  system.time(lapply(mode,sub_cal_sum_pr_in_source_based_gpcc))
  
  
}
cal_sum_pe_in_source_based_on_era5 <- function(
  
){
  mode = c('ato','as','eu')
  ### calculation of precipitation on
  source('/home/share/R_project/xinjiang_vapor/mask_era5_p_er.R')
  source('/home/share/R_project/xinjiang_vapor/sub_cal_mean_pe_in_source.R') 
  system.time(lapply(mode,mask_era5_p_er))
  
  mask_era5_p_er('ato')
  mask_era5_p_er('as')
  mask_era5_p_er('eu')
  
  mode = c('ato','as','eu')
  system.time(lapply(mode,sub_cal_sum_pe_in_source))
  
  
}
cal_sum_poten_evap_in_source_based_on_era5<-function(
  
){
  mode = c('as','ato','eu')
  source('/home/share/R_project/xinjiang_vapor/mask_era5_poten_evap.R')
  mask_era5_poten_evap(mode[1])
  mask_era5_poten_evap(mode[2])
  mask_era5_poten_evap(mode[3])
  
  source('/home/share/R_project/xinjiang_vapor/sub_cal_sum_pet_in_source.R')
  lapply(mode,sub_cal_sum_pet_in_source)
  
  
  
  
}
cal_sum_tws_in_source_based_on_era5 <- function(
  
){
  library(data.table)
  library(raster)
  library(ncdf4)
  mode = c('ato','as','eu')
  ### calculation of precipitation on
  source('/home/share/R_project/xinjiang_vapor/mask_grace_tws.R')
  source('/home/share/R_project/xinjiang_vapor/sub_cal_sum_tws_in_source.R')
  
  mask_grace_tws('ato')
  mask_grace_tws('as')
  mask_grace_tws('eu')
  
  mode = c('ato','as','eu')
  system.time(lapply(mode,sub_cal_sum_tws_in_source))
  
  
}
cal_temp_in_each_region_based_cmip6 <-function(
  cmip6_model,
  pattern = 'hist_ssp245'
){
  # input_shp
  #
  source('/home/share/R_project/xinjiang_vapor/import_cmip6_combined_.R')
  cmip6_temp = import_cmip6_combined(pattern,'T',cmip6_model)
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  
  south = shp_management('xinjiang_south')
  north = shp_management('xinjiang_north')
  
  crs(south) = crs(south_moun)
  crs(north) = crs(north_moun)
  
  output = 'temp_in_target_cmip6'
  dir.create(output)
  
  output = paste0(output,'/',pattern)
  dir.create(output)
  
  output = paste0(output,'/',cmip6_model)
  dir.create(output)
  
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  output = paste0(output,'/',files,'.csv')
  
  # cal north
  cal_pr_sum <-function(cmip6_temp,full_shp,shp_moun){
    cmip6_full = crop(cmip6_temp,full_shp)
    
    cmip6_moun = mask(cmip6_full,shp_moun)
    cmip6_moun = as.list(cmip6_moun)
    
    cmip6_full = mask(cmip6_full,full_shp)
    cmip6_full = as.list(cmip6_full)
    
    sum_fun <- function(x){
      xs = cellStats(x,mean,na.rm = T)
      return(xs)
    }
    
    moun_sum = lapply(cmip6_moun,sum_fun)
    full_sum = lapply(cmip6_full,sum_fun)
    
    moun_sum = do.call('c',moun_sum)
    full_sum = do.call('c',full_sum)
    
    jishui_sum = full_sum -moun_sum
    
    return(cbind(moun_sum,jishui_sum))
  }
  
  north_df = cal_pr_sum(cmip6_temp,north,north_moun)
  south_df = cal_pr_sum(cmip6_temp,south,south_moun)
  
  north_moun = data.frame(north_moun =north_df[,1])
  north_jishui = data.frame(north_jishui = north_df[,2])
  
  south_moun = data.frame(south_moun =south_df[,1])
  south_jishui = data.frame(south_jishui = south_df[,2])
  
  fwrite(north_moun,output[1])
  fwrite(north_jishui,output[2])
  fwrite(south_moun,output[3])
  fwrite(south_jishui,output[4])
  
  
  
  
}
cal_tmean_in_each_region_based_era5 <-function(
  
){
  # input_shp
  
  era5_t = data_management(mode = 'era5_temper')
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  
  south = shp_management('xinjiang_south')
  north = shp_management('xinjiang_north')
  
  crs(south) = crs(south_moun)
  crs(north) = crs(north_moun)
  
  output = 'temperature_in_target'
  dir.create(output)
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  output = paste0(output,'/',files,'.csv')
  
  # cal north
  cal_pr_sum <-function(era5_t,full_shp,shp_moun){
    era5_full = crop(era5_t,full_shp)
    
    era5_moun = mask(era5_full,shp_moun)
    era5_moun = as.list(era5_moun)
    
    era5_full = mask(era5_full,full_shp)
    era5_full = as.list(era5_full)
    
    sum_fun <- function(x){
      xs = cellStats(x,mean,na.rm = T)
      return(xs)
    }
    
    moun_sum = lapply(era5_moun,sum_fun)
    full_sum = lapply(era5_full,sum_fun)
    
    moun_sum = do.call('c',moun_sum)
    full_sum = do.call('c',full_sum)
    
    jishui_sum = full_sum -moun_sum
    
    return(cbind(moun_sum,jishui_sum))
  }
  
  north_df = cal_pr_sum(era5_t,north,north_moun)
  south_df = cal_pr_sum(era5_t,south,south_moun)
  
  north_moun = data.frame(north_moun =north_df[,1])
  north_jishui = data.frame(north_jishui = north_df[,2])
  
  south_moun = data.frame(south_moun =south_df[,1])
  south_jishui = data.frame(south_jishui = south_df[,2])
  
  fwrite(north_moun,output[1])
  fwrite(north_jishui,output[2])
  fwrite(south_moun,output[3])
  fwrite(south_jishui,output[4])
  
  
  
  
}
cal_tws_in_each_region_based_grace <-function(
  
){
  # input_shp
  
  era5_tws = data_management(mode = 'grace')
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  
  south = shp_management('xinjiang_south')
  north = shp_management('xinjiang_north')
  
  crs(south) = crs(south_moun)
  crs(north) = crs(north_moun)
  
  output = 'tws_in_target'
  dir.create(output)
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  output = paste0(output,'/',files,'.csv')
  
  # cal north
  cal_pr_sum <-function(era5_tws,full_shp,shp_moun){
    era5_full = crop(era5_tws,full_shp)
    
    era5_moun = mask(era5_full,shp_moun)
    era5_moun = as.list(era5_moun)
    
    era5_full = mask(era5_full,full_shp)
    era5_full = as.list(era5_full)
    
    sum_fun <- function(x){
      xs = cellStats(x,sum,na.rm = T)
      return(xs)
    }
    
    moun_sum = lapply(era5_moun,sum_fun)
    full_sum = lapply(era5_full,sum_fun)
    
    moun_sum = do.call('c',moun_sum)
    full_sum = do.call('c',full_sum)
    
    jishui_sum = full_sum -moun_sum
    
    return(cbind(moun_sum,jishui_sum))
  }
  
  north_df = cal_pr_sum(era5_tws,north,north_moun)
  south_df = cal_pr_sum(era5_tws,south,south_moun)
  
  north_moun = data.frame(north_moun =north_df[,1])
  north_jishui = data.frame(north_jishui = north_df[,2])
  
  south_moun = data.frame(south_moun =south_df[,1])
  south_jishui = data.frame(south_jishui = south_df[,2])
  
  fwrite(north_moun,output[1])
  fwrite(north_jishui,output[2])
  fwrite(south_moun,output[3])
  fwrite(south_jishui,output[4])
  
  
  
  
}
cal_uptake_ratio_in_each_squared_region<-function(
  mode = 'ato'
){
  
  library(raster)
  library(maps)
  library(maptools)
  library(ggplot2)
  library(reshape2)
  library(RColorBrewer)
  library(data.table)
  library(foreach)
  library(doParallel)
  library(parallel)
  library(snow)
  library(doParallel)
  library(snow)
  library(foreach)
  library(parallel)
  library(factoextra)
  library(vegan)
  library(dplyr)
  library(plyr)
  
  first_files = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
  whole_files = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
  if(mode == 'ato'){
    first_files = paste0(first_files,'/output/contr_released_ocean/')
    #shp = shp_management('ocean',mode)
  }else{
    first_files = paste0(first_files,'/output/contr_released_land/')
    #shp = shp_management('land',mode)
  }
  whole_files = paste0(whole_files,'/output/masked_var_whole_route_mid.csv')
  first_files = paste0(first_files,mode,'.csv')
  
  region_file = paste0('cluster_shp/',mode,'/',mode,1:4,'.shp')
  region_file <<- region_file
  
  
  whole_files <<- whole_files
  first_files <<- first_files
  
  output_file = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
  output_file = paste0(output_file,'/output/convey_rate_df')
  #for(i in 1:length(output_file)){
  #  dir.create(output_file[i])
  #}
  
  output_file = paste0(output_file,'/',mode,'.csv')
  output_file <<- output_file
  i = 1:length(first_files)
  i <<- i
  sub_cal_uptake <- function(i){
    library(dplyr)
    library(data.table)
    library(raster)
    df_whole = fread(whole_files[i])
    df_first = fread(first_files[i])
    df_first$uptake_in_region = NA
    
    regid = as.numeric(unique(df_first$region_label))
    regid = sort(regid)
    
    for(j in regid){
      regionid = which(df_first$region_label == j)
      
      type = df_first$type[regionid]
      
      typeid = which(df_whole$type %in% type)
      
      df_region = df_whole[typeid,]
      
      reg_shp = shapefile(region_file[j])
      reg_shp = extent(reg_shp)
      
      minlong = reg_shp[1]
      maxlong = reg_shp[2]
      minlat = reg_shp[3]
      maxlat = reg_shp[4]
      
      id_in_region = which(df_region[,1]<=maxlong &
              df_region[,1]>=minlong &
              df_region[,2] <=maxlat &
              df_region[,2]>=minlat)
      
      df_in_region = df_region[id_in_region,]
      sum_fun<-function(x){
        x = sum(x,na.rm = T)
        return(x)
      }
      varep_in_region = aggregate(df_in_region$varep,list(df_in_region$type),sum_fun)
      
      first_type_id = which(df_first$type %in% varep_in_region[,1])
      
      df_first$uptake_in_region[first_type_id] = varep_in_region[,2]
      #print(j)
    }
    df_first$convey_rate = abs(df_first$contr_value)/df_first$uptake_in_region
    
    id_pos = which(df_first$uptake_in_region >0)
    df_convey = df_first[id_pos,]
    fwrite(df_convey,output_file[i])
  }
  
  cl = makeCluster(15)
  clusterExport(cl,c('whole_files','first_files','output_file','region_file','i'))
  #system.time(lapply(i,sub_cal_uptake))
  system.time(parLapply(cl,i,sub_cal_uptake))
  stopCluster(cl)
  
}
calc_cluster_traj_with_height<-function(
  
){
  input_files = list.files('/media/sdb1/xinjiang_output_file',
                           full.names = T)
  
  
  input_files <<- input_files
  input_land = paste0(input_files,'/output/contr_released_land')
  input_ocean = paste0(input_files,'/output/contr_released_ocean')
  input_land <<- input_land
  input_ocean <<- input_ocean
  
  output_files = paste0(input_files,'/output/cluster_traj_loc_with_height.csv')
  output_files <<- output_files
  
  library(data.table)
  library(raster)
  library(reshape2)
  
  
  time = c('JAN','FEB','MAR','APR','MAY',"JUN",
           'JUL',"AUG",'SEP','OCT','NOV',"DEC")
  
  i = 1:180
  i <<- i
  cluster_k_mean<-function(i){
    library(data.table)
    library(raster)
    library(dplyr)
    input_sub = paste0(input_files[i],'/output/masked_var_whole_route_mid.csv')
    df = fread(input_sub)
    df = as.data.frame(df)
    
    ret_fun <-function(x){
      len = length(x)
      if(len < 38){
        dif = 38-len 
        addna = rep(NA,dif)
        x = c(x,addna)
      }else if(len > 38){
        return(NULL)
      }
      return(x)
    }
    
    
    long = aggregate(df$long,list(df$type),ret_fun)[,2]
    lat = aggregate(df$lat,list(df$type),ret_fun)[,2]
    height = aggregate(df$height,list(df$type),ret_fun)[,2]
    
    
    dim = dim(long)
    if(length(dim) == 0){
      long = do.call('rbind',long)  
    }
    
    dim = dim(lat)
    if(length(dim) == 0){
      lat = do.call('rbind',lat)  
    }
    
    dim = dim(height)
    if(length(dim) == 0){
      height = do.call('rbind',height)
    }
    
    
    feature= cbind(long,lat,height)
    set.seed(4321)
    cl = kmeans(na.omit(feature),13)
    
    cluster = cl$centers
    fwrite(cluster,output_files[i])
    #print(i)
    return(cluster)
  }
  
  # Calculation of trajectory
  ########
  i1 = seq(1,180,10)
  i2 = seq(10,180,10)
  
  ilist = list()
  for(j in 1:length(i1)){
    ilist[[j]] = i1[j]:i2[j]
  }
  library(doParallel)
  ret_traj_box = list()
  for(j in 1:length(i1)){
    i = ilist[[j]]
    i <<- i
    
    cl = makeCluster(10)
    clusterExport(cl,c('input_files','i','output_files'))
    system.time(ret_traj_loc <- parLapply(cl,i,cluster_k_mean))
    stopCluster(cl)
    
    ret_traj_box = c(ret_traj_box,ret_traj_loc)
    print(j)
  }
  ########
  
  ret_traj_box = lapply(output_files,fread)
  ret_traj_box = lapply(ret_traj_box,as.data.frame)
  
  janid = seq(1,180,12)
  febid = seq(2,180,12)
  marid = seq(3,180,12)
  aprid = seq(4,180,12)
  mayid = seq(5,180,12)
  junid = seq(6,180,12)
  julid = seq(7,180,12)
  augid = seq(8,180,12)
  sepid = seq(9,180,12)
  octid = seq(10,180,12)
  novid = seq(11,180,12)
  decid = seq(12,180,12)
  
  monid = list(janid,febid,marid,aprid,mayid,junid,
               julid,augid,sepid,octid,novid,decid)
  
  ret_traj_box <<- ret_traj_box
  i = 1:12
  i <<- i
  monname = c('JAN','FEB','MAR','APR','MAY',"JUN",
              'JUL',"AUG",'SEP','OCT','NOV',"DEC")
  monname <<- monname
  output_monthly_traj = 'monthly_kmeans_traj_with_height'
  dir.create(output_monthly_traj)
  output_monthly_traj = paste0(output_monthly_traj,'/',
                               monname,'.csv')
  output_monthly_traj <<- output_monthly_traj
  monthly_cluster_loc<-function(i){
    tmpid = monid[[i]]
    traj_mon = ret_traj_box[tmpid]
    traj_mon = do.call('rbind',traj_mon)
    
    cl = kmeans(traj_mon,13)
    
    cluster = cl$centers
    colnames(cluster) = c(paste0('long',1:38),
                          paste0('lat',1:38),
                          paste0('heihgt',1:38))
    
    long = cluster[,1:38]
    lat = cluster[,39:76]
    height = cluster[,77:114]
    
    routeid = 1:13
    
    longdf = data.frame(routeid,long)
    latdf = data.frame(routeid,lat)
    heightdf = data.frame(routeid,height)
    
    
    longdf = reshape2::melt(longdf,'routeid')
    latdf = reshape2::melt(latdf,'routeid')
    heightdf = reshape2::melt(heightdf,'routeid')
    
    retdf = data.frame(routeid = longdf$routeid,
                       variable = longdf$variable,
                       long = longdf$value,
                       lat = latdf$value,
                       height = heightdf$value,
                       month = monname[i])
    fwrite(retdf,output_monthly_traj[i])
    
    return(retdf)
  }
  mon_kmean_traj = lapply(i,monthly_cluster_loc)
  
  traj_df_by_mon = do.call('rbind',mon_kmean_traj)
  traj_df_by_mon$group = paste0(traj_df_by_mon$month,'_',
                                traj_df_by_mon$routeid)
  
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management("world")
  world = crop(world,extent(-180,180,0,90))
  
  xj = shp_management('xinjiang')
  
  library(RColorBrewer)
  mycolor = colorRampPalette(brewer.pal(11,'Spectral'))(12)
  
  
  library(ggplot2)
  # Trajectory Plot
  #####
  p = ggplot()+
    geom_polygon(data = world,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 1)+
    geom_polygon(data = xj,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 1)+
    geom_path(data = traj_df_by_mon,aes(x = long,y = lat,
                                        group = group,
                                        color = month))+
    scale_color_manual(values = mycolor)+
    facet_wrap(~month,nrow = 4)+
    theme_bw()
  #####
  
  #
  
  
  
}
calc_cluster_traj<-function(
  
){
  input_files = list.files('/media/sdb1/xinjiang_output_file',
                           full.names = T)
  
  
  input_files <<- input_files
  input_land = paste0(input_files,'/output/contr_released_land')
  input_ocean = paste0(input_files,'/output/contr_released_ocean')
  input_land <<- input_land
  input_ocean <<- input_ocean
  
  output_files = paste0(input_files,'/output/cluster_traj_loc.csv')
  output_files <<- output_files
  
  library(data.table)
  library(raster)
  library(reshape2)
  
  
  time = c('JAN','FEB','MAR','APR','MAY',"JUN",
           'JUL',"AUG",'SEP','OCT','NOV',"DEC")
  
  i = 1:180
  i <<- i
  cluster_k_mean<-function(i){
    library(data.table)
    library(raster)
    library(dplyr)
    input_sub = paste0(input_files[i],'/output/masked_var_whole_route_mid.csv')
    df = fread(input_sub)
    df = as.data.frame(df)
    
    ret_fun <-function(x){
      len = length(x)
      if(len < 38){
        dif = 38-len 
        addna = rep(NA,dif)
        x = c(x,addna)
      }else if(len > 38){
        return(NULL)
      }
      return(x)
    }
    
    
    long = aggregate(df$long,list(df$type),ret_fun)[,2]
    lat = aggregate(df$lat,list(df$type),ret_fun)[,2]
    
    dim = dim(long)
    if(length(dim) == 0){
      long = do.call('rbind',long)  
    }
    
    dim = dim(lat)
    if(length(dim) == 0){
      lat = do.call('rbind',lat)  
    }
    
    
    feature= cbind(long,lat)
    set.seed(4321)
    cl = kmeans(na.omit(feature),13)
    
    cluster = cl$centers
    fwrite(cluster,output_files[i])
    #print(i)
    return(cluster)
  }
  
  # Calculation of trajectory
  ########
  i1 = seq(1,180,10)
  i2 = seq(10,180,10)
  
  ilist = list()
  for(j in 1:length(i1)){
    ilist[[j]] = i1[j]:i2[j]
  }
  library(doParallel)
  ret_traj_box = list()
  for(j in 1:length(i1)){
    i = ilist[[j]]
    i <<- i
    
    cl = makeCluster(10)
    clusterExport(cl,c('input_files','i','output_files'))
    system.time(ret_traj_loc <- parLapply(cl,i,cluster_k_mean))
    stopCluster(cl)
    
    ret_traj_box = c(ret_traj_box,ret_traj_loc)
    print(j)
  }
  ########
  
  janid = seq(1,180,12)
  febid = seq(2,180,12)
  marid = seq(3,180,12)
  aprid = seq(4,180,12)
  mayid = seq(5,180,12)
  junid = seq(6,180,12)
  julid = seq(7,180,12)
  augid = seq(8,180,12)
  sepid = seq(9,180,12)
  octid = seq(10,180,12)
  novid = seq(11,180,12)
  decid = seq(12,180,12)
  
  monid = list(janid,febid,marid,aprid,mayid,junid,
               julid,augid,sepid,octid,novid,decid)
  
  ret_traj_box <<- ret_traj_box
  i = 1:12
  i <<- i
  monname = c('JAN','FEB','MAR','APR','MAY',"JUN",
              'JUL',"AUG",'SEP','OCT','NOV',"DEC")
  monname <<- monname
  output_monthly_traj = 'monthly_kmeans_traj'
  dir.create(output_monthly_traj)
  output_monthly_traj = paste0(output_monthly_traj,'/',
                               monname,'.csv')
  output_monthly_traj <<- output_monthly_traj
  monthly_cluster_loc<-function(i){
    tmpid = monid[[i]]
    traj_mon = ret_traj_box[tmpid]
    traj_mon = do.call('rbind',traj_mon)
    
    cl = kmeans(traj_mon,13)
    
    cluster = cl$centers
    colnames(cluster) = c(paste0('long',1:38),
                          paste0('lat',1:38))
    
    long = cluster[,1:38]
    lat = cluster[,39:76]
    
    routeid = 1:13
    
    longdf = data.frame(routeid,long)
    latdf = data.frame(routeid,lat)
    
    longdf = reshape2::melt(longdf,'routeid')
    latdf = reshape2::melt(latdf,'routeid')
    
    retdf = data.frame(routeid = longdf$routeid,
                       variable = longdf$variable,
                       long = longdf$value,
                       lat = latdf$value,
                       month = monname[i])
    fwrite(retdf,output_monthly_traj[i])
    
    return(retdf)
  }
  mon_kmean_traj = lapply(i,monthly_cluster_loc)
  
  traj_df_by_mon = do.call('rbind',mon_kmean_traj)
  traj_df_by_mon$group = paste0(traj_df_by_mon$month,'_',
                                traj_df_by_mon$routeid)
  
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management("world")
  world = crop(world,extent(-180,180,0,90))
  
  xj = shp_management('xinjiang')
  
  library(RColorBrewer)
  mycolor = colorRampPalette(brewer.pal(11,'Spectral'))(12)
  
  
  library(ggplot2)
  # Trajectory Plot
  #####
  p = ggplot()+
    geom_polygon(data = world,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 1)+
    geom_polygon(data = xj,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 1)+
    geom_path(data = traj_df_by_mon,aes(x = long,y = lat,
                                        group = group,
                                        color = month))+
    scale_color_manual(values = mycolor)+
    facet_wrap(~month,nrow = 4)+
    theme_bw()
  #####
  
  #
  
  
  
}
calc_each_dqt_group <- function(x){
  xstype = x$type[1]
  xetype = x$type[length(x$type)]
  
  tmpids = min(which(df_full$type ==xstype))
  tmpide = max(which(df_full$type ==xetype))
  
  df_sec <<- df_full[tmpids:tmpide,]
  x<<- x
  idu = unique(x$type)
  
  calc_by_id <- function(id){
    tmpidu = which(x$type == id)
    print(id)
    if(length(tmpidu)==1){
      tmpidfull = which(df_sec$type == id)
      len1 = length(tmpidfull)
      len2 = len1 -1
      tmpdf = df_sec[len2:len1,]
      
      tmpdq = tmpdf$varep[2] - tmpdf$varep[1]
    }else if (length(tmpidu) ==2){
      tmpdf = x[tmpidu,]
      tmpdq = tmpdf$varep[2] - tmpdf$varep[1]
    }else{
      len1 = length(tmpidu)
      len2 = len1 - 1
      tmpdq1 = x$varep[2:len1] # end
      tmpdq2 = x$varep[1:len2] # start
      tmpdq = tmpdq1-tmpdq2
      
    }
    tmpdq = sum(tmpdq)
    return(tmpdq)
  }
  
  cl = makeCluster(detectCores()-2)
  clusterExport(cl,c('df_sec','x'))
  system.time(
    ret_box <- parLapply(cl,idu,calc_by_id)
  )
  stopCluster(cl)
  ret_box = do.call('c',ret_box)
  return(ret_box)
}
calc_long_term_contr_by_month<-function(
  
){
  
  input_files = list.files('/media/sdb1/xinjiang_output_file',
                           full.names = T)
  
  
  input_files <<- input_files
  input_land = paste0(input_files,'/output/contr_released_land')
  input_ocean = paste0(input_files,'/output/contr_released_ocean')
  input_land <<- input_land
  input_ocean <<- input_ocean
  
  time = c('JAN','FEB','MAR','APR','MAY',"JUN",
           'JUL',"AUG",'SEP','OCT','NOV',"DEC")
  
  i = 1:180
  i <<- i
  sub_calc<-function(i){
    library(data.table)
    library(raster)
    
    input_land_sub = list.files(input_land[i],full.names = T)
    input_ocean_sub = list.files(input_ocean[i],full.names = T)
    
    land_df = lapply(lapply(input_land_sub,fread),as.data.frame)
    ocean_df = lapply(lapply(input_ocean_sub,fread),as.data.frame)
    
    filter_col <-function(x){
      if(ncol(x) ==8){
        x = x[,1:7]
      }
      return(x)
    }
    
    land_df = lapply(land_df,filter_col)
    ocean_df = lapply(ocean_df,filter_col)
    
    land_df = do.call('rbind',land_df)
    ocean_df = do.call('rbind',ocean_df)
    
    df = rbind(land_df,ocean_df)
    #df$contr_rate = abs(df$contr_rate)
    
    df$contr_rate[which(df$contr_rate <0)] = 0
    
    df = cbind(df[,1:2],
               contr_rate = df$contr_rate*1000000) # 1 / 1000000
    
    r = raster(nrow = 360,ncol = 720) 
    coordinates(df) = ~ long+lat
    rdf = rasterize(df,r,'contr_rate')
    
    rdf1 = crop(rdf,extent(-180,180,0,90))
    
    return(rdf1)
    
    #df1_df = as.data.frame(rdf1,xy = T)
    #if(i >12){
    #  i = i -12
    #}
    
    
    #df1_df$type = time[i]
    #return(df1_df)
  }
  
  library(data.table)
  library(raster)
  library(reshape2)
  
  
  janid = seq(1,180,12)
  febid = seq(2,180,12)
  marid = seq(3,180,12)
  aprid = seq(4,180,12)
  mayid = seq(5,180,12)
  junid = seq(6,180,12)
  julid = seq(7,180,12)
  augid = seq(8,180,12)
  sepid = seq(9,180,12)
  octid = seq(10,180,12)
  novid = seq(11,180,12)
  decid = seq(12,180,12)
  
  monid = list(janid,febid,marid,aprid,mayid,junid,
               julid,augid,sepid,octid,novid,decid)
  
  
  library(doParallel)
  cl = makeCluster(12)
  clusterExport(cl,c('i',"input_land",'input_ocean'))
  system.time(season_box <- parLapply(cl,i,sub_calc))
  stopCluster(cl)
  
  #season_box = lapply(i,sub_calc)
  season_box = do.call('stack',season_box)
  
  #season_box = season_box *-1
  cell_calc_fun<-function(x){
    xmean = mean(x,na.rm = T)
    return(xmean)
  }
  cell_sum_fun<-function(x){
    xsum = sum(x,na.rm = T)
    return(xsum)
  }
  
  
  jan_contr = calc(season_box[[janid]],
                   cell_calc_fun)
  feb_contr = calc(season_box[[febid]],
                   cell_calc_fun)
  mar_contr = calc(season_box[[marid]],cell_calc_fun)
  apr_contr = calc(season_box[[aprid]],cell_calc_fun)
  may_contr = calc(season_box[[mayid]],cell_calc_fun)
  jun_contr = calc(season_box[[junid]],cell_calc_fun)
  jul_contr = calc(season_box[[julid]],cell_calc_fun)
  aug_contr = calc(season_box[[augid]],cell_calc_fun)
  sep_contr = calc(season_box[[sepid]],cell_calc_fun)
  oct_contr = calc(season_box[[octid]],cell_calc_fun)
  nov_contr = calc(season_box[[novid]],cell_calc_fun)
  dec_contr = calc(season_box[[decid]],cell_calc_fun)
  
  contr_by_month = list(jan_contr,
                         feb_contr,
                         mar_contr,
                         apr_contr,
                         may_contr,
                         jun_contr,
                         jul_contr,
                         aug_contr,
                         sep_contr,
                         oct_contr,
                         nov_contr,
                         dec_contr)
  
  
  contr_by_month = calc(contr_by_month,cell_sum_fun)
  
  
  contr_by_month = lapply(contr_by_month,as.data.frame,
                         xy  =T)
  
  monname = c('JAN','FEB','MAR','APR','MAY',"JUN",
              'JUL',"AUG",'SEP','OCT','NOV',"DEC")
  
  contr_by_month[[1]]$type = monname[1]
  contr_by_month[[2]]$type = monname[2]
  contr_by_month[[3]]$type = monname[3]
  contr_by_month[[4]]$type = monname[4]
  contr_by_month[[5]]$type = monname[5]
  contr_by_month[[6]]$type = monname[6]
  contr_by_month[[7]]$type = monname[7]
  contr_by_month[[8]]$type = monname[8]
  contr_by_month[[9]]$type = monname[9]
  contr_by_month[[10]]$type = monname[10]
  contr_by_month[[11]]$type = monname[11]
  contr_by_month[[12]]$type = monname[12]
  
  contr_by_month = do.call('rbind',contr_by_month)
  mean_df = contr_by_month
  colnames(mean_df) = c('x','y','contr_rate','type')
  
  output = 'analysis_output/mean_contr_raster_bymonth.csv'
  fwrite(mean_df,output)
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
}
calc_long_term_contri <- function(
  
){
  library(raster)
  library(data.table)
  library(reshape2)
  library(dplyr)
  library(doParallel)
  
  input_files = list.files('/media/sdb1/xinjiang_output_file',
                           full.names = T)
  
  
  input_files <<- input_files
  input_land = paste0(input_files,'/output/contr_released_land')
  input_ocean = paste0(input_files,'/output/contr_released_ocean')
  input_land <<- input_land
  input_ocean <<- input_ocean
  
  time = c('JAN','FEB','MAR','APR','MAY',"JUN",
           'JUL',"AUG",'SEP','OCT','NOV',"DEC")
  
  i = 1:180
  i <<- i
  sub_calc<-function(i){
    library(data.table)
    library(raster)
    
    input_land_sub = list.files(input_land[i],full.names = T)
    input_ocean_sub = list.files(input_ocean[i],full.names = T)
    
    land_df = lapply(lapply(input_land_sub,fread),as.data.frame)
    ocean_df = lapply(lapply(input_ocean_sub,fread),as.data.frame)
    
    filter_col <-function(x){
      if(ncol(x) ==8){
        x = x[,1:7]
      }
      return(x)
    }
    
    land_df = lapply(land_df,filter_col)
    ocean_df = lapply(ocean_df,filter_col)
    
    land_df = do.call('rbind',land_df)
    ocean_df = do.call('rbind',ocean_df)
    
    df = rbind(land_df,ocean_df)
    #df$contr_rate = abs(df$contr_rate)
    
    df$contr_rate[which(df$contr_rate <0)] = 0
    
    df = cbind(df[,1:2],
               contr_rate = df$contr_rate*1000000) # 1 / 1000000
    
    r = raster(nrow = 360,ncol = 720) 
    coordinates(df) = ~ long+lat
    rdf = rasterize(df,r,'contr_rate')

    rdf1 = crop(rdf,extent(-180,180,0,90))
    
    return(rdf1)
    
    #df1_df = as.data.frame(rdf1,xy = T)
    #if(i >12){
    #  i = i -12
    #}
    
    
    #df1_df$type = time[i]
    #return(df1_df)
  }
  
  library(data.table)
  library(raster)
  library(reshape2)
  
  library(doParallel)
  cl = makeCluster(12)
  clusterExport(cl,c('i',"input_land",'input_ocean'))
  system.time(season_box <- parLapply(cl,i,sub_calc))
  stopCluster(cl)
  
  #season_box = lapply(i,sub_calc)
  season_box = do.call('stack',season_box)
  
  #season_box = season_box *-1
  cell_calc_fun<-function(x){
    xmean = mean(x,na.rm = T)
    return(xmean)
  }
  cell_sum_fun<-function(x){
    xsum = sum(x,na.rm = T)
    return(xsum)
  }
  
  
  # whole_mean
  mean_dump = calc(season_box,
                   cell_calc_fun)
                   #cell_sum_fun)
  
  mean_df = as.data.frame(mean_dump,xy = T)
  
  colnames(mean_df) = c('x','y','contr_rate') # 1/1000000
  
  #mean_df$cuts = cut(mean_df$contr_rate,
  #                   breaks = c(seq(0,100,10),seq(200,400,50)),right = F)
  
  mean_df$cuts = cut(mean_df$contr_rate,
                     breaks = c(seq(0,5,0.5),15,20,25,30),right = F)
  
  output = 'analysis_output/long_term_mean_contr_raster.csv'
  
  fwrite(mean_df,output)
  
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management("world")
  world = crop(world,extent(-180,180,0,90))
  
  xj = shp_management('xinjiang')
  library(RColorBrewer)
  mycolor = colorRampPalette(brewer.pal(11,'Blues'))(16)
  mycolor = mycolor[3:16]
  
  
  p = ggplot()+
    geom_tile(data = mean_df,aes(x = x,y = y,fill = cuts))+
    geom_polygon(data = world,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 1)+
    geom_polygon(data = xj,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 1)+
    scale_fill_manual(values = mycolor)+
    #facet_wrap(~type,nrow = 4)+
    coord_fixed(1.3)+
    #facet_wrap(~type,nrow = 3,scales = 'free')+
    theme_bw()
  
  return(output)
  
  
  
  
  
}
calc_pme_sst_in_ato13 <- function(
  
){
  # generate subs
  library(raster)
  input_cluster = paste0('cluster_shp/ato/ato',c(1,3),'.shp')
  ato13 = lapply(input_cluster,shapefile)
  ato1 = ato13[[1]]
  ato3 = ato13[[2]]
  
  ce1 = extent(ato1)
  ce11 = extent(ce1[1],ce1[2],ce1[3],20)
  ce12 = extent(ce1[1],ce1[2],20,ce1[4])
  ce3 = extent(ato1)
  ce31 = extent(ce3[1],ce3[2],ce3[3],20)
  ce32 = extent(ce3[1],ce3[2],20,ce3[4])
  
  ato11 = crop(ato1,ce1)
  ato12 = crop(ato1,ce1)
  
  # import raster
}
check_output_number<-function(
  
){
  fp = 'xinjiang[0-9]*'
  file = list.files('/media/sdb1/xinjiang_output_file',pattern = fp,full.names = T)
  
  output = paste0(file,'/output')
  output_box = 1
  for(i in 1:length(file)){
    tmp = list.files(output[i])
    print(length(tmp))
    if(length(tmp)==11){
      output_box  = c(output_box,output[i])
    }
  }
  output_box = output_box[-1]
  #print(length(output_box))
  return(output_box)
}

cluster_basedon_allpart <- function(
  mode = 'ato'
){
  library(raster)
  library(maps)
  library(maptools)
  library(ggplot2)
  library(reshape2)
  library(RColorBrewer)
  library(data.table)
  library(foreach)
  library(doParallel)
  library(parallel)
  library(snow)
  library(doParallel)
  library(snow)
  library(foreach)
  library(parallel)
  library(factoextra)
  library(vegan)
  library(dplyr)
  library(plyr)
  
  files = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
  if(mode == 'ato'){
    files = paste0(files,'/output/contr_released_ocean/')
    #shp = shp_management('ocean',mode)
  }else{
    files = paste0(files,'/output/contr_released_land/')
    #shp = shp_management('land',mode)
  }

  
  
  files = paste0(files,mode,'.csv')
  
  df = lapply(files,fread)
  
  df = do.call('rbind',df)
  
  loc = df[,1:2]
  
  #system.time(ca_clust <- cascadeKM(loc,1,10,iter = 1))
  #cal_best = as.numeric(which.max(ca_clust$results[2,]))
  if(mode != 'eu'){
    minlong = round(min(loc[,1]))-1
    maxlong = round(max(loc[,1]))+1
    midlong = round((maxlong - minlong)/2+minlong)
    
    minlat = round(min(loc[,2]))-1
    maxlat = round(max(loc[,2]))+1
    if(minlat <0){
      minlat = 0
    }
    midlat = round((maxlat - minlat)/2+minlat)
  }else{
    idless100 = which(loc[,1]<(-100))
    locless = loc[idless100,]
    loceu = loc[-idless100,]
    
    minlong = round(min(loceu[,1]))-1
    maxlong = round(max(loceu[,1]))+1
    thlong1 = round((maxlong - minlong)/3+minlong)
    thlong2 = round((maxlong - minlong)*2/3+minlong)
    
    minlat = round(min(loceu[,2]))-1
    maxlat = round(max(loceu[,2]))+1
    if(minlat <0){
      minlat = 0
    }
    
    minlong1 = -180
    maxlong1 = round(max(locless[,1]))+1
    minlat1 = round(min(locless[,2]))-1
    maxlat1 = round(max(locless[,2]))+1
  
  }
  
  library(rgeos)
  library(rgdal)
  library(raster)
  
  # border reset based on points
  reset_border <- function(loc,sx){
    id_loc1 = which(loc[,1]>=sx[1] &
                      loc[,1]<=sx[2]&
                      loc[,2]>=sx[3]&
                      loc[,2]<=sx[4])
    locx = loc[id_loc1,]
    
    minlong = min(locx[,1])
    maxlong = max(locx[,1])
    minlat = min(locx[,2])
    maxlat = max(locx[,2])
    
    sx = extent(minlong,maxlong,
                minlat,maxlat)
    return(sx)
  }
  
  if(mode != "eu"){
    s1 = extent(minlong,midlong,
                minlat,midlat)
    s2 = extent(minlong,midlong,
                midlat,maxlat)
    s3 = extent(midlong,maxlong,
                minlat,midlat)
    s4 = extent(midlong,maxlong,
                midlat,maxlat)
    
    s1 = reset_border(loc,s1)
    s2 = reset_border(loc,s2)
    s3 = reset_border(loc,s3)
    s4 = reset_border(loc,s4)
    
    
    pol1 = as(s1,'SpatialPolygons')
    pol2 = as(s2,'SpatialPolygons')
    pol3 = as(s3,'SpatialPolygons')
    pol4 = as(s4,'SpatialPolygons')
    
    crs(pol1) = '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'
    crs(pol2) = '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'
    crs(pol3) = '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'
    crs(pol4) = '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'
    
    output_shp = 'cluster_shp/'
    output_shp = paste0(output_shp,mode)
    dir.create(output_shp)
    
    outputname = paste0(mode,1:4,'.shp')
    output_shp = paste0(output_shp,'/',outputname)
    
    poly_list = list(pol1,pol2,pol3,pol4)
    for(i in 1:4){
      shapefile(poly_list[[i]],output_shp[i],overwrite = T)
    }
    
    # lable id
    poly_list <<- poly_list
  }else{
    s1 = extent(minlong,thlong1,
                minlat,maxlat)
    s2 = extent(thlong1,thlong2,
                minlat,maxlat)
    s3 = extent(thlong2,maxlong,
                minlat,maxlat)
    s4 = extent(minlong1,maxlong1,
                minlat1,maxlat1)
    
    
    #refit based on points 
    s1 = reset_border(loc,s1)
    s2 = reset_border(loc,s2)
    s3 = reset_border(loc,s3)
    s4 = reset_border(loc,s4)
    
    
    pol1 = as(s1,'SpatialPolygons')
    pol2 = as(s2,'SpatialPolygons')
    pol3 = as(s3,'SpatialPolygons')
    pol4 = as(s4,'SpatialPolygons')
    
    crs(pol1) = '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'
    crs(pol2) = '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'
    crs(pol3) = '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'
    crs(pol4) = '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'
    
    output_shp = 'cluster_shp/'
    output_shp = paste0(output_shp,mode)
    dir.create(output_shp)
    
    outputname = paste0(mode,1:4,'.shp')
    output_shp = paste0(output_shp,'/',outputname)
    
    poly_list = list(pol1,pol2,pol3,pol4)
    for(i in 1:4){
      shapefile(poly_list[[i]],output_shp[i],overwrite = T)
    }
    
    # lable id
    poly_list <<- poly_list
  }
  
  
  label_id <- function(x){
    library(data.table)
    library(raster)
    
    tmpdf = fread(x)
    tmploc = tmpdf[,1:2]
    tmpdf$region_label = NA
    
    regionlabel = 1:4
    for(i in 1:4){
      poly = poly_list[[i]]
      minlong = extent(poly)[1]
      maxlong = extent(poly)[2]
      minlat = extent(poly)[3]
      maxlat = extent(poly)[4]
      
      tmpid = which(tmploc[,1]<=maxlong & tmploc[,1]>=minlong &  tmploc[,2]<=maxlat &
         tmploc[,2]>=minlat)
      
      tmpdf$region_label[tmpid] = regionlabel[i]
    }
    
    fwrite(tmpdf,x)

  }
  
  
  cl = makeCluster(10)
  clusterExport(cl,c('poly_list',"files"))
  system.time(parLapply(cl,files,label_id))
  stopCluster(cl)
  
}

cluster_in_source <- function(
  input_data
){
  library(raster)
  library(maps)
  library(maptools)
  library(ggplot2)
  library(reshape2)
  library(RColorBrewer)
  library(data.table)
  library(foreach)
  library(doParallel)
  library(parallel)
  library(snow)
  cluster_sub<-function(
    input_sub
  ){
    library(doParallel)
    library(snow)
    library(foreach)
    library(parallel)
    library(factoextra)
    library(vegan)
    
    df = fread(paste0(input_sub,'/masked_var_whole_route_mid.csv'))
    df_full_for_cl <<- data.frame(df)
    
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    
    input_path = paste0(input_sub,'/contr_ocean')
    input_ocean = paste0(input_path,'/',oce_names,'.csv')
    output_ocean = paste0(input_sub,'/mean_cluster_route_ocean')
    dir.create(output_ocean)
    output_ocean = paste0(output_ocean,'/',oce_names,'.csv')
    
    
    
    for(i in 1:length(input_ocean)){
      tmp_df = fread(input_ocean[i])
      
      cl_m= tmp_df[,1:2]
      
      #ca_clust = cascadeKM(cl_m,1,10,iter = 100)
      #cal_best = as.numeric(which.max(ca_clust$results[2,]))
      
      cluster_mod = kmeans(cl_m,10)
      cluster = cluster_mod$cluster
      
      tmp_df$cluster = cluster
      clm = 1:10
      
      cl_li = list()
      for(j in 1:length(unique(cluster))){
        idt = which(tmp_df$cluster == clm[j])
        tmpdfs = as.data.frame(tmp_df[idt,])
        cl_li = c(cl_li,list(tmpdfs))
      }
      source('/home/share/R_project/xinjiang_vapor/mean_route_by_cl.R')
      ret_li <- lapply(cl_li,mean_route_by_cl)
      
      ret_li = do.call('rbind',ret_li)
      #print(ret_li)
      fwrite(ret_li,output_ocean[i])
      print(i)
    }
    
    # land 
    con_names = c('as','xj','eu','naf','na')
    input_path = paste0(input_sub,'/contr_land')
    input_land = paste0(input_path,'/',con_names,'.csv')
    output_land = paste0(input_sub,'/mean_cluster_route_land')
    dir.create(output_land)
    output_land = paste0(output_land,'/',con_names,'.csv')
    
    for(i in 1:length(input_land)){
      tmp_df = fread(input_land[i])
      
      cl_m= tmp_df[,1:2]
      
      #ca_clust = cascadeKM(cl_m,1,10,iter = 100)
      #cal_best = as.numeric(which.max(ca_clust$results[2,]))
      
      cluster_mod = kmeans(cl_m,10)
      cluster = cluster_mod$cluster
      
      tmp_df$cluster = cluster
      clm = 1:10
      
      cl_li = list()
      for(j in 1:length(unique(cluster))){
        idt = which(tmp_df$cluster == clm[j])
        tmpdfs = as.data.frame(tmp_df[idt,])
        cl_li = c(cl_li,list(tmpdfs))
      }
      source('/home/share/R_project/xinjiang_vapor/mean_route_by_cl.R')
      ret_li <- lapply(cl_li,mean_route_by_cl)
      
      ret_li = do.call('rbind',ret_li)
      fwrite(ret_li,output_land[i])
      print(i)
    }
    
    
  }
  sapply(input_data,cluster_sub)
}
cluster_sub<-function(
  input_contr,names
){
  # source file
  contr_df = fread(input_contr)
  contr_df = as.data.frame(contr_df)
  
  sum_contr_full = abs(sum(contr_df$contr_rate,na.rm = T))
  library(dplyr)
  #print(names)
  if(nrow(contr_df)>0){
    loc = contr_df[,1:2]
    colnames(loc) = c('long','lat')
    
    
    if(nrow(loc)<50){
      cluster = 1
      contr_df$cluster = cluster
      
      cal_mean_route <- function(x){
        library(dplyr)
        sum_rates = sum(x$contr_rate,na.rm = T)
        
        ids = which(df_full$type %in% x$type)
        df_sce = df_full[ids,]
        df_sce1 = df_sce %>%
          group_by(type) %>%
          mutate(date_id = row_number())
        
        df_sce$date_id = df_sce1$date_id
        rm(df_sce1)
        
        
        mean_fun<-function(x){
          library(cluster)
          x = as.character(x)
          trans_fun<-function(x){
            x = cbind(as.numeric(strsplit(x,'_')[[1]][1]),
                      as.numeric(strsplit(x,'_')[[1]][2]))
            return(x)
          }
          x = do.call('rbind',lapply(x,trans_fun))
          x = data.frame(long = x[,1],lat = x[,2])
          xm = kmeans(x,1)$center
          return(xm)
        }
        
        mean_fun2 <-function(x){
          xm = mean(x,na.rm = T)
          return(xm)
        }
        
        df_sce$longlat = paste0(df_sce$long,'_',df_sce$lat)
        
        #mean_route_loc = aggregate(df_sce$longlat,list(df_sce$date_id),mean_fun)
        #mean_route_loc = mean_route_loc$x
        mean_route_long = aggregate(df_sce$long,list(df_sce$date_id),mean_fun2)[,2]
        mean_route_lat = aggregate(df_sce$lat,list(df_sce$date_id),mean_fun2)[,2]
        mean_route_loc = cbind(mean_route_long,mean_route_lat)
        mean_route_height = aggregate(df_sce$height,list(df_sce$date_id),mean_fun2)[,2]
        
        
        sum_rates = c(sum_rates,rep(NA,length(mean_route_height)-1))
        
        mean_route_df = data.frame(
          long = mean_route_loc[,1],
          lat = mean_route_loc[,2],
          height = mean_route_height,
          contr_rates = sum_rates,
          cluster = x$cluster[1]
        )
        
        return(mean_route_df)
      }
      
      mean_route_li = cal_mean_route(contr_df)
      mean_route_li$source_name = names
      
    }else{
      loc = contr_df[,1:2]
      idname = which(sou_names == names)
      
      best_cl = best_cluster_mat[idname,mon]
      
      print(paste0(names,'_',best_cl))
      mean_best_cl = round(mean(best_cluster_mat[idname,],na.rm = T))
      
      if(is.na(best_cl)){
        best_cl = mean_best_cl
      }
      
      cluster = kmeans(loc,best_cl)
      cluster = cluster$cluster
      
      contr_df$cluster = cluster
      
      # calculation contr_rates for each cluster
      clm = 1:best_cl
      cl_li = list()
      #sum_contr_rates =1
      for(j in 1:length(unique(cluster))){
        idt = which(contr_df$cluster == clm[j])
        tmpdfs = as.data.frame(contr_df[idt,])
        cl_li = c(cl_li,list(tmpdfs))
      }
      
      cl_li <<- cl_li
      
      
      # adding time line label
      
      cal_mean_route <- function(x){
        library(dplyr)
        sum_rates = sum(x$contr_rate,na.rm = T)
        
        ids = which(df_full$type %in% x$type)
        df_sce = df_full[ids,]
        df_sce1 = df_sce %>%
          group_by(type) %>%
          mutate(date_id = row_number())
        
        df_sce$date_id = df_sce1$date_id
        rm(df_sce1)
        
        
        mean_fun<-function(x){
          library(cluster)
          x = as.character(x)
          trans_fun<-function(x){
            x = cbind(as.numeric(strsplit(x,'_')[[1]][1]),
                      as.numeric(strsplit(x,'_')[[1]][2]))
            return(x)
          }
          x = do.call('rbind',lapply(x,trans_fun))
          x = data.frame(long = x[,1],lat = x[,2])
          xm = kmeans(x,1)$center
          return(xm)
        }
        
        mean_fun2 <-function(x){
          xm = mean(x,na.rm = T)
          return(xm)
        }
        
        df_sce$longlat = paste0(df_sce$long,'_',df_sce$lat)
        
        #mean_route_loc = aggregate(df_sce$longlat,list(df_sce$date_id),mean_fun)
        #mean_route_loc = mean_route_loc$x
        mean_route_long = aggregate(df_sce$long,list(df_sce$date_id),mean_fun2)[,2]
        mean_route_lat = aggregate(df_sce$lat,list(df_sce$date_id),mean_fun2)[,2]
        mean_route_loc = cbind(mean_route_long,mean_route_lat)
        mean_route_height = aggregate(df_sce$height,list(df_sce$date_id),mean_fun2)[,2]
        
        
        sum_rates = c(sum_rates,rep(NA,length(mean_route_height)-1))
        
        mean_route_df = data.frame(
          long = mean_route_loc[,1],
          lat = mean_route_loc[,2],
          height = mean_route_height,
          contr_rates = sum_rates,
          cluster = x$cluster[1]
        )
        
        return(mean_route_df)
      }
      
      library(doParallel)
      #cl = makeCluster(15)
      #clusterExport(cl,c("cl_li","df_full"))
      #system.time(mean_route_li <- parLapply(cl,cl_li,cal_mean_route))
      #stopCluster(cl)
      mean_route_li = lapply(cl_li,cal_mean_route)
      mean_route_li = do.call('rbind',mean_route_li)
      
      mean_route_li$source_name = names
    }
    
  }else{
    mean_route_li = NA
  }
  
  return(mean_route_li)
  
  
  
}
cluster_traj_routes<-function(
  input_data
){
  library(dplyr)
  library(data.table)
  sub_cluster<-function(
    input_sub
  ){
    # based on contr_released file 
    print(input_sub)
    source('/home/share/R_project/xinjiang_vapor/cluster_sub.R')
    df = fread(paste0(input_sub,'/masked_var_whole_route_mid.csv'))
    df = as.data.frame(df)
    df_full <<- df
    
    # just calculation routes with contribution rates > 0.01
    con_names = c('as','xj','eu','naf','na')
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    sou_names = c(oce_names,con_names)
    sou_names <<- sou_names
    
    input_land = paste0(input_sub,'/contr_released_land')
    input_land = paste0(input_land,'/',con_names,'.csv')
    
    mon = as.numeric(substr(input_sub,46,47))
    mon <<- mon
    
    best_cluster_mat =fread('analysis_output/best_cluster_each_monh.csv')
    best_cluster_mat = as.matrix(best_cluster_mat)
    best_cluster_mat <<- best_cluster_mat
    
    cluster_fun_each_land<- function(i){
      source('/home/share/R_project/xinjiang_vapor/cluster_sub.R')
      library(data.table)
      if(file.exists(input_land[i])){
        contr_df <- cluster_sub(input_land[i],con_names[i])
        return(contr_df)  
      }
      
    }
    
    input_land <<- input_land
    con_names <<- con_names
    i = 1:length(con_names)
    #i <<- i
    #cl = makeCluster(5)
    #clusterExport(cl,c('i','df_full','input_land','con_names'))
    #system.time(contr_df_land <- parLapply(cl,i,cluster_fun_each_land))
    #stopCluster(cl)
    contr_df_land = lapply(i,cluster_fun_each_land)
    contr_df_land = do.call('rbind',contr_df_land)
    naid = which(is.na(contr_df_land[,1]))
    if(length(naid)!=0){
      contr_df_land = contr_df_land[-naid,]  
    }
    contr_df_land = contr_df_land[-naid,]
    print('pass here 1')
    
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    input_oce = paste0(input_sub,'/contr_released_ocean')
    input_oce = paste0(input_oce,'/',oce_names,'.csv')
    
    
    cluster_fun_each_oce<-function(i){
      source('/home/share/R_project/xinjiang_vapor/cluster_sub.R')
      library(data.table)
      if(file.exists(input_oce[i])){
        contr_df <- cluster_sub(input_oce[i],oce_names[i])
        return(contr_df)  
      }
      
    }
    
    i = 1:length(oce_names)
    #i <<- i
    #input_oce <<- input_oce
    #oce_names <<- oce_names
    
    #cl = makeCluster(4)
    #clusterExport(cl,c('i','df_full','input_oce','oce_names'))
    #system.time(contr_df_oce <- parLapply(cl,i,cluster_fun_each_oce))
    #stopCluster(cl)
    
    contr_df_oce = lapply(i, cluster_fun_each_oce)
    contr_df_oce = do.call('rbind',contr_df_oce)
    naid = which(is.na(contr_df_oce[,1]))
    if(length(naid)!=0){
      contr_df_oce = contr_df_oce[-naid,]  
    }
    
    
    contr_df = rbind(contr_df_oce,contr_df_land)
    print('pass here 2')
    output = paste0(input_sub,'/mean_route_released')
    dir.create(output)
    output = paste0(output,'/mean_route_released.csv')
    
    fwrite(contr_df,output)
    
  } 
  sapply(input_data,sub_cluster)
  
  
}
cluster_whole_time_traj<-function(
  
){
  input_files = list.files('/media/sdb1/xinjiang_output_file',
                           full.names = T)
  input = paste0(input_files,'/output/cluster_traj_loc.csv')
  
  df = lapply(input,fread)
  
  df = lapply(df,as.data.frame)
  
  df = do.call('rbind',df)
  
  set.seed(4321)
  cl = kmeans(df,20)
  
  cluster = cl$centers
  colnames(cluster) = c(paste0('long',1:38),
                        paste0('lat',1:38))
  
  long = cluster[,1:38]
  lat = cluster[,39:76]
  
  
  loc1 = data.frame(long = long[,1],
                    lat = lat[,1])
  loc1 <<- loc1
  con_names = c('as','eu','naf','na')
  oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
  sou_names = toupper(c(con_names,oce_names))
  
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  con_shp = lapply(con_names,shp_management,pattern = 'land')
  oce_shp = lapply(oce_names,shp_management,pattern = 'ocean')
  
  shp_li = c(con_shp,oce_shp)
  shp_li <<- shp_li
  
  
  determine_source<- function(i){
    dfsce = loc1
    coordinates(dfsce) = ~ long+lat
    proj4string(dfsce) = "+proj=longlat +datum=WGS84 +no_defs"
    
    df_m = over(dfsce,shp_li[[i]])
    df_land_index = which(!is.na(df_m[,1]))
    return(df_land_index)
  }
  
  i = 1:length(shp_li)
  
  ret_id = lapply(i,determine_source)
  
  routeid = 1:20
  
  longdf = data.frame(routeid,long)
  latdf = data.frame(routeid,lat)
  
  longdf$region = 'as'
  latdf$region = 'as'
  
  for(i in i){
    rowid = ret_id[[i]]
    longdf$region[rowid] = sou_names[i]
    latdf$region[rowid]= sou_names[i]
  }
  
  longdf$size = 1
  latdf$size = 1
  
  # import contr 
  input_contr_by_sou = 'analysis_output/contr_in_source_variance_new.csv'
  contr_by_sou = as.data.frame(fread(input_contr_by_sou))
  
  sou_names1 = toupper(contr_by_sou[,1])
  contr_by_sou = contr_by_sou[,-1]
  
  contr_by_sou_mean = apply(contr_by_sou,1,mean,na.rm= T)
  contr_by_sou_mean = as.numeric(contr_by_sou_mean)
  
  region_uni = as.character(unique(longdf$region))
  
  for(i in 1:length(region_uni)){
    tmp = region_uni[i]
    iddf = which(longdf$region == tmp)
    id2 = which(sou_names1 == tmp)
    contr = contr_by_sou_mean[id2]
    longdf$size[iddf] = contr
    latdf$size[iddf] = contr
  }
  
  
  longdf = reshape2::melt(longdf,c('routeid','region','size'))
  latdf = reshape2::melt(latdf,c('routeid','region','size'))
  
  retdf = data.frame(routeid = longdf$routeid,
                     region = longdf$region,
                     size = longdf$size,
                     variable = longdf$variable,
                     long = longdf$value,
                     lat = latdf$value)
  
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management("world")
  world = crop(world,extent(-180,180,0,90))
  
  xj = shp_management('xinjiang')
  
  library(RColorBrewer)
  mycolor = colorRampPalette(brewer.pal(11,'Spectral'))(6)
  
  
  library(ggplot2)
  # Trajectory Plot
  sizemanual = c('AS'= 2,
                 'EU'=1.5,
                 'ATO'=1,
                 "CS" = 0.5,
                 "MS" = 0.5,
                 'NA' = 0.25)
  #####
  p = ggplot()+
    geom_polygon(data = world,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 1)+
    geom_polygon(data = xj,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 1)+
    geom_path(data = retdf,aes(x = long,y = lat,
                                        group = routeid,
                                        color = region,
                                        size = region),
              arrow=arrow(angle=30,length=unit(0.1,"inches"),type="closed"))+
    scale_color_manual(values = mycolor)+
    scale_size_manual(values = sizemanual)+
    guides(color = guide_legend(title = 'Route'),
           size = guide_legend(title = 'Route'))+
    #facet_wrap(~routeid,nrow = 4)+
    theme_bw()
  #####
  p
  
  return(retdf)
  
  
}
cmip5_precip<-function(
  
){
  input = '/media/root/ERAin/2019-02-27-Computer_D_backup/CMIP5_downscale/'
  #model = list.files(input,full.names = T)
  model_name = list.files('/media/root/ERAin/Radom_window_code_building/Data/bcsnrd')
  model_name = tolower(model_name)
  
  model = paste0(input,model_name)
  
  model45 = paste0(model,'/rcp45/mon/r1i1p1/pr/')
  model85 = paste0(model,'/rcp85/mon/r1i1p1/pr/')
  xj = shp_management(pattern = 'xinjiang')
  
  ret_box45= 1
  ret_box85 = 1
  for(i in 1:length(model45)){
    files45 = list.files(model45[i],full.names = T)
    files85 = list.files(model85[i],full.names = T)
    
    files45_n = list.files(model45[i])
    files85_n = list.files(model85[i])
    
    startyear = as.numeric(substr(strsplit(files45_n,'_')[[1]][8],1,4))
    if(startyear == 2006){
      loc_202001 = length(2006:2020)*12-11
      loc_205012 = length(2006:2050)*12
    }else{
      loc_202001 = length(2006:2020)*12-11+1
      loc_205012 = length(2006:2050)*12+1
    }
    
    nc45 = stack(files45)
    nc85 = stack(files85)
    
    nc45 = nc45[[loc_202001:loc_205012]]
    nc85 = nc85[[loc_202001:loc_205012]]
    
    nc45 = crop(nc45,xj)
    nc45 = mask(nc45,xj)
    
    nc85 = crop(nc85,xj)
    nc85 = mask(nc85,xj)
    
    mean_cal<-function(x){
      xmean = cellStats(x,'mean')
      return(xmean)
    }
    tmp45 = lapply(as.list(nc45),mean_cal)
    tmp85 = lapply(as.list(nc85),mean_cal)
    
    nc45mean = do.call('c',tmp45)
    nc85mean = do.call('c',tmp85)
    
    ret_box45 = cbind(ret_box45,nc45mean)
    ret_box85 = cbind(ret_box85,nc85mean)
    
  }
  ret_box45 = ret_box45[,-1]
  ret_box85 = ret_box85[,-1]
  
  colnames(ret_box45) = model_name
  colnames(ret_box85) = model_name
  
  fwrite(ret_box45,'analysis_output/cmip45_pr.csv')
  fwrite(ret_box85,'analysis_output/cmip85_pr.csv')
  
}
cmip6_data_prepocess_procedure <-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/cmip6_preprocess_his.R')
  source('/home/share/R_project/xinjiang_vapor/cmip6_preprocess.R')
  mode = 'SST'
  cmip6_preprocess(mode)
  cmip6_preprocess_his(mode)
}
cmip6_extent_check <- function(
  
){
  
  library(raster)
  library(ncdf4)
  input = list.files('/media/root/Shen_drive1/CMIP6/',full.names = T)
  for(i in 1:2){
    files = list.files(input[i],full.names = T)
    files = paste0(files,'/historical')
    
    if(i ==1){
      for(j in 1:length(files)){
        f1 = list.files(files[i],full.names = T)[1]
        f1= stack(f1)
        print(extent(f1))
      }  
    }else if(i==2){
      for(j in 1:length(files)){
        f1 = list.files(files[i],full.names = T)[1]
        f1= stack(f1)
        print(extent(f1))
      }  
    }
    
  }
  
}
cmip6_preprocess_his <- function(
  mode = 'E'
){
  
  input_path = '/media/root/Shen_drive1/CMIP6/'
  input_path = paste0(input_path,'/',mode)
  
  model = list.files(input_path)
  files = list.files(input_path,full.names = T)
  
  files_ssp245 = paste0(files,'/historical')
  
  output_path = paste0('/media/root/Shen_drive1/CMIP6_reorder/',
                       mode)
  dir.create(output_path)
  
  output_path245 = paste0(output_path,'/historical')
 
  dir.create(output_path245)
  
  
  
  
  
  for(i in 2:length(files_ssp245)){
    if(model[i] != 'FGOALS-g3'){
      print(i)
      files_in_name2 = list.files(files_ssp245[i])
      files_in_full2 = list.files(files_ssp245[i],full.names = T)
      
      print(model[i])
      
      if(length(files_in_name2)==1){
        str_date = strsplit(files_in_name2,'_')[[1]][7]
        str_date = strsplit(str_date,'-')
        start_date = str_date[[1]][1]
        end_date = str_date[[1]][2]
        
        date = paste0(start_date,'_',end_date)
      }else{
        str_date = strsplit(files_in_name2[1],'_')[[1]][7]
        str_date = strsplit(str_date,'-')
        start_date = str_date[[1]][1]
        
        str_date = strsplit(files_in_name2[length(files_in_name2)],'_')[[1]][7]
        str_date = strsplit(str_date,'-')
        
        end_date = str_date[[1]][2]
        
        date = paste0(start_date,'_',end_date)
      }
      print(date)
      
      output_name = paste0('his','_',model[i],'_',date)
      output2 = paste0(output_path245,'/',output_name)
      library(raster)
      library(ncdf4)
      dat = try(stack(files_in_full2,varname = 'tos'),
                silent = T)
      if('try-error' %in% class(dat)){
        source('/home/share/R_project/xinjiang_vapor/nc_to_df.R')
        if(length(files_in_full2) == 1){
          dat = nc_open(files_in_full2)
          dat = nc_to_df(dat)
        }else{
          dat_box = 1
          for(j in 1:length(files_in_full2)){
            tmpdat = nc_open(files_in_full2[j])
            tmpdat = nc_to_df(tmpdat)
            if(j == 1){
              dat_box = cbind(dat_box,tmpdat)
            }else{
              tmpdat = tmpdat[,-c(1,2)]
              dat_box = cbind(dat_box,tmpdat)
            }
          }
          dat_box = dat_box[,-1]
          dat = dat_box
        }
        output_name = strsplit(output_name,'_')[[1]]
        final_name = substr(output_name[4],1,6)
        final_name = paste0(final_name,'.csv')
        output_name = paste0(output_name[1],'_',
                             output_name[2],'_',
                             output_name[3],'_',
                             final_name)
        
        output2 = paste0(output_path245,'/',output_name)
        library(data.table)
        fwrite(dat,output2)
        gc()
      }else{
        ex = extent(extent(dat)[1],extent(dat)[2],0,extent(dat)[4])
        dat = crop(dat,ex)
        dat = stack(dat)
        print(ex)
        
        writeRaster(dat,output2,format = 'CDF',overwrite = T)
        gc() 
      }
      
    }
    
  }
  
  
  
}
cmip6_preprocess <- function(
  mode = 'E'
){
  
  input_path = '/media/root/Shen_drive1/CMIP6/'
  input_path = paste0(input_path,'/',mode)
  
  model = list.files(input_path)
  files = list.files(input_path,full.names = T)
  
  files_ssp245 = paste0(files,'/ssp245')
  files_ssp585 = paste0(files,'/ssp585')
  
  output_path = paste0('/media/root/Shen_drive1/CMIP6_reorder/',
                       mode)
  dir.create(output_path)
  
  output_path245 = paste0(output_path,'/ssp245')
  output_path585 = paste0(output_path,'/ssp585')
  
  dir.create(output_path245)
  dir.create(output_path585)
  
  
  
  
  
  for(i in 4:length(files_ssp245)){
    if(model[i] != 'FGOALS-g3'){
      print(i)
      files_in_name2 = list.files(files_ssp245[i])
      files_in_full2 = list.files(files_ssp245[i],full.names = T)
      
      print(model[i])
      
      if(length(files_in_name2)==1){
        str_date = strsplit(files_in_name2,'_')[[1]][7]
        str_date = strsplit(str_date,'-')
        start_date = str_date[[1]][1]
        end_date = str_date[[1]][2]
        
        date = paste0(start_date,'_',end_date)
      }else{
        str_date = strsplit(files_in_name2[1],'_')[[1]][7]
        str_date = strsplit(str_date,'-')
        start_date = str_date[[1]][1]
        
        str_date = strsplit(files_in_name2[length(files_in_name2)],'_')[[1]][7]
        str_date = strsplit(str_date,'-')
        
        end_date = str_date[[1]][2]
        
        date = paste0(start_date,'_',end_date)
      }
      print(date)
      
      output_name = paste0('ssp245','_',model[i],'_',date)
      output2 = paste0(output_path245,'/',output_name)
      library(raster)
      library(ncdf4)
      dat = try(stack(files_in_full2,varname = 'tos'),
                 silent = T)
      if('try-error' %in% class(dat)){
        source('/home/share/R_project/xinjiang_vapor/nc_to_df.R')
        if(length(files_in_full2) == 1){
          dat = nc_open(files_in_full2)
          dat = nc_to_df(dat)
        }else{
          dat_box = 1
          for(j in 1:length(files_in_full2)){
            tmpdat = nc_open(files_in_full2[j])
            tmpdat = nc_to_df(tmpdat)
            if(j == 1){
              dat_box = cbind(dat_box,tmpdat)
            }else{
              tmpdat = tmpdat[,-c(1,2)]
              dat_box = cbind(dat_box,tmpdat)
            }
          }
          dat_box = dat_box[,-1]
          dat = dat_box
        }
        
        output_name = strsplit(output_name,'_')[[1]]
        final_name = substr(output_name[4],1,6)
        final_name = paste0(final_name,'.csv')
        output_name = paste0(output_name[1],'_',
                             output_name[2],'_',
                             output_name[3],'_',
                             final_name)
        
        output2 = paste0(output_path245,'/',output_name)
        library(data.table)
        fwrite(dat,output2)
        gc()
      }else{
        ex = extent(extent(dat)[1],extent(dat)[2],0,extent(dat)[4])
        dat = crop(dat,ex)
        print(ex)
        dat = stack(dat)
        writeRaster(dat,
                    output2,format = 'CDF',
                    overwrite = T)
        gc()
        
      }
      
      
      
      
      
      
      print('_________')
      
      files_in_name5 = list.files(files_ssp585[i])
      files_in_full5 = list.files(files_ssp585[i],full.names = T)
      
      if(length(files_in_name5)==1){
        str_date = strsplit(files_in_name5,'_')[[1]][7]
        str_date = strsplit(str_date,'-')
        start_date = str_date[[1]][1]
        end_date = str_date[[1]][2]
        
        date = paste0(start_date,'_',end_date)
      }else{
        str_date = strsplit(files_in_name5[1],'_')[[1]][7]
        str_date = strsplit(str_date,'-')
        start_date = str_date[[1]][1]
        
        str_date = strsplit(files_in_name5[length(files_in_name5)],'_')[[1]][7]
        str_date = strsplit(str_date,'-')
        
        end_date = str_date[[1]][2]
        
        date = paste0(start_date,'_',end_date)
      }
      
      print(date)
      
      output_name = paste0('ssp585','_',model[i],'_',date)
      output5 = paste0(output_path585,'/',output_name)
      library(raster)
      library(ncdf4)
      
      
      dat = try(stack(files_in_full5,varname = 'tos'),
                silent = T)
      if('try-error' %in% class(dat)){
        if(length(files_in_full5) == 1){
          dat = nc_open(files_in_full5)
          dat = nc_to_df(dat)
        }else{
          dat_box = 1
          for(j in 1:length(files_in_full5)){
            tmpdat = nc_open(files_in_full5[j])
            tmpdat = nc_to_df(tmpdat)
            if(j == 1){
              dat_box = cbind(dat_box,tmpdat)
            }else{
              tmpdat = tmpdat[,-c(1,2)]
              dat_box = cbind(dat_box,tmpdat)
            }
          }
          dat_box = dat_box[,-1]
          dat = dat_box
        }
        
        output_name = strsplit(output_name,'_')[[1]]
        final_name = substr(output_name[4],1,6)
        final_name = paste0(final_name,'.csv')
        output_name = paste0(output_name[1],'_',
                             output_name[2],'_',
                             output_name[3],'_',
                             final_name)
        output5 = paste0(output_path585,'/',output_name)
        library(data.table)
        fwrite(dat,output5)
        gc()
      }else{
        ex = extent(extent(dat)[1],extent(dat)[2],0,extent(dat)[4])
        dat = crop(dat,ex)
        dat = stack(dat)
        print(ex)
        writeRaster(dat,output5,format = 'CDF',overwrite = T)
        gc() 
      }
     
    }
    
  }
    
  
  
}
cmip6_unit_check <- function(
  
){
  
  library(raster)
  library(ncdf4)
  input = list.files('/media/root/Shen_drive1/CMIP6/',full.names = T)
  for(i in 1:2){
    files = list.files(input[i],full.names = T)
    files = paste0(files,'/historical')
    
    if(i ==1){
      for(j in 1:length(files)){
        f1 = list.files(files[i],full.names = T)[1]
        f1= nc_open(f1)
        print(f1$var$evspsbl$units)
      }  
    }else if(i==2){
      for(j in 1:length(files)){
        f1 = list.files(files[i],full.names = T)[1]
        f1= nc_open(f1)
        print(f1$var$pr$units)
      }  
    }

  }
  
}
codes_check <-function(
  
){
  input = '/home/share/R_project/xinjiang_vapor'
  files = list.files(input,pattern = '*.R$',full.names = T)
  a = '1'
  for(i in 1:length(files)){
    tmp = readLines(files[i])
    a = c(a,tmp)
  }
  a = a[-1]
  
  writeLines(a,'/home/share/R_project/xinjiang_vapor/full_codes.R')
}
combine_cmip6_data_his_ssp_sst <- function(
  attrs = 'SST'
){
  input_file = '/media/root/Shen_drive1/CMIP6_2003'
  
  #attr = c('E','Pr','T')
  
  input_file = paste0(input_file,'/',attrs)
  
  input_his = paste0(input_file,'/hist')
  input_ssp245 = paste0(input_file,'/ssp245')
  input_ssp585 = paste0(input_file,'/ssp585')
  
  hist_files = list.files(input_his)
  hist_files_full = list.files(input_his,full.names = T)
  
  ssp245_files = list.files(input_ssp245)
  ssp245_files_full = list.files(input_ssp245,full.names = T)
  
  ssp585_files = list.files(input_ssp585)
  ssp585_files_full = list.files(input_ssp585,full.names = T)
  
  i = 1:length(hist_files)
  
  i <<- i 
  hist_files <<- hist_files
  hist_files_full <<- hist_files_full
  ssp245_files <<- ssp245_files
  ssp245_files_full <<- ssp245_files_full
  ssp585_files <<- ssp585_files
  ssp585_files_full <<- ssp585_files_full
  
  dir.create('/media/root/Shen_drive1/CMIP6_combined')
  output = paste0('/media/root/Shen_drive1/CMIP6_combined',
                  '/',attrs)
  dir.create(output)
  
  output_his245 = paste0(output,'/hist_ssp245') # 2003-201412 201501-2050
  output_his585 = paste0(output,'/hist_ssp585')
  
  dir.create(output_his245)
  dir.create(output_his585)
  
  output_his245 <<- output_his245
  output_his585 <<- output_his585
  
  sub_combine_his_245 <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    
    tmpname = strsplit(hist_files[i],'_')[[1]][2]
    pattern = 'his245_'
    
    
    tmphis = try(stack(hist_files_full[i]),
                 silent = T)
    tmpssp = try(stack(ssp245_files_full[i]),
                 silent = T)
    if('try-error' %in% class(tmphis)|
       'try-error' %in% class(tmpssp)){
      tmphis = fread(hist_files_full[i])
      tmpssp = fread(ssp245_files_full[i])
      tmphis = as.data.frame(tmphis)
      tmpssp = as.data.frame(tmpssp)
      
      loc = tmphis[,1:2]
      tmphis = tmphis[,-c(1,2)]
      tmpssp = tmpssp[,-c(1,2)]
      
      tmpcombine = cbind(tmphis,tmpssp)
      tmpcombine = cbind(loc,tmpcombine)
      
      # area filter
      idloc = which(loc[,2]>=0)
      tmpcombine = tmpcombine[idloc,]
      
      outputname = paste0(pattern,tmpname,'_','200301_','205012.csv')
      output = paste0(output_his245,'/',outputname)
      
      fwrite(tmpcombine,output)
    }else{
      tmpcombine = stack(tmphis,tmpssp)
      outputname = paste0(pattern,tmpname,'_','200301_','205012.nc')
      
      output = paste0(output_his245,'/',outputname)
      
      writeRaster(tmpcombine,output,format = 'CDF',overwrite = T)
      
    }
    
    
  }
  
  sub_combine_his_585 <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    
    tmpname = strsplit(hist_files[i],'_')[[1]][2]
    pattern = 'his585_'
    
    
    tmphis = try(stack(hist_files_full[i]),
                 silent = T)
    tmpssp = try(stack(ssp585_files_full[i]),
                 silent = T)
    
    if('try-error' %in% class(tmphis)|
       'try-error' %in% class(tmpssp)){
      tmphis = fread(hist_files_full[i])
      tmpssp = fread(ssp585_files_full[i])
      
      tmphis = as.data.frame(tmphis)
      tmpssp = as.data.frame(tmpssp)
      
      loc = tmphis[,1:2]
      
      tmphis = tmphis[,-c(1,2)]
      tmpssp = tmpssp[,-c(1,2)]
      
      tmpcombine = cbind(loc,tmphis,tmpssp)
      
      #mask north hemisphere
      idloc = which(loc[,2]>=0)
      
      tmpcombine = tmpcombine[idloc,]
      
      outputname = paste0(pattern,tmpname,'_','200301_','205012.csv')
      output = paste0(output_his585,'/',outputname)
      
      fwrite(tmpcombine,output)
      
    }else{
      tmpcombine = stack(tmphis,tmpssp)
      outputname = paste0(pattern,tmpname,'_','200301_','205012.nc')
      
      output = paste0(output_his585,'/',outputname)
      
      writeRaster(tmpcombine,output,format = 'CDF',overwrite = T)
    }
    
    
    
  }

  library(doParallel)
  
  #cl = makeCluster(8)
  #clusterExport(cl,c("hist_files",'hist_files_full',"ssp245_files","ssp245_files_full",'i','output_ssp245'))
  #system.time(parLapply(cl,i,sub_combine_his_245))
  #stopCluster(cl)
  
  
  cl = makeCluster(8)
  clusterExport(cl,c("hist_files",'hist_files_full',"ssp585_files","ssp585_files_full",'i','output_ssp585'))
  system.time(parLapply(cl,i,sub_combine_his_585))
  stopCluster(cl)
  
  
  
}
combine_cmip6_data_his_ssp <- function(
  attrs = 'E'
){
  input_file = '/media/root/Shen_drive1/CMIP6_2003'
  
  #attr = c('E','Pr','T')
  
  input_file = paste0(input_file,'/',attrs)
  
  input_his = paste0(input_file,'/hist')
  input_ssp245 = paste0(input_file,'/ssp245')
  input_ssp585 = paste0(input_file,'/ssp585')
  
  hist_files = list.files(input_his)
  hist_files_full = list.files(input_his,full.names = T)
  
  ssp245_files = list.files(input_ssp245)
  ssp245_files_full = list.files(input_ssp245,full.names = T)
  
  ssp585_files = list.files(input_ssp585)
  ssp585_files_full = list.files(input_ssp585,full.names = T)
  
  i = 1:length(hist_files)
  
  i <<- i 
  hist_files <<- hist_files
  hist_files_full <<- hist_files_full
  ssp245_files <<- ssp245_files
  ssp245_files_full <<- ssp245_files_full
  ssp585_files <<- ssp585_files
  ssp585_files_full <<- ssp585_files_full
  
  dir.create('/media/root/Shen_drive1/CMIP6_combined')
  output = paste0('/media/root/Shen_drive1/CMIP6_combined',
                  '/',attrs)
  dir.create(output)
  
  output_his245 = paste0(output,'/hist_ssp245') # 2003-201412 201501-2050
  output_his585 = paste0(output,'/hist_ssp585')
  
  dir.create(output_his245)
  dir.create(output_his585)
  
  output_his245 <<- output_his245
  output_his585 <<- output_his585
  
  sub_combine_his_245 <- function(i){
    library(raster)
    library(ncdf4)
    
    tmpname = strsplit(hist_files[i],'_')[[1]][2]
    pattern = 'his245_'
    
    outputname = paste0(pattern,tmpname,'_','200301_','205012.nc')
    
    tmphis = stack(hist_files_full[i])
    tmpssp = stack(ssp245_files_full[i])
    
    tmpcombine = stack(tmphis,tmpssp)
    
    output = paste0(output_his245,'/',outputname)
    
    writeRaster(tmpcombine,output,format = 'CDF',overwrite = T)
    
  }
  
  sub_combine_his_585 <- function(i){
    library(raster)
    library(ncdf4)
    
    tmpname = strsplit(hist_files[i],'_')[[1]][2]
    pattern = 'his585_'
    
    outputname = paste0(pattern,tmpname,'_','200301_','205012.nc')
    
    tmphis = stack(hist_files_full[i])
    tmpssp = stack(ssp585_files_full[i])
    
    tmpcombine = stack(tmphis,tmpssp)
    
    output = paste0(output_his585,'/',outputname)
    
    writeRaster(tmpcombine,output,format = 'CDF',overwrite = T)
    
  }
  
  library(doParallel)
  
  #cl = makeCluster(8)
  #clusterExport(cl,c("hist_files",'hist_files_full',"ssp245_files","ssp245_files_full",'i','output_ssp245'))
  #system.time(parLapply(cl,i,sub_combine_his_245))
  #stopCluster(cl)
  
  
  cl = makeCluster(8)
  clusterExport(cl,c("hist_files",'hist_files_full',"ssp585_files","ssp585_files_full",'i','output_ssp585'))
  system.time(parLapply(cl,i,sub_combine_his_585))
  stopCluster(cl)
  
  
  
}
contr_bar_stat<-function(
  
){
  
  contr = fread('analysis_output/contr_in_source_variance_new.csv')
  contr = as.data.frame(contr)
  
  sou_names = contr[,1]
  contr = contr[,-1]
  
  sub_contr<-function(x){
    
    x = matrix(x,nrow = 12)
    mean_fun <-function(x){
      xm = mean(x,na.rm = T)
      return(xm)
    }
    xm = apply(x,1,mean_fun)
  }
  
  x = data.frame(x,x_mean = xmean)
  colnames(x) = c(paste0("year",2003:2017),'xmean')
  mon = factor(1:12)
  
  xm = data.frame(mon,x)
  xm = melt(xm,'mon')
  pbar = ggplot()+
    geom_tile(data = xm,aes(x = variable, y = mon,fill = value))+
    scale_fill_distiller(palette = 'Spectral')+
    theme_bw()+
    theme(
      panel.background = element_rect(fill = 'transparent'),
      axis.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      axis.title = element_text(color = 'black',size = 14,face = 'bold',hjust = 0.5),
      legend.position = 'bottom',
      legend.direction = 'horizontal',
      legend.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      legend.title = element_text(color = 'black',size = 14, face = 'bold',hjust = 0.5),
      strip.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5)
    )+
    guides(color = guide_legend(nrow = 1))
}
contribution_ratio_cal<-function(
  input_data
){
  
  sub_cal<-function(
    input_sub
  ){
    df = fread(paste0(input_sub,'/var_whole_route_mid.csv'))
    
    # ocean 
    id_ocean_p = paste0(input_sub,'/df_first_ocean')
    id_ocean_p = list.files(id_ocean_p,full.names = T)
    
    id_li = list()
    for(i in 1:length(id_ocean_p)){
      tmp = read.csv(id_ocean_p[i],header = T)
      tmp = tmp[,-1]
      tmp = as.vector(tmp)
      id_li = c(id_li,tmp)
    }
    
    # return full id
    
    group_id <- function(x){
      step = round(length(x) /100)
      ids = seq(1,length(x),step)
      ide = ids -1
      ide = ide[-1]
      ide = c(ide,length(x))
      xl = list()
      for(i in 1:length(ids)){
        stmp = ids[i]
        etmp = ide[i]
        tmp = x[stmp:etmp]
        xl[[i]] = tmp
      }
      return(xl)
    }
    
    xfull <<- df$type
    df_fullid <<- df$type
    
    for(i in 1:length(id_li)){
      
      tmpid = id_li[[i]]
      
      tmpid_g = group_id(tmpid)
      
      tmp_ret_id = lapply(tmpid_g,search_which_full)
      
      
      
      
      
      
    }
    
    
    
    
    
  }
}
convey_rate_plot<-function(
  
){
  input_convey =  input_con_mean = 'analysis_output/convey_rate_by_region_mean.csv'
  convey_rate = fread(input_convey)
  convey_rate = as.data.frame(convey_rate)
  
  sounames = convey_rate[,1]
  type = rep(c('north_jishui',
               'north_moun',
               'south_jishui',
               'south_moun'),each =12)
  
  convey_rate$type = type
  
  df = reshape2::melt(convey_rate,c('re_group','type'))
  #df$variable = as.numeric(df$variable)
  
  colnames(df) = c('Source_region','type','Date',
                   'value')
  
  
  p = ggplot()+
    geom_path(data = df,
              aes(x = Date,y = value,group = Source_region,
                  color= Source_region))+
    facet_wrap(~type,nrow = 2)
  
  
  
}
cor_analysis_annual_scale<-function(
  
){
  input = 'covar_analysis_data'
  input_pme_in_source = paste0(input,'/pme_in_source.csv')
  input_pme_targ_south = paste0(input,'/pme_in_target_south.csv')
  input_pme_targ_north = paste0(input,'/pme_in_target_north.csv')
  input_tws_targ_south = paste0(input,'/tws_in_target_south.csv')
  input_tws_targ_north = paste0(input,'/tws_in_target_north.csv')
  input_tws_in_source = paste0(input,'/tws_in_source.csv')
  input_prdf_source = paste0(input,'/pr_in_source.csv')
  
  
  pmedf = as.data.frame(fread(input_pme_in_source))
  prdf = as.data.frame(fread(input_prdf_source))
  pmedf_south = as.data.frame(fread(input_pme_targ_south))
  pmedf_north = as.data.frame(fread(input_pme_targ_north))
  tws_south = as.data.frame(fread(input_tws_targ_south))
  tws_north = as.data.frame(fread(input_tws_targ_north))
  twsdf = as.data.frame(fread(input_tws_in_source))
  
  naid = which(is.na(pmedf$pme1))
  pmedf = pmedf[-naid,]
  twsdf = twsdf[-naid,]
  prdf = prdf[-naid,]
  prdf = prdf[,-1]
  twsdf = twsdf[,-1]
  pmedf = pmedf[,-1]
  pmedf_south = pmedf_south[-naid,]
  pmedf_north = pmedf_north[-naid,]
  tws_south = tws_south[-naid,]
  tws_north = tws_north[-naid,]
  
  petar_south = pmedf_south$value
  petar_north = pmedf_north$value
  twstar_south = tws_south$value
  twstar_north = tws_north$value  
  
  to_annual<-function(x){
    x = c(rep(NA,6),x)
    x = matrix(x,nrow = 12)
    x = apply(x,2,sum,na.rm = T)
    return(as.numeric(x))
  }
  
  pme_ann = apply(pmedf,2,to_annual)
  petar_north_ann = to_annual(petar_north)
  petar_south_ann = to_annual(petar_south)
  tws_ann = apply(twsdf,2,to_annual)
  twstar_north_ann = to_annual(twstar_north)
  twstar_south_ann = to_annual(twstar_south)
  
  
  cor_north = 1
  cor_south = 1
  for(i in 1:ncol(pmedf)){
    tmp_south = max(ccf(pme_ann[,i],petar_south_ann)$acf)
    tmp_north = max(ccf(pme_ann[,i],petar_north_ann)$acf)
    
    cor_north = c(cor_north,tmp_north)
    cor_south = c(cor_south,tmp_south)
  }
  cor_north = cor_north[-1]
  cor_south = cor_south[-1]
  
  print(cor_north)
  print(cor_south)
  
  
}
cor_analysis_pr_and_pr_tws_<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/find_peak_valley_p_trial.R')
  library(data.table)
  input = 'covar_analysis_data'
  input_pme_in_source = paste0(input,'/pme_in_source.csv')
  input_pme_targ_south = paste0(input,'/pme_in_target_south.csv')
  input_pme_targ_north = paste0(input,'/pme_in_target_north.csv')
  input_tws_targ_south = paste0(input,'/tws_in_target_south.csv')
  input_tws_targ_north = paste0(input,'/tws_in_target_north.csv')
  
  pmedf = as.data.frame(fread(input_pme_in_source))
  pmedf_south = as.data.frame(fread(input_pme_targ_south))
  pmedf_north = as.data.frame(fread(input_pme_targ_north))
  tws_south = as.data.frame(fread(input_tws_targ_south))
  tws_north = as.data.frame(fread(input_tws_targ_north))
  
  naid = which(is.na(pmedf$pme1))
  pmedf = pmedf[-naid,]
  pmedf = pmedf[,-1]
  pmedf_south = pmedf_south[-naid,]
  pmedf_north = pmedf_north[-naid,]
  tws_south = tws_south[-naid,]
  tws_north = tws_north[-naid,]
  
  petar_south = pmedf_south$value
  petar_north = pmedf_north$value
  twstar_south = tws_south$value
  twstar_north = tws_north$value
  
  abid_south = find_peak_valley_p_trial(petar_south,0.5)
  abid_north = find_peak_valley_p_trial(petar_north,0.5)
  
  abid_north_start = c(1,abid_north)
  abid_south_start = c(1,abid_south)
  abid_north_end = c(abid_north,162)
  abid_south_end = c(abid_south,162)
  
  cor_box_outter = 1
  for(i in 1:length(abid_north_start)){
    tmpid = abid_north_start[i]:abid_north_end[i]
    tmpmat = pmedf[tmpid,]
    tmpnorth = petar_north[tmpid]
    
    cor_box = 1
    for(j in 1:ncol(tmpmat)){
      tmpcor = cor(tmpmat[,j],tmpnorth)  
      cor_box = c(cor_box,tmpcor)
    }
    
    cor_box = cor_box[-1]
    cor_box_outter = rbind(cor_box_outter,
                           cor_box)
  }
  cor_box_outter = cor_box_outter[-1,]
    
  # monthly analysis
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),
             '1 month')
  date = date[1:174]
  date = date[-naid]
  
  mon_cor_box_south = 1
  mon_cor_box_north = 1
  for(i in 1:ncol(pmedf)){
    
    tmppme = as.numeric(pmedf[,i])
    tmppme = c(rep(NA,6),tmppme)
    tmppme = matrix(tmppme,nrow = 12)
    
    tmppme_north =c(rep(NA,6), petar_north)
    tmppme_south = c(rep(NA,6),petar_south)
    
    tmppme_north = matrix(tmppme_north,nrow = 12)
    tmppme_south = matrix(tmppme_south,nrow = 12)
    
    cor_north_box = 1
    cor_south_box = 1
    for(j in 1:nrow(tmppme)){
      tmpid = which(is.na(tmppme[j,]))
      
      monpme = tmppme[j,]
      monpme_north = tmppme_north[j,]
      monpme_south = tmppme_south[j,]
      if(length(tmpid)>0){
        monpme = monpme[-tmpid]
        monpme_north = monpme_north[-tmpid]
        monpme_south = monpme_south[-tmpid]
      }
      
      
      moncor_north = max(ccf(monpme,monpme_north)$acf)
      moncor_south = max(ccf(monpme,monpme_south)$acf)
      
      cor_north_box = c(cor_north_box,
                        moncor_north)
      cor_south_box = c(cor_south_box,
                        moncor_south)
    }
    cor_north_box = cor_north_box[-1]
    cor_south_box = cor_south_box[-1]
    
    mon_cor_box_north = cbind(mon_cor_box_north,
                              cor_north_box)
    mon_cor_box_south = cbind(mon_cor_box_south,
                              cor_south_box)
    
  }
  mon_cor_box_north = mon_cor_box_north[,-1]
  mon_cor_box_south = mon_cor_box_south[,-1]
  
  cols = paste0(rep(c('as','ato','eu'),each = 4),
                rep(1:4,3))
  cols = cols[-c(3,12)]
  
  colnames(mon_cor_box_north) = cols
  colnames(mon_cor_box_south) = cols
  
  mon = toupper(month.abb)
  
  dfcor_north = data.frame(mon,mon_cor_box_north)
  dfcor_south = data.frame(mon,mon_cor_box_south)
  
  dfcor_northm = reshape2::melt(dfcor_north,'mon')
  dfcor_southm = reshape2::melt(dfcor_south,'mon')
  
  dfcor_northm$type = 'north'
  dfcor_southm$type = 'south'
  
  dfcor = rbind(dfcor_northm,
                dfcor_southm)
  dfcor$mon = factor(dfcor$mon,
                     levels = mon)
  
  dfcor$cuts = cut(dfcor$value,
                    breaks = seq(-1,1,0.25),
                    right = F
                    )
  p = ggplot()+
    geom_tile(data = dfcor,
              aes(x = variable,
                  y = mon,
                  fill = cuts))+
    scale_fill_brewer(palette = 'Spectral',
                      direction = -1)+
    theme_bw()+
    facet_wrap(~type,nrow = 1)
  
  p
  
  
  
  
}
cor_analysis_pr_tws <-function(
  pattern = 'north'
){
  trend_fun <-function(x){
    
    #xs = (x - mean(x))/(max(x)-min(x))
    
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    
    xt = as.numeric(xt)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }  
  
  # import tws
  input_tws = 'tws_in_target/'
  files_jishui = c('north_jishui','south_jishui')
  input_tws = paste0(input_tws,files_jishui,'.csv')
  
  north_tws = as.data.frame(fread(input_tws[1]))
  south_tws = as.data.frame(fread(input_tws[2]))
  
  north_tws = north_tws[,1]
  south_tws = south_tws[,1]
  
  north_tws = trend_fun(north_tws)
  south_tws = trend_fun(south_tws)
  
  naid = which(is.na(north_tws))
  
  if(pattern == 'north'){
    tws = north_tws[-naid]
  }else{
    tws = south_tws[-naid]
  }
  
  
  
  library(data.table)
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  source('/home/share/R_project/xinjiang_vapor/source_id_identify.R')
  
  pe_in_source = import_pe_in_source('era5_pr_mean',
                                     name = 'era5_pr_mean.csv')
  pe_in_source = pe_in_source[1:174,]
  
  eva_in_source = import_pe_in_source('era5_eva_mean',
                                      name = 'era5_eva_mean.csv')
  eva_in_source = eva_in_source[1:174,]
  # as,ato,eu
  colnames(eva_in_source) = paste0('eva',1:12)
  
  tws_in_source = import_pe_in_source('tws_in_source',
                                      name = 'tws_sum.csv')
  colnames(tws_in_source) = paste0('tws',1:12)
  
  
  #pe_in_source = pe_in_source
  #pe_in_source = tws_in_source
  
  if(pattern == 'north'){
    id_re = source_id_identify('north')
    pe_in_source = pe_in_source[,-id_re]
  }else{
    id_re = source_id_identify('south')
    pe_in_source = pe_in_source[,-id_re]
  }
  
  pe_t = apply(pe_in_source,2,trend_fun)
  naid = which(is.na(pe_t[,1]))
  pe_t = pe_t[-naid,]
  
  
  # cor analysis
  cor_box = 1
  for(i in 1:ncol(pe_t)){
    tmp = cor(pe_t[,i],tws)
    print(colnames(pe_t)[i])
    print(tmp)
    cor_box =c(cor_box,tmp)
  }
  cor_box = cor_box[-1]
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
}













cor_analysis_spei_tws<-function(
  pattern = 'north'
){
  trend_fun <-function(x){
    
    #xs = (x - mean(x))/(max(x)-min(x))
    
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    
    xt = as.numeric(xt)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }  
  # import tws
  input_tws = 'tws_in_target/'
  files_jishui = c('north_jishui','south_jishui')
  input_tws = paste0(input_tws,files_jishui,'.csv')
  
  north_tws = as.data.frame(fread(input_tws[1]))
  south_tws = as.data.frame(fread(input_tws[2]))
  
  north_tws = north_tws[-c(1:2),1]
  south_tws = south_tws[-c(1:2),1]
  
  north_tws = trend_fun(north_tws)
  south_tws = trend_fun(south_tws)
  
  naid = which(is.na(north_tws))
  
  if(pattern == 'north'){
    tws = north_tws[-naid]
  }else{
    tws = south_tws[-naid]
  }
  
  # import spei
  input_spei = 'spei3_in_source'
  input_spei = paste0(input_spei,'/',pattern,'.csv')
  spei = fread(input_spei)
  
  spei_df = as.data.frame(spei)
  colnames(spei_df) = paste0('spei',1:12)
  spei_df = spei_df[-c(1,2),]
  
  spei_df = apply(spei_df,2,trend_fun)
  
  if(pattern == 'north'){
    id_re = source_id_identify('north')
    spei_df = spei_df[,-id_re]
  }else{
    id_re = source_id_identify('south')
    spei_df = spei_df[,-id_re]
  }
  tmpid = which(is.na(spei_df[,1]))
  spei_df = spei_df[-tmpid,]
  
  cor_box = 1
  for(i in 1:ncol(spei_df)){
    
    tmpcor = cor(spei_df[,i],tws)
    print(colnames(spei_df)[i])
    print(tmpcor)
    cor_box = c(cor_box,tmpcor)
  }
  cor_box = cor_box[-1]
  
  
  df = data.frame(tws = tws,
                  spei_df)
  dfm = reshape2::melt(df,'tws')
  
  p = ggplot()+
    geom_point(data = dfm,aes(x = tws,y = value))+
    facet_wrap(~variable,scales = 'free',nrow = 2)+
    theme_bw()
  
  p
    
  
  
  
  
  
}
cor_analysis_sub_windowtws_atope<-function(
  mode = 'ato3'
){
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  if(mode == 'ato1'){
    pe_ato34 = pe_in_source$pr5
    pet_ato34 = pet_sum$pr5
    output_pme_trend = 'analysis_output/fig2/pme_ato1_trend.csv'
  }else if(mode =='ato2'){
    pe_ato34 = pe_in_source$pr6
    pet_ato34 = pet_sum$pr6
    output_pme_trend = 'analysis_output/fig2/pme_ato2_trend.csv'
  }else if(mode == 'ato3'){
    pe_ato34 = pe_in_source$pr7
    pet_ato34 = pet_sum$pr7
    output_pme_trend = 'analysis_output/fig2/pme_ato3_trend.csv'
  }else{
    pe_ato34 = pe_in_source$pr8
    pet_ato34 = pet_sum$pr8
    output_pme_trend = 'analysis_output/fig2/pme_ato4_trend.csv'
  }
  
  
  #pe_ato34 = pe_in_source$pr7
  #pet_ato34 = pet_sum$pr7
  
  pme_ato34 = pe_ato34 - pet_ato34
  
  trend_fun <-function(x){
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    
    xt = as.numeric(xt)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }
  
  
  pme_ato34 = trend_fun(pme_ato34)
  naid = which(is.na(pme_ato34))
  pme_ato34 = pme_ato34[-naid]
  
  write.csv(pme_ato34,output_pme_trend)
  
  input_tws_subwindow = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws_subs = read.csv(input_tws_subwindow,header = T)
  tws_subs = tws_subs[,-1]
  
  colnames(tws_subs) = paste0('subwindow',1:ncol(tws_subs))
  
  tws_subs = tws_subs[-naid,]
  
  input_sub_shp = paste0('sub_windows',
                         '/sub_window',1:19,'.shp')
  
  shp_list = list()
  tws_box = 1
  cor_box = 1
  id_box = 1
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  for(i in id_box){
    
    #tmpcor = cor(pme_ato34,tws_subs[,i])
    tmpcor = max(ccf(pme_ato34,tws_subs[,i])$acf)
    
    tmpshp = shapefile(input_sub_shp[i])
    shp_list = c(shp_list,tmpshp)
    tws_box = cbind(tws_box,tws_subs[,i])
    cor_box = c(cor_box,tmpcor)
    #print(tmpcor)
  }
  tws_box = tws_box[,-1]
  cor_box = cor_box[-1]
  shp_com = do.call('bind',shp_list)
  
  
  
  output_combine_sub = 'analysis_output/fig2/combine_sub_window.shp'
  output_combine_tws = 'analysis_output/fig2/combine_tws_subwindow.csv' 
  fwrite(tws_box,output_combine_tws)

  shapefile(shp_com,output_combine_sub,
            overwrite = T)
  
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),
             '1 month')
  date = date[1:174]
  date = date[-naid]
  
  linedf =1
  for(i in 1:ncol(tws_box)){
    tmpdf = cbind(date = date,
                       pme_ato34 = pme_ato34,
                       tws = tws_box[,i],
                       type = i)
    
    linedf= rbind(linedf,tmpdf)
  }
  linedf = linedf[-1,]
  
  linedf = as.data.frame(linedf)
  linedfm = reshape2::melt(linedf,c('date','type'))
  
  ret_box = list(pme_ato34,
                 tws_box,
                 shp_com,
                 cor_box)
  return(ret_box)
}
cor_analysis_sub_windowtws_atotas<-function(
  mode = 'ato3'
){
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  
  peva_subs = read.csv(
    'analysis_output/poten_eva_subwindow_2003_2017.csv',
    header = T
  )
  naid = which(is.na(peva_subs[,2]))
  peva_subs = peva_subs[-naid,-1]
  
  sst = read.csv('analysis_output/ato_mean_trend_sst.csv',
                 header =T)
  sst = sst[-naid,-1]
  
  
  input_tws_subwindow = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws_subs = read.csv(input_tws_subwindow,header = T)
  tws_subs = tws_subs[,-1]
  
  colnames(tws_subs) = paste0('subwindow',1:ncol(tws_subs))
  
  tws_subs = tws_subs[-naid,]
  
  input_sub_shp = paste0('sub_windows',
                         '/sub_window',1:19,'.shp')
  
  shp_list = list()
  tws_box = 1
  cor_box = 1
  id_box = 1
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  for(i in id_box){
    
    #tmpcor = cor(pme_ato34,tws_subs[,i])
    #tmpcor = max(ccf(sst[,2],tws_subs[,i])$acf)
    tmpcor = max(ccf(sst[,3],tws_subs[,i])$acf)
    tmpshp = shapefile(input_sub_shp[i])
    shp_list = c(shp_list,tmpshp)
    tws_box = cbind(tws_box,tws_subs[,i])
    cor_box = c(cor_box,tmpcor)
    print(tmpcor)
  }
  tws_box = tws_box[,-1]
  cor_box = cor_box[-1]
  shp_com = do.call('bind',shp_list)
  
  return(ret_box)
}
cor_analysis_whole_index <- function(
  
){
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  source('/home/share/R_project/xinjiang_vapor/source_id_identify.R')
  
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source
  
  #pe_in_source = import_pe_in_source('gpcc_pr_sum',
  #                                   name = 'gpcc_pr_sum.csv')
  #pe_in_source = pe_in_source[1:174,]
  
  eva_in_source = import_pe_in_source('era5_eva_sum',
                                      name = 'era5_eva_sum.csv')
  eva_in_source = eva_in_source
  colnames(eva_in_source) = paste0('eva',1:12)
  
  tws_in_source = import_pe_in_source('tws_in_source',
                                      name = 'tws_sum.csv')
  colnames(tws_in_source) = paste0('tws',1:12)
  
  
  eva_in_source = eva_in_source *30.5
  pe_in_source = pe_in_source * 30.5
  
  pe_minus_eva = pe_in_source - eva_in_source 
  colnames(pe_minus_eva) = paste0('pme',1:12)
  
  input_pr_intarget = list.files('era5_pr_in_target',
                                 full.names = T)[c(1,3)]
  input_eva_intarget = list.files('evaporation_in_target',
                                  full.names =T)[c(1,3)]
  
  pr_in_target = fread(input_pr_intarget[1])
  eva_in_target = fread(input_eva_intarget[1])
  
  pr_in_target= as.data.frame(pr_in_target)
  eva_in_target = as.data.frame(eva_in_target)
  
  pme_north = pr_in_target - eva_in_target
  
  pr_in_target = fread(input_pr_intarget[2])
  eva_in_target = fread(input_eva_intarget[2])
  
  pr_in_target= as.data.frame(pr_in_target)
  eva_in_target = as.data.frame(eva_in_target)
  
  pme_south = pr_in_target - eva_in_target
  
  
  trend_fun <-function(x){
    
    #xs = (x - mean(x))/(max(x)-min(x))
    
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    
    xt = as.numeric(xt)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }  
  
  pme_t = apply(pe_minus_eva,2,trend_fun)
  petar_south = trend_fun(pme_south$south_jishui)
  petar_north = trend_fun(pme_north$north_jishui)
  
  naid = which(is.na(pme_t[,1]))
  pmet = pme_t[-naid,]
  petar_north = petar_north[-naid]
  petar_south = petar_south[-naid]
  
  cor_north = 1
  cor_south = 1
  for(i in 1:ncol(pmedf)){
    tmp_south = max(ccf(pmet[,i],petar_south)$acf)
    tmp_north = max(ccf(pmet[,i],petar_north)$acf)
    
    cor_north = c(cor_north,tmp_north)
    cor_south = c(cor_south,tmp_south)
  }
  cor_north = cor_north[-1]
  cor_south = cor_south[-1]
  
  print(cor_north)
  print(cor_south)
  
  
  
}
cor_filter_fun <-function(
  ret_df
){
  cor2 = 1
  for(i in 1:10 ){
    cor1 = 1
    for(j in 1:8){
      tmpdf = ret_df[[i]][[1]][[j]][[2]]
      tmpcor = cor(tmpdf[,1],tmpdf[,2])
      cor1 = c(cor1,tmpcor)
    }
    cor1 = cor1[-1]
    cor2 = cbind(cor2,cor1)
  }
  cor2 = cor2[,-1]
  return(cor2)
}
cor_pme_tws_cmip6 <- function(
 df
){
  
  g1 = 1:10
  g2 = 11:20
  
  df1 = df[which(df$type %in% g1),]
  df2 = df[which(df$type %in% g2),]
  
  cor1_box = 1
  cor2_box = 1
  for(i in 1:10){
    tmpid1 = which(df1$type ==g1[i])
    tmpid2 = which(df2$type ==g2[i])
    
    tmpdf1 = df1[tmpid1,]
    tmpdf2 = df2[tmpid2,]
    
    cor1 = cor(tmpdf1$TWS,
               tmpdf1$value)
    
    cor2 = cor(tmpdf2$TWS,
               tmpdf2$value)
    
    cor1_box = c(cor1_box,
                 cor1)
    cor2_box = c(cor2_box,
                 cor2)
  }
  cor1_box = cor1_box[-1]
  cor2_box = cor2_box[-1]
  
  cor1_box = data.frame(
    x = 0.05,
    y = -0.20+0.05,
    cor = paste0('Cor: ',round(cor1_box,2)),
    type = 1:10
  )
  
  cor2_box = data.frame(
    x = 0.05,
    y = -0.20+0.05,
    cor = paste0('Cor: ',round(cor2_box,2)),
    type = 11:20
  )
  corbox = rbind(cor1_box,cor2_box)
  pbox = data.frame(
    x = 0.05,
    y = -0.23+0.02,
    cor = 'p<0.05',
    type = 1:20
  )
  
  return(list(corbox,pbox))
}
covar_pe_insource_and_pe_in_target<-function(
  pattern  = 'north'
){
  library(data.table)
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  source('/home/share/R_project/xinjiang_vapor/source_id_identify.R')
  
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  
  tas_in_source = import_pe_in_source('era5_tas_mean',
                                      name = 'era5_tas_mean.csv')
  
  #pe_in_source = import_pe_in_source('gpcc_pr_sum',
  #                                   name = 'gpcc_pr_sum.csv')
  #pe_in_source = pe_in_source[1:174,]
  
  eva_in_source = import_pe_in_source('era5_eva_sum',
                                      name = 'era5_eva_sum.csv')
  eva_in_source = eva_in_source[1:174,]
  # as,ato,eu
  colnames(eva_in_source) = paste0('eva',1:12)
  
  tws_in_source = import_pe_in_source('tws_in_source',
                                      name = 'tws_sum.csv')
  colnames(tws_in_source) = paste0('tws',1:12)
  
  
  eva_in_source = eva_in_source *30.5
  pe_in_source = pe_in_source * 30.5
  
  
  pe_minus_eva = pe_in_source - eva_in_source
  pe_minus_eva = pe_in_source - pet_sum
  colnames(pe_minus_eva) = paste0('pme',1:12)
  eva_minus_pe = eva_in_source - pe_in_source
  colnames(eva_minus_pe) = paste0('emp',1:12)
  
  
  # import pe in target
  input_pr_intarget = list.files('era5_pr_in_target',
                                 full.names = T)[c(1,3)]
  input_eva_intarget = list.files('poten_evap_in_target',
                                  full.names =T)[c(1,3)]
  
  if(pattern == 'north'){
    pr_in_target = fread(input_pr_intarget[1])
    eva_in_target = fread(input_eva_intarget[1])
    
    pr_in_target= as.data.frame(pr_in_target)
    eva_in_target = as.data.frame(eva_in_target)
    
    pe_in_target = pr_in_target - eva_in_target
    #pe_in_target = pr_in_target
  }else{
    pr_in_target = fread(input_pr_intarget[2])
    eva_in_target = fread(input_eva_intarget[2])
    
    pr_in_target= as.data.frame(pr_in_target)
    eva_in_target = as.data.frame(eva_in_target)
    
    pe_in_target = pr_in_target - eva_in_target
    #pe_in_target = pr_in_target
  }
  
  source('/home/share/R_project/xinjiang_vapor/spei_fun.R')
  spei_df = apply(pe_minus_eva,2,spei_fun)
  
  output_spei = 'spei3_in_source'
  dir.create(output_spei)
  output_spei = paste0(output_spei,'/',pattern,'.csv')
  print(output_spei)
  fwrite(spei_df,output_spei)
  
  
  
  if(pattern == 'north'){
    id_re = source_id_identify('north')
    eva_in_source = eva_in_source[,-id_re]
    pe_in_source = pe_in_source[,-id_re]
    pe_minus_eva = pe_minus_eva[,-id_re]
    eva_minus_pe = eva_minus_pe[,-id_re]
    tws_in_source = tws_in_source[,-id_re]
    spei_df = spei_df[,-id_re]
  }else{
    id_re = source_id_identify('south')
    eva_in_source = eva_in_source[,-id_re]
    pe_in_source = pe_in_source[,-id_re]
    pe_minus_eva = pe_minus_eva[,-id_re]
    eva_minus_pe = eva_minus_pe[,-id_re]
    tws_in_source = tws_in_source[,-id_re]
    spei_df = spei_df[,-id_re]
  }
  
  
  trend_fun <-function(x){
    
    #xs = (x - mean(x))/(max(x)-min(x))
    
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    
    xt = as.numeric(xt)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }  
  
  pe_t = apply(pe_in_source,2,trend_fun)
  eva_t = apply(eva_in_source,2,trend_fun)
  pme = apply(pe_minus_eva,2,trend_fun)
  emp = apply(eva_minus_pe,2,trend_fun)
  spei_t = apply(spei_df,2,trend_fun)
  tws_source_t = apply(tws_in_source,2,trend_fun)
  
  
  
  #cor_analysis(pe_t,eva_t)
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),
             '1 month')
  date = date[1:174]
  pe_df = data.frame(date,pe_t)
  eva_df = data.frame(date,eva_t)
  pme_df = data.frame(date,pme)
  emp_df = data.frame(date,emp)
  spei_t = data.frame(date,spei_t)
  tws_source_df = data.frame(date,tws_source_t)
  
  
  pe_dfm = reshape2::melt(pe_df,'date')
  eva_dfm = reshape2::melt(eva_df,'date')
  pme_dfm = reshape2::melt(pme_df,'date')
  emp_dfm = reshape2::melt(emp_df,'date')
  spei_dfm = reshape2::melt(spei_t,'date')
  tws_source_dfm = reshape2::melt(tws_source_df,'date')
  
  type = paste0(rep(c('as','ato','eu'),each = 4),
                rep(1:4,3))
  contype = rep(c('as','ato','eu'),each = 4)
  contype = contype[-id_re]
  type = type[-id_re]
  source('/home/share/R_project/xinjiang_vapor/source_id_by_convey_amount.R')
  ranks = source_id_by_convey_amount(pattern)
  print(type[ranks])
  type = rep(type,each = 174)
  contype = rep(contype,each = 174)
  
  pe_dfm$type = type
  eva_dfm$type = type
  pme_dfm$type = type
  emp_dfm$type = type
  tws_source_dfm$type = type
  spei_dfm$type = type
  
  pe_dfm$contype = contype
  eva_dfm$contype = contype
  pme_dfm$contype = contype
  emp_dfm$contype = contype
  tws_source_dfm$contype = contype
  spei_dfm$contype = contype
  
  # import tws
  input_tws = 'tws_in_target/'
  files_jishui = c('north_jishui','south_jishui')
  input_tws = paste0(input_tws,files_jishui,'.csv')
  
  north_tws = as.data.frame(fread(input_tws[1]))
  south_tws = as.data.frame(fread(input_tws[2]))
  
  north_tws = trend_fun(north_tws[,1])
  south_tws = trend_fun(south_tws[,1])
  
  pe_in_target = pe_in_target[1:174,]
  pe_in_target = trend_fun(pe_in_target)
  
  dfpe_in_target = data.frame(date,
                              pe_in_target = pe_in_target)
  
  if(pattern == 'north'){
    dftws = data.frame(date,
                       north_tws = north_tws)
    
    
  }else{
    dftws = data.frame(date,
                       south_tws = south_tws)
  }
  
  
  dftws = reshape2::melt(dftws,'date')
  dfpe_in_target = reshape2::melt(dfpe_in_target,
                                  'date')
  colnames(dftws) = c('date','variable2','value')
  colnames(dfpe_in_target) = c('date','variable2','value')
  
  #mean the index by continent
  mean_fun <- function(x){
    x = mean(x,na.rm = T)
  }
  
  pe_df_as = apply(
    cbind(pme_df$pme2),1,mean_fun
  )
  pe_df_ato = apply(cbind(pme_df$pme5,pme_df$pme6,
                          pme_df$pme7,pme_df$pme8),1,
                    mean_fun)
  
  pe_df_eu = apply(cbind(pme_df$pme10,pme_df$pme9),1,
                    mean_fun)
  
  pe_df_con_mean = data.frame(date,
                              as_mean = pe_df_as,
                              ato_mean = pe_df_ato,
                              eu_mean = pe_df_eu)
  pe_df_conm = reshape2::melt(pe_df_con_mean,
                              'date')
  type_con = rep(c('as','ato','eu'),each = 174)
  pe_df_conm$contype = type_con
  
  naid = which(is.na(dfpe_in_target$value))
  petar = dfpe_in_target$value[-naid]
  pe_df_con_mean = pe_df_con_mean[-naid,]
  date_sub = date[-naid]
  abrupt_id = find_peak_valley_p_trial(petar,0.1)
  
  abrupt_id = abrupt_id+6
  dfab = data.frame(
    date = date[abrupt_id],
    value = dfpe_in_target$value[abrupt_id]
  )
  output = 'covar_analysis_data'
  
  output_prdf_sour = paste0(output,'/pr_in_source.csv')
  
  output_pmedf_sour = paste0(output,'/pme_in_source.csv')
  output_pmedf_targ_north = paste0(output,'/pme_in_target_north.csv')
  output_pmedf_targ_south = paste0(output,'/pme_in_target_south.csv')
  output_tws_targ_north = paste0(output,'/tws_in_target_north.csv')
  output_tws_targ_south = paste0(output,'/tws_in_target_south.csv')
  output_tws_sour = paste0(output,'/tws_in_source.csv')
  dir.create(output)
  print(ncol(pme_df))
  fwrite(pe_df,output_prdf_sour)
  fwrite(pme_df,output_pmedf_sour)
  fwrite(tws_source_df,output_tws_sour)
  if(pattern == 'north'){
    fwrite(dfpe_in_target,output_pmedf_targ_north)
    fwrite(dftws,output_tws_targ_north)
  }else{
    fwrite(dfpe_in_target,output_pmedf_targ_south)
    fwrite(dftws,output_tws_targ_south)
  }
 
  
  library(ggplot2)
  pline = ggplot()+
    #geom_line(data = pe_dfm,aes(x = date,y = value,
    #                            color = variable,
    #                            linetype = variable),
    #          size = 0.5)+
    #geom_line(data = pe_df_conm,
    #          aes(x = date,y = value,
    #              color = variable),size = 0.5)+
    #geom_line(data = eva_dfm,aes(x = date,y = value,
    #                             color = variable))+
    
    geom_line(data = pme_dfm,aes(x = date,y = value,
                                color = variable))+
    #geom_line(data = spei_dfm,aes(x = date,y = value,
    #                             color = variable))+
    #geom_line(data = emp_dfm,aes(x = date,y = value,
    #                             color = variable))+
    geom_line(data = tws_source_dfm,aes(x = date,y = value,
                                        color = variable),
              linetype = 2)+
    #geom_line(data = dftws,aes(x =date,y = value,
    #                           color = variable2),
    #          linetype = 2,size = 2)+
    geom_line(data = dfpe_in_target,aes(
      x  =date,y = value,color = variable2
    ),size = 1.5)+
    #geom_point(data = dfab,
    #           aes(x = date,y = value),
    #           color = 'blue',shape = 1,size= 5)+
    #facet_wrap(~contype,ncol =3,scales = 'free')+
    facet_wrap(~type,ncol =3,scales = 'free')+
    theme_bw()+
    theme(legend.position = 'bottom')
  
  pline
  
    
  
  
  
  
}
covar_pe_insource_and_tws<-function(
  pattern  = 'north'
){
  library(data.table)
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  source('/home/share/R_project/xinjiang_vapor/source_id_identify.R')
  
  pe_in_source = import_pe_in_source('era5_pr_mean',
                                     name = 'era5_pr_mean.csv')
  pe_in_source = pe_in_source[1:174,]
  
  eva_in_source = import_pe_in_source('era5_eva_mean',
                                      name = 'era5_eva_mean.csv')
  eva_in_source = eva_in_source[1:174,]
  # as,ato,eu
  colnames(eva_in_source) = paste0('eva',1:12)
  
  tws_in_source = import_pe_in_source('tws_in_source',
                                      name = 'tws_sum.csv')
  colnames(tws_in_source) = paste0('tws',1:12)
  
  
  eva_in_source = eva_in_source *30.5
  pe_in_source = pe_in_source * 30.5
  
  
  pe_minus_eva = pe_in_source - eva_in_source 
  colnames(pe_minus_eva) = paste0('pme',1:12)
  eva_minus_pe = eva_in_source - pe_in_source
  colnames(eva_minus_pe) = paste0('emp',1:12)
  
  
  spei_df = apply(pe_minus_eva,2,spei_fun)

  output_spei = 'spei3_in_source'
  dir.create(output_spei)
  output_spei = paste0(output_spei,'/',pattern,'.csv')
  print(output_spei)
  fwrite(spei_df,output_spei)
  
  
  
  if(pattern == 'north'){
    id_re = source_id_identify('north')
    eva_in_source = eva_in_source[,-id_re]
    pe_in_source = pe_in_source[,-id_re]
    pe_minus_eva = pe_minus_eva[,-id_re]
    eva_minus_pe = eva_minus_pe[,-id_re]
    tws_in_source = tws_in_source[,-id_re]
    spei_df = spei_df[,-id_re]
  }else{
    id_re = source_id_identify('south')
    eva_in_source = eva_in_source[,-id_re]
    pe_in_source = pe_in_source[,-id_re]
    pe_minus_eva = pe_minus_eva[,-id_re]
    eva_minus_pe = eva_minus_pe[,-id_re]
    tws_in_source = tws_in_source[,-id_re]
    spei_df = spei_df[,-id_re]
  }
  
  
  trend_fun <-function(x){
    
    #xs = (x - mean(x))/(max(x)-min(x))
      
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    
    xt = as.numeric(xt)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }  
  
  pe_t = apply(pe_in_source,2,trend_fun)
  eva_t = apply(eva_in_source,2,trend_fun)
  pme = apply(pe_minus_eva,2,trend_fun)
  emp = apply(eva_minus_pe,2,trend_fun)
  spei_t = apply(spei_df,2,trend_fun)
  tws_source_t = apply(tws_in_source,2,trend_fun)
  
  
  
  cor_analysis(pe_t,eva_t)
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),
             '1 month')
  date = date[1:174]
  pe_df = data.frame(date,pe_t)
  eva_df = data.frame(date,eva_t)
  pme_df = data.frame(date,pme)
  emp_df = data.frame(date,emp)
  spei_t = data.frame(date,spei_t)
  tws_source_df = data.frame(date,tws_source_t)
  
  
  
  
  
  
  pe_dfm = reshape2::melt(pe_df,'date')
  eva_dfm = reshape2::melt(eva_df,'date')
  pme_dfm = reshape2::melt(pme_df,'date')
  emp_dfm = reshape2::melt(emp_df,'date')
  spei_dfm = reshape2::melt(spei_t,'date')
  tws_source_dfm = reshape2::melt(tws_source_df,'date')
  
  type = paste0(rep(c('as','ato','eu'),each = 4),
                rep(1:4,3))
  type = type[-id_re]
  source('/home/share/R_project/xinjiang_vapor/source_id_by_convey_amount.R')
  ranks = source_id_by_convey_amount(pattern)
  print(type[ranks])
  type = rep(type,each = 174)
  
  pe_dfm$type = type
  eva_dfm$type = type
  pme_dfm$type = type
  emp_dfm$type = type
  tws_source_dfm$type = type
  spei_dfm$type = type
  # import tws
  input_tws = 'tws_in_target/'
  files_jishui = c('north_jishui','south_jishui')
  input_tws = paste0(input_tws,files_jishui,'.csv')
  
  north_tws = as.data.frame(fread(input_tws[1]))
  south_tws = as.data.frame(fread(input_tws[2]))
  
  north_tws = trend_fun(north_tws[,1])
  south_tws = trend_fun(south_tws[,1])
  
  
  
  if(pattern == 'north'){
    dftws = data.frame(date,
                       north_tws = north_tws)
        
    
  }else{
    dftws = data.frame(date,
                       south_tws = south_tws)
  }
  
  
  dftws = reshape2::melt(dftws,'date')
  
  colnames(dftws) = c('date','variable2','value')
  
  
  
  
  
  library(ggplot2)
  pline = ggplot()+
    geom_line(data = pe_dfm,aes(x = date,y = value,
                                color = variable))+
    geom_line(data = eva_dfm,aes(x = date,y = value,
                                 color = variable))+
    
    #geom_line(data = pme_dfm,aes(x = date,y = value,
    #                             color = variable))+
    #geom_line(data = spei_dfm,aes(x = date,y = value,
    #                             color = variable))+
    #geom_line(data = emp_dfm,aes(x = date,y = value,
    #                             color = variable))+
    #geom_line(data = tws_source_dfm,aes(x = date,y = value,
    #                                    color = variable),
    #          linetype = 2)+
    #geom_line(data = dftws,aes(x =date,y = value,
    #                           color = variable2))+
    facet_wrap(~type,nrow =3,scales = 'free')+
    theme_bw()+
    theme(legend.position = 'bottom')
  
  pline
  
  
  
  
  
  
}
create_path_ava_cmd<-function(
  input_process= '/media/sdb1/Data2',
  date = '1219'
){
  # generate yeamon and prepare initial parameters
  #########
  path = '/media/sdb5'
  month = 1:12
  year = 2003:2017
  monstr= 1
  for(i in 1:12){
    if(month[i] < 10){
      mon = paste0('0',month[i])
    }else{
      mon = month[i]
    }
    monstr = c(monstr,mon)
  }
  monstr = monstr[-1]
  
  yeamon = paste0(rep(year,each = 12),rep(monstr,length(year)))
  sday = paste0(yeamon,'01')
  eday = paste0(yeamon,'10')
  
  file = paste0('xinjiang',yeamon) # includes options, available and output files
  #########
  # files already processed check
  
  files_check_id <-function(input){
    files = list.files(input)
    month = 1:12
    year = 2003:2017
    monstr= 1
    for(i in 1:12){
      if(month[i] < 10){
        mon = paste0('0',month[i])
      }else{
        mon = month[i]
      }
      monstr = c(monstr,mon)
    }
    monstr = monstr[-1]
    
    yeamon = paste0(rep(year,each = 12),rep(monstr,length(year)))
    
    filesfull = paste0('EI',substr(yeamon,3,6))
    
    idb = 1
    for(i in 1:length(files)){
      tmpid = which(filesfull == files[i])
      idb = c(idb,tmpid)
    }
    idb= idb[-1]
    return(idb)
  }
  
  id = files_check_id(input_process)
  
  # create AVAILABLE file
  datapath = list.files(input_process,full.names = T)
  dataname = list.files(input_process)
  
  fullpath = paste0('/media/sdb5/',file)
  ava_full_path = fullpath
  
  # ava with file
  ava_with_data = ava_full_path[id]
  ava_sday = sday[id]
  ava_eday = eday[id]
  ava_data_path = datapath
  cmd_python_ava = paste0('python2 /usr/local/flexpart_bk1/mkAVAIL_v7.py -s ',ava_sday,' -e ',ava_eday,' -m EI -p ',
                          ava_data_path, ' -a ',ava_with_data)
  
  writeLines(cmd_python_ava,'/media/sdb5/cmd_python_ava_genrate.sh')
  system('/media/sdb5/cmd_python_ava_genrate.sh')
  print("AVAILABLE file has been generated!")
  
  # create all pathnames
  pathnames = readLines('/usr/local/flexpart10/src2/pathnames')
  output_pathnames = '/media/sdb1/pathnames'
  dir.create(output_pathnames)
  
  output_pathnames = paste0(output_pathnames,'/','pathnames',substr(yeamon,3,6)) # all pathnames
  ava_pathnames = output_pathnames[id]
  full_options = paste0('/media/sdb5/',file,'/options/')
  ava_options = full_options[id]
  full_output = paste0('/media/sdb5/',file,'/output/')
  ava_output = full_output[id]
  ava_data_in = paste0(ava_data_path,'/')
  ava_AVA_in = paste0(ava_with_data,'/AVAILABLE')
  
  
  for(i in 1:length(ava_pathnames))
  {
    tmp = pathnames
    tmp[1] = ava_options[i]
    tmp[2] = ava_output[i]
    tmp[3] = ava_data_in[i]
    tmp[4] = ava_AVA_in[i]
    writeLines(tmp,ava_pathnames[i])
    print(ava_pathnames[i])
  }
  print("Pathnames has been generated!")
  
  cmd_date= paste0('cmd',date)
  group_pathnames<-function(pathnames,cmd_date){
    len_path = length(pathnames)
    step = len_path / 12
    groups = round(seq(1,len_path,step))
    groupe = groups - 1
    groupe = groupe[-1]
    groupe = c(groupe,len_path)
    
    command_sh = paste0('/media/sdb1/command_sh/',cmd_date)
    dir.create(command_sh)
    command_sh_name = paste0("command_sh_g",1:12,'.sh')
    command_sh_name = paste0(command_sh,'/',command_sh_name)
    
    output = '/media/sdb1'
    for (i in 1:length(groupe)){
      tmps = groups[i]
      tmpe = groupe[i]
      tmppath = pathnames[tmps:tmpe]
      print(tmppath)
      tmpcmd = paste0('/usr/local/flexpart10/src2/FLEXPART ',tmppath)
      
      writeLines(tmpcmd, command_sh_name[i])
    }
  }
  
  group_pathnames(ava_pathnames,cmd_date)
  # command 12 threads start at 18:35
  # command 12 threads end at 
  # total 15 files
}
crop_mask_tws_for_subwindows <- function(
  
){
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  library(raster)
  
  input = 'sub_windows'
  num = 1:19
  input = paste0(input,'/sub_window',num,'.shp')
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  input = input[id_box]
  
  tws = data_management('grace')
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  tws = crop(tws,world)
  tws = mask(tws,world)
  
  output = '/media/sdb5/Data/grace_tws_masked/'
  dir.create(output)
  
  filesname = paste0('SW_TWS',1:10,'.nc')
  output = paste0(output,filesname)
    
  for(i in 1:10){
    tmpshp = shapefile(input[i])
    crs(tmpshp) = crs(world)
    
    tmptws = crop(tws,tmpshp)
    tmptws = mask(tmptws,tmpshp)
    
    writeRaster(tmptws,output[i],format = 'CDF',
                overwrite = T)
    print(i)
  }
}
crop_shp_by_region<-function(
  
){
  
  mode = c('ocean','land','land')
  name = c('ato','as','eu')
  
  region = paste0('cluster_shp/',name[1],'/',name[1],1:4,'.shp')
  r1 = shapefile(region[1])
  r2 = shapefile(region[2])
  r3 = shapefile(region[3])
  r4 = shapefile(region[4])
  
  region = paste0('cluster_shp/',name[2],'/',name[2],1:4,'.shp')
  r5 = shapefile(region[1])
  r6 = shapefile(region[2])
  r7 = shapefile(region[3])
  r8 = shapefile(region[4])
  
  region = paste0('cluster_shp/',name[3],'/',name[3],1:4,'.shp')
  r9 = shapefile(region[1])
  r10 = shapefile(region[2])
  r11 = shapefile(region[3])
  r12 = shapefile(region[4])
  
  p = ggplot()+
    geom_polygon(data = world,aes(x = long,y = lat,group = group),
                 fill = 'grey80',alpha = 0.5,size = 0.5,color = 'black')+
    geom_polygon(data = r9,aes(x = long,y = lat,group = group),
                 fill = 'transparent',alpha = 0.5,size = 0.5,color = 'black')+
    geom_polygon(data = r10,aes(x = long,y = lat,group = group),
                 fill = 'transparent',alpha = 0.5,size = 0.5,color = 'black')+
    geom_polygon(data = r11,aes(x = long,y = lat,group = group),
                 fill = 'transparent',alpha = 0.5,size = 0.5,color = 'black')+
    geom_polygon(data = r12,aes(x = long,y = lat,group = group),
                 fill = 'transparent',alpha = 0.5,size = 0.5,color = 'black')
    
  
  
  for(i in 1:length(mode)){
    tmpshp = shp_management(mode[i],name[i])
    
    
    
    tmpshp1 = crop(tmpshp,r1)
    tmp
    
    
    
    
    
  }
  
  
  
  
  
}
data_management <-function(
  mode = 'gpcc'
){
  library(raster)
  library(ncdf4)
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  if(mode == 'gpcc'){
    #full date: X2001 - 2019
    
    input1 = '/media/sdb5/Data/gpcc_pr_monthly_025_2001_2010.nc'
    input2 = '/media/sdb5/Data/gpcc_pr_monthly_025_2011_2019.nc'
    data1 = stack(input1)
    data2 = stack(input2)
    
    data = stack(data1,data2)
    loc_200301 = length(2001:2003)*12-11
    loc_201712 = length(2001:2017)*12
    loc_dim = dim(data)[3]
    data = data[[loc_200301:loc_201712]]
    #data = data[[loc_200301:loc_dim]]
    
    xj= shp_management(pattern = 'xinjiang')
    #xj = shp_management(pattern = 'shamo')
    data = crop(data,xj)
    data = mask(data,xj)
    return(data)
  }else if(mode == 'gpcc_full'){
    #full date: X2001 - 2019
    
    input1 = '/media/sdb5/Data/gpcc_pr_monthly_025_2001_2010.nc'
    input2 = '/media/sdb5/Data/gpcc_pr_monthly_025_2011_2019.nc'
    data1 = stack(input1)
    data2 = stack(input2)
    
    data = stack(data1,data2)
    loc_200301 = length(2001:2003)*12-11
    loc_201712 = length(2001:2017)*12
    loc_dim = dim(data)[3]
    data = data[[loc_200301:loc_201712]]
    
    return(data)
  }else if(mode == 'grace'){
    #input = '/media/sdb5/Data/grace_fill_200204_202007.nc'
    input = '/media/sdb5/Data/grace_fill_200204_201706.nc'
    data = stack(input)
    loc_200301 = length(2002:2003)*12-11-3
    #loc_201712 = length(2002:2017)*12-3
    loc_dim = dim(data)[3]
    data = data[[loc_200301:loc_dim]]
    #data = data[[loc_200301:loc_dim]]
    
    #xj= shp_management(pattern = 'xinjiang')
    #xj = shp_management(pattern = 'shamo')
    #xj = shp_management(pattern = 'land',names ='as')
    #data = crop(data,xj)
    #data = mask(data,xj)
    
    return(data)
  }else if(mode == 'era5_tevapor'){
    input = '/media/sdb5/Data/era5_evapor'
    input = list.files(input,full.names = T)
    
    era5_tevapor = stack(input,varname = 'e')
    loc_200301 = length(1981:2003)*12-11
    loc_201712 = length(1981:2017)*12
    
    era5_tevapor = era5_tevapor[[loc_200301:loc_201712]]
    #xj= shp_management(pattern = 'xinjiang')
    xj = shp_management(pattern = 'shamo')
    
    data = crop(era5_tevapor,xj)
    data = mask(data,xj)
    
    return(data)
    
  }else if(mode == 'era5_temper'){
    input = '/media/sdb5/Data/era5_t'
    input = list.files(input,full.names = T)
    input = input[-1]
    
    era5_t = stack(input)
    loc_200301 = length(1981:2003)*12-11
    loc_201712 = length(1981:2017)*12
    
    era5_t = era5_t[[loc_200301:loc_201712]]
    #xj= shp_management(pattern = 'xinjiang')
    xj = shp_management(pattern = 'shamo')
    data = crop(era5_t,xj)
    data = mask(data,xj)
    
    return(data)
  }else if(mode == 'ndvi'){
    input = '/media/sdb5/Data/Global_NDVI_tif'
    input = list.files(input,full.names = T)
    # start 2000-02 end 2019-08
    ndvi = stack(input)
    
    loc200301 = length(2000:2003)*12-11-1
    loc201712 = length(2000:2017)*12-1
    
    ndvi = ndvi[[loc200301:loc201712]]
    #xj = shp_management(pattern = 'xinjiang')
    xj = shp_management(pattern = 'shamo')
    data = crop(ndvi,xj)
    data = mask(data,xj)
    return(data)
    
  }else if(mode == 'total_released'){
    input = 'analysis_output/total_released_03_17.csv'
    
    tt_re = read.csv(input,header = T)
    tt_re = tt_re[,-1]
    
    return(tt_re)
  }else if(mode == 'era5_pr_include_ocean'){
    input = '/media/sdb5/Data/era5_evapor_pr_include_ocean'
    input = list.files(input,full.names = T,
                       pattern = '*.nc$')
    var = 'tp'
    input = input[25:39]
    data = stack(input,varname = var)
    data = data *1000*30.5 #m to mm
    }
  else if(mode == 'global_era5_temperature'){
    input = '/media/sdb5/Data/era5_temperature_include_ocean'
    input = list.files(input,full.names = T,
                       pattern = '*.nc$')
    var = 't2m'
    input = input[25:39]
    data = stack(input,varname = var)
  }else if(mode == 'global_era5_sst'){
    input = '/media/sdb5/Data/era5_temperature_include_ocean'
    input = list.files(input,full.names = T,
                       pattern = '*.nc$')
    input = input[25:39]
    var = 'sst'
    data = stack(input,varname = var)
  }else if(mode == 'global_era5_poten_evap'){
    input = '/media/sdb5/Data/era5_potential_evap'
    input = list.files(input,full.names = T,
                       pattern = '*.nc$')
    input = input[25:39]
    data = stack(input)
    data = data * -1 * 1000 * 30.5
  }
  return(data)
}
    
declare_glob_var_fun_cloud<-function(
  input_sub
){
  
  df = fread(paste0(input_sub,'/var_whole_route_mid.csv'))
  df_cal_dep <<- df
  
}
declare_glob_var_fun<-function(
  input_sub
){
  source('/home/share/R_project/xinjiang_vapor/source_fun.R')
  source_fun()
  
  df = fread(paste0(input_sub,'/var_whole_route_mid.csv'))
  df_cal_dep <<- df
  
}
divide_full_as_each_type_cloud <- function(x)
{
  xs = x[1]
  xe = x[length(x)]
  
  
  xsl = which(xfull == xs)[1]
  xel = which(xfull == xe)
  xel = xel[length(xel)]
  #print(xfull)
  #print(xel)
  xes <<- xfull[xsl:xel]
  select_first_loc<-function(id){
    tmpmark = which(xes == id)
    return(tmpmark)
  }
  
  ret_box = lapply(x,select_first_loc)
  ret_box = do.call('c',ret_box)
  ret_box = ret_box+(xsl-1)
  #print(length(unique(ret_box)))
  return(ret_box)
  
}
divide_full_as_each_type <- function(x)
{
  xs = x[1]
  xe = x[length(x)]
  
  
  xsl = which(xfull == xs)[1]
  xel = which(xfull == xe)
  xel = xel[length(xel)]
  #print(xfull)
  #print(xel)
  xes <<- xfull[xsl:xel]
  select_first_loc<-function(id){
    tmpmark = which(xes == id)
    return(tmpmark)
  }
  
  ret_box = lapply(x,select_first_loc)
  ret_box = do.call('c',ret_box)
  ret_box = ret_box+(xsl-1)
  #print(length(unique(ret_box)))
  return(ret_box)
  
}
era5_evapor<-function(
  mode = 'trend'
){
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  source('/home/share/R_project/xinjiang_vapor/trend_index.R')
  era5 = data_management(mode = 'era5_tevapor')
  
  era5_li = as.list(era5)
  era5_mean_ext<-function(x){
    xmean = cellStats(x,'mean')
    return(xmean)
  }
  
  
  era5_mean = lapply(era5_li,era5_mean_ext)
  era5_mean = do.call('c',era5_mean)
  era5_mean = -1*era5_mean*1000
  
  if(mode == 'trend'){
    era5_trend = trend_index(era5_mean,start = c(2003,1),fre = 12)
  }else{
    era5_trend = era5_mean
  }
  
 
  return(era5_trend)
  
}
era5_tmp<-function(
  mode = 'trend'
){
  era5t = data_management(mode = 'era5_temper')
  
  era5tb = 1
  for(i in 1:dim(era5t)[3]){
    tmp = cellStats(era5t[[i]],'mean')
    era5tb = c(era5tb,tmp)
  }
  era5tb = era5tb[-1]
  
  if(mode == 'trend'){
    era5tb = trend_index(era5tb,c(2003,1),12)
  }else{
    era5tb = era5tb
  }
  
  return(era5tb)
}
evaluate_pr_predicted_based_on_convey <- function(
  
){
  #input_gpcc and era5
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  gpcc_pr = paste0('gpcc_pr_in_target/',files,'.csv')
  era5_pr = paste0('era5_pr_in_target/',files,'.csv')
  
  gpcc_pr = do.call('cbind',lapply(gpcc_pr,fread))
  era5_pr = do.call('cbind',lapply(era5_pr,fread))
  
  #
  
}
extent_check_sst_df <- function(
  
){
  files = list.files('/media/root/Shen_drive1/CMIP6_combined',
                     full.names = T)[3]
  
  files = list.files(files,full.names = T)[1]
  files = list.files(files,full.names = T)
  
  model = list.files('/media/root/Shen_drive1/CMIP6/SST')
  for(i in 1:length(files)){
    tmp = try(stack(files[i]),silent = T)
    if('try-error' %in% class(tmp)){
      library(data.table)
      tmp = fread(files[i])
      tmp = as.data.frame(tmp)
      
      print(model[i])
      print(min(tmp[,1]))
      print(max(tmp[,1]))
      print(min(tmp[,2]))
      print(max(tmp[,2]))
     
    }else{
      print(extent(tmp))
    }
    print(i)
    
    
  }
  
}
extent_check_sst <- function(
  mode = 'ssp245'
){
  library(raster)
  library(data.table)
  files = list.files('/media/root/Shen_drive1/CMIP6_combined',
                     full.names = T)[3]
  
  if(mode !='ssp245'){
    files = list.files(files,full.names = T)[2]
  }else{
    files = list.files(files,full.names = T)[1]
  }
  
  files = list.files(files,full.names = T)
  
  model = list.files('/media/root/Shen_drive1/CMIP6/SST')
  for(i in 1:length(files)){
    tmp = try(stack(files[i]),silent = T)
    if('try-error' %in% class(tmp)){
      library(data.table)
      tmp = fread(files[i])
      tmp = as.data.frame(tmp)
      
      print(model[i])
      print(min(tmp[,1]))
      print(max(tmp[,1]))
      print(min(tmp[,2]))
      print(max(tmp[,2]))
      
      
      if(i == 6 |i ==7){
        id180 = which(tmp[,1]>=180)
        tmp[id180,1] = tmp[id180,1] -360
      }else{
        lt = -180
        id1 = which(tmp[,1]<=lt)
        tmp[id1,1] = tmp[id1,1]+360
        
      }
      
      fwrite(tmp,files[i])
    }else{
      if(i == 1){
        extent(tmp) = extent(-280,80,-90,90)
        tmp1 = crop(tmp,extent(-280,-180,-90,90))
        tmp2 = crop(tmp,extent(-180,80,-90,90))
        extent(tmp1) = extent(80,180,-90,90)
        
        tmp = merge(tmp1,tmp2)
        writeRaster(tmp,files[i],format = 'CDF',
                    overwrite = T)
      }else if(i == 3 | i ==5){
        tmp = try(stack(files[i]),silent = T)
        
        extent(tmp) = extent(-290,70,-90,90)
        tmp1 = crop(tmp,extent(-290,-180,-90,90))
        tmp2 = crop(tmp,extent(-180,70,-90,90))
        extent(tmp1) = extent(70,180,-90,90)
        
        tmp = merge(tmp2,tmp1)
        writeRaster(tmp,files[i],format = 'CDF',
                    overwrite = T)
        
      }else if(i ==8){
        tmp = try(stack(files[i]),silent = T)
        extent(tmp) = extent(0,360,-90,90)
        tmp1 = crop(tmp,extent(290,360,-90,90))
        tmp2 = crop(tmp,extent(0,290,-90,90))
        extent(tmp1) = extent(-70,0,-90,90)
        tmp = merge(tmp1,tmp2)
        extent(tmp) = extent(-180,180,-90,90)
        
        writeRaster(tmp,files[i],format = 'CDF',
                    overwrite = T)
      }
    }
    print(i)
    
    
  }
  
}
extract_mean_value_of_cmip6_over_ato13<-function(
  mode = 'ssp245'
){
  if(mode == 'ssp245'){
    input_cmip6_sst = list.files('/media/root/Shen_drive1/CMIP6_mask_sst',
                                 full.names = T)[1]

  }else{
    input_cmip6_sst = list.files('/media/root/Shen_drive1/CMIP6_mask_sst',
                                 full.names = T)[2]
    
  }
  
  input_sst1 = paste0(input_cmip6_sst,'/','region1')
  input_sst3 = paste0(input_cmip6_sst,'/region3')
  
  sst_files1 = list.files(input_sst1,full.names = T)
  sst_files3 = list.files(input_sst3,full.names = T)
  
  
  i <<- 1:8
  sst_files1 <<- sst_files1
  sst_files3 <<- sst_files3
  
  sub_cal_mean_sst1 <-function(i){
    library(raster)
    library(data.table)
    
    sst1 = try(stack(sst_files1[i]),silent = T)
    if('try-error' %in% class(sst1)){
      sst1 = fread(sst_files1[i])
      sst1 = as.data.frame(sst1)
      loc = sst1[,1:2]
      sstdf = sst1[,-c(1:2)]
      
      sstdfmean = apply(sstdf,2,mean,na.rm = T)
    }else{
      sstl1 = as.list(sst1)
      cell_fun <-function(x){
        xm = cellStats(x,'mean')
        return(xm)
      }
      sstdfmean = lapply(sstl1,cell_fun)
      sstdfmean = do.call('c',sstdfmean)
    }
    return(sstdfmean)
  }
  sub_cal_mean_sst3 <-function(i){
    library(raster)
    library(data.table)
    
    sst1 = try(stack(sst_files3[i]),silent = T)
    if('try-error' %in% class(sst1)){
      sst1 = fread(sst_files3[i])
      sst1 = as.data.frame(sst1)
      loc = sst1[,1:2]
      sstdf = sst1[,-c(1:2)]
      
      sstdfmean = apply(sstdf,2,mean,na.rm = T)
    }else{
      sstl1 = as.list(sst1)
      cell_fun <-function(x){
        xm = cellStats(x,'mean')
        return(xm)
      }
      sstdfmean = lapply(sstl1,cell_fun)
      sstdfmean = do.call('c',sstdfmean)
      
    }
    return(sstdfmean)
  }
  
  library(doParallel)
  cl = makeCluster(8)
  clusterExport(cl,c('i','sst_files1'))
  ret1 = parLapply(cl,i,sub_cal_mean_sst1)
  stopCluster(cl)
  
  
  library(doParallel)
  cl = makeCluster(8)
  clusterExport(cl,c('i','sst_files3'))
  ret3 = parLapply(cl,i,sub_cal_mean_sst3)
  stopCluster(cl)
  
  ret1 = do.call(cbind,ret1)
  ret3 = do.call(cbind,ret3)
  
  models = list.files('/media/root/Shen_drive1/CMIP6/SST')
  colnames(ret1) = models
  colnames(ret3) = models 
  
  dir.create('analysis_output/cmip6_by_model')
  dir.create('analysis_output/cmip6_by_model/sst')
  output = paste0('analysis_output/cmip6_by_model/sst/region',
                  c(1,3),'_',mode,'.csv')
  fwrite(ret1,output[1])
  fwrite(ret3,output[2])
}






extract_region_sum_value_of_pmeato13 <-function(
 mode = 'ssp245' 
){
  if(mode == 'ssp245'){
    input_pme = list.files(
      '/media/root/Shen_drive1/CMIP6_pme/ato/',
      full.names = T)[1]
  }else{
    input_pme = list.files(
      '/media/root/Shen_drive1/CMIP6_pme/ato/',
      full.names = T)[2]
  }
  
  input_pme1 = list.files(paste0(input_pme,'/region1'),
                          full.names = T)
  input_pme3 = list.files(paste0(input_pme,'/region3'),
                          full.names = T)
  
  
  i <<- 1:8
  input_pme1 <<- input_pme1
  input_pme3 <<- input_pme3
  
  sub_cal_sum_pme1<-function(i){
    library(raster)
    tmp = stack(input_pme1[i])
    
    tmp = as.list(tmp)
    
    cel_sum_fun <-function(x){
      sumx = cellStats(x,'sum')
      return(sumx)
    }
    
    retsum = lapply(tmp,cel_sum_fun)
    retsum = do.call('c',retsum)
    return(retsum)
  }
  
  sub_cal_sum_pme3<-function(i){
    library(raster)
    tmp = stack(input_pme3[i])
    
    tmp = as.list(tmp)
    
    cel_sum_fun <-function(x){
      sumx = cellStats(x,'sum')
      return(sumx)
    }
    
    retsum = lapply(tmp,cel_sum_fun)
    retsum = do.call('c',retsum)
    return(retsum)
  }
  
  library(doParallel)
  cl = makeCluster(8)
  clusterExport(cl,c('i','input_pme1'))
  ret1 = parLapply(cl,i,sub_cal_sum_pme1)
  stopCluster(cl)
  
  
  library(doParallel)
  cl = makeCluster(8)
  clusterExport(cl,c('i','input_pme3'))
  ret3 = parLapply(cl,i,sub_cal_sum_pme3)
  stopCluster(cl)
  
  
  ret1 = do.call('cbind',ret1)
  ret3 = do.call('cbind',ret3)
  
  models = list.files('/media/root/Shen_drive1/CMIP6/SST')
  colnames(ret1) = models
  colnames(ret3) = models 
  
  dir.create('analysis_output/cmip6_by_model')
  dir.create('analysis_output/cmip6_by_model/pme')
  output = paste0('analysis_output/cmip6_by_model/pme/region',
                  c(1,3),'_',mode,'.csv')
  
  fwrite(ret1,output[1])
  fwrite(ret3,output[2])
  
  
}
fig1_plot_xinjiang_vapor <-function(
  
){
  # Fig 1 
  # (a) Long term Contribution Rates
  # (b) Study Area Regionalization 
  # (c) Monthly pattern of contribution 
  source('/home/share/R_project/xinjiang_vapor/calc_long_term_contri.R')
  #calc_long_term_contri()
  print('long term mean of contri. has been calculated')
  source('/home/share/R_project/xinjiang_vapor/calc_cluster_traj.R')
  print('calc of traj has been done!')
  #calc_cluster_traj()
  
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management("world")
  world = crop(world,extent(-180,180,0,90))
  
  xj = shp_management('xinjiang')
  
  
  
  # import data
  # fig 1a contribution and route
  input_long_term_contr = 'analysis_output/long_term_mean_contr_raster.csv'
  long_term_contr = fread(input_long_term_contr)
  long_term_contr = as.data.frame(long_term_contr)
  naid = which(is.na(long_term_contr$contr_rate))
  long_term_contr = long_term_contr[-naid,]
  source('/home/share/R_project/xinjiang_vapor/cluster_whole_time_traj.R')
  #cluster_traj_df = cluster_whole_time_traj()
  cluster_traj_df = fread('analysis_output/fig2/cluster_traj_df.csv')
  cluster_traj_df = as.data.frame(cluster_traj_df)
  # fig 1a sub
  input_contr_by_sou = 'analysis_output/contr_in_source_variance_new.csv'
  contr_by_sou = as.data.frame(fread(input_contr_by_sou))
  
  sou_names = contr_by_sou[,1]
  contr_by_sou = contr_by_sou[,-1]
  
  contr_by_sou_mean = apply(contr_by_sou,1,mean,na.rm= T)
  contr_by_sou_mean = as.numeric(contr_by_sou_mean)
  
  sou_names[2]= 'nato'
  bar_df = data.frame(source = sou_names,
                      contr_rates = contr_by_sou_mean)
  
  idorder = order(bar_df$contr_rates,decreasing = T)
  bar_df = bar_df[idorder,]
  bar_df$contr_rates[which(bar_df$contr_rates<0)] = 0
  
  # fig 1b study area dem
  dem = raster('dem/dem.nc')
  dem = crop(dem,xj)
  dem = as.data.frame(dem,xy = T)
  naid = which(is.na(dem$dem))
  dem = dem[-naid,]
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  south_xj = shp_management('xinjiang_south')
  north_xj = shp_management('xinjiang_north')
  
  xj = shp_management('xinjiang')
  ex_xinjiang = extent(xj)
  ex_xinjiang = round(ex_xinjiang)
  ex_xinjiang[c(1,3)] = ex_xinjiang[c(1,3)]-0.5
  ex_xinjiang[c(2,4)] = ex_xinjiang[c(2,4)]+0.5
  
  border = as(ex_xinjiang,'SpatialPolygons')
  crs(border) = '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'
  
  #ex_xinjinang_shp = as(ex_xinjiang,'SpatialPolygon')
  world_crop = crop(world,ex_xinjiang)
  china = shp_management('china')
  china_crop = crop(china,ex_xinjiang)
  # fig 
  
  # import shp
  ######
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management("world")
  world = crop(world,extent(-180,180,0,90))
  
  xj = shp_management('xinjiang')
  
  
  # color set
  
  # plot set 
  fontsize = 12
  plot_set = theme(panel.background = element_rect(fill = 'transparent',color = 'black'),
                   axis.text = element_text(face='bold',colour='black',size=fontsize,hjust=.5),
                   axis.title = element_text(face='bold',colour='black',size=fontsize,hjust=.5),
                   legend.position=c('bottom'),
                   legend.direction = c('horizontal'))
  
  # plot zone
  library(RColorBrewer)
  fillcolor = colorRampPalette(brewer.pal(11,'Blues'))(14)
  fillcolor = fillcolor[3:14]
  
  #lincolor = colorRampPalette(pal_lancet('lanonc',0.8)(9))(20)
  lincolor = colorRampPalette(brewer.pal(9,'Spectral'))(20)
  #lincolor = rev(lincolor)
  linecol_manual = c('AS' = lincolor[1],
                     'EU' = lincolor[2],
                     'ATO' = lincolor[3],
                     'CS' = lincolor[5],
                     'MS' = lincolor[6],
                     'NA' = lincolor[10])
  
  sizemanual = c('AS'= 2,
                 'EU'=1.5,
                 'ATO'=1,
                 "CS" = 0.5,
                 "MS" = 0.5,
                 'NA' = 0.25)
  
  cluster_traj_df$region = factor(cluster_traj_df$region,
                                  levels = c('AS',"EU",'ATO',
                                             "CS",'MS','NA'))
  p1 = ggplot()+
    #############
    geom_tile(data = long_term_contr,aes(x = x,y = y,fill = cuts),
              alpha = 0.5)+
    geom_polygon(data = world,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 0.5)+
    geom_polygon(data = xj,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 0.5)+
    geom_polygon(data = border,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 0.5)+
    geom_path(data = cluster_traj_df,aes(x = long,y = lat,
                                         group = routeid,
                                         color = factor(routeid)),
              size = 1,
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="closed"))+
    #scale_fill_gradientn(colors = mycolor)+
    scale_fill_manual(values = fillcolor)+
    scale_color_manual(values = lincolor)+
    #scale_size_manual(values = sizemanual)+
    #facet_wrap(~type,nrow = 4)+
    #coord_fixed(1.3)+
    guides(color = guide_legend(title= "Trajectory"),
           size = guide_legend(title= "Trajectory"),
           fill = guide_legend(title= "Contribution rate (1/10000000)"))+
    #facet_wrap(~type,nrow = 3,scales = 'free')+
    theme_bw()+
    plot_set+
    theme(legend.position = 'none')+
    xlab('Longitude')+
    ylab('Latitude')
  #############
    
  
  bar_df$source = toupper(bar_df$source)
  bar_df$source = factor(bar_df$source,levels = bar_df$source)
  barcolor = colorRampPalette(brewer.pal(11,'Spectral'))(14)
  #barcolor = colorRampPalette(pal_lancet('lanonc',1)(9))(13)
  barcolor = c('AS' = barcolor[1],
               'EU' = barcolor[2],
               'NATO' = barcolor[3],
               'NAF' = barcolor[4]) 
  bar_df = bar_df[1:4,]
  
  label_df = data.frame(
    x = bar_df$source,
    y = bar_df$contr_rates +5,
    z = paste0(round(bar_df$contr_rates,1),'%')
  )
  p1a = ggplot()+
    ######
    geom_bar(data = bar_df,aes(x = source, y = contr_rates,
                               fill = source),stat = 'identity',
             position = 'dodge',width = 0.6,alpha = 0.8)+
    scale_fill_manual(values = barcolor)+
    geom_text(data = label_df,
                    aes(x = x,y = y,label = z),
                    color = 'black',size = 3,hjust =0.5)+
    theme_bw()+
    plot_set+
    theme(
          legend.position = 'none',
          panel.border = element_rect(fill = 'transparent',
                                      color = 'transparent'),
          axis.title = element_text(size = 5,color = 'black',
                                    hjust = 0.5),
          panel.background = element_rect(fill = 'transparent',
                                          color = 'transparent'),
          panel.grid =element_blank(),
          axis.text = element_text(size = 5,color = 'black',hjust = 0.5),
          axis.line.x = element_line(color= 'black',size = 0.5))+
    xlab('Source region')+
    ylab('Contribution rate (%)')
    #scale_fill_aaas(0.5)+
    #scale_fill_lancet()+
  ######
  
  library(gridExtra)
  library(cowplot)
  
  p1combine =  ggdraw()+
    draw_plot(p1)+
    draw_plot(p1a, x = 0.07, y = 0.37,
              width = 0.3, height = 0.15)
  
  #p1combine
  
  # p2 spatial pattern of dem
  p1b = ggplot()+
    #####
    geom_tile(data = dem,aes(x = x,y = y,fill = dem),
              color = 'transparent')+  
    geom_polygon(data = south_xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = north_xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    
    geom_polygon(data = south_moun,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = north_moun,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    scale_fill_distiller(palette = 'Spectral')+
    geom_path(data = cluster_traj_df,aes(x = long,y = lat,
                                         group = routeid,
                                         color = factor(routeid)),
              size = 1,
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="closed"))+
    #scale_fill_gradientn(colors = mycolor)+
    #scale_fill_manual(values = fillcolor)+
    scale_color_manual(values = lincolor)+
    
    scale_x_continuous(limits = ex_xinjiang[1:2])+
    scale_y_continuous(limits = ex_xinjiang[3:4])+
    guides(color = 'none')+
    #coord_fixed(1.3)+
    theme_bw()+
    plot_set+
    theme(axis.title.y = element_blank())+
    theme(legend.position = 'none')+
    xlab('Longitude')+
    ylab('Latitude')
  #####
  
  # p3 variation of line
  input_long_term_contr = 'analysis_output/contr_in_source_variance_new.csv'
  contr_df = fread(input_long_term_contr)
  contr_df = as.data.frame(contr_df)

  sou_names = toupper(contr_df[,1])
  
  contr_df = contr_df[,-1]
  contr_df[10,] = 0
  contr_full_sum = apply(contr_df,2,sum,na.rm = T)
  contr_chos = contr_df[c(2,9,11),]
  contr_chos = apply(contr_chos,2,sum,na.rm = T)
  
  contr_chos = as.numeric(contr_chos)
  contr_full = as.numeric(contr_full_sum)

  ratio = contr_chos/ contr_full_sum * 100
  
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),
             '1 month')
  dfcontr = data.frame(date,contr_full,contr_chos)
  dfcontr = melt(dfcontr,'date')
  
  dfratio = data.frame(date,contr_chos,ratio)
  dfratio = dfratio[which(dfratio$ratio>=80),]
  
  dfratio$label = paste0(round(dfratio$ratio,1),
                         '%')
  
  
  dfratio90 = dfratio[which(dfratio$ratio>=90),]
  
  label_df2 = data.frame(
    x = as.Date('2015-01-01'),
    y = 18,
    label = paste0('')
  )
  library(ggrepel)
  line1c = pal_lancet(alpha = 1)(2)
  color_value = c('contr_full' = line1c[2],
                  'contr_chos' = line1c[1])
  p1c = ggplot()+
    geom_line(data= dfcontr,aes(x= date,y = value,
                                color = variable))+
    geom_point(data = dfratio,aes(x = date,y = contr_chos),
               size = 3,shape = 1,
               color = 'blue')+
    geom_text(data = label_df2,
                    aes(x = x,y = y,label = label),
                    color = 'blue',
                    size = 5)+
   # geom_text_repel(data = dfratio,aes(x = date,
    #                                   y = contr_chos,
    #                                   label = label),
    #                color = 'black',
    #                size = 3,
    #                check_overlap = T)+
               
    #scale_fill_manual(values= tilecolor)+
    #scale_fill_manual(values = barcolor)+
    #scale_y_continuous(position = 'right')+
    scale_color_manual(values =color_value,
                       labels = c('TCR','CR(AS+EU+NATO)'))+
    theme_bw()+
    plot_set+
    theme(legend.position = 'none')+
    xlab('Time (month)')+
    ylab('Contribution rate (continent scale)')
  
  
  
  p1ab = plot_grid(p1,p1b,align = 'h',
                   axis = 'tb',nrow = 1,
                   rel_widths = c(3,1.4),
                   rel_heights = c(1,1),labels = c('','(b)'),
                   label_x = c(0.10,0.15),
                   label_y = c(0.98,0.98))
  p1abc3 = plot_grid(p1ab,p1c,align = 'h',
                    axis = 'l',nrow = 2,
                    rel_widths = c(1,1),
                    rel_heights = c(1.3,1),labels = c('(a)','(c)'),
                    label_x = c(0.065,0.065),
                    label_y = c(0.965,0.98))
  
  p1a = p1a+
    theme(plot.background = element_rect(fill = 'transparent'),
          axis.text = element_text(size = 10,color = 'black',
                                   hjust = 0.5),
          axis.title = element_blank())
  
  p1abc_sub = ggdraw()+
    draw_plot(p1abc3)+
    draw_plot(p1a, x = 0.058, y = 0.57,
              width = 0.18, height = 0.19)
  
  
  png('main_plot/fig1/fig1abc5.png',
      height = 18,
      width = 25,
      units = 'cm',
      res = 800)
  print(p1abc_sub)
  dev.off()
  
  legend_theme = theme(legend.position = 'bottom',
                       legend.background = element_rect(fill = 'transparent',
                                                        color = 'transparent'),
                       legend.text = element_text(color = 'black',size = fontsize),
                       legend.title = element_text(color = 'black',size = fontsize,face = 'bold'))
                
  library(ggpubr)
  p1_legend = p1+
    legend_theme+
    guides(fill = guide_legend(title = 'Contribution rates of particles',nrow = 2),
           color = 'none')
  p1_legend = get_legend(p1_legend)
  p1_legend = as_ggplot(p1_legend)
  #
  png('main_plot/fig1/fig1a_legend.png',
      height = 18,
      width = 25,
      units = 'cm',
      res = 800)
  print(p1_legend)
  dev.off()
  
  p2_legend = p1b+
    legend_theme+
    guides(color = 'none',
           fill = guide_legend(title = 'DEM (m)',
                               label.position = 'right'))+
    theme(legend.text = element_text(color = 'black',size = 8))+
    theme(legend.title = element_text(color = 'black',size = 8,
                                      face = 'bold'))
  p2_legend = get_legend(p2_legend)
  p2_legend = as_ggplot(p2_legend)
  
  png('main_plot/fig1/fig1b_legend.png',
      height = 0.7,
      width = 7,
      units = 'cm',
      res = 800)
  print(p2_legend)
  dev.off()
  
  
  p3_legend = p1c +
    legend_theme+
    guides(color = guide_legend(title = 'Sum of contribution rates'))
  
  p3_legend = as_ggplot(get_legend(p3_legend))
  png('main_plot/fig1/fig1c_legend.png',
      height = 18,
      width = 25,
      units = 'cm',
      res = 800)
  print(p3_legend)
  dev.off()
  
  
    
  
  source('/home/share/R_project/xinjiang_vapor/traj_plot_fun.R')
  
  
  # p3 
  
  
  
  p1b+theme(legend.position = 'bottom')+legend_theme+
    #theme(legend.key.width = unit(2,'cm'))+
    guides(fill= guide_legend(title = 'DEM (m)',
                              keywidth = unit(2,'cm'),
                              label.position = 'bottom'),color = 'none')
  
  
  
  
  
  
  
  
  
  
  
}
fig2_backup_plot_tws_mmk<-function(
  
){
  library(ggnewscale)
  library(ggplot2)
  library(raster)
  
  # import world shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management('world')
  world = crop(world,extent(c(-180,180,0,90)))
  shp_as = shp_management('land','as')
  shp_eu = shp_management('land','eu')
  shp_naf = shp_management('land','naf')
  shp_as_eu = bind(shp_as,shp_eu,shp_naf)
  
  shp_oce = list.files('cluster_shp/ato',
                       full.names = T,
                       pattern = '*.shp$')[1:4]
  shp_oces = lapply(shp_oce,shapefile)
  shp_oce = do.call('bind',lapply(shp_oce,shapefile))
  # import sub windows 
  shp_com = shapefile('analysis_output/fig2/combine_sub_window.shp')
  input = paste0('sub_windows/sub_window',1:19,'.shp')
  shp_sep = lapply(input,shapefile) 
  # import tws land mmk
  #twsmmk_land = fread('analysis_output/fig2/tws_mmk_df.csv')
  #twsmmk_land = as.data.frame(twsmmk_land)
  twsmmk_land = raster('analysis_output/tws_mmk.nc')
  twsmmk_land = mask(twsmmk_land,shp_as_eu)
  
  mmksst = shapefile('analysis_output/fig2/sst_big0.shp')
  
  
  
  ex_as_ato = extent(shp_as_eu)
  ex_as_ato = extent(-50,ex_as_ato[2],ex_as_ato[3],
                     ex_as_ato[4])
  
  twsmmk_land = crop(twsmmk_land,ex_as_ato)
  twsmmk_land = as.data.frame(twsmmk_land,
                              xy = T)
  colnames(twsmmk_land) = c('long','lat',"value")
  lesszerotws = which(twsmmk_land$value<0)
  twsmmk_land = twsmmk_land[lesszerotws,]

  twsmmk_land$cuts = cut(twsmmk_land$value,
                         breaks = c(-700,seq(-20,0,2)))
  
  pme_ocean = raster('analysis_output/fig2/pme_ato_mmk.nc')
  pme_oceandf = as.data.frame(pme_ocean,xy = T)
  dfnaid = which(is.na(pme_oceandf[,3]))
  pme_oceandf = pme_oceandf[-dfnaid,]
  negid = which(pme_oceandf[,3]<0)
  pme_oceandf = pme_oceandf[negid,]
  
  colnames(pme_oceandf) = c('long','lat','value')
  pme_oceandf$cuts = cut(pme_oceandf$value,
                         breaks = c(-42,seq(-10,0,2)))
  library(ggnewscale)
  library(RColorBrewer)
  
  cobreaks = c(-700,-42,seq(-20,-12,2),
             seq(-10,0,1))
  
  land_tws_mmk_pal = colorRampPalette(
    brewer.pal(9,'YlOrRd'))(25)
  land_tws_mmk_pal = rev(land_tws_mmk_pal)
  land_tws_mmk_pal = land_tws_mmk_pal[seq(1,25,2)[1:11]]
  
  sea_pme_mmk_pal = colorRampPalette(
    brewer.pal(9,'YlOrRd')
  )(25)
  #sea_pme_mmk_pal = sea_pme_mmk_pal[1:]
  sea_pme_mmk_pal = rev(sea_pme_mmk_pal)
  sea_pme_mmk_pal = sea_pme_mmk_pal[seq(1,25,2)[c(2,7:11)]]
  
  # main plot
  fontsize = 12
  text_theme_set = theme(
    axis.text = element_text(
                             color = 'black',
                             size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
                               color = 'black',
                               size = fontsize),
    legend.title = element_text(
                                color = 'black',
                                size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  
  cluster_traj_df = fread('analysis_output/fig2/cluster_traj_df.csv')
  cluster_traj_df = as.data.frame(cluster_traj_df)
  route_col = pal_npg()(10)[4]
  route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
  
  route_col = colorRampPalette(brewer.pal(
    9,'Blues'
  ))(20)
  
  cur_df = as.data.frame(
    fread('analysis_output/fig4/current_df.csv')
  )
  
  idless50 = which(cur_df$lat <= 50)
  cur_df = cur_df[idless50,]
  
  idbig1 = which(cur_df$u>0 &
                   cur_df$v >0)
  idbig2 = which(cur_df$u<0 &
                   cur_df$v >0)
  
  cur_df1 = cur_df[idbig1,]
  cur_df2 = cur_df[idbig2,]
  
  cid1 = seq(1,nrow(cur_df1),30)
  cid2 = seq(1,nrow(cur_df2),200)
  
  cur_df1 = cur_df1[cid1,]
  cur_df2 = cur_df2[cid2,]
  
  
  cols_cur = c('#2988AE','#30376E')
  
  xj = shp_management('xinjiang')
  
  cal_center_point <- function(x){
    xm = extent(x)
    latm = round((xm[3]+xm[4])/2)
    longm = round((xm[1]+xm[2])/2)
    rm = data.frame(x = longm,y = latm)
    return(rm)
  }
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  dfhigh_label = lapply(shp_sep[id_box],cal_center_point)
  dfato_label = lapply(shp_oces,cal_center_point)
  
  
  dfhigh_label = do.call(rbind,dfhigh_label)
  dfato_label = do.call(rbind,dfato_label)
  
  dfhigh_label$label = paste0('(',letters[1:10],')')
  dfato_label$label = paste0('NATO',1:4)
  
  
  sst_col = pal_npg(alpha = 0.5)(9)[1]
  pmmk2 = ggplot()+
    ###############
    geom_polygon(data = world,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    
    geom_tile(data = twsmmk_land,
             aes(x = long,y= lat,fill = cuts))+
    geom_polygon(data = xj,
                 aes(x = long,y= lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    scale_fill_manual(values = land_tws_mmk_pal,
                      guide = guide_legend(
                        title = 'TWS_MMK',
                        title.position = 'top',
                        nrow = 2
                      ))+
    new_scale_fill()+
    geom_tile(data = pme_oceandf,
              aes(x = long,y = lat,fill = cuts))+
    scale_fill_manual(values = sea_pme_mmk_pal)+
    geom_path(data = cluster_traj_df,aes(x = long,y = lat,
                                         group = routeid,
                                         color = factor(
                                           routeid,
                                           levels = 1:20
                                         )),
              size = 1,
              linetype = 'solid',
              #color = route_col[5],
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="open"))+
    scale_color_manual(values = route_col,
                       guide = 'none')+
    geom_polygon(data = shp_com,
                 aes(x = long,y = lat,group =group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    #geom_polygon(data = mmksst,
    #             aes(x = long,y = lat,
    #                 group = group),
    #             fill =  land_tws_mmk_pal[5],
    #             #color = land_tws_mmk_pal[5],
    #             alpha = 0.1)+
    geom_text_repel(data = dfhigh_label,
              aes(x = x,y = y,label = label),
              size = 3.5,
              color = 'black',
              bg.color = 'white',
              bg.r = 0.25,
              force = F)+
    geom_segment(data = cur_df1,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.15,'cm'),
                               type = 'open'),
                 color = cols_cur[1])+
    geom_segment(data = cur_df2,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.2,'cm'),
                               type = 'open'),
                 color = cols_cur[2])+
    guides(fill = 
             guide_legend(title = 'PME_ATO_MMK',
                          title.position = 'top',
                          nrow = 2))+
    theme_bw()+
    text_theme_set+
    ###############
    xlab('Longitude')+
    ylab('Latitude')
  
  world_crop = crop(world,extent(shp_oce))
  pmmk_oce = ggplot()+
    
    geom_polygon(data = shp_oce,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    #geom_polygon(data = mmksst,
    #             aes(x = long,y = lat,
    #                 group = group),
    #             fill =  land_tws_mmk_pal[5],
                 #color = land_tws_mmk_pal[5],
    #             alpha = 0.1)+
    geom_tile(data = pme_oceandf,
              aes(x = long,y = lat,fill = cuts))+
    geom_text_repel(data = dfato_label,
                    aes(x = x,y = y,label = label),
                    size = 2.7,
                    color = 'black',
                    bg.color = 'white',
                    bg.r = 0.25,
                    force = F)+
    scale_fill_manual(values = sea_pme_mmk_pal,
                      guide = 'none')+
    xlim(c(extent(shp_oce)[1],
           extent(shp_oce)[2]))+
    
    theme_bw()+
    theme(
      axis.text = element_text(
        color = 'black',
        size = 10
      ),
      axis.title =  element_blank()
    )
    
  # line plot 
  source('/home/share/R_project/xinjiang_vapor/cor_analysis_sub_windowtws_atope.R')
  ret_box1 = cor_analysis_sub_windowtws_atope(mode ='ato1')
  ret_box2 = cor_analysis_sub_windowtws_atope(mode ='ato2')
  ret_box3 = cor_analysis_sub_windowtws_atope(mode ='ato3')
  ret_box4 = cor_analysis_sub_windowtws_atope(mode ='ato4')
  
  pme_oce = data.frame(
    PME_ATO1= ret_box1[[1]],
    PME_ATO3= ret_box3[[1]]
    #pme_ato3= ret_box3[[1]],
    #pme_ato4= ret_box4[[1]]
  )
  colnames_land = paste0('sub_window',1:10)
  twsland_df = as.data.frame(ret_box1[[2]])
  colnames(twsland_df) = paste0('HSW',1:10)
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),
             '1 month')
  date = date[1:174]
  date = date[-c(1:6,169:174)]
  
  pme_oce_df = data.frame(
    date = date,
    pme_oce
  )
  pme_oce_df = reshape2::melt(pme_oce_df,'date')
  
  colnames(twsland_df) = paste0('HSW',1:10)
  
  twsland_df1 = data.frame(
    date,
    twsland_df[,1:5]
  )
  twsland_df2 = data.frame(
    date = date,
    twsland_df[,6:10]
  )
  
  twsland_df1 = reshape2::melt(twsland_df1,'date')
  twsland_df2 = reshape2::melt(twsland_df2,'date')
  
  twsland_df1$type = twsland_df1$variable
  twsland_df2$type = twsland_df2$variable
  
  library(ggsci)
  #pals1 = pal_lancet(alpha = 1)(9)
  pals2 = pal_lancet(alpha = 0.8)(9)
  twscol = pals2[7]
  pmecol = c(pals2[1],pals2[3])
  
  twsland_df1$color = 'TWS'
  twsland_df2$color = 'TWS'
  pme_oce_df$color = pme_oce_df$variable
  
  pline1 = ggplot()+
    geom_line(data = twsland_df1,
              aes(x = date,y = value,
                  color = color),
              size = 2)+
    geom_line(data = pme_oce_df,
              aes(x = date,y= value,color = color)
              ,size = 1)+
    scale_color_manual(values = c(pmecol,twscol))+
    facet_wrap(~type,nrow = 1)+
    theme_bw()+
    text_theme_set
  
  pline2 = ggplot()+
    geom_line(data = twsland_df2,
              aes(x = date,y = value,
                  color = color),
              size = 2)+
    geom_line(data = pme_oce_df,
              aes(x = date,y= value,color = color)
              ,size = 1)+
    scale_color_manual(values = c(pmecol,twscol))+
    facet_wrap(~type,nrow = 1)+
    theme_bw()+
    text_theme_set
  
  Sub_name = paste0('HSW',1:10)
  # side point cor plot
  side_cor_df = data.frame(
    Sub_windows = paste0('HSW',1:10),
    ATO1_COR = ret_box1[[4]],
    ATO2_COR = ret_box2[[4]],
    ATO3_COR = ret_box3[[4]],
    ATO4_COR = ret_box4[[4]]
  )
  
  side_cor_df = reshape2::melt(side_cor_df,
                               'Sub_windows')
  side_cor_df$Sub_windows = 
    factor(side_cor_df$Sub_windows,
           levels = rev(Sub_name))
  
  point_pal = colorRampPalette(pal_lancet(alpha = 0.8)(9))(10)
  #point_pal = pals2[1:10]
  
  side_cor_df_mean = aggregate(side_cor_df$value,
                               list(side_cor_df$variable),
                               mean)
  colnames(side_cor_df_mean) = c("variable",
                                 'value')
  side_cor_df_mean$label = 
    round(side_cor_df_mean$value,2)
  
  library(ggrepel)
  pside = ggplot()+
    #############
    geom_point(data = side_cor_df,
               aes(y = variable,
                   x = value,
                   color = factor(Sub_windows,
                                  levels = Sub_name)),
               size = 9-4,
               shape = 1)+
    
    geom_point(data = side_cor_df,
               aes(y = variable,
                   x = value,
                   color = factor(Sub_windows,
                                  levels = Sub_name)),
               size = 8.75-4,
               shape = 1)+
    geom_point(data = side_cor_df,
               aes(y = variable,
                   x = value,
                   color = factor(Sub_windows,
                                  levels = Sub_name)),
               size = 9.25-4,
               shape = 1)+
    geom_point(data = side_cor_df,
               aes(y = variable,
                   x = value,
                   color = factor(Sub_windows,
                                  levels = Sub_name)),
               size = 8.50-4,
               shape = 1)+
    geom_text_repel(data = side_cor_df_mean,
                    aes(y = variable,
                        x = value,
                        label = label),
                    nudge_y = 0.25,
                    size = 4,
                    hjust = 0.5)+
    #############
    scale_y_discrete(labels = c('ATO1','ATO2','ATO3','ATO4'))+
    theme_bw()+
    text_theme_set+
    #scale_size_manual('',values = c(3,5,7,9,11))+
    #scale_size_continuous(range = c(1,15))+
    scale_color_manual('',values = point_pal)+
    guides(color = guide_legend(title = 'Cross Correlation',
                                title.position = 'top'))
  
  
  
  library(cowplot)
  pline1 = pline1+theme(legend.position = 'none')
  pline2 = pline2+theme(legend.position = 'none')
  pmmk2 = pmmk2 +theme(legend.position = 'none')
  
  pline1 = pline1+
    theme(axis.text.y = element_text(hjust = 0.5,
                                     angle = 90))
  
  pline2 = pline2+
    theme(axis.text.y = element_text(hjust = 0.5,
                                     angle = 90))
  pmmk2 = pmmk2+
    theme(axis.text.y = element_text(hjust = 0.5,
                                     angle = 90))
  
  
  dfsubs_line1 = data.frame(
    x = rep(as.Date('2005-01-01'),5),
    y = rep(-0.45,5),
    label = paste0('(',letters[1:5],')'),
    type = paste0('HSW',1:5)
  )
  
  dfsubs_line2 = data.frame(
    x = rep(as.Date('2005-01-01'),5),
    y = rep(-0.45,5),
    label = paste0('(',letters[8:12],')'),
    type = paste0('HSW',6:10)
  )
  
  
  dfsubs_tws = data.frame(
    x = -175,
    y = 80,
    label = "(g)"
  )
  
  dfside = data.frame(
    x = 0.75,
    y = 'ATO4',
    label = '(f)'
  )
  
  pline1 = pline1+
    geom_text(data = dfsubs_line1,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black')+ylab('Indices')+
    xlab('Time (month)')
     #+theme(axis.title.x = element_blank())
  
  pline2 = pline2+
    geom_text(data = dfsubs_line2,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black')+xlab('Time (month)')+ylab('Indices')
   #+theme(axis.title.x = element_blank())
  
  pmmk2 = pmmk2+
    geom_text(data = dfsubs_tws,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black')
 
  
  
  p1 = plot_grid(pline1,pmmk2,pline2,
            align = 'hv',
            axis = 'lr',
            rel_widths = c(1,1,1),
            rel_heights = c(3,6,3),
            ncol = 1)
  pside = pside+theme(
    #axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_text(face = 'bold',
                               color= 'black',
                               size = fontsize,
                               hjust = 0.5,
                               angle = 90),
    #axis.text.y = element_blank(),
    legend.position = 'none')+
    xlab('Cross correlation')

  
  p12 = plot_grid(p1,pside,
                  align = 'v',
                  axis = 'b',
                  rel_widths = c(6,2),
                  rel_heights = c(1,1),
                  nrow = 1)
  
  library(gridExtra)
  p123 = ggdraw()+
    draw_plot(p12)+
    draw_plot(pmmk_oce,x = 0.08, y = 0.33,
              width = 0.16, height = 0.22)
  
  
  legend_line = get_legend(pline1+
                             theme(legend.position = 'bottom')+
                             guides(color = guide_legend(nrow = 1,
                                                         title = 'Indices',
                                                         title.position = 'top')))
  
  legend_map = get_legend(pmmk2+
                            theme(legend.position = 'bottom'))
  
  legend_side = get_legend(pside+
                             theme(legend.position = 'bottom'))
  
  library(ggpubr)
  legend_line = as_ggplot(legend_line)
  legend_map = as_ggplot(legend_map)
  legend_side = as_ggplot(legend_side)
  
  legend_line = legend_line+
    theme(plot.margin = unit(rep(0,4),'cm'))
  legend_map = legend_map+
    theme(plot.margin = unit(rep(0,4),'cm'))
  legend_side = legend_side+
    theme(plot.margin = unit(rep(0,4),'cm'))
  
  
  
  legs1 = plot_grid(legend_side,legend_line,
                    nrow = 1,
                    rel_heights = c(1,1))
  
  p4 = plot_grid(
    p123,legend_map,legs1,
    ncol = 1,
    rel_heights = c(10,1,1)
  )
  
  png('main_plot/fig2/fig2_final_mod3.png',
      height = 26,
      width = 27,
      units = 'cm',
      res = 800)
  print(p4)
  dev.off()
  
  
  png('main_plot/fig2/leg1.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(legend_line)
  dev.off()
  
  png('main_plot/fig2/leg2.png',
      height = 20,
      width = 30,
      units = 'cm',
      res = 800)
  print(legend_map)
  dev.off()
  
  png('main_plot/fig2/leg3.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(legend_side)
  dev.off()
  
  
}
fig2_plot_xinjiang_vapor <- function(
  
){
  #1. import cluster in each ocean
  input_source_cluster_shp = list.files('cluster_shp',
                                        full.names = T)
  input_source_cluster_shp = lapply(input_source_cluster_shp,
                                    list.files,
                                    full.names = T,
                                    pattern = '*.shp$')
  input_cluster_shp = do.call('c',input_source_cluster_shp)
  input_cluster_shp = input_cluster_shp[-c(9,10)]
    
  shp_list = lapply(input_cluster_shp,shapefile)
  shp_eu1_as2 = do.call('bind',shp_list[c(2,7,9)])
  
  shp_combine = do.call('bind',shp_list)
  
  world = shp_management('world')
  world = crop(world,extent(c(-180,180,0,90)))
  
  pmap = ggplot()+
    geom_polygon(data = world,aes(x = long,y = lat,
                                  group = group),
                 fill = 'grey50',
                 color = 'black',
                 size = 0.5)+
    geom_polygon(data = shp_eu1_as2,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    geom_path(data = cluster_traj_df,aes(x = long,y = lat,
                                         group = routeid,
                                         color = factor(routeid)),
              size = 1,
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="closed"))
  
  
  # 
  
  
  
  
  
  
  
    
  
  
}
fig3_abnormal_phenomana <- function(
  
){
  # cal sub windows pme 
  source('/home/share/R_project/xinjiang_vapor/cal_mean_tws_for_subwindow.R')
  #cal_mean_pme_for_subwindow()
  library(data.table)
  library(ggplot2)
  
  pme_subs <-fread('analysis_output/pme_subwindow_2003_2017.csv')
  tws_subs <- fread('analysis_output/tws_subwindow_2003_2017.csv')
  input_pme_oce = c(
    'analysis_output/fig2/pme_ato1_trend.csv',
    'analysis_output/fig2/pme_ato2_trend.csv',
    'analysis_output/fig2/pme_ato3_trend.csv',
    'analysis_output/fig2/pme_ato4_trend.csv'
  )
  
  pme_oce <-lapply(lapply(input_pme_oce,
                             fread),
                    as.data.frame)
  
  pme_oce = data.frame(
    pme_ato1 = pme_oce[[1]][,2],
    pme_ato2 = pme_oce[[2]][,2],
    pme_ato3 = pme_oce[[3]][,2],
    pme_ato4 = pme_oce[[4]][,2]
  )
  
  pme_subs = as.data.frame(pme_subs)
  tws_subs = as.data.frame(tws_subs)
  
  pme_subs = pme_subs[,-1]
  tws_subs = tws_subs[,-1]
  
  naid = which(is.na(pme_subs[,1]))
  pme_subs = pme_subs[-naid,]
  tws_subs = tws_subs[-naid,]
  
  cor_box = 1
  for(i in 1:ncol(pme_subs)){
    tmpcor = max(ccf(pme_subs[,i],
                     tws_subs[,i])$acf)
    
    cor_box = c(cor_box,tmpcor)  
  }
  cor_box =cor_box[-1]
  
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),
             '1 month')
  date = date[1:174]
  date = date[-naid]
  
  colnames(pme_subs) = paste0('SW',1:19)
  colnames(tws_subs)   = paste0('SW',1:19)
  
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  pme_subs = pme_subs[,id_box]
  tws_subs = tws_subs[,id_box]
  pme_subs_df = data.frame(
    date = date,
    pme_subs
  )
  tws_subs_df = data.frame(
    date = date,
    tws_subs
  )
  
  pme_df = reshape2::melt(pme_subs_df,'date')
  tws_df = reshape2::melt(tws_subs_df,'date')
  
  pme_df$type = 'pme'
  tws_df$type = 'TWS'
  
  pme_tws_df = rbind(pme_df,tws_df)
  df1 = data.frame(variable = pme_df$variable,
                   pme = pme_df$value,
                   tws = tws_df$value)
  pline = ggplot()+
    geom_point(data = df1,
              aes(x  = pme,y = tws),
              color = 'blue',
              size = 3,
              shape = 1)+
    facet_wrap(~variable,nrow = 4)+
    theme_bw()
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  }
fig3_plot<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/spatio_tws_evolu.R')
  spatio_tws_evolu()
}
fig3_pme_content_analysis<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  
  pmeato = pe_in_source[,5:8]- pet_sum[,5:8]
  
  input_era5_pr = list.files('era5_pr_in_target',
                             full.names = T)#[c(1,3)]
  input_eva_intarget = list.files('poten_evap_in_target',
                                  full.names =T)#[c(1,3)]
  
  era5_pr = lapply(lapply(input_era5_pr,fread),
                   as.data.frame)
  eva = lapply(lapply(input_eva_intarget,fread),
               as.data.frame)
  
  era5_pr = do.call('cbind',era5_pr)
  eva = do.call('cbind',eva)

  era5_pr = era5_pr[1:174,]
  eva = eva[1:174,]
  pmeato = pmeato[1:174,]
  #era5_pr = apply(era5_pr,1,sum)
  #eva = apply(eva,1,sum)
  
  era5_pme = era5_pr - eva
  
  #tws = apply(tws,1,sum)
  
  stand_fun <-function(x){
    
    x = ts(x,start = c(2003,1),
           frequency = 12)
    xt = decompose(x)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    x = xt
    
    x = (x -mean(x,na.rm = T))/(max(x,na.rm = T)-
                                  min(x,na.rm = T))
    return(x)
  }
  
  #era5_pme = stand_fun(era5_pme)
  #tws = stand_fun(tws)
  
  era5_pme = apply(era5_pme,2,stand_fun)
  pmeato = apply(pmeato,2,stand_fun)
  
  # pr structure analysis 
  
  
  
  
  
  
  
  
  
  
}
fig4_projection_of_tws_subs_version2 <- function(
  
){
  library(ggplot2)
  library(raster)
  input_tws = 'analysis_output/fig4/project_tws'
  input_tws = list.files(input_tws,full.names = T)
  
  
  tws245_maxmin = as.data.frame(fread(input_tws[1]))
  tws245_mean = as.data.frame(
    fread(input_tws[2])
  )
  
  tws585_maxmin = as.data.frame(
    fread(input_tws[3])
  )
  tws585_mean = as.data.frame(
    fread(input_tws[4])
  )
  
  colnames(tws245_mean) = c('date',
                            'variable',
                            'value')
  colnames(tws585_mean) = c('date',
                            'variable',
                            'value')
  
  tws245_mean$type = 'SSP245_TWS'
  tws585_mean$type = 'SSP585_TWS'
  tws245_maxmin$type = 'SSP245_TWS'
  tws585_maxmin$type = 'SSP585_TWS'
  
  sub_to_year_fun <- function(df){
    year = 2018:2050
    var  = paste0('SW',1:10)
    value = 1
    type = as.character(unique(df$type))
    for(i in 1:10){
      tmpid = which(df$variable %in% var[i])
      x = c(df[tmpid,3],rep(NA,6))
      xm = matrix(x,nrow = 12)
      
      xm = apply(xm,2,sum,na.rm = T)
      value = c(value,xm)
    }
    value = value[-1]
    retdf = data.frame(
      date = year,
      variable = rep(var,each = length(year)),
      value = value,
      type = type
    )
    return(retdf)
  }
  sub_to_year_fun_maxmin <- function(df){
    year = 2018:2050
    var  = paste0('SW',1:10)
    max = 1
    min = 1
    type = as.character(unique(df$type))
    for(i in 1:10){
      
      tmpid = which(df$variable %in% var[i])
      x = c(df[tmpid,3],rep(NA,6))
      xm = matrix(x,nrow = 12)
      xm = apply(xm,2,sum,na.rm = T)
      #xm = stand_fun(xm)
      max = c(max,xm)
      
      x = c(df[tmpid,4],rep(NA,6))
      xm = matrix(x,nrow = 12)
      xm = apply(xm,2,sum,na.rm = T)
      #xm = stand_fun(xm)
      min = c(min,xm)
    }
    max =max[-1]
    min = min[-1]
    retdf = data.frame(
      date = year,
      variable = rep(var,each = length(year)),
      max = max,
      min = min,
      type = type
    )
    return(retdf)
  }
  tws245_mean = sub_to_year_fun(tws245_mean)
  tws585_mean = sub_to_year_fun(tws585_mean)
  tws245_maxmin = sub_to_year_fun_maxmin(tws245_maxmin)
  tws585_maxmin = sub_to_year_fun_maxmin(tws585_maxmin)
  
  source('/home/share/R_project/xinjiang_vapor/cal_increasing_rate.R')
  cr245 = cal_increasing_rate(tws245_mean)
  cr585 = cal_increasing_rate(tws585_mean)
  
  cr245_whole = cr245[[2]]
  cr585_whole = cr585[[2]]
  cr245 = cr245[[1]]
  cr585 = cr585[[1]]
  
  df = rbind(tws245_mean,tws585_mean)
  df$variable = factor(df$variable,
                       levels = paste0("SW",1:10))
  df2 = rbind(tws245_maxmin,tws585_maxmin)
  df2$variable = factor(df2$variable,
                        levels = paste0('SW',1:10))
  
  source('/home/share/R_project/xinjiang_vapor/import_pme_ato_fig4.R')
  pmedf = import_pme_ato_fig4(T)

  library(ggsci)
  col1 = pal_lancet(alpha = 0.8)(9)
  library(RColorBrewer)
  a = colorRampPalette(col1)(20)
  pals2 = pal_lancet(alpha = 0.8)(9)
  pals2 = colorRampPalette(pals2)(40)
  twscol = c('SSP245_TWS' = '#E2746E',
             'SSP585_TWS' = '#C12C44')
  pmecol = c('SSP245_PME1' = '#0B94B2',
             'SSP585_PME1' = '#2988AE',
             'SSP245_PME3' = '#00468B',
             'SSP585_PME3' = '#30376E')
  cols = c(twscol,pmecol)
  
  library(Rmisc)
  
  pathdf1 = data.frame(
    x = c(2018,2031,2031,2050),
    xend = c(2031,2050,2018,2031),
    y = c(4.5,4.5,4.5,4.5)-1+0.5
  )
  pathdf2 = data.frame(
    x = c(2018,2031,2050),
    y = rep(4.2,3)-1+0.5,
    yend = rep(4.8,3)-1+0.5
  )
  pathdf3 = data.frame(
    x = c(2018,2031,2031,2050),
    xend = c(2031,2050,2018,2031),
    y = rep(-4.5,2)+0.5
  )
  pathdf4 = data.frame(
    x = c(2018,2031,2050),
    y = c(-4.8,-4.8,-4.8)+0.5,
    yend = c(-4.2,-4.2,-4.2)
  )
  pathdf11 = pathdf1
  pathdf21 = pathdf2
  pathdf31 = pathdf3
  pathdf41 = pathdf4
  pathdf12 = pathdf1
  pathdf22 = pathdf2
  pathdf32 = pathdf3
  pathdf42 = pathdf4
  
  
  pathdf11$type = '(a) Regional mean standard indices under SSP245'
  pathdf21$type = '(a) Regional mean standard indices under SSP245'
  pathdf31$type = '(a) Regional mean standard indices under SSP245'
  pathdf41$type = '(a) Regional mean standard indices under SSP245'
  
  pathdf12$type = '(b) Regional mean standard indices under SSP585'
  pathdf22$type = '(b) Regional mean standard indices under SSP585'
  pathdf32$type = '(b) Regional mean standard indices under SSP585'
  pathdf42$type = '(b) Regional mean standard indices under SSP585'
  
  pathdfc1 = rbind(pathdf11,
                  pathdf12,
                  pathdf31,
                  pathdf32)
  pathdfc2 = rbind(pathdf21,
                   pathdf22,
                   pathdf41,
                   pathdf42)
  
  
  cr245$y = 5.3-1+0.5
  cr585$y = 3.6-1+0.5
  year = 2018:2050
  cr245$x = year[cr245$x]
  cr585$x = year[cr585$x]
  
  cr245$variable = factor(cr245$variable,
                          levels = paste0('SW',1:10))
  cr585$variable = factor(cr585$variable,
                          levels = paste0('SW',1:10))
  
  pline1 = ggplot()+
    #geom_ribbon(data = df2,aes(x = date,
    #                           ymax = max,
    #                           ymin = min),
    #            fill = '#87CEFA',
    #            alpha = 0.5)+
    geom_text(data = cr245,
              aes(x = x, y = y,label = label),
              size = 3.5,
              color = '#E2746E',
              fontface = 'bold')+
    geom_text(data = cr585,
              aes(x = x,y = y , label = label),
              size = 3.5,
              color = '#C12C44',
              fontface = 'bold')+
    geom_vline(xintercept = 2031,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_vline(xintercept = 2018,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_vline(xintercept = 2050,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_line(data = pmedf,
              aes(x = date,
                  y = value,
                  color = type),
              size = 1,
              alpha = 0.8)+
    geom_segment(data = pathdf1,
                 aes(x = x,xend =xend,
                     y = y,yend = y),
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'),
                 size = 0.5)+
    geom_segment(data = pathdf2,
                 aes(x = x,xend =x,
                     y = y,yend = yend),
                 size = 0.5)+
    geom_line(data = df,aes(x = date,
                             y = value,
                             color = type),
              size = 1)+
    
    #scale_fill_manual(values= fills)+
    scale_y_continuous(limits = c(-3,6),
                       position = 'left')+
    
    scale_color_manual(values = cols)+
    facet_wrap(~variable,ncol = 2)+
    theme_bw()+
    theme(legend.position = 'none')+
    ylab('Standardized indices')
  
  library(data.table)
  
  
  source('/home/share/R_project/xinjiang_vapor/cal_mean_tws_among_windows.R')
  mean_tws245 = cal_mean_tws_among_windows(tws245_mean,
                                           mode = 'mean')
  mean_tws585 = cal_mean_tws_among_windows(tws585_mean,
                                           mode = 'mean')
  mean_maxmin_tws245 = cal_mean_tws_among_windows(tws245_maxmin,
                                                  mode = 'max')

  mean_maxmin_tws585 = cal_mean_tws_among_windows(tws585_maxmin,
                                                  mode = 'max')
  mean_tws245$type = '(a) Regional mean standard indices under SSP245'
  mean_tws585$type = '(b) Regional mean standard indices under SSP585'
  
  pmedf1 = pmedf
  colnames(pmedf1) = c('date','variable','value')
  pmedf245 = pmedf1[
    which(pmedf1$variable %in% c('SSP245_PME1',
                                 'SSP245_PME3')),]
  pmedf585 = pmedf1[
    which(pmedf1$variable %in% c('SSP585_PME1',
                                 'SSP585_PME3')),
  ]
  pmedf245$type = '(a) Regional mean standard indices under SSP245'
  pmedf585$type = '(b) Regional mean standard indices under SSP585'
  
  library(prophet)
  ir_tws245 = cal_increasing_rate_whole(mean_tws245,
                                        'TWS_245')
  ir_tws585 = cal_increasing_rate_whole(mean_tws585,
                                        'TWS_585')
  ir_pme245 = cal_increasing_rate_whole(
    pmedf245,
    'SSP245_PME'
  )
  ir_pme585 = cal_increasing_rate_whole(pmedf585,
                                        'SSP585_PME')
  crytws= 4.8-0.2
  crypme1 = -4.5+0.5+0.6
  crypme2 = -5+0.5-0.3
  ir_tws245$y = crytws
  ir_tws585$y = crytws
  ir_pme245$y = c(crypme1,crypme2)
  ir_pme585$y =  c(crypme1,crypme2)
  
  ir_tws245$type = '(a) Regional mean standard indices under SSP245'
  ir_pme245$type = '(a) Regional mean standard indices under SSP245'
  ir_tws585$type = '(b) Regional mean standard indices under SSP585'
  ir_pme585$type = '(b) Regional mean standard indices under SSP585'
  
  irdf = rbind(ir_tws245,ir_pme245,
               ir_tws585,ir_pme585)
  irdf$x = year[irdf$x]
  
  # import pme ato mmk
  input_ato1 = 'analysis_output/fig4/ato_mmk_ssp245.nc'
  input_ato2 = 'analysis_output/fig4/ato_mmk_ssp585.nc'
  
  ato245 = raster(input_ato1)
  ato585 = raster(input_ato2)
  #aim 0.25
  rs = raster(nrow = 329,ncol = 626)
  extent(rs) = extent(c(-127.25,29.25,0,82.25))
  ato245r = resample(ato245,rs)
  ato585r = resample(ato585,rs)
  
  ato245df = as.data.frame(ato245r,
                           xy = T)
  ato585df = as.data.frame(ato585r,
                           xy = T)
  
  colnames(ato245df) = c('long','lat','SSP245-PME-MMK')
  colnames(ato585df) = c('long','lat','SSP585-PME-MMK')
  
  dfato1 = reshape2::melt(ato245df,
                          c('long','lat'))
  dfato2 = reshape2::melt(ato585df,
                          c('long','lat'))
  
  idless0 = which(dfato1$value < 0)
  idless02 = which(dfato2$value <0)
  
  dfato1 = dfato1[idless0,]
  dfato2 = dfato2[idless02,]
  
  dfato1$type = '(c) SSP245'
  dfato2$type = '(d) SSP585'
  
  dfato = rbind(dfato1,dfato2)
  dfato$cuts = cut(dfato$value,
                   breaks = c(-13,seq(-4,0,1)))
  
  fillato = colorRampPalette(
    brewer.pal(9,'YlOrRd')
  )(25)
  #sea_pme_mmk_pal = sea_pme_mmk_pal[1:]
  fillato = rev(fillato)
  fillato = fillato[seq(1,25,5)]
  
  
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  worlddf = fortify(world)
  worlddf1 = worlddf
  worlddf2 = worlddf
  
  worlddf1$type = '(c) SSP245'
  worlddf2$type = "(d) SSP585"
  worlddf = rbind(worlddf1,worlddf2)
  
  
  input_twsmmk = 'analysis_output/fig4/tws_subs_mmk/tws_mmk_subs_era5model.csv'
  twsmmk = fread(input_twsmmk)
  
  colnames(twsmmk) = c('long','lat',
                       '(c) SSP245','(d) SSP585')
  twsmmk = reshape2::melt(twsmmk,c('long','lat'))
  twsmmk$type = twsmmk$variable
  
  idless0 = which(twsmmk$value <0)
  twsmmk = twsmmk[idless0,]
  
  twsmmk$cuts = cut(twsmmk$value,
                    breaks = c(-63,seq(-10,0,1)))
  
  filltwsmmk = colorRampPalette(
    brewer.pal(9,'YlOrRd')
  )(25)
  filltwsmmk = rev(filltwsmmk)
  filltwsmmk = filltwsmmk[seq(1,25,2)][1:11]
  
  input_subs = 'sub_windows'
  num = 1:19
  input_subs = paste0(input_subs,'/sub_window',num,'.shp')
  
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  input_subs = input_subs[id_box]
  subs_shp = lapply(input_subs,shapefile)
  subs_shp = do.call('bind',subs_shp)
  subs_shp1 = fortify(subs_shp)
  subs_shp2 = fortify(subs_shp)
  
  subs_shp1$type = '(c) SSP245'
  subs_shp2$type = '(d) SSP585'
  subs_shp = rbind(subs_shp1,subs_shp2)
    
  xj = shp_management('xinjiang')
  xjdf = fortify(xj)
  xjdf1 = xjdf
  xjdf2 = xjdf
  xjdf1$type = '(c) SSP245'
  xjdf2$type = '(d) SSP585'
  xjdf = rbind(xjdf1,xjdf2)

  library(ggnewscale)
  
  ato1 = shapefile('cluster_shp/ato/ato1.shp')
  ato3 = shapefile('cluster_shp/ato/ato3.shp')
  
  cur_df = as.data.frame(
    fread('analysis_output/fig4/current_df.csv')
  )
  
  idless50 = which(cur_df$lat <= 50)
  cur_df = cur_df[idless50,]
  
  idbig1 = which(cur_df$u>0 &
                   cur_df$v >0)
  idbig2 = which(cur_df$u<0 &
                   cur_df$v >0)
  
  cur_df1 = cur_df[idbig1,]
  cur_df2 = cur_df[idbig2,]
  
  cid1 = seq(1,nrow(cur_df1),30)
  cid2 = seq(1,nrow(cur_df2),200)
  
  cur_df1 = cur_df1[cid1,]
  cur_df2 = cur_df2[cid2,]
  cur_df1$type = '(c) SSP245'
  cur_df11 = cur_df1
  cur_df2$type = '(c) SSP245'
  cur_df21 = cur_df2
  cur_df11$type = '(d) SSP585'
  cur_df21$type = '(d) SSP585'
  
  cur_df1 = rbind(cur_df1,cur_df11)
  cur_df2 = rbind(cur_df2,cur_df21)
  
  abline_df = data.frame(
    x = rep(c(2018,2031,2050),2),
    y = rep(c(-5,-5,-5),2),
    yend = rep(c(5,5,5),2),
    type = rep(c('(a) Regional mean standard indices under SSP245',
                 '(b) Regional mean standard indices under SSP585'),
               each =  3))  
  
  
  pline_whole = ggplot()+
    ###########
  geom_line(data = mean_tws245,
            aes(x = date,y = value,
                color = variable),
            size = 1.5)+
    geom_line(data = mean_tws585,
              aes(x = date,y = value,
                  color = variable),
              size = 1.5)+
    geom_line(data = pmedf245,
              aes(x = date,y = value,
                  color = variable),
              size = 1)+
    geom_line(data = pmedf585,
              aes(x = date,y = value,
                  color = variable),
              size = 1)+
    geom_segment(data = abline_df,
                 aes(x = x,xend = x,
                     y = y,yend = yend),
                 linetype = 'dashed',
                 size = 0.5)+
    geom_segment(data = pathdfc1,
                 aes(x = x,xend =xend,
                     y = y,yend = y),
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'),
                 size = 0.5)+
    geom_segment(data = pathdfc2,
                 aes(x = x,xend =x,
                     y = y,yend = yend),
                 size = 0.5)+
    geom_text(data = irdf,
              aes(x = x,y = y,label = label,
                  color = variable),
              size = 4,
              fontface = 'bold')+
    scale_color_manual(values = cols)+
    facet_wrap(~type,nrow = 1)+
    theme_bw()+
    theme(legend.position = 'none')
  #############
  
  cluster_traj_df = fread('analysis_output/fig2/cluster_traj_df.csv')
  cluster_traj_df = as.data.frame(trajs)
  route_col = pal_npg()(10)[4]
  route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
  
  route_col = colorRampPalette(brewer.pal(
    9,'Blues'
  ))(20)
  
  pmap = ggplot()+
    ###########
    geom_tile(data = dfato,
            aes(x = long,
                y = lat,
                fill = cuts),
            color = 'transparent')+
    scale_fill_manual(values = fillato,
                      guide = guide_legend(
                        title = 'PME-ATO-MMK',
                        title.position = 'top',
                        nrow = 2
                      ))+
    new_scale_fill()+
    geom_tile(data = twsmmk,
              aes(x = long,
                  y = lat,
                  fill = cuts),
              color = 'transparent')+
    
    scale_fill_manual(values = filltwsmmk,
                      guide = guide_legend(
                        title = 'TWS-MMK',
                        title.position = 'top',
                        nrow = 2
                      ))+
    geom_segment(data = cur_df1,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.15,'cm'),
                               type = 'open'),
                 color = cols[4])+
    geom_segment(data = cur_df2,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.2,'cm'),
                               type = 'open'),
                 color = cols[6])+
    
    geom_polygon(data = worlddf,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_polygon(data = xjdf,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_path(data = cluster_traj_df,aes(x = long,y = lat,
                                         group = routeid,
                                         color = factor(
                                           routeid,
                                           levels = 1:20
                                         )),
              size = 0.5,
              linetype = 'solid',
              #color = route_col[5],
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="open"))+
    scale_color_manual(values = route_col,
                       guide = 'none')+
    geom_polygon(data = subs_shp,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    
    facet_wrap(~type,ncol = 1,
               scales = 'free')+
    #coord_sf()+
    theme_bw()+
    ###########
    theme(legend.position = 'none')+
    ylab('Latitude')
  
  world_crop = crop(world,
                    extent(-5,125,30,60))
  
  subs_label = data.frame(
    x = c(10,
          rep(30,3),
          rep(50,2),
          rep(70,2),
          rep(90,1),
          rep(110,1)),
    y = c(35,
          seq(35,60,10),
          seq(35,50,10),
          seq(35,50,10),
          45,
          40),
    label = paste0('SW',1:10)
  )
  
  pmap2= ggplot()+
    ##########
  geom_polygon(data = subs_shp,
               aes(x = long,
                   y = lat,
                   group = group),
               color = 'black',
               fill = 'transparent',
               size = 0.5)+
    geom_text(data = subs_label,
              aes(x = x,y =y ,label = label),
              size = 2.3,
              fontface = 'bold')+
    #coord_sf()+
    theme_void()+
    coord_fixed(1.3)+
    ###########
  theme(
    plot.background = element_rect(
      fill = 'white'
    )
  )
  
  
  # mmk analysis statistic for each subs and ato13
  input_mean_mmk = 'analysis_output/fig4/bars_mmk_mean'
  input1 = paste0(input_mean_mmk,'/','substws_mmk245.csv')
  input2 = paste0(input_mean_mmk,'/','substws_mmk585.csv')
  
  input3 = paste0(input_mean_mmk,'/',
                  'pme_mmk_ssp245.csv')
  input4 = paste0(input_mean_mmk,'/',
                  'pme_mmk_ssp585.csv')
  
  substws_mmk245 = as.data.frame(fread(input1))
  substws_mmk585 = as.data.frame(fread(input2))
  pme_mmk245 = as.data.frame(fread(input3))
  pme_mmk585 = as.data.frame(fread(input4))
  
  dfmmk_mean245 = rbind(substws_mmk245,pme_mmk245)
  dfmmk_mean585 = rbind(substws_mmk585,
                        pme_mmk585)
  
  fillbar = colorRampPalette(pal_npg()(9))(12)
  fillbar2 = colorRampPalette(brewer.pal(10,'Spectral'))(12)
  
  label_df1 =data.frame(
    y = dfmmk_mean245$Region,
    x = abs(dfmmk_mean245$MMK)-1,
    labels = round(dfmmk_mean245$MMK,1)
  )
  
  label_df2 =data.frame(
    y = dfmmk_mean585$Region,
    x = abs(dfmmk_mean585$MMK)-1,
    labels = round(dfmmk_mean585$MMK,1)
  )
  
  order245 = order(abs(dfmmk_mean245$MMK),
                   decreasing = T)
  order585 = order(abs(dfmmk_mean585$MMK),
                   decreasing = T)
  subs1 = dfmmk_mean245$Region[order245]
  subs2 = dfmmk_mean585$Region[order585]
  
  dfmmk_mean245$Region = 
    factor(dfmmk_mean245$Region,
           levels = subs1)
  dfmmk_mean585$Region = 
    factor(dfmmk_mean585$Region,
           levels = subs2)
  
  label_df1$y = factor(label_df1$y
                       ,levels = subs1)
  label_df2$y = factor(label_df2$y,
                       levels = subs2)
  
  pbar1 = ggplot()+
    ##############
  geom_bar(data = dfmmk_mean245,
           aes(x = abs(MMK),y = Region,
               fill = Region),
           stat = 'identity',
           position = "dodge",
           width = 0.8,alpha = 0.8)+
    geom_text(data = label_df1,
              aes(x = x,y = y, label = labels),
              color = 'black',size = 3,hjust =0.5)+
    scale_x_continuous(breaks = c(0,1,2,3,4),
                       labels =c(0,-1,-2,-3,-4))+
    scale_fill_manual(values = fillbar)+
    theme_bw()+
    theme(
      legend.position = 'none',
      panel.border = element_rect(fill = 'transparent',
                                  color = 'transparent'),
      axis.title = element_text(size = 10,color = 'black',
                                hjust = 0.5),
      panel.background = element_rect(fill = 'transparent',
                                      color = 'transparent'),
      panel.grid =element_blank(),
      axis.text = element_text(size = 5,color = 'black',hjust = 0.5),
      axis.line.x = element_line(color= 'black',size = 0.5))+
    ##############
  xlab('Regions')+
    ylab('MMK')
  
  pbar2 = ggplot()+
    ##############
  geom_bar(data = dfmmk_mean585,
           aes(x = abs(MMK) ,y =Region,
               fill = Region),
           stat = 'identity',
           position = "dodge",
           width = 0.8,alpha = 0.8)+
    geom_text(data = label_df2,
              aes(x = x,y = y, label = labels),
              color = 'black',size = 3,hjust =0.5)+
    scale_x_continuous(breaks = c(0,2,4,6,8),
                       labels =c(0,-2,-4,-6,-8))+
    scale_fill_manual(values = fillbar)+
    theme_bw()+
    theme(
      legend.position = 'none',
      panel.border = element_rect(fill = 'transparent',
                                  color = 'transparent'),
      axis.title = element_text(size = 5,color = 'black',
                                hjust = 0.5),
      panel.background = element_rect(fill = 'transparent',
                                      color = 'transparent'),
      panel.grid =element_blank(),
      axis.text = element_text(size = 5,color = 'black',hjust = 0.5),
      axis.line.x = element_line(color= 'black',size = 0.5))+
    xlab('Regions')+
    ylab('MMK')
  ##############
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  re_axis_title = 
    theme(axis.title.x = element_blank())
  axis_angel = theme(
    axis.text.x = element_text(
      color = 'black',
      size = fontsize,
      angle = 15)
  )
  
  pline1 = pline1+text_theme_set+re_axis_title
  #+axis_angel
  pline_whole = pline_whole+text_theme_set+re_axis_title
  pmap = pmap+text_theme_set+re_axis_title
  
  pline12 = pline1+theme(axis.title = element_blank())
  pmap = pmap+theme(axis.title = element_blank())
  pline_whole = pline_whole+theme(axis.title = element_blank())
  
  pline_whole = pline_whole+
    theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),'cm'),
          strip.text = element_blank())
  pmap = pmap+
    theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),'cm'),
          strip.text = element_blank())
  pline12 = pline12+
    theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),'cm'),
          strip.text = element_blank())
  
  library(cowplot)
  p1 = plot_grid(pline_whole,pmap,
                 align = 'hv',
                 axis = 'lr',
                 rel_widths = c(1,1),
                 rel_heights = c(3,6),
                 ncol = 1)
  
  p12 = plot_grid(p1,pline12,
                 align = 'hv',
                 axis = 'lr',
                 rel_widths = c(2,1.5),
                 rel_heights = c(1,1),
                 nrow = 1)
  
  pbar1 = pbar1+
    theme(
      axis.title = element_blank(),
      axis.text.y = element_text(
        size = 9,color = 'black'
      ),
      axis.text.x = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      plot.background = element_rect(
        fill= 'transparent',
        color = 'transparent'
      )
      
    )
  pbar2 = pbar2+
    theme(
      axis.title = element_blank(),
      axis.text.y = element_text(
        size = 9,color = 'black'
      ),
      axis.text.x = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      plot.background  = element_rect(
        fill= 'transparent',
        color = 'transparent'
      )
    )
  
 p123 = ggdraw()+
    draw_plot(p12)+
    draw_plot(pbar1,x = 0.06, y = 0.352,
              width = 0.11, height = 0.22)+
    draw_plot(pbar2,x = 0.06, y = 0.02,
              width = 0.11, height = 0.22)+
    draw_plot(pmap2,x = 0.404, y = 0.329,
              width = 0.16, height = 0.15)+
    draw_plot(pmap2,x = 0.404, y = -0.007,
              width = 0.16, height = 0.15)
  
  png('main_plot/fig4/fig4_final7.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(p123)
  dev.off()
  
  legend_set = theme(
    legend.position = 'bottom'
  )
  library(ggpubr)
  pline1_legend = as_ggplot(
    get_legend(pline1+legend_set+
                 guides(color = guide_legend(
                   title = '',
                   title.position = 'top'
                 )))
  )
  
  pmap_legend = as_ggplot(
    get_legend(pmap+legend_set))
    
  png('main_plot/fig4/pmap_legend.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(pmap_legend)
  dev.off()
  
  png('main_plot/fig4/pline1_legend.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(pline1_legend)
  dev.off()
  
    
  
}









fig4_projection_of_tws_subs_version3 <- function(
  
){
  library(ggplot2)
  library(raster)
  input_tws = 'analysis_output/fig4/project_tws'
  input_tws = list.files(input_tws,full.names = T)
  
  
  tws245_maxmin = as.data.frame(fread(input_tws[1]))
  tws245_mean = as.data.frame(
    fread(input_tws[2])
  )
  
  tws585_maxmin = as.data.frame(
    fread(input_tws[3])
  )
  tws585_mean = as.data.frame(
    fread(input_tws[4])
  )
  
  colnames(tws245_mean) = c('date',
                            'variable',
                            'value')
  colnames(tws585_mean) = c('date',
                            'variable',
                            'value')
  
  tws245_mean$type = 'SSP245_TWS'
  tws585_mean$type = 'SSP585_TWS'
  tws245_maxmin$type = 'SSP245_TWS'
  tws585_maxmin$type = 'SSP585_TWS'
  
  sub_to_year_fun <- function(df){
    year = 2018:2050
    var  = paste0('SW',1:10)
    value = 1
    type = as.character(unique(df$type))
    for(i in 1:10){
      tmpid = which(df$variable %in% var[i])
      x = c(df[tmpid,3],rep(NA,6))
      xm = matrix(x,nrow = 12)
      
      xm = apply(xm,2,sum,na.rm = T)
      value = c(value,xm)
    }
    value = value[-1]
    retdf = data.frame(
      date = year,
      variable = rep(var,each = length(year)),
      value = value,
      type = type
    )
    return(retdf)
  }
  sub_to_year_fun_maxmin <- function(df){
    year = 2018:2050
    var  = paste0('SW',1:10)
    max = 1
    min = 1
    type = as.character(unique(df$type))
    for(i in 1:10){
      
      tmpid = which(df$variable %in% var[i])
      x = c(df[tmpid,3],rep(NA,6))
      xm = matrix(x,nrow = 12)
      xm = apply(xm,2,sum,na.rm = T)
      #xm = stand_fun(xm)
      max = c(max,xm)
      
      x = c(df[tmpid,4],rep(NA,6))
      xm = matrix(x,nrow = 12)
      xm = apply(xm,2,sum,na.rm = T)
      #xm = stand_fun(xm)
      min = c(min,xm)
    }
    max =max[-1]
    min = min[-1]
    retdf = data.frame(
      date = year,
      variable = rep(var,each = length(year)),
      max = max,
      min = min,
      type = type
    )
    return(retdf)
  }
  tws245_mean = sub_to_year_fun(tws245_mean)
  tws585_mean = sub_to_year_fun(tws585_mean)
  tws245_maxmin = sub_to_year_fun_maxmin(tws245_maxmin)
  tws585_maxmin = sub_to_year_fun_maxmin(tws585_maxmin)
  
  source('/home/share/R_project/xinjiang_vapor/cal_increasing_rate.R')
  cr245 = cal_increasing_rate(tws245_mean)
  cr585 = cal_increasing_rate(tws585_mean)
  
  cr245_whole = cr245[[2]]
  cr585_whole = cr585[[2]]
  cr245 = cr245[[1]]
  cr585 = cr585[[1]]
  
  df = rbind(tws245_mean,tws585_mean)
  df$variable = factor(df$variable,
                       levels = paste0("HSW",1:10))
  df2 = rbind(tws245_maxmin,tws585_maxmin)
  df2$variable = factor(df2$variable,
                        levels = paste0('HSW',1:10))
  
  source('/home/share/R_project/xinjiang_vapor/import_pme_ato_fig4.R')
  pmedf = import_pme_ato_fig4(T)
  
  library(ggsci)
  col1 = pal_lancet(alpha = 0.8)(9)
  library(RColorBrewer)
  a = colorRampPalette(col1)(20)
  pals2 = pal_lancet(alpha = 0.8)(9)
  pals2 = colorRampPalette(pals2)(40)
  twscol = c('SSP245_TWS' = '#E2746E',
             'SSP585_TWS' = '#C12C44')
  pmecol = c('SSP245_PME1' = '#0B94B2',
             'SSP585_PME1' = '#2988AE',
             'SSP245_PME3' = '#00468B',
             'SSP585_PME3' = '#30376E')
  cols = c(twscol,pmecol)
  
  library(Rmisc)
  
  pathdf1 = data.frame(
    x = c(2018,2031,2031,2050),
    xend = c(2031,2050,2018,2031),
    y = c(4.5,4.5,4.5,4.5)-1+0.5
  )
  pathdf2 = data.frame(
    x = c(2018,2031,2050),
    y = rep(4.2,3)-1+0.5,
    yend = rep(4.8,3)-1+0.5
  )
  pathdf3 = data.frame(
    x = c(2018,2031,2031,2050),
    xend = c(2031,2050,2018,2031),
    y = rep(-4.5,2)+0.5
  )
  pathdf4 = data.frame(
    x = c(2018,2031,2050),
    y = c(-4.8,-4.8,-4.8)+0.5,
    yend = c(-4.2,-4.2,-4.2)
  )
  pathdf11 = pathdf1
  pathdf21 = pathdf2
  pathdf31 = pathdf3
  pathdf41 = pathdf4
  pathdf12 = pathdf1
  pathdf22 = pathdf2
  pathdf32 = pathdf3
  pathdf42 = pathdf4
  
  
  pathdf11$type = '(a) Regional mean standard indices under SSP245'
  pathdf21$type = '(a) Regional mean standard indices under SSP245'
  pathdf31$type = '(a) Regional mean standard indices under SSP245'
  pathdf41$type = '(a) Regional mean standard indices under SSP245'
  
  pathdf12$type = '(b) Regional mean standard indices under SSP585'
  pathdf22$type = '(b) Regional mean standard indices under SSP585'
  pathdf32$type = '(b) Regional mean standard indices under SSP585'
  pathdf42$type = '(b) Regional mean standard indices under SSP585'
  
  pathdfc1 = rbind(pathdf11,
                   pathdf12,
                   pathdf31,
                   pathdf32)
  pathdfc2 = rbind(pathdf21,
                   pathdf22,
                   pathdf41,
                   pathdf42)
  
  
  cr245$y = 5.3-1+0.5
  cr585$y = 3.6-1+0.5
  year = 2018:2050
  cr245$x = year[cr245$x]
  cr585$x = year[cr585$x]
  
  cr245$variable = factor(cr245$variable,
                          levels = paste0('SW',1:10))
  cr585$variable = factor(cr585$variable,
                          levels = paste0('SW',1:10))
  
  pline1 = ggplot()+
    #geom_ribbon(data = df2,aes(x = date,
    #                           ymax = max,
    #                           ymin = min),
    #            fill = '#87CEFA',
    #            alpha = 0.5)+
    geom_text(data = cr245,
              aes(x = x, y = y,label = label),
              size = 3.5,
              color = '#E2746E',
              fontface = 'bold')+
    geom_text(data = cr585,
              aes(x = x,y = y , label = label),
              size = 3.5,
              color = '#C12C44',
              fontface = 'bold')+
    geom_vline(xintercept = 2031,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_vline(xintercept = 2018,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_vline(xintercept = 2050,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_line(data = pmedf,
              aes(x = date,
                  y = value,
                  color = type),
              size = 1,
              alpha = 0.8)+
    geom_segment(data = pathdf1,
                 aes(x = x,xend =xend,
                     y = y,yend = y),
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'),
                 size = 0.5)+
    geom_segment(data = pathdf2,
                 aes(x = x,xend =x,
                     y = y,yend = yend),
                 size = 0.5)+
    geom_line(data = df,aes(x = date,
                            y = value,
                            color = type),
              size = 1)+
    
    #scale_fill_manual(values= fills)+
    scale_y_continuous(limits = c(-3,6),
                       position = 'left')+
    
    scale_color_manual(values = cols)+
    facet_wrap(~variable,ncol = 2)+
    theme_bw()+
    theme(legend.position = 'none')+
    ylab('Standardized indices')
  
  library(data.table)
  
  
  source('/home/share/R_project/xinjiang_vapor/cal_mean_tws_among_windows.R')
  mean_tws245 = cal_mean_tws_among_windows(tws245_mean,
                                           mode = 'mean')
  mean_tws585 = cal_mean_tws_among_windows(tws585_mean,
                                           mode = 'mean')
  mean_maxmin_tws245 = cal_mean_tws_among_windows(tws245_maxmin,
                                                  mode = 'max')
  
  mean_maxmin_tws585 = cal_mean_tws_among_windows(tws585_maxmin,
                                                  mode = 'max')
  mean_tws245$type = '(a) Regional mean standard indices under SSP245'
  mean_tws585$type = '(b) Regional mean standard indices under SSP585'
  
  pmedf1 = pmedf
  colnames(pmedf1) = c('date','variable','value')
  pmedf245 = pmedf1[
    which(pmedf1$variable %in% c('SSP245_PME1',
                                 'SSP245_PME3')),]
  pmedf585 = pmedf1[
    which(pmedf1$variable %in% c('SSP585_PME1',
                                 'SSP585_PME3')),
    ]
  pmedf245$type = '(a) Regional mean standard indices under SSP245'
  pmedf585$type = '(b) Regional mean standard indices under SSP585'
  
  library(prophet)
  ir_tws245 = cal_increasing_rate_whole(mean_tws245,
                                        'TWS_245')
  ir_tws585 = cal_increasing_rate_whole(mean_tws585,
                                        'TWS_585')
  ir_pme245 = cal_increasing_rate_whole(
    pmedf245,
    'SSP245_PME'
  )
  ir_pme585 = cal_increasing_rate_whole(pmedf585,
                                        'SSP585_PME')
  crytws= 4.8-0.2
  crypme1 = -4.5+0.5+0.6
  crypme2 = -5+0.5-0.3
  ir_tws245$y = crytws
  ir_tws585$y = crytws
  ir_pme245$y = c(crypme1,crypme2)
  ir_pme585$y =  c(crypme1,crypme2)
  
  ir_tws245$type = '(a) Regional mean standard indices under SSP245'
  ir_pme245$type = '(a) Regional mean standard indices under SSP245'
  ir_tws585$type = '(b) Regional mean standard indices under SSP585'
  ir_pme585$type = '(b) Regional mean standard indices under SSP585'
  
  irdf = rbind(ir_tws245,ir_pme245,
               ir_tws585,ir_pme585)
  irdf$x = year[irdf$x]
  
  # import pme ato mmk
  input_ato1 = 'analysis_output/fig4/ato_mmk_ssp245.nc'
  input_ato2 = 'analysis_output/fig4/ato_mmk_ssp585.nc'
  
  ato245 = raster(input_ato1)
  ato585 = raster(input_ato2)
  #aim 0.25
  rs = raster(nrow = 329,ncol = 626)
  extent(rs) = extent(c(-127.25,29.25,0,82.25))
  ato245r = resample(ato245,rs)
  ato585r = resample(ato585,rs)
  
  ato245df = as.data.frame(ato245r,
                           xy = T)
  ato585df = as.data.frame(ato585r,
                           xy = T)
  
  colnames(ato245df) = c('long','lat','SSP245-PME-MMK')
  colnames(ato585df) = c('long','lat','SSP585-PME-MMK')
  
  dfato1 = reshape2::melt(ato245df,
                          c('long','lat'))
  dfato2 = reshape2::melt(ato585df,
                          c('long','lat'))
  
  idless0 = which(dfato1$value < 0)
  idless02 = which(dfato2$value <0)
  
  dfato1 = dfato1[idless0,]
  dfato2 = dfato2[idless02,]
  
  dfato1$type = '(c) SSP245'
  dfato2$type = '(d) SSP585'
  
  dfato = rbind(dfato1,dfato2)
  dfato$cuts = cut(dfato$value,
                   breaks = c(-13,seq(-4,0,1)))
  
  fillato = colorRampPalette(
    brewer.pal(9,'YlOrRd')
  )(25)
  #sea_pme_mmk_pal = sea_pme_mmk_pal[1:]
  fillato = rev(fillato)
  fillato = fillato[seq(1,25,5)]
  
  
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  worlddf = fortify(world)
  worlddf1 = worlddf
  worlddf2 = worlddf
  
  worlddf1$type = '(c) SSP245'
  worlddf2$type = "(d) SSP585"
  worlddf = rbind(worlddf1,worlddf2)
  
  
  input_twsmmk = 'analysis_output/fig4/tws_subs_mmk/tws_mmk_subs_era5model.csv'
  twsmmk = fread(input_twsmmk)
  
  colnames(twsmmk) = c('long','lat',
                       '(c) SSP245','(d) SSP585')
  twsmmk = reshape2::melt(twsmmk,c('long','lat'))
  twsmmk$type = twsmmk$variable
  
  idless0 = which(twsmmk$value <0)
  twsmmk = twsmmk[idless0,]
  
  twsmmk$cuts = cut(twsmmk$value,
                    breaks = c(-63,seq(-10,0,1)))
  
  filltwsmmk = colorRampPalette(
    brewer.pal(9,'YlOrRd')
  )(25)
  filltwsmmk = rev(filltwsmmk)
  filltwsmmk = filltwsmmk[seq(1,25,2)][1:11]
  
  input_subs = 'sub_windows'
  num = 1:19
  input_subs = paste0(input_subs,'/sub_window',num,'.shp')
  
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  input_subs = input_subs[id_box]
  subs_shp = lapply(input_subs,shapefile)
  subs_shp = do.call('bind',subs_shp)
  subs_shp1 = fortify(subs_shp)
  subs_shp2 = fortify(subs_shp)
  
  subs_shp1$type = '(c) SSP245'
  subs_shp2$type = '(d) SSP585'
  subs_shp = rbind(subs_shp1,subs_shp2)
  
  xj = shp_management('xinjiang')
  xjdf = fortify(xj)
  xjdf1 = xjdf
  xjdf2 = xjdf
  xjdf1$type = '(c) SSP245'
  xjdf2$type = '(d) SSP585'
  xjdf = rbind(xjdf1,xjdf2)
  
  library(ggnewscale)
  
  ato1 = shapefile('cluster_shp/ato/ato1.shp')
  ato3 = shapefile('cluster_shp/ato/ato3.shp')
  
  cur_df = as.data.frame(
    fread('analysis_output/fig4/current_df.csv')
  )
  
  idless50 = which(cur_df$lat <= 50)
  cur_df = cur_df[idless50,]
  
  idbig1 = which(cur_df$u>0 &
                   cur_df$v >0)
  idbig2 = which(cur_df$u<0 &
                   cur_df$v >0)
  
  cur_df1 = cur_df[idbig1,]
  cur_df2 = cur_df[idbig2,]
  
  cid1 = seq(1,nrow(cur_df1),30)
  cid2 = seq(1,nrow(cur_df2),200)
  
  cur_df1 = cur_df1[cid1,]
  cur_df2 = cur_df2[cid2,]
  cur_df1$type = '(c) SSP245'
  cur_df11 = cur_df1
  cur_df2$type = '(c) SSP245'
  cur_df21 = cur_df2
  cur_df11$type = '(d) SSP585'
  cur_df21$type = '(d) SSP585'
  
  cur_df1 = rbind(cur_df1,cur_df11)
  cur_df2 = rbind(cur_df2,cur_df21)
  
  abline_df = data.frame(
    x = rep(c(2018,2031,2050),2),
    y = rep(c(-5,-5,-5),2),
    yend = rep(c(5,5,5),2),
    type = rep(c('(a) Regional mean standard indices under SSP245',
                 '(b) Regional mean standard indices under SSP585'),
               each =  3))  
  
  
  pline_whole = ggplot()+
    ###########
  geom_line(data = mean_tws245,
            aes(x = date,y = value,
                color = variable),
            size = 1.5)+
    geom_line(data = mean_tws585,
              aes(x = date,y = value,
                  color = variable),
              size = 1.5)+
    geom_line(data = pmedf245,
              aes(x = date,y = value,
                  color = variable),
              size = 1)+
    geom_line(data = pmedf585,
              aes(x = date,y = value,
                  color = variable),
              size = 1)+
    geom_segment(data = abline_df,
                 aes(x = x,xend = x,
                     y = y,yend = yend),
                 linetype = 'dashed',
                 size = 0.5)+
    geom_segment(data = pathdfc1,
                 aes(x = x,xend =xend,
                     y = y,yend = y),
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'),
                 size = 0.5)+
    geom_segment(data = pathdfc2,
                 aes(x = x,xend =x,
                     y = y,yend = yend),
                 size = 0.5)+
    geom_text(data = irdf,
              aes(x = x,y = y,label = label,
                  color = variable),
              size = 4,
              fontface = 'bold')+
    scale_color_manual(values = cols)+
    facet_wrap(~type,nrow = 1)+
    theme_bw()+
    theme(legend.position = 'none')
  #############
  
  cluster_traj_df = fread('analysis_output/fig2/cluster_traj_df.csv')
  cluster_traj_df = as.data.frame(trajs)
  route_col = pal_npg()(10)[4]
  route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
  
  route_col = colorRampPalette(brewer.pal(
    9,'Blues'
  ))(20)
  
  pmap = ggplot()+
    ###########
  geom_tile(data = dfato,
            aes(x = long,
                y = lat,
                fill = cuts),
            color = 'transparent')+
    scale_fill_manual(values = fillato,
                      guide = guide_legend(
                        title = 'PME-ATO-MMK',
                        title.position = 'top',
                        nrow = 2
                      ))+
    new_scale_fill()+
    geom_tile(data = twsmmk,
              aes(x = long,
                  y = lat,
                  fill = cuts),
              color = 'transparent')+
    
    scale_fill_manual(values = filltwsmmk,
                      guide = guide_legend(
                        title = 'TWS-MMK',
                        title.position = 'top',
                        nrow = 2
                      ))+
    geom_segment(data = cur_df1,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.15,'cm'),
                               type = 'open'),
                 color = cols[4])+
    geom_segment(data = cur_df2,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.2,'cm'),
                               type = 'open'),
                 color = cols[6])+
    
    geom_polygon(data = worlddf,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_polygon(data = xjdf,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_path(data = cluster_traj_df,aes(x = long,y = lat,
                                         group = routeid,
                                         color = factor(
                                           routeid,
                                           levels = 1:20
                                         )),
              size = 0.5,
              linetype = 'solid',
              #color = route_col[5],
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="open"))+
    scale_color_manual(values = route_col,
                       guide = 'none')+
    geom_polygon(data = subs_shp,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    
    facet_wrap(~type,ncol = 1,
               scales = 'free')+
    #coord_sf()+
    theme_bw()+
    ###########
  theme(legend.position = 'none')+
    ylab('Latitude')
  
  world_crop = crop(world,
                    extent(-5,125,30,60))
  
  subs_label = data.frame(
    x = c(10,
          rep(30,3),
          rep(50,2),
          rep(70,2),
          rep(90,1),
          rep(110,1)),
    y = c(35,
          seq(35,60,10),
          seq(35,50,10),
          seq(35,50,10),
          45,
          40),
    label = paste0('SW',1:10)
  )
  
  pmap2= ggplot()+
    ##########
  geom_polygon(data = subs_shp,
               aes(x = long,
                   y = lat,
                   group = group),
               color = 'black',
               fill = 'transparent',
               size = 0.5)+
    geom_text(data = subs_label,
              aes(x = x,y =y ,label = label),
              size = 2.3,
              fontface = 'bold')+
    #coord_sf()+
    theme_void()+
    coord_fixed(1.3)+
    ###########
  theme(
    plot.background = element_rect(
      fill = 'white'
    )
  )
  
  
  # mmk analysis statistic for each subs and ato13
  input_mean_mmk = 'analysis_output/fig4/bars_mmk_mean'
  input1 = paste0(input_mean_mmk,'/','substws_mmk245.csv')
  input2 = paste0(input_mean_mmk,'/','substws_mmk585.csv')
  
  input3 = paste0(input_mean_mmk,'/',
                  'pme_mmk_ssp245.csv')
  input4 = paste0(input_mean_mmk,'/',
                  'pme_mmk_ssp585.csv')
  
  substws_mmk245 = as.data.frame(fread(input1))
  substws_mmk585 = as.data.frame(fread(input2))
  pme_mmk245 = as.data.frame(fread(input3))
  pme_mmk585 = as.data.frame(fread(input4))
  
  dfmmk_mean245 = rbind(substws_mmk245,pme_mmk245)
  dfmmk_mean585 = rbind(substws_mmk585,
                        pme_mmk585)
  
  fillbar = colorRampPalette(pal_npg()(9))(12)
  fillbar2 = colorRampPalette(brewer.pal(10,'Spectral'))(12)
  
  label_df1 =data.frame(
    y = dfmmk_mean245$Region,
    x = abs(dfmmk_mean245$MMK)-1,
    labels = round(dfmmk_mean245$MMK,1)
  )
  
  label_df2 =data.frame(
    y = dfmmk_mean585$Region,
    x = abs(dfmmk_mean585$MMK)-1,
    labels = round(dfmmk_mean585$MMK,1)
  )
  
  order245 = order(abs(dfmmk_mean245$MMK),
                   decreasing = T)
  order585 = order(abs(dfmmk_mean585$MMK),
                   decreasing = T)
  subs1 = dfmmk_mean245$Region[order245]
  subs2 = dfmmk_mean585$Region[order585]
  
  dfmmk_mean245$Region = 
    factor(dfmmk_mean245$Region,
           levels = subs1)
  dfmmk_mean585$Region = 
    factor(dfmmk_mean585$Region,
           levels = subs2)
  
  label_df1$y = factor(label_df1$y
                       ,levels = subs1)
  label_df2$y = factor(label_df2$y,
                       levels = subs2)
  
  pbar1 = ggplot()+
    ##############
  geom_bar(data = dfmmk_mean245,
           aes(x = abs(MMK),y = Region,
               fill = Region),
           stat = 'identity',
           position = "dodge",
           width = 0.8,alpha = 0.8)+
    geom_text(data = label_df1,
              aes(x = x,y = y, label = labels),
              color = 'black',size = 3,hjust =0.5)+
    scale_x_continuous(breaks = c(0,1,2,3,4),
                       labels =c(0,-1,-2,-3,-4))+
    scale_fill_manual(values = fillbar)+
    theme_bw()+
    theme(
      legend.position = 'none',
      panel.border = element_rect(fill = 'transparent',
                                  color = 'transparent'),
      axis.title = element_text(size = 10,color = 'black',
                                hjust = 0.5),
      panel.background = element_rect(fill = 'transparent',
                                      color = 'transparent'),
      panel.grid =element_blank(),
      axis.text = element_text(size = 5,color = 'black',hjust = 0.5),
      axis.line.x = element_line(color= 'black',size = 0.5))+
    ##############
  xlab('Regions')+
    ylab('MMK')
  
  pbar2 = ggplot()+
    ##############
  geom_bar(data = dfmmk_mean585,
           aes(x = abs(MMK) ,y =Region,
               fill = Region),
           stat = 'identity',
           position = "dodge",
           width = 0.8,alpha = 0.8)+
    geom_text(data = label_df2,
              aes(x = x,y = y, label = labels),
              color = 'black',size = 3,hjust =0.5)+
    scale_x_continuous(breaks = c(0,2,4,6,8),
                       labels =c(0,-2,-4,-6,-8))+
    scale_fill_manual(values = fillbar)+
    theme_bw()+
    theme(
      legend.position = 'none',
      panel.border = element_rect(fill = 'transparent',
                                  color = 'transparent'),
      axis.title = element_text(size = 5,color = 'black',
                                hjust = 0.5),
      panel.background = element_rect(fill = 'transparent',
                                      color = 'transparent'),
      panel.grid =element_blank(),
      axis.text = element_text(size = 5,color = 'black',hjust = 0.5),
      axis.line.x = element_line(color= 'black',size = 0.5))+
    xlab('Regions')+
    ylab('MMK')
  ##############
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  re_axis_title = 
    theme(axis.title.x = element_blank())
  axis_angel = theme(
    axis.text.x = element_text(
      color = 'black',
      size = fontsize,
      angle = 15)
  )
  
  pline1 = pline1+text_theme_set+re_axis_title
  #+axis_angel
  pline_whole = pline_whole+text_theme_set+re_axis_title
  pmap = pmap+text_theme_set+re_axis_title
  
  pline12 = pline1+theme(axis.title = element_blank())
  pmap = pmap+theme(axis.title = element_blank())
  pline_whole = pline_whole+theme(axis.title = element_blank())
  
  pline_whole = pline_whole+
    theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),'cm'),
          strip.text = element_blank())
  pmap = pmap+
    theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),'cm'),
          strip.text = element_blank())
  pline12 = pline12+
    theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),'cm'),
          strip.text = element_blank())
  
  library(cowplot)
  p1 = plot_grid(pline_whole,pmap,
                 align = 'hv',
                 axis = 'lr',
                 rel_widths = c(1,1),
                 rel_heights = c(3,6),
                 ncol = 1)
  
  p12 = plot_grid(p1,pline12,
                  align = 'hv',
                  axis = 'lr',
                  rel_widths = c(2,1.5),
                  rel_heights = c(1,1),
                  nrow = 1)
  
  pbar1 = pbar1+
    theme(
      axis.title = element_blank(),
      axis.text.y = element_text(
        size = 9,color = 'black'
      ),
      axis.text.x = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      plot.background = element_rect(
        fill= 'transparent',
        color = 'transparent'
      )
      
    )
  pbar2 = pbar2+
    theme(
      axis.title = element_blank(),
      axis.text.y = element_text(
        size = 9,color = 'black'
      ),
      axis.text.x = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      plot.background  = element_rect(
        fill= 'transparent',
        color = 'transparent'
      )
    )
  
  p123 = ggdraw()+
    draw_plot(p12)+
    draw_plot(pbar1,x = 0.06, y = 0.352,
              width = 0.11, height = 0.22)+
    draw_plot(pbar2,x = 0.06, y = 0.02,
              width = 0.11, height = 0.22)+
    draw_plot(pmap2,x = 0.404, y = 0.329,
              width = 0.16, height = 0.15)+
    draw_plot(pmap2,x = 0.404, y = -0.007,
              width = 0.16, height = 0.15)
  
  png('main_plot/fig4/fig4_final7.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(p123)
  dev.off()
  
  legend_set = theme(
    legend.position = 'bottom'
  )
  library(ggpubr)
  pline1_legend = as_ggplot(
    get_legend(pline1+legend_set+
                 guides(color = guide_legend(
                   title = '',
                   title.position = 'top'
                 )))
  )
  
  pmap_legend = as_ggplot(
    get_legend(pmap+legend_set))
  
  png('main_plot/fig4/pmap_legend.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(pmap_legend)
  dev.off()
  
  png('main_plot/fig4/pline1_legend.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(pline1_legend)
  dev.off()
  
  
  
}



fig4_projection_of_tws_subs_version4 <- function(
  
){
  library(ggplot2)
  library(raster)
  input_tws = 'analysis_output/fig4/project_tws'
  input_tws = list.files(input_tws,full.names = T)
  
  
  tws245_maxmin = as.data.frame(fread(input_tws[1]))
  tws245_mean = as.data.frame(
    fread(input_tws[2])
  )
  
  tws585_maxmin = as.data.frame(
    fread(input_tws[3])
  )
  tws585_mean = as.data.frame(
    fread(input_tws[4])
  )
  
  colnames(tws245_mean) = c('date',
                            'variable',
                            'value')
  colnames(tws585_mean) = c('date',
                            'variable',
                            'value')
  
  tws245_mean$type = 'SSP245_TWS'
  tws585_mean$type = 'SSP585_TWS'
  tws245_maxmin$type = 'SSP245_TWS'
  tws585_maxmin$type = 'SSP585_TWS'
  
  sub_to_year_fun <- function(df){
    year = 2018:2050
    var  = paste0('SW',1:10)
    value = 1
    type = as.character(unique(df$type))
    for(i in 1:10){
      tmpid = which(df$variable %in% var[i])
      x = c(df[tmpid,3],rep(NA,6))
      xm = matrix(x,nrow = 12)
      
      xm = apply(xm,2,sum,na.rm = T)
      value = c(value,xm)
    }
    value = value[-1]
    retdf = data.frame(
      date = year,
      variable = rep(var,each = length(year)),
      value = value,
      type = type
    )
    return(retdf)
  }
  sub_to_year_fun_maxmin <- function(df){
    year = 2018:2050
    var  = paste0('SW',1:10)
    max = 1
    min = 1
    type = as.character(unique(df$type))
    for(i in 1:10){
      
      tmpid = which(df$variable %in% var[i])
      x = c(df[tmpid,3],rep(NA,6))
      xm = matrix(x,nrow = 12)
      xm = apply(xm,2,sum,na.rm = T)
      #xm = stand_fun(xm)
      max = c(max,xm)
      
      x = c(df[tmpid,4],rep(NA,6))
      xm = matrix(x,nrow = 12)
      xm = apply(xm,2,sum,na.rm = T)
      #xm = stand_fun(xm)
      min = c(min,xm)
    }
    max =max[-1]
    min = min[-1]
    retdf = data.frame(
      date = year,
      variable = rep(var,each = length(year)),
      max = max,
      min = min,
      type = type
    )
    return(retdf)
  }
  tws245_mean = sub_to_year_fun(tws245_mean)
  tws585_mean = sub_to_year_fun(tws585_mean)
  tws245_maxmin = sub_to_year_fun_maxmin(tws245_maxmin)
  tws585_maxmin = sub_to_year_fun_maxmin(tws585_maxmin)
  
  source('/home/share/R_project/xinjiang_vapor/cal_increasing_rate.R')
  cr245 = cal_increasing_rate(tws245_mean)
  cr585 = cal_increasing_rate(tws585_mean)
  
  cr245_whole = cr245[[2]]
  cr585_whole = cr585[[2]]
  cr245 = cr245[[1]]
  cr585 = cr585[[1]]
  
  df = rbind(tws245_mean,tws585_mean)
  df$variable = paste0('H',df$variable)
  df$variable = factor(df$variable,
                       levels = paste0("HSW",1:10))
  df2 = rbind(tws245_maxmin,tws585_maxmin)
  df2$variable = factor(df2$variable,
                        levels = paste0('HSW',1:10))
  
  source('/home/share/R_project/xinjiang_vapor/import_pme_ato_fig4.R')
  pmedf = import_pme_ato_fig4(T)
  
  library(ggsci)
  col1 = pal_lancet(alpha = 0.8)(9)
  library(RColorBrewer)
  a = colorRampPalette(col1)(20)
  pals2 = pal_lancet(alpha = 0.8)(9)
  pals2 = colorRampPalette(pals2)(40)
  twscol = c('SSP245_TWS' = '#E2746E',
             'SSP585_TWS' = '#C12C44')
  pmecol = c('SSP245_PME1' = '#0B94B2',
             'SSP585_PME1' = '#2988AE',
             'SSP245_PME3' = '#00468B',
             'SSP585_PME3' = '#30376E')
  cols = c(twscol,pmecol)
  
  library(Rmisc)
  
  pathdf1 = data.frame(
    x = c(2018,2031,2031,2050),
    xend = c(2031,2050,2018,2031),
    y = c(4.5,4.5,4.5,4.5)-1+0.5
  )
  pathdf2 = data.frame(
    x = c(2018,2031,2050),
    y = rep(4.2,3)-1+0.5,
    yend = rep(4.8,3)-1+0.5
  )
  pathdf3 = data.frame(
    x = c(2018,2031,2031,2050),
    xend = c(2031,2050,2018,2031),
    y = rep(-4.5,2)+0.5
  )
  pathdf4 = data.frame(
    x = c(2018,2031,2050),
    y = c(-4.8,-4.8,-4.8)+0.5,
    yend = c(-4.2,-4.2,-4.2)
  )
  pathdf11 = pathdf1
  pathdf21 = pathdf2
  pathdf31 = pathdf3
  pathdf41 = pathdf4
  pathdf12 = pathdf1
  pathdf22 = pathdf2
  pathdf32 = pathdf3
  pathdf42 = pathdf4
  
  
  pathdf11$type = '(a) Regional mean standard indices under SSP245'
  pathdf21$type = '(a) Regional mean standard indices under SSP245'
  pathdf31$type = '(a) Regional mean standard indices under SSP245'
  pathdf41$type = '(a) Regional mean standard indices under SSP245'
  
  pathdf12$type = '(b) Regional mean standard indices under SSP585'
  pathdf22$type = '(b) Regional mean standard indices under SSP585'
  pathdf32$type = '(b) Regional mean standard indices under SSP585'
  pathdf42$type = '(b) Regional mean standard indices under SSP585'
  
  pathdfc1 = rbind(pathdf11,
                   pathdf12,
                   pathdf31,
                   pathdf32)
  pathdfc2 = rbind(pathdf21,
                   pathdf22,
                   pathdf41,
                   pathdf42)
  
  
  cr245$y = 5.3-1+0.5
  cr585$y = 3.6-1+0.5
  year = 2018:2050
  cr245$x = year[cr245$x]
  cr585$x = year[cr585$x]
  
  cr245$variable = paste0('H',cr245$variable)
  cr585$variable = paste0('H',cr585$variable)
  
  cr245$variable = factor(cr245$variable,
                          levels = paste0('HSW',1:10))
  cr585$variable = factor(cr585$variable,
                          levels = paste0('HSW',1:10))
  
  pline1 = ggplot()+
    #geom_ribbon(data = df2,aes(x = date,
    #                           ymax = max,
    #                           ymin = min),
    #            fill = '#87CEFA',
    #            alpha = 0.5)+
    geom_text(data = cr245,
              aes(x = x, y = y,label = label),
              size = 3.5,
              color = '#E2746E',
              fontface = 'bold')+
    geom_text(data = cr585,
              aes(x = x,y = y , label = label),
              size = 3.5,
              color = '#C12C44',
              fontface = 'bold')+
    geom_vline(xintercept = 2031,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_vline(xintercept = 2018,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_vline(xintercept = 2050,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_line(data = pmedf,
              aes(x = date,
                  y = value,
                  color = type),
              size = 1,
              alpha = 0.8)+
    geom_segment(data = pathdf1,
                 aes(x = x,xend =xend,
                     y = y,yend = y),
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'),
                 size = 0.5)+
    geom_segment(data = pathdf2,
                 aes(x = x,xend =x,
                     y = y,yend = yend),
                 size = 0.5)+
    geom_line(data = df,aes(x = date,
                            y = value,
                            color = type),
              size = 1)+
    
    #scale_fill_manual(values= fills)+
    scale_y_continuous(limits = c(-3,6),
                       position = 'left')+
    
    scale_color_manual(values = cols)+
    facet_wrap(~variable,ncol = 2)+
    theme_bw()+
    theme(legend.position = 'none')+
    ylab('Normalized indices')
  
  library(data.table)
  
  
  source('/home/share/R_project/xinjiang_vapor/cal_mean_tws_among_windows.R')
  mean_tws245 = cal_mean_tws_among_windows(tws245_mean,
                                           mode = 'mean')
  mean_tws585 = cal_mean_tws_among_windows(tws585_mean,
                                           mode = 'mean')
  mean_maxmin_tws245 = cal_mean_tws_among_windows(tws245_maxmin,
                                                  mode = 'max')
  
  mean_maxmin_tws585 = cal_mean_tws_among_windows(tws585_maxmin,
                                                  mode = 'max')
  mean_tws245$type = '(a) Regional mean standard indices under SSP245'
  mean_tws585$type = '(b) Regional mean standard indices under SSP585'
  
  pmedf1 = pmedf
  colnames(pmedf1) = c('date','variable','value')
  pmedf245 = pmedf1[
    which(pmedf1$variable %in% c('SSP245_PME1',
                                 'SSP245_PME3')),]
  pmedf585 = pmedf1[
    which(pmedf1$variable %in% c('SSP585_PME1',
                                 'SSP585_PME3')),
    ]
  pmedf245$type = '(a) Regional mean standard indices under SSP245'
  pmedf585$type = '(b) Regional mean standard indices under SSP585'
  
  library(prophet)
  source('/home/share/R_project/xinjiang_vapor/cal_increasing_rate_whole.R')
  ir_tws245 = cal_increasing_rate_whole(mean_tws245,
                                        'TWS_245')
  ir_tws585 = cal_increasing_rate_whole(mean_tws585,
                                        'TWS_585')
  ir_pme245 = cal_increasing_rate_whole(
    pmedf245,
    'SSP245_PME'
  )
  ir_pme585 = cal_increasing_rate_whole(pmedf585,
                                        'SSP585_PME')
  crytws= 4.8-0.2
  crypme1 = -4.5+0.5+0.6
  crypme2 = -5+0.5-0.3
  ir_tws245$y = crytws
  ir_tws585$y = crytws
  ir_pme245$y = c(crypme1,crypme2)
  ir_pme585$y =  c(crypme1,crypme2)
  
  ir_tws245$type = '(a) Regional mean standard indices under SSP245'
  ir_pme245$type = '(a) Regional mean standard indices under SSP245'
  ir_tws585$type = '(b) Regional mean standard indices under SSP585'
  ir_pme585$type = '(b) Regional mean standard indices under SSP585'
  
  irdf = rbind(ir_tws245,ir_pme245,
               ir_tws585,ir_pme585)
  irdf$x = year[irdf$x]
  
  # import pme ato mmk
  input_ato1 = 'analysis_output/fig4/ato_mmk_ssp245.nc'
  input_ato2 = 'analysis_output/fig4/ato_mmk_ssp585.nc'
  
  ato245 = raster(input_ato1)
  ato585 = raster(input_ato2)
  #aim 0.25
  rs = raster(nrow = 329,ncol = 626)
  extent(rs) = extent(c(-127.25,29.25,0,82.25))
  ato245r = resample(ato245,rs)
  ato585r = resample(ato585,rs)
  
  ato245df = as.data.frame(ato245r,
                           xy = T)
  ato585df = as.data.frame(ato585r,
                           xy = T)
  
  colnames(ato245df) = c('long','lat','SSP245-PME-MMK')
  colnames(ato585df) = c('long','lat','SSP585-PME-MMK')
  
  dfato1 = reshape2::melt(ato245df,
                          c('long','lat'))
  dfato2 = reshape2::melt(ato585df,
                          c('long','lat'))
  
  idless0 = which(dfato1$value < 0)
  idless02 = which(dfato2$value <0)
  
  dfato1 = dfato1[idless0,]
  dfato2 = dfato2[idless02,]
  
  dfato1$type = '(c) SSP245'
  dfato2$type = '(d) SSP585'
  
  dfato = rbind(dfato1,dfato2)
  dfato$cuts = cut(dfato$value,
                   breaks = c(-13,seq(-4,0,1)))
  
  fillato = colorRampPalette(
    brewer.pal(9,'YlOrRd')
  )(25)
  #sea_pme_mmk_pal = sea_pme_mmk_pal[1:]
  fillato = rev(fillato)
  fillato = fillato[seq(1,25,5)]
  
  
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  worlddf = fortify(world)
  worlddf1 = worlddf
  worlddf2 = worlddf
  
  worlddf1$type = '(c) SSP245'
  worlddf2$type = "(d) SSP585"
  worlddf = rbind(worlddf1,worlddf2)
  
  
  input_twsmmk = 'analysis_output/fig4/tws_subs_mmk/tws_mmk_subs_era5model.csv'
  twsmmk = fread(input_twsmmk)
  
  colnames(twsmmk) = c('long','lat',
                       '(c) SSP245','(d) SSP585')
  twsmmk = reshape2::melt(twsmmk,c('long','lat'))
  twsmmk$type = twsmmk$variable
  
  idless0 = which(twsmmk$value <0)
  twsmmk = twsmmk[idless0,]
  
  twsmmk$cuts = cut(twsmmk$value,
                    breaks = c(-63,seq(-10,0,1)))
  
  filltwsmmk = colorRampPalette(
    brewer.pal(9,'YlOrRd')
  )(25)
  filltwsmmk = rev(filltwsmmk)
  filltwsmmk = filltwsmmk[seq(1,25,2)][1:11]
  
  input_subs = 'sub_windows'
  num = 1:19
  input_subs = paste0(input_subs,'/sub_window',num,'.shp')
  
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  input_subs = input_subs[id_box]
  subs_shp = lapply(input_subs,shapefile)
  subs_shp = do.call('bind',subs_shp)
  subs_shp1 = fortify(subs_shp)
  subs_shp2 = fortify(subs_shp)
  
  subs_shp1$type = '(c) SSP245'
  subs_shp2$type = '(d) SSP585'
  subs_shp = rbind(subs_shp1,subs_shp2)
  
  xj = shp_management('xinjiang')
  xjdf = fortify(xj)
  xjdf1 = xjdf
  xjdf2 = xjdf
  xjdf1$type = '(c) SSP245'
  xjdf2$type = '(d) SSP585'
  xjdf = rbind(xjdf1,xjdf2)
  
  library(ggnewscale)
  
  ato1 = shapefile('cluster_shp/ato/ato1.shp')
  ato3 = shapefile('cluster_shp/ato/ato3.shp')
  
  cur_df = as.data.frame(
    fread('analysis_output/fig4/current_df.csv')
  )
  
  idless50 = which(cur_df$lat <= 50)
  cur_df = cur_df[idless50,]
  
  idbig1 = which(cur_df$u>0 &
                   cur_df$v >0)
  idbig2 = which(cur_df$u<0 &
                   cur_df$v >0)
  
  cur_df1 = cur_df[idbig1,]
  cur_df2 = cur_df[idbig2,]
  
  cid1 = seq(1,nrow(cur_df1),30)
  cid2 = seq(1,nrow(cur_df2),200)
  
  cur_df1 = cur_df1[cid1,]
  cur_df2 = cur_df2[cid2,]
  cur_df1$type = '(c) SSP245'
  cur_df11 = cur_df1
  cur_df2$type = '(c) SSP245'
  cur_df21 = cur_df2
  cur_df11$type = '(d) SSP585'
  cur_df21$type = '(d) SSP585'
  
  cur_df1 = rbind(cur_df1,cur_df11)
  cur_df2 = rbind(cur_df2,cur_df21)
  
  abline_df = data.frame(
    x = rep(c(2018,2031,2050),2),
    y = rep(c(-5,-5,-5),2),
    yend = rep(c(5,5,5),2),
    type = rep(c('(a) Regional mean standard indices under SSP245',
                 '(b) Regional mean standard indices under SSP585'),
               each =  3))  
  
  
  pline_whole = ggplot()+
    ###########
  geom_line(data = mean_tws245,
            aes(x = date,y = value,
                color = variable),
            size = 1.5)+
    geom_line(data = mean_tws585,
              aes(x = date,y = value,
                  color = variable),
              size = 1.5)+
    geom_line(data = pmedf245,
              aes(x = date,y = value,
                  color = variable),
              size = 1)+
    geom_line(data = pmedf585,
              aes(x = date,y = value,
                  color = variable),
              size = 1)+
    geom_segment(data = abline_df,
                 aes(x = x,xend = x,
                     y = y,yend = yend),
                 linetype = 'dashed',
                 size = 0.5)+
    geom_segment(data = pathdfc1,
                 aes(x = x,xend =xend,
                     y = y,yend = y),
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'),
                 size = 0.5)+
    geom_segment(data = pathdfc2,
                 aes(x = x,xend =x,
                     y = y,yend = yend),
                 size = 0.5)+
    geom_text(data = irdf,
              aes(x = x,y = y,label = label,
                  color = variable),
              size = 4,
              fontface = 'bold')+
    scale_color_manual(values = cols)+
    facet_wrap(~type,nrow = 1)+
    theme_bw()+
    theme(legend.position = 'none')
  #############
  
  cluster_traj_df = fread('analysis_output/fig2/cluster_traj_df.csv')
  cluster_traj_df = as.data.frame(cluster_traj_df)
  route_col = pal_npg()(10)[4]
  route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
  
  route_col = colorRampPalette(brewer.pal(
    9,'Blues'
  ))(20)
  
  pmap = ggplot()+
    ###########
  geom_tile(data = dfato,
            aes(x = long,
                y = lat,
                fill = cuts),
            color = 'transparent')+
    scale_fill_manual(values = fillato,
                      guide = guide_legend(
                        title = 'PME-ATO-MMK',
                        title.position = 'top',
                        nrow = 2
                      ))+
    new_scale_fill()+
    geom_tile(data = twsmmk,
              aes(x = long,
                  y = lat,
                  fill = cuts),
              color = 'transparent')+
    
    scale_fill_manual(values = filltwsmmk,
                      guide = guide_legend(
                        title = 'TWS-MMK',
                        title.position = 'top',
                        nrow = 2
                      ))+
    geom_segment(data = cur_df1,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.15,'cm'),
                               type = 'open'),
                 color = cols[4])+
    geom_segment(data = cur_df2,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.2,'cm'),
                               type = 'open'),
                 color = cols[6])+
    
    geom_polygon(data = worlddf,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_polygon(data = xjdf,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_path(data = cluster_traj_df,aes(x = long,y = lat,
                                         group = routeid,
                                         color = factor(
                                           routeid,
                                           levels = 1:20
                                         )),
              size = 0.5,
              linetype = 'solid',
              #color = route_col[5],
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="open"))+
    scale_color_manual(values = route_col,
                       guide = 'none')+
    geom_polygon(data = subs_shp,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    
    facet_wrap(~type,ncol = 1,
               scales = 'free')+
    #coord_sf()+
    theme_bw()+
    ###########
  theme(legend.position = 'none')+
    ylab('Latitude')
  
  world_crop = crop(world,
                    extent(-5,125,30,60))
  
  subs_label = data.frame(
    x = c(10,
          rep(30,3),
          rep(50,2),
          rep(70,2),
          rep(90,1),
          rep(110,1)),
    y = c(35,
          seq(35,60,10),
          seq(35,50,10),
          seq(35,50,10),
          45,
          40),
    label = paste0('SW',1:10)
  )
  
  pmap2= ggplot()+
    ##########
  geom_polygon(data = subs_shp,
               aes(x = long,
                   y = lat,
                   group = group),
               color = 'black',
               fill = 'transparent',
               size = 0.5)+
    geom_text(data = subs_label,
              aes(x = x,y =y ,label = label),
              size = 2.3,
              fontface = 'bold')+
    #coord_sf()+
    theme_void()+
    coord_fixed(1.3)+
    ###########
  theme(
    plot.background = element_rect(
      fill = 'white'
    )
  )
  
  
  # mmk analysis statistic for each subs and ato13
  input_mean_mmk = 'analysis_output/fig4/bars_mmk_mean'
  input1 = paste0(input_mean_mmk,'/','substws_mmk245.csv')
  input2 = paste0(input_mean_mmk,'/','substws_mmk585.csv')
  
  input3 = paste0(input_mean_mmk,'/',
                  'pme_mmk_ssp245.csv')
  input4 = paste0(input_mean_mmk,'/',
                  'pme_mmk_ssp585.csv')
  
  substws_mmk245 = as.data.frame(fread(input1))
  substws_mmk585 = as.data.frame(fread(input2))
  pme_mmk245 = as.data.frame(fread(input3))
  pme_mmk585 = as.data.frame(fread(input4))
  
  dfmmk_mean245 = rbind(substws_mmk245,pme_mmk245)
  dfmmk_mean585 = rbind(substws_mmk585,
                        pme_mmk585)
  
  fillbar = colorRampPalette(pal_npg()(9))(12)
  fillbar2 = colorRampPalette(brewer.pal(10,'Spectral'))(12)
  
  label_df1 =data.frame(
    y = dfmmk_mean245$Region,
    x = abs(dfmmk_mean245$MMK)-1,
    labels = round(dfmmk_mean245$MMK,1)
  )
  
  label_df2 =data.frame(
    y = dfmmk_mean585$Region,
    x = abs(dfmmk_mean585$MMK)-1,
    labels = round(dfmmk_mean585$MMK,1)
  )
  
  order245 = order(abs(dfmmk_mean245$MMK),
                   decreasing = T)
  order585 = order(abs(dfmmk_mean585$MMK),
                   decreasing = T)
  subs1 = dfmmk_mean245$Region[order245]
  subs2 = dfmmk_mean585$Region[order585]
  
  dfmmk_mean245$Region = 
    factor(dfmmk_mean245$Region,
           levels = subs1)
  dfmmk_mean585$Region = 
    factor(dfmmk_mean585$Region,
           levels = subs2)
  
  label_df1$y = factor(label_df1$y
                       ,levels = subs1)
  label_df2$y = factor(label_df2$y,
                       levels = subs2)
  
  pbar1 = ggplot()+
    ##############
  geom_bar(data = dfmmk_mean245,
           aes(x = abs(MMK),y = Region,
               fill = Region),
           stat = 'identity',
           position = "dodge",
           width = 0.8,alpha = 0.8)+
    geom_text(data = label_df1,
              aes(x = x,y = y, label = labels),
              color = 'black',size = 3,hjust =0.5)+
    scale_x_continuous(breaks = c(0,1,2,3,4),
                       labels =c(0,-1,-2,-3,-4))+
    scale_fill_manual(values = fillbar)+
    theme_bw()+
    theme(
      legend.position = 'none',
      panel.border = element_rect(fill = 'transparent',
                                  color = 'transparent'),
      axis.title = element_text(size = 10,color = 'black',
                                hjust = 0.5),
      panel.background = element_rect(fill = 'transparent',
                                      color = 'transparent'),
      panel.grid =element_blank(),
      axis.text = element_text(size = 5,color = 'black',hjust = 0.5),
      axis.line.x = element_line(color= 'black',size = 0.5))+
    ##############
  xlab('Regions')+
    ylab('MMK')
  
  pbar2 = ggplot()+
    ##############
  geom_bar(data = dfmmk_mean585,
           aes(x = abs(MMK) ,y =Region,
               fill = Region),
           stat = 'identity',
           position = "dodge",
           width = 0.8,alpha = 0.8)+
    geom_text(data = label_df2,
              aes(x = x,y = y, label = labels),
              color = 'black',size = 3,hjust =0.5)+
    scale_x_continuous(breaks = c(0,2,4,6,8),
                       labels =c(0,-2,-4,-6,-8))+
    scale_fill_manual(values = fillbar)+
    theme_bw()+
    theme(
      legend.position = 'none',
      panel.border = element_rect(fill = 'transparent',
                                  color = 'transparent'),
      axis.title = element_text(size = 5,color = 'black',
                                hjust = 0.5),
      panel.background = element_rect(fill = 'transparent',
                                      color = 'transparent'),
      panel.grid =element_blank(),
      axis.text = element_text(size = 5,color = 'black',hjust = 0.5),
      axis.line.x = element_line(color= 'black',size = 0.5))+
    xlab('Regions')+
    ylab('MMK')
  ##############
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  re_axis_title = 
    theme(axis.title.x = element_blank())
  axis_angel = theme(
    axis.text.x = element_text(
      color = 'black',
      size = fontsize,
      angle = 15)
  )
  
  pline1 = pline1+text_theme_set+re_axis_title
  #+axis_angel
  pline_whole = pline_whole+text_theme_set+re_axis_title
  pmap = pmap+text_theme_set+re_axis_title
  
  pline12 = pline1+theme(axis.title = element_blank())
  pmap = pmap+theme(axis.title = element_blank())
  pline_whole = pline_whole+theme(axis.title = element_blank())
  
  pline_whole = pline_whole+
    theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),'cm'),
          strip.text = element_blank())
  pmap = pmap+
    theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),'cm'),
          strip.text = element_blank())
  pline12 = pline12+
    theme(plot.margin = unit(c(0.1,0.1,0.1,0.1),'cm'),
          strip.text = element_blank())
  
  library(cowplot)
  p1 = plot_grid(pline_whole,pmap,
                 align = 'hv',
                 axis = 'lr',
                 rel_widths = c(1,1),
                 rel_heights = c(3,6),
                 ncol = 1)
  
  p12 = plot_grid(p1,pline12,
                  align = 'hv',
                  axis = 'lr',
                  rel_widths = c(2,1.5),
                  rel_heights = c(1,1),
                  nrow = 1)
  
  pbar1 = pbar1+
    theme(
      axis.title = element_blank(),
      axis.text.y = element_text(
        size = 9,color = 'black'
      ),
      axis.text.x = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      plot.background = element_rect(
        fill= 'transparent',
        color = 'transparent'
      )
      
    )
  pbar2 = pbar2+
    theme(
      axis.title = element_blank(),
      axis.text.y = element_text(
        size = 9,color = 'black'
      ),
      axis.text.x = element_blank(),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      plot.background  = element_rect(
        fill= 'transparent',
        color = 'transparent'
      )
    )
  
  p123 = ggdraw()+
    draw_plot(p12)+
    draw_plot(pbar1,x = 0.06, y = 0.352,
              width = 0.11, height = 0.22)+
    draw_plot(pbar2,x = 0.06, y = 0.02,
              width = 0.11, height = 0.22)+
    draw_plot(pmap2,x = 0.404, y = 0.329,
              width = 0.16, height = 0.15)+
    draw_plot(pmap2,x = 0.404, y = -0.007,
              width = 0.16, height = 0.15)
  
  png('main_plot/fig4/fig4_final7.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(p123)
  dev.off()
  
  legend_set = theme(
    legend.position = 'bottom'
  )
  library(ggpubr)
  pline1_legend = as_ggplot(
    get_legend(pline1+legend_set+
                 guides(color = guide_legend(
                   title = '',
                   title.position = 'top'
                 )))
  )
  
  pmap_legend = as_ggplot(
    get_legend(pmap+legend_set))
  
  png('main_plot/fig4/pmap_legend.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(pmap_legend)
  dev.off()
  
  png('main_plot/fig4/pline1_legend.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(pline1_legend)
  dev.off()
  
  
  
}



fig4_projection_of_tws_subs <- function(
 
){
  library(ggplot2)
  library(raster)
  input_tws = 'analysis_output/fig4/project_tws'
  input_tws = list.files(input_tws,full.names = T)
  
  
  tws245_maxmin = as.data.frame(fread(input_tws[1]))
  tws245_mean = as.data.frame(
    fread(input_tws[2])
  )
  
  tws585_maxmin = as.data.frame(
    fread(input_tws[3])
  )
  tws585_mean = as.data.frame(
    fread(input_tws[4])
  )
  
  colnames(tws245_mean) = c('date',
                            'variable',
                            'value')
  colnames(tws585_mean) = c('date',
                            'variable',
                            'value')
  
  tws245_mean$type = 'SSP245_TWS'
  tws585_mean$type = 'SSP585_TWS'
  tws245_maxmin$type = 'SSP245_TWS'
  tws585_maxmin$type = 'SSP585_TWS'
  
  sub_to_year_fun <- function(df){
    year = 2018:2050
    var  = paste0('SW',1:10)
    value = 1
    type = as.character(unique(df$type))
    for(i in 1:10){
      tmpid = which(df$variable %in% var[i])
      x = c(df[tmpid,3],rep(NA,6))
      xm = matrix(x,nrow = 12)
      
      xm = apply(xm,2,sum,na.rm = T)
      value = c(value,xm)
    }
    value = value[-1]
    retdf = data.frame(
      date = year,
      variable = rep(var,each = length(year)),
      value = value,
      type = type
    )
    return(retdf)
  }
  sub_to_year_fun_maxmin <- function(df){
    year = 2018:2050
    var  = paste0('SW',1:10)
    max = 1
    min = 1
    type = as.character(unique(df$type))
    for(i in 1:10){
    
      tmpid = which(df$variable %in% var[i])
      x = c(df[tmpid,3],rep(NA,6))
      xm = matrix(x,nrow = 12)
      xm = apply(xm,2,sum,na.rm = T)
      #xm = stand_fun(xm)
      max = c(max,xm)
      
      x = c(df[tmpid,4],rep(NA,6))
      xm = matrix(x,nrow = 12)
      xm = apply(xm,2,sum,na.rm = T)
      #xm = stand_fun(xm)
      min = c(min,xm)
    }
    max =max[-1]
    min = min[-1]
    retdf = data.frame(
      date = year,
      variable = rep(var,each = length(year)),
      max = max,
      min = min,
      type = type
    )
    return(retdf)
  }
  tws245_mean = sub_to_year_fun(tws245_mean)
  tws585_mean = sub_to_year_fun(tws585_mean)
  tws245_maxmin = sub_to_year_fun_maxmin(tws245_maxmin)
  tws585_maxmin = sub_to_year_fun_maxmin(tws585_maxmin)
  
  source('/home/share/R_project/xinjiang_vapor/cal_increasing_rate.R')
  cr245 = cal_increasing_rate(tws245_mean)
  cr585 = cal_increasing_rate(tws585_mean)
  
  cr245_whole = cr245[[2]]
  cr585_whole = cr585[[2]]
  cr245 = cr245[[1]]
  cr585 = cr585[[1]]
  
  
  id1 = which(tws245_mean$variable %in%
               paste0('SW',1:5))
  
  id2 = which(tws245_mean$variable %in%
                paste0('SW',6:10))
  
  df1 = rbind(tws245_mean[id1,],tws585_mean[id1,])
  df1$variable = factor(df1$variable,
                        levels = paste0('SW',1:5))
  
  df2 = rbind(tws245_maxmin[id1,],
              tws585_maxmin[id1,])
  df2$variable = factor(df2$variable,
                        levels = paste0('SW',1:5))
  source('/home/share/R_project/xinjiang_vapor/import_pme_ato_fig4.R')
  pmedf = import_pme_ato_fig4(T)
  
  idcr1 = which(cr245$variable %in% 
                  paste0('SW',1:5))
  idcr2 = which(cr245$variable %in% 
                  paste0('SW',6:10))
  idcr3 = which(cr245_whole$variable %in%
                  paste0('SW',1:5))
  idcr4 = which(cr245_whole$variable %in%
                  paste0('SW',6:10))
  
  
  cr245_1 = cr245[idcr1,]
  cr245_2 = cr245[idcr2,]
  cr245_whole1 = cr245_whole[idcr3,]
  cr245_whole2 = cr245_whole[idcr4,]
  
  cr585_1 = cr585[idcr1,]
  cr585_2 = cr585[idcr2,]
  cr585_whole1 = cr585_whole[idcr3,]
  cr585_whole2 = cr585_whole[idcr4,]
  
  library(ggsci)
  col1 = pal_lancet(alpha = 0.8)(9)
  library(RColorBrewer)
  a = colorRampPalette(col1)(20)
  pals2 = pal_lancet(alpha = 0.8)(9)
  pals2 = colorRampPalette(pals2)(40)
  twscol = c('SSP245_TWS' = '#E2746E',
             'SSP585_TWS' = '#C12C44')
  pmecol = c('SSP245_PME1' = '#0B94B2',
             'SSP585_PME1' = '#2988AE',
             'SSP245_PME3' = '#00468B',
             'SSP585_PME3' = '#30376E')
  cols = c(twscol,pmecol)
  
  library(Rmisc)
  
  pathdf1 = data.frame(
    x = c(2018,2031,2031,2050),
    xend = c(2031,2050,2018,2031),
    y = c(4.5,4.5,4.5,4.5)-1+0.5
  )
  pathdf2 = data.frame(
    x = c(2018,2031,2050),
    y = rep(4.2,3)-1+0.5,
    yend = rep(4.8,3)-1+0.5
  )
  pathdf3 = data.frame(
    x = c(2018,2031,2031,2050),
    xend = c(2031,2050,2018,2031),
    y = rep(-4.5,2)
  )
  pathdf4 = data.frame(
    x = c(2018,2031,2050),
    y = c(-4.8,-4.8,-4.8),
    yend = c(-4.2,-4.2,-4.2)
  )
  
  cr245_1$y = 5.3-1+0.5
  cr585_1$y = 3.6-1+0.5
  cr245_whole1$y = -3.3
  cr585_whole1$y = -3.7
  
  crdf1 = rbind(cr245_1,
                cr585_1)
  year = 2018:2050
  crdf1$x = year[crdf1$x]
  
  cr245_1$x = year[cr245_1$x]
  cr585_1$x = year[cr585_1$x]
  
  cr245_whole1$x = year[cr245_whole1$x]
  cr585_whole1$x = year[cr585_whole1$x]
  
  pline1 = ggplot()+
    
    geom_ribbon(data = df2,aes(x = date,
                               ymax = max,
                               ymin = min),
                fill = '#87CEFA',
                alpha = 0.5)+
    geom_text(data = cr245_1,
              aes(x = x, y = y,label = label),
              size = 4,
              color = '#E2746E')+
    geom_text(data = cr585_1,
              aes(x = x,y = y , label = label),
              size = 4,
              color = '#C12C44')+
    
    geom_vline(xintercept = 2031,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_vline(xintercept = 2018,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_vline(xintercept = 2050,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_line(data = pmedf,
              aes(x = date,
                y = value,
                  color = type),
              size = 1,
              alpha = 0.8)+
    geom_segment(data = pathdf1,
                 aes(x = x,xend =xend,
                     y = y,yend = y),
                 arrow = arrow(angle=30,
                                    unit('0.25','cm'),
                               type = 'closed'),
                 size = 0.5)+
    geom_segment(data = pathdf3,
                 aes(x = x,xend =xend,
                     y = y,yend = y),
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'),
                 size = 0.5)+
    geom_segment(data = pathdf2,
                 aes(x = x,xend =x,
                     y = y,yend = yend),
                 size = 0.5)+
    geom_segment(data = pathdf4,
                 aes(x = x,xend =x,
                     y = y,yend = yend),
                 size = 0.5)+
    geom_line(data = df1,aes(x = date,
                             y = value,
                             color = type),
              size = 1)+
    
    #scale_fill_manual(values= fills)+
    scale_y_continuous(limits = c(-6,5))+
    scale_color_manual(values = cols)+
    facet_wrap(~variable,nrow = 1)+
    theme_bw()+
    theme(legend.position = 'none')+
    ylab('Standardized indices')
  
  library(data.table)
 
  
  #dir.create('main_plot/fig4')
  png('main_plot/fig4/pline1_test.png',
      height = 6,
      width = 25,
      units =  'cm',
      res = 800)
  print(pline1)
  dev.off()
  
  
  df1 = rbind(tws245_mean[id2,],tws585_mean[id2,])
  df1$variable = factor(df1$variable,
                        levels = paste0('SW',6:10))
  
  df2 = rbind(tws245_maxmin[id2,],
              tws585_maxmin[id2,])
  df2$variable = factor(df2$variable,
                        levels = paste0('SW',6:10))
  
  
  cr245_2$y = 5.3-1+0.5
  cr585_2$y = 3.6-1+0.5
  cr245_whole2$y = -3.3
  cr585_whole2$y = -3.7
  
  
  crdf2 = rbind(cr245_2,
                cr585_2)
  year = 2018:2050
  crdf2$x = year[crdf2$x]
  
  cr245_2$x  = year[cr245_2$x]
  cr585_2$x  = year[cr585_2$x]
  cr245_whole2$x = year[cr245_whole2$x]
  cr585_whole2$x = year[cr585_whole2$x]
  
  pline2 = ggplot()+
    geom_ribbon(data = df2,aes(x = date,
                               ymax = max,
                               ymin = min),
                fill = '#87CEFA',
                alpha = 0.5)+
    
    geom_text(data = cr245_2,
              aes(x = x, y = y,label = label),
              size = 4,
              color = '#E2746E')+
    geom_text(data = cr585_2,
              aes(x = x,y = y , label = label),
              size = 4,
              color = '#C12C44')+
    
    geom_vline(xintercept = 2031,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_vline(xintercept = 2018,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_vline(xintercept = 2050,
               linetype = 'dashed',
               size = 0.5,
               color = 'black')+
    geom_segment(data = pathdf1,
                 aes(x = x,xend =xend,
                     y = y,yend = y),
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'),
                 size = 0.5)+
    geom_segment(data = pathdf3,
                 aes(x = x,xend =xend,
                     y = y,yend = y),
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'),
                 size = 0.5)+
    geom_segment(data = pathdf2,
                 aes(x = x,xend =x,
                     y = y,yend = yend),
                 size = 0.5)+
    geom_segment(data = pathdf4,
                 aes(x = x,xend =x,
                     y = y,yend = yend),
                 size = 0.5)+
    geom_line(data = pmedf,
              aes(x = date,
                  y = value,
                  color = type),
              size = 1,
              alpha = 0.8)+
    geom_line(data = df1,aes(x = date,
                             y = value,
                             color = type),
              size = 1.5)+
    scale_y_continuous(limits = c(-6,5))+
    #scale_fill_manual(values= fills)+
    scale_color_manual(values = cols)+
    facet_wrap(~variable,nrow = 1)+
    theme_bw()+
    theme(legend.position = 'none')+
    ylab('Standardized indices')
  
  #dir.create('main_plot/fig4')
  png('main_plot/fig4/pline2_test.png',
      height = 6,
      width = 25,
      units =  'cm',
      res = 800)
  print(pline2)
  dev.off()
  
  # import pme ato mmk
  input_ato1 = 'analysis_output/fig4/ato_mmk_ssp245.nc'
  input_ato2 = 'analysis_output/fig4/ato_mmk_ssp585.nc'
  
  ato245 = raster(input_ato1)
  ato585 = raster(input_ato2)
  #aim 0.25
  rs = raster(nrow = 329,ncol = 626)
  extent(rs) = extent(c(-127.25,29.25,0,82.25))
  ato245r = resample(ato245,rs)
  ato585r = resample(ato585,rs)
  
  ato245df = as.data.frame(ato245r,
                           xy = T)
  ato585df = as.data.frame(ato585r,
                           xy = T)
  
  colnames(ato245df) = c('long','lat','SSP245-PME-MMK')
  colnames(ato585df) = c('long','lat','SSP585-PME-MMK')

  dfato1 = reshape2::melt(ato245df,
                          c('long','lat'))
  dfato2 = reshape2::melt(ato585df,
                          c('long','lat'))
  
  idless0 = which(dfato1$value < 0)
  idless02 = which(dfato2$value <0)
  
  dfato1 = dfato1[idless0,]
  dfato2 = dfato2[idless02,]
  
  dfato1$type = 'SSP245'
  dfato2$type = 'SSP585'
  
  dfato = rbind(dfato1,dfato2)
  dfato$cuts = cut(dfato$value,
                   breaks = c(-13,seq(-4,0,1)))
  
  fillato = colorRampPalette(
    brewer.pal(9,'YlOrRd')
  )(25)
  #sea_pme_mmk_pal = sea_pme_mmk_pal[1:]
  fillato = rev(fillato)
  fillato = fillato[seq(1,25,5)]
  
  
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  input_twsmmk = 'analysis_output/fig4/tws_subs_mmk/tws_mmk_subs_era5model.csv'
  twsmmk = fread(input_twsmmk)
  
  colnames(twsmmk) = c('long','lat',
                       'SSP245','SSP585')
  twsmmk = reshape2::melt(twsmmk,c('long','lat'))
  twsmmk$type = twsmmk$variable
  
  idless0 = which(twsmmk$value <0)
  twsmmk = twsmmk[idless0,]
  
  twsmmk$cuts = cut(twsmmk$value,
                    breaks = c(-63,seq(-10,0,1)))
  
  filltwsmmk = colorRampPalette(
    brewer.pal(9,'YlOrRd')
  )(25)
  filltwsmmk = rev(filltwsmmk)
  filltwsmmk = filltwsmmk[seq(1,25,2)][1:11]
  
  input_subs = 'sub_windows'
  num = 1:19
  input_subs = paste0(input_subs,'/sub_window',num,'.shp')
  
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  input_subs = input_subs[id_box]
  subs_shp = lapply(input_subs,shapefile)
  subs_shp = do.call('bind',subs_shp)
  
  xj = shp_management('xinjiang')
  library(ggnewscale)
  
  ato1 = shapefile('cluster_shp/ato/ato1.shp')
  ato3 = shapefile('cluster_shp/ato/ato3.shp')
  
  cur_df = as.data.frame(
    fread('analysis_output/fig4/current_df.csv')
  )
  
  idless50 = which(cur_df$lat <= 50)
  cur_df = cur_df[idless50,]
  
  idbig1 = which(cur_df$u>0 &
                   cur_df$v >0)
  idbig2 = which(cur_df$u<0 &
                   cur_df$v >0)
  
  cur_df1 = cur_df[idbig1,]
  cur_df2 = cur_df[idbig2,]
  
  cid1 = seq(1,nrow(cur_df1),20)
  cid2 = seq(1,nrow(cur_df2),200)
  
  cur_df1 = cur_df1[cid1,]
  cur_df2 = cur_df2[cid2,]
  
  pmap = ggplot()+
    ###########
    geom_tile(data = dfato,
              aes(x = long,
                  y = lat,
                  fill = cuts),
              color = 'transparent')+
    scale_fill_manual(values = fillato,
                      guide = guide_legend(
                        title = 'PME-ATO-MMK',
                        title.position = 'top'
                      ))+
    new_scale_fill()+
    geom_tile(data = twsmmk,
              aes(x = long,
                  y = lat,
                  fill = cuts),
              color = 'transparent')+
    
    scale_fill_manual(values = filltwsmmk,
                      guide = guide_legend(
                        title = 'TWS-MMK',
                        title.position = 'top'
                      ))+
    geom_segment(data = cur_df1,
                 aes(x = long,y = lat,
                     xend = long+u,
                    yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.15,'cm'),
                               type = 'open'),
                 color = cols[4])+
    geom_segment(data = cur_df2,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.2,'cm'),
                               type = 'open'),
                 color = cols[6])+
    
    geom_polygon(data = world,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_polygon(data = xj,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_polygon(data = subs_shp,
                 aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    facet_wrap(~type,nrow = 1,
               scales = 'free')+
    #coord_sf()+
    theme_bw()+
    ###########
    theme(legend.position = 'bottom')+
    ylab('Latitude')
  
  world_crop = crop(world,
                    extent(-5,125,30,60))
  
  subs_label = data.frame(
    x = c(10,
          rep(30,3),
          rep(50,2),
          rep(70,2),
          rep(90,1),
          rep(110,1)),
    y = c(35,
          seq(35,60,10),
          seq(35,50,10),
          seq(35,50,10),
          45,
          40),
    label = paste0('SW',1:10)
  )
  
  pmap2= ggplot()+
    ##########
    geom_polygon(data = subs_shp,
                aes(x = long,
                     y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_text(data = subs_label,
              aes(x = x,y =y ,label = label),
              size = 2.5,
              fontface = 'bold')+
    #coord_sf()+
    theme_void()+
    coord_fixed(1.3)+
    ###########
    theme(
      plot.background = element_rect(
        fill = 'white'
      )
    )
  
  
  # mmk analysis statistic for each subs and ato13
  input_mean_mmk = 'analysis_output/fig4/bars_mmk_mean'
  input1 = paste0(input_mean_mmk,'/','substws_mmk245.csv')
  input2 = paste0(input_mean_mmk,'/','substws_mmk585.csv')
  
  input3 = paste0(input_mean_mmk,'/',
                   'pme_mmk_ssp245.csv')
  input4 = paste0(input_mean_mmk,'/',
                   'pme_mmk_ssp585.csv')
  
  substws_mmk245 = as.data.frame(fread(input1))
  substws_mmk585 = as.data.frame(fread(input2))
  pme_mmk245 = as.data.frame(fread(input3))
  pme_mmk585 = as.data.frame(fread(input4))
  
  dfmmk_mean245 = rbind(substws_mmk245,pme_mmk245)
  dfmmk_mean585 = rbind(substws_mmk585,
                        pme_mmk585)
  
  fillbar = colorRampPalette(pal_npg()(9))(12)
  fillbar2 = colorRampPalette(brewer.pal(10,'Spectral'))(12)
  
  label_df1 =data.frame(
    y = dfmmk_mean245$Region,
    x = abs(dfmmk_mean245$MMK)-1,
    labels = round(dfmmk_mean245$MMK,1)
  )
  
  label_df2 =data.frame(
    y = dfmmk_mean585$Region,
    x = abs(dfmmk_mean585$MMK)-1,
    labels = round(dfmmk_mean585$MMK,1)
  )
  
  order245 = order(abs(dfmmk_mean245$MMK),
                decreasing = T)
  order585 = order(abs(dfmmk_mean585$MMK),
                   decreasing = T)
  subs1 = dfmmk_mean245$Region[order245]
  subs2 = dfmmk_mean585$Region[order585]
  
  dfmmk_mean245$Region = 
    factor(dfmmk_mean245$Region,
           levels = subs1)
  dfmmk_mean585$Region = 
    factor(dfmmk_mean585$Region,
           levels = subs2)
  
  label_df1$y = factor(label_df1$y
                       ,levels = subs1)
  label_df2$y = factor(label_df2$y,
                       levels = subs2)
  
  pbar1 = ggplot()+
  ##############
    geom_bar(data = dfmmk_mean245,
             aes(x = abs(MMK),y = Region,
                 fill = Region),
             stat = 'identity',
             position = "dodge",
             width = 0.8,alpha = 0.8)+
    geom_text(data = label_df1,
              aes(x = x,y = y, label = labels),
              color = 'black',size = 3,hjust =0.5)+
    scale_x_continuous(breaks = c(0,1,2,3,4),
                       labels =c(0,-1,-2,-3,-4))+
    scale_fill_manual(values = fillbar)+
    theme_bw()+
    theme(
      legend.position = 'none',
      panel.border = element_rect(fill = 'transparent',
                                  color = 'transparent'),
      axis.title = element_text(size = 10,color = 'black',
                                hjust = 0.5),
      panel.background = element_rect(fill = 'transparent',
                                      color = 'transparent'),
      panel.grid =element_blank(),
      axis.text = element_text(size = 5,color = 'black',hjust = 0.5),
      axis.line.x = element_line(color= 'black',size = 0.5))+
    ##############
    xlab('Regions')+
    ylab('MMK')
  
  pbar2 = ggplot()+
    ##############
    geom_bar(data = dfmmk_mean585,
             aes(x = abs(MMK) ,y =Region,
                 fill = Region),
             stat = 'identity',
             position = "dodge",
             width = 0.8,alpha = 0.8)+
    geom_text(data = label_df2,
              aes(x = x,y = y, label = labels),
              color = 'black',size = 3,hjust =0.5)+
    scale_x_continuous(breaks = c(0,2,4,6,8),
                       labels =c(0,-2,-4,-6,-8))+
    scale_fill_manual(values = fillbar)+
    theme_bw()+
    theme(
      legend.position = 'none',
      panel.border = element_rect(fill = 'transparent',
                                  color = 'transparent'),
      axis.title = element_text(size = 5,color = 'black',
                                hjust = 0.5),
      panel.background = element_rect(fill = 'transparent',
                                      color = 'transparent'),
      panel.grid =element_blank(),
      axis.text = element_text(size = 5,color = 'black',hjust = 0.5),
      axis.line.x = element_line(color= 'black',size = 0.5))+
    xlab('Regions')+
    ylab('MMK')
  ##############
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  re_axis_title = 
    theme(axis.title.x = element_blank())
  axis_angel = theme(
    axis.text.x = element_text(
      color = 'black',
      size = fontsize,
      angle = 15)
  )
  pline1 = pline1+text_theme_set+re_axis_title+
    axis_angel
  pline2 = pline2+text_theme_set+re_axis_title+
    axis_angel
  pmap = pmap+text_theme_set+re_axis_title
  
  library(cowplot)
  p1 = plot_grid(pline1,pmap,pline2,
                 align = 'hv',
                 axis = 'lr',
                 rel_widths = c(1,1,1),
                 rel_heights = c(3,6,3),
                 ncol = 1)
  
  pbar1 = pbar1+
    theme(
      axis.title = element_blank(),
      axis.text = element_text(
        size = 10,color = 'black'
      ),
      plot.background = element_rect(
        fill= 'transparent',
        color = 'transparent'
      )
      
    )
  pbar2 = pbar2+
    theme(
      axis.title = element_blank(),
      axis.text = element_text(
        size = 10,color = 'black'
      ),
      plot.background  = element_rect(
        fill= 'transparent',
        color = 'transparent'
      )
    )
  
  p12 = ggdraw()+
    draw_plot(p1)+
    draw_plot(pbar1,x = 0.062, y = 0.29,
              width = 0.11, height = 0.3)+
    draw_plot(pbar2,x = 0.54, y = 0.29,
              width = 0.11, height = 0.3)+
    draw_plot(pmap2,x = 0.353, y = 0.26,
              width = 0.16, height = 0.15)+
    draw_plot(pmap2,x = 0.833, y = 0.26,
              width = 0.16, height = 0.15)
  
  png('main_plot/fig4/fig4_final4.png',
      height = 20,
      width = 27,
      units = 'cm',
      res = 800)
  print(p12)
  dev.off()
  
  
}









figs_big_scale_exploration_cor_tws_tws <- function(
  
){
  # analyze the relation between XJ and AS,EU,ATO
  
  # map plot 
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  # import cluster shps 
  input_cluster = 'cluster_shp'
  input_cluster = list.files(input_cluster,
                             full.names = T)
  input_ato = list.files(input_cluster[2],
                         full.names = T,
                         pattern = '*.shp$')[1:4]
  
  input_as = list.files(input_cluster[1],
                        full.names = T,
                        pattern = '*.shp$')
  input_eu = list.files(input_cluster[3],
                        full.names = T,
                        pattern = '*.shp$')[1:3]
  
  shp_ato = do.call('bind',lapply(input_ato,
                                  shapefile))
  shp_as = do.call('bind',
                   lapply(input_as,
                          shapefile))
  shp_eu = do.call('bind',
                   lapply(input_eu,
                          shapefile))
  
  shp_ato1 = fortify(shp_ato)
  shp_as1 = fortify(shp_as)
  shp_eu1 = fortify(shp_eu)
  
  shp_ato1$type = 1
  shp_as1$type = 3
  shp_eu1$type = 2
  
  shp_df = rbind(shp_ato1,shp_as1,
                 shp_eu1)
  
  # import trajectory
  trajs = fread('analysis_output/fig2/cluster_traj_df.csv')
  trajs = as.data.frame(trajs)
  route_col = pal_npg()(10)[4]
  route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  south_xj = shp_management('xinjiang_south')
  north_xj = shp_management('xinjiang_north')
  xj = shp_management('xinjiang')
  pmaps = ggplot()+
    geom_polygon(data = world,
                 aes(x = long,y =lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'grey80',
                 alpha = 0.8)+
    geom_polygon(data = shp_df,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_polygon(data = south_xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = north_xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    
    geom_polygon(data = south_moun,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = north_moun,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    
    geom_path(data = trajs,aes(x = long,y = lat,
                               group = routeid,
                               color = factor(routeid,
                                              levels = 1:20)),
              size = 1,
              #color = route_col,
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="open"))+    
    scale_color_manual(values = route_col)+
    facet_wrap(~type,ncol = 1,scales = 'free')+
    guides(color = FALSE)+
    theme_bw()
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  pmaps = pmaps + text_theme_set
  pmaps = pmaps+theme(
    strip.text = element_blank()
  )+xlab('Longitude')+ylab('Latitude')
  
  cal_center_point <- function(x){
    xm = extent(x)
    latm = round((xm[3]+xm[4])/2)
    longm = round((xm[1]+xm[2])/2)
    rm = data.frame(x = longm,y = latm)
    return(rm)
  }
  shp_ato_se = lapply(input_ato[1:4],shapefile)
  df_ato_label = lapply(shp_ato_se,
                        cal_center_point)
  df_ato_label = do.call('rbind',df_ato_label)
  df_ato_label$label =paste0('ATO',1:4)
  
  
  pmap1 = ggplot()+
    
    geom_polygon(data = shp_ato1,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_text(data = df_ato_label,
              aes(x = x,y = y,
                  label = label),
              size = 3,
              color = 'black')+
    theme_void()+
    coord_fixed(1.3)
  
  shp_eu_se = lapply(input_eu[1:3],shapefile)
  df_eu_label = lapply(shp_eu_se,
                       cal_center_point)
  df_eu_label = do.call('rbind',df_eu_label)
  df_eu_label$label =paste0('EU',1:3)
  
  pmap2 = ggplot()+
    geom_polygon(data = shp_eu1,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_text(data = df_eu_label,
              aes(x = x,y = y,
                  label = label),
              size = 3,
              color = 'black')+
    theme_void()+
    coord_fixed(1.3)
  
  shp_as_se = lapply(input_as,shapefile)
  df_as_label = lapply(shp_as_se,
                       cal_center_point)
  df_as_label = do.call('rbind',df_as_label)
  df_as_label$label =paste0('AS',1:4)
  
  pmap3 = ggplot()+
    geom_polygon(data = shp_as1,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_text(data = df_as_label,
              aes(x = x,y = y,
                  label = label),
              size = 3,
              color = 'black')+
    theme_void()+
    coord_fixed(1.3)
  
  # cor plot 
  tws_in_source = import_pe_in_source('tws_in_source',
                                      name = 'tws_sum.csv')
  colnames(tws_in_source) = paste0('tws',1:12)
  colnames(tws_in_source) = paste0('pme',1:12)
  twsdf = tws_in_source[,1:11]
  
  input_tws = 'tws_in_target/'
  files_jishui = c('north_jishui','south_jishui')
  input_tws = paste0(input_tws,files_jishui,'.csv')
  
  north_tws = as.data.frame(fread(input_tws[1]))
  south_tws = as.data.frame(fread(input_tws[2]))
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  twsdf = apply(twsdf,2,trend_fun)
  north_tws = trend_fun(north_tws)
  south_tws = trend_fun(south_tws)
  
  cor1box = 1
  cor2box = 1
  for(i in 1:11){
    cor1 = cor(twsdf[,i],north_tws)
    cor2 = cor(twsdf[,i],south_tws)
    #cor1 = max(ccf(twsdf[,i],north_tws)$acf)
    #cor2 = max(ccf(twsdf[,i],south_tws)$acf)
    cor1box = c(cor1box,cor1)
    cor2box = c(cor2box,cor2)
  }
  cor1box = cor1box[-1]
  cor2box = cor2box[-1]
  
  cordf = data.frame(
    x = paste0(rep(c('AS','ATO','EU'),each = 4)
               ,rep(1:4,3))[-12],
    Cor_North = cor1box,
    Cor_South = cor2box
  )
  cordf3 = cordf[1:4,]
  cordf1 = cordf[5:8,]
  cordf2 = cordf[9:11,]
  
  cordf1 = reshape2::melt(cordf1,'x')
  cordf2 = reshape2::melt(cordf2,'x')
  cordf3 = reshape2::melt(cordf3,'x')
  
  cordf1$type = 1
  cordf2$type = 2
  cordf3$type = 3
  
  cordf =rbind(cordf1,cordf2,cordf3)
  
  pals = pal_lancet(alpha = 0.8)(9)
  pcor = ggplot()+
    geom_bar(data  =cordf,
             aes(x = x,y = value,
                 fill = variable),
             stat = 'identity',
             position = 'dodge',
             width = 0.8)+
    geom_text(data = cordf,
              aes(x = x,y = value*1.2,
                  label = round(value,2)),
              size = 4,
              color = 'black',
              position = position_dodge2(0.8))+
    scale_fill_manual(values = pals[c(1,7)])+
    facet_wrap(~type,ncol = 1,scales = 'free')+
    theme_bw()+
    xlab('Source Regions')
  
  pcor = pcor+text_theme_set+
    theme(
      strip.text = element_blank(),
      axis.title.y = element_blank(),
      legend.position = 'none'
    )
  
  pcor = pcor+theme(
    plot.margin = unit(rep(0.1,4),'cm')
  )
  pmaps = pmaps+theme(
    plot.margin = unit(rep(0.1,4),'cm')
  )
  # adding (a)
  subs_df1 = data.frame(
    x = rep(-175,3),
    y = rep(80,3),
    label = c('(a)','(c)','(e)'),
    type = c(1,2,3)
  )  
  subs_df2 = data.frame(
    x = c('ATO1','EU1','AS1'),
    y = c(0.9,0.2,0.25),
    label = c('(b)','(d)','(f)'),
    type = c(1,2,3)
  ) 
  
  pmaps  = pmaps+
    geom_text(data = subs_df1,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black')
  
  pcor = pcor+
    geom_text(data = subs_df2,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black')
  
  # assemble plots
  library(cowplot)
  p12 = plot_grid(pmaps,
                  pcor,
                  rel_widths = c(3,1.5),
                  rel_heights = c(1,1),
                  nrow = 1)
  
  output = 'main_plot/SI/big_scale_tws_tws_cor/figs.png'
  dir.create('main_plot/SI/big_scale_tws_tws_cor')
  
  p123 = ggdraw()+
    draw_plot(p12)+
    draw_plot(pmap1,x =0.05,y = 0.72 ,
              height = 0.1,width = 0.13)+
    draw_plot(pmap2,x = 0.05,y = 0.38,
              height = 0.1,width = 0.13)+
    draw_plot(pmap3,x= 0.05,y = 0.06,
              height =0.1,width = 0.13)
  
  
  png(output,
      width = 25,
      height =22,
      units = 'cm',
      res = 800)
  print(p123)
  dev.off()
  
  
  
  
}
figs_big_scale_exploration_cor <- function(
  
){
  # analyze the relation between XJ and AS,EU,ATO
  
  # map plot 
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  # import cluster shps 
  input_cluster = 'cluster_shp'
  input_cluster = list.files(input_cluster,
                             full.names = T)
  input_ato = list.files(input_cluster[2],
                         full.names = T,
                         pattern = '*.shp$')[1:4]
  
  input_as = list.files(input_cluster[1],
                         full.names = T,
                         pattern = '*.shp$')
  input_eu = list.files(input_cluster[3],
                         full.names = T,
                         pattern = '*.shp$')[1:3]
  
  shp_ato = do.call('bind',lapply(input_ato,
                                  shapefile))
  shp_as = do.call('bind',
                   lapply(input_as,
                          shapefile))
  shp_eu = do.call('bind',
                   lapply(input_eu,
                          shapefile))
  
  shp_ato1 = fortify(shp_ato)
  shp_as1 = fortify(shp_as)
  shp_eu1 = fortify(shp_eu)
  
  shp_ato1$type = 1
  shp_as1$type = 3
  shp_eu1$type = 2
  
  shp_df = rbind(shp_ato1,shp_as1,
                 shp_eu1)
  
  # import trajectory
  trajs = fread('analysis_output/fig2/cluster_traj_df.csv')
  trajs = as.data.frame(trajs)
  route_col = pal_npg()(10)[4]
  route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  south_xj = shp_management('xinjiang_south')
  north_xj = shp_management('xinjiang_north')
  xj = shp_management('xinjiang')
  pmaps = ggplot()+
    geom_polygon(data = world,
                 aes(x = long,y =lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'grey80',
                 alpha = 0.8)+
    geom_polygon(data = shp_df,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_polygon(data = south_xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = north_xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    
    geom_polygon(data = south_moun,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = north_moun,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    
    geom_path(data = trajs,aes(x = long,y = lat,
                              group = routeid,
                              color = factor(routeid,
                                             levels = 1:20)),
              size = 1,
              #color = route_col,
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="open"))+    
    scale_color_manual(values = route_col)+
    facet_wrap(~type,ncol = 1,scales = 'free')+
    guides(color = FALSE)+
    theme_bw()
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  pmaps = pmaps + text_theme_set
  pmaps = pmaps+theme(
    strip.text = element_blank()
  )+xlab('Longitude')+ylab('Latitude')
  
  cal_center_point <- function(x){
    xm = extent(x)
    latm = round((xm[3]+xm[4])/2)
    longm = round((xm[1]+xm[2])/2)
    rm = data.frame(x = longm,y = latm)
    return(rm)
  }
  shp_ato_se = lapply(input_ato[1:4],shapefile)
  df_ato_label = lapply(shp_ato_se,
                        cal_center_point)
  df_ato_label = do.call('rbind',df_ato_label)
  df_ato_label$label =paste0('ATO',1:4)
  
  
  pmap1 = ggplot()+
    
    geom_polygon(data = shp_ato1,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_text(data = df_ato_label,
              aes(x = x,y = y,
                  label = label),
              size = 3,
              color = 'black')+
    theme_void()+
    coord_fixed(1.3)
  
  shp_eu_se = lapply(input_eu[1:3],shapefile)
  df_eu_label = lapply(shp_eu_se,
                       cal_center_point)
  df_eu_label = do.call('rbind',df_eu_label)
  df_eu_label$label =paste0('EU',1:3)
  
  pmap2 = ggplot()+
    geom_polygon(data = shp_eu1,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_text(data = df_eu_label,
              aes(x = x,y = y,
                  label = label),
              size = 3,
              color = 'black')+
    theme_void()+
    coord_fixed(1.3)
  
  shp_as_se = lapply(input_as,shapefile)
  df_as_label = lapply(shp_as_se,
                       cal_center_point)
  df_as_label = do.call('rbind',df_as_label)
  df_as_label$label =paste0('AS',1:4)
  
  pmap3 = ggplot()+
    geom_polygon(data = shp_as1,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_text(data = df_as_label,
              aes(x = x,y = y,
                  label = label),
              size = 3,
              color = 'black')+
    theme_void()+
    coord_fixed(1.3)
  
  # cor plot 
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pe_in_source = pe_in_source * 30.5
  
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  pe_minus_eva = pe_in_source - pet_sum
  colnames(pe_minus_eva) = paste0('pme',1:12)
  pmedf = pe_minus_eva[,1:11]
  
  input_tws = 'tws_in_target/'
  files_jishui = c('north_jishui','south_jishui')
  input_tws = paste0(input_tws,files_jishui,'.csv')
  
  north_tws = as.data.frame(fread(input_tws[1]))
  south_tws = as.data.frame(fread(input_tws[2]))
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  pmedf = apply(pmedf,2,trend_fun)
  north_tws = trend_fun(north_tws)
  south_tws = trend_fun(south_tws)
  
  cor1box = 1
  cor2box = 1
  for(i in 1:11){
    cor1 = cor(pmedf[,i],north_tws)
    cor2 = cor(pmedf[,i],south_tws)
    #cor1 = max(ccf(pmedf[,i],north_tws)$acf)
    #cor2 = max(ccf(pmedf[,i],south_tws)$acf)
    cor1box = c(cor1box,cor1)
    cor2box = c(cor2box,cor2)
  }
  cor1box = cor1box[-1]
  cor2box = cor2box[-1]
  
  cordf = data.frame(
    x = paste0(rep(c('AS','ATO','EU'),each = 4)
               ,rep(1:4,3))[-12],
    Cor_North = cor1box,
    Cor_South = cor2box
  )
  cordf3 = cordf[1:4,]
  cordf1 = cordf[5:8,]
  cordf2 = cordf[9:11,]
  
  cordf1 = reshape2::melt(cordf1,'x')
  cordf2 = reshape2::melt(cordf2,'x')
  cordf3 = reshape2::melt(cordf3,'x')
  
  cordf1$type = 1
  cordf2$type = 2
  cordf3$type = 3
  
  cordf =rbind(cordf1,cordf2,cordf3)
  
  pals = pal_lancet(alpha = 0.8)(9)
  pcor = ggplot()+
    geom_bar(data  =cordf,
             aes(x = x,y = value,
                 fill = variable),
             stat = 'identity',
             position = 'dodge',
             width = 0.8)+
    geom_text(data = cordf,
              aes(x = x,y = value*1.2,
                  label = round(value,2)),
              size = 4,
              color = 'black',
              position = position_dodge2(0.8))+
    scale_fill_manual(values = pals[c(1,7)])+
    facet_wrap(~type,ncol = 1,scales = 'free')+
    theme_bw()+
    xlab('Source Regions')
  
  pcor = pcor+text_theme_set+
    theme(
      strip.text = element_blank(),
      axis.title.y = element_blank(),
      legend.position = 'none'
    )
  
  pcor = pcor+theme(
    plot.margin = unit(rep(0.1,4),'cm')
  )
  pmaps = pmaps+theme(
    plot.margin = unit(rep(0.1,4),'cm')
  )
  
  
  
  # adding (a)
  subs_df1 = data.frame(
    x = rep(-175,3),
    y = rep(80,3),
    label = c('(a)','(c)','(e)'),
    type = c(1,2,3)
  )  
  subs_df2 = data.frame(
    x = c('ATO1','EU1','AS1'),
    y = c(0.9,0.2,0.25),
    label = c('(b)','(d)','(f)'),
    type = c(1,2,3)
  ) 
  
  pmaps  = pmaps+
    geom_text(data = subs_df1,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black')
  
  pcor = pcor+
    geom_text(data = subs_df2,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black')
  
  # assemble plots
  library(cowplot)
  p12 = plot_grid(pmaps,
                  pcor,
                  rel_widths = c(3,1.5),
                  rel_heights = c(1,1),
                  nrow = 1)
  
  output = 'main_plot/SI/big_scale_pme_tws_cor/figs.png'
  #dir.create('main_plot/SI/big_scale_pme_tws_cor')
  png(output,
      width = 25,
      height =22,
      units = 'cm',
      res = 800)
  print(p12)
  dev.off()
  
  p123 = ggdraw()+
    draw_plot(p12)+
    draw_plot(pmap1,x =0.05,y = 0.72 ,
              height = 0.1,width = 0.13)+
    draw_plot(pmap2,x = 0.05,y = 0.38,
              height = 0.1,width = 0.13)+
    draw_plot(pmap3,x= 0.05,y = 0.06,
              height =0.1,width = 0.13)
  
 
  png(output,
      width = 25,
      height =22,
      units = 'cm',
      res = 800)
  print(p123)
  dev.off()
  
  
    
    
  
  
}
figs_big_scale_exploration_pme_pme_cor <- function(
  
){
  # analyze the relation between XJ and AS,EU,ATO
  
  # map plot 
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  # import cluster shps 
  input_cluster = 'cluster_shp'
  input_cluster = list.files(input_cluster,
                             full.names = T)
  input_ato = list.files(input_cluster[2],
                         full.names = T,
                         pattern = '*.shp$')[1:4]
  
  input_as = list.files(input_cluster[1],
                        full.names = T,
                        pattern = '*.shp$')[c(2,4)]
  input_eu = list.files(input_cluster[3],
                        full.names = T,
                        pattern = '*.shp$')[1:3]
  
  shp_ato = do.call('bind',lapply(input_ato,
                                  shapefile))
  shp_as = do.call('bind',
                   lapply(input_as,
                          shapefile))
  shp_eu = do.call('bind',
                   lapply(input_eu,
                          shapefile))
  
  shp_ato1 = fortify(shp_ato)
  shp_as1 = fortify(shp_as)
  shp_eu1 = fortify(shp_eu)
  
  shp_ato1$type = 1
  shp_as1$type = 3
  shp_eu1$type = 2
  
  shp_df = rbind(shp_ato1,shp_as1,
                 shp_eu1)
  
  # import trajectory
  trajs = fread('analysis_output/fig2/cluster_traj_df.csv')
  trajs = as.data.frame(trajs)
  route_col = pal_npg()(10)[4]
  route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  south_xj = shp_management('xinjiang_south')
  north_xj = shp_management('xinjiang_north')
  xj = shp_management('xinjiang')
  pmaps = ggplot()+
    geom_polygon(data = world,
                 aes(x = long,y =lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'grey80',
                 alpha = 0.8)+
    geom_polygon(data = shp_df,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_polygon(data = south_xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = north_xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    
    geom_polygon(data = south_moun,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = north_moun,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    
    geom_path(data = trajs,aes(x = long,y = lat,
                               group = routeid,
                               color = factor(routeid,
                                              levels = 1:20)),
              size = 1,
              #color = route_col,
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="open"))+    
    scale_color_manual(values = route_col)+
    facet_wrap(~type,ncol = 1,scales = 'free')+
    guides(color = FALSE)+
    theme_bw()
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  pmaps = pmaps + text_theme_set
  pmaps = pmaps+theme(
    strip.text = element_blank()
  )+xlab('Longitude')+ylab('Latitude')
  
  cal_center_point <- function(x){
    xm = extent(x)
    latm = round((xm[3]+xm[4])/2)
    longm = round((xm[1]+xm[2])/2)
    rm = data.frame(x = longm,y = latm)
    return(rm)
  }
  shp_ato_se = lapply(input_ato[1:4],shapefile)
  df_ato_label = lapply(shp_ato_se,
                        cal_center_point)
  df_ato_label = do.call('rbind',df_ato_label)
  df_ato_label$label =paste0('ATO',1:4)
  
  
  pmap1 = ggplot()+
    
    geom_polygon(data = shp_ato1,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_text(data = df_ato_label,
              aes(x = x,y = y,
                  label = label),
              size = 3,
              color = 'black')+
    theme_void()+
    coord_fixed(1.3)
  
  shp_eu_se = lapply(input_eu[1:3],shapefile)
  df_eu_label = lapply(shp_eu_se,
                       cal_center_point)
  df_eu_label = do.call('rbind',df_eu_label)
  df_eu_label$label =paste0('EU',1:3)
  
  pmap2 = ggplot()+
    geom_polygon(data = shp_eu1,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_text(data = df_eu_label,
              aes(x = x,y = y,
                  label = label),
              size = 3,
              color = 'black')+
    theme_void()+
    coord_fixed(1.3)
  
  shp_as_se = lapply(input_as,shapefile)
  df_as_label = lapply(shp_as_se,
                       cal_center_point)
  df_as_label = do.call('rbind',df_as_label)
  df_as_label$label =paste0('AS',1:2)
  
  pmap3 = ggplot()+
    geom_polygon(data = shp_as1,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_text(data = df_as_label,
              aes(x = x,y = y,
                  label = label),
              size = 3,
              color = 'black')+
    theme_void()+
    coord_fixed(1.3)
  
  # cor plot 
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pe_in_source = pe_in_source * 30.5
  
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  pe_minus_eva = pe_in_source - pet_sum
  colnames(pe_minus_eva) = paste0('pme',1:12)
  pmedf = pe_minus_eva[,1:11]
  
  tws_in_source = import_pe_in_source('tws_in_source',
                                      name = 'tws_sum.csv')
  colnames(tws_in_source) = paste0('tws',1:12)
  tws_in_source = tws_in_source[,1:11]
  tws_in_source  =as.data.frame(tws_in_source)
  
  input_pr_intarget = list.files('era5_pr_in_target',
                                 full.names = T)[c(1,3)]
  input_eva_intarget = list.files('poten_evap_in_target',
                                  full.names =T)[c(1,3)]
  prtar = lapply(lapply(input_pr_intarget,fread),
                 as.data.frame)
  evatar = lapply(lapply(input_eva_intarget,fread),
                  as.data.frame)
  
  prtar = do.call('cbind',prtar)
  evatar = do.call('cbind',evatar)
  
  #prtar = apply(prtar,1,sum,na.rm =T)
  #evatar = apply(evatar,1,sum,na.rm = T)
  
  pmetar = prtar-evatar
  pmetar = pmetar[1:174,]
  
  input_tws = 'tws_in_target/'
  input_tws = list.files(input_tws,
                         full.names = T)[c(1,3)]
  
  twstar = lapply(lapply(input_tws,
                         fread),
                  as.data.frame)
  twstar = do.call('cbind',twstar)
  
  #twstar = apply(twstar,1,sum,na.rm = T)
  
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  pmedf = apply(pmedf,2,trend_fun)
  twsdf = apply(tws_in_source,2,trend_fun)
  #pmetar = trend_fun(pmetar)
  #twstar = trend_fun(twstar)
  north_pme = trend_fun(pmetar[,1])
  north_tws = trend_fun(twstar[,1])
  south_pme = trend_fun(pmetar[,2])
  south_tws = trend_fun(twstar[,2])
  
  twsdf = twsdf[,-c(1,3,5:8)]
  pmedf = pmedf[,5:8]
  
  corpme_nor = 1
  corpme_sou = 1
  for(i in 1:ncol(pmedf)){
    tmpcor_nor = cor(pmedf[,i],north_tws)
    #tmpcor_nor = max(ccf(pmedf[,i],north_tws)$acf)
    corpme_nor = c(corpme_nor,tmpcor_nor)
    
    tmpcor_sou = cor(pmedf[,i],south_tws)
    #tmpcor_sou = max(ccf(pmedf[,i],south_tws)$acf)
    corpme_sou = c(corpme_sou,tmpcor_sou)
  }
  corpme_nor = corpme_nor[-1]
  corpme_sou = corpme_sou[-1]
  
  cordf1 = data.frame(
    x = paste0('ATO',1:4),
    COR_PME_TWS_North = corpme_nor,
    COR_PME_TWS_South = corpme_sou,
    type = 1
  )
  
  cortws_nor = 1
  cortws_sou = 1
  for(i in 1:ncol(twsdf)){
    tmpcor_nor = cor(twsdf[,i],north_tws)
    #tmpcor_nor = max(ccf(twsdf[,i],north_tws)$acf)
    cortws_nor = c(cortws_nor,tmpcor_nor)
    
    tmpcor_sou = cor(twsdf[,i],south_tws)
    #tmpcor_sou = max(ccf(twsdf[,i],south_tws)$acf)
    cortws_sou = c(cortws_sou,tmpcor_sou)
    
  }
  cortws_nor = cortws_nor[-1]
  cortws_sou = cortws_sou[-1]
  
  
  cordf2 = data.frame(
    x = c(paste0('AS',1:2),paste0('EU',1:3)),
    COR_TWS_TWS_North = cortws_nor,
    COR_TWS_TWS_South = cortws_sou,
    type = c(rep(3,2),rep(2,3))
  )
  
  cordf1 = reshape2::melt(cordf1,c('x','type'))
  cordf2 = reshape2::melt(cordf2,c('x','type'))
  cordf = rbind(cordf1,cordf2)
  
  
  pals = pal_lancet(alpha = 0.8)(9)
  
  pals = c('COR_PME_TWS_North' = pals[1],
           'COR_PME_TWS_South' = pals[4],
           'COR_TWS_TWS_North' = pals[6],
           'COR_TWS_TWS_South' = pals[7])
  
  pcor = ggplot()+
    geom_bar(data  =cordf,
             aes(x = x,y = value,
                 fill = variable),
             stat = 'identity',
             position = 'dodge',
             width = 0.8)+
    geom_text(data = cordf,
              aes(x = x,y = value*1.2,
                  label = round(value,2)),
              size = 4,
              position = position_dodge2(0.8),
              color = 'black')+
    scale_fill_manual(values = pals)+
    facet_wrap(~type,ncol = 1,scales = 'free')+
    theme_bw()+
    xlab('Source Regions')
  
  pcor = pcor+text_theme_set+
    theme(
      strip.text = element_blank(),
      axis.title.y = element_blank(),
      legend.position = 'none'
    )
  
  pcor = pcor+theme(
    plot.margin = unit(rep(0.1,4),'cm')
  )
  pmaps = pmaps+theme(
    plot.margin = unit(rep(0.1,4),'cm')
  )
  
  
  
  # adding (a)
  subs_df1 = data.frame(
    x = rep(-175,3),
    y = rep(80,3),
    label = c('(a)','(c)','(e)'),
    type = c(1,2,3)
  )  
  subs_df2 = data.frame(
    x = c('ATO1','EU1','AS2'),
    y = c(0.9,-0.26,1.1),
    label = c('(b)','(d)','(f)'),
    type = c(1,2,3)
  ) 
  
  pmaps  = pmaps+
    geom_text(data = subs_df1,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black')
  
  pcor = pcor+
    geom_text(data = subs_df2,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black')
  
  # assemble plots
  library(cowplot)
  p12 = plot_grid(pmaps,
                  pcor,
                  rel_widths = c(3,1.5),
                  rel_heights = c(1,1),
                  nrow = 1)
  
  output = 'main_plot/SI/big_scale_pme_tws_tws_cor/figs1.png'
  dir.create('main_plot/SI/big_scale_pme_tws_tws_cor')
  
  p123 = ggdraw()+
    draw_plot(p12)+
    draw_plot(pmap1,x =0.05,y = 0.72 ,
              height = 0.1,width = 0.13)+
    draw_plot(pmap2,x = 0.05,y = 0.38,
              height = 0.1,width = 0.13)+
    draw_plot(pmap3,x= 0.05,y = 0.06,
              height =0.1,width = 0.13)
  
  
  leg1 = as_ggplot(get_legend(
    pcor+guides(fill = guide_legend(
      title = 'Pearson Correlation Coefficients',
      title.position = 'top',nrow = 1
    ))+theme(legend.position = 'bottom')
  ))
  
  leg1  =leg1+theme(plot.margin = unit(rep(0,4),'cm'))
  
  p1234 = plot_grid(
    p123,leg1,
    ncol = 1,
    rel_heights = c(10,1)
  )
  
  
  png(output,
      width = 25,
      height =22,
      units = 'cm',
      res = 800)
  print(p1234)
  dev.off()
  
  
  
  
  
  
}
figs_big_scale_exploration_pme_pme_single_cor <- function(
  
){
  # analyze the relation between XJ and AS,EU,ATO
  
  # map plot 
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  # import cluster shps 
  input_cluster = 'cluster_shp'
  input_cluster = list.files(input_cluster,
                             full.names = T)
  input_ato = list.files(input_cluster[2],
                         full.names = T,
                         pattern = '*.shp$')[1:4]
  
  input_as = list.files(input_cluster[1],
                        full.names = T,
                        pattern = '*.shp$')[c(2,4)]
  input_eu = list.files(input_cluster[3],
                        full.names = T,
                        pattern = '*.shp$')[1:3]
  
  shp_ato = do.call('bind',lapply(input_ato,
                                  shapefile))
  shp_as = do.call('bind',
                   lapply(input_as,
                          shapefile))
  shp_eu = do.call('bind',
                   lapply(input_eu,
                          shapefile))
  
  shp_ato1 = fortify(shp_ato)
  shp_as1 = fortify(shp_as)
  shp_eu1 = fortify(shp_eu)
  
  shp_ato1$type = 1
  shp_as1$type = 3
  shp_eu1$type = 2
  
  shp_df = rbind(shp_ato1,shp_as1,
                 shp_eu1)
  
  # import trajectory
  trajs = fread('analysis_output/fig2/cluster_traj_df.csv')
  trajs = as.data.frame(trajs)
  route_col = pal_npg()(10)[4]
  route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
  
  south_moun = shp_management('xinjiang_jishui_south')
  north_moun = shp_management('xinjiang_jishui_north')
  south_xj = shp_management('xinjiang_south')
  north_xj = shp_management('xinjiang_north')
  xj = shp_management('xinjiang')
  pmaps = ggplot()+
    geom_polygon(data = world,
                 aes(x = long,y =lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'grey80',
                 alpha = 0.8)+
    geom_polygon(data = shp_df,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_polygon(data = south_xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = north_xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    
    geom_polygon(data = south_moun,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = north_moun,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    geom_polygon(data = xj,
                 aes(x = long, y = lat,group = group),
                 fill = 'transparent',color = 'black',size = 0.5)+
    
    geom_path(data = trajs,aes(x = long,y = lat,
                               group = routeid,
                               color = factor(routeid,
                                              levels = 1:20)),
              size = 1,
              #color = route_col,
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="open"))+    
    scale_color_manual(values = route_col)+
    facet_wrap(~type,ncol = 1,scales = 'free')+
    guides(color = FALSE)+
    theme_bw()
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  pmaps = pmaps + text_theme_set
  pmaps = pmaps+theme(
    strip.text = element_blank()
  )+xlab('Longitude')+ylab('Latitude')
  
  cal_center_point <- function(x){
    xm = extent(x)
    latm = round((xm[3]+xm[4])/2)
    longm = round((xm[1]+xm[2])/2)
    rm = data.frame(x = longm,y = latm)
    return(rm)
  }
  shp_ato_se = lapply(input_ato[1:4],shapefile)
  df_ato_label = lapply(shp_ato_se,
                        cal_center_point)
  df_ato_label = do.call('rbind',df_ato_label)
  df_ato_label$label =paste0('ATO',1:4)
  
  
  pmap1 = ggplot()+
    
    geom_polygon(data = shp_ato1,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_text(data = df_ato_label,
              aes(x = x,y = y,
                  label = label),
              size = 3,
              color = 'black')+
    theme_void()+
    coord_fixed(1.3)
  
  shp_eu_se = lapply(input_eu[1:3],shapefile)
  df_eu_label = lapply(shp_eu_se,
                       cal_center_point)
  df_eu_label = do.call('rbind',df_eu_label)
  df_eu_label$label =paste0('EU',1:3)
  
  pmap2 = ggplot()+
    geom_polygon(data = shp_eu1,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_text(data = df_eu_label,
              aes(x = x,y = y,
                  label = label),
              size = 3,
              color = 'black')+
    theme_void()+
    coord_fixed(1.3)
  
  shp_as_se = lapply(input_as,shapefile)
  df_as_label = lapply(shp_as_se,
                       cal_center_point)
  df_as_label = do.call('rbind',df_as_label)
  df_as_label$label =paste0('AS',1:2)
  
  pmap3 = ggplot()+
    geom_polygon(data = shp_as1,
                 aes(x = long,y = lat,group = group),
                 size = 0.5,
                 color = 'black',
                 fill = 'white',
                 alpha = 0.5)+
    geom_text(data = df_as_label,
              aes(x = x,y = y,
                  label = label),
              size = 3,
              color = 'black')+
    theme_void()+
    coord_fixed(1.3)
  
  # cor plot 
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pe_in_source = pe_in_source * 30.5
  
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  pe_minus_eva = pe_in_source - pet_sum
  colnames(pe_minus_eva) = paste0('pme',1:12)
  pmedf = pe_minus_eva[,1:11]
  
  tws_in_source = import_pe_in_source('tws_in_source',
                                      name = 'tws_sum.csv')
  colnames(tws_in_source) = paste0('tws',1:12)
  tws_in_source = tws_in_source[,1:11]
  tws_in_source  =as.data.frame(tws_in_source)
  
  input_pr_intarget = list.files('era5_pr_in_target',
                                 full.names = T)[c(1,3)]
  input_eva_intarget = list.files('poten_evap_in_target',
                                  full.names =T)[c(1,3)]
  prtar = lapply(lapply(input_pr_intarget,fread),
                 as.data.frame)
  evatar = lapply(lapply(input_eva_intarget,fread),
                  as.data.frame)
  
  prtar = do.call('cbind',prtar)
  evatar = do.call('cbind',evatar)
  
  #prtar = apply(prtar,1,sum,na.rm =T)
  #evatar = apply(evatar,1,sum,na.rm = T)
  
  pmetar = prtar-evatar
  pmetar = pmetar[1:174,]
  
  input_tws = 'tws_in_target/'
  input_tws = list.files(input_tws,
                         full.names = T)[c(1,3)]
  
  twstar = lapply(lapply(input_tws,
                         fread),
                  as.data.frame)
  twstar = do.call('cbind',twstar)
  
  #twstar = apply(twstar,1,sum,na.rm = T)
  
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  pmedf = apply(pmedf,2,trend_fun)
  twsdf = apply(tws_in_source,2,trend_fun)
  #pmetar = trend_fun(pmetar)
  #twstar = trend_fun(twstar)
  north_pme = trend_fun(pmetar[,1])
  north_tws = trend_fun(twstar[,1])
  south_pme = trend_fun(pmetar[,2])
  south_tws = trend_fun(twstar[,2])
  
  #twsdf = twsdf[,-c(1,3,5:8)]
  pmedf = pmedf[,-c(1,3)]
  
  corpme_nor = 1
  corpme_sou = 1
  for(i in 1:ncol(pmedf)){
    tmpcor_nor = cor(pmedf[,i],north_pme)
    #tmpcor_nor = max(ccf(pmedf[,i],north_pme,
    #                     lag.max = 3)$acf)
    corpme_nor = c(corpme_nor,tmpcor_nor)
    
    tmpcor_sou = cor(pmedf[,i],south_pme)
    #tmpcor_sou = max(ccf(pmedf[,i],south_pme,
    #                     lag.max = 3)$acf)
    corpme_sou = c(corpme_sou,tmpcor_sou)
  }
  corpme_nor = corpme_nor[-1]
  corpme_sou = corpme_sou[-1]
  
  cordf1 = data.frame(
    x = c(paste0("AS",1:2),paste0('ATO',1:4),
          paste0('EU',1:3)),
    COR_PME_PME_North = corpme_nor,
    COR_PME_PME_South = corpme_sou,
    type = c(rep(3,2),rep(1,4),rep(2,3))
  )
  
  cordf1 = reshape2::melt(cordf1,c('x','type'))
  #cordf2 = reshape2::melt(cordf2,c('x','type'))
  cordf = cordf1
  
  
  pals = pal_lancet(alpha = 0.8)(9)
  
  pals = c('COR_PME_PME_North' = pals[1],
           'COR_PME_PME_South' = pals[7])
  
  pcor = ggplot()+
    geom_bar(data  = cordf,
             aes(x = x,y = value,
                 fill = variable),
             stat = 'identity',
             position = 'dodge',
             width = 0.8)+
    geom_text(data = cordf,
              aes(x = x,y = value*1.2,
                  label = round(value,2)),
              size = 4,
              position = position_dodge2(0.8),
              color = 'black')+
    scale_fill_manual(values = pals)+
    facet_wrap(~type,ncol = 1,scales = 'free')+
    theme_bw()+
    xlab('Source Regions')
  
  pcor = pcor+text_theme_set+
    theme(
      strip.text = element_blank(),
      axis.title.y = element_blank(),
      legend.position = 'none'
    )
  
  pcor = pcor+theme(
    plot.margin = unit(rep(0.1,4),'cm')
  )
  pmaps = pmaps+theme(
    plot.margin = unit(rep(0.1,4),'cm')
  )
  
  
  
  # adding (a)
  subs_df1 = data.frame(
    x = rep(-175,3),
    y = rep(80,3),
    label = c('(a)','(c)','(e)'),
    type = c(1,2,3)
  )  
  subs_df2 = data.frame(
    x = c('ATO1','EU1','AS1'),
    y = c(0.9,0.15,1.1),
    label = c('(b)','(d)','(f)'),
    type = c(1,2,3)
  ) 
  
  pmaps  = pmaps+
    geom_text(data = subs_df1,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black')
  
  pcor = pcor+
    geom_text(data = subs_df2,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black')
  
  # assemble plots
  library(cowplot)
  p12 = plot_grid(pmaps,
                  pcor,
                  rel_widths = c(3,1.5),
                  rel_heights = c(1,1),
                  nrow = 1)
  
  output = 'main_plot/SI/big_scale_pme_pme_cor/figs1.png'
  dir.create('main_plot/SI/big_scale_pme_pme_cor')
  
  p123 = ggdraw()+
    draw_plot(p12)+
    draw_plot(pmap1,x =0.05,y = 0.72 ,
              height = 0.1,width = 0.13)+
    draw_plot(pmap2,x = 0.05,y = 0.38,
              height = 0.1,width = 0.13)+
    draw_plot(pmap3,x= 0.05,y = 0.06,
              height =0.1,width = 0.13)
  
  library(ggpubr)
  pleg = as_ggplot(get_legend(pcor+
                                theme(legend.position = 'bottom')+
                                guides(fill = guide_legend(
                                  title = 'Pearson Corrleation Coefficients',
                                  title.position = 'top',
                                  nrow = 1
                                ))))
  pleg = pleg+
    theme(plot.margin = 
          unit(rep(0,4),'cm'))
  
  p123 = plot_grid(p123,
                   pleg,
                   rel_heights = c(10,1),
                   ncol =1)
  
  
  
  png(output,
      width = 25,
      height =22,
      units = 'cm',
      res = 800)
  print(p123)
  dev.off()
  
  
  
  
  
  
}
figs_cmip6_tws_pme_cor <- function(
  
){
  library(ggplot2)
  library(raster)
  input_tws = 'analysis_output/fig4/project_tws'
  input_tws = list.files(input_tws,full.names = T)
  
  tws245_mean = as.data.frame(
    fread(input_tws[2])
  )
  tws585_mean = as.data.frame(
    fread(input_tws[4])
  )
  
  colnames(tws245_mean) = c('date',
                            'variable',
                            'value')
  colnames(tws585_mean) = c('date',
                            'variable',
                            'value')
  
  tws245_mean$type = 'SSP245_TWS'
  tws585_mean$type = 'SSP585_TWS'
  
  source('/home/share/R_project/xinjiang_vapor/import_pme_ato_fig4.R')
  pmedf = import_pme_ato_fig4(F)
  
  SSP245_PME1 = pmedf$value[which(pmedf$type =='SSP245_PME1')]
  SSP245_PME3 = pmedf$value[which(pmedf$type =='SSP245_PME3')]
  SSP585_PME1 = pmedf$value[which(pmedf$type =='SSP585_PME1')]
  SSP585_PME3 = pmedf$value[which(pmedf$type =='SSP585_PME3')]
  
  df245_1 = data.frame(
    TWS = tws245_mean$value,
    PME1 = SSP245_PME1,
    type = tws245_mean$variable
  )
  df245_2 = data.frame(
    TWS = tws245_mean$value,
    PME3 = SSP245_PME3,
    type = tws245_mean$variable
  )
  
  df245_1 = reshape2::melt(df245_1,c('TWS','type'))
  df245_2 = reshape2::melt(df245_2,c('TWS','type'))
  
  df245_1$type = rep(1:10,each = 390)
  df245_2$type = rep(11:20,each = 390)
  df245 = rbind(df245_1,df245_2)
  
  retcor = cor_pme_tws_cmip6(df245)
  cordf245 = retcor[[1]]
  pdf245 = retcor[[2]]
  
  df585_1 = data.frame(
    TWS = tws585_mean$value,
    PME1 = SSP585_PME1,
    type = tws585_mean$variable
  )
  df585_2 = data.frame(
    TWS = tws585_mean$value,
    PME3 = SSP585_PME3,
    type = tws585_mean$variable
  )
  
  df585_1 = reshape2::melt(df585_1,c('TWS','type'))
  df585_2 = reshape2::melt(df585_2,c('TWS','type'))
  
  df585_1$type = rep(1:10,each = 390)
  df585_2$type = rep(11:20,each = 390)
  df585 = rbind(df585_1,df585_2)
  
  
  subsdf = data.frame(
    x = -0.25,
    y = 0.25,
    label = paste0('(',letters[1:20],')'),
    type = 1:20
  )
  
  
  
  
  p1 = ggplot()+
    geom_point(data = df245,
               aes(x = TWS,y = value,
                   color = variable),
               size = 3.25,
               shape = 1)+
    geom_point(data = df245,
               aes(x = TWS,y = value,
                   color = variable),
               size = 3,
               shape = 1)+
    geom_abline(intercept = 0,slope = 1)+
    geom_text(data = cordf245,
              aes(x = x,y =y,label = cor),
              hjust = 0,
              size = 4,
              color = 'black')+
    geom_text(data = pdf245,
              aes(x = x,y = y,label = cor),
              hjust = 0,
              size = 4,
              color = 'black')+
    geom_text(data = subsdf,
              aes(x = x,y = y,label = label),
              hjust  =0,
              size = 4,
              color = 'black')+
    facet_wrap(~type,nrow = 4)+
    ylim(-0.25,0.25)+
    xlim(-0.25,0.25)+
    theme_bw()+
    xlab("Projected TWS")+
    ylab('PME')
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  p1 = p1+text_theme_set+
    theme(legend.position = 'bottom',
          strip.text =element_blank())+
    guides(color = guide_legend(title = '',
                                nrow = 1))
  
  output = 'main_plot/SI/cor_pme_tws_fut/'
  dir.create(output)
  output1 = paste0(output,'/figs10.png')
  png(output1,
      height = 20,
      width = 25,
      units = 'cm',
      res = 800)
  print(p1)
  dev.off()
  
  
  retcor = cor_pme_tws_cmip6(df585)
  cordf585 = retcor[[1]]
  pdf585 = retcor[[2]]
  
  cordf585$y = cordf585$y-0.02
  cordf585$y = cordf585$y+0.02
  p2 = ggplot()+
    geom_point(data = df585,
               aes(x = TWS,y = value,
                   color = variable),
               size = 3.25,
               shape = 1)+
    geom_point(data = df585,
               aes(x = TWS,y = value,
                   color = variable),
               size = 3,
               shape = 1)+
    geom_abline(intercept = 0,slope = 1)+
    geom_text(data = cordf585,
              aes(x = x,y =y,label = cor),
              hjust = 0,
              size = 4,
              color = 'black')+
    geom_text(data = pdf585,
              aes(x = x,y = y,label = cor),
              hjust = 0,
              size = 4,
              color = 'black')+
    geom_text(data = subsdf,
              aes(x = x,y = y,label = label),
              hjust  =0,
              size = 4,
              color = 'black')+
    facet_wrap(~type,nrow = 4)+
    ylim(-0.25,0.25)+
    xlim(-0.25,0.25)+
    theme_bw()+
    xlab("Projected TWS")+
    ylab('PME')
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  p2 = p2+text_theme_set+
    theme(legend.position = 'bottom',
          strip.text =element_blank())+
    guides(color = guide_legend(title = '',
                                nrow = 1))
  
  output = 'main_plot/SI/cor_pme_tws_fut/'
  dir.create(output)
  output1 = paste0(output,'/figs11.png')
  png(output1,
      height = 20,
      width = 25,
      units = 'cm',
      res = 800)
  print(p2)
  dev.off()

}


figs_cor_analysis_pme_ato <- function(
  
){
  input_pme = list.files('analysis_output/cmip6_by_model/pme',
                         full.names = T)
  input_sst = list.files('analysis_output/cmip6_by_model/sst',
                         full.names = T)
  
  
  pme = lapply(lapply(input_pme,fread),as.data.frame)
  sst = lapply(lapply(input_sst,fread),as.data.frame)
  
  
  cmip6_trend_ts <- function(x){
    x = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(x)$trend
    
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    xm = (xt-mean(xt,na.rm = T))/
      (max(xt,na.rm=T)-min(xt,na.rm = T))
    return(xm)
  }
  
  type = c('ATO1_SSP245','ATO1_SSP585',
                'ATO3_SSP245','ATO3_SSP585')
  
  cor1 = 1
  p = 1
  
  dfpmeb = list()
  dfsstb = list()
  for(i in 1:4){
    pme[[i]] = apply(pme[[i]],2,cmip6_trend_ts)
    sst[[i]] = apply(sst[[i]],2,cmip6_trend_ts)
    
    pme_mean = apply(pme[[i]] ,1,mean)
    sst_mean = apply( sst[[i]],1,mean)
    
    tmp = cor.test(pme_mean,
                   sst_mean)
    cor1 = c(cor1,tmp$estimate)
    p = c(p,tmp$p.value)
    
    date = seq(as.Date('2003-01-01'),
               as.Date('2050-12-01'),
               '1 month')
    date = date[-c(1:6,571:576)]
    dfpme = data.frame(date,pme_mean)
    dfsst = data.frame(date,sst_mean)
    
    dfpme = reshape2::melt(dfpme,'date')
    dfsst = reshape2::melt(dfsst,'date')
    
    dfpme$type = type[i]
    dfsst$type = type[i]
    
    dfpmeb[[i]] = dfpme
    dfsstb[[i]] = dfsst
    
  }
  cor1 = cor1[-1]
  p = p[-1]
  
  cordf = data.frame(
    x = as.Date('2005-01-01'),
    y = -0.5,
    label = paste0("Pearson's R: ",round(cor,2)),
    type = type
  )
  
  pdf = data.frame(
    x = as.Date('2005-01-01'),
    y = -0.6,
    label = paste0("p.value: ",format(p, scientific = TRUE)),
    type = type
  )
  
  dflabel = data.frame(
    x = as.Date('2003-07-01'),
    y = 0.6,
    label = paste0('(',letters[1:4],')'),
    type = type
  )
  
  dfsstb = do.call(rbind,dfsstb)
  dfpmeb = do.call(rbind,dfpmeb)
  
  dfpmeb$variable = 'PME'
  dfsstb$variable = 'SST'
  
  cols = pal_lancet(alpha = 0.8)(9)
  cols = c("PME"=cols[1],
           "SST"= cols[2])
  
  
  pline = ggplot()+
    geom_line(data = dfpmeb,aes(x = date,y= value,
                                color = variable),
              size = 1)+
    geom_line(data = dfsstb,aes(x = date,y= value,
                                color = variable),
              size = 1)+
    scale_color_manual(values = cols)+
    facet_wrap(~type,nrow = 2)+
    theme_bw()
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  pline = pline+text_theme_set+
    theme(strip.text = element_blank())
  
  pline = pline+
    geom_text(data = dflabel,
              aes(x = x,y = y,label = label),
              size = 4,
              color= 'black')+
    guides(color = guide_legend(
      title= 'Standardized Indices',
      title.position = 'left',
      nrow = 1
    ),linetype = guide_legend(
      title= 'Standardized Indices',
      title.position = 'left',
      nrow = 1
    ))+
    xlab('Date')+
    ylab('Standardized Indices')
  
  cordf = rbind(cordf,pdf)
  
  pline =pline+
    geom_text(data = cordf,
              aes(x = x,y = y,label = label),
              color= 'black',size = 4,hjust = 0)
  
  output = 'main_plot/SI/figs_cor_cmip6_pmeato_sst/'
  dir.create(output)
  output = paste0(output,'/figs.png')
  
  png(output,
      height = 18,
      width = 26,
      units = 'cm',
      res = 800)
  print(pline)
  dev.off()
    
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
}
figs_cor_matrix_plot<-function(
  
){
  
  input_tws_subwindow = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws_subs = read.csv(input_tws_subwindow,header = T)
  tws_subs = tws_subs[,-1]
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  tws_subs = tws_subs[,id_box]
  
  naid= which(is.na(tws_subs[,1]))
  tws_subs = tws_subs[-naid,]
  colnames(tws_subs) = paste0('SW',1:10)
  
  input_tws = 'tws_in_target/'
  input_tws = list.files(input_tws,
                         full.names = T)[c(1,3)]
  
  twsxj = do.call('cbind',lapply(
    lapply(input_tws,fread),as.data.frame
  ))
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  twsxj = apply(twsxj,2,trend_fun)
  colnames(twsxj) = c('North_XJ','South_XJ')
  
  twsdf = data.frame(
    tws_subs,
    twsxj
  )
  

  library(ggcor)
  library(vegan)
  library(dplyr)
  
  cordf = fortify_cor(tws_subs,type = 'upper',
                      show.diag = TRUE,
                      cor.test = T,
                      cluster_type = "all")
  
  
  cor_analze_xj_window <- function(xj,tws_subs,mode = 'North_XJ'){
    cor = 1
    p = 1
    for(i in 1:ncol(tws_subs)){
      tes = cor.test(tws_subs[,i],xj)
      cor = c(cor,tes$estimate)
      p = c(p,tes$p.value)
    }
    cor = cor[-1]
    p = p[-1]
    
    cols= colnames(tws_subs)
    ret = data.frame(
      spec = mode,
      env = cols,
      r = cor,
      p = p
    )
    return(ret)
  }
  
  ret1 = cor_analze_xj_window(twsxj[,1],tws_subs,
                              mode = 'North_XJ')
  ret2 = cor_analze_xj_window(twsxj[,2],tws_subs,
                              mode = 'South_XJ')
  

  mantel = rbind(ret1,ret2)
  mantel = mantel %>%
    mutate(r = cut(r, breaks = c(-Inf, 0.25, 0.5, 0.75,1),
                   labels = c("<0.25", "0.25-0.5", "0.5-0.75",
                              "0.75-1"),
                   right = FALSE),
           p.value = cut(p, breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
                         labels = c("<0.001", "0.001-0.01", "0.01-0.05", ">=0.05"),
                         right = FALSE))
  ps = data.frame(
    x = cordf$.row.names[which(cordf$r!=1)],
    y = cordf$.col.names[which(cordf$r!=1)],
    pvalue=cordf$p.value[which(cordf$r!=1)]
  )
  ps$pvalue = cut(ps$pvalue,
                    breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
                    labels = c("***", "**", "*", "x"),
                    right = FALSE)
  
  
  p1<-quickcor(tws_subs, type = "upper",
               fixed.xy = F) + 
    geom_square(inherit.aes = T,
                aes(fill = cut(r,
                               breaks = seq(0,1,0.1))))+
    anno_link(mantel, 
              mapping = aes(color = r,
                            size = r)) +
    scale_size_manual(values = c(1.5, 3)) +
    geom_diag_label(angle = 0,geom = "text", 
                    remove.axis = TRUE)
  p1
  
  
  p2<-p1+scale_fill_brewer(palette = 'Spectral',
                           direction = -1)
    
  pals = pal_lancet(alpha = 0.8)(9)[c(1,7)]
  #自定义连线
  p3<-p2+scale_color_manual(values=pals)
  p3
  #定义图例标题
  p3 = p3+guides(
            size=guide_legend(title="Pearson's R XJ~Subs",
                              override.aes = list(size=3),
                              order=1,title.position = 'top'),
            colour=guide_legend(title="Pearson's R XJ~Subs",
                                override.aes = list(size=3),
                                order=1,title.position = 'top'),
            fill=guide_legend(title="Pearson's R TWS",order=3,
                              title.position = 'top'))

  ######
  
  p4 = figs_covar_twsxj_twssubs()
  #p4 =p4+coord_fixed(1.5)
  p4 = p4+theme(
    #plot.margin = unit(rep(0.1,4),'cm'),
    legend.position = 'bottom',
    legend.background = element_rect(fill = 'transparent',
                                     color= 'transparent')
  )
  
  p4 = p4+
    xlab('Date')+
    ylab("Standardized Indices")+
    theme(axis.title.x = element_blank())
  
  p4 = p4+
    guides(color = guide_legend(
      title.position = 'top',
      title = 'Standardized Indices',
      nrow= 3
    ),
    linetype =guide_legend(
      title.position = 'top',
      title = 'Standardized Indices',
      nrow = 3
    ) )
  p4leg = as_ggplot(get_legend(p4))
  
  p4leg = p4leg+theme(plot.margin = unit(rep(0.2,4),'cm'))
  p4 = p4+theme(legend.position = 'none')
  
  
  p3 = p3+theme(
    #plot.margin = unit(rep(0.1,4),'cm'),
    legend.position = 'bottom',
    legend.background = element_rect(fill = 'transparent',
                                     color= 'transparent')
  )
  
  p3leg = as_ggplot(get_legend(p3))
  p3leg = p3leg+theme(plot.margin = unit(rep(0.2,4),'cm'))
  p3 = p3+theme(legend.position = 'none')
  

  
  p34 = plot_grid(
    p3,p4,
    nrow = 1,
    rel_widths = c(1,1.2),
    rel_heights = c(1,1)
    #align = 'tb',
   # axis = 'h'
    
  )
  
  p34leg = plot_grid(
    p3leg,p4leg,nrow = 1
  )
  
  
  p34l = plot_grid(
    p34,
    p3leg,
    ncol = 1,
    rel_heights = c(11,1),
    align = 'none',
    axis = 'none'
  )
  
  
  p34l2 = ggdraw()+
    draw_plot(p34l)+
    draw_plot(p4leg,x = 0.7,y = 0.15,
              width = 0.3,height = 0.2)
  
  output = 'main_plot/SI/explore_cor_xj_subs'
  dir.create(output)
  output = paste0(output,'/cor_xj_subs3.png')
  png(output,
      height = 19,
      width = 26,
      units = 'cm',
      res = 800)
  print(p34l2)
  dev.off()
  
}
figs_covar_pme13_tws_cmip6_his <- function(
  
){
  # import pme1234 
  input_sst = list.files('analysis_output/cmip6_by_model/sst',
                         full.names = T)
  input_pme = list.files('analysis_output/cmip6_by_model/pme',
                         full.names = T)
  
  sst = lapply(lapply(input_sst,fread),as.data.frame)
  pme = lapply(lapply(input_pme,fread),as.data.frame)
  
  sst_trend = sst
  pme_trend = pme
  #sst_trend = lapply(sst,trend_fun)
  #pme_trend = lapply(pme,trend_fun)
  
  sst1_ssp245 = sst_trend[[1]]
  sst1_ssp585 = sst_trend[[2]]
  sst3_ssp245 = sst_trend[[3]]
  sst3_ssp585 = sst_trend[[4]]
  
  pme1_ssp245 = pme_trend[[1]]
  pme1_ssp585 = pme_trend[[2]]
  pme3_ssp245 = pme_trend[[3]]
  pme3_ssp585 = pme_trend[[4]]
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(sst1_ssp245) = modelnames
  colnames(sst1_ssp585) = modelnames
  colnames(sst3_ssp245) = modelnames
  colnames(sst3_ssp585) = modelnames
  
  colnames(pme1_ssp245) = modelnames
  colnames(pme1_ssp585) = modelnames
  colnames(pme3_ssp245) = modelnames
  colnames(pme3_ssp585) = modelnames
  
  sst1_ssp245 <<- sst1_ssp245
  sst1_ssp585 <<- sst1_ssp585
  sst3_ssp245 <<- sst3_ssp245
  sst3_ssp585 <<- sst3_ssp585
  
  pme1_sst245 <<- pme1_ssp245
  pme3_ssp245 <<- pme3_ssp245
  pme1_ssp585 <<- pme1_ssp585
  pme3_ssp585 <<- pme3_ssp585
  
  pme1_pj245 = as.matrix(pme1_ssp245[1:174,])
  pme3_pj245 = as.matrix(pme3_ssp245[1:174,])
  pme1_pj585 = as.matrix(pme1_ssp585[1:174,])
  pme3_pj585 = as.matrix(pme3_ssp585[1:174,])
  source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
  pme1_pj245 = trend_fun(pme1_pj245)
  pme3_pj245 = trend_fun(pme3_pj245)
  
  naid = which(is.na(pme3_pj245[,1]))
  pme3_pj245 = pme3_pj245[-naid,]
  pme1_pj245 = pme1_pj245[-naid,]
  
  pme1_pj585 = trend_fun(pme1_pj585)
  pme3_pj585 = trend_fun(pme3_pj585)
  
  naid = which(is.na(pme3_pj585[,1]))
  pme3_pj585 = pme3_pj585[-naid,]
  pme1_pj585 = pme1_pj585[-naid,]
  
  pme1_pj245 = apply(pme1_pj245,1,mean)
  pme3_pj245 = apply(pme3_pj245,1,mean)
  pme1_pj585 = apply(pme1_pj585,1,mean)
  pme3_pj585 = apply(pme3_pj585,1,mean)
  
  pmedf = data.frame(
    PME_ATO1_SSP245 = pme1_pj245,
    PME_ATO1_SSP585 = pme1_pj585,
    PME_ATO3_SSP245 = pme3_pj245,
    PME_ATO3_SSP585 = pme3_pj585
  )
  
  subs_tws = as.data.frame(fread('analysis_output/tws_subwindow_2003_2017.csv'))
  subs_tws = subs_tws[,-1]
  
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  subs_tws = subs_tws[,id_box]
  subs_tws = subs_tws[-naid,]
  colnames(subs_tws) = paste0('HSW',1:10)
  
  cor2 = data.frame(cor1 =NA,type = '1')
  p2 = data.frame(p1 =NA,type = '1')
  for(i in 1:ncol(subs_tws)){
    cor1 = 1
    p1 = 1
    for(j in 1:ncol(pmedf)){
      cort = cor.test(subs_tws[,i],pmedf[,j])
      tmpcor = round(cort$estimate,2)
      p = cort$p.value
      
      p1 = c(p1,p)
      cor1 = c(cor1,tmpcor)
    }
    cor1 = cor1[-1]
    p1 = p1[-1]
    
    cor1 = data.frame(cor1,type = paste0('HSW',i))
    p1 = data.frame(p1,type = paste0('HSW',i))
    
    cor2 = rbind(cor2,cor1)
    p2 = rbind(p2,p1)
  }
  cor2 = cor2[-1,]
  p2 = p2[-1,]
  
  date = seq(as.Date('2003-01-01'),as.Date('2017-12-01'),'1 month')
  date = date[1:174]
  date = date[-naid]
  
  pmedf$date = date
  pmedf = reshape2::melt(pmedf,'date')
  
  subs_tws$date= date
  subs_tws = reshape2::melt(subs_tws,'date')
  
  subs_tws$type = subs_tws$variable
  subs_tws$col = 'TWS'
  pmedf$col = pmedf$variable
  
  pals = pal_lancet(alpha = 0.8)(9)
  pals = colorRampPalette(pals)(20)[c(6:9,16)]
  
  p2$label = 'p>0.05'
  p2$label[which(p2$p1<0.05)] = 'p<0.05'
  
  corpdf = data.frame(
    x = as.Date(date[3]),
    y = rep(c(-0.3,-0.4,-0.5,-0.6),10),
    label = paste0('R: ',cor2$cor1,' ',p2$label),
    col = rep(as.character(unique(pmedf$col)),10),
    type = cor2$type
  )
  labeldf = data.frame(
    x = as.Date(date[3]),
    y = 0.6,
    label = paste0('(',letters[1:10],')'),
    type = paste0('HSW',1:10)
  )
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  p = ggplot()+
    geom_line(data = subs_tws,aes(x = date,y =value,color = col),
              size = 1.2)+
    geom_line(data = pmedf,aes(x = date,y =value,color = col),
              size = 1.2)+
    geom_text(data = corpdf,aes(x = x,y=y,label=label,color = col),
              size = 4.5,hjust = 0)+
    geom_text(data = labeldf,aes(x = x,y = y,label = label),color = 'black',
              size = 4.5,hjust = 0)+
    scale_color_manual(values = pals)+
    facet_wrap(~type,nrow = 2)+
    guides(color = guide_legend(title = 'Normalized indices',
                               title.position = 'top'))+
    theme_bw()+
    xlab('Time (month)')+
    ylab('Normalized indices')+text_theme_set
    
  dir.create('main_plot/SI/cor_covar_anlysis_pme13_twssubs')
  output = 'main_plot/SI/cor_covar_anlysis_pme13_twssubs/figs2.png'
  png(output,
      height = 20,
      width = 30,
      units = 'cm',
      res = 800)
  print(p)
  dev.off()
    
  
  
  
  
  
}
figs_covar_sst_pme1234_cmip6 <- function(
  
){
  input_sst = list.files('analysis_output/cmip6_by_model/sst',
                         full.names = T)
  input_pme = list.files('analysis_output/cmip6_by_model/pme',
                         full.names = T)
  
  
  
  sst = lapply(lapply(input_sst,fread),as.data.frame)
  pme = lapply(lapply(input_pme,fread),as.data.frame)
  
  sst_trend = sst
  pme_trend = pme
  #sst_trend = lapply(sst,trend_fun)
  #pme_trend = lapply(pme,trend_fun)
  
  sst1_ssp245 = sst_trend[[1]]
  sst1_ssp585 = sst_trend[[2]]
  sst3_ssp245 = sst_trend[[3]]
  sst3_ssp585 = sst_trend[[4]]
  
  pme1_ssp245 = pme_trend[[1]]
  pme1_ssp585 = pme_trend[[2]]
  pme3_ssp245 = pme_trend[[3]]
  pme3_ssp585 = pme_trend[[4]]
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(sst1_ssp245) = modelnames
  colnames(sst1_ssp585) = modelnames
  colnames(sst3_ssp245) = modelnames
  colnames(sst3_ssp585) = modelnames
  
  colnames(pme1_ssp245) = modelnames
  colnames(pme1_ssp585) = modelnames
  colnames(pme3_ssp245) = modelnames
  colnames(pme3_ssp585) = modelnames
  
  sst1_ssp245 <<- sst1_ssp245
  sst1_ssp585 <<- sst1_ssp585
  sst3_ssp245 <<- sst3_ssp245
  sst3_ssp585 <<- sst3_ssp585
  
  pme1_sst245 <<- pme1_ssp245
  pme3_ssp245 <<- pme3_ssp245
  pme1_ssp585 <<- pme1_ssp585
  pme3_ssp585 <<- pme3_ssp585
  
  pme1_pj245 = as.matrix(pme1_ssp245[175:576,])
  pme3_pj245 = as.matrix(pme3_ssp245[175:576,])
  
  source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
  pme1_pj245 = trend_fun(pme1_pj245)
  pme3_pj245 = trend_fun(pme3_pj245)
  
  naid = which(is.na(pme3_pj245[,1]))
  pme3_pj245 = pme3_pj245[-naid,]
  pme1_pj245 = pme1_pj245[-naid,]
  
  pme1_pj585 = as.matrix(pme1_ssp585[175:576,])
  pme3_pj585 = as.matrix(pme3_ssp585[175:576,])
  
  source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
  pme1_pj585 = trend_fun(pme1_pj585)
  pme3_pj585 = trend_fun(pme3_pj585)
  
  naid = which(is.na(pme3_pj585[,1]))
  pme3_pj585 = pme3_pj585[-naid,]
  pme1_pj585 = pme1_pj585[-naid,]
  
  
  pme1_mean245 = apply(pme1_pj245,1,mean)
  pme3_mean245 = apply(pme3_pj245,1,mean)
  pme1_mean585 = apply(pme1_pj585,1,mean)
  pme3_mean585 = apply(pme3_pj585,1,mean)
  sst1_pj245 = as.matrix(sst1_ssp245[175:576,])
  sst3_pj245 = as.matrix(sst3_ssp245[175:576,])
  
  source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
  sst1_pj245 = trend_fun(sst1_pj245)
  sst3_pj245 = trend_fun(sst3_pj245)
  
  naid = which(is.na(sst3_pj245[,1]))
  sst3_pj245 = sst3_pj245[-naid,]
  sst1_pj245 = sst1_pj245[-naid,]
  
  sst1_pj585 = as.matrix(sst1_ssp585[175:576,])
  sst3_pj585 = as.matrix(sst3_ssp585[175:576,])
  
  source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
  sst1_pj585 = trend_fun(sst1_pj585)
  sst3_pj585 = trend_fun(sst3_pj585)
  
  naid = which(is.na(sst3_pj585[,1]))
  sst3_pj585 = sst3_pj585[-naid,]
  sst1_pj585 = sst1_pj585[-naid,]
  
  
  sst1_mean245 = apply(sst1_pj245,1,mean)
  sst3_mean245 = apply(sst3_pj245,1,mean)
  sst1_mean585 = apply(sst1_pj585,1,mean)
  sst3_mean585 = apply(sst3_pj585,1,mean)
  
  pmedf = data.frame(
    pme1_mean245,pme1_mean585,
    pme3_mean245,pme3_mean585
  )
  sstdf = data.frame(
    sst1_mean245,sst1_mean585,
    sst3_mean245,sst3_mean585
  )
  
  cors = 1
  ps = 1
  for(i in 1:ncol(pmedf)){
    cor = cor.test(pmedf[,i],sstdf[,i])
    p = cor$p.value
    cor = cor$estimate
    cors = c(cors,cor)
    ps  =c(ps,p)
  }
  cors = cors[-1]
  ps = ps[-1]
  
  
  date = seq(as.Date('2018-01-01'),as.Date('2050-12-01'),'1 month')
  date = date[-naid]
  
  pmedf1 = data.frame(date,pmedf)
  sstdf1 = data.frame(date,sstdf)
  
  pmedf1 = reshape2::melt(pmedf1,'date')
  sstdf1 = reshape2::melt(sstdf1,'date')
  
  pmedf1$col = 'PME'
  sstdf1$col = 'SST'
  pmedf1$type = rep(c('ATO1-SSP245','ATO1-SSP585','ATO3-SSP245','ATO3-SSP585'),each = 390)
  sstdf1$type = pmedf1$type
  
  pal1 = pal_lancet(alpha = 0.8)(9)[c(1,7)]
  
  cordf = data.frame(
    x = as.Date('2019-01-01'),
    y = -0.5,
    label = paste0('Pearson R: ',round(cors,2)),
    type = c('ATO1-SSP245','ATO1-SSP585','ATO3-SSP245','ATO3-SSP585')
  )
  
  pdf = data.frame(
    x = as.Date('2019-01-01'),
    y = -0.6,
    label = paste0('p.value: ',format(ps,2)),
    type =c('ATO1-SSP245','ATO1-SSP585','ATO3-SSP245','ATO3-SSP585')
  )
  
  labdf = data.frame(
    x = as.Date('2019-01-01'),
    y = 0.6,
    label = paste0('(',letters[1:4],')'),
    type = c('ATO1-SSP245','ATO1-SSP585','ATO3-SSP245','ATO3-SSP585')
  )
  
  
  p = ggplot()+
    geom_line(data = pmedf1,aes(x =date,y = value, color = col),
              size = 1.5)+
    geom_line(data = sstdf1,aes(x = date,y = value,color = col),
              size = 1.5)+
    geom_text(data = cordf,aes(x = x,y = y,label = label),
              color = 'black',size = 4,hjust = 0)+
    geom_text(data = pdf,aes(x = x,y = y,label = label),
              color = 'black',size = 4,hjust = 0)+
    geom_text(data = labdf,aes(x = x,y = y,label = label),
              color = 'black',size = 4)+
    scale_color_manual(values = pal1)+
    facet_wrap(~type,nrow = 2)+
    theme_bw()
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  p = p + text_theme_set+
    theme(legend.title = element_blank())+
    xlab('Time (month)')+
    ylab('Normalized indices')
  
  output = 'main_plot/SI/figs_cor_cmip6_pmeato_sst/'
  dir.create(output)
  output = paste0(output,'/figs3.png')
  
  png(output,
      height = 24,
      width = 26,
      units = 'cm',
      res = 800)
  print(p)
  dev.off()
  
  
}
figs_covar_sst_pme1234 <- function(
  
){
  # cor plot 
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pe_in_source = pe_in_source * 30.5
  
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  pe_minus_eva = pe_in_source - pet_sum
  colnames(pe_minus_eva) = paste0('PME',1:12)
  pmedf = pe_minus_eva[,1:11]
  
  pmedf = pmedf[,c(5:8)]
  pmedf$PME13 = pmedf[,1]+pmedf[,3]
  pmedf$PME24 = pmedf[,2]+pmedf[,4]
  
  colnames(pmedf) = c(paste0("ATO",1:4),'ATO13','ATO24')
  
  input_sst = list.files('era5_sst_mean/ato/',
                         full.names = T)
  input_sst = lapply(input_sst,list.files,full.names = T)
  
  sst = lapply(lapply(input_sst,fread),as.data.frame)
  sst = do.call(cbind,sst)[1:174,]
  sst$SST13 = (sst[,1]+sst[,3])/2
  sst$SST24 = (sst[,2]+sst[,4])/2
  

  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  pmedf = apply(pmedf,2,trend_fun)
  sstdf = apply(sst,2,trend_fun)
  colnames(sstdf) = c(paste0("ATO",1:4),'ATO13','ATO24')
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),'1 month')[1:174]
  date = date[-c(1:6,169:174)]
  
  dfsst = data.frame(date = date,
                     sstdf)
  dfpme = data.frame(date = date,
                     pmedf)
  
  dfsst = reshape2::melt(dfsst,'date')
  dfpme = reshape2::melt(dfpme,'date')
  
  dfsst$type = dfsst$variable
  dfpme$type = dfpme$variable
  
  dfsst$variable = 'SST'
  dfpme$variable = 'PME'
  
  cols = pal_lancet(alpha = 0.8)(10)
  cols = c('PME'= cols[1],
           'SST' = cols[7])
  
  
  pline =ggplot()+
    geom_line(data = dfsst,
              aes(x = date,y = value,
                  color = variable,
                  linetype = variable),
              size = 1)+
    geom_line(data = dfpme,
              aes(x = date,y = value,
                  color = variable,
                  linetype = variable),
              size = 1)+
    scale_color_manual(values = cols)+
    facet_wrap(~type,nrow = 2)+
    theme_bw()
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  pline = pline+text_theme_set+
    theme(strip.text = element_blank())
  
  dflabel = data.frame(
    x = as.Date('2003-07-01'),
    y = 0.6,
    label = paste0('(',letters[3:8],')'),
    type = c(paste0('ATO',1:4),'ATO13','ATO24')
  )
  
  pline = pline+
    geom_text(data = dflabel,
              aes(x = x,y = y,label = label),
              size = 4,
              color= 'black')+
    guides(color = guide_legend(
      title= 'Standardized Indices',
      title.position = 'top',
      nrow = 3
    ),linetype = guide_legend(
      title= 'Standardized Indices',
      title.position = 'top',
      nrow = 3
    ))+
    xlab('Date')+
    ylab('Standardized Indices')
  
  
  cor = 1
  p = 1
  pmedf = as.data.frame(pmedf)
  sstdf = as.data.frame(sstdf)
  for(i in 1:ncol(pmedf)){
    tmp1 = cor.test(pmedf[,i],
                    sstdf[,i])
    
    p = c(p,tmp1$p.value)
    tmp1 = max(ccf(pmedf[,i],sstdf[,i])$acf)
    
    cor = c(cor,tmp1)
    
  }
  cor = cor[-1]
  p = p [-1]
  
  cordf = data.frame(
    x = as.Date('2005-01-01'),
    y = -0.5,
    label = paste0("Cross Pearson's correlation: ",round(cor,2)),
    type = c(paste0('ATO',1:4),'ATO13','ATO24')
  )
  
  pdf = data.frame(
    x = as.Date('2005-01-01'),
    y = -0.6,
    label = paste0("p.value: ",format(p, scientific = TRUE)),
    type = c(paste0('ATO',1:4),'ATO13','ATO24')
  )
  
  cordf = rbind(cordf,pdf)
  
  pline =pline+
    geom_text(data = cordf,
              aes(x = x,y = y,label = label),
              color= 'black',size = 4,hjust = 0)
  
  
  
  pmap = figs_sst_mmk()
  
  mapleg = as_ggplot(get_legend(pmap))
  mapleg = mapleg+theme(
    plot.margin = unit(rep(0,4),'cm')
  )
  lleg = as_ggplot(get_legend(pline+
                                theme(legend.position = 'bottom')))
  lleg = lleg+theme(
    plot.margin = unit(rep(0,4),'cm')
  )
  
  pmap = pmap+theme(legend.position = 'none',
                    axis.text.y = element_text(
                      angle = 90,hjust = 0.5
                    ),
                    axis.title.x = element_blank())+
    ylab('Latitude')
  pline = pline+theme(legend.position = 'none',
                      axis.text.y = element_text(
                        angle = 90,hjust = 0.5
                      ))
  
  pcoms = plot_grid(
    pmap,pline,
    ncol = 1,
    rel_heights = c(1,1.5),
    align = 'lr',
    axis = 'h'
  )
  
  legs = plot_grid(
    mapleg,lleg,nrow = 1,
    align = 't'
  )
  
  pcoms = plot_grid(pcoms,legs,ncol = 1,
                    rel_heights = c(10,1),
                    align = 'r')
  output = 'main_plot/SI/figs_cor_era5_pmeato_sst/'
  dir.create(output)
  output = paste0(output,'/figs2.png')
  
  png(output,
      height = 24,
      width = 26,
      units = 'cm',
      res = 800)
  print(pcoms)
  dev.off()
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
}



















figs_covar_twssubs_pme24 <- function(
  
){
  input_tws_subwindow = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws_subs = read.csv(input_tws_subwindow,header = T)
  tws_subs = tws_subs[,-1]
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  tws_subs = tws_subs[,id_box]
  
  naid= which(is.na(tws_subs[,1]))
  tws_subs = tws_subs[-naid,]
  colnames(tws_subs) = paste0('SW',1:10)
  
  # cor plot 
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pe_in_source = pe_in_source * 30.5
  
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  pe_minus_eva = pe_in_source - pet_sum
  colnames(pe_minus_eva) = paste0('PME',1:12)
  pmedf = pe_minus_eva[,1:11]
  
  pmedf = pmedf[,c(6,8)]
  
  colnames(pmedf) = paste0('PME_ATO',c(2,4))
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  pmedf = apply(pmedf,2,trend_fun)
 
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),'1 month')[1:174]
  date = date[-c(1:6,169:174)]
  
  dfsubs = data.frame(date = date,
                      tws_subs)
  dfpme = data.frame(date = date,
                     pmedf)
  
  dfsubs = reshape2::melt(dfsubs,'date')
  dfpme = reshape2::melt(dfpme,'date')
  
  dfsubs$type = dfsubs$variable
  dfsubs$variable = 'TWS_SWs'
  
  
  cols = pal_lancet(alpha = 0.8)(10)
  cols = c('PME_ATO2'= cols[1],
           'PME_ATO4' = cols[4],
           'TWS_SWs' = cols[7])
  
  
  pline =ggplot()+
    geom_line(data = dfsubs,
              aes(x = date,y = value,
                  color = variable,
                  linetype = variable))+
    geom_line(data = dfpme,
              aes(x = date,y = value,
                  color = variable,
                  linetype = variable))+
    scale_color_manual(values = cols)+
    facet_wrap(~type,nrow = 2)+
    theme_bw()
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  pline = pline+text_theme_set+
    theme(strip.text = element_blank())
  
  dflabel = data.frame(
    x = as.Date('2005-01-01'),
    y = -0.6,
    label = paste0('(',letters[1:10],')'),
    type = paste0('SW',1:10)
  )
  
  pline = pline+
    geom_text(data = dflabel,
              aes(x = x,y = y,label = label),
              size = 4,
              color= 'black')+
    guides(color = guide_legend(
      title= 'Standardized Indices',
      title.position = 'top',
      nrow = 1
    ),linetype = guide_legend(
      title= 'Standardized Indices',
      title.position = 'top',
      nrow = 1
    ))+
    xlab('Date')+
    ylab('Standardized Indices')
  
  
  cor_analze_pme_window <- function(xj,tws_subs,mode = 'North_XJ'){
    cor = 1
    p = 1
    for(i in 1:ncol(tws_subs)){
      tes = max(ccf(tws_subs[,i],xj)$acf)
      cor = c(cor,tes)
    }
    cor = cor[-1]
    p = p[-1]
    
    cols= colnames(tws_subs)
    ret = data.frame(
      variable = mode,
      type = cols,
      r = cor
    )
    return(ret)
  }
  
  
  cor1 = cor_analze_pme_window(pmedf[,1],
                               tws_subs,
                               mode = 'PME_ATO2')
  
  cor2 = cor_analze_pme_window(pmedf[,2],
                               tws_subs,
                               mode = 'PME_ATO4')
  
  cor1$y = 0.6
  cor2$y = 0.5
  cordf = rbind(cor1,cor2)
  
  cordf$label = paste0('Cross PR: ',
                       round(cordf$r,2))
  
  cordf$x = as.Date('2009-03-01')
  
  pline =pline+
    geom_text(data = cordf,
              aes(x = x,y = y,label = label,
                  color  =variable),size = 4,hjust = 0)
  

  
  output = 'main_plot/SI/figs_covar_pme24/'
  dir.create(output)
  output = paste0(output,'/figs.png')
  
  png(output,
      height = 18,
      width = 26,
      units = 'cm',
      res = 800)
  print(pline)
  dev.off()
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
   
}



















figs_covar_twsxj_twssubs <-function(
  
){
  
  input_tws_subwindow = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws_subs = read.csv(input_tws_subwindow,header = T)
  tws_subs = tws_subs[,-1]
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  tws_subs = tws_subs[,id_box]
  
  naid= which(is.na(tws_subs[,1]))
  tws_subs = tws_subs[-naid,]
  colnames(tws_subs) = paste0('SW',1:10)
  
  input_tws = 'tws_in_target/'
  input_tws = list.files(input_tws,
                         full.names = T)[c(1,3)]
  
  twsxj = do.call('cbind',lapply(
    lapply(input_tws,fread),as.data.frame
  ))
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  twsxj = apply(twsxj,2,trend_fun)
  colnames(twsxj) = c('TWS_North_XJ','TWS_South_XJ')
  
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),'1 month')[1:174]
  date = date[-c(1:6,169:174)]
  
  dfsubs = data.frame(date = date,
                      tws_subs)
  dfxj = data.frame(
    date = date,
    twsxj
  )
  
  dfsubs = reshape2::melt(dfsubs,'date')
  dfxj = reshape2::melt(dfxj,'date')
  
  dfsubs$type = factor(dfsubs$variable,
                       levels = paste0('SW',1:10))
  dfsubs$variable = 'TWS_SWs'
  
  cols = pal_lancet(alpha = 0.8)(9)
  
  cols = c('TWS_SWs' = cols[7],
           'TWS_North_XJ' = cols[1],
           'TWS_South_XJ' = cols[4])
  
  cor_analze_xj_window <- function(xj,tws_subs,mode = 'North_XJ'){
    cor = 1
    p = 1
    for(i in 1:ncol(tws_subs)){
      tes = cor.test(tws_subs[,i],xj)
      cor = c(cor,tes$estimate)
      p = c(p,tes$p.value)
    }
    cor = cor[-1]
    p = p[-1]
    
    cols= colnames(tws_subs)
    ret = data.frame(
      spec = mode,
      env = cols,
      r = cor,
      p = p
    )
    return(ret)
  }
  
  ret1 = cor_analze_xj_window(twsxj[,1],tws_subs,
                              mode = 'TWS_North_XJ')
  ret2 = cor_analze_xj_window(twsxj[,2],tws_subs,
                              mode = 'TWS_South_XJ')
  
  ret1$y = 0.6
  ret2$y = 0.4
  cordf = rbind(ret1,ret2)
  cordf$x = as.Date('2010-01-01')
  
  cordf$label = paste0("R: ",
                       round(cordf$r,2))
  
  cordf$type = cordf$env
  cordf$variable = cordf$spec
 
  pcovar = ggplot()+
    geom_line(data = dfsubs,
              aes(x = date,y= value,
                  color = variable,
                  linetype = variable),
              size = 1)+
    geom_line(data = dfxj,
              aes(x = date,y= value,
                  color = variable,
                  linetype = variable),
              size = 1)+
    geom_text(data = cordf,
              aes(x=x,y = y,label = label,
                  color = variable),
              size = 4,hjust = 0)+
    scale_color_manual(values = cols)+
    facet_wrap(~type,nrow = 3)+
    theme_bw()
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  pcovar = pcovar+text_theme_set
  
  
  subsdf = data.frame(
    x = as.Date('2005-01-01'),
    y = -0.45,
    label = paste0('(',letters[2:11],')'),
    type = paste0('SW',1:10)
  )
  
  pcovar = pcovar+
    geom_text(data = subsdf,
              aes(x=x,y = y,label = label),
              color = 'black',
              size = 4,hjust = 0)
  
  return(pcovar)
  
  
  
  
  
  
  
}
figs_generate_sub_windows <- function(
  
  ){
    # maps of subwindows 
    # cor analysis 
    input = paste0('sub_windows/sub_window',1:19,'.shp')
    shp = lapply(input,shapefile)
    
    world = shp_management('world')
    world = crop(world,extent(-180,180,0,90))
    
    pe_in_source = import_pe_in_source('era5_pr_sum',
                                       name = 'era5_pr_sum.csv')
    pe_in_source = pe_in_source[1:174,]
    pe_in_source = pe_in_source * 30.5
    
    pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
    pet_sum = pet_sum[1:174,]
    pe_minus_eva = pe_in_source - pet_sum
    colnames(pe_minus_eva) = paste0('pme',1:12)
    pmedf = pe_minus_eva[,5:8]
    
    trend_fun<-function(x){
      xs = ts(x,start = c(2003,1),frequency = 12)
      xt = decompose(xs)$trend
      naid = which(is.na(xt))
      xt = xt[-naid]
      
      stand_fun <- function(xt){
        xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                        min(xt,na.rm = T))
        return(xm)
      }
      xm = stand_fun(xt)
      return(xm)
    }
    
    pmedf = apply(pmedf,2,trend_fun)
    
    
    input_tws_subwindow = 'analysis_output/tws_subwindow_2003_2017.csv'
    tws_subs = read.csv(input_tws_subwindow,header = T)
    tws_subs = tws_subs[,-1]
    
    colnames(tws_subs) = paste0('subwindow',1:ncol(tws_subs))
    naid = which(is.na(tws_subs[,1]))
    tws_subs = tws_subs[-naid,]
    
    cor1 = 1
    cor2 = 1
    cor3 = 1
    cor4 = 1
    lag1 = 1
    lag2 = 1
    lag3 = 1
    lag4 = 1
    for(i in 1:ncol(tws_subs)){
      #tmpcor1 = cor(pmedf[,1],tws_subs[,i])
      #tmpcor2 = cor(pmedf[,2],tws_subs[,i])
      #tmpcor3 = cor(pmedf[,3],tws_subs[,i])
      #tmpcor4 = cor(pmedf[,4],tws_subs[,i])
      
      tmpcor1 = ccf(pmedf[,1],tws_subs[,i])
      tmpcor2 = ccf(pmedf[,2],tws_subs[,i])
      tmpcor3 = ccf(pmedf[,3],tws_subs[,i])
      tmpcor4 = ccf(pmedf[,4],tws_subs[,i])
      
      tmplag1 = tmpcor1$lag
      tmplag2 = tmpcor2$lag
      tmplag3 = tmpcor3$lag
      tmplag4 = tmpcor4$lag
      
      maxcor1 = max(tmpcor1$acf)
      maxcor2 = max(tmpcor2$acf)
      maxcor3 = max(tmpcor3$acf)
      maxcor4 = max(tmpcor4$acf)
      
      id1 = which.max(tmpcor1$acf)
      id2 = which.max(tmpcor2$acf)
      id3 = which.max(tmpcor3$acf)
      id4 = which.max(tmpcor4$acf)
      
      
      tmplag1 = tmplag1[id1]
      tmplag2 = tmplag2[id2]
      tmplag3 = tmplag3[id3]
      tmplag4 = tmplag4[id4]
      
      if(maxcor3>0.4){
        print(i)
      }
      cor1 = c(cor1,maxcor1)
      cor2 = c(cor2,maxcor2)
      cor3 = c(cor3,maxcor3)
      cor4 = c(cor4,maxcor4)
      
      
      lag1 = c(lag1,tmplag1)
      lag2 = c(lag2,tmplag2)
      lag3 = c(lag3,tmplag3)
      lag4 = c(lag4,tmplag4)
      
    }
    cor1 = cor1[-1]
    cor2 = cor2[-1]
    cor3 = cor3[-1]
    cor4 = cor4[-1]
    lag1 = lag1[-1]
    lag2 = lag2[-1]
    lag3 = lag3[-1]
    lag4 = lag4[-1]
    
    id_box = c(4,7,8,9,10,11,13,14,17,19)
    shphigh = do.call(bind,shp[id_box])
    shplow = do.call(bind,shp[-id_box])
    
    
    atoshp = list.files('cluster_shp/ato',
                        full.names = T,
                        pattern = '*.shp$')[1:4]
    atoshp = lapply(atoshp,shapefile)
    cal_center_point <- function(x){
      xm = extent(x)
      latm = round((xm[3]+xm[4])/2)
      longm = round((xm[1]+xm[2])/2)
      rm = data.frame(x = longm,y = latm)
      return(rm)
    }
    
    dfhigh_label = lapply(shp[id_box],cal_center_point)
    dflow_label = lapply(shp[-id_box],cal_center_point)
    dfato_label = lapply(atoshp,cal_center_point)
    
    
    dfhigh_label = do.call(rbind,dfhigh_label)
    dflow_label = do.call(rbind,dflow_label)
    dfato_label = do.call(rbind,dfato_label)
    
    dfhigh_label$label = paste0('HSW','\n',1:10)
    dflow_label$label = paste0('LSW','\n',1:9)
    dfato_label$label = paste0('ATO',1:4)
    
    dfato_label$y[4] = dfato_label$y[4]+15
    dflabel = rbind(dfhigh_label,
                    dflow_label,
                    dfato_label)
    
    
    
    
    pals = pal_lancet(alpha = 0.8)(9)
    
    atoshp =do.call(bind,atoshp)
    trajs = fread('analysis_output/fig2/cluster_traj_df.csv')
    trajs = as.data.frame(trajs)
    route_col = pal_npg()(10)[4]
    route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
    
    
    
    psubs = ggplot()+
      geom_polygon(data = world,aes(x = long,y= lat,
                                    group= group),
                   size = 0.5,
                   color = 'black',
                   fill = 'grey80',
                   alpha= 0.8)+
      geom_path(data = trajs,aes(x = long,y = lat,
                                 group = routeid,
                                 color = factor(routeid,
                                                levels = 1:20)),
                size = 1,
                #color = route_col,
                arrow=arrow(angle=30,length=unit(0.11,"inches"),
                            type="open"))+   
      scale_color_manual(values = route_col)+
      geom_polygon(data = atoshp,aes(x = long,y= lat,
                                    group= group),
                   size = 0.5,
                   color = 'black',
                   fill = 'white',
                   alpha= 0.5)+
      geom_polygon(data = shplow,aes(x = long,y= lat,
                                    group= group),
                   size = 0.5,
                   color = pals[4],
                   fill = pals[4],
                   alpha = 0.3)+
      geom_polygon(data = shphigh,aes(x = long,y = lat,
                                      group = group),
                   size = 0.5,
                   color = pals[7],
                   fill = pals[7],
                   alpha = 0.3)+
      geom_text_repel(data = dflabel,
                aes(x = x,y = y,label = label),
                size = 3.5,
                color = 'black',
                bg.color = 'white',
                bg.r =0.25,
                force = F)+
      theme_bw()
    
    dfcor = rbind(cor1,cor2,cor3,cor4)
    dfcorh = dfcor[,id_box]
    dfcorl = dfcor[,-id_box]
    
    colnames(dfcorh) = paste0('HSW',1:ncol(dfcorh))
    colnames(dfcorl) = paste0('LSW',1:ncol(dfcorl))
    
    dfcorh = data.frame(
      ATO = paste0('ATO',1:4),
      dfcorh
    )
    
    dfcorh = reshape2::melt(dfcorh,'ATO')
    
    
    dfcorl = data.frame(
      ATO = paste0('ATO',1:4),
      dfcorl
    )
    
    dfcorl = reshape2::melt(dfcorl,'ATO')
    
    dfcorh$type = 1
    dfcorl$type = 2
  
    dfcor = rbind(dfcorh,dfcorl)
    
    dfcor$cuts = cut(dfcor$value,
                     breaks = seq(-0.3,0.9,0.1))
    
    fil = colorRampPalette(brewer.pal(10,'Spectral'))(12)
    fil = rev(fil)
    library(ggrepel)
    ptile = ggplot()+
      geom_tile(data = dfcor,
                aes(y = ATO,x = variable,
                    fill = cuts))+
      geom_text_repel(data = dfcor,
                aes(x = variable,
                    y = ATO,
                    label = round(value,1)),
                size = 4,
                color = 'black',
                bg.color = 'white',
                bg.r= 0.25,
                force = F)+
      scale_fill_manual(values = fil)+
      scale_x_discrete(breaks = c(paste0('HSW',seq(1,10,2)),
                                  paste0('LSW',seq(1,9,2))))+
      facet_wrap(~type,nrow = 1,scales = 'free_x')+
      theme_bw()
    
    
    dflags = rbind(lag1,lag2,lag3,lag4)
    dflagsh = dflags[,id_box]
    dflagsh = cbind(dflagsh,rep(NA,4),rep(NA,4))
    dflagsl = dflags[,-id_box]
    
    colnames(dflagsh) = paste0('HSW',1:ncol(dflagsh))
    colnames(dflagsl) = paste0('LSW',1:ncol(dflagsl))
    
    
    dflags = cbind(dflagsh,dflagsl)
    #dflags = dflagsh
    dflags = data.frame(
      ATO = 1:4,
      dflags
    )
    dflags = reshape2::melt(dflags,'ATO')
    
    
    col = pal_npg(alpha = 0.8)(10)
    col = colorRampPalette(col)(19)
    
    g1h = c(max(dflagsh[1,],na.rm = T),min(dflagsh[1,],na.rm = T))
    g1l = c(max(dflagsl[1,]),min(dflagsl[1,]))
    g2h = c(max(dflagsh[2,],na.rm = T),min(dflagsh[2,],na.rm = T))
    g2l = c(max(dflagsl[2,]),min(dflagsl[2,]))
    g3h = c(max(dflagsh[3,],na.rm = T),min(dflagsh[3,],na.rm = T))
    g3l = c(max(dflagsl[3,]),min(dflagsl[3,]))
    g4h = c(max(dflagsh[4,],na.rm = T),min(dflagsh[4,],na.rm = T))
    g4l = c(max(dflagsl[4,]),min(dflagsl[4,]))
    
    g1 = rbind(g1h,g2h,g3h,g4h)
    g2 = rbind(g1l,g2l,g3l,g4l)
    
    colnames(g1) =c('max','min')
    colnames(g2) = c('max','min')
    
    lagtextdf = data.frame(
      x = rep('HSW6',4),
      y = 24,
      label = paste0('Lags scale: ',g1[,2],'~',g1[,1]),
      ATO = c(1,2,3,4)
    )
    
    lagtextdf2 = data.frame(
      x = rep('LSW5',4),
      y = 24,
      label = paste0('Lags scale: ',g2[,2],'~',g2[,1]),
      ATO = c(1,2,3,4)
    )
    
    lagtextdf = rbind(lagtextdf,lagtextdf2)
    
    
    
    dfseg = data.frame(
      x = rep(c('HSW1','HSW10','LSW1','LSW9'),4),
      xend = rep(c('HSW10','HSW1','LSW9','LSW1'),4),
      y = 22,
      yend = 22,
      ATO = rep(1:4,each = 4)
    )
    
    dfseg2 = data.frame(
      x = rep(c("HSW1",'HSW10','LSW1','LSW9'),4),
      y = 20,
      yend = 24,
      ATO = rep(1:4,each = 4)
    )
    
    plag = ggplot()+
      geom_bar(data = dflags,
               aes(x = variable,y = value,
                   fill = variable),
               stat = 'identity',
               width = 0.8,
               alpha = 0.8,
               color = 'white')+
      scale_fill_manual(values = col)+
      scale_x_discrete(breaks = c(paste0('HSW',c(1,10)),
                                  paste0('LSW',c(1,9))),
                       labels = c(paste0('HSW',c(1)),10,
                                  paste0('LSW',c(1)),9))+
      geom_text(data = lagtextdf,
                aes(x = x,y = y,label = label),
                size = 3.5,
                color = 'black')+
      geom_segment(data = dfseg,
                   aes(x = x,xend = xend,y=y,
                       yend =yend),size = 0.5,color = 'black',
                   arrow = arrow(angle = 30,unit(0.1,'cm'),
                                 type = 'closed'))+
      geom_segment(data = dfseg2,
                   aes(x = x,xend = x,y = y,
                       yend = yend),
                   size = 0.5,
                   color = 'black')+
      facet_wrap(~ATO,nrow = 4)+
      theme_bw()
    
    
    fontsize = 12
    ##########
    text_theme_set = theme(
      axis.text = element_text(
        color = 'black',
        size = fontsize),
      axis.title = element_text(face = 'bold',
                                color = 'black',
                                size = fontsize),
      legend.text = element_text(
        color = 'black',
        size = fontsize),
      legend.title = element_text(
        color = 'black',
        size = fontsize),
      legend.position = 'none',
      strip.text = element_text(
        color = 'black',
        size = fontsize)
    )
    ##########
    psubs = psubs+text_theme_set+
      xlab('Longitude')+
      ylab('Latitude')+
      theme(
        axis.text.y = element_text(angle = 90,hjust = 0.5)
      )
    
    ptile = ptile+text_theme_set+
      theme(strip.text = element_blank(),
            legend.position = 'none',
            axis.title.x = element_blank(),
            axis.text.y = element_text(angle = 90,hjust = 0.5))+
      ylab('Cross correlation')
    
    plag = plag+text_theme_set+
      xlab('SWs')+
      theme(axis.title.y = element_blank(),
            strip.text = element_blank())
    
    p12 = plot_grid(ptile,
                    psubs,
                    ncol = 1,
                    rel_widths = c(1,1),
                    rel_heights = c(1,1),
                    axis = 'v',
                    align = 'lr'
                    )
    
    p123 = plot_grid(
      p12,plag,
      nrow = 1,
      rel_widths = c(3,1.5),
      rel_heights = c(1,1)
    )
    
    
    p1leg = ptile+theme(
      legend.position = 'bottom'
    )+guides(fill = guide_legend(
      title = 'Cross correlation',
      title.position = 'top',
      nrow = 4
    ))
    
    p1leg = as_ggplot(get_legend(p1leg))
    p1leg = p1leg+theme(plot.margin = unit(rep(0,4),'cm'))
    
    p2leg = plag+theme(
      legend.position = 'bottom'
    )+guides(fill = guide_legend(
      title = 'Max cross correlation lags',
      title.position = 'top',
      nrow = 4
    ))
    
    p2leg = as_ggplot(get_legend(p2leg))
    p2leg = p2leg+theme(plot.margin = unit(rep(0,4),'cm'))
    
    p12leg= plot_grid(
      p1leg,p2leg,
      nrow = 1,
      rel_widths = c(1,1),
      rel_heights = c(1,1)
    )
    
    p123_withleg = plot_grid(
      p123,p12leg,
      ncol = 1,
      rel_heights = c(10,2),
      scale = c(1,0.8)
    )
    
    dir.create('main_plot/SI/generate_sub_windows')
    output = 'main_plot/SI/generate_sub_windows/figs.png'
    png(output,
        height = 26,
        width = 27,
        units = 'cm',
        res = 800)
    print(p123_withleg)
    dev.off()
    
    
}






figs_sst_mmk <- function(
  
  ){
    input = 'analysis_output/fig2/sst_mmk.csv'
    
    sstmmk = as.data.frame(fread(input))
    
    sstdf = reshape2::melt(sstmmk,
                           c('long','lat'))
    
    sstdf$cuts = cut(sstdf$value,
                     breaks = c(-20,seq(-6,8,2)))
    
    
    sstdf$type = 1
    
    pme_ocean = raster('analysis_output/fig2/pme_ato_mmk.nc')
    pme_oceandf = as.data.frame(pme_ocean,xy = T)
    dfnaid = which(is.na(pme_oceandf[,3]))
    pme_oceandf = pme_oceandf[-dfnaid,]
    negid = which(pme_oceandf[,3]<0)
    pme_oceandf = pme_oceandf[negid,]
    
    colnames(pme_oceandf) = c('long','lat','value')
    pme_oceandf$cuts = cut(pme_oceandf$value,
                           breaks = c(-42,seq(-10,0,2)))
    sea_pme_mmk_pal = colorRampPalette(
      brewer.pal(9,'YlOrRd')
    )(25)
    #sea_pme_mmk_pal = sea_pme_mmk_pal[1:]
    sea_pme_mmk_pal = rev(sea_pme_mmk_pal)
    sea_pme_mmk_pal = sea_pme_mmk_pal[seq(1,25,2)[c(2,7:11)]]
    
    pme_oceandf$type = 2
    
    ex = c(min(sstdf$long)-5,max(sstdf$long)+5,
           0,max(sstdf$lat)+5)
    ex = extent(ex)
    
    world = shp_management('world')
    world = crop(world,ex)
    
    atos = list.files('cluster_shp/ato',
                      full.names = T,
                      pattern = '*.shp$')[1:4]
    atos = do.call(bind,lapply(atos,shapefile))
    
    atoshp = list.files('cluster_shp/ato',
                        full.names = T,
                        pattern = '*.shp$')[1:4]
    atoshp = lapply(atoshp,shapefile)
    cal_center_point <- function(x){
      xm = extent(x)
      latm = round((xm[3]+xm[4])/2)
      longm = round((xm[1]+xm[2])/2)
      rm = data.frame(x = longm,y = latm)
      return(rm)
    }
    dfato_label = lapply(atoshp,cal_center_point)
    dfato_label = do.call(rbind,dfato_label)
    dfato_label$label = paste0('ATO',1:4)
    
    cur_df = as.data.frame(
      fread('analysis_output/fig4/current_df.csv')
    )
    
    idless50 = which(cur_df$lat <= 50)
    cur_df = cur_df[idless50,]
    
    idbig1 = which(cur_df$u>0 &
                     cur_df$v >0)
    idbig2 = which(cur_df$u<0 &
                     cur_df$v >0)
    
    cur_df1 = cur_df[idbig1,]
    cur_df2 = cur_df[idbig2,]
    
    cid1 = seq(1,nrow(cur_df1),30)
    cid2 = seq(1,nrow(cur_df2),200)
    
    cur_df1 = cur_df1[cid1,]
    cur_df2 = cur_df2[cid2,]
    
    
    cols_cur = c('#2988AE','#30376E')
    
    psstmmk = ggplot()+
      geom_polygon(data = world,
                   aes(x = long,y = lat,group =group),
                   fill = 'grey80',
                   alpha = 0.5,
                   color = 'black',
                   size = 0.5)+
      geom_tile(data = sstdf,
                aes(x = long,y = lat,
                    fill = cuts))+
      scale_fill_brewer(palette = 'Spectral',
                        guide = guide_legend(
                          title = 'SST_MMK_Trend',
                          title.position = 'top',
                          nrow = 3
                        ),direction = -1)+
      new_scale_fill()+
      geom_tile(data = pme_oceandf,
                aes(x = long,y = lat,
                    fill = cuts))+
      scale_fill_manual(values = sea_pme_mmk_pal,
                        guide = guide_legend(
                          title = 'PME_MMK_Trend',
                          title.position = 'top',
                          nrow = 3
                        ))+
      geom_polygon(data = atos,
                   aes(x = long,y = lat,group =group),
                   fill = 'transparent',
                   #alpha = 0.5,
                   color = 'black',
                   size = 0.5)+
      geom_segment(data = cur_df1,
                   aes(x = long,y = lat,
                       xend = long+u,
                       yend = lat+v),
                   arrow = arrow(angle = 20,unit(0.15,'cm'),
                                 type = 'open'),
                   color = cols_cur[1])+
      geom_segment(data = cur_df2,
                   aes(x = long,y = lat,
                       xend = long+u,
                       yend = lat+v),
                   arrow = arrow(angle = 20,unit(0.2,'cm'),
                                 type = 'open'),
                   color = cols_cur[2])+
      geom_text_repel(data = dfato_label,
                      aes(x = x,y = y,label = label),
                      size = 3.5,
                      color = 'black',
                      bg.color = 'white',
                      bg.r =0.25,
                      force = F)+
      facet_wrap(~type,nrow = 1)+
      theme_bw()
    
    fontsize = 12
    ##########
    text_theme_set = theme(
      axis.text = element_text(
        color = 'black',
        size = fontsize),
      axis.title = element_text(face = 'bold',
                                color = 'black',
                                size = fontsize),
      legend.text = element_text(
        color = 'black',
        size = fontsize),
      legend.title = element_text(
        color = 'black',
        size = fontsize),
      legend.position = 'bottom',
      strip.text = element_text(
        color = 'black',
        size = fontsize)
    )
    ##########
    
    psstmmk = psstmmk + text_theme_set+
      theme(strip.text = element_blank())
    
    dfsubs= data.frame(
      x = c(-130,-130),
      y = c(5,5),
      label = c('(a)','(b)'),
      type = c(1,2)
    )
    
    psstmmk = psstmmk+
      geom_text(data = dfsubs,
                aes(x = x,y = y,label = label),
                size=4,
                color = 'black')
    
    return(psstmmk)
  
  
  
}
figs_variation_analysis_pme_pmexj <-function(
  
){
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pe_in_source = pe_in_source * 30.5
  
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  pe_minus_eva = pe_in_source - pet_sum
  colnames(pe_minus_eva) = paste0('pme',1:12)
  pmedf = pe_minus_eva[,1:11]
  
  tws_in_source = import_pe_in_source('tws_in_source',
                                      name = 'tws_sum.csv')
  colnames(tws_in_source) = paste0('tws',1:12)
  tws_in_source = tws_in_source[,1:11]
  tws_in_source  =as.data.frame(tws_in_source)
  
  input_pr_intarget = list.files('era5_pr_in_target',
                                 full.names = T)[c(1,3)]
  input_eva_intarget = list.files('poten_evap_in_target',
                                  full.names =T)[c(1,3)]
  prtar = lapply(lapply(input_pr_intarget,fread),
                 as.data.frame)
  evatar = lapply(lapply(input_eva_intarget,fread),
                  as.data.frame)
  
  prtar = do.call('cbind',prtar)
  evatar = do.call('cbind',evatar)
  
  #prtar = apply(prtar,1,sum,na.rm =T)
  #evatar = apply(evatar,1,sum,na.rm = T)
  
  pmetar = prtar-evatar
  pmetar = prtar
  pmetar = pmetar[1:174,]
  
  input_tws = 'tws_in_target/'
  input_tws = list.files(input_tws,
                         full.names = T)[c(1,3)]
  
  twstar = lapply(lapply(input_tws,
                         fread),
                  as.data.frame)
  twstar = do.call('cbind',twstar)
  
  #twstar = apply(twstar,1,sum,na.rm = T)
  
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  pmedf = apply(pmedf,2,trend_fun)
  twsdf = apply(tws_in_source,2,trend_fun)
  #pmetar = trend_fun(pmetar)
  #twstar = trend_fun(twstar)
  north_pme = trend_fun(pmetar[,1])
  north_tws = trend_fun(twstar[,1])
  south_pme = trend_fun(pmetar[,2])
  south_tws = trend_fun(twstar[,2])
  
  #twsdf = twsdf[,-c(1,3,5:8)]
  pmedf = pmedf[,-c(1,3)]
  
  corpme_nor = 1
  corpme_sou = 1
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),
             '1 month')[1:174]
  date = date[-c(1:6,169:174)]
  #date = 1:162+100
  names = c(paste0('AS',1:2),
            paste0('ATO',1:4),
            paste0('EU',1:3))
  colnames(pmedf) = c(paste0('AS',1:2),
                      paste0('ATO',1:4),
                      paste0('EU',1:3))
  
  pmedf = data.frame(date = date,
                     pmedf)

  pmedf1 = reshape2::melt(pmedf,'date')
  pmedf1$type = pmedf1$variable
  pmedf1$type = factor(pmedf1$type,
                       levels = c(paste0(
                         'ATO',1:4
                       ),paste0('EU',1:3),
                       paste0('AS',1:2)))
  pmedf1$variable = 'PME_Source'
  
  pmetar = data.frame(
    date = rep(date,9),
    North_PME = rep(north_pme,9)
  )
  
  pmetar1 = reshape2::melt(pmetar,c('date'))
  
  
  pals = pal_lancet(alpha = 0.8)(9)
  
  pals1 = c('North_PME'=pals[1],
           'PME_Source' = pals[7])
  
  
  pline1 = ggplot()+
    geom_line(data =pmedf1,
               aes(x = date,y =value,
                   color = variable),
               size = 1)+
    geom_line(data = pmetar1,
              aes(x = date, y = value,
                  color = variable),
              size = 1.5)+
    scale_color_manual(values = pals1)+
    facet_wrap(~type,nrow= 3)+
    theme_bw()+
    theme(legend.position = 'bottom')+
    guides(color = guide_legend(title = 'Standardized Indices',
                                title.position = 'left',
                                nrow = 1))+
    xlab("Date")+
    ylab('Standardized Indices')

  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  pline1 = pline1+text_theme_set
  pline1 = pline1+theme(
    legend.position = 'bottom'
  )
  
  subsdf = data.frame(
    x = rep(as.Date('2003-08-01'),9),
    y = 0.7,
    label = paste0('(',letters[1:9],')'),
    type = c(paste0('ATO',1:4),paste0('EU',1:3),
             paste0('AS',1:2))
  )
  
  pline1 = pline1+
    geom_text(data = subsdf,aes(x = x,y = y,label = label),
              size = 4,color ='black',hjust = 0)
  
  output = 'main_plot/SI/variation_analysis_pme_pmexj'
  dir.create(output)
  output1 = paste0(output,'/figs_north.png')
  
  png(output1,
      width = 26,
      height = 26,
      res = 800,
      units = 'cm')
  print(pline1)
  dev.off()
  
  pmetar2 = data.frame(
    date = date,
    South_PME = south_pme
  )
  
  pmetar2 = reshape2::melt(pmetar2,c('date'))
  
  
  pals = pal_lancet(alpha = 0.8)(9)
  
  pals1 = c('South_PME'=pals[1],
            'PME_Source' = pals[7])
  
  pline2 = ggplot()+
    geom_line(data =pmedf1,
              aes(x = date,y =value,
                  color = variable),
              size = 1)+
    geom_line(data = pmetar2,
              aes(x = date, y = value,
                  color = variable),
              size = 1.5)+
    scale_color_manual(values = pals1)+
    facet_wrap(~type,nrow= 3)+
    theme_bw()+
    theme(legend.position = 'bottom')+
    guides(color = guide_legend(title = 'Standardized Indices',
                                title.position = 'left',
                                nrow = 1))+
    xlab("Date")+
    ylab('Standardized Indices')
  
  pline2 = pline2+text_theme_set
  pline2 = pline2+theme(
    legend.position = 'bottom'
  )
  
  subsdf = data.frame(
    x = rep(as.Date('2003-08-01'),9),
    y = 0.7,
    label = paste0('(',letters[1:9],')'),
    type = c(paste0('ATO',1:4),paste0('EU',1:3),
            paste0('AS',1:2))
  )
  
  
  pline2 = pline2+
    geom_text(data = subsdf,aes(x = x,y = y,label = label),
              size = 4,color ='black',hjust = 0)
  
  output2 = paste0(output,'/figs_south.png')
  
  png(output2,
      width = 26,
      height = 26,
      res = 800,
      units = 'cm')
  print(pline2)
  dev.off()
  
  
}
figs_variation_analysis_pme_tws_twsxj <-function(
  
){
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pe_in_source = pe_in_source * 30.5
  
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  pe_minus_eva = pe_in_source - pet_sum
  colnames(pe_minus_eva) = paste0('pme',1:12)
  pmedf = pe_minus_eva[,1:11]
  
  tws_in_source = import_pe_in_source('tws_in_source',
                                      name = 'tws_sum.csv')
  colnames(tws_in_source) = paste0('tws',1:12)
  tws_in_source = tws_in_source[,1:11]
  tws_in_source  =as.data.frame(tws_in_source)
  
  input_pr_intarget = list.files('era5_pr_in_target',
                                 full.names = T)[c(1,3)]
  input_eva_intarget = list.files('poten_evap_in_target',
                                  full.names =T)[c(1,3)]
  prtar = lapply(lapply(input_pr_intarget,fread),
                 as.data.frame)
  evatar = lapply(lapply(input_eva_intarget,fread),
                  as.data.frame)
  
  prtar = do.call('cbind',prtar)
  evatar = do.call('cbind',evatar)
  
  #prtar = apply(prtar,1,sum,na.rm =T)
  #evatar = apply(evatar,1,sum,na.rm = T)
  
  pmetar = prtar-evatar
  pmetar = prtar
  pmetar = pmetar[1:174,]
  
  input_tws = 'tws_in_target/'
  input_tws = list.files(input_tws,
                         full.names = T)[c(1,3)]
  
  twstar = lapply(lapply(input_tws,
                         fread),
                  as.data.frame)
  twstar = do.call('cbind',twstar)
  
  #twstar = apply(twstar,1,sum,na.rm = T)
  
  
  trend_fun<-function(x){
    xs = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xs)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    stand_fun <- function(xt){
      xm = (xt- mean(xt,na.rm =T))/(max(xt,na.rm = T)-
                                      min(xt,na.rm = T))
      return(xm)
    }
    xm = stand_fun(xt)
    return(xm)
  }
  
  pmedf = apply(pmedf,2,trend_fun)
  twsdf = apply(tws_in_source,2,trend_fun)
  #pmetar = trend_fun(pmetar)
  #twstar = trend_fun(twstar)
  north_pme = trend_fun(pmetar[,1])
  north_tws = trend_fun(twstar[,1])
  south_pme = trend_fun(pmetar[,2])
  south_tws = trend_fun(twstar[,2])
  
  twsdf = twsdf[,-c(1,3,5:8)]
  pmedf = pmedf[,5:8]
  
  corpme_nor = 1
  corpme_sou = 1
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),
             '1 month')[1:174]
  date = date[-c(1:6,169:174)]
  #date = 1:162+100
  names = c(paste0('AS',1:2),
            paste0('ATO',1:4),
            paste0('EU',1:3))
  
  
  colnames(pmedf) = c(paste0('ATO',1:4))
  colnames(twsdf) = c(paste0('AS',1:2),
                      paste0('EU',1:3))
  pmedf = cbind(pmedf,twsdf)
  
  pmedf = data.frame(date = date,
                     pmedf)
  
  pmedf1 = reshape2::melt(pmedf,'date')
  pmedf1$type = pmedf1$variable
  
  pmedf1$variable = c(rep('PME_ATO',162*4),
                      rep('TWS_Land',162*2),
                      rep('TWS_Land',162*3))
                          
  pmedf1$type = factor(pmedf1$type,
                       levels = c(paste0(
                         'ATO',1:4
                       ),paste0('EU',1:3),
                       paste0('AS',1:2)))
  
  pmetar = data.frame(
    date = rep(date,9),
    North_TWS = rep(north_tws,9)
  )
  
  pmetar1 = reshape2::melt(pmetar,c('date'))
  
  
  pals = pal_lancet(alpha = 0.8)(9)
  
  pals1 = c('PME_ATO' = pals[1],
            'TWS_Land' = pals[6],
            'North_TWS' = pals[7])
  
  
  pline1 = ggplot()+
    geom_line(data =pmedf1,
              aes(x = date,y =value,
                  color = variable),
              size = 1)+
    geom_line(data = pmetar1,
              aes(x = date, y = value,
                  color = variable),
              size = 1.5)+
    scale_color_manual(values = pals1)+
    facet_wrap(~type,nrow= 3)+
    theme_bw()+
    theme(legend.position = 'bottom')+
    guides(color = guide_legend(title = 'Standardized Indices',
                                title.position = 'left',
                                nrow = 1))+
    xlab("Date")+
    ylab('Standardized Indices')
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  pline1 = pline1+text_theme_set
  pline1 = pline1+theme(
    legend.position = 'bottom'
  )
  
  subsdf = data.frame(
    x = rep(as.Date('2003-08-01'),9),
    y = 0.7,
    label = paste0('(',letters[1:9],')'),
    type = c(paste0('ATO',1:4),paste0('EU',1:3),
             paste0('AS',1:2))
  )
  
  
  pline1 = pline1+
    geom_text(data = subsdf,aes(x = x,y = y,label = label),
              size = 4,color ='black',hjust = 0)
  
  output = 'main_plot/SI/variation_analysis_pme_tws_tws'
  dir.create(output)
  output1 = paste0(output,'/figs_north.png')
  
  png(output1,
      width = 26,
      height = 26,
      res = 800,
      units = 'cm')
  print(pline1)
  dev.off()
  
  pmetar2 = data.frame(
    date = rep(date,9),
    South_TWS = rep(south_tws,9)
  )
  
  pmetar2 = reshape2::melt(pmetar2,c('date'))
  
  
  pals = pal_lancet(alpha = 0.8)(9)
  
  pals1 = c('PME_ATO' = pals[1],
            'TWS_Land' = pals[6],
            'South_TWS' = pals[7])
  
  
  pline2 = ggplot()+
    geom_line(data =pmedf1,
              aes(x = date,y =value,
                  color = variable),
              size = 1)+
    geom_line(data = pmetar2,
              aes(x = date, y = value,
                  color = variable),
              size = 1.5)+
    scale_color_manual(values = pals1)+
    facet_wrap(~type,nrow= 3)+
    theme_bw()+
    theme(legend.position = 'bottom')+
    guides(color = guide_legend(title = 'Standardized Indices',
                                title.position = 'left',
                                nrow = 1))+
    xlab("Date")+
    ylab('Standardized Indices')
  
  pline2 = pline2+text_theme_set
  pline2 = pline2+theme(
    legend.position = 'bottom'
  )
  
  subsdf = data.frame(
    x = rep(as.Date('2003-08-01'),9),
    y = 0.7,
    label = paste0('(',letters[1:9],')'),
    type =  c(paste0('ATO',1:4),
              paste0('EU',1:3),
              paste0('AS',1:2))
  )
  
  
  pline2 = pline2+
    geom_text(data = subsdf,aes(x = x,y = y,label = label),
              size = 4,color ='black',hjust = 0)
  
  output2 = paste0(output,'/figs_south.png')
  
  png(output2,
      width = 26,
      height = 26,
      res = 800,
      units = 'cm')
  print(pline2)
  dev.off()
  
  
}
figs1_plot_xinjiang_vapor<-function(
  
){
  
}
figs1_validation_of_contribution<-function(
  
){
  
  input_contr_by_sou = 'analysis_output/contr_in_source_variance_new.csv'
  contr_by_sou = as.data.frame(fread(input_contr_by_sou))
  
  sou_names = contr_by_sou[,1]
  sou_names[13] = 'NAM'
  contr_by_sou = contr_by_sou[,-1]
  
  contr_by_sou[10,]= abs(contr_by_sou[10,])
  
  contr_sum = apply(contr_by_sou,2,sum,
                    na.rm = T)
  
  # input_pr_in_target
  input_era5_pr = list.files('era5_pr_in_target',
                                 full.names = T)
  input_gpcc_pr = list.files('gpcc_pr_in_target',
                             full.names = T)
  
  era5_pr = lapply(lapply(input_era5_pr,fread),
                   as.data.frame)
  gpcc_pr = lapply(lapply(input_gpcc_pr,fread),
                   as.data.frame)
  
  era5_pr = do.call('cbind',era5_pr)
  gpcc_pr = do.call('cbind',gpcc_pr)
  
  era5_pr = apply(era5_pr,1,sum)
  gpcc_pr = apply(gpcc_pr,1,sum)
  
  stand_fun <-function(x){
    
    x = ts(x,start = c(2003,1),
           frequency = 12)
    xt = decompose(x)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    x = xt
    
    x = (x -mean(x,na.rm = T))/(max(x,na.rm = T)-
                                  min(x,na.rm = T))
    return(x)
  }
  
  contr_sum = stand_fun(contr_sum)
  era5_pr = stand_fun(era5_pr)
  gpcc_pr = stand_fun(gpcc_pr)
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-12-01'),
             '1 month')
  dates = date[-c(1:6,175:180)]
  date = 1:168+100
  
  df1 = data.frame(
    date = date,
    Sum_Contr_Rate = contr_sum,
    ERA5_Pr = era5_pr,
    GPCC_Pr = gpcc_pr
  )
  df2 = df1[,-1]

  df1 = reshape2::melt(df1,'date')
  df2 = reshape2::melt(df2,'Sum_Contr_Rate')
  
  df1$type = 1
  df2$type = 2
  
  dfabline = data.frame(
    x =0,
    slope = 1,
    type = 2
  )
  
  pcom = ggplot()+
    geom_line(data = df1,aes(x = date,y = value,
                             color = variable,
                             linetype = variable),
              size = 1.5)+
    geom_point(data = df2,aes(x = Sum_Contr_Rate,
                              y = value,
                              color = variable),
               size = 3,
               shape = 1)+
    geom_point(data = df2,aes(x = Sum_Contr_Rate,
                              y = value,
                              color = variable),
               size = 3.25,
               shape = 1)+
    geom_abline(data = dfabline,
                aes(intercept = x,
                    slope = slope),
                size = 1,
                color = 'black')+
    facet_wrap(~type,nrow = 1,
               scales = 'free_x')+
    scale_color_npg()+
    scale_x_continuous(breaks = c(seq(-0.5,0.5,0.25),
                                  seq(101,268,50)),
                       labels = c(seq(-0.5,0.5,0.25),
                                  substr(dates[seq(1,168,50)],1,4)))+
    theme_bw()
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  pcom = pcom+text_theme_set+
    guides(color = guide_legend(
      title = ''),
      linetype = guide_legend(
        title = ''))+
    theme(strip.text = element_blank(),
          legend.position = 'bottom')
  
  # adding df
  subsdf = data.frame(
    x = c(101,-0.45),
    y = c(0.6,0.60),
    label = c('(a)','(b)'),
    type = c(1,2)
  )
  
  pcom = pcom+
    geom_text(data = subsdf,
              aes(x =x,y= y,label = label),
              size = 4,
              color = 'black')
  pcom = pcom+
    xlab('Date')+
    ylab('Standardized Indices')
  
  # cor test 
  cor1 = cor.test(contr_sum,era5_pr,p=0.01)
  cor2 = cor.test(contr_sum,gpcc_pr)
  
  cor1in = cor1$conf.int
  cor2in = cor2$conf.int
  
  cor1e = cor1$estimate
  cor2e = cor2$estimate
  
  cordf1 = data.frame(
    x = c('Cor_ERA5','Cor_GPCC'),
    y50 = c(cor1e,cor2e),
    y95 = c(cor1in[2],cor2in[2]),
    y05 = c(cor1in[1],cor2in[1])
  )
  
  fil1 = pal_npg()(9)[2:3]
  pbox = ggplot()+
    geom_bar(data = cordf1,
             aes(x = x,
                 y = y50,
                 fill = x),
             stat = 'identity',
             position = 'dodge',
             color = 'white',
             width = 0.8)+
    geom_text(data = cordf1,
              aes(x = x,
                  y = y50-0.1,
                  label = round(y50,2)),
              size = 4,
              color = 'black')+
    scale_fill_manual(values = fil1)+
    theme_void()+
    theme(
      legend.position = 'none',
      axis.line.x = element_line(size = 0.5,color = 'black'),
      axis.title.x = element_text(size = 11,
                                  color = 'black')
    )+
    xlab('Corre. Coeff. (p <0.05)')
  
  library(cowplot)
  pcom1 = ggdraw()+
    draw_plot(pcom)+
    draw_plot(pbox,x = 0.86, y = 0.30,
              width = 0.11, height = 0.24)
  
  output = 'main_plot/SI/figs1_validation_contri'
  dir.create(output)
  output = paste0(output,'/figs1.png')
  
  png(output,
      height = 10,
      width = 25,
      units = 'cm',
      res = 800)
  print(pcom1)
  dev.off()
  
}



figs10_plot_ver2 <- function(
  
){
  source('/home/share/R_project/xinjiang_vapor/import_importance_data_figs1011.R')
  retbox = import_importance_data_figs1011()
  imp245 = retbox[[1]]
  imp585 = retbox[[2]]
  
  imp245$type = 'SSP245'
  imp585$type = 'SSP585'
  
  imp245 = reshape2::melt(imp245,c('SWs','type','PME'))
  imp585 = reshape2::melt(imp585,c('SWs','type','PME'))
  
  
  imp245$type = '(a) SSP245'
  imp585$type ='(b) SSP585'
  
  labeldf = data.frame(
    x = c('SW1'),
    y = rep(10,1),
    label = c('(a)'),
    type = c('(a) SSP245')
  )
  
  text_df1 = data.frame(
    x = c(imp245$SWs),
    y = c(imp245$value),
    type = c(imp245$type)
  )
  
  library(ggsci)
  p10 = ggplot()+
    geom_bar(data = imp245,
             aes(x = SWs,
                 y = value,
                 fill = PME),
             stat = 'identity',
             position = 'dodge',
             color = 'white',
             width = 0.8)+
    geom_text(data = labeldf,
              aes(x = x,y = y,
                  label = label),
              color = 'black',
              size = 4)+
    geom_text(data = text_df1,
              aes(x = x,y = y+0.2,
                  label = round(y,2)),
              position = position_dodge2(0.8),
              size = 4,
              color = 'black')+
    #facet_wrap(~type,nrow = 1)+
    scale_fill_lancet(alpha = 0.8)+
    theme_bw()+
    ylab('IncNodePurity')
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  p10 = p10+
    text_theme_set+
    theme(strip.text = element_blank(),
          axis.title.x = element_blank(),
          legend.position = 'none')
  
  source('/home/share/R_project/xinjiang_vapor/import_IncMSE_data_figs1011.R')
  
  imsedf = import_IncMSE_data_figs1011()
  imse245 = imsedf[[1]]
  imse585 = imsedf[[2]]
  
  
  imse245$type = 'SSP245'
  imse585$type = 'SSP585'
  
  imse245 = reshape2::melt(imse245,c('SWs','type','PME'))
  imse585 = reshape2::melt(imse585,c('SWs','type','PME'))
  
  
  imse245$type = '(c) SSP245'
  imse585$type ='(d) SSP585'
  
  labeldf = data.frame(
    x = c('SW1'),
    y = rep(12,1),
    label = c('(b)'),
    type = c('(c) SSP245')
  )
  
  text_df1 = data.frame(
    x = c(imse245$SWs),
    y = c(imse245$value),
    type = c(imse245$type)
  )
  
  library(ggsci)
  p11 = ggplot()+
    geom_bar(data = imse245,
             aes(x = SWs,
                 y = value,
                 fill = PME),
             stat = 'identity',
             position = 'dodge',
             color = 'white',
             width = 0.8)+
    geom_text(data = labeldf,
              aes(x = x,y = y,
                  label = label),
              color = 'black',
              size = 4)+
    geom_text(data = text_df1,
              aes(x = x,y = y+0.2,
                  label = round(y,2)),
              position = position_dodge2(0.8),
              size = 4,
              color = 'black')+
    #facet_wrap(~type,nrow = 1)+
    scale_fill_lancet(alpha = 0.8)+
    theme_bw()+
    ylab('IncMSE (%)')
  
  
  p11 = p11+text_theme_set+
    theme(strip.text = element_blank(),
          axis.title.x = element_blank(),
          legend.position = 'none')
  
  p10 = p10+scale_y_continuous(
    breaks = seq(0,8,2),
    labels = paste0(seq(0,8,2),'.0')
  )
  p11 = p11+scale_y_continuous(
    breaks = seq(0,12,2),
    labels = paste0(seq(0,12,2),'.0')
  )
  
  library(cowplot)
  p12 = plot_grid(
    p10,p11,
    align = 'tb',
    axis = 'h',
    rel_widths = c(1,1),
    rel_heights = c(1,1),
    nrow = 1
  )
  
  library(ggpubr)
  p12legend = as_ggplot(get_legend(
    p10+theme(legend.position = 'bottom')+
      guides(fill = guide_legend(title = ''))
  ))
  p12legend = p12legend+
    theme(plot.margin = unit(c(0,0,0,0),'cm'))
  p123 = plot_grid(
    p12,p12legend,
    ncol = 1,
    rel_heights = c(10,1)
  )
  dir.create('main_plot/SI/importance_matrix')
  png('main_plot/SI/importance_matrix/fig91.png',
      height = 15,
      width = 24,
      units = 'cm',
      res = 800)
  print(p123)
  dev.off()
  
  
  
  
}
figs10_plot <- function(
  
){
  source('/home/share/R_project/xinjiang_vapor/import_importance_data_figs1011.R')
  retbox = import_importance_data_figs1011()
  imp245 = retbox[[1]]
  imp585 = retbox[[2]]
  
  imp245$type = 'SSP245'
  imp585$type = 'SSP585'
  
  imp245 = reshape2::melt(imp245,c('SWs','type','PME'))
  imp585 = reshape2::melt(imp585,c('SWs','type','PME'))
  
  
  imp245$type = '(a) SSP245'
  imp585$type ='(b) SSP585'
  
  labeldf = data.frame(
    x = c('SW1','SW1'),
    y = rep(10,2),
    label = c('(a)','(b)'),
    type = c('(a) SSP245','(b) SSP585')
  )
  
  text_df1 = data.frame(
    x = c(imp245$SWs,imp585$SWs),
    y = c(imp245$value,imp585$value),
    type = c(imp245$type,imp585$type)
  )
  
  library(ggsci)
  p10 = ggplot()+
    geom_bar(data = imp245,
             aes(x = SWs,
                 y = value,
                 fill = PME),
             stat = 'identity',
             position = 'dodge',
             color = 'white',
             width = 0.8)+
    geom_bar(data = imp585,
             aes(x = SWs,
                 y = value,
                 fill = PME),
             stat = 'identity',
             position = 'dodge',
             color = 'white',
             width = 0.8)+
    geom_text(data = labeldf,
              aes(x = x,y = y,
                  label = label),
              color = 'black',
              size = 4)+
    geom_text(data = text_df1,
                    aes(x = x,y = y+0.2,
                        label = round(y,2)),
                    position = position_dodge2(0.8),
                    size = 4,
                    color = 'black')+
    facet_wrap(~type,nrow = 1)+
    scale_fill_lancet(alpha = 0.8)+
    theme_bw()+
    ylab('IncNodePurity')
    
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  p10 = p10+
      text_theme_set+
    theme(strip.text = element_blank(),
          axis.title.x = element_blank(),
          legend.position = 'none')
  
  source('/home/share/R_project/xinjiang_vapor/import_IncMSE_data_figs1011.R')
  
  imsedf = import_IncMSE_data_figs1011()
  imse245 = imsedf[[1]]
  imse585 = imsedf[[2]]
  
  
  imse245$type = 'SSP245'
  imse585$type = 'SSP585'
  
  imse245 = reshape2::melt(imse245,c('SWs','type','PME'))
  imse585 = reshape2::melt(imse585,c('SWs','type','PME'))
  
  
  imse245$type = '(c) SSP245'
  imse585$type ='(d) SSP585'
  
  labeldf = data.frame(
    x = c('SW1','SW1'),
    y = rep(12,2),
    label = c('(c)','(d)'),
    type = c('(c) SSP245','(d) SSP585')
  )
  
  text_df1 = data.frame(
    x = c(imse245$SWs,imse585$SWs),
    y = c(imse245$value,imse585$value),
    type = c(imse245$type,imse585$type)
  )
  
  library(ggsci)
  p11 = ggplot()+
    geom_bar(data = imse245,
             aes(x = SWs,
                 y = value,
                 fill = PME),
             stat = 'identity',
             position = 'dodge',
             color = 'white',
             width = 0.8)+
    geom_bar(data = imse585,
             aes(x = SWs,
                 y = value,
                 fill = PME),
             stat = 'identity',
             position = 'dodge',
             color = 'white',
             width = 0.8)+
    geom_text(data = labeldf,
              aes(x = x,y = y,
                  label = label),
              color = 'black',
              size = 4)+
    geom_text(data = text_df1,
              aes(x = x,y = y+0.2,
                  label = round(y,2)),
              position = position_dodge2(0.8),
              size = 4,
              color = 'black')+
    facet_wrap(~type,nrow = 1)+
    scale_fill_lancet(alpha = 0.8)+
    theme_bw()+
    ylab('IncMSE (%)')
  
  
  p11 = p11+text_theme_set+
    theme(strip.text = element_blank(),
          axis.title.x = element_blank(),
          legend.position = 'none')
  
  p10 = p10+scale_y_continuous(
    breaks = seq(0,8,2),
    labels = paste0(seq(0,8,2),'.0')
  )
  p11 = p11+scale_y_continuous(
    breaks = seq(0,12,2),
    labels = paste0(seq(0,12,2),'.0')
  )
  
  library(cowplot)
  p12 = plot_grid(
    p10,p11,
    align = 'lr',
    axis = 'h',
    rel_widths = c(1,1),
    rel_heights = c(1,1),
    ncol = 1
  )
  
  library(ggpubr)
  p12legend = as_ggplot(get_legend(
    p10+theme(legend.position = 'bottom')+
      guides(fill = guide_legend(title = ''))
  ))
  p12legend = p12legend+
    theme(plot.margin = unit(c(0,0,0,0),'cm'))
  p123 = plot_grid(
    p12,p12legend,
    ncol = 1,
    rel_heights = c(10,1)
  )
  dir.create('main_plot/SI/importance_matrix')
  png('main_plot/SI/importance_matrix/fig9.png',
      height = 20,
      width = 24,
      units = 'cm',
      res = 800)
  print(p123)
  dev.off()
  
  
  
  
}
figs2_monthly_contribution<-function(
  
){
  input_contr_by_sou = 'analysis_output/contr_in_source_variance_new.csv'
  contr_by_sou = as.data.frame(fread(input_contr_by_sou))
  
  sou_names = contr_by_sou[,1]
  sou_names[13] = 'NAM'
  contr_by_sou = contr_by_sou[,-1]
  
  contr_by_sou[10,]= abs(contr_by_sou[10,])

  monthly_median <- function(x){
    xm = matrix(x,nrow = 12)
    xm = apply(xm,1,median,na.rm= T)
    return(xm)
  }
  monthly_max <- function(x){
    xm = matrix(x,nrow = 12)
    xm = apply(xm,1,max,na.rm= T)
    return(xm)
  }
  monthly_min <- function(x){
    xm = matrix(x,nrow = 12)
    xm = apply(xm,1,min,na.rm= T)
    return(xm)
  }
  monthly_q25 <- function(x){
    xm = matrix(x,nrow = 12)
    xm = apply(xm,1,quantile,
               na.rm= T,
               probs = 0.25)
    return(xm)
  }
  monthly_q75 <- function(x){
    xm = matrix(x,nrow = 12)
    xm = apply(xm,1,quantile,
               na.rm= T,
               probs = 0.75)
    return(xm)
  }
  
  mean_box = apply(contr_by_sou,1,monthly_mean)
  min_box = apply(contr_by_sou,1,monthly_min)
  max_box = apply(contr_by_sou,1,monthly_max)
  q25_box = apply(contr_by_sou,1,monthly_q25)
  q75_box = apply(contr_by_sou,1,monthly_q75)
    
  colnames(mean_box) = toupper(sou_names)
  colnames(min_box) = toupper(sou_names)
  colnames(max_box) = toupper(sou_names)
  colnames(q25_box) = toupper(sou_names)
  colnames(q75_box) = toupper(sou_names)
  
  date = toupper(month.abb)
  #date = 1:12
  dfmean = data.frame(
    date,
    mean_box
  )
  
  dfmin = data.frame(
    date = date,
    min_box
  )
  
  dfmax =data.frame(
    date   = date,
    max_box
  )
  
  df25 = data.frame(
    date = date,
    q25_box
  )
  
  df75 = data.frame(
    date = date,
    q75_box
  )
  
  
  
  dfmean = reshape2::melt(dfmean,'date')
  dfmin = reshape2::melt(dfmin,'date')
  dfmax = reshape2::melt(dfmax,'date')
  df25 = reshape2::melt(df25,'date')
  df75 = reshape2::melt(df75,'date')
  
  
  
  dfmaxmin = data.frame(
    date = dfmin$date,
    variable = dfmin$variable,
    max = dfmax$value,
    min = dfmin$value,
    y25 = df25$value,
    y75 = df75$value,
    mean = dfmean$value
  )
  
  
  
  cols = colorRampPalette(
    brewer.pal(9,'Set1')
  )(13)
  cols = colorRampPalette(
    pal_npg()(9)
  )(13)
  
  idsort = order(apply(contr_by_sou,1,mean,
                      na.rm = T),
                decreasing = T)
  mean_contr = sort(apply(contr_by_sou,1,mean,
                           na.rm = T),
                     decreasing = T)
  sous = toupper(sou_names)[idsort]
  
  sous1 = sous[1:3]
  sous2 = sous[4:13]
  
  dfg1 = dfmaxmin[which(dfmaxmin$variable
                       %in% sous1),]
  dfg2 = dfmaxmin[which(dfmaxmin$variable
                       %in% sous2),]
  
  dfmaxmin$variable = factor(dfmaxmin$variable,
                             levels = sous)
  
  dfg1$variable = factor(dfg1$variable,
                         levels = sous1)
  dfg2$variable = factor(dfg2$variable,
                         levels = sous2)
  dates1 = date[1:5]
  dates2 = date[6:12]
  
  dfg1$date = factor(dfg1$date,
                     levels = date)
  dfg2$date = factor(dfg2$date,
                     levels = date)
  library(ggsci)
  pmonth1 = ggplot()+
    geom_boxplot(data = dfg1,
      aes(x = date,
          ymin = min, 
          lower = y25, 
          middle = mean, 
          upper = y75, 
          ymax = max,
          fill = variable),
                 stat = "identity")+
    scale_fill_manual(values = cols[1:3])+
    scale_x_discrete(breaks = date[seq(1,12,3)])+
    facet_wrap(~variable,nrow = 1)+
    theme_bw()
  library(ggsci)
  pmonth2 = ggplot()+
    geom_boxplot(data = dfg2,
                 aes(x = date,
                     ymin = min, 
                     lower = y25, 
                     middle = mean, 
                     upper = y75, 
                     ymax = max,
                     fill = variable),
                 stat = "identity")+
    scale_fill_manual(values = cols[4:13])+
    scale_x_discrete(breaks = date[seq(1,12,3)])+
    facet_wrap(~variable,nrow = 2,
               scales = 'free')+
    theme_bw()
  
  pmonth3 = ggplot()+
    geom_boxplot(data = dfmaxmin,
                 aes(x = date,
                     ymin = min, 
                     lower = y25, 
                     middle = mean, 
                     upper = y75, 
                     ymax = max,
                     fill = variable),
                 stat = "identity")+
    scale_fill_manual(values = cols,
                      guide = guide_legend(
                        title = 'Continent',
                        title.position = 'top',
                        nrow = 1
                      ))+
    scale_x_discrete(breaks = date[seq(1,12,3)])+
    facet_wrap(~variable,nrow = 2,
               scales = 'free')+
    theme_bw()
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'none',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  
  dftext1 = data.frame(
    x = rep('JAN',3),
    y = rep(50,3),
    label = paste0('(',letters[1:3],')'),
    variable = sous1
  )
  dftext2 = data.frame(
    x = rep('JAN',10),
    y = c(12.5,8,5,11.5,4.5,
          5,3,1,1.25,1.1),
    label = paste0('(',letters[4:13],')'),
    variable = sous2
  )
  
  mean_contr = as.numeric(mean_contr)
  mean_contr = round(mean_contr,2)
  dftext3 = data.frame(
    x = rep('APR',3),
    y = rep(50,3),
    label = paste0("MCR: ",mean_contr[1:3],'%'),
    variable = sous1
  )
  
  dftext4 = data.frame(
    x = rep('APR',10),
    y = c(12.5,8,5,11.5,4.5,
          5,3,1,1.25,1.1),
    label = paste0("MCR: ",mean_contr[4:13],'%'),
    variable = sous2
  )
  pmonth1 = pmonth1+text_theme_set
  pmonth2 = pmonth2+text_theme_set
  pmonth3 = pmonth3+text_theme_set
  
  pmonth1 = pmonth1+
    geom_text(data = dftext1,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black',
              hjust = 0)+
    geom_text(data = dftext3,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black',
              hjust = 0)
  pmonth2 = pmonth2+
    geom_text(data = dftext2,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black',
              hjust =0)+
    geom_text(data = dftext4,
              aes(x = x,y = y,label = label),
              size = 4,
              color = 'black',
              hjust = 0)
  
  
  comb_set = theme(
    legend.position = 'none',
    axis.title = element_blank(),
    strip.text = element_blank()
  )
  
  pmonth1 = pmonth1+comb_set
  pmonth2 = pmonth2+comb_set
  
  pmon = plot_grid(
    pmonth1,
    pmonth2,
    ncol =1,
    align = 'lr',
    axis = 'hv',
    rel_widths = c(1,1),
    rel_heights = c(1,2)
  )
  
  plegend = as_ggplot(
    get_legend(pmonth3+
                 theme(legend.position = 'bottom'))
  )
  
  plegend = plegend+
    theme(plot.margin = unit(c(0,0,0,0),'cm'))
  
  pmon_leg = plot_grid(
    pmon,
    plegend,
    ncol = 1,
    rel_heights = c(10,1),
    rel_widths = c(1,1)
  )
  
  output = 'main_plot/SI/monthly_contribution/'
  dir.create(output)
  output = paste0(output,'figs2.png')
  
  png(output,
      height = 22,
      width = 26,
      units = 'cm',
      res = 800)
  print(pmon_leg)
  dev.off()
  
}




figs3_pme_local_tws <- function(
  
){
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:174,]
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:174,]
  
  pmeato = pe_in_source[,5:8]- pet_sum[,5:8]
  
  input_era5_pr = list.files('era5_pr_in_target',
                             full.names = T)[c(1,3)]
  input_eva_intarget = list.files('poten_evap_in_target',
                                  full.names =T)[c(1,3)]
  
  input_tws = 'tws_in_target/'
  input_tws = list.files(input_tws,
                         full.names = T)[c(1,3)]
  
  
  era5_pr = lapply(lapply(input_era5_pr,fread),
                   as.data.frame)
  eva = lapply(lapply(input_eva_intarget,fread),
                   as.data.frame)
  tws = lapply(lapply(input_tws,fread),
               as.data.frame)
  
  era5_pr = do.call('cbind',era5_pr)
  eva = do.call('cbind',eva)
  tws = do.call('cbind',tws)
  
  era5_pr = era5_pr[1:174,]
  eva = eva[1:174,]
  pmeato = pmeato[1:174,]
  #era5_pr = apply(era5_pr,1,sum)
  #eva = apply(eva,1,sum)
  
  era5_pme = era5_pr - eva
  
  #tws = apply(tws,1,sum)
  
  stand_fun <-function(x){
    
    x = ts(x,start = c(2003,1),
           frequency = 12)
    xt = decompose(x)$trend
    naid = which(is.na(xt))
    xt = xt[-naid]
    
    x = xt
    
    x = (x -mean(x,na.rm = T))/(max(x,na.rm = T)-
                                  min(x,na.rm = T))
    return(x)
  }
  
  #era5_pme = stand_fun(era5_pme)
  #tws = stand_fun(tws)
  
  era5_pme = apply(era5_pme,2,stand_fun)
  era5_pr = apply(era5_pr,2,stand_fun)
  pmeato = apply(pmeato,2,stand_fun)
  tws  =apply(tws,2,stand_fun)
  
  df1 = data.frame(
    PME_North = era5_pme[,1],
    PME_ATO1 = pmeato[,1],
    PME_ATO2 = pmeato[,2],
    PME_ATO3 = pmeato[,3],
    PME_ATO4 = pmeato[,4]
  )
  df2 = data.frame(
    PME_South = era5_pme[,2],
    PME_ATO1 = pmeato[,1],
    PME_ATO2 = pmeato[,2],
    PME_ATO3 = pmeato[,3],
    PME_ATO4 = pmeato[,4]
  )
  
  df1m = reshape2::melt(df1,'PME_North')
  df2m = reshape2::melt(df2,'PME_South')
  
  p1 = ggplot()+
    geom_point(data = df1m,
               aes(x = PME_North,
                   y = value,
                   color = variable),
               shape = 1,
               size = 3)+
    geom_abline(intercept = 0,
                slope = 1,
                color = 'black',
                size = 0.5)+
    geom_abline(intercept = 0,
                slope = -1,
                color = 'black',
                size = 0.5)+
    facet_wrap(~variable,nrow = 1)+
    theme_bw()
  p2 = ggplot()+
    geom_point(data = df1m,
               aes(x = PME_Sorth,
                   y = value,
                   color = variable),
               shape = 1,
               size = 3)+
    geom_abline(intercept = 0,
                slope = 1,
                color = 'black',
                size = 0.5)+
    geom_abline(intercept = 0,
                slope = -1,
                color = 'black',
                size = 0.5)+
    facet_wrap(~variable,nrow = 1)+
    theme_bw()
  
  date = 1:162+100
  dates = seq(as.Date('2003-01-01'),
              as.Date('2017-12-01'),
              '1 month')[1:174]
  dates = dates[-c(1:6,169:174)]
  
  colnames(pmeato) = paste0('PME_ATO',1:4)
  
  df3 = data.frame(
    date = date,
    TWS_North = tws[,1],
    PME_North = era5_pme[,1],
    pmeato
  )
  df4 = data.frame(
    TWS_North = tws[,1],
    PME_North = era5_pme[,1],
    pmeato
  )
  df3m= reshape2::melt(df3,'date')
  df4m = reshape2::melt(df4,'TWS_North')
  
  df3m$type = 1
  df4m$type = 2
  p2 = ggplot()+
    geom_line(data = df3m,
              aes(x = date,y = value,
                  color =variable),
              size = 1.5)+
    geom_point(data = df4m,aes(x = TWS_North,
                               y = value,
                               color = variable))+
    scale_color_npg()+
    facet_wrap(~type,nrow = 1,
               scales ='free_x')+
    theme_bw()
  
  
}
figs8_plot <- function(
  
){
  # content 
  # validation of training peariod
  source('/home/share/R_project/xinjiang_vapor/import_validate_tws_sws.R')
  source('/home/share/R_project/xinjiang_vapor/import_validate_tws_sws585.R')
  ret245 = import_validate_tws_sws245()
  ret585 = import_validate_tws_sws585()
  
  df245 = ret245[[1]]
  dfcor245 = ret245[[2]]
  df585 = ret585[[1]]
  dfcor585 = ret585[[2]]
  
  dfcor245$group = seq(2,20,2)
  dfcor585$group = seq(2,20,2)
  
  date = seq(as.Date('2003-01-01'),
             as.Date('2017-06-01'),
             '1 month')
  
  reid = c(1:6,167:172)
  date = date[-reid]
  
  dfline245 = data.frame(
    date = (1:162)+100,
    df245,
    date_label = date
  )
  dfline585 = data.frame(
    date = (1:162)+100,
    df585,
    date_label = date
  )
  
  dfline245$group = rep(seq(1,20,2),each = 162)
  dfline585$group = rep(seq(1,20,2),each = 162)
  df245$group = rep(seq(2,20,2),each = 162)
  df585$group = rep(seq(2,20,2),each = 162)
  
  dflin245m = reshape2::melt(dfline245,
                            c('date','date_label',
                              'SWs','type','group'))
  dflin585m = reshape2::melt(dfline585,
                             c('date','date_label',
                               'SWs','type','group'))
  colnames = colnames(df245) 
  colnames[4] = 'type'
  colnames(df245) = colnames
  colnames(df585) = colnames
  
  pal1 = pal_lancet(alpha = 0.8)(9)
  pal1 = colorRampPalette(pal1)(30)
  cols = c('TWS_OBS'= pal1[1],
           'TWS_PROJ'= pal1[12],
           'Validation' = pal1[10],
           'Train' = pal1[13])
  
  dfabline1 = data.frame(
    x = c(rep(1,10),rep(113,10),
          rep(162,10))+100,
    group = rep(seq(1,20,2),3)
  )
  dfabline2 = data.frame(
    x = c(rep(0,10)),
    slope = rep(1,10),
    group = seq(2,20,2)
  )
  
  x = c(0,0.15,0.1,-0.25,0,0.1,
        0.1,0,0,0.1)
  y = c(-0.3,-0.25,-0.2,-0.5,
        -0.3,-0.3,-0.25,-0.25,
        -0.4,-0.4)
  
  dfcor245$x = x
  dfcor585$x = x
  
  dfcor245$y = y+0.1
  dfcor585$y = y+0.1
  
  dfcor245$label = paste0('Cor: ',
                          round(dfcor245$Cor,2))
  dfcor585$label = paste0('Cor: ',
                          round(dfcor585$Cor,2))
  
  dfp245 = dfcor245
  dfp585 = dfcor585
  
  dfp245$y = y
  dfp585$y = y
  
  dfp245$label = c('p<0.05')
  dfp585$label = c('p<0.05')
  
  pathdf = data.frame(
    x = rep(c(1,113,113,162),10)+100,
    xend = rep(c(113,1,162,113),10)+100,
    y = rep(rep(0.63,4),10),
    yend = rep(rep(0.63,4),10),
    group = rep(seq(1,20,2),each = 4)
  )
  
  pathdf2 = data.frame(
    x = rep(c(1,113,162),10)+100,
    y = rep(rep(0.60,3),10),
    yend = rep(rep(0.68,3),10),
    group = rep(seq(1,20,2),each = 3)
  )
  
  perioddf= data.frame(
    x = rep(c(56.5,137.5),10)+100,
    y = rep(c(0.68,0.68),10),
    label = rep(c('TP',
                  'VP'),
                10),
    group = rep(seq(1,20,2),each = 2)
  )
  
  subdf = data.frame(
    x = rep(5,10)+100,
    y = c(-0.45,-0.45,-0.3,-0.45,
          -0.3,-0.3,-0.3,-0.3,
          -0.45,-0.45),
    label = paste0('(',letters[seq(1,20,2)],')'),
    group = seq(1,20,2)
  )
  subdf2 = data.frame(
    x = c(-0.55,-0.5,-0.4,-0.6,
          -0.4,-0.5,-0.4,-0.5,
          -0.5,-0.5),
    y = c(0.3,0.35,0.45,0.25,
          0.5,0.45,0.5,0.45,
          0.23,0.3),
    label = paste0('(',letters[seq(2,20,2)],')'),
    group = seq(2,20,2)
  )
  subdf = rbind(subdf,subdf2)
  ps8 = ggplot()+
    ############
    geom_line(data = dflin245m,
              aes(x = date,y = value,
                  color = variable),
              size = 1.5)+
    geom_point(data = df245,
               aes(x = TWS_OBS,y = TWS_PROJ,
                   color = type),
               shape = 1,
               size = 3)+
    geom_point(data = df245,
               aes(x = TWS_OBS,y = TWS_PROJ,
                   color = type),
               shape = 1,
               size = 3.25)+
    geom_point(data = df245,
               aes(x = TWS_OBS,y = TWS_PROJ,
                   color = type),
               shape = 1,
               size = 2.85)+
    geom_vline(data = dfabline1,
               aes(xintercept = x),
               size = 0.5,
               linetype = 'dashed',
               color = 'black')+
    geom_abline(data = dfabline2,
                aes(intercept = x,
                    slope = slope),
                size = 1,
                color = 'black')+
    geom_text(data = subdf,
              aes(x = x,y = y,label = label),
              color = 'black',
              size = 5,
              hjust = 0)+
    geom_text(data= dfcor245,
              aes(x = x,y = y,label = label),
              color = 'black',
              size = 4,
              hjust = 0)+
    geom_text(data= dfp245,
              aes(x = x,y = y,label = label),
              color = 'black',
              size = 4,
              hjust = 0)+
    geom_text(data= perioddf,
            aes(x = x,y = y,label = label),
            color = 'black',
            size = 4,
            hjust = 0.5)+
    geom_segment(data = pathdf,
                 aes(x = x,xend = xend,
                     y = y,yend = y),
                 color = 'black',
                 size = 0.5,
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'))+
    geom_segment(data = pathdf2,
                  aes(x = x,xend = x,
                      y = y,yend = yend),
                  color = 'black',
                  size = 0.5)+
    scale_color_manual(values = cols)+
    scale_x_continuous(breaks = 
                         c(seq(-0.5,0.5,0.25),
                           seq(101,262,50)),
                       labels = c(
                         seq(-0.5,0.5,0.25),
                         substr(date[seq(1,162,50)],
                                1,4)
                       ))+
    facet_wrap(~group,nrow = 5,scales = 'free')+
    theme_bw()
    ############
    
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  ps8 = ps8+text_theme_set+
    theme(
      strip.text = element_blank(),
      axis.title = element_blank()
    )+
    guides(color = guide_legend(nrow = 1,title = ''))
  
  dir.create('main_plot/SI/figS8')
  
  png('main_plot/SI/figS8/fig8.png',
      height = 25,
      width = 27,
      units = 'cm',
      res = 800)
  print(ps8)
  dev.off()
  
  ### 
  # Fig S9 validation and train period for ssp585
  ps9 = ggplot()+
    ############
  geom_line(data = dflin585m,
            aes(x = date,y = value,
                color = variable),
            size = 1.5)+
    geom_point(data = df585,
               aes(x = TWS_OBS,y = TWS_PROJ,
                   color = type),
               shape = 1,
               size = 3)+
    geom_point(data = df585,
               aes(x = TWS_OBS,y = TWS_PROJ,
                   color = type),
               shape = 1,
               size = 3.25)+
    geom_point(data = df585,
               aes(x = TWS_OBS,y = TWS_PROJ,
                   color = type),
               shape = 1,
               size = 2.85)+
    geom_vline(data = dfabline1,
               aes(xintercept = x),
               size = 0.5,
               linetype = 'dashed',
               color = 'black')+
    geom_abline(data = dfabline2,
                aes(intercept = x,
                    slope = slope),
                size = 1,
                color = 'black')+
    geom_text(data = subdf,
              aes(x = x,y = y,label = label),
              color = 'black',
              size = 5,
              hjust = 0)+
    geom_text(data= dfcor585,
              aes(x = x,y = y,label = label),
              color = 'black',
              size = 4,
              hjust = 0)+
    geom_text(data= dfp585,
              aes(x = x,y = y,label = label),
              color = 'black',
              size = 4,
              hjust = 0)+
    geom_text(data= perioddf,
              aes(x = x,y = y,label = label),
              color = 'black',
              size = 4,
              hjust = 0.5)+
    geom_segment(data = pathdf,
                 aes(x = x,xend = xend,
                     y = y,yend = y),
                 color = 'black',
                 size = 0.5,
                 arrow = arrow(angle=30,
                               unit('0.25','cm'),
                               type = 'closed'))+
    geom_segment(data = pathdf2,
                 aes(x = x,xend = x,
                     y = y,yend = yend),
                 color = 'black',
                 size = 0.5)+
    scale_color_manual(values = cols)+
    scale_x_continuous(breaks = 
                         c(seq(-0.5,0.5,0.25),
                           seq(101,262,50)),
                       labels = c(
                         seq(-0.5,0.5,0.25),
                         substr(date[seq(1,162,50)],
                                1,4)
                       ))+
    facet_wrap(~group,nrow = 5,scales = 'free')+
    theme_bw()
  ############
  
  
  fontsize = 12
  ##########
  text_theme_set = theme(
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
  )
  ##########
  ps9 = ps9+text_theme_set+
    theme(
      strip.text = element_blank(),
      axis.title = element_blank()
    )+
    guides(color = guide_legend(nrow = 1,title = ''))
  
  dir.create('main_plot/SI/figS9')
  
  png('main_plot/SI/figS9/figs9.png',
      height = 25,
      width = 27,
      units = 'cm',
      res = 800)
  print(ps9)
  dev.off()
  
  
  
  
  
  
  
  
}































filter_cmip6_data_to_date_sst <- function(
  attrs = 'SST'
){
  input_file = '/media/root/Shen_drive1/CMIP6_reorder'
  
  #attr = c('E','Pr','T')
  
  input_file = paste0(input_file,'/',attrs)
  
  input_his = paste0(input_file,'/historical')
  input_ssp245 = paste0(input_file,'/ssp245')
  input_ssp585 = paste0(input_file,'/ssp585')
  
  
  hist_files = list.files(input_his)
  hist_files_full = list.files(input_his,
                               full.names = T)
  
  ssp245_files = list.files(input_ssp245)
  ssp245_files_full = list.files(input_ssp245,full.names = T)
  
  ssp585_files = list.files(input_ssp585)
  ssp585_files_full = list.files(input_ssp585,full.names = T)
  
  i = 1:length(hist_files)
  
  #declare global variables
  i <<- i 
  hist_files <<- hist_files
  hist_files_full <<- hist_files_full
  ssp245_files <<- ssp245_files
  ssp245_files_full <<- ssp245_files_full
  ssp585_files <<- ssp585_files
  ssp585_files_full <<- ssp585_files_full
  
  dir.create('/media/root/Shen_drive1/CMIP6_2003')
  output = paste0('/media/root/Shen_drive1/CMIP6_2003',
                  '/',attrs)
  dir.create(output)
  
  output_his = paste0(output,'/hist')
  output_ssp245 = paste0(output,'/ssp245')
  output_ssp585 = paste0(output,'/ssp585')
  
  dir.create(output_his)
  dir.create(output_ssp245)
  dir.create(output_ssp585)
  
  output_his <<- output_his
  output_ssp245 <<- output_ssp245
  output_ssp585 <<- output_ssp585
  
  sub_filter_his <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    
    tmp = hist_files[i]
    tmpmode = strsplit(tmp,'_')[[1]][1]
    tmpname = strsplit(tmp,'_')[[1]][2]
    startdate = as.numeric(substr(strsplit(tmp,'_')[[1]][3],1,4))
    enddate = as.numeric(substr(strsplit(tmp,'_')[[1]][4],1,4))
    
    tmpfull = hist_files_full[i]
    tmps = try(stack(tmpfull),silent = T)
    if('try-error' %in% class(tmps)){
      tmps = fread(tmpfull)
      tmps = as.data.frame(tmps)
      
      loc = tmps[,1:2]
      tmps = tmps[,-c(1,2)]
      
      aim = length(startdate:2003)*12-11
      dim = ncol(tmps)
      
      tmps = tmps[,aim:dim]
      tmps = cbind(loc,tmps)
      
      output_name = paste0(tmpmode,'_',tmpname,'_','200301','_',enddate,'.csv')
      output_tmps = paste0(output_his,'/',output_name)
      
      fwrite(tmps,
             output_tmps)
    }else{
      aim = length(startdate:2003)*12-11
      dim = dim(tmps)[3]
      
      tmps = tmps[[aim:dim]]
      
      output_name = paste0(tmpmode,'_',tmpname,'_','200301','_',enddate,'.nc')
      output_tmps = paste0(output_his,'/',output_name)
      
      writeRaster(tmps,output_tmps,format='CDF',overwrite = T)
      
    }
    
    
  }
  
  sub_filter_ssp245 <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    
    tmp = ssp245_files[i]
    tmpmode = strsplit(tmp,'_')[[1]][1]
    tmpname = strsplit(tmp,'_')[[1]][2]
    startdate = as.numeric(substr(strsplit(tmp,'_')[[1]][3],1,4))
    enddate = as.numeric(substr(strsplit(tmp,'_')[[1]][4],1,4))
    
    tmpfull = ssp245_files_full[i]
    tmps = try(stack(tmpfull),silent = T)
    
    if('try-error' %in% class(tmps)){
      tmps = fread(tmpfull)
      tmps = as.data.frame(tmps)
      
      loc = tmps[,1:2]
      tmps = tmps[,-c(1,2)]
      
      aim = length(startdate:2050)*12
      tmps = tmps[,1:aim]
      
      output_name = paste0(tmpmode,'_',tmpname,'_',startdate,'_',2050,'.csv')
      output_tmps = paste0(output_ssp245,'/',output_name)
      
      tmps = cbind(loc,tmps)
      fwrite(tmps,output_tmps)
      
    }else{
      aim = length(startdate:2050)*12
      tmps = tmps[[1:aim]]
      
      output_name = paste0(tmpmode,'_',tmpname,'_',startdate,'_',2050,'.nc')
      output_tmps = paste0(output_ssp245,'/',output_name)
      
      writeRaster(tmps,output_tmps,format='CDF',overwrite = T)
      
    }
    
    
    
  }
  
  sub_filter_ssp585 <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    
    tmp = ssp585_files[i]
    tmpmode = strsplit(tmp,'_')[[1]][1]
    tmpname = strsplit(tmp,'_')[[1]][2]
    startdate = as.numeric(substr(strsplit(tmp,'_')[[1]][3],1,4))
    enddate = as.numeric(substr(strsplit(tmp,'_')[[1]][4],1,4))
    
    tmpfull = ssp585_files_full[i]
    tmps = try(stack(tmpfull),silent = T)
    
    if('try-error' %in% class(tmps)){
      tmps = fread(tmpfull)
      tmps = as.data.frame(tmps)
      loc = tmps[,1:2]
      tmps = tmps[,-c(1,2)]
      
      aim = length(startdate:2050)*12
      tmps = tmps[,1:aim]
      
      tmps = cbind(loc,tmps)
      output_name = paste0(tmpmode,'_',tmpname,'_',startdate,'_',2050,'.csv')
      output_tmps = paste0(output_ssp585,'/',output_name)
      
      fwrite(tmps,output_tmps)
      
    }else{
      aim = length(startdate:2050)*12
      
      tmps = tmps[[1:aim]]
      
      output_name = paste0(tmpmode,'_',tmpname,'_',startdate,'_',2050,'.nc')
      output_tmps = paste0(output_ssp585,'/',output_name)
      
      writeRaster(tmps,output_tmps,format='CDF',overwrite = T)
      
    }
    
    
  }
  
  
  
  library(doParallel)
  print('hist start')
  cl = makeCluster(8)
  clusterExport(cl,c("hist_files","hist_files_full",'i','output_his'))
  system.time(parLapply(cl,i,sub_filter_his))
  stopCluster(cl)
  
  print('ssp245 start')
  cl = makeCluster(8)
  clusterExport(cl,c("ssp245_files","ssp245_files_full",'i','output_ssp245'))
  system.time(parLapply(cl,i,sub_filter_ssp245))
  stopCluster(cl)
  
  print('ssp585 start')
  cl = makeCluster(8)
  clusterExport(cl,c("ssp585_files","ssp585_files_full",'i','output_ssp585'))
  system.time(parLapply(cl,i,sub_filter_ssp585))
  stopCluster(cl)
  
  print(paste0('pass','_',attrs))
  
}
filter_cmip6_data_to_date <- function(
  attrs = 'E'
){
  input_file = '/media/root/Shen_drive1/CMIP6_reorder'
  
  #attr = c('E','Pr','T')
  
  input_file = paste0(input_file,'/',attrs)
  
  input_his = paste0(input_file,'/historical')
  input_ssp245 = paste0(input_file,'/ssp245')
  input_ssp585 = paste0(input_file,'/ssp585')
  
  
  hist_files = list.files(input_his)
  hist_files_full = list.files(input_his,full.names = T)
  
  ssp245_files = list.files(input_ssp245)
  ssp245_files_full = list.files(input_ssp245,full.names = T)
  
  ssp585_files = list.files(input_ssp585)
  ssp585_files_full = list.files(input_ssp585,full.names = T)
  
  i = 1:length(hist_files)
  
  #declare global variables
  i <<- i 
  hist_files <<- hist_files
  hist_files_full <<- hist_files_full
  ssp245_files <<- ssp245_files
  ssp245_files_full <<- ssp245_files_full
  ssp585_files <<- ssp585_files
  ssp585_files_full <<- ssp585_files_full
  
  dir.create('/media/root/Shen_drive1/CMIP6_2003')
  output = paste0('/media/root/Shen_drive1/CMIP6_2003',
                  '/',attrs)
  dir.create(output)
  
  output_his = paste0(output,'/hist')
  output_ssp245 = paste0(output,'/ssp245')
  output_ssp585 = paste0(output,'/ssp585')
  
  dir.create(output_his)
  dir.create(output_ssp245)
  dir.create(output_ssp585)
  
  output_his <<- output_his
  output_ssp245 <<- output_ssp245
  output_ssp585 <<- output_ssp585
  
  sub_filter_his <- function(i){
    library(raster)
    library(ncdf4)
    
    tmp = hist_files[i]
    tmpmode = strsplit(tmp,'_')[[1]][1]
    tmpname = strsplit(tmp,'_')[[1]][2]
    startdate = as.numeric(substr(strsplit(tmp,'_')[[1]][3],1,4))
    enddate = as.numeric(substr(strsplit(tmp,'_')[[1]][4],1,4))
    
    tmpfull = hist_files_full[i]
    tmps = stack(tmpfull)
    
    aim = length(startdate:2003)*12-11
    dim = dim(tmps)[3]
    
    tmps = tmps[[aim:dim]]
    
    output_name = paste0(tmpmode,'_',tmpname,'_','200301','_',enddate,'.nc')
    output_tmps = paste0(output_his,'/',output_name)
    
    writeRaster(tmps,output_tmps,format='CDF',overwrite = T)
    
  }
  
  sub_filter_ssp245 <- function(i){
    library(raster)
    library(ncdf4)
    
    tmp = ssp245_files[i]
    tmpmode = strsplit(tmp,'_')[[1]][1]
    tmpname = strsplit(tmp,'_')[[1]][2]
    startdate = as.numeric(substr(strsplit(tmp,'_')[[1]][3],1,4))
    enddate = as.numeric(substr(strsplit(tmp,'_')[[1]][4],1,4))
    
    tmpfull = ssp245_files_full[i]
    tmps = stack(tmpfull)
    
    aim = length(startdate:2050)*12
    tmps = tmps[[1:aim]]
    
    output_name = paste0(tmpmode,'_',tmpname,'_',startdate,'_',2050,'.nc')
    output_tmps = paste0(output_ssp245,'/',output_name)
    
    writeRaster(tmps,output_tmps,format='CDF',overwrite = T)
    
  }
  
  sub_filter_ssp585 <- function(i){
    library(raster)
    library(ncdf4)
    
    tmp = ssp585_files[i]
    tmpmode = strsplit(tmp,'_')[[1]][1]
    tmpname = strsplit(tmp,'_')[[1]][2]
    startdate = as.numeric(substr(strsplit(tmp,'_')[[1]][3],1,4))
    enddate = as.numeric(substr(strsplit(tmp,'_')[[1]][4],1,4))
    
    tmpfull = ssp585_files_full[i]
    tmps = stack(tmpfull)
    
    aim = length(startdate:2050)*12
    
    tmps = tmps[[1:aim]]
    
    output_name = paste0(tmpmode,'_',tmpname,'_',startdate,'_',2050,'.nc')
    output_tmps = paste0(output_ssp585,'/',output_name)
    
    writeRaster(tmps,output_tmps,format='CDF',overwrite = T)
    
  }
  
  
  
  library(doParallel)
  #cl = makeCluster(8)
  #clusterExport(cl,c("hist_files","hist_files_full",'i','output_his'))
  #system.time(parLapply(cl,i,sub_filter_his))
  #stopCluster(cl)
  
  #cl = makeCluster(8)
  #clusterExport(cl,c("ssp245_files","ssp245_files_full",'i','output_ssp245'))
  #system.time(parLapply(cl,i,sub_filter_ssp245))
  #stopCluster(cl)
  
  
  cl = makeCluster(8)
  clusterExport(cl,c("ssp585_files","ssp585_files_full",'i','output_ssp585'))
  system.time(parLapply(cl,i,sub_filter_ssp585))
  stopCluster(cl)
  
  print(paste0('pass','_',attrs))
  
}
find_not_in_index <- function(
  input_sub
){

  df = fread(paste0(input_sub,'/var_whole_route_mid.csv'))
  
  mask_id_land_p = list.files(paste0(input_sub,'/df_first_land'),full.names = T)
  mask_id_ocean_p = list.files(paste0(input_sub,'/df_first_ocean'),full.names = T)
  
  import_id_mask <- function(x){
    tmp = read.csv(x,header = T)
    tmp = tmp[,-1]
    return(tmp)
  }
  id_land = lapply(mask_id_land_p,import_id_mask)
  id_ocean = lapply(mask_id_ocean_p,import_id_mask)
  
  id_land = do.call('c',id_land)
  id_ocean = do.call('c',id_ocean)
  
  
  ids =c(id_land,id_ocean)
  ids = sort(ids)
  xfull <<- df$type
  df_fullid <<- df$type
  group_id <- function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  idsl = group_id(ids)
  source('/home/share/R_project/xinjiang_vapor/search_which_not_in.R')
  system.time(ret_full_id <- lapply(idsl, search_which_not_in))
  ret_full_id = do.call('c',ret_full_id)
  
  df_re_lack = df[ret_full_id,]
  
  output_path = paste0(input_sub,'/masked_var_whole_route_mid.csv')
  fwrite(df_re_lack,output_path)
}
find_peak_valley_p_trial <-function(
  index,
  tell_final = 0.01
){
  
  
  
  index = as.numeric(index)
  # 1. select #points by slope initially
  source('/home/share/R_project/xinjiang_vapor/slope_select.R')
  tp_box = slope_select(index)
  
  #plot(index)
  ##points(tp_box,index[tp_box],col = 'red')#
  #break
  #return(tp_box);break
  #break
  
  ##print(length(tp_box))
  index_tp = index[tp_box]
  tp_box2 = tp_box
  
  id_list = list()
  for(i in 1:length(tp_box)){
    temp_id = tp_box[i]
    id_group = 1
    for(j in 1:length(tp_box2)){
      temp_id2 = tp_box2[j]
      diff = abs(temp_id2 -temp_id)
      
      if(diff <= 2 & diff !=0){
        id_group =c(id_group,tp_box2[j])
      }
    } 
    id_group = id_group[-1]
    
    if(length(id_group)>0){
      id_group = c(temp_id,id_group)  
      id_group = sort(id_group)
      id_list[[i]] = id_group
    }
  }
  
  if(length(id_list) ==0){
    
  }else{
    re_id_box = 1
    id_keep = 1
    for(i in 1:length(id_list)){
      temp_id = id_list[[i]]
      ##print(temp_id)
      if(length(temp_id)==0){
        
      }else if(length(temp_id)==2){
        if(temp_id[1]>2){
          index_1 = index[temp_id[1]-2]
          index_2 = index[temp_id[1]]
          index_3 = index[temp_id[2]]
          index_4 = index[temp_id[2]+2]
          
          diff32 = index_3 - index_2
          diff41 = index_4 - index_1
          diff = diff41/diff32
          
          
          if(diff < 0 & abs(diff) >1 & abs(index_4)>abs(index_2)){
            re_id_box = c(re_id_box,temp_id)
          }else{
            
          }
        }
        
        
      }else{
        index_temp = index[temp_id]
        mean_box = mean(index_temp)
        diff = abs(index_temp - mean_box)
        
        temp_loc = which(diff == max(diff))
        temp_id = temp_id[temp_loc]
        id_keep = c(id_keep,temp_id)
        ###print(id_keep)
      }
      
    }
    
    re_id_box = re_id_box[-1]
    re_id_box = unique(re_id_box)
    id_keep = id_keep[-1]
    id_keep = unique(id_keep)
    #return(id_list)
    #(re_id_box);break
    
    re_keep_box = 1
    for(i in 1:length(re_id_box)){
      temp_re = which(id_keep == re_id_box[i])
      re_keep_box =c(re_keep_box,temp_re)
    }
    
    re_keep_box = re_keep_box[-1]
    id_keep = id_keep[-re_keep_box]
    
    #print(id_keep)
    ##print(re_id_box)
    
    re_box = 1
    for(i in 1:length(re_id_box)){
      temp_re = which(tp_box == re_id_box[i])
      re_box = c(re_box,temp_re)
    }
    re_box = re_box[-1]
    print(tp_box[re_box])
    ##print(re_box)
    #tp_box = tp_box[-re_box]
    
    #plot(index,type = 'b')
    #points(tp_box,index[tp_box],col = 'red')
    tp_box2 = tp_box
    #print(tp_box)
    #print(re_box)
    #break
    
    re_too_close = 1
    for(i in 1:(length(tp_box)-1)){
      
      tell = abs(index[tp_box[i]]-index[tp_box[i+1]])
      #print(tell)
      if(tell <tell_final){
        re_too_close = c(re_too_close,i)
      }
      
    }
    #print(re_too_close)
    #plot(index,type='l')
    #points(tp_box,index[tp_box],col = 'red',cex = 2)
    
    re_too_close = re_too_close[-1]
    if(length(re_too_close) !=0){
      #print(re_too_close)
      tp_box = tp_box[-re_too_close]
      
    }
    ##print(tp_box)
    ##print(tp_box2)
  }
  
  #plot(index,type='l')
  #points(tp_box,index[tp_box],col = 'red',cex = 2)
  
  
  return(tp_box)
  
}




























generate_sub_windows<-function(
  
){
  # aim 
  # to pursure the routes of terrestrial water storage
  
  
  latex = seq(30,60,10)
  longex = seq(-20,100,20)
  
  latex_start = latex[1:3]
  latex_end = latex[2:4]
  
  longex_start = longex[1:6]
  longex_end = longex[2:7]
  
  ex_li = list()
  
  for(i in 1:6){
    longextmp = c(longex_start[i],
               longex_end[i])
    tmp_li1 = list()
    for(j in 1:3){
      lat_start = latex_start[j]
      lat_end = latex_end[j]
      tmpextent = c(longextmp,lat_start,lat_end)
      tmpextent = extent(tmpextent)
      tmppoly  = as(tmpextent,'SpatialPolygons')
      tmp_li1[j] = tmppoly
    }
    
    ex_li = c(ex_li,tmp_li1)
  }
  
  output_poly = 'sub_windows'
  dir.create(output_poly)
  num = 1:length(ex_li)
  output_poly = paste0(output_poly,'/sub_window',num,'.shp')
  
  for(i in 1:length(ex_li)){
    print(i)
    shapefile(ex_li[[i]],filename = output_poly[i],overwrite = T)
  }
  
  # adding shp gansu hexi zoulang
  
  ex_add = extent(100,120,35,45)
  ex_add = as(ex_add,'SpatialPolygons')
  shapefile(ex_add,'sub_windows/sub_window19.shp',
            overwrite = T)
  
  
  
  
  
  
}
gpcc_pr_in_xinjiang <- function(
  mode = 'trend'
){
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  gpcc = data_management(mode = 'gpcc')
  
  gpcc_pr = 1
  
  for(i in 1:dim(gpcc)[3]){
    tmpmean = cellStats(gpcc[[i]],'mean')
    gpcc_pr = c(gpcc_pr,tmpmean)
  }
  gpcc_pr = gpcc_pr[-1]
  
  if(mode == 'trend'){
    gpcc_pr_trend = trend_index(gpcc_pr,c(2003,1),fre =12)
  }else{
    gpcc_pr_trend = gpcc_pr
  }
  
  
  return(gpcc_pr_trend)
  
    
}
gpcc_season_analysis<-function(
  
){
  
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  gpcc = data_management(mode = 'gpcc')
  
  gpcc_pr = 1
  
  for(i in 1:dim(gpcc)[3]){
    tmpmean = cellStats(gpcc[[i]],'mean')
    gpcc_pr = c(gpcc_pr,tmpmean)
  }
  gpcc_pr = gpcc_pr[-1]
  
  gpcc_pr_mon = matrix(gpcc_pr,nrow = 12)
  
  mon_mean_fun<-function(x){
    xm = mean(x,na.rm = T)
    return(xm)
  }
  gpcc_pr_mon_pattern = apply(gpcc_pr_mon,1,mon_mean_fun)
  
}
group_matrix_by_id<-function(x){ # df_xinjiang as input
  step = nrow(x)/100
  ids = round(seq(1,nrow(x),step))
  ide = ids -1
  ide = ide[-1]
  ide = c(ide,nrow(x))
  
  # ide position to value{
  for(i in 1:(length(ide)-1)){
    tmpid = ide[i]
    tmptype = x[tmpid,]$type
    typeid = which(x$type == tmptype)
    print(typeid)
    typeidmax = max(typeid)
    if(typeidmax>tmpid){
      ide[i] = typeidmax
      ids[i+1] = ide[i]+1
    }
  }
  li = list()
  for(i in 1:length(ide)){
    tmps= ids[i]
    tmpe = ide[i]
    li[[i]]= x[tmps:tmpe,]
  }
  return(li)
}
gws_in_xinjiang <- function(
  mode = 'trend'
){
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  gws = data_management(mode = 'grace')
  
  gws_meanb = 1
  for(i in 1:dim(gws)[[3]]){
    tmp = cellStats(gws[[i]],'mean')
    gws_meanb = c(gws_meanb,tmp)
  }
  gws_meanb = gws_meanb[-1]
  
  gws_mean = gws_meanb
  
  if(mode == 'trend'){
    gws_mean_trend = trend_index(gws_mean,start = c(2003,1),fre=12)
  }else{
    gws_mean_trend = gws_mean
  }
  
  
  return(gws_mean_trend)
}
import_cmip6_combined<-function(
  mode = 'hist_ssp245',
  var = 'E',
  model_name
){
  input = '/media/root/Shen_drive1/CMIP6_combined/'
  input = paste0(input,'/',var)
  input = paste0(input,'/',mode)
  
  input =list.files(input,full.names = T)
  
  models = c('ACCESS-ESM1-5','BCC-CSM2-MR',
                 'CanESM5','GFDL-ESM4','IPSL-CM6A-LR',
                 'MIROC6','MRI-ESM2-0','NorESM2-LM')
  
  id = which(models == model_name)
  print(model_name)
  ncfile = stack(input[id])
  return(ncfile)
  
}
import_importance_data_figs1011<-function(
  
){
  input245 = 'analysis_output/figS8-11/import_ssp245'
  input585 = 'analysis_output/figS8-11/import_ssp585'
  
  files = paste0('SW',1:10,'.csv')
  
  input245 = paste0(input245,'/',files)
  input585 = paste0(input585,'/',files)
  
  imp245 = 1
  imp585 = 1
  
  SWs = paste0('SW',1:10)
  for(i in 1:length(input245)){
    tmp245 = as.data.frame(fread(input245[i]))[,2]
    tmp585 = as.data.frame(fread(input585[i]))[,2]
    
    tmp245 = data.frame(
      PME = c('PME1','PME3'),
      SWs = SWs[i],
      IncNodePurity=tmp245
    )
    tmp585 = data.frame(
      PME = c('PME1','PME3'),
      SWs = SWs[i],
      IncNodePurity = tmp585
    )
    
    imp245 = rbind(imp245,tmp245)
    imp585 = rbind(imp585,tmp585)
    
  }
  imp245 = imp245[-1,]
  imp585 = imp585[-1,]
  
  return(list(imp245,imp585))
}
import_IncMSE_data_figs1011<-function(
  
){
  input245 = 'analysis_output/figS8-11/import_ssp245'
  input585 = 'analysis_output/figS8-11/import_ssp585'
  
  files = paste0('SW',1:10,'.csv')
  
  input245 = paste0(input245,'/',files)
  input585 = paste0(input585,'/',files)
  
  imp245 = 1
  imp585 = 1
  
  SWs = paste0('SW',1:10)
  for(i in 1:length(input245)){
    tmp245 = as.data.frame(fread(input245[i]))[,1]*100
    tmp585 = as.data.frame(fread(input585[i]))[,1]*100
    
    tmp245 = data.frame(
      PME = c('PME1','PME3'),
      SWs = SWs[i],
      IncMSE=tmp245
    )
    tmp585 = data.frame(
      PME = c('PME1','PME3'),
      SWs = SWs[i],
      IncMSE = tmp585
    )
    
    imp245 = rbind(imp245,tmp245)
    imp585 = rbind(imp585,tmp585)
    
  }
  imp245 = imp245[-1,]
  imp585 = imp585[-1,]
  
  return(list(imp245,imp585))
}
import_pe_in_source <-function(
  input = 'era5_pe_mean',
  name = 'era5_pe_sum.csv'
){
  
  mode = c('as','ato','eu')
  
  input = paste0(input,'/',rep(mode,each = 4))
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/',name)
  
  tmpb = 1
  for(i in 1:length(input)){
    tmp = fread(input[i])
    tmp = as.data.frame(tmp)
    tmpb = cbind(tmpb,tmp)
  }
  
  tmpb = tmpb[,-1]
  colnames(tmpb) = paste0('pr',1:12)
  
  return(tmpb)
  
}
import_pme_ato_fig4<-function(
  year = T
){
  
  input_sst = list.files('analysis_output/cmip6_by_model/sst',
                         full.names = T)
  input_pme = list.files('analysis_output/cmip6_by_model/pme',
                         full.names = T)
  
  
  
  sst = lapply(lapply(input_sst,fread),as.data.frame)
  pme = lapply(lapply(input_pme,fread),as.data.frame)
  
  sst_trend = sst
  pme_trend = pme
  
  sst1_ssp245 = sst_trend[[1]]
  sst1_ssp585 = sst_trend[[2]]
  sst3_ssp245 = sst_trend[[3]]
  sst3_ssp585 = sst_trend[[4]]
  
  pme1_ssp245 = pme_trend[[1]]
  pme1_ssp585 = pme_trend[[2]]
  pme3_ssp245 = pme_trend[[3]]
  pme3_ssp585 = pme_trend[[4]]
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(sst1_ssp245) = modelnames
  colnames(sst1_ssp585) = modelnames
  colnames(sst3_ssp245) = modelnames
  colnames(sst3_ssp585) = modelnames
  
  colnames(pme1_ssp245) = modelnames
  colnames(pme1_ssp585) = modelnames
  colnames(pme3_ssp245) = modelnames
  colnames(pme3_ssp585) = modelnames
  
  trend_fun <- function(x){
    
    sub_fun <-function(x){
      x = ts(x,start = c(2003,1),
             frequency = 12)
      x = decompose(x)$trend
      
      xt = as.numeric(x)
      stand_fun <-function(y){
        y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
      }
      xy  = stand_fun(xt)
      return(xy)
    }
    xm = apply(x,2,sub_fun)
    return(xm)
  }
  
  pme1_pj245 = pme1_ssp245[175:576,]
  pme3_pj245 = pme3_ssp245[175:576,]
  sst1_pj245 = sst1_ssp245[175:576,]
  sst3_pj245 = sst3_ssp245[175:576,]
  
  pme1_pj245 = trend_fun(pme1_pj245)
  pme3_pj245 = trend_fun(pme3_pj245)
  sst1_pj245 = trend_fun(sst1_pj245)
  sst3_pj245 = trend_fun(sst3_pj245)
  
  naid = which(is.na(pme1_pj245[,1]))
  naidfut <<- naid
  
  pme1_pj245 = pme1_pj245[-naid,]
  pme3_pj245 = pme3_pj245[-naid,]
  sst1_pj245 = sst1_pj245[-naid,]
  sst3_pj245 = sst3_pj245[-naid,]
  
  pme1_pj585 = pme1_ssp585[175:576,]
  pme3_pj585 = pme3_ssp585[175:576,]
  sst1_pj585 = sst1_ssp585[175:576,]
  sst3_pj585 = sst3_ssp585[175:576,]
  
  pme1_pj585 = trend_fun(pme1_pj585)
  pme3_pj585 = trend_fun(pme3_pj585)
  sst1_pj585 = trend_fun(sst1_pj585)
  sst3_pj585 = trend_fun(sst3_pj585)
  
  naidfut = which(is.na(pme1_pj585[,1]))
  naidfut <<- naidfut
  
  pme1_pj585 = pme1_pj585[-naidfut,]
  pme3_pj585 = pme3_pj585[-naidfut,]
  sst1_pj585 = sst1_pj585[-naidfut,]
  sst3_pj585 = sst3_pj585[-naidfut,]
  
  to_year_ato <- function(x){
    x = c(x,rep(NA ,6))
    xm = matrix(x,nrow = 12)
    xm = apply(xm,2,sum,na.rm = T)
    #stand_fun <- function(x){
    #  xm = (x -mean(x,na.rm = T))/(max(x,na.rm = T)-min(x,na.rm = T))
    #}
    #xm = stand_fun(xm)
    return(xm)
  }
  
  if(year){
    pme1_pj585 = apply(pme1_pj585,2,to_year_ato)
    pme3_pj585 = apply(pme3_pj585,2,to_year_ato)
    sst1_pj585 = apply(sst1_pj585,2,to_year_ato)
    sst3_pj585 = apply(sst3_pj585,2,to_year_ato)
    
    pme1_pj245 = apply(pme1_pj245,2,to_year_ato)
    pme3_pj245 = apply(pme3_pj245,2,to_year_ato)
    sst1_pj245 = apply(sst1_pj245,2,to_year_ato)
    sst3_pj245 = apply(sst3_pj245,2,to_year_ato)
    
    pme1_pj245m = apply(pme1_pj245,1,mean)
    pme3_pj245m = apply(pme3_pj245,1,mean)
    pme1_pj585m = apply(pme1_pj585,1,mean)
    pme3_pj585m = apply(pme3_pj585,1,mean)
    
    
    df = data.frame(
      date = 2018:2050,
      SSP245_PME1 = pme1_pj245m,
      SSP245_PME3 = pme3_pj245m,
      SSP585_PME1 = pme1_pj585m,
      SSP585_PME3 = pme3_pj585m
    )
    
  }else{
    pme1_pj245m = apply(pme1_pj245,1,mean)
    pme3_pj245m = apply(pme3_pj245,1,mean)
    pme1_pj585m = apply(pme1_pj585,1,mean)
    pme3_pj585m = apply(pme3_pj585,1,mean)
    
    
    df = data.frame(
      date = seq(as.Date('2018-01-01'),
                 as.Date('2050-06-01'),
                 '1 month'),
      SSP245_PME1 = pme1_pj245m,
      SSP245_PME3 = pme3_pj245m,
      SSP585_PME1 = pme1_pj585m,
      SSP585_PME3 = pme3_pj585m
    )
  }
  
  
  df = reshape2::melt(df,'date')
  colnames(df) = c('date','type',"value")
 
  
  return(df)
}
import_project_tws_subs <- function(
  input,
  year = T
){
  library(data.table)
  files = paste0(input,'/SW',1:10,'.csv')
  ptws = lapply(lapply(files,fread),
                as.data.frame)
  
  cor_mat = fread('analysis_output/fig4/train_cor_tws.csv')
  cor_mat = as.data.frame(cor_mat)
  cor_mat <<- cor_mat

  ptws <<- ptws
  type = paste0('SW',1:10)
  type <<- type
  i = 1:10
  process_mean_fun <- function(i){
    tmp = ptws[[i]]
    date = seq(as.Date('2018-01-01'),
               as.Date('2050-06-01'),
               '1 month')
    tmp = tmp[,-1]
    
    tmpcor= cor_mat[,i]
    id = which(tmpcor>0.5)
    tmp = tmp[,id]
    tmp = apply(tmp,1,mean,na.rm = T)
    
    tmpdf = data.frame(
      date = date,
      tws = as.numeric(tmp),
      type= type[i]
    )
    
  }
  process_max_fun <- function(i){
    tmp = ptws[[i]]
    date = seq(as.Date('2018-01-01'),
               as.Date('2050-06-01'),
               '1 month')
    tmp = tmp[,-1]
    
    tmpcor= cor_mat[,i]
    id = which(tmpcor>0.5)
    tmp = tmp[,id]
    tmp = apply(tmp,1,max,na.rm = T)
    
    tmpdf = data.frame(
      date = date,
      tws = as.numeric(tmp),
      type= type[i]
    )
    
  }
  process_min_fun <- function(i){
    tmp = ptws[[i]]
    date = seq(as.Date('2018-01-01'),
               as.Date('2050-06-01'),
               '1 month')
    tmp = tmp[,-1]
    
    tmpcor= cor_mat[,i]
    id = which(tmpcor>0.5)
    tmp = tmp[,id]
    tmp = apply(tmp,1,min,na.rm = T)
    
    tmpdf = data.frame(
      date = date,
      tws = as.numeric(tmp),
      type= type[i]
    )
    
  }
  
  to_year <- function(x){
    x1 = c(x[,2],rep(NA,6))
    xm = matrix(x1,nrow = 12)
    xm = apply(xm,2,mean,na.rm = T)
    year = 2018:2050
    type = x[,3][1]
    xm = data.frame(
      date = year,
      tws = xm,
      type = type
    )
    return(xm)
  }
  
  ptws_mean = lapply(i,process_mean_fun)
  ptws_min = lapply(i,process_min_fun)
  ptws_max = lapply(i,process_max_fun)
  
  ptws_year_mean = lapply(ptws_mean,to_year)
  ptws_year_min = lapply(ptws_min,to_year)
  ptws_year_max = lapply(ptws_max,to_year)
  
  ptws_mean = do.call('rbind',ptws_mean)
  ptws_min = do.call('rbind',ptws_min)
  ptws_max = do.call('rbind',ptws_max)
  
  ptws_year_mean = do.call('rbind',
                           ptws_year_mean)
  ptws_year_max = do.call('rbind',
                          ptws_year_max)
  ptws_year_min = do.call('rbind',
                          ptws_year_min)
  
  ptws_year_maxmin = data.frame(
    date = ptws_year_max$date,
    max = ptws_year_max$tws,
    min = ptws_year_min$tws,
    type = ptws_year_min$type
  )
  
  ptwsmaxmin = data.frame(
    date = ptws_max$date,
    max = ptws_max$tws,
    min = ptws_min$tws,
    type = ptws_max$type
  )
  
  type = paste0('SW',1:10)
  ptws_mean$type = factor(ptws_mean$type,
                          levels = type)
  ptwsmaxmin$type = factor(ptwsmaxmin$type,
                           levels = type)
  
  ptws_year_mean$type = factor(ptws_year_mean$type,
                               levels = type)
  ptws_year_maxmin$type = factor(ptws_year_maxmin$type,
                                 levels = type)
  if(year){
    return(list(ptws_year_mean,
                ptws_year_maxmin))
  }else{
    return(list(ptws_mean,
                ptwsmaxmin))
  }
  
  
  
}
import_validate_pme_cmip6 <-function(
  
){
  
  input_pme = 'analysis_output/fig4/pme'
  input_pme_train = list.files(input_pme,
                               full.names = T,
                               pattern = '*train.csv$')
  input_pme_test = list.files(input_pme,
                              full.names = T,
                              pattern = '*test.csv$')
  input_pme_fut = list.files(input_pme,
                             full.names = T,
                             pattern = '*proj.csv$')
  
  pme_train = lapply(lapply(input_pme_train,fread),
                     as.data.frame)
  pme_test = lapply(lapply(input_pme_test,fread),
                    as.data.frame)
  pme_fut = lapply(lapply(input_pme_fut,fread),
                   as.data.frame)
  
  
  remove_abundant_info_train_test <-function(x){
    x = x[,-c(1,2)]
    return(x)
  }
  remove_abundant_info_fut <-function(x){
    x = x[,-1]
    return(x)
  }
  
  pme_train = lapply(pme_train,remove_abundant_info_train_test)
  pme_test = lapply(pme_test,remove_abundant_info_train_test)
  pme_fut = lapply(pme_fut,remove_abundant_info_fut)
  
  pmeli = list()
  for(i in 1:length(pme_train)){
    tmp1 = pme_train[[i]]
    tmp2 = pme_test[[i]]
    tmp3 = pme_fut[[i]]
    modelnames = c('ACCESS-ESM1-5',
                   'BCC-CSM2-MR',
                   'CanESM5',
                   'GFDL-ESM4',
                   'IPSL-CM6A-LR',
                   'MIROC6',
                   'MRI-ESM2-0',
                   'NorESM2-LM')
    colnames(tmp1) = modelnames
    colnames(tmp2) = modelnames
    colnames(tmp3) = modelnames
    
    tmp = rbind(tmp1,tmp2,tmp3)
    colnames(tmp) = modelnames
    pmeli[[i]] = tmp
  }
  return(pmeli)
}
import_validate_sst <-function(
  
){
  
  input_sst = 'analysis_output/fig4/sst'
  input_sst_train = list.files(input_sst,
                               full.names = T,
                               pattern = '*train.csv$')
  input_sst_test = list.files(input_sst,
                              full.names = T,
                              pattern = '*test.csv$')
  input_sst_fut = list.files(input_sst,
                             full.names = T,
                             pattern = '*proj.csv$')
  
  sst_train = lapply(lapply(input_sst_train,fread),
                     as.data.frame)
  sst_test = lapply(lapply(input_sst_test,fread),
                    as.data.frame)
  sst_fut = lapply(lapply(input_sst_fut,fread),
                   as.data.frame)
  
  
  remove_abundant_info_train_test <-function(x){
    x = x[,-c(1,2)]
    return(x)
  }
  remove_abundant_info_fut <-function(x){
    x = x[,-1]
    return(x)
  }
  
  sst_train = lapply(sst_train,remove_abundant_info_train_test)
  sst_test = lapply(sst_test,remove_abundant_info_train_test)
  sst_fut = lapply(sst_fut,remove_abundant_info_fut)
  
  sstli = list()
  for(i in 1:length(sst_train)){
    tmp1 = sst_train[[i]]
    tmp2 = sst_test[[i]]
    tmp3 = sst_fut[[i]]
    modelnames = c('ACCESS-ESM1-5',
                   'BCC-CSM2-MR',
                   'CanESM5',
                   'GFDL-ESM4',
                   'IPSL-CM6A-LR',
                   'MIROC6',
                   'MRI-ESM2-0',
                   'NorESM2-LM')
    
    colnames(tmp1) = modelnames
    colnames(tmp2) = modelnames
    colnames(tmp3) = modelnames
    
    tmp = rbind(tmp1,tmp2,tmp3)
    colnames(tmp) = modelnames
    tmp = tmp - 273.15
    sstli[[i]] = tmp
  }
  return(sstli)
}
import_validate_tws_sws245 <- function(
  
){
  input_valid = 'analysis_output/figS8-11/valid_ssp245'
  input_train = 'analysis_output/figS8-11/train_ssp245'
  
  files = paste0('SW',1:10,'.csv')
  input_valid = paste0(input_valid,'/',files)
  input_train = paste0(input_train,'/',files)
  
  ret_com = 1
  cor_box = 1
  for(i in 1:length(input_valid)){
    tmpval = as.data.frame(fread(input_valid[i]))
    tmptrain = as.data.frame(fread(input_train[i]))
    
    tmpval$type = 'Validation'
    tmptrain$type = 'Train'
    
    tmpcombine = rbind(tmptrain,tmpval)
    tmpcor = cor(tmpcombine[,1],tmpcombine[,2])
    cor_box = c(cor_box,tmpcor)
    ret_com = rbind(ret_com,tmpcombine)
  }
  ret_com = ret_com[-1,]
  cor_box = cor_box[-1]
  cor_box = data.frame(
    SWs = paste0('SW',1:10),
    Cor = cor_box
  )
  
  return(list(ret_com,cor_box))
} 
import_validate_tws_sws585 <- function(
  
){
  input_valid = 'analysis_output/figS8-11/valid_ssp585'
  input_train = 'analysis_output/figS8-11/train_ssp585'
  
  files = paste0('SW',1:10,'.csv')
  input_valid = paste0(input_valid,'/',files)
  input_train = paste0(input_train,'/',files)
  
  ret_com = 1
  cor_box = 1
  for(i in 1:length(input_valid)){
    tmpval = as.data.frame(fread(input_valid[i]))
    tmptrain = as.data.frame(fread(input_train[i]))
    
    tmpval$type = 'Validation'
    tmptrain$type = 'Train'
    
    tmpcombine = rbind(tmptrain,tmpval)
    tmpcor = cor(tmpcombine[,1],tmpcombine[,2])
    cor_box = c(cor_box,tmpcor)
    
    ret_com = rbind(ret_com,tmpcombine)
  }
  ret_com = ret_com[-1,]
  cor_box = cor_box[-1]
  cor_box = data.frame(
    SWs = paste0('SW',1:10),
    Cor = cor_box
  )
  
  return(list(ret_com,cor_box))
} 
kriging <- function(
  df,
  resolution = 1
){
  library(rgdal)
  library(tmap)
  library(raster)
  library(ggplot2)
  library(maptools)
  library(maps)
  library(gstat)
  library(RColorBrewer)
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  #shp = shp_management('world_include_ocean')
  shp = crop(shp,raster::extent(-180,180,0,90))
  
  minlong = min(df$long)
  minlat = min(df$lat)
  maxlong = max(df$long)
  maxlat = max(df$lat)
  
  
  shp = crop(shp,raster::extent(minlong,maxlong,
                        minlat,maxlat))
  
  long_shp = extent(shp)[1:2]
  lat_shp = extent(shp)[3:4]
  
  long_p = seq(min(long_shp),max(long_shp),by =resolution )
  lat_p = seq(min(lat_shp),max(lat_shp),by = resolution)

  s_p = expand.grid(long_p,lat_p)
  inusa = map.where(x = s_p[,1],y = s_p[,2])
  inusa = !is.na(inusa)
  s_p = s_p[inusa,]
  
  colnames(s_p) = c('long','lat')
  
  coordinates(s_p) = ~ long + lat
  gridded(s_p) = T
  fullgrid(s_p) = F
  proj4string(s_p) = crs(shp)
  
  print("Pass Phase 1")
  
  pr = as.numeric(df[,3])
  na_index = which(is.na(pr))
    
  df = data.frame(long=df[,1],lat=df[,2],pr=as.numeric(df[,3]))
  df2 = df
  if(length(na_index)>0){
    df = df[-na_index,] 
  }
  coordinates(df) = ~ long+lat
  proj4string(df) = crs(shp)
  print("Pass Phase 2")
  #df_r = raster(df)
  f1 = as.formula(pr ~ long+lat)
    
  var.sampl = variogram(f1,df,cloud =F,
                        cutoff = 100000,
                        width = 89900)
  dat.fit = fit.variogram(var.sampl,fit.ranges = F,
                          fit.sills = F,
                          vgm(psill = 14,model = 'Sph',
                              range = 590000,
                              nugget = 0))
  
  
  dat.krig = krige(f1,df,s_p,dat.fit)
  dat.r = raster(dat.krig)

  #writeRaster(dat.r,'raster.tif',format = 'GTiff',overwrite = T)
  krg.res = as.data.frame(dat.r,xy = T)
  colnames(krg.res) = c('long','lat','pr')
  
  mycolor = colorRampPalette(brewer.pal(11,'Spectral'))(12)
  
  return(krg.res)
  p = ggplot()+
    geom_tile(data = krg.res,aes(x = long,y = lat,fill = pr),
              color = 'transparent')+
    #geom_point(data = df2,aes(x = long,y = lat),color = 'black',
    #           shape =1, size = 5)+
    scale_fill_gradientn(colours = mycolor)+
    theme_bw()+
    theme(
      axis.text =  element_text(face = 'bold',color = 'black',size = 12),
      axis.title =  element_text(face = 'bold',color = 'black',size = 14, hjust = .5),
      legend.text = element_text(face = 'bold',color = 'black',size = 12),
      legend.title = element_blank(),
      legend.position = 'bottom',
      legend.direction = 'horizontal',
      legend.key.width = unit(2,'cm')
    )+
    xlab('Longitude')+
    ylab('Latitude')
  
  return(p)
  png('krige.png',
      height = 20,
      width = 20,
      units = 'cm',
      res = 800)
  print(p)
  dev.off()
  
}





























land_tas_mean_monthly_analysis <- function(
  
){
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  tas = data_management('global_era5_temperature')
  tas = tas - 273.15
  #tas = tas[[1:180]]
  world = shp_management('world')
  
  world = crop(world,extent(-180,180,0,90))
  
  tas = crop(tas,world)
  tas = mask(tas,world)
  
  janid = seq(1,180,12)
  febid = seq(2,180,12)
  marid = seq(3,180,12)
  aprid = seq(4,180,12)
  mayid = seq(5,180,12)
  junid = seq(6,180,12)
  julid = seq(7,180,12)
  augid = seq(8,180,12)
  sepid = seq(9,180,12)
  octid = seq(10,180,12)
  novid = seq(11,180,12)
  decid = seq(12,180,12)
  
  monid = list(janid,febid,marid,aprid,
               mayid,junid,julid,augid,
               sepid,octid,novid,decid)
  
  
  
  monid <<- monid
  tas <<- tas
  
  cell_mean_fun <-function(i){
    tmpid = monid[[i]]
    tmptas = tas[[tmpid]]
    
    
    tmptasdf = as.data.frame(tmptas,
                             xy = T)
    loc = tmptasdf[,1:2]
    tmptasdf = tmptasdf[,-c(1,2)]
    
    tmptasmean = apply(tmptasdf,1,mean
                       ,na.rm = T)
    retbox = cbind(loc,tmptasmean)
    return(retbox)
  }
  i = 1:length(monid)
  mon_mean_box = lapply(i,cell_mean_fun)
  
  tasmean1 = mon_mean_box[[1]]
  tasmean2 = mon_mean_box[[2]][,3]
  tasmean3 = mon_mean_box[[3]][,3]
  tasmean4 = mon_mean_box[[4]][,3]
  tasmean5 = mon_mean_box[[5]][,3]
  tasmean6 = mon_mean_box[[6]][,3]
  tasmean7 = mon_mean_box[[7]][,3]
  tasmean8 = mon_mean_box[[8]][,3]
  tasmean9 = mon_mean_box[[9]][,3]
  tasmean10 = mon_mean_box[[10]][,3]
  tasmean11 = mon_mean_box[[11]][,3]
  tasmean12 = mon_mean_box[[12]][,3]
  
  tasmean_mon = cbind(tasmean1,
                     tasmean2,
                     tasmean3,
                     tasmean4,
                     tasmean5,
                     tasmean6,
                     tasmean7,
                     tasmean8,
                     tasmean9,
                     tasmean10,
                     tasmean11,
                     tasmean12)
  
  output_tas_mean = 'analysis_output/fig3/landtas_mean.csv'
  #fwrite(mon_mean_box,output_tas_mean)
  fwrite(tasmean_mon,output_tas_mean)
  
  
}
land_tas_mmk_monthly_analysis <- function(
  
){
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  tas = data_management('global_era5_temperature')
  tas = tas - 273.15
  #tas = tas[[1:180]]
  world = shp_management('world')
  
  world = crop(world,extent(-180,180,0,90))
  
  tas = crop(tas,world)
  tas = mask(tas,world)
  
  janid = seq(1,180,12)
  febid = seq(2,180,12)
  marid = seq(3,180,12)
  aprid = seq(4,180,12)
  mayid = seq(5,180,12)
  junid = seq(6,180,12)
  julid = seq(7,180,12)
  augid = seq(8,180,12)
  sepid = seq(9,180,12)
  octid = seq(10,180,12)
  novid = seq(11,180,12)
  decid = seq(12,180,12)
  
  monid = list(janid,febid,marid,aprid,
               mayid,junid,julid,augid,
               sepid,octid,novid,decid)
  
  
  
  monid <<- monid
  tas <<- tas
  
  cell_mmk_fun <-function(i){
    tmpid = monid[[i]]
    tmptas = tas[[tmpid]]
    
    
    tmptasdf = as.data.frame(tmptas,
                             xy = T)
    loc = tmptasdf[,1:2]
    tmptasdf = tmptasdf[,-c(1,2)]
    tmptasdf <<- tmptasdf
    
    j <<- 1:nrow(tmptasdf)
    
    sub_fun <- function(j){
      tmptasv = as.numeric(tmptasdf[j,])
      source('/home/share/R_project/xinjiang_vapor/mmk_fundf.R')
      tmpmmk = mmk_fundf(tmptasv)
      return(tmpmmk)
    }
    
    
    cl = makeCluster(14)
    clusterExport(cl,c('tmptasdf','j'))
    tmptasmmk <- parLapply(cl,j,sub_fun)
    stopCluster(cl)
    
    tmptasmmk = do.call('c',tmptasmmk)
    
    retbox = cbind(loc,tmptasmmk)
    return(retbox)
  }
  i = 1:length(monid)
  mon_mmk_box = lapply(i,cell_mmk_fun)
  
  tasmmk1 = mon_mmk_box[[1]]
  tasmmk2 = mon_mmk_box[[2]][,3]
  tasmmk3 = mon_mmk_box[[3]][,3]
  tasmmk4 = mon_mmk_box[[4]][,3]
  tasmmk5 = mon_mmk_box[[5]][,3]
  tasmmk6 = mon_mmk_box[[6]][,3]
  tasmmk7 = mon_mmk_box[[7]][,3]
  tasmmk8 = mon_mmk_box[[8]][,3]
  tasmmk9 = mon_mmk_box[[9]][,3]
  tasmmk10 = mon_mmk_box[[10]][,3]
  tasmmk11 = mon_mmk_box[[11]][,3]
  tasmmk12 = mon_mmk_box[[12]][,3]
  
  tasmmk_mon = cbind(tasmmk1,
                      tasmmk2,
                      tasmmk3,
                      tasmmk4,
                      tasmmk5,
                      tasmmk6,
                      tasmmk7,
                      tasmmk8,
                      tasmmk9,
                      tasmmk10,
                      tasmmk11,
                      tasmmk12)
  
  output_tas_mmk = 'analysis_output/fig3/landtas_mmk.csv'
  #fwrite(mon_mmk_box,output_tas_mmk)
  fwrite(tasmmk_mon,output_tas_mmk)
  
  
}
linear_project_model <-function(
  df,df_project
){
  train_id = 1:(nrow(df)*0.7)
  train_in_order = df[train_id,]
  test_in_order = df[-train_id,]
  
  lmmodel = lm(tws~.,data = train_in_order)
  
  projtws = lmmodel$fitted.values
  
  coeff = lmmodel$coefficients
  
  train_tws = coeff[1]+coeff[2]*train_in_order[,2]+
    coeff[3]*train_in_order[,3]+
    coeff[4]*train_in_order[,4]+
    coeff[5]*train_in_order[,5]
  
  test_tws = coeff[1]+coeff[2]*test_in_order[,2]+
    coeff[3]*test_in_order[,3]+
    coeff[4]*test_in_order[,4]+
    coeff[5]*test_in_order[,5]
  
  proj_tws = coeff[1]+coeff[1]+coeff[2]*df_project[,1]+
    coeff[3]*df_project[,2]+
    coeff[4]*df_project[,3]+
    coeff[5]*df_project[,4]
  
  date = seq(as.Date('2003-01-01'),as.Date('2050-12-01'),'1 month')
  
  date_proj = date[175:576]
  a = ts(175:576,start = c(2017,7),
         frequency = 12)
  a = decompose(a)$trend
  naidfut = which(is.na(a))
  
  date_proj = date_proj[-naidfut]
  
  ret_train = data.frame(train_tws,train_in_order$tws)
  ret_test = data.frame(test_tws,test_in_order$tws)
  ret_proj = data.frame(date_proj,proj_tws)
  return(list(ret_train,ret_test,ret_proj))
  
}
linear_validate_pme <- function(
  df,df_project
){
  
  train_id = 1:(nrow(df)*0.7)
  train_in_order = df[train_id,]
  test_in_order = df[-train_id,]
  
  lmmodel = lm(pr~.,data = train_in_order)
  
  projtws = lmmodel$fitted.values
  
  return(cor(projtws,train_in_order[,1]))
}
liner_model <-function(
  df
){
  set.seed(100)
  id_train = sample(nrow(df),0.7*nrow(df),replace = FALSE)
  
  train = df[id_train,]
  test = df[-id_train,]
  
  model = lm(tws ~ ., data = df)
  
  pred_train = as.numeric(predict(model,train))
  pred_test = as.numeric(predict(model,test))
  
  train_id = 1:round(nrow(df)*0.7)
  train_in_order = df[train_id,]
  test_in_order = df[-train_id,]
  
  pred_train_in_order = predict(model,train_in_order)
  pred_test_in_order = predict(model,test_in_order)
  
  return(cbind(test_in_order$tws,pred_test_in_order))
}
main_analysis <- function(
  
){
  library(raster)
  library(maps)
  library(maptools)
  library(ggplot2)
  library(reshape2)
  library(RColorBrewer)
  library(data.table)
  library(foreach)
  library(doParallel)
  library(parallel)
  library(snow)
  # 0. Preprocess the loc and attributes
  source('/home/share/R_project/xinjiang_vapor/main_data_preprocess.R')
  source('/home/share/R_project/xinjiang_vapor/main_data_preprocess_mpi.R')
  #input_data_test = '/usr/local/flexpart_bk1/output'
  #input_data_test = '/media/sdb5/xinjiang200302/output'
  source('/home/share/R_project/xinjiang_vapor/check_output_number.R')
  input_data = check_output_number()
  gc()
  source('/home/share/R_project/xinjiang_vapor/back_chose_within_boundury.R')
  #main_data_preprocess_mpi(input_data) # input data refers to output path for all simulations
  
  #system.time(main_data_preprocess(input_data))# exports alldates_output.csv time budget 57.772s

  
  rm(list = ls())
  source('/home/share/R_project/xinjiang_vapor/check_output_number.R')
  source('/home/share/R_project/xinjiang_vapor/back_chose_within_boundury.R')
  input_data = check_output_number()
  system.time(back_chose_within_boundury(input_data)) #exports df_released_inxinjiang.csv time budget 393.866s
  gc()
  
  # world ocean shp combining
  # world_ocean_shp()
  
  # calculation the mid value along the route
  rm(list = ls())
  source('/home/share/R_project/xinjiang_vapor/check_output_number.R')
  source('/home/share/R_project/xinjiang_vapor/back_chose_within_boundury.R')
  input_data = check_output_number()
  source('/home/share/R_project/xinjiang_vapor/main_cal_dp_whole_route_mpi.R')
  # time budget: 90.094 s
  # export /var_whole_route_mid.csv
  system.time(main_cal_dp_whole_route_mpi(input_data))  
  gc()
  
  
  # mask mid df via continent and ocean 
  rm(list = ls())
  source('/home/share/R_project/xinjiang_vapor/check_output_number.R')
  source('/home/share/R_project/xinjiang_vapor/back_chose_within_boundury.R')
  input_data = check_output_number()
  source('/home/share/R_project/xinjiang_vapor/mask_points_via_world_continent.R')
  # time cost:555.474 s
  system.time(mask_points_via_world_continent(input_data)) # 
  gc()
  
  # cal sum dep in source and route region for lands and ocean respectively
  # for all particles
  source('/home/share/R_project/xinjiang_vapor/cal_dep_by_each_source_type.R')
  system.time(cal_dep_by_each_source_type(input_data))
  
  # cal total released in xinjiang region
  source('/home/share/R_project/xinjiang_vapor/main_cal_dqt_in_xinjiang.R')
  system.time(main_cal_dqt_in_xinjiang(input_data))
  
  # cal contribution rate
  source('/home/share/R_project/xinjiang_vapor/cal_contri_rate.R')
  system.time(cal_contri_rate(input_data))
  
  # cluster mean route
  source('/home/share/R_project/xinjiang_vapor/cluster_in_source.R')
  source('/home/share/R_project/xinjiang_vapor/mean_route_by_cl.R')
  system.time(cluster_in_source(input_data))
  
  # cal convey routes 
  cal_convey_rate_by_type()
  # monthly pattern analysis of convey routes
  source('/home/share/R_project/xinjiang_vapor/monthly_pattern_convey_rates.R')
  monthly_pattern_convey_rates()
  
  # filter date and combine hist and ssp 
  source('/home/share/R_project/xinjiang_vapor/outter_filter_cmip6_data_to_date.R')
  outter_filter_cmip6_data_to_date()
  
  # calculation of E-P in source region at particle scale
  source('/home/share/R_project/xinjiang_vapor/cal_ep_in_source_region.R')
  cal_ep_in_source_region()
  
  #outter_mask_crop_cmip6
  source('/home/share/R_project/xinjiang_vapor/outter_mask_crop_cmip6.R')
  outter_mask_crop_cmip6()
}
main_cal_dp_whole_route_mpi<-function(
  input_data
){
  
  library(raster)
  library(maps)
  library(maptools)
  library(ggplot2)
  library(reshape2)
  library(RColorBrewer)
  library(data.table)
  library(foreach)
  library(doParallel)
  library(parallel)
  library(snow)
  sub_cal<-function(input_sub)
  {
    print(input_sub)
    df = fread(paste0(input_sub,'/df_released_inxinjiang.csv'))
    #df = as.data.frame(df)
    # data_structure
    # c('long','lat','height','ep','type')
    
    # diveded as 100 groups
    group_id_xinjiang<-function(x){ # df_xinjiang as input
      step = nrow(x)/100
      ids = round(seq(1,nrow(x),step))
      ide = ids -1
      ide = ide[-1]
      ide = c(ide,nrow(x))
      
      # ide position to value{
      for(i in 1:(length(ide)-1)){
        tmpid = ide[i]
        tmptype = x[tmpid,]$type
        typeid = which(x$type == tmptype)
        print(typeid)
        typeidmax = max(typeid)
        if(typeidmax>tmpid){
          ide[i] = typeidmax
          ids[i+1] = ide[i]+1
        }
      }
      li = list()
      for(i in 1:length(ide)){
        tmps= ids[i]
        tmpe = ide[i]
        li[[i]]= x[tmps:tmpe,]
      }
      return(li)
    }
    li <<- group_id_xinjiang(df)
    #
    print('main_cal_dp_whole_route_mpi: pass group id!')
    source('/home/share/R_project/xinjiang_vapor/cal_dp_sub_pal.R')
    
    cl = makeCluster(15)
    clusterExport(cl,c('li'))
    system.time(
      ret_box <- parLapply(cl,li,cal_dp_sub_pal)
    )
    stopCluster(cl)
  
    ret_box = do.call('rbind',ret_box) # 
    
    print('main_cal_dp_whole_route_mpi: pass caclulation!')
    var_whole_route = ret_box
    # long lat height for mid, varep refers to variance of ep
    output = paste0(input_sub,'/var_whole_route_mid.csv')
    
    fwrite(var_whole_route,output)
    
  }
  sapply(input_data,sub_cal)
  
}
main_cal_dqt_in_xinjiang <- function(
  input_data
){
  library(raster)
  library(maps)
  library(maptools)
  library(ggplot2)
  library(reshape2)
  library(RColorBrewer)
  library(data.table)
  library(foreach)
  library(doParallel)
  library(parallel)
  library(snow)
  
  sub_cal_dqt <- function(
    input_sub
  ){
    # global variables
    # df_full
    
    # find not full index 
    source('/home/share/R_project/xinjiang_vapor/find_not_in_index.R')
    find_not_in_index(input_sub)
    
    df = fread(paste0(input_sub,'/masked_var_whole_route_mid.csv'))
    df_full <<- df
    
    source('/home/share/R_project/xinjiang_vapor/mask_via_each_ocean_dep_inxinjiang.R')
    mas_df = mask_via_each_ocean_dep_inxinjiang(df_full,names ='xj',pattern = 'xinjiang')
    
    tt_release = sum(mas_df$varep[which(mas_df$varep<0)])
    
    tt_release = abs(tt_release)
        
    output = paste0(input_sub,'/totoal_release_in_xinjiang')
    dir.create(output)
    output = paste0(output, '/total_released.csv')
    
    write.csv(tt_release,output)
   
    
  }
  sapply(input_data,sub_cal_dqt)
}
main_cal_dqt_mpi<-function(
  input_data
){
  
  source('/home/share/R_project/xinjiang_vapor/group_matrix_by_id.R')
  source('/home/share/R_project/xinjiang_vapor/calc_each_dqt_group.R')
  
  sub_cal<-function(input_sub)
  {
    source('/home/share/R_project/xinjiang_vapor/group_matrix_by_id.R')
    source('/home/share/R_project/xinjiang_vapor/calc_each_dqt_group.R')
    
    df = fread(paste0(input_sub,'/var_whole_route_mid.csv'))
    df = as.data.frame(df)
    # data_structure
    # c('long','lat','height','ep','type')
    
    # Calculation of total released in Xinjiang Extent
    shp_path = '/usr/local/flexpart_bk1/shp/Xinjiang_border.shp'
    xinjiang_shp = shapefile(shp_path)
    ## crop releasing zone
    dfc = df
    coordinates(dfc) = ~ long+lat
    proj4string(dfc) = "+proj=longlat +datum=WGS84 +no_defs"
    df_m = over(dfc,xinjiang_shp)
    df_index = which(!is.na(df_m[,1]))
    df_m = dfc[df_index,]
    df_xinjiang = as.data.frame(df_m,xy = T)
    #back chosing id
    id_inzone = unique(df_xinjiang$type)
    
    df_full <<- df
    df_xinjiang <<- df_xinjiang
    
    group_id_route<-function(x){ # df_xinjiang as input
      step = nrow(x)/100
      ids = round(seq(1,nrow(x),step))
      ide = ids -1
      ide = ide[-1]
      ide = c(ide,nrow(x))
      
      # ide position to value{
      for(i in 1:(length(ide)-1)){
        tmpid = ide[i]
        tmptype = x[tmpid,]$type
        typeid = which(x$type == tmptype)
        print(typeid)
        typeidmax = max(typeid)
        if(typeidmax>tmpid){
          ide[i] = typeidmax
          ids[i+1] = ide[i]+1
        }
      }
      li = list()
      for(i in 1:length(ide)){
        tmps= ids[i]
        tmpe = ide[i]
        li[[i]]= x[tmps:tmpe,]
      }
      return(li)
    }
    li_xinjiang = group_id_route(df_xinjiang)
    
    system.time(ret_box <- lapply(li_xinjiang,calc_each_dqt_group))
    ret_box = do.call('c',ret_box) # 
    tt_release = sum(ret_box)
    
    return(ret_box)
    print(tt_release)
    output = paste0(input_sub,'/totoal_release_in_xinjiang')
    dir.create(output)
    output = paste0(output, '/total_released.csv')
    
    write.csv(tt_release,output)
    
    
  }
  
  ret = sapply(input_data,sub_cal)
  return(ret)
}
main_cal_dqt<-function(
  input_data
){
  
  
  sub_cal<-function(input_sub)
  {
     df = fread(paste0(input_sub,'/var_whole_route_mid.csv'))
     df = as.data.frame(df)
     # data_structure
     # c('long','lat','height','ep','type')
     
     # Calculation of total released in Xinjiang Extent
     shp_path = '/usr/local/flexpart_bk1/shp/Xinjiang_border.shp'
     xinjiang_shp = shapefile(shp_path)
     ## crop releasing zone
     dfc = df
     coordinates(dfc) = ~ long+lat
     proj4string(dfc) = "+proj=longlat +datum=WGS84 +no_defs"
     df_m = over(dfc,xinjiang_shp)
     df_index = which(!is.na(df_m[,1]))
     df_m = dfc[df_index,]
     df_xinjiang = as.data.frame(df_m,xy = T)
     #back chosing id
     id_inzone = unique(df_xinjiang$type)
     
     df <<- df
     df_xinjiang <<- df_xinjiang
     calc_each_dqt_inzone <- function(id_inzone){
       tmpid = which(df_xinjiang$type == id_inzone)
       
       if(length(tmpid)==1){
         tmpidfull = which(df$type == id_inzone)
         len1 = length(tmpidfull)
         len2 = len1 -1
         tmpdf = df[c(len1,len2),]
         
         tmpdq = tmpdf$ep[2] - tmpdf$ep[1]
       }else if (length(tmpid) ==2){
         tmpdf = df_xinjiang[tmpid,]
         tmpdq = tmpdf$ep[2] - tmpdf$ep[1]
       }else{
         len1 = length(tmpid)
         len2 = len1 - 1
         tmpdq1 = df_xinjiang$ep[2:len1]
         tmpdq2 = df_xinjiang$ep[1:len2]
         tmpdq = tmpdq2-tmpdq1
         tmpdq = sum(tmpdq)
       }
       return(tmpdq)
     }
     
     dqinzone = sapply(id_inzone,calc_each_dqt_inzone)
     
     p = ggplot()+
       geom_polygon(data = xinjiang_shp,aes(x = long,y = lat,group = group),fill= 'white')+
       geom_point(data = df_xinjiang,aes(x = long,y = lat),color= 'blue')
     
     png('plot_point.png',
         height = 15,
         width = 20,
         units = 'cm',
         res = 800)
     print(p)
     dev.off()
     
     
     
     
     
     
     calc_per_traj <- function(id){
       tmpid = which(df$type == id)
       dfpt = df[tmpid,]
       
       
     }
   
  }
  
  
}
main_cal_relesed_inxinjiang <- function(
  input_data
){
  library(raster)
  library(maps)
  library(maptools)
  library(ggplot2)
  library(reshape2)
  library(RColorBrewer)
  library(data.table)
  library(foreach)
  library(doParallel)
  library(parallel)
  library(snow)
  
  sub_cal_dqt <- function(
    input_sub
  ){
    # global variables
    # df_full
    
    # find not full index 
    #source('/home/share/R_project/xinjiang_vapor/find_not_in_index.R')
    #find_not_in_index(input_sub)
    
    print(input_sub)
    df = fread(paste0(input_sub,'/masked_var_whole_route_mid.csv'))
    df_full <<- df
    
    source('/home/share/R_project/xinjiang_vapor/mask_via_each_ocean_dep_inxinjiang.R')
    mas_df = mask_via_each_ocean_dep_inxinjiang(df_full,names ='xj',pattern = 'xinjiang')
    
    sum_fun_neg<-function(x){
      xs = sum(x[which(x <0)])
    }
    
    released_by_type = aggregate(mas_df$varep,list(mas_df$type),sum_fun_neg)
    #released_by_type = released_by_type[-which(released_by_type$x == 0),]
    
    tt_release = sum(released_by_type$x)
    
    output_released = paste0(input_sub,'/released_by_type.csv')
    fwrite(released_by_type,output_released)
    
    # cal 
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    input_ocean_contr = paste0(input_sub,'/contr_ocean')
    input_ocean_contr = paste0(input_ocean_contr,'/',oce_names,'.csv')
    
    output_ocean_contr = paste0(input_sub,'/contr_released_ocean')
    dir.create(output_ocean_contr)
    output_ocean_contr = paste0(output_ocean_contr,'/',oce_names,'.csv')
  
    
    source('/home/share/R_project/xinjiang_vapor/match_by_id.R')
    
    sub_find_oce_fun<-function(i){
      if(file.exists(input_ocean_contr[i])){
        match_by_id(output_released,input_ocean_contr[i],mode = oce_names[i],output_ocean_contr[i])  
      }
    }
    
    i = 1:length(oce_names)
    lapply(i,sub_find_oce_fun)
    
    
    con_names = c('as','xj','eu','naf','na')
    input_land_contr = paste0(input_sub,'/contr_land')
    input_land_contr = paste0(input_land_contr,'/',con_names,'.csv')
    
    output_land_contr = paste0(input_sub,'/contr_released_land')
    dir.create(output_land_contr)
    output_land_contr = paste0(output_land_contr,'/',con_names,'.csv')
    
    
    sub_find_con_fun<-function(i){
      if(file.exists(input_land_contr[i])){
        match_by_id(output_released,input_land_contr[i],mode = con_names[i],output_land_contr[i])  
      }
      
    }
    
    i = 1:length(con_names)
    lapply(i,sub_find_con_fun)
    
    
    
  }
  sapply(input_data,sub_cal_dqt)
}
main_cluster<-function(
  input_data
){
  library(doParallel)
  library(snow)
  library(foreach)
  library(parallel)
  library(factoextra)
  library(vegan)
  
  
  sub_cluster<-function(input_sub){
    input_file = paste0(input_sub,'/alldates_output.csv')
    df = fread(input_file)
    
    id = unique(df$type)
    id <<- as.numeric(id)
    idfull <<- df$type
    
    ids = id
    xfull <<- df$type
    group_id <- function(x){
      step = round(length(x) /100)
      ids = seq(1,length(x),step)
      ide = ids -1
      ide = ide[-1]
      ide = c(ide,length(x))
      xl = list()
      for(i in 1:length(ids)){
        stmp = ids[i]
        etmp = ide[i]
        tmp = x[stmp:etmp]
        xl[[i]] = tmp
      }
      return(xl)
    }
    idsl = group_id(ids)
    system.time(ret_b <- lapply(idsl, search_which))
  
    ret_box = do.call('c',ret_b)
    
    df = as.data.frame(df)
    df_first = df[ret_box,1:4]
  
    
    ca_clust = cascadeKM(df_first,1,10,iter = 10)
    cal_best = as.numeric(which.max(ca_clust$results[2,]))
    
    cluster_mod = kmeans(df_first,4)
    cluster = cluster_mod$cluster
    
    df_first$cluster = cluster
    output_cl = paste0(input_sub,'/output_cluster.csv')
    
    #fwrite(ret_box,output_cl)
    
    
    p = ggplot()+
      geom_point(data = df_first,aes(x = long,y = lat,color =cluster))+
      geom_polygon(data = shp,aes(x = long,y= lat,group = group),
                   color = 'black',fill = 'transparent')+
      scale_color_distiller(palette = 'Spectral')+
      theme_bw()
    p
  }
  sapply(input_data,sub_cluster)
  
  
  
}
main_data_preprocess_mpi<-function(
  input_data
){
  
  sub_data_preprocess_mpi<-function(
    input_sub # sub input file of input_data
    
  ){
    parnum = 500000
    input_loc = list.files(input_sub,pattern = '*loc.csv$',full.names = T)
    input_attr = list.files(input_sub,pattern = '*var.csv$',full.names = T)
    input_mass = list.files(input_sub,pattern = '*mass.csv$',full.names = T)
    
    # reverse the time from source to region
    #input_loc = rev(input_loc)
    #input_attr = rev(input_attr)
    #input_mass = rev(input_mass)
    
    longb = 1
    latb = 1
    heightb = 1
    epb = 1
    for(i in 1:length(input_loc)){
      loctmp = fread(input_loc[i])
      attrtmp = fread(input_attr[i])
      masstmp = fread(input_mass[i])
      
      loctmp = as.data.frame(loctmp)
      attrtmp = as.data.frame(attrtmp)
      masstmp = as.data.frame(masstmp)
      
      longtmp = loctmp[,1]
      lattmp = loctmp[,2]
      height = loctmp[,3]
      sh = attrtmp[,1]
      mass = masstmp[,1]
      
      if(is.na(mean(sh))){
        sh = rep(0,length(sh))
      }
      
      ep = sh*mass
      #print(length(longtmp))
      
      if(length(longtmp) < parnum){
        less_num = parnum - length(longtmp)
        longtmp = c(longtmp,rep(NA,less_num))
        lattmp = c(lattmp,rep(NA,less_num))
        height = c(height,rep(NA,less_num))
        ep = c(ep,rep(NA,less_num))
      }
      
      longb = rbind(longb,longtmp)
      latb = rbind(latb,lattmp)
      heightb = rbind(heightb,height)
      epb = rbind(epb,ep)
    }
    longb = longb[-1,]
    latb = latb[-1,]
    heightb = heightb[-1,]
    epb = epb[-1,]
    
    longb <<- longb
    latb <<- latb
    heightb <<- heightb
    epb <<- epb
    
    print(ncol(longb))
    
    # mpi modification starts here
    
    mpi_trans<-function(ncolid){
      longtmp = longb[,ncolid]
      lattmp = latb[,ncolid]
      height = heightb[,ncolid]
      ep = epb[,ncolid]
      type = ncolid
      mattmp = cbind(longtmp,lattmp,height,ep,type)
      
      return(mattmp)
    }
    
    #cl = makeCluster(detectCores()-1)
    cl = makeCluster(2)
    clusterExport(cl,c('longb','latb','heightb','epb'))
    system.time(
      mat <- parLapply(cl,1:ncol(longb),mpi_trans)
    )
    stopCluster(cl)
    
    matr = do.call('rbind',mat)
    
    colnames(matr) = c('long','lat','height','ep','type')
    
    naid = which(is.na(matr[,1]))
    matr = matr[-naid,]
    output_mat = paste0(input_sub,'/alldates_output.csv')
    print(output_mat)
    fwrite(matr,output_mat)
    #return(mat)
    
  }
  
  sapply(input_data,sub_data_preprocess_mpi)
}
main_data_preprocess<-function(
  input_data
){
  
  sub_data_preprocess<-function(
    input_sub # sub input file of input_data
   
  ){
    parnum = 500000
    input_loc = list.files(input_sub,pattern = '*loc.csv$',full.names = T)
    input_attr = list.files(input_sub,pattern = '*var.csv$',full.names = T)
    input_mass = list.files(input_sub,pattern = '*mass.csv$',full.names = T)
    
    # reverse the time from source to region
    #input_loc = rev(input_loc)
    #input_attr = rev(input_attr)
    #input_mass = rev(input_mass)
    
    longb = 1
    latb = 1
    heightb = 1
    epb = 1
    for(i in 1:length(input_loc)){
      loctmp = fread(input_loc[i])
      attrtmp = fread(input_attr[i])
      masstmp = fread(input_mass[i])
      
      loctmp = as.data.frame(loctmp)
      attrtmp = as.data.frame(attrtmp)
      masstmp = as.data.frame(masstmp)
      
      longtmp = loctmp[,1]
      lattmp = loctmp[,2]
      height = loctmp[,3]
      sh = attrtmp[,1]
      mass = masstmp[,1]
      
      if(is.na(mean(sh))){
        sh = rep(0,length(sh))
      }
      
      ep = sh*mass
      print(length(longtmp))
      
      if(length(longtmp) < parnum){
        less_num = parnum - length(longtmp)
        longtmp = c(longtmp,rep(NA,less_num))
        lattmp = c(lattmp,rep(NA,less_num))
        height = c(height,rep(NA,less_num))
        ep = c(ep,rep(NA,less_num))
      }
      
      longb = rbind(longb,longtmp)
      latb = rbind(latb,lattmp)
      heightb = rbind(heightb,height)
      epb = rbind(epb,ep)
    }
    longb = longb[-1,]
    latb = latb[-1,]
    heightb = heightb[-1,]
    epb = epb[-1,]
    
    print(ncol(longb))
    type = rep(1:ncol(longb),each = nrow(longb))
    
    print('start as vector')
    longtmp = as.vector(longb)
    lattmp = as.vector(latb)
    heigthtmp = as.vector(heightb)
    eptmp = as.vector(epb)
    
    mat = cbind(longtmp,lattmp,heigthtmp,eptmp,type)
    mat = as.data.frame(mat)
    
    colnames(mat) = c('long','lat','height','ep','type')
    
    naid = which(is.na(mat[,1]))
    mat = mat[-naid,]
    output_mat = paste0(input_sub,'/alldates_output.csv')
    print(output_mat)
    fwrite(mat,output_mat)
    #return(mat)
    
  }
  
  sapply(input_data,sub_data_preprocess)
}
main_plot_xinjiang_vapor <-function(
  
){
  # Fig 1 
  # (a) Long term Contribution Rates
  # (b) Study Area Regionalization 
  # (c) Monthly pattern of contribution 
  source('/home/share/R_project/xinjiang_vapor/fig1_plot_xinjiang_vapor.R')
  fig1_plot_xinjiang_vapor()
  
  
}
main_plot <- function(
  
){
  # plot management 
  source('/home/share/R_project/xinjiang_vapor/fig1_plot_xinjiang_vapor.R')
  fig1_plot_xinjiang_vapor()
  
  # fig2 
  source('/home/share/R_project/xinjiang_vapor/fig2_plot_xinjiang_vapor.R')
}
main_supplementary_figures <- function(
  
){
  # figs 8 plot done 
  # era5 traing and validation model
  source('/home/share/R_project/xinjiang_vapor/figs8_plot.R')
  figs8_plot()
  
  # figs 9 plot
  # era5 random forest model importance
  source('/home/share/R_project/xinjiang_vapor/figs10_plot.R')
  figs10_plot()
  
  # figs 10 plot
  # cor barplot projection based on cmip6 pme and tws in sws
  source('/home/share/R_project/xinjiang_vapor/figs_cmip6_tws_pme_cor.R')
  figs_cmip6_tws_pme_cor()
  
  # figs.
  
}
mask_crop_cmip6_pme<- function(
  mode = 'ato'
){
  #input file 
  input_cmip6 = '/media/root/Shen_drive1/CMIP6_combined'
  e_hist_ssp245 = list.files(paste0(input_cmip6,'/E/hist_ssp245'),full.names = T)
  e_hist_ssp585 = list.files(paste0(input_cmip6,'/E/hist_ssp585'),full.names = T)
  pr_hist_ssp245 = list.files(paste0(input_cmip6,'/Pr/hist_ssp245'),full.names = T)
  pr_hist_ssp585 = list.files(paste0(input_cmip6,'/Pr/hist_ssp585'),full.names = T)
  
  e_hist_ssp245 <<- e_hist_ssp245
  e_hist_ssp585 <<- e_hist_ssp585
  pr_hist_ssp245 <<- pr_hist_ssp245
  pr_hist_ssp585 <<- pr_hist_ssp585
  
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  # output file
  
  
  
  
  # 3. cal the sum of total ep
  # units of evapor = mm/s to mm/month *86400*30.5
  # units of pr = mm/s to mm/month *86400*30.5
  
  output_ep = '/media/root/Shen_drive1/CMIP6_pme'
  dir.create(output_ep)
  output_ep = paste0(output_ep,'/',mode)
  dir.create(output_ep)
  
  ep_ssp245 = paste0(output_ep,'/hist_ssp245')
  ep_ssp585 = paste0(output_ep,'/hist_ssp585')
  
  dir.create(ep_ssp245)
  dir.create(ep_ssp585)
  
  ep_ssp245_region = paste0(ep_ssp245,'/','region',1:4)
  ep_ssp585_region = paste0(ep_ssp585,'/','region',1:4)
  
  sapply(ep_ssp245_region,dir.create)
  sapply(ep_ssp585_region,dir.create)
  
  output_name245 = list.files(paste0(input_cmip6,'/E/hist_ssp245'))
  output_name585 = list.files(paste0(input_cmip6,'/E/hist_ssp585'))
  
  output_region245 = paste0(rep(ep_ssp245_region,8),'/',rep(output_name245,each = 4))
  output_region585 = paste0(rep(ep_ssp585_region,8),'/',rep(output_name585,each = 4))
  
  output_region245 = list(output_region245[1:4],
                          output_region245[5:8],
                          output_region245[9:12],
                          output_region245[13:16],
                          output_region245[17:20],
                          output_region245[21:24],
                          output_region245[25:28],
                          output_region245[29:32])
  output_region585 = list(output_region585[1:4],
                          output_region585[5:8],
                          output_region585[9:12],
                          output_region585[13:16],
                          output_region585[17:20],
                          output_region585[21:24],
                          output_region585[25:28],
                          output_region585[29:32])
  output_region245 <<- output_region245
  output_region585 <<- output_region585
  
  mode <<- mode
  sub_mask_hist_ssp245 <- function(i){
    # using 2003-201412 to training
    library(raster)
    library(ncdf4)
    
    tmpe = stack(e_hist_ssp245[i])
    tmppr = stack(pr_hist_ssp245[i])
    
    tmpe = tmpe*86400*30.5
    tmppr = tmppr*86400*30.5
    
    tmpep = tmppr-tmpe
    
    poly = shapefile(input_poly)
    
    # 1. mask by shapefile polygon 
    tmpep = mask(tmpep,poly)
    # 2. crop by sub-regions 
    r1 = shapefile(input_crop[1])    
    r2 = shapefile(input_crop[2])    
    r3 = shapefile(input_crop[3])    
    r4 = shapefile(input_crop[4])    
    
    tmpep1 <- crop(tmpep,r1)
    tmpep2 <- crop(tmpep,r2)
    tmpep3 <- crop(tmpep,r3)
    tmpep4 <- crop(tmpep,r4)
    
    
    tmpoutput1 = output_region245[[i]][1]
    tmpoutput2 = output_region245[[i]][2]
    tmpoutput3 = output_region245[[i]][3]
    tmpoutput4 = output_region245[[i]][4]
    
    writeRaster(tmpep1,tmpoutput1,format = 'CDF',overwrite = T)
    writeRaster(tmpep2,tmpoutput2,format = 'CDF',overwrite = T)
    writeRaster(tmpep3,tmpoutput3,format = 'CDF',overwrite = T)
    
    if(mode == 'eu' & i ==3){
      tmpep4  = as.data.frame(tmpep4,xy = T)
      library(data.table)
      fwrite(tmpep4,'/media/root/Shen_drive1/CMIP6_pme/eu/hist_ssp245/region4/his245_CanESM5_200301_205012.csv')
    } else{
      writeRaster(tmpep4,tmpoutput4,format = 'CDF',overwrite = T)
    }
    
    
    
    
  }
  
  sub_mask_hist_ssp585 <- function(i){
    # using 2003-201412 to training
    library(raster)
    library(ncdf4)
    
    tmpe = stack(e_hist_ssp585[i])
    tmppr = stack(pr_hist_ssp585[i])
    
    tmpe = tmpe*86400*30.5
    tmppr = tmppr*86400*30.5
    
    tmpep = tmppr-tmpe
    
    poly = shapefile(input_poly)
    
    # 1. mask by shapefile polygon 
    tmpep = mask(tmpep,poly)
    # 2. crop by sub-regions 
    r1 = shapefile(input_crop[1])    
    r2 = shapefile(input_crop[2])    
    r3 = shapefile(input_crop[3])    
    r4 = shapefile(input_crop[4])    
    
    tmpep1 <<- crop(tmpep,r1)
    tmpep2 <<- crop(tmpep,r2)
    tmpep3 <<- crop(tmpep,r3)
    tmpep4 <<- crop(tmpep,r4)
    
    tmpoutput1 = output_region585[[i]][1]
    tmpoutput2 = output_region585[[i]][2]
    tmpoutput3 = output_region585[[i]][3]
    tmpoutput4 = output_region585[[i]][4]
    
    writeRaster(tmpep1,tmpoutput1,format = 'CDF',overwrite = T)
    writeRaster(tmpep2,tmpoutput2,format = 'CDF',overwrite = T)
    writeRaster(tmpep3,tmpoutput3,format = 'CDF',overwrite = T)
    
    if(mode == 'eu' & i ==3){
      tmpep4  = as.data.frame(tmpep4,xy = T)
      library(data.table)
      fwrite(tmpep4,'/media/root/Shen_drive1/CMIP6_pme/eu/hist_ssp585/region4/his585_CanESM5_200301_205012.csv')
    } else{
      writeRaster(tmpep4,tmpoutput4,format = 'CDF',overwrite = T)
    }
    
    
    
  }
  
  i = 1:length(e_hist_ssp245)
  i <<- i
  library(doParallel)
  #cl = makeCluster(8)
  #clusterExport(cl,c('e_hist_ssp245','pr_hist_ssp245','input_poly','input_crop',
  #                   'output_region245'))
  #system.time(parLapply(cl,i,sub_mask_hist_ssp245))
  #stopCluster(cl)
  
  
  cl = makeCluster(8)
  clusterExport(cl,c('e_hist_ssp585','pr_hist_ssp585','input_poly','input_crop',
                     'output_region585'))
  system.time(parLapply(cl,i,sub_mask_hist_ssp585))
  stopCluster(cl)
  
  print(paste0('pass_',mode))  
}
mask_crop_cmip6_ssp585 <- function(
  mode = 'ato'
){
  #input file 
  input_cmip6 = '/media/root/Shen_drive1/CMIP6_combined'
  e_hist_ssp245 = list.files(paste0(input_cmip6,'/E/hist_ssp245'),full.names = T)
  e_hist_ssp585 = list.files(paste0(input_cmip6,'/E/hist_ssp585'),full.names = T)
  pr_hist_ssp245 = list.files(paste0(input_cmip6,'/Pr/hist_ssp245'),full.names = T)
  pr_hist_ssp585 = list.files(paste0(input_cmip6,'/Pr/hist_ssp585'),full.names = T)
  
  e_hist_ssp245 <<- e_hist_ssp245
  e_hist_ssp585 <<- e_hist_ssp585
  pr_hist_ssp245 <<- pr_hist_ssp245
  pr_hist_ssp585 <<- pr_hist_ssp585
  
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  # output file
  
  
  
  
  # 3. cal the sum of total ep
  # units of evapor = mm/s to mm/month *86400*30.5
  # units of pr = mm/s to mm/month *86400*30.5
  
  output_ep = '/media/root/Shen_drive1/CMIP6_pme'
  dir.create(output_ep)
  output_ep = paste0(output_ep,'/',mode)
  dir.create(output_ep)
  
  ep_ssp245 = paste0(output_ep,'/hist_ssp245')
  ep_ssp585 = paste0(output_ep,'/hist_ssp585')
  
  dir.create(ep_ssp245)
  dir.create(ep_ssp585)
  
  ep_ssp245_region = paste0(ep_ssp245,'/','region',1:4)
  ep_ssp585_region = paste0(ep_ssp585,'/','region',1:4)
  
  sapply(ep_ssp245_region,dir.create)
  sapply(ep_ssp585_region,dir.create)
  
  output_name245 = list.files(paste0(input_cmip6,'/E/hist_ssp245'))
  output_name585 = list.files(paste0(input_cmip6,'/E/hist_ssp585'))
  
  output_region245 = paste0(rep(ep_ssp245_region,8),'/',rep(output_name245,each = 4))
  output_region585 = paste0(rep(ep_ssp585_region,8),'/',rep(output_name585,each = 4))
  
  output_region245 = list(output_region245[1:4],
                          output_region245[5:8],
                          output_region245[9:12],
                          output_region245[13:16],
                          output_region245[17:20],
                          output_region245[21:24],
                          output_region245[25:28],
                          output_region245[29:32])
  output_region585 = list(output_region585[1:4],
                          output_region585[5:8],
                          output_region585[9:12],
                          output_region585[13:16],
                          output_region585[17:20],
                          output_region585[21:24],
                          output_region585[25:28],
                          output_region585[29:32])
  output_region245 <<- output_region245
  output_region585 <<- output_region585
  
  mode <<- mode
  sub_mask_hist_ssp245 <- function(i){
    # using 2003-201412 to training
    library(raster)
    library(ncdf4)
    
    tmpe = stack(e_hist_ssp245[i])
    tmppr = stack(pr_hist_ssp245[i])
    
    tmpe = tmpe*86400*30.5
    tmppr = tmppr*86400*30.5
    
    tmpep = tmppr-tmpe
    
    poly = shapefile(input_poly)
    
    # 1. mask by shapefile polygon 
    tmpep = mask(tmpep,poly)
    # 2. crop by sub-regions 
    r1 = shapefile(input_crop[1])    
    r2 = shapefile(input_crop[2])    
    r3 = shapefile(input_crop[3])    
    r4 = shapefile(input_crop[4])    
    
    tmpep1 <- crop(tmpep,r1)
    tmpep2 <- crop(tmpep,r2)
    tmpep3 <- crop(tmpep,r3)
    tmpep4 <- crop(tmpep,r4)
    
    
    tmpoutput1 = output_region245[[i]][1]
    tmpoutput2 = output_region245[[i]][2]
    tmpoutput3 = output_region245[[i]][3]
    tmpoutput4 = output_region245[[i]][4]
    
    writeRaster(tmpep1,tmpoutput1,format = 'CDF',overwrite = T)
    writeRaster(tmpep2,tmpoutput2,format = 'CDF',overwrite = T)
    writeRaster(tmpep3,tmpoutput3,format = 'CDF',overwrite = T)
    
    if(mode == 'eu' & i ==3){
      tmpep4  = as.data.frame(tmpep4,xy = T)
      library(data.table)
      fwrite(tmpep4,'/media/root/Shen_drive1/CMIP6_e-p/eu/hist_ssp245/region4/his245_CanESM5_200301_205012.csv')
    } else{
      writeRaster(tmpep4,tmpoutput4,format = 'CDF',overwrite = T)
    }
    
    
    
    
  }
  
  sub_mask_hist_ssp585 <- function(i){
    # using 2003-201412 to training
    library(raster)
    library(ncdf4)
    
    tmpe = stack(e_hist_ssp585[i])
    tmppr = stack(pr_hist_ssp585[i])
    
    tmpe = tmpe*86400*30.5
    tmppr = tmppr*86400*30.5
    
    tmpep = tmpe-tmppr
    
    poly = shapefile(input_poly)
    
    # 1. mask by shapefile polygon 
    tmpep = mask(tmpep,poly)
    # 2. crop by sub-regions 
    r1 = shapefile(input_crop[1])    
    r2 = shapefile(input_crop[2])    
    r3 = shapefile(input_crop[3])    
    r4 = shapefile(input_crop[4])    
    
    tmpep1 <<- crop(tmpep,r1)
    tmpep2 <<- crop(tmpep,r2)
    tmpep3 <<- crop(tmpep,r3)
    tmpep4 <<- crop(tmpep,r4)
    
    tmpoutput1 = output_region585[[i]][1]
    tmpoutput2 = output_region585[[i]][2]
    tmpoutput3 = output_region585[[i]][3]
    tmpoutput4 = output_region585[[i]][4]
    
    writeRaster(tmpep1,tmpoutput1,format = 'CDF',overwrite = T)
    writeRaster(tmpep2,tmpoutput2,format = 'CDF',overwrite = T)
    writeRaster(tmpep3,tmpoutput3,format = 'CDF',overwrite = T)
    
    if(mode == 'eu' & i ==3){
      tmpep4  = as.data.frame(tmpep4,xy = T)
      library(data.table)
      fwrite(tmpep4,'/media/root/Shen_drive1/CMIP6_e-p/eu/hist_ssp585/region4/his585_CanESM5_200301_205012.csv')
    } else{
      writeRaster(tmpep4,tmpoutput4,format = 'CDF',overwrite = T)
    }
    
    
    
  }
  
  #i = 1:length(e_hist_ssp245)
  #i <<- i
  #library(doParallel)
  #cl = makeCluster(8)
  #clusterExport(cl,c('e_hist_ssp245','pr_hist_ssp245','input_poly','input_crop',
  #                   'output_region245'))
  #system.time(parLapply(cl,i,sub_mask_hist_ssp245))
  #stopCluster(cl)
  
  
  cl = makeCluster(8)
  clusterExport(cl,c('e_hist_ssp585','pr_hist_ssp585','input_poly','input_crop',
                     'output_region585'))
  system.time(parLapply(cl,i,sub_mask_hist_ssp585))
  stopCluster(cl)
  
  print(paste0('pass_',mode))  
}
mask_crop_cmip6_sst<- function(
  mode = 'ato'
){
  library(raster)
  library(data.table)
  library(ncdf4)
  #input file 
  input_cmip6 = '/media/root/Shen_drive1/CMIP6_combined'
  sst_hist_ssp245 = list.files(paste0(input_cmip6,'/SST/hist_ssp245'),full.names = T)
  sst_hist_ssp585 = list.files(paste0(input_cmip6,'/SST/hist_ssp585'),full.names = T)
  
  sst_hist_ssp245 <<- sst_hist_ssp245
  sst_hist_ssp585 <<- sst_hist_ssp585
  
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  # output file
  
  
  
  
  # 3. cal the sum of total ep
  # units of evapor = mm/s to mm/month *86400*30.5
  # units of pr = mm/s to mm/month *86400*30.5
  
  output_sst = '/media/root/Shen_drive1/CMIP6_mask_sst'
  dir.create(output_sst)
  output_ep = paste0(output_sst,'/',mode)
  dir.create(output_sst)
  
  sst_ssp245 = paste0(output_sst,'/hist_ssp245')
  sst_ssp585 = paste0(output_sst,'/hist_ssp585')
  
  dir.create(sst_ssp245)
  dir.create(sst_ssp585)
  
  sst_ssp245_region = paste0(sst_ssp245,'/','region',1:4)
  sst_ssp585_region = paste0(sst_ssp585,'/','region',1:4)
  
  sapply(sst_ssp245_region,dir.create)
  sapply(sst_ssp585_region,dir.create)
  
  output_name245 = list.files(paste0(input_cmip6,'/SST/hist_ssp245'))
  output_name585 = list.files(paste0(input_cmip6,'/SST/hist_ssp585'))
  
  output_region245 = paste0(rep(sst_ssp245_region,8),'/',rep(output_name245,each = 4))
  output_region585 = paste0(rep(sst_ssp585_region,8),'/',rep(output_name585,each = 4))
  
  output_region245 = list(output_region245[1:4],
                          output_region245[5:8],
                          output_region245[9:12],
                          output_region245[13:16],
                          output_region245[17:20],
                          output_region245[21:24],
                          output_region245[25:28],
                          output_region245[29:32])
  output_region585 = list(output_region585[1:4],
                          output_region585[5:8],
                          output_region585[9:12],
                          output_region585[13:16],
                          output_region585[17:20],
                          output_region585[21:24],
                          output_region585[25:28],
                          output_region585[29:32])
  output_region245 <<- output_region245
  output_region585 <<- output_region585
  
  mode <<- mode
  sub_mask_hist_ssp245 <- function(i){
    # using 2003-201412 to training
    library(raster)
    library(ncdf4)
    library(data.table)
    
    tmpsst = try(stack(sst_hist_ssp245[i]),
               silent = T)
    poly = shapefile(input_poly)
    
    r1 = shapefile(input_crop[1])    
    r2 = shapefile(input_crop[2])    
    r3 = shapefile(input_crop[3])    
    r4 = shapefile(input_crop[4]) 
    if('try-error' %in% class(tmpsst)){
      tmpsst = fread(sst_hist_ssp245[i])
      tmpsst = as.data.frame(tmpsst)
      
      loc = tmpsst[,1:3]
      naid = which(is.na(loc[,3]))
      
      loc  =loc[-naid,]
      tmpsst = tmpsst[-naid,]
      
      loc = tmpsst[,1:2]
      # import sub regions
      r1e = extent(r1)
      r2e = extent(r2)
      r3e = extent(r3)
      r4e = extent(r4)
      
      id1 = which(loc[,1]>=r1e[1] &
                    loc[,1]<=r1e[2] &
                    loc[,2]>=r1e[3] &
                    loc[,2]<=r1e[4])
      id2 = which(loc[,1]>=r2e[1] &
                    loc[,1]<=r2e[2] &
                    loc[,2]>=r2e[3] &
                    loc[,2]<=r2e[4])
      id3 = which(loc[,1]>=r3e[1] &
                    loc[,1]<=r3e[2] &
                    loc[,2]>=r3e[3] &
                    loc[,2]<=r3e[4])
      id4 = which(loc[,1]>=r4e[1] &
                    loc[,1]<=r4e[2] &
                    loc[,2]>=r4e[3] &
                    loc[,2]<=r4e[4])
      
      tmpsst1 = tmpsst[id1,]
      tmpsst2 = tmpsst[id2,]
      tmpsst3 = tmpsst[id3,]
      tmpsst4 = tmpsst[id4,]
      
      tmpoutput1 = output_region245[[i]][1]
      tmpoutput2 = output_region245[[i]][2]
      tmpoutput3 = output_region245[[i]][3]
      tmpoutput4 = output_region245[[i]][4]
      
      fwrite(tmpsst1,tmpoutput1)
      fwrite(tmpsst2,tmpoutput2)
      fwrite(tmpsst3,tmpoutput3)
      fwrite(tmpsst4,tmpoutput4)
      
    }else{
      tmpsst = mask(tmpsst,poly)
      
      tmpsst1 <- crop(tmpsst,r1)
      tmpsst2 <- crop(tmpsst,r2)
      tmpsst3 <- crop(tmpsst,r3)
      tmpsst4 <- crop(tmpsst,r4)
      
      
      tmpoutput1 = output_region245[[i]][1]
      tmpoutput2 = output_region245[[i]][2]
      tmpoutput3 = output_region245[[i]][3]
      tmpoutput4 = output_region245[[i]][4]
      
      writeRaster(tmpsst1,tmpoutput1,format = 'CDF',overwrite = T)
      writeRaster(tmpsst2,tmpoutput2,format = 'CDF',overwrite = T)
      writeRaster(tmpsst3,tmpoutput3,format = 'CDF',overwrite = T)
      writeRaster(tmpsst4,tmpoutput4,format = 'CDF',overwrite = T)
    }
    
  }
  
  sub_mask_hist_ssp585 <- function(i){
    # using 2003-201412 to training
    library(raster)
    library(ncdf4)
    library(data.table)
    
    tmpsst = try(stack(sst_hist_ssp585[i]),
                 silent = T)
    poly = shapefile(input_poly)
    
    r1 = shapefile(input_crop[1])    
    r2 = shapefile(input_crop[2])    
    r3 = shapefile(input_crop[3])    
    r4 = shapefile(input_crop[4]) 
    if('try-error' %in% class(tmpsst)){
      tmpsst = fread(sst_hist_ssp585[i])
      tmpsst = as.data.frame(tmpsst)
      
      naid = which(is.na(tmpsst[,3]))
      tmpsst = tmpsst[-naid,]
      
      loc = tmpsst[,1:2]
      # import sub regions
      r1e = extent(r1)
      r2e = extent(r2)
      r3e = extent(r3)
      r4e = extent(r4)
      
      id1 = which(loc[,1]>=r1e[1] &
                    loc[,1]<=r1e[2] &
                    loc[,2]>=r1e[3] &
                    loc[,2]<=r1e[4])
      id2 = which(loc[,1]>=r2e[1] &
                    loc[,1]<=r2e[2] &
                    loc[,2]>=r2e[3] &
                    loc[,2]<=r2e[4])
      id3 = which(loc[,1]>=r3e[1] &
                    loc[,1]<=r3e[2] &
                    loc[,2]>=r3e[3] &
                    loc[,2]<=r3e[4])
      id4 = which(loc[,1]>=r4e[1] &
                    loc[,1]<=r4e[2] &
                    loc[,2]>=r4e[3] &
                    loc[,2]<=r4e[4])
      
      tmpsst1 = tmpsst[id1,]
      tmpsst2 = tmpsst[id2,]
      tmpsst3 = tmpsst[id3,]
      tmpsst4 = tmpsst[id4,]
      
      tmpoutput1 = output_region585[[i]][1]
      tmpoutput2 = output_region585[[i]][2]
      tmpoutput3 = output_region585[[i]][3]
      tmpoutput4 = output_region585[[i]][4]
      
      fwrite(tmpsst1,tmpoutput1)
      fwrite(tmpsst2,tmpoutput2)
      fwrite(tmpsst3,tmpoutput3)
      fwrite(tmpsst4,tmpoutput4)
      
    }else{
      tmpsst = mask(tmpsst,poly)
      
      tmpsst1 <- crop(tmpsst,r1)
      tmpsst2 <- crop(tmpsst,r2)
      tmpsst3 <- crop(tmpsst,r3)
      tmpsst4 <- crop(tmpsst,r4)
      
      
      tmpoutput1 = output_region585[[i]][1]
      tmpoutput2 = output_region585[[i]][2]
      tmpoutput3 = output_region585[[i]][3]
      tmpoutput4 = output_region585[[i]][4]
      
      writeRaster(tmpsst1,tmpoutput1,format = 'CDF',overwrite = T)
      writeRaster(tmpsst2,tmpoutput2,format = 'CDF',overwrite = T)
      writeRaster(tmpsst3,tmpoutput3,format = 'CDF',overwrite = T)
      writeRaster(tmpsst4,tmpoutput4,format = 'CDF',overwrite = T)
    }
    
  }
  
  
  i = 1:length(sst_hist_ssp245)
  i <<- i
  
  for(i in 1:8){
    #sub_mask_hist_ssp245(i)
    sub_mask_hist_ssp585(i)
    print(i)
  }
  
  print(paste0('pass_',mode))  
}
mask_crop_cmip6 <- function(
  mode = 'ato'
){
  #input file 
  input_cmip6 = '/media/root/Shen_drive1/CMIP6_combined'
  e_hist_ssp245 = list.files(paste0(input_cmip6,'/E/hist_ssp245'),full.names = T)
  e_hist_ssp585 = list.files(paste0(input_cmip6,'/E/hist_ssp585'),full.names = T)
  pr_hist_ssp245 = list.files(paste0(input_cmip6,'/Pr/hist_ssp245'),full.names = T)
  pr_hist_ssp585 = list.files(paste0(input_cmip6,'/Pr/hist_ssp585'),full.names = T)
  
  e_hist_ssp245 <<- e_hist_ssp245
  e_hist_ssp585 <<- e_hist_ssp585
  pr_hist_ssp245 <<- pr_hist_ssp245
  pr_hist_ssp585 <<- pr_hist_ssp585
  
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  # output file
  
  
  
  
  # 3. cal the sum of total ep
  # units of evapor = mm/s to mm/month *86400*30.5
  # units of pr = mm/s to mm/month *86400*30.5
  
  output_ep = '/media/root/Shen_drive1/CMIP6_e-p'
  dir.create(output_ep)
  output_ep = paste0(output_ep,'/',mode)
  dir.create(output_ep)
  
  ep_ssp245 = paste0(output_ep,'/hist_ssp245')
  ep_ssp585 = paste0(output_ep,'/hist_ssp585')
  
  dir.create(ep_ssp245)
  dir.create(ep_ssp585)
  
  ep_ssp245_region = paste0(ep_ssp245,'/','region',1:4)
  ep_ssp585_region = paste0(ep_ssp585,'/','region',1:4)
  
  sapply(ep_ssp245_region,dir.create)
  sapply(ep_ssp585_region,dir.create)
  
  output_name245 = list.files(paste0(input_cmip6,'/E/hist_ssp245'))
  output_name585 = list.files(paste0(input_cmip6,'/E/hist_ssp585'))
  
  output_region245 = paste0(rep(ep_ssp245_region,8),'/',rep(output_name245,each = 4))
  output_region585 = paste0(rep(ep_ssp585_region,8),'/',rep(output_name585,each = 4))
  
  output_region245 = list(output_region245[1:4],
                          output_region245[5:8],
                          output_region245[9:12],
                          output_region245[13:16],
                          output_region245[17:20],
                          output_region245[21:24],
                          output_region245[25:28],
                          output_region245[29:32])
  output_region585 = list(output_region585[1:4],
                          output_region585[5:8],
                          output_region585[9:12],
                          output_region585[13:16],
                          output_region585[17:20],
                          output_region585[21:24],
                          output_region585[25:28],
                          output_region585[29:32])
  output_region245 <<- output_region245
  output_region585 <<- output_region585
  
  mode <<- mode
  sub_mask_hist_ssp245 <- function(i){
    # using 2003-201412 to training
    library(raster)
    library(ncdf4)
    
    tmpe = stack(e_hist_ssp245[i])
    tmppr = stack(pr_hist_ssp245[i])
    
    tmpe = tmpe*86400*30.5
    tmppr = tmppr*86400*30.5
    
    tmpep = tmpe-tmppr
    
    poly = shapefile(input_poly)
    
    # 1. mask by shapefile polygon 
    tmpep = mask(tmpep,poly)
    # 2. crop by sub-regions 
    r1 = shapefile(input_crop[1])    
    r2 = shapefile(input_crop[2])    
    r3 = shapefile(input_crop[3])    
    r4 = shapefile(input_crop[4])    
    
    tmpep1 <- crop(tmpep,r1)
    tmpep2 <- crop(tmpep,r2)
    tmpep3 <- crop(tmpep,r3)
    tmpep4 <- crop(tmpep,r4)
    
    
    tmpoutput1 = output_region245[[i]][1]
    tmpoutput2 = output_region245[[i]][2]
    tmpoutput3 = output_region245[[i]][3]
    tmpoutput4 = output_region245[[i]][4]
    
    writeRaster(tmpep1,tmpoutput1,format = 'CDF',overwrite = T)
    writeRaster(tmpep2,tmpoutput2,format = 'CDF',overwrite = T)
    writeRaster(tmpep3,tmpoutput3,format = 'CDF',overwrite = T)
    
    if(mode == 'eu' & i ==3){
      tmpep4  = as.data.frame(tmpep4,xy = T)
      library(data.table)
      fwrite(tmpep4,'/media/root/Shen_drive1/CMIP6_e-p/eu/hist_ssp245/region4/his245_CanESM5_200301_205012.csv')
    } else{
      writeRaster(tmpep4,tmpoutput4,format = 'CDF',overwrite = T)
    }
    
    
    
    
  }
  
  sub_mask_hist_ssp585 <- function(i){
    # using 2003-201412 to training
    library(raster)
    library(ncdf4)
    
    tmpe = stack(e_hist_ssp585[i])
    tmppr = stack(pr_hist_ssp585[i])
    
    tmpe = tmpe*86400*30.5
    tmppr = tmppr*86400*30.5
    
    tmpep = tmpe-tmppr
    
    poly = shapefile(input_poly)
    
    # 1. mask by shapefile polygon 
    tmpep = mask(tmpep,poly)
    # 2. crop by sub-regions 
    r1 = shapefile(input_crop[1])    
    r2 = shapefile(input_crop[2])    
    r3 = shapefile(input_crop[3])    
    r4 = shapefile(input_crop[4])    
    
    tmpep1 <<- crop(tmpep,r1)
    tmpep2 <<- crop(tmpep,r2)
    tmpep3 <<- crop(tmpep,r3)
    tmpep4 <<- crop(tmpep,r4)
    
    tmpoutput1 = output_region585[[i]][1]
    tmpoutput2 = output_region585[[i]][2]
    tmpoutput3 = output_region585[[i]][3]
    tmpoutput4 = output_region585[[i]][4]
    
    writeRaster(tmpep1,tmpoutput1,format = 'CDF',overwrite = T)
    writeRaster(tmpep2,tmpoutput2,format = 'CDF',overwrite = T)
    writeRaster(tmpep3,tmpoutput3,format = 'CDF',overwrite = T)
    
    if(mode == 'eu' & i ==3){
      tmpep4  = as.data.frame(tmpep4,xy = T)
      library(data.table)
      fwrite(tmpep4,'/media/root/Shen_drive1/CMIP6_e-p/eu/hist_ssp585/region4/his585_CanESM5_200301_205012.csv')
    } else{
      writeRaster(tmpep4,tmpoutput4,format = 'CDF',overwrite = T)
    }
    
    
    
  }
  
  i = 1:length(e_hist_ssp245)
  i <<- i
  library(doParallel)
  cl = makeCluster(8)
  clusterExport(cl,c('e_hist_ssp245','pr_hist_ssp245','input_poly','input_crop',
                     'output_region245'))
  system.time(parLapply(cl,i,sub_mask_hist_ssp245))
  stopCluster(cl)
  
  
  cl = makeCluster(8)
  clusterExport(cl,c('e_hist_ssp585','pr_hist_ssp585','input_poly','input_crop',
                     'output_region585'))
  system.time(parLapply(cl,i,sub_mask_hist_ssp585))
  stopCluster(cl)
  
  print(paste0('pass_',mode))  
}
mask_era5_e_pr <- function(
  mode = 'ato'
){
  # date 2003 - 2017
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  era5_pr = data_management('era5_pr_include_ocean')
  era5_e = data_management('era5_e_include_ocean')
  era5_e = era5_e * -1
  
  era5_ep = era5_e - era5_pr
  era5_ep <<- era5_ep
  
  ### input shp
  #######
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  #######
  i = 1:4
  print(i)
  i <<- i
  
  ###output
  output_era5_ep_masked = '/media/sdb5/Data/era5_ep_masked'
  dir.create(output_era5_ep_masked)
  
  output1 = paste0(output_era5_ep_masked,'/',mode)
  dir.create(output1)
  output2 = paste0(output1,'/region',1:4)
  sapply(output2,dir.create)
  
  output2 = paste0(output2,'/era5_source_ep_2003_2017.nc')
  
  output2 <<- output2
  
  sub_mask <- function(i){
    library(raster)
    library(ncdf4)
    tmpraster = era5_ep
    
    poly = shapefile(input_poly)
    
    r = mask(tmpraster,poly)
    
    crop1 = shapefile(input_crop[i])
    
    r1 = crop(r,crop1)
    
    writeRaster(r1,output2[i],format = 'CDF',overwrite = T)
  }
  
  library(doParallel)
  cl = makeCluster(4)
  clusterExport(cl,c('i','input_poly','input_crop','era5_ep','output2'))
  system.time(parLapply(cl,i,sub_mask))
  stopCluster(cl)
  
  print(paste0('Pass ',mode))
  
  
  
}
mask_era5_eva <- function(
  mode = 'ato'
){
  # date 2003 - 2017
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  #era5_pr = data_management('era5_pr_include_ocean')
  era5_e = data_management('era5_e_include_ocean')
  era5_e = era5_e * -1
  
  era5_ep = era5_e
  era5_ep <<- era5_ep
  
  ### input shp
  #######
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  #######
  i = 1:4
  print(i)
  i <<- i
  
  ###output
  output_era5_ep_masked = '/media/sdb5/Data/era5_eva_masked_in_source'
  dir.create(output_era5_ep_masked)
  
  output1 = paste0(output_era5_ep_masked,'/',mode)
  dir.create(output1)
  output2 = paste0(output1,'/region',1:4)
  sapply(output2,dir.create)
  
  output2 = paste0(output2,'/era5_source_eva_2003_2017.nc')
  
  output2 <<- output2
  
  sub_mask <- function(i){
    library(raster)
    library(ncdf4)
    tmpraster = era5_ep
    
    poly = shapefile(input_poly)
    
    r = mask(tmpraster,poly)
    
    crop1 = shapefile(input_crop[i])
    
    r1 = crop(r,crop1)
    
    writeRaster(r1,output2[i],format = 'CDF',overwrite = T)
  }
  
  library(doParallel)
  cl = makeCluster(4)
  clusterExport(cl,c('i','input_poly','input_crop','era5_ep','output2'))
  system.time(parLapply(cl,i,sub_mask))
  stopCluster(cl)
  
  print(paste0('Pass ',mode))
  
  
  
}
mask_era5_p_er <- function(
  mode = 'ato'
){
  # date 2003 - 2017
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  era5_pr = data_management('era5_pr_include_ocean')
  era5_e = data_management('era5_e_include_ocean')
  era5_e = era5_e * -1
  
  era5_ep = era5_pr - era5_e
  era5_ep <<- era5_ep
  
  ### input shp
  #######
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  #######
  i = 1:4
  print(i)
  i <<- i
  
  ###output
  output_era5_ep_masked = '/media/sdb5/Data/era5_pe_masked'
  dir.create(output_era5_ep_masked)
  
  output1 = paste0(output_era5_ep_masked,'/',mode)
  dir.create(output1)
  output2 = paste0(output1,'/region',1:4)
  sapply(output2,dir.create)
  
  output2 = paste0(output2,'/era5_source_pe_2003_2017.nc')
  
  output2 <<- output2
  
  sub_mask <- function(i){
    library(raster)
    library(ncdf4)
    tmpraster = era5_ep
    
    poly = shapefile(input_poly)
    
    r = mask(tmpraster,poly)
    
    crop1 = shapefile(input_crop[i])
    
    r1 = crop(r,crop1)
    
    writeRaster(r1,output2[i],format = 'CDF',overwrite = T)
  }
  
  library(doParallel)
  cl = makeCluster(4)
  clusterExport(cl,c('i','input_poly','input_crop','era5_ep','output2'))
  system.time(parLapply(cl,i,sub_mask))
  stopCluster(cl)
  
  print(paste0('Pass ',mode))
  
  
  
}
mask_era5_p <- function(
  mode = 'ato'
){
  # date 2003 - 2017
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  era5_pr = data_management('era5_pr_include_ocean')
  #era5_e = data_management('era5_e_include_ocean')
  #era5_e = era5_e * -1
  
  era5_ep = era5_pr
  era5_ep <<- era5_ep
  
  ### input shp
  #######
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  #######
  i = 1:4
  print(i)
  i <<- i
  
  ###output
  output_era5_ep_masked = '/media/sdb5/Data/era5_pr_masked'
  dir.create(output_era5_ep_masked)
  
  output1 = paste0(output_era5_ep_masked,'/',mode)
  dir.create(output1)
  output2 = paste0(output1,'/region',1:4)
  sapply(output2,dir.create)
  
  output2 = paste0(output2,'/era5_source_pr_2003_2017.nc')
  
  output2 <<- output2
  
  sub_mask <- function(i){
    library(raster)
    library(ncdf4)
    tmpraster = era5_ep
    
    poly = shapefile(input_poly)
    
    r = mask(tmpraster,poly)
    
    crop1 = shapefile(input_crop[i])
    
    r1 = crop(r,crop1)
    
    writeRaster(r1,output2[i],format = 'CDF',overwrite = T)
  }
  
  library(doParallel)
  cl = makeCluster(4)
  clusterExport(cl,c('i','input_poly','input_crop','era5_ep','output2'))
  system.time(parLapply(cl,i,sub_mask))
  stopCluster(cl)
  
  print(paste0('Pass ',mode))
  
  
  
}
mask_era5_poten_evap<-function(
  mode = 'ato'
){
  # date 2003 - 2017
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  era5_pr = data_management('global_era5_poten_evap')
  #era5_e = data_management('era5_e_include_ocean')
  #era5_e = era5_e * -1
  
  era5_ep = era5_pr
  era5_ep <<- era5_ep
  
  ### input shp
  #######
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  #######
  i = 1:4
  print(i)
  i <<- i
  
  ###output
  output_era5_ep_masked = '/media/sdb5/Data/era5_pet_masked'
  dir.create(output_era5_ep_masked)
  
  output1 = paste0(output_era5_ep_masked,'/',mode)
  dir.create(output1)
  output2 = paste0(output1,'/region',1:4)
  sapply(output2,dir.create)
  
  output2 = paste0(output2,'/era5_source_pet_2003_2017.nc')
  
  output2 <<- output2
  
  sub_mask <- function(i){
    library(raster)
    library(ncdf4)
    tmpraster = era5_ep
    
    poly = shapefile(input_poly)
    
    r = mask(tmpraster,poly)
    
    crop1 = shapefile(input_crop[i])
    
    r1 = crop(r,crop1)
    
    writeRaster(r1,output2[i],format = 'CDF',overwrite = T)
  }
  
  library(doParallel)
  cl = makeCluster(4)
  clusterExport(cl,c('i','input_poly','input_crop','era5_ep','output2'))
  system.time(parLapply(cl,i,sub_mask))
  stopCluster(cl)
  
  print(paste0('Pass ',mode))
  
}
mask_era5_sst<-function(
  mode = 'ato'
){
  # date 2003 - 2017
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  era5_pr = data_management('global_era5_sst')
  #era5_e = data_management('era5_e_include_ocean')
  #era5_e = era5_e * -1
  
  era5_ep = era5_pr
  era5_ep <<- era5_ep
  
  ### input shp
  #######
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  #######
  i = 1:4
  print(i)
  i <<- i
  
  ###output
  output_era5_ep_masked = '/media/sdb5/Data/era5_sst_masked'
  dir.create(output_era5_ep_masked)
  
  output1 = paste0(output_era5_ep_masked,'/',mode)
  dir.create(output1)
  output2 = paste0(output1,'/region',1:4)
  sapply(output2,dir.create)
  
  output2 = paste0(output2,'/era5_source_sst_2003_2017.nc')
  
  output2 <<- output2
  
  sub_mask <- function(i){
    library(raster)
    library(ncdf4)
    tmpraster = era5_ep
    
    poly = shapefile(input_poly)
    
    r = mask(tmpraster,poly)
    
    crop1 = shapefile(input_crop[i])
    
    r1 = crop(r,crop1)
    
    writeRaster(r1,output2[i],format = 'CDF',overwrite = T)
  }
  
  library(doParallel)
  cl = makeCluster(4)
  clusterExport(cl,c('i','input_poly','input_crop','era5_ep','output2'))
  system.time(parLapply(cl,i,sub_mask))
  stopCluster(cl)
  
  print(paste0('Pass ',mode))
  
}
mask_era5_temperature<-function(
  mode = 'ato'
){
  # date 2003 - 2017
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  era5_pr = data_management('global_era5_temperature')
  #era5_e = data_management('era5_e_include_ocean')
  #era5_e = era5_e * -1
  
  era5_ep = era5_pr
  era5_ep <<- era5_ep
  
  ### input shp
  #######
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  #######
  i = 1:4
  print(i)
  i <<- i
  
  ###output
  output_era5_ep_masked = '/media/sdb5/Data/era5_tas_masked'
  dir.create(output_era5_ep_masked)
  
  output1 = paste0(output_era5_ep_masked,'/',mode)
  dir.create(output1)
  output2 = paste0(output1,'/region',1:4)
  sapply(output2,dir.create)
  
  output2 = paste0(output2,'/era5_source_tas_2003_2017.nc')
  
  output2 <<- output2
  
  sub_mask <- function(i){
    library(raster)
    library(ncdf4)
    tmpraster = era5_ep
    
    poly = shapefile(input_poly)
    
    r = mask(tmpraster,poly)
    
    crop1 = shapefile(input_crop[i])
    
    r1 = crop(r,crop1)
    
    writeRaster(r1,output2[i],format = 'CDF',overwrite = T)
  }
  
  library(doParallel)
  cl = makeCluster(4)
  clusterExport(cl,c('i','input_poly','input_crop','era5_ep','output2'))
  system.time(parLapply(cl,i,sub_mask))
  stopCluster(cl)
  
  print(paste0('Pass ',mode))
  
}
mask_gpcc_p <- function(
  mode = 'ato'
){
  # date 2003 - 2017
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  era5_pr = data_management('gpcc_full')
  #era5_e = data_management('era5_e_include_ocean')
  #era5_e = era5_e * -1
  
  era5_ep = era5_pr
  era5_ep <<- era5_ep
  
  ### input shp
  #######
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  #######
  i = 1:4
  print(i)
  i <<- i
  
  ###output
  output_era5_ep_masked = '/media/sdb5/Data/gpcc_pr_masked'
  dir.create(output_era5_ep_masked)
  
  output1 = paste0(output_era5_ep_masked,'/',mode)
  dir.create(output1)
  output2 = paste0(output1,'/region',1:4)
  sapply(output2,dir.create)
  
  output2 = paste0(output2,'/gpcc_source_pr_2003_2017.nc')
  
  output2 <<- output2
  
  sub_mask <- function(i){
    library(raster)
    library(ncdf4)
    tmpraster = era5_ep
    
    poly = shapefile(input_poly)
    
    r = mask(tmpraster,poly)
    
    crop1 = shapefile(input_crop[i])
    
    r1 = crop(r,crop1)
    
    writeRaster(r1,output2[i],format = 'CDF',overwrite = T)
  }
  
  library(doParallel)
  cl = makeCluster(4)
  clusterExport(cl,c('i','input_poly','input_crop','era5_ep','output2'))
  system.time(parLapply(cl,i,sub_mask))
  stopCluster(cl)
  
  print(paste0('Pass ',mode))
  
  
  
}
mask_grace_tws <- function(
  mode = 'ato'
){
  # date 2003 - 2017
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  tws = data_management('grace')
  #era5_e = data_management('era5_e_include_ocean')
  #era5_e = era5_e * -1
  
  era5_ep = tws
  era5_ep <<- era5_ep
  
  ### input shp
  #######
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  #######
  i = 1:4
  print(i)
  i <<- i
  
  ###output
  output_era5_ep_masked = '/media/sdb5/Data/tws_in_source'
  dir.create(output_era5_ep_masked)
  
  output1 = paste0(output_era5_ep_masked,'/',mode)
  dir.create(output1)
  output2 = paste0(output1,'/region',1:4)
  sapply(output2,dir.create)
  
  output2 = paste0(output2,'/tws_in_source_2003_2017.nc')
  
  output2 <<- output2
  
  sub_mask <- function(i){
    library(raster)
    library(ncdf4)
    tmpraster = era5_ep
    
    poly = shapefile(input_poly)
    
    r = mask(tmpraster,poly)
    
    crop1 = shapefile(input_crop[i])
    
    r1 = crop(r,crop1)
    
    writeRaster(r1,output2[i],format = 'CDF',overwrite = T)
  }
  
  library(doParallel)
  cl = makeCluster(4)
  clusterExport(cl,c('i','input_poly','input_crop','era5_ep','output2'))
  system.time(parLapply(cl,i,sub_mask))
  stopCluster(cl)
  
  print(paste0('Pass ',mode))
  
  
  
}
mask_points_for_south_xinjiang <-function(
  df_ocean,
  pattern = 'ocean'
){
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world_shp <<- shp_management(pattern = pattern)
  
  df_fullid<<-df_ocean$type
  idu = unique(df_ocean$type)
  df_full = df_ocean
  df_full <<- df_full
  
  group_id_vector<-function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  
  
  gpd <<- group_id_vector(idu)
  source('/home/share/R_project/xinjiang_vapor/mask_points_with_shp.R')
  
  cl = makeCluster(13)
  clusterExport(cl,c('gpd','df_fullid','df_full','world_shp'))
  system.time(
    ret_test_id <- parLapply(cl,gpd,mask_points_with_shp)
  )
  stopCluster(cl)
  
  ret_test_id = do.call('c',ret_test_id)
  
  return(ret_test_id)
}
mask_points_solo_shp<-function(
  df_in,shp
){
  # mask points df with solo thread
  # demands input of df and shp
  library(raster)
  library(maps)
  library(maptools)
  library(data.table)
  dfsce = df_in
  coordinates(dfsce) = ~ long+lat
  proj4string(dfsce) = "+proj=longlat +datum=WGS84 +no_defs"
  
  df_m = over(dfsce,shp)
  df_index = which(!is.na(df_m[,1]))
  return(df_index)
}
mask_points_via_poly_pal_path_mode<-function(
  df_sce,shp_path
){
  # inputdata sec
  # df_sce
  # ncols: long, lat, height, type 
  # group by type short time 
  library(raster)
  library(maps)
  library(maptools)
  library(data.table)
  
  pattern = 'shp_path'
  if(pattern == 'shp_path'){
    world_shp <<- shapefile(shp_path)  
  }else{
    world_shp <<- shp_path
  }
  
  
  df_fullid <<- df_sce$type
  idu = unique(df_sce$type)
  df_full <<- df_sce
  group_id_vector<-function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  
  gpd <<- group_id_vector(idu)
  
  cl = makeCluster(15)
  clusterExport(cl,c('gpd','df_fullid','df_full','world_shp'))
  system.time(
    ret_test_id <- parLapply(cl,gpd,mask_points_with_shp)
  )
  stopCluster(cl)
  ret_test_id = do.call('c',ret_test_id)
  return(ret_test_id)
  
}
mask_points_via_poly_pal<-function(
  df_sce,shp_path
){
  # inputdata sec
  # df_sce
  # ncols: long, lat, height, type 
  # group by type short time 
  library(raster)
  library(maps)
  library(maptools)
  library(data.table)
  
  pattern = 'shp_direct'
  if(pattern == 'shp_path'){
    world_shp <<- shapefile(shp_path)  
  }else{
    world_shp <<- shp_path
  }
  
  
  df_fullid <<- df_sce$type
  idu = unique(df_sce$type)
  df_full <<- df_sce
  group_id_vector<-function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  
  gpd <<- group_id_vector(idu)
  source('/home/share/R_project/xinjiang_vapor/mask_points_with_shp.R')
  cl = makeCluster(13)
  clusterExport(cl,c('gpd','df_fullid','df_full','world_shp'))
  system.time(
    ret_test_id <- parLapply(cl,gpd,mask_points_with_shp)
  )
  stopCluster(cl)
  ret_test_id = do.call('c',ret_test_id)
  return(ret_test_id)
  
}
 mask_points_via_world_continent <- function(
  input_data
){
  
  sub_mask <- function(input_sub){
    source('/home/share/R_project/xinjiang_vapor/mask_points_with_shp.R')
    source('/home/share/R_project/xinjiang_vapor/search_which.R')
    source('/home/share/R_project/xinjiang_vapor/shp_management.R')
    
    df = fread(paste0(input_sub,'/var_whole_route_mid.csv'))
    #df = as.data.frame(df)
    # data_structure
    # c('long','lat','height','ep','type')
    
    # select initialized  id 
    ids = unique(df$type)
    xfull <<- df$type
    df_fullid <<- df$type
    group_id <- function(x){
      step = round(length(x) /100)
      ids = seq(1,length(x),step)
      ide = ids -1
      ide = ide[-1]
      ide = c(ide,length(x))
      xl = list()
      for(i in 1:length(ids)){
        stmp = ids[i]
        etmp = ide[i]
        tmp = x[stmp:etmp]
        xl[[i]] = tmp
      }
      return(xl)
    }
    idsl = group_id(ids)
    system.time(ret_first_id <- lapply(idsl, search_which))
    ret_first_id = do.call('c',ret_first_id)
    
    df_sce = df[ret_first_id,]
    print('mask_points_via_world_continent:_pass return first id phase_')
    # Mask points with shp 
    source('/home/share/R_project/xinjiang_vapor/mask_points_via_poly_pal_path_mode.R')
    shp_path = '/media/sdb1/shp/world_continent.shp'
    ret_test_id = mask_points_via_poly_pal_path_mode(df_sce,shp_path)
    
    df_in_land = df_sce[ret_test_id,]
    df_in_ocean = df_sce[-ret_test_id,]
    
    print('mask_points_via_world_continent:_pass divid land and ocean phase_')
    # mask with each continents
    
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    output_path = paste0(input_sub,'/df_first_ocean')
    dir.create(output_path)
    output_ocean = paste0(output_path,'/',oce_names,'.csv')
    source('/home/share/R_project/xinjiang_vapor/mask_via_each_ocean.R')
    
    for(i in 1:length(oce_names)){
      tmp = mask_via_each_ocean(df_in_ocean,oce_names[i],pattern = 'ocean')
      write.csv(tmp,output_ocean[i])
      print(i)
    }
    print('mask_points_via_world_continent:_pass mask with each ocean phase_')
    # mask with each lands
    con_names = c('as','xj','eu','naf','na')
    output_path = paste0(input_sub,'/df_first_land')
    output_land = paste0(output_path,'/',con_names,'.csv')
    
    for(i in 1:length(con_names)){
      if(con_names[i] =='as'){
        tmp =  mask_via_each_ocean(df_in_land,con_names[i],pattern = 'as_bu_xinjiang')
        write.csv(tmp,output_land[i])
      }else if(con_names[i] =='xj'){
        tmp =  mask_via_each_ocean(df_in_land,con_names[i],pattern = 'xinjiang')
        write.csv(tmp,output_land[i])
      }else{
        tmp = mask_via_each_ocean(df_in_land,con_names[i],pattern = 'land')
        write.csv(tmp,output_land[i])
      }
      
      print(i)
    }
    
    print('mask_points_via_world_continent:_pass mask with each land phase_')
    print(input_sub)
    
  }
  
  sapply(input_data,sub_mask)
  
  gc()
  rm("df")
  rm("df_in_ocean")
  rm("df_in_land")
  rm("ids")
  rm("df_fullid")
  rm("xfull")
  rm("df_sce")
  rm("tmp")
  rm('df_full')
  print('rm done!')
  
}
mask_points_with_shp_cloud<-function(
  x
){
  # sub functions for mask_points_via_poly_pal 
  # has sepcific requirements on global variables declared in above function
  
  sid = min(which(df_fullid == x[1]))
  eid = max(which(df_fullid == x[length(x)]))
  idc = sid:eid
  #print(length(idc))
  
  mask_pal <- function(idc){
    library(raster)
    library(maps)
    library(maptools)
    library(data.table)
    input_df_full = 'tmp/df_full.csv'
    df_full = fread(input_df_full)
    dfsce = df_full[idc,]
    rm(df_full)
    coordinates(dfsce) = ~ long+lat
    proj4string(dfsce) = "+proj=longlat +datum=WGS84 +no_defs"
    
    df_m = over(dfsce,world_shp)
    df_land_index = which(!is.na(df_m[,1]))
    rm(df_m)
    rm(dfsce)
    return(df_land_index)
  }
  
  ret_mask_id = mask_pal(idc)
  ret_mask_id = ret_mask_id + sid -1
  
  
  return(ret_mask_id)
  
}
mask_points_with_shp<-function(
  x
){
  # sub functions for mask_points_via_poly_pal 
  # has sepcific requirements on global variables declared in above function
 
  sid = min(which(df_fullid == x[1]))
  eid = max(which(df_fullid == x[length(x)]))
  idc = sid:eid
  #print(length(idc))
  
  mask_pal <- function(idc){
    library(raster)
    library(maps)
    library(maptools)
    library(data.table)
    #input_df_full = 'tmp/df_full.csv'
    #df_full = fread(input_df_full)
    dfsce = df_full[idc,]
    rm(df_full)
    coordinates(dfsce) = ~ long+lat
    proj4string(dfsce) = "+proj=longlat +datum=WGS84 +no_defs"
    
    df_m = over(dfsce,world_shp)
    df_land_index = which(!is.na(df_m[,1]))
    rm(df_m)
    rm(dfsce)
    return(df_land_index)
  }
  
  ret_mask_id = mask_pal(idc)
  ret_mask_id = ret_mask_id + sid -1
  
  
  return(ret_mask_id)
  
}
mask_via_each_ocean_dep_inxinjiang <-function(
  df_ocean,
  names = 'ao',
  pattern = 'ocean'
){
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world_shp <<- shp_management(names = names,pattern = pattern)
  
  df_fullid <<- df_ocean$type
  idu = unique(df_ocean$type)
  df_full <<- df_ocean
  
  #input_df_full = 'tmp/df_full.csv'
  #fwrite(df_full,input_df_full)
  #rm(df_full)
  
  group_id_vector<-function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  
  gpd <<- group_id_vector(idu)
  source('/home/share/R_project/xinjiang_vapor/mask_points_with_shp.R')
  
  
  cl = makeCluster(15)
  clusterExport(cl,c('gpd','df_fullid','world_shp','df_full'))
  system.time(
    ret_test_id <- parLapply(cl,gpd,mask_points_with_shp)
  )
  stopCluster(cl)
  
  ret_test_id = do.call('c',ret_test_id)
  
  tmpid = df_ocean[ret_test_id,]
  #tmpid = tmpid$type # return type
  
  return(tmpid)
}
mask_via_each_ocean_for_contri_cal_cloud <-function(
  df_ocean,
  names = 'ao',
  pattern = 'ocean'
){
  source('~/shp_management_cloud.R')
  world_shp <<- shp_management_cloud(names = names,pattern = pattern)
  
  df_fullid<<-df_ocean$type
  idu = unique(df_ocean$type)
  df_full = df_ocean
  group_id_vector<-function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  
  input_df_full = 'tmp/df_full.csv'
  fwrite(df_full,input_df_full)
  rm(df_full)
  
  gpd <<- group_id_vector(idu)
  source('~/mask_points_with_shp_cloud.R')
  
  cl = makeCluster(15)
  clusterExport(cl,c('gpd','df_fullid','world_shp'))
  system.time(
    ret_test_id <- parLapply(cl,gpd,mask_points_with_shp_cloud)
  )
  stopCluster(cl)
  
  ret_test_id = do.call('c',ret_test_id)
  
  if(pattern == 'combine_ocean' | pattern =='combine_land'){
    tmpid = df_ocean[-ret_test_id,]
    #return(tmpid)
  }else{
    tmpid = df_ocean[ret_test_id,]
  }
  
  #tmpid = tmpid$type # return type
  
  return(tmpid)
}
mask_via_each_ocean_for_contri_cal <-function(
  df_ocean,
  names = 'ao',
  pattern = 'ocean'
){
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world_shp <<- shp_management(names = names,pattern = pattern)
  
  df_fullid<<-df_ocean$type
  idu = unique(df_ocean$type)
  df_full = df_ocean
  group_id_vector<-function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  
  input_df_full = 'tmp/df_full.csv'
  fwrite(df_full,input_df_full)
  rm(df_full)
  
  gpd <<- group_id_vector(idu)
  source('/home/share/R_project/xinjiang_vapor/mask_points_with_shp.R')
  
  cl = makeCluster(15)
  clusterExport(cl,c('gpd','df_fullid','world_shp'))
  system.time(
    ret_test_id <- parLapply(cl,gpd,mask_points_with_shp)
  )
  stopCluster(cl)
  
  ret_test_id = do.call('c',ret_test_id)
  
  if(pattern == 'combine_ocean' | pattern =='combine_land'){
    tmpid = df_ocean[-ret_test_id,]
    #return(tmpid)
  }else{
    tmpid = df_ocean[ret_test_id,]
  }
  
  #tmpid = tmpid$type # return type
  
  return(tmpid)
}
mask_via_each_ocean <-function(
  df_ocean,
  names = 'ao',
  pattern = 'ocean'
){
  print(names)
  world_shp <<- shp_management(names = names,pattern = pattern)
  
  df_fullid <<- df_ocean$type
  idu = unique(df_ocean$type)
  df_full <<- df_ocean
  group_id_vector<-function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  
  gpd <<- group_id_vector(idu)
  source('/home/share/R_project/xinjiang_vapor/mask_points_with_shp.R')
  
  cl = makeCluster(15)
  clusterExport(cl,c('gpd','df_fullid','df_full','world_shp'))
  system.time(
    ret_test_id <- parLapply(cl,gpd,mask_points_with_shp)
  )
  stopCluster(cl)
  
  ret_test_id = do.call('c',ret_test_id)
  
  tmpid = df_ocean[ret_test_id,]
  tmpid = tmpid$type # return type
  
  return(tmpid)
}
match_by_id<-function(
 output_released,input_contr,mode = 'ao',output
){
  #output_released,input_ocean_contr[i],mode = oce_names[i],output_ocean_contr[i]
  # released calculation
  re_in_aim = fread(output_released)
  re_in_aim = as.data.frame(re_in_aim)
  tt_release = abs(sum(re_in_aim[,2]))
  
  # contr first matrix
  contr_df = fread(input_contr)
  contr_df = as.data.frame(contr_df)
  
  
  if(mode == 'xj'){
    contr_df_above0 = contr_df[which(contr_df$varep_insource<0),] # less zero relesed
    ids_released = which(re_in_aim[,1] %in% contr_df_above0$type)
    re_in_released = re_in_aim[ids_released,]
    
    contr_df_above_released = contr_df_above0[which(contr_df_above0$type %in% re_in_released[,1]),]
    contr_df_above_released$contr_value = re_in_released[,2]
    contr_df_above_released$contr_rate = re_in_released[,2]/tt_release
    
    fwrite(contr_df_above_released,output)
    
  }else{
    contr_df_above0 = contr_df[which(contr_df$varep_insource>0),]
    ids_released = which(re_in_aim[,1] %in% contr_df_above0$type)
    re_in_released = re_in_aim[ids_released,]
    
    contr_df_above_released = contr_df_above0[which(contr_df_above0$type %in% re_in_released[,1]),]
    contr_df_above_released$contr_value = re_in_released[,2]
    contr_df_above_released$contr_rate = abs(re_in_released[,2])/tt_release
    
    fwrite(contr_df_above_released,output)
  }
  
  
  
}
match_convey_and_rel_by_region <- function(
  input_file
){
  
  sub_match <- function(
    input
  ){
    print(paste0('Start ',input))
    
    input_rel_by_region = paste0(input,'/output/xinjiang_release')
    input_rel_north = paste0(input_rel_by_region,'/north')
    input_rel_south = paste0(input_rel_by_region,'/south')
    
    input_rel_north_jishui = paste0(input_rel_north,'/jishui_re.csv')
    input_rel_north_moun = paste0(input_rel_north,'/moun_re.csv')
    
    input_rel_south_jishui = paste0(input_rel_south,'/jishui_re.csv')
    input_rel_south_moun = paste0(input_rel_south,'/moun_re.csv')
    
    input_uptake = paste0(input,'/output/convey_rate_df')
    input_uptake_as = paste0(input_uptake,'/as.csv')
    input_uptake_ato = paste0(input_uptake,'/ato.csv')
    input_uptake_eu = paste0(input_uptake,'/eu.csv')
    
    uptake_as = fread(input_uptake_as)
    uptake_ato = fread(input_uptake_ato)
    uptake_eu = fread(input_uptake_eu)
    
    north_jishui = fread(input_rel_north_jishui)
    north_moun = fread(input_rel_north_moun)
    
    output = paste0(input,'/output/combine_uptake_rel_by_region')
    dir.create(output)
    output_north = paste0(output,'/north')
    output_south = paste0(output,'/south')
    dir.create(output_south)
    dir.create(output_north)
    
    output_north_jishui_as = paste0(output_north,'/jishui_as.csv')
    output_north_jishui_ato = paste0(output_north,'/jishui_ato.csv')
    output_north_jishui_eu = paste0(output_north,'/jishui_eu.csv')
    
    output_north_moun_as = paste0(output_north,'/moun_as.csv')
    output_north_moun_ato = paste0(output_north,'/moun_ato.csv')
    output_north_moun_eu = paste0(output_north,'/moun_eu.csv')
    
    
    match_fun <- function(rel_df,uptake_df,output_file){
      library(dplyr)
      
      tmpid = which(uptake_df$type %in% rel_df$type)
      
      uptake_rel_df = uptake_df[tmpid,]
      
      uptake_rel_df = data.frame(long = uptake_rel_df$long,
                                 lat =  uptake_rel_df$lat,
                                 height = uptake_rel_df$height,
                                 type = uptake_rel_df$type,
                                 uptake = uptake_rel_df$uptake_in_region,
                                 region_id = uptake_rel_df$region_label)
      
      tmpid2 = which(rel_df$type %in% uptake_rel_df$type)
      rel_df_over = rel_df[tmpid2,]
      
      uptake_rel_df$release = rel_df_over$release
      
      fwrite(uptake_rel_df,output_file)
      
    }
    
    match_fun(north_jishui,uptake_as,output_north_jishui_as)
    match_fun(north_jishui,uptake_ato,output_north_jishui_ato)
    match_fun(north_jishui,uptake_eu,output_north_jishui_eu)
    
    match_fun(north_moun,uptake_as,output_north_moun_as)
    match_fun(north_moun,uptake_ato,output_north_moun_ato)
    match_fun(north_moun,uptake_eu,output_north_moun_eu)
    
    print("Pass North")
    south_jishui = fread(input_rel_south_jishui)
    south_moun = fread(input_rel_south_moun)
    
    
    output_south_jishui_as = paste0(output_south,'/jishui_as.csv')
    output_south_jishui_ato = paste0(output_south,'/jishui_ato.csv')
    output_south_jishui_eu = paste0(output_south,'/jishui_eu.csv')
    
    output_south_moun_as = paste0(output_south,'/moun_as.csv')
    output_south_moun_ato = paste0(output_south,'/moun_ato.csv')
    output_south_moun_eu = paste0(output_south,'/moun_eu.csv')
    
    match_fun(south_jishui,uptake_as,output_south_jishui_as)
    match_fun(south_jishui,uptake_ato,output_south_jishui_ato)
    match_fun(south_jishui,uptake_eu,output_south_jishui_eu)
    
    match_fun(south_moun,uptake_as,output_south_moun_as)
    match_fun(south_moun,uptake_ato,output_south_moun_ato)
    match_fun(south_moun,uptake_eu,output_south_moun_eu)
    print('Pass South')
    print(paste0('Pass ',input))
  }
  
  sapply(input_file,sub_match)
    
}
mean_route_by_cl<-function(
  cl_liin
){
  

  
  cl_contr = sum(cl_liin$contr_rate)
  
  #print('1')
  ids = cl_liin$type
  ids = sort(ids)
  xfull <<- df_full_for_cl$type
  df_fullid <<- df_full_for_cl$type
  group_id <- function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  if(length(ids) < 100){
    idsl = list(ids)
  }else{
    idsl = group_id(ids) 
  }
  
  source('/home/share/R_project/xinjiang_vapor/search_which_cl_tr.R')
  system.time(ret_box <- lapply(idsl, search_which_cl_tr))
  
  
  
  mean_fun<-function(x){
    x = mean(x,na.rm = T)
    return(x)
  }
  
  mean_outter_long<-function(x){
    longtmp1 = x[,1]
    return(longtmp1)
  }
  mean_outter_lat<-function(x){
    lattmp1 = x[,2]
    return(lattmp1)
  }
  mean_outter_hei<-function(x){
    heitmp1 = x[,3]
    return(heitmp1)
  }
  
  long_o = lapply(ret_box,mean_outter_long)
  lat_o = lapply(ret_box,mean_outter_lat)
  hei_o = lapply(ret_box,mean_outter_hei)
  
  
  long_o = do.call('rbind',long_o)
  lat_o = do.call('rbind',lat_o)
  hei_o = do.call('rbind',hei_o)
  
  long_o = apply(long_o,2,mean_fun)
  lat_o = apply(lat_o,2,mean_fun)
  hei_o = apply(hei_o,2,mean_fun)
  
  mean_ret_df = data.frame(mean_long = long_o,
                           mean_lat = lat_o,
                           mean_hei = hei_o,
                           contr_r = c(cl_contr,rep(NA,(length(long_o)-1))),
                           cluster = unique(cl_liin$cluster))
  return(mean_ret_df)
  
}
mmk_analysis_pme_ato <-function(
  
){
  input_pr_mask = '/media/sdb5/Data/era5_pr_masked/ato'
  input_pr_mask = list.files(input_pr_mask,
                             full.names = T)
  input_pr_mask = do.call('c',
                          lapply(input_pr_mask,
                                 list.files,
                                 full.names = T))
  input_pet_mask = '/media/sdb5/Data/era5_pet_masked/ato'
  input_pet_mask = list.files(input_pet_mask,
                              full.names = T)
  input_pet_mask = do.call('c',
                           lapply(input_pet_mask,
                                  list.files,
                                  full.names = T))
  
  import_ato_nc <-function(x){
    x = stack(x)
    return(x)
  }
  
  pr_li = lapply(input_pr_mask,
                 import_ato_nc)
  pet_li = lapply(input_pet_mask,
                  import_ato_nc)
  
  pr_ato = do.call('merge',pr_li)
  pet_ato = do.call('merge',pet_li)
  
  pr_ato = pr_ato*30.5
  pme_ato = pr_ato - pet_ato
  
  trans_funRaster <- function(x){
    natell = mean(x)
    if(is.na(natell)){
      return(NA)
    }else{
      xts = ts(x, start = c(2003,1),
               frequency = 12)
      xtst = decompose(xts)$trend
      xtst = 
    }
  }
  
  library(doParallel)
  beginCluster(12)

  pme_mmk = clusterR(pme_ato,calc,args = list(fun = mmkfunRaster))
  endCluster()
  
  output_pme_mmk = 'analysis_output/fig2/pme_ato_mmk.nc'
  writeRaster(pme_mmk,output_pme_mmk,
              format = 'CDF',overwrite = T)  
  
  pme_mmkdf = as.data.frame(pme_mmk,xy = T)
  colnames(pme_mmkdf) = c('long','lat',
                          'pme_mmk')
  
  lessid = which(pme_mmkdf$pme_mmk <0)
  
  pme_mmkdf_less = pme_mmkdf[lessid,]

  pme_mmkdf_less$cuts = 
    cut(pme_mmkdf_less$pme_mmk,
        breaks = c(-45,-10,seq(-9,0,1)))
  
  
  shp_ato = paste0('cluster_shp/ato/','ato',1:4,'.shp')
  shp_ato1 = shapefile(shp_ato[[1]])
  shp_ato2 = shapefile(shp_ato[[2]])
  shp_ato3 = shapefile(shp_ato[[3]])
  shp_ato4 = shapefile(shp_ato[[4]])
  
  pmmk_atopme = ggplot()+
  ######
    geom_polygon(data = shp_ato1,
                 aes(x = long,y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_polygon(data = shp_ato2,
                 aes(x = long,y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_polygon(data = shp_ato3,
                 aes(x = long,y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_polygon(data = shp_ato4,
                 aes(x = long,y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_tile(data = pme_mmkdf_less,
              aes(x = long,y = lat,
                  fill = cuts))+
    scale_fill_brewer(palette = 'Spectral')+
    theme_bw()
  ######
  
  pme_mmkdf$cuts = cut(pme_mmkdf$pme_mmk,
                       breaks = c(-45,-10,seq(-8,0,2),
                                  seq(2,10,2),
                                  50,110))
  naidmmk = which(is.na(pme_mmkdf$pme_mmk))
  pme_mmkdf = pme_mmkdf[-naidmmk,]
  library(RColorBrewer)
  mypal = colorRampPalette(brewer.pal(11,'Spectral'))(13)
  
  pmmk_atopme_full = ggplot()+
    geom_polygon(data = shp_ato1,
                 aes(x = long,y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_polygon(data = shp_ato2,
                 aes(x = long,y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_polygon(data = shp_ato3,
                 aes(x = long,y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_polygon(data = shp_ato4,
                 aes(x = long,y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_tile(data = pme_mmkdf,
              aes(x = long,y = lat,
                  fill = cuts))+
    scale_fill_manual(values = mypal)+
    #scale_fill_brewer(palette = 'Spectral')+
    theme_bw()
    
  
  pme_mmk1 = crop(pme_mmk,shp_ato1)
  pme_mmk2 = crop(pme_mmk,shp_ato2)
  pme_mmk3 = crop(pme_mmk,shp_ato3)
  pme_mmk4 = crop(pme_mmk,shp_ato4)
  
  
}









mmk_analysis_sst_ato <-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/mmk_fundf.R')
  input_sst_mask = '/media/sdb5/Data/era5_sst_masked/ato'
  input_sst_mask = list.files(input_sst_mask,
                              full.names = T)
  input_sst_mask = do.call('c',
                           lapply(input_sst_mask,
                                  list.files,
                                  full.names = T))
  
  import_ato_nc <-function(x){
    x = stack(x)
    return(x)
  }
  
  sst_li = lapply(input_sst_mask,
                  import_ato_nc)
  
  sst_ato = do.call('merge',sst_li)
  
  sst_ato = sst_ato - 273.15
  sst_atodf  = as.data.frame(sst_ato,
                             xy = T)
  
  naidsst = which(is.na(sst_atodf$layer.1))
  sst_atodf = sst_atodf[-naidsst,]
  
  loc = sst_atodf[,c(1,2)]
  sst_atodf = sst_atodf[,-c(1,2)]
  
  sst_atodf = t(sst_atodf)
  
  i = 1:ncol(sst_atodf)
  i <<- i
  sst_atodf <<- sst_atodf
  sub_cal_fun <-function(i){
    tmp = as.numeric(sst_atodf[,i])
    source('/home/share/R_project/xinjiang_vapor/mmk_fundf.R')
    tmp = mmk_fundf(tmp)
    return(tmp)
  }
  
  
  library(doParallel)
  cl = makeCluster(14)
  clusterExport(cl,c('i','sst_atodf'))
  system.time(ret_mmk_sst <-parLapply(cl,i,sub_cal_fun))
  stopCluster(cl)
  
  mmk_sst = do.call('c',ret_mmk_sst)
  mmk_df = data.frame(
    long = loc[,1],
    lat = loc[,2],
    mmk_sst = mmk_sst
  )
  naidsst = which(is.na(mmk_sst))
  mmk_df = mmk_df[-naidsst,]
  output_sst_mmk = 'analysis_output/fig2/sst_mmk.csv'
  fwrite(mmk_df,output_sst_mmk)
  
  mmk_df$cuts = cut(mmk_df$mmk_sst,
                    breaks = c(-20,seq(-10,10,2.5)))
  
  library(metR)
  lessid = which(mmk_df$mmk_sst >0)
  mmk_df = mmk_df[lessid,]
  
  bigdf =  mmk_df[,1:3]
  bigdf$mmk_sst = 1
  coordinates(bigdf) = ~long+lat
  gridded(bigdf) = T
  bigdf = raster(bigdf)
  
  bigdf_poly = rasterToPolygons(bigdf,dissolve = T)
  shapefile(bigdf_poly,'analysis_output/fig2/sst_big0.shp')
  psstmmk = ggplot()+
    ######
  geom_polygon(data = world,
               aes(x = long,y = lat,
                   group = group),
               color = 'black',
               fill = 'transparent',
               size = 0.5)+
    geom_tile(data = mmk_df,
              aes(x = long,y = lat,
                  fill = cuts))+
    geom_contour(data = mmk_df,
              aes(x = long,y = lat,
                  z = mmk_sst),
              binwidth = 2.5)+
    geom_text_contour(
      data = mmk_df,
      aes(x = long,y = lat,z = mmk_sst),
      binwidth = 2.5,
      check_overlap = T,
      size = 5
    )+
    scale_color_brewer(palette = 'Spectral')+
    scale_fill_brewer(palette = 'Spectral')+
    theme_bw()
  ######
  
}









mmk_fundf <-function(x){
  x = as.numeric(x)
  xtell = mean(x)
  if(is.na(xtell)){
    x = NA
  }else{
    x = as.numeric(x)
    source('/home/share/R_project/xinjiang_vapor/mmkTrend.R')
    
    mmk = mmkTrend(x)$Zc
    mmk = as.numeric(mmk)
    x = mmk
  }
  return(x)
}
mmk_monthly_analysis <-function(
  
){
  tws = data_management('grace')
  world = shp_management('world')
  
  world = crop(world,extent(-180,180,0,90))
  
  tws = crop(tws,world)
  tws = mask(tws,world)
  
  
  janid = seq(1,174,12)
  febid = seq(2,174,12)
  marid = seq(3,174,12)
  aprid = seq(4,174,12)
  mayid = seq(5,174,12)
  junid = seq(6,174,12)
  julid = seq(7,174,12)
  augid = seq(8,174,12)
  sepid = seq(9,174,12)
  octid = seq(10,174,12)
  novid = seq(11,174,12)
  decid = seq(12,174,12)
  
  monid = list(janid,febid,marid,aprid,
               mayid,junid,julid,augid,
               sepid,octid,novid,decid)
  
  
  
  monid <<- monid
  tws <<- tws
  
  cell_mean_fun <-function(i){
    tmpid = monid[[i]]
    tmptws = tws[[tmpid]]
    
    
    tmptwsdf = as.data.frame(tmptws,
                             xy = T)
    loc = tmptwsdf[,1:2]
    tmptwsdf = tmptwsdf[,-c(1,2)]
    
    tmptwsmean = apply(tmptwsdf,1,mean
                       ,na.rm = T)
    retbox = cbind(loc,tmptwsmean)
    return(retbox)
  }
  
  i = 1:length(monid)
  mon_mean_box = lapply(i,cell_mean_fun)
  
  twsmmk1 = mon_mean_box[[1]]
  twsmmk2 = mon_mean_box[[2]][,3]
  twsmmk3 = mon_mean_box[[3]][,3]
  twsmmk4 = mon_mean_box[[4]][,3]
  twsmmk5 = mon_mean_box[[5]][,3]
  twsmmk6 = mon_mean_box[[6]][,3]
  twsmmk7 = mon_mean_box[[7]][,3]
  twsmmk8 = mon_mean_box[[8]][,3]
  twsmmk9 = mon_mean_box[[9]][,3]
  twsmmk10 = mon_mean_box[[10]][,3]
  twsmmk11 = mon_mean_box[[11]][,3]
  twsmmk12 = mon_mean_box[[12]][,3]
  
  twsmmk_mon = cbind(twsmmk1,
                     twsmmk2,
                     twsmmk3,
                     twsmmk4,
                     twsmmk5,
                     twsmmk6,
                     twsmmk7,
                     twsmmk8,
                     twsmmk9,
                     twsmmk10,
                     twsmmk11,
                     twsmmk12)
  

  colnames(twsmmk_mon) = c('long','lat',
                           toupper(month.abb))
  dir.create('analysis_output/fig3')
  #output = 'analysis_output/fig3/twsmean_mon.csv'
  
  #fwrite(twsmmk_mon,output)
  #twsmean_mon = twsmmk_mon
  twsmmk_mon = fread('analysis_output/fig3/twsmean_mon.csv')
  twsmmk_mon =as.data.frame(twsmmk_mon)
  
  loc = twsmmk_mon[,1:2]
  twsmmk_mon = twsmmk_mon[,-c(1,2)]
  idnan = which(is.na(twsmmk_mon$JAN))
  
  loc = loc[-idnan,]
  twsmmk_mon = twsmmk_mon[-idnan,]
  
  shp_as = shp_management('land','as')
  shp_eu = shp_management('land','eu')
  shp_naf = shp_management('land','naf')
  shp_as_eu = bind(shp_as,shp_eu,shp_naf)
  ex_as_ato = extent(shp_as_eu)
  ex_as_ato = extent(-50,ex_as_ato[2],ex_as_ato[3],
                     ex_as_ato[4])
  
  i <<- 1:12
  loc <<- loc
  shp_as_eu <<- shp_as_eu
  ex_as_ato <<- ex_as_ato
  twsmmk_mon <<- twsmmk_mon
  
  crop_mask_sub <- function(i){
    tmp = twsmmk_mon[,i]
    tmp = as.numeric(tmp)
    tmpdf = data.frame(loc,tmp)
    
    coordinates(tmpdf) = ~long + lat
    gridded(tmpdf) = T
    tmpdf = raster(tmpdf)
    
    tmpdf = mask(tmpdf,shp_as_eu)
    tmpdf = crop(tmpdf,ex_as_ato)
    
    tmpdf = as.data.frame(tmpdf,xy = T)
    
    return(tmpdf)
    
  }
  
  full_df_li = lapply(i,crop_mask_sub)
  
  full_df = data.frame(
    long = full_df_li[[1]][,1],
    lat = full_df_li[[1]][,2],
    JAN = full_df_li[[1]][,3],
    FEB = full_df_li[[2]][,3],
    MAR = full_df_li[[3]][,3],
    APR = full_df_li[[4]][,3],
    MAY = full_df_li[[5]][,3],
    JUN = full_df_li[[6]][,3],
    JUL = full_df_li[[7]][,3],
    AUG = full_df_li[[8]][,3],
    SEP = full_df_li[[9]][,3],
    OCT = full_df_li[[10]][,3],
    NOV = full_df_li[[11]][,3],
    DEC = full_df_li[[12]][,3]
  )
  
  idnan = which(is.na(full_df$JAN))
  full_df = full_df[-idnan,]
  fulldfm = reshape2::melt(full_df,
                           c('long','lat'))
  
  lessid= which(fulldfm$value<0)
  fulldfm = fulldfm[lessid,]
  fulldfm$cuts = cut(fulldfm$value,
                     breaks = c(-50,-20,seq(-10,0,1)))
  tws_fill = colorRampPalette(
    brewer.pal(11,'Spectral')
  )(12)
  
  # import pme pattern 
  input_pme_mean = 'analysis_output/fig3/pmemean_mon.csv'
  pme_mean = as.data.frame(fread(input_pme_mean))
  naidpme = which(is.na(pme_mean$JAN))
  pme_mean = pme_mean[-naidpme,]
  
  pme_df = reshape2::melt(pme_mean,
                          c('long','lat'))
  
  pme_df$pme_cuts = cut(pme_df$value,
                        breaks = c(-375,-200,
                                   seq(-100,100,10),
                                   200,
                                   400,
                                   700
                                   ))
  
  pme_fill = colorRampPalette(
    brewer.pal(11,'Spectral')
  )(25)
  
  fulldfm$variable = factor(fulldfm$variable,
                            levels = c(toupper(month.abb)[1:12]))
  pme_df$variable = factor(pme_df$variable,
                           levels = c(toupper(month.abb)[1:12]))
  monname = c('JAN','FEB','MAR','APR','MAY',"JUN",
              'JUL',"AUG",'SEP','OCT','NOV',"DEC")
  input_monthly_traj = 'monthly_kmeans_traj'
  #dir.create(input_monthly_traj)
  input_monthly_traj = paste0(input_monthly_traj,'/',
                              monname,'.csv')
  
  df = lapply(input_monthly_traj,fread)
  traj_df_by_mon = do.call('rbind',df)
  traj_df_by_mon$group = paste0(traj_df_by_mon$month,'_',
                                traj_df_by_mon$routeid)
  traj_df_by_mon$variable = traj_df_by_mon$month
  traj_df_by_mon$variable = factor(traj_df_by_mon$variable,
                                   levels = c(toupper(month.abb)[1:12]))
  
  label_df = data.frame(
    x = rep(-170,12),
    y = rep(10,12),
    label = paste0('(',c(letters[1:12]),')'),
    variable = c(toupper(month.abb)[1:12])
    
  )
  
  # input of currents ocean
  cur_df = as.data.frame(
    fread('analysis_output/fig4/current_df.csv')
  )
  
  idless50 = which(cur_df$lat <= 50)
  cur_df = cur_df[idless50,]
  
  idbig1 = which(cur_df$u>0 &
                   cur_df$v >0)
  idbig2 = which(cur_df$u<0 &
                   cur_df$v >0)
  
  cur_df1 = cur_df[idbig1,]
  cur_df2 = cur_df[idbig2,]
  
  cid1 = seq(1,nrow(cur_df1),30)
  cid2 = seq(1,nrow(cur_df2),200)
  
  cur_df1 = cur_df1[cid1,]
  cur_df2 = cur_df2[cid2,]
  
  
  cols_cur = c('#E6E6FA','#FFE4E1')
  
  p1 = ggplot()+
    ###################
    geom_polygon(data = world,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    
    geom_tile(data = fulldfm,
              aes(x = long,y = lat,fill = cuts))+
    scale_fill_manual(values = tws_fill,
                      guide = guide_legend(nrow = 4,
                                           title.position = 'top',
                                           title = 'TWS_MON_MEAN'))+
    new_scale_fill()+
    geom_tile(data = pme_df,
              aes(x = long,y = lat,fill = pme_cuts))+
    scale_fill_manual(values = pme_fill,
                      guide = guide_legend(nrow = 4,
                                           title.position = 'top',
                                           title = 'PME_MON_MEAN'))+
    geom_polygon(data = xj,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    geom_path(data = traj_df_by_mon,aes(x = long,y = lat,
                                        group = group),
              color = '#3A5FCD',size = 0.5 )+
    geom_hline(yintercept = 30,linetype  = 'dashed',
               size = 0.5)+
    geom_hline(yintercept = 60,linetype  = 'dashed',
               size = 0.5)+
    #scale_color_manual(values = mycolor)+
    geom_text(data = label_df,
              aes(x = x,y = y,label = label),
              fontface =  'bold',
              color = 'black',
              size = 5)+
    
    facet_wrap(~variable)+
    ###################
    theme_bw()+
    #guides(fill = guide_legend(nrow = 2))+
    xlab('Longitude')+
    ylab('Latitude')
  
  fontsize = 12
  text_theme_set = theme(
    ##########
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize,
      face = 'bold'),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
    ##########
  )
  
  p1 = p1+ text_theme_set+
    theme(
      legend.position = 'none'
    )
  
  
  p2 = ggplot()+
    ###################
  geom_polygon(data = world,
               aes(x = long,y = lat,group = group),
               fill = 'transparent',
               color = 'black',
               size = 0.5)+
    
    geom_tile(data = fulldfm,
              aes(x = long,y = lat,fill = cuts),
              show.legend = F)+
    scale_fill_manual(values = tws_fill)+
    new_scale_fill()+
    geom_tile(data = pme_df,
              aes(x = long,y = lat,fill = pme_cuts))+
    scale_fill_manual(values = pme_fill,
                      guide = guide_legend(nrow = 4,
                                           title.position = 'top',
                                           title = 'PME_MON_MEAN'))+
    geom_polygon(data = xj,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    geom_path(data = traj_df_by_mon,aes(x = long,y = lat,
                                        group = group),
              color = '#3A5FCD',size = 0.5 )+
    geom_hline(yintercept = 30,linetype  = 'dashed',
               size = 0.5)+
    geom_hline(yintercept = 60,linetype  = 'dashed',
               size = 0.5)+
    #scale_color_manual(values = mycolor)+
    geom_text(data = label_df,
              aes(x = x,y = y,label = label),
              fontface =  'bold',
              color = 'black',
              size = 5)+
    facet_wrap(~variable)+
    ###################
  theme_bw()+
    #guides(fill = guide_legend(nrow = 2))+
    theme(
      legend.position = 'bottom'
    )+
    text_theme_set
  
  p2_leg = as_ggplot(get_legend(p2))
  
  p3 = ggplot()+
    ###################
  geom_polygon(data = world,
               aes(x = long,y = lat,group = group),
               fill = 'transparent',
               color = 'black',
               size = 0.5)+
    
    geom_tile(data = fulldfm,
              aes(x = long,y = lat,fill = cuts))+
    scale_fill_manual(values = tws_fill,
                      guide = guide_legend(nrow = 4,
                                           title.position = 'top',
                                           title = 'TWS_MON_MEAN'))+
    new_scale_fill()+
    geom_tile(data = pme_df,
              aes(x = long,y = lat,fill = pme_cuts),
              show.legend = F)+
    scale_fill_manual(values = pme_fill)+
    geom_polygon(data = xj,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    geom_path(data = traj_df_by_mon,aes(x = long,y = lat,
                                        group = group),
              color = '#3A5FCD',size = 0.5 )+
    geom_hline(yintercept = 30,linetype  = 'dashed',
               size = 0.5)+
    geom_hline(yintercept = 60,linetype  = 'dashed',
               size = 0.5)+
    #scale_color_manual(values = mycolor)+
    geom_text(data = label_df,
              aes(x = x,y = y,label = label),
              fontface =  'bold',
              color = 'black',
              size = 5)+
    facet_wrap(~variable)+
    ###################
  theme_bw()+
    #guides(fill = guide_legend(nrow = 2))+
    theme(
      legend.position = 'bottom'
    )+text_theme_set
  
  p3_leg = as_ggplot(get_legend(p3))
  
  leg = plot_grid(
    p3_leg,p2_leg,
    nrow = 1,
    rel_heights = c(1,1),
    align = 'hv',
    axis = 'b'
  )
  library(cowplot)
  p123 = plot_grid(
    p1,leg,
    axis = 'l',
    align = 'h',
    ncol = 1,
    rel_heights = c(8,1),
    rel_widths = c(1,0.5)
  )
  p1 = p1+theme(legend.position = 'bottom')
  dir.create('main_plot/SI')
  dir.create('main_plot/SI/Monthly_mean_tws_anomaly_evolu')

  png('main_plot/SI/Monthly_mean_tws_anomaly_evolu/Monthly_mean_tws_anomaly_evolu4.png',
             height = 25,
             width = 35,
             units = 'cm',
             res = 800)
  
  print(p1)
  dev.off()
  png('main_plot/SI/Monthly_mean_tws_anomaly_evolu/leg1.png',
      height = 5,
      width = 35,
      units = 'cm',
      res = 800)
  
  print(leg)
  dev.off()
  
}
mmk_trend_analysis_for_subs_ato_mean <- function(
  
){
  input_tws = 'analysis_output/fig4/project_tws'
  input_tws = list.files(input_tws,full.names = T)
  
  tws245_mean = as.data.frame(
    fread(input_tws[2])
  )
  tws585_mean = as.data.frame(
    fread(input_tws[4])
  )
  colnames(tws245_mean) = c('date',
                            'variable',
                            'value')
  colnames(tws585_mean) = c('date',
                            'variable',
                            'value')
  
  vars = paste0('SW',1:10)
  mmks245 = 1
  mmks585 = 1
  for(i in 1:length(vars)){
    tmpid = which(tws245_mean$variable %in% vars[i])
    tmptws245 = tws245_mean[tmpid,3]
    tmptws585 = tws585_mean[tmpid,3]
    
    mmk245 = mmkTrend(as.numeric(tmptws245))$Zc
    mmk585 = mmkTrend(as.numeric(tmptws585))$Zc
    
    mmks245 = c(mmks245,mmk245)
    mmks585 = c(mmks585,mmk585)
  }
  mmks245 = mmks245[-1]
  mmks585 = mmks585[-1]

  dftws_mmk_245 = data.frame(
    Region = vars,
    MMK = mmks245
  )
  dftws_mmk_585 = data.frame(
    Region = vars,
    MMK = mmks585
  )
  
  output_mean_mmk = 'analysis_output/fig4/bars_mmk_mean'
  dir.create(output_mean_mmk)
  output1 = paste0(output_mean_mmk,'/','substws_mmk245.csv')
  output2 = paste0(output_mean_mmk,'/','substws_mmk585.csv')
  
  fwrite(dftws_mmk_245,output1)
  fwrite(dftws_mmk_585,output2)
  
  ## mmk analysis for pme1 and pme3
  source('/home/share/R_project/xinjiang_vapor/import_pme_ato_fig4.R')
  dfpme = import_pme_ato_fig4(T)
  
  vars1 = c('SSP245_PME1','SSP245_PME3')
  vars2 = c('SSP585_PME1','SSP585_PME3')
  
  mmks_245 = 1
  mmks_585 = 1
  for(i in 1:length(vars1)){
    tmp1 = dfpme[which(dfpme$type %in% vars1[i]),3]
    tmp2 = dfpme[which(dfpme$type %in% vars2[i]),3]
    
    tmp1mmk = mmkTrend(as.numeric(tmp1))$Zc
    tmp2mmk = mmkTrend(as.numeric(tmp2))$Zc
    
    mmks_245 = c(mmks_245,tmp1mmk)
    mmks_585 = c(mmks_585,tmp2mmk)
  }
  mmks_245 = mmks_245[-1]
  mmks_585 = mmks_585[-1]
  
  output3 = paste0(output_mean_mmk,'/',
                   'pme_mmk_ssp245.csv')
  output4 = paste0(output_mean_mmk,'/',
                   'pme_mmk_ssp585.csv')
  atodfmmks_245 = data.frame(
    Region = c('ATO1','ATO3'),
    MMK = mmks_245
  )
  atodfmmks_585 = data.frame(
    Region = c('ATO1','ATO3'),
    MMK = mmks_585
  )
  
  fwrite(atodfmmks_245,output3)
  fwrite(atodfmmks_585,output4)
  
  
    
  
}
mmk_trend_analysis_pme_ato <- function(
  
){
  input_pme_ato = '/media/root/Shen_drive1/CMIP6_pme/ato'
  
  input = list.files(input_pme_ato,full.names = T)
  input245 = input[1]
  input585 = input[2]
  
  input245 = list.files(input245,full.names = T)
  input585 = list.files(input585,full.names = T)
  
  input_shp = list.files('cluster_shp/ato',
                         pattern = '*.shp$',
                         full.names = T)[1:4]
  
  output = 'analysis_output/fig4/atopmemmk_raster'
  dir.create(output)
  
  output245 = paste0(output,'/ssp245')
  output585 = paste0(output,'/ssp585')
  
  dir.create(output245)
  dir.create(output585)
  
  output245 = paste0(output245,'/','region',1:4)
  output585 = paste0(output585,'/','region',1:4)
  
  lapply(output245,dir.create)
  lapply(output585,dir.create)
  
  modelnames = c('ACCESS-ESM1-5',
                 'BCC-CSM2-MR',
                 'CanESM5',
                 'GFDL-ESM4',
                 'IPSL-CM6A-LR',
                 'MIROC6',
                 'MRI-ESM2-0',
                 'NorESM2-LM')
  outfiles = paste0(modelnames,'_2018_2020_','mmk.nc')
  
  r1whole = list()
  r2whole = list()
  for(i in 1:4){
    print(i)
    tmpin245 = list.files(input245[i],full.names = T)
    tmpin585 = list.files(input585[i],full.names = T)
    
    tmpoutput245 = output245[i]
    tmpoutput585 = output585[i]    
    
    r1li = list()
    r2li = list()
    for(j in 1:length(tmpin245)){
      tmpr245 = stack(tmpin245[j])
      tmpr585 = stack(tmpin585[j])
      
      tmpr245df = as.data.frame(tmpr245,xy = T)
      tmpr585df = as.data.frame(tmpr585,xy = T)
      
      naid1 = which(is.na(tmpr245df[,3]))
      naid2 = which(is.na(tmpr585df[,3]))
      
      tmpr245df = tmpr245df[-naid1,]
      tmpr585df = tmpr585df[-naid2,]
      
      loc245 = tmpr245df[,1:2]
      loc585 = tmpr585df[,1:2]
      
      df245 = t(tmpr245df[,-c(1,2)])
      df585 = t(tmpr585df[,-c(1,2)])
      
      loc2018 = length(2003:2017)*12-5
      loc2050 = nrow(df245)
      
      df245 = df245[loc2018:loc2050,]
      df585 = df585[loc2018:loc2050,]
      
      source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
      df245 = trend_fun(df245)
      df585 = trend_fun(df585)
      
      naid = which(is.na(df245[,1]))
      df245 = df245[-naid,]
      df585 = df585[-naid,]
      
      sub_cal_mmk245 <- function(k){
        source('/home/share/R_project/xinjiang_vapor/mmkTrend.R')
        x = df245[,k]
        x = as.numeric(x)
        if(!is.na(mean(x))){
          mmk = mmkTrend(x)$Zc
        }else{
          mmk = NA
        }
        return(mmk)
      }
      sub_cal_mmk585 <- function(k){
        source('/home/share/R_project/xinjiang_vapor/mmkTrend.R')
        x = df585[,k]
        x = as.numeric(x)
        if(!is.na(mean(x))){
          mmk = mmkTrend(x)$Zc
        }else{
          mmk = NA
        }
        return(mmk)
      }
      
      k = 1:ncol(df245)
      k <<- k
      df245 <<-df245
      df585 <<- df585
      
      cl = makeCluster(10)
      clusterExport(cl,c('k','df245'))
      system.time(mmk245 <- parLapply(cl,k,
                                       sub_cal_mmk245))
      stopCluster(cl)
      
      cl = makeCluster(10)
      clusterExport(cl,c('k','df585'))
      system.time(mmk585 <- parLapply(cl,k,
                                       sub_cal_mmk585))
      stopCluster(cl)
      
      mmk245 = do.call('c',mmk245)
      mmk585 = do.call('c',mmk585)
      
      mmk245 = data.frame(
        long = loc245[,1],
        lat = loc245[,2],
        mmk = mmk245
      )
      mmk585 = data.frame(
        long = loc585[,1],
        lat = loc585[,2],
        mmk = mmk585
      )
      
      coordinates(mmk245) = ~long+lat
      gridded(mmk245) = T
      r1 = raster(mmk245)
      
      coordinates(mmk585) = ~long+lat
      gridded(mmk585) = T
      r2 = raster(mmk585)
      
      tmpres = res(r1)
      
      if(tmpres[1] != 1.125 |
         tmpres[2] != 1.125){
        
        refer = stack(tmpin245[2])[[1]]
        r1 = resample(r1,refer)
        r2 = resample(r2,refer)
      }
     
      output_245_raster = paste0(tmpoutput245,'/',
                                 outfiles[j])
      output_585_raster = paste0(tmpoutput585,
                                 '/',
                                 outfiles[j])
      library(ncdf4)
      library(raster)
      writeRaster(r1,output_245_raster,
                  overwrite =T)
      
      writeRaster(r2,output_585_raster,
                  overwrite = T)
      
      r1li = c(r1li,r1)
      r2li = c(r2li,r2)
      
    }
    
    r1li1 = try(stack(r1li),silent = T)
    r2li1 = try(stack(r2li),silent = T)
    
    if('try-error' %in% class(r1li1) | 
       'try-error' %in% class(r2li1)){
      
      for(k in 1:length(r1li)){
       if(k != 2 | k!=7){
         r1li[[k]] = crop(r1li[[k]],
                          extent(r1li[[2]]))
         r2li[[k]] = crop(r2li[[k]],
                          extent(r2li[[2]]))
       }
      }
      r1li1 = stack(r1li)
      r2li1 = stack(r2li)
    }
    
    r1_mean = calc(r1li1,mean,na.rm = T)
    r2_mean = calc(r2li1,mean,na.rm= T)
    
    r1whole = c(r1whole,r1_mean)
    r2whole = c(r2whole,r2_mean)
  }
  
  r1whole = do.call('merge',r1whole)
  r2whole = do.call('merge',r2whole)
  
  output_mean_r1 = 'analysis_output/fig4/ato_mmk_ssp245.nc'
  output_mean_r2 = 'analysis_output/fig4/ato_mmk_ssp585.nc'
  
  writeRaster(r1whole,output_mean_r1,
              overwrite = T)
  writeRaster(r2whole,output_mean_r2,
              overwrite = T)
  
  
}
mmk_tws_analysis <-function(
  
){
  tws = data_management('grace')
  
  beginCluster(12)
  tws_mmk = clusterR(tws,calc,
                     args = list(fun=mmkfun))
  endCluster()
  
  
  tws = mask(tws,world)
  
  tws = crop(tws,world)
  tws = mask(tws,world)
  
  tws_mmk_df = as.data.frame(tws_mmk,xy = T)
  
  id = which(is.na(tws_mmk_df$layer))
  tws_mmk_df = tws_mmk_df[-id,]
  tws_mmk_df = tws_mmk_df[-which(tws_mmk_df$layer>0),]
  
  
  tws_mmk_df$cuts = cut(tws_mmk_df$layer,
                        breaks = c(-700,seq(-20,0,2)))
  fwrite(tws_mmk_df,'analysis_output/fig2/tws_mmk_df.csv')
  fwrite(cluster_traj_df,'analysis_output/fig2/cluster_traj_df.csv')
  pmmk = ggplot()+
    geom_polygon(data = world,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    geom_tile(data = tws_mmk_df,
              aes(x = x,y= y,fill = cuts))+
    geom_polygon(data = xj,
                 aes(x = long,y= lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    geom_polygon(data = shp_com,
                 aes(x = long,y= lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    scale_fill_brewer(palette = 'Spectral')+
    geom_path(data = cluster_traj_df,aes(x = long,y = lat,
                                         group = routeid,
                                         color = factor(routeid)),
              size = 1,
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="closed"))+
    theme_bw()
}
mmk_tws_trend_analysis <-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  
  tws = data_management('grace')
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  tws = crop(tws,world)
  tws = mask(tws,world)
  
  twsdf = as.data.frame(tws,xy = T)
  loc = twsdf[,1:2]
  twsdf = twsdf[,-c(1,2)]
  
  library(doParallel)
  library(raster)
  twsdf <<- twsdf
  sub_cal_twsmmk <- function(i){
    source('/home/share/R_project/xinjiang_vapor/trend_funRaster.R')
    x = twsdf[i,]
    xm = trend_funRaster(x)
    return(xm)
  }
  i <<- 1:nrow(twsdf)
  cl = makeCluster(14)
  clusterExport(cl,c('twsdf','i'))
  system.time(twsmmk <- parLapply(cl,i,sub_cal_twsmmk))
  stopCluster(cl)
  
  twsmmkdf = do.call('c',twsmmk)
  twsmmkdf = data.frame(loc,twsmmkdf)
  
  colnames(twsmmkdf) = c('long','lat','twsmmk')
  
  xj= shp_management('xinjiang')
  cluster_traj_df = read.csv('analysis_output/fig2/cluster_traj_df.csv',
                             header = T)
  
  naidmmk = which(is.na(twsmmkdf$twsmmk))
  twsmmkdf = twsmmkdf[-naidmmk,]
  lessid = which(twsmmkdf$twsmmk<0)
  twsmmkdf = twsmmkdf[lessid,]
  
  twsmmkdf$cuts = cut(twsmmkdf$twsmmk,
                      breaks = seq(-24,0,2))
  pmmk = ggplot()+
    geom_polygon(data = world,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    geom_tile(data = twsmmkdf,
              aes(x = long,y= lat,fill = cuts))+
    geom_polygon(data = xj,
                 aes(x = long,y= lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    #geom_polygon(data = shp_com,
    #             aes(x = long,y= lat,group = group),
    #             fill = 'transparent',
    #             color = 'black',
    #            size = 0.5)+
    scale_fill_brewer(palette = 'Spectral')+
    geom_path(data = cluster_traj_df,aes(x = long,y = lat,
                                         group = routeid,
                                         color = factor(routeid)),
              size = 1,
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="closed"))+
    theme_bw()
  
  
  
  
  
}
mmkfunRaster<-function(x){
  xmean = mean(x)
  if(is.na(xmean)){
    x = NA
  }else{
    source('/home/share/R_project/xinjiang_vapor/mmkTrend.R')
    x = mmkTrend(x)$Zc
    x = as.numeric(x)
  }
  return(x)
}
mmkTrend <-
  function(x, ci = .95) {
    x = x
    z = NULL
    z0 = NULL
    pval = NULL
    pval0 = NULL
    S = 0
    Tau = NULL
    essf = NULL
    ci = ci
    if (is.vector(x) == FALSE) {
      stop("Input data must be a vector")
    }
    if (any(is.finite(x) == FALSE)) {
      x[-c(which(is.finite(x) == FALSE))] -> x
      warning("The input vector contains non-finite numbers. An attempt was made to remove them")
    }
    n <- length(x)
    for (i in 1:(n-1)) {
      for (j in (i+1):n) {
        S = S + sign(x[j]-x[i])
      }
    }
    acf(rank(lm(x ~ I(1:n))$resid), lag.max=(n-1), plot=FALSE)$acf[-1] -> ro
    qnorm((1+ci)/2)/sqrt(n) -> sig
    rep(NA,length(ro)) -> rof
    for (i in 1:(length(ro))) {
      if(ro[i] > sig || ro[i] < -sig) {
        rof[i] <- ro[i]
      } else {
        rof[i] = 0
      }
    }
    2 / (n*(n-1)*(n-2)) -> cte
    ess=0
    for (i in 1:(n-1)) {          
      ess = ess + (n-i)*(n-i-1)*(n-i-2)*rof[i]
    }
    essf = 1 + ess*cte
    var.S = n*(n-1)*(2*n+5)*(1/18) 
    if(length(unique(x)) < n) {
      unique(x) -> aux
      for (i in 1:length(aux)) {
        length(which(x == aux[i])) -> tie
        if (tie > 1) {
          var.S = var.S - tie*(tie-1)*(2*tie+5)*(1/18)  
        }
      }
    }
    VS = var.S * essf            
    if (S == 0) {
      z = 0
      z0 = 0
    }
    if (S > 0) {
      z = (S-1)/sqrt(VS) 
      z0 = (S-1)/sqrt(var.S)
    } else {
      z = (S+1)/sqrt(VS) 
      z0 = (S+1)/sqrt(var.S)
    }      
    pval = 2*pnorm(-abs(z))
    pval0 = 2*pnorm(-abs(z0)) 
    Tau = S/(.5*n*(n-1))
    rep(NA, times=(n^2-n)/2) -> V
    k = 0
    for (i in 2:n) {
      for (j in 1:i) {
        k = k+1
        V[k] = (x[i]-x[j])/(i-j)
        
      }
    }
    median(na.omit(V)) -> slp
    return(list("Z" = z0, "p.value" = pval0, "Zc" = z, "Corrected p.value" = pval, "tau" = Tau, "N/N*s" = essf, "Sen's Slope" = slp))
  }
modify_parttotext<-function(
  
){
  inputpath = '/media/sdb5'
  files = list.files(inputpath,pattern = 'xinjiang[0-9]*',full.names = T)
  fname = 'parttotext.m'
  files = paste0(files,'/',fname)
  
  for (i in 1:length(files)){
    f = files[i]
    fc = readLines(f)
    fc[11] = 'for i = 1:39'
    writeLines(fc,f)
    print(i)
  }
  
}
month_lat_evolution<-function(
  
){
  input_tws_mean = 'analysis_output/fig3/twsmean_mon.csv'
  
  tws_mean = fread(input_tws_mean)
  tws_mean = as.data.frame(tws_mean)
  
  naidtws = which(is.na(tws_mean$JAN))
  tws_mean = tws_mean[-naidtws,]
  
  tws_meanm = reshape2::melt(tws_mean,c('long','lat'))
  lessid = which(tws_meanm$value<0)
  
  tws_meanm = tws_meanm[lessid,]
  
  tws_meanm_agg = aggregate(tws_meanm$value,
                            list(tws_meanm$lat,
                                 tws_meanm$variable),
                            mean)
  
  colnames(tws_meanm_agg) = c('Latitude',
                              'Time',
                              'TWS')
  
  tws_meanm_agg$Time = factor(
    tws_meanm_agg$Time,
    levels = toupper(month.abb)
  )
  
  id = which(tws_meanm_agg$Latitude<=60 &
               tws_meanm_agg$Latitude>=30)
  tws_meanm_agg = tws_meanm_agg[id,]
  
  tws_meanm_agg$TWS_CLASS = cut(tws_meanm_agg$TWS,
                                breaks = seq(-10,0,1))
  tile_col = colorRampPalette(
    brewer.pal(11,'Spectral')
  )(13)
  
  ptile = ggplot()+
    geom_tile(data = tws_meanm_agg,
              aes(y = Latitude,
                  x = Time,
                  fill = TWS_CLASS
              ))+
    scale_fill_manual(values = tile_col)+
    theme_bw()
  
  ptile
  
  #return(tws_meanm_agg)
  
  
  
  
  
  
  
}
month_longit_evolution<-function(
  
){
  shp_as = shp_management('land','as')
  shp_eu = shp_management('land','eu')
  shp_naf = shp_management('land','naf')
  shp_as_eu = bind(shp_as,shp_eu,shp_naf)
  
  shp_oce = list.files('cluster_shp/ato',
                       full.names = T,
                       pattern = '*.shp$')[1:4]
  shp_oce = do.call('bind',lapply(shp_oce,shapefile))
  ex_as_ato = extent(shp_as_eu)
  ex_as_ato = extent(-50,ex_as_ato[2],ex_as_ato[3],
                     ex_as_ato[4])
  
  input_tws_mean = 'analysis_output/fig3/twsmean_mon.csv'
  input_pme_mean = 'analysis_output/fig3/pmemean_mon.csv'
  
  pme_mean = as.data.frame(fread(input_pme_mean))
  tws_mean = fread(input_tws_mean)
  tws_mean = as.data.frame(tws_mean)
  
  naidtws = which(is.na(tws_mean$JAN))
  naidpme = which(is.na(pme_mean$JAN))
  tws_mean = tws_mean[-naidtws,]
  pme_mean = pme_mean[-naidpme,]
  
  ex_chos = which(tws_mean$long<=180 & 
                    tws_mean$long >= -20)
  
  tws_mean = tws_mean[ex_chos,]
  
  ex_chos2 = which(tws_mean$lat <=60 &
                     tws_mean$lat >=30)
  
  #ex_chos3 = which(tws_mean$lat <=60 &
  #                   tws_mean$lat >=50)
  
  #ex_chos4 = which(tws_mean$lat <=50 &
  #                   tws_mean$lat >=40)
  
  #ex_chos5 = which(tws_mean$lat <=40 &
  #                   tws_mean$lat >=30)
  tws_mean = tws_mean[ex_chos2,]
  ex_chos2 = which(pme_mean$lat <=60 &
                     pme_mean$lat >=30)
  pme_mean = pme_mean[ex_chos2,]
  
  tws_meanm = reshape2::melt(tws_mean,c('long','lat'))
  pme_meanm = reshape2::melt(pme_mean,c('long','lat'))
  
  lessid = which(tws_meanm$value<0)
  
  tws_meanm = tws_meanm[lessid,]
  
  tws_meanm_agg = aggregate(tws_meanm$value,
                            list(tws_meanm$long,
                                 tws_meanm$variable),
                            mean)
  pme_meanm_agg = aggregate(pme_meanm$value,
                            list(pme_meanm$long,
                                 pme_meanm$variable),
                            mean)
  tws_meanm_agg$Group.1 = tws_meanm_agg$Group.1 + 0.125
  tws_meanm_agg = rbind(pme_meanm_agg,tws_meanm_agg)
  colnames(tws_meanm_agg) = c('Longitude',
                              'Time',
                              'value')
  
  tws_meanm_agg$Time = factor(
    tws_meanm_agg$Time,
    levels = toupper(month.abb)
  )
  
  tws_meanm_agg$cuts = cut(tws_meanm_agg$value,
                                breaks = c(seq(-60,0,5),
                                           seq(10,140,20)))
  tile_col = colorRampPalette(
    brewer.pal(11,'Spectral')
  )(23)
  
  ptile = ggplot()+
    geom_tile(data = tws_meanm_agg,
              aes(x = Longitude,
                  y = Time,
                  fill = cuts
                  ))+
    geom_vline(xintercept = -50)+
    scale_fill_manual(values = tile_col)+
    theme_bw()
  
  ptile
  
  return(tws_meanm_agg)
  
  
  
  
  
  
  
}
monthly_contri_structure_validation <-function(
  
){
  # import contribution
  
  input_contr = 'analysis_output/contr_in_source_variance_new.csv'
  contr_full = fread(input_contr)
  contr_full = as.data.frame(contr_full)
  contr_full = abs(contr_full)
  sou_names = contr_full[,1]
  sou_names = toupper(sou_names)
  contr_full = contr_full[,-1]
  
  mon_analysis<-function(x){
    
    xm = matrix(x,nrow = 12)
    mean_fun<-function(x){
      xm = mean(x,na.rm = T)
      return(xm)
    }
    max_fun <-function(x){
      xm = max(x,na.rm = T)
      return(xm)
    }
    
    min_fun <-function(x){
      xm = min(x,na.rm = T)
      return(xm)
    }
    
    xmean = apply(xm,1,mean_fun)
    xmax = apply(xm,1,max_fun)
    xmin = apply(xm,1,min_fun)
    
    ret = data.frame(xmean,xmax,xmin)
    return(ret)
  }
  mon_contr = apply(contr_full,1,mon_analysis)
  
  mon_df = do.call('rbind',mon_contr)
  mon_sou_names = rep(sou_names,each = 12)
  mon = c('JAN',"FEB",'MAR','APR',
          'MAY','JUN','JUL','AUG',"SEP",'OCT','NOV','DEC')
  mon = rep(mon,13)
  
  colnames(mon_df)  = c('Contr_mean','Contr_max','Contr_min')
  mon_df = as.data.frame(mon_df)
  mon_df$Month = mon
  mon_df$Source = mon_sou_names
  
  library(reshape2)
  
  mon_df_m = melt(mon_df,c('Month','Source'))
  
  library(ggplot2)
  mon_df_m$Month = factor(mon_df_m$Month,
                          levels =  c('JAN',"FEB",'MAR','APR',
                                      'MAY','JUN','JUL','AUG',"SEP",'OCT','NOV','DEC'))
  mon_df_m$Source = factor(mon_df_m$Source,
                           levels = sou_names)
  
  mon_df_m$value[which(mon_df_m$value<0)] = abs( mon_df_m$value[which(mon_df_m$value<0)])
  mon_df_m$cuts = cut(mon_df_m$value,breaks = c(0,1,5,10,20,30,40,50,60),right = FALSE)
  
  pvar = ggplot()+
    geom_tile(data = mon_df_m,aes(x = Month,y = Source,fill = cuts))+
    scale_fill_brewer(palette = 'Spectral')+
    facet_wrap(~variable,nrow = 1,ncol = 3)
  
  
  # monthly for each year 
  annual_distr_df = contr_full
  
  annual_df_reorder <- function(x){
    xm = matrix(x,nrow = 12)
    colnames(xm) = paste0('year',2003:2017)
    
    mon = c('JAN',"FEB",'MAR','APR',
            'MAY','JUN','JUL','AUG',"SEP",'OCT','NOV','DEC')
    
    xdf = data.frame(mon,xm)
    library(reshape2)
    xdf = melt(xdf,'mon')
    return(xdf)
  }
  
  annual_df = apply(annual_distr_df,1,annual_df_reorder)
  an_sou_names = rep(sou_names,each = nrow(annual_df[[1]]))
  annual_df = do.call('rbind',annual_df)
  
  annual_df$Source = an_sou_names
  annual_df$mon = factor(annual_df$mon,levels =  c('JAN',"FEB",'MAR','APR',
                                                   'MAY','JUN','JUL','AUG',"SEP",'OCT','NOV','DEC'))
  
  annual_df$group = paste0(annual_df$Source,annual_df$variable)
  library(RColorBrewer)
  
  color = colorRampPalette(brewer.pal(11,'Spectral'))(13)
 
  annual_df$monid =rep(1:12,length(2003:2017)*length(sou_names))
  mon_df$monid = rep(1:12,length(sou_names))
  
  pan = ggplot()+
    
    geom_ribbon(data = mon_df,aes(x = monid,ymin = Contr_min,ymax = Contr_max,group= Source),
                fill= 'grey70',alpha = 0.5)+
    geom_point(data = annual_df,aes(x = monid,y = value, color = Source))+
    geom_line(data = mon_df,aes(x = monid,y = Contr_mean,color = Source))+
    
    #geom_path(data = annual_df,aes(x= mon,y = value, group = variable))+
    scale_color_manual(values = color)+
    scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12),
                       labels =c('JAN',"FEB",'MAR','APR',
                                 'MAY','JUN','JUL','AUG',"SEP",'OCT','NOV','DEC'))+
    facet_wrap(~Source,ncol = 4,scales = 'free')+
    theme_bw()
  
  
  # rank the contribution
  rank_fun <-function(x){
    sumx = sum(x,na.rm = T)
    r = x/sumx
    return(r)
  }
  
  rank_mat = apply(contr_full,2,rank_fun)
  rank_mean = apply(rank_mat,1,mean,na.rm = T)*100
  rank_max = apply(rank_mat,1,max,na.rm = T)*100
  rank_min = apply(rank_mat,1,min,na.rm = T)*100
  
}
monthly_convey_by_region_analysis <-function(
  
){
  
  input_files = list.files('/media/sdb1/xinjiang_output_file/',full.names = T)
  input_files = paste0(input_files,'/output/convey_rate_by_region.csv')
  
  #order = c('as','ato','eu')
  
  con_box = 1
  for(i in 1:length(input_files)){
    convey_rate = fread(input_files[i])
    names = convey_rate[,3]
    convey_rate = convey_rate[,2]
    con_box = cbind(con_box,convey_rate)
  }
  con_box = con_box[,-1]
  
  con_box = as.matrix(con_box)
  
  cal_mon_max <- function(x){
    x = matrix(x,nrow = 12)
    
    max_fun <-function(y){
      y = max(y,na.rm = T)
      return(y)
    }
    
    xm = apply(x,1,max_fun)
    return(xm)
  }
  
  cal_mon_min <- function(x){
    x = matrix(x,nrow = 12)
    
    min_fun <-function(y){
      y = min(y,na.rm = T)
      return(y)
    }
    
    xm = apply(x,1,min_fun)
    return(xm)
  }
  
  cal_mon_mean <- function(x){
    x = matrix(x,nrow = 12)
    
    mean_fun <-function(y){
      y = mean(y,na.rm = T)
      return(y)
    }
    
    xm = apply(x,1,mean_fun)
    return(xm)
  }
  
  con_max = apply(con_box,1,cal_mon_max)
  con_mean = apply(con_box,1,cal_mon_mean)
  con_min = apply(con_box,1,cal_mon_min)
  
  con_max = t(con_max)
  con_mean = t(con_mean)
  con_min = t(con_min)
  
  mon_name = c('JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT',
               'NOV','DEC')
  
  colnames(con_max) = mon_name
  colnames(con_min) = mon_name
  colnames(con_mean) = mon_name

  con_max = data.frame(
    re_group = names$groups,
    con_max
  )
  
  con_min = data.frame(
    re_group = names$groups,
    con_min
  )
  
  con_mean = data.frame(
    re_group = names$groups,
    con_mean
  )
  
  con_max_df = reshape2::melt(con_max,'re_group')
  
  con_min_df = reshape2::melt(con_min,'re_group')
  
  con_mean_df = reshape2::melt(con_mean,'re_group')
  
  date_match<-function(x){
    mon_name = c('JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT',
                 'NOV','DEC')
    id = which(mon_name == x)
    return(id)
  }
  
  date = sapply(con_max_df$variable,date_match)
  
  con_max_df$date = date
  con_min_df$date = date
  con_mean_df$date = date
  
  region = c('north_jishui','north_moun','south_jishui',"south_mon")
  region = rep(region,each = 3)
  region = paste0(region,'_',c('as','ato','eu'))
  region = rep(region,each = 4)
  region = rep(region,12)
  
  con_max_df$region = region
  con_min_df$region = region
  con_mean_df$region = region
  
  ribbion_df = con_max_df
  ribbion_df$min = con_min_df$value
  ribbion_df$max = con_max_df$value
  
  output = 'analysis_output'
  output_min = paste0(output,'/convey_rate_by_region_min.csv')
  output_max = paste0(output,'/convey_rate_by_region_max.csv')
  output_mean = paste0(output,'/convey_rate_by_region_mean.csv')
  
  fwrite(con_min,output_min)
  fwrite(con_max,output_max)
  fwrite(con_mean,output_mean)
  
  library(ggplot2)
  pmean = ggplot()+
    geom_line(data = con_mean_df,aes(x = date,y = value,color = re_group),size = 0.5)+
    geom_ribbon(data = ribbion_df,aes(x = date,ymin=min,ymax=max,group = re_group),
                fill = 'grey80',alpha = 0.5)+
    scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12),
                       labels = mon_name)+
    facet_wrap(~region,nrow = 4,scales = 'free')+
    theme_bw()+
    theme(
      legend.position = 'none'
    )
  
}
monthly_pattern_analysis<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/monthly_pattern_cal.R')
  # gpcc 
  source('/home/share/R_project/xinjiang_vapor/gpcc_pr_in_xinjiang.R')
  gpcc_full = gpcc_pr_in_xinjiang(mode = 'full')
  gpcc_mon = monthly_pattern_cal(gpcc_full)
  # gws
  source('/home/share/R_project/xinjiang_vapor/gws_in_xinjiang.R')
  gws_full = gws_in_xinjiang(mode = 'full')
  gws_mon = monthly_pattern_cal(gws_full)
  # era5_evpor
  source('/home/share/R_project/xinjiang_vapor/era5_evapor.R')
  eva_full = era5_evapor(mode = 'full')
  eva_mon = monthly_pattern_cal(eva_full)
  # era5_temper
  source('/home/share/R_project/xinjiang_vapor/era5_temper.R')
  t_full = era5_tmp(mode = 'full')
  t_mon = monthly_pattern_cal(t_full)
  # ndvi 
  source('/home/share/R_project/xinjiang_vapor/ndvi_in_xinjiang.R')
  ndvi_full = ndvi_in_xinjiang(mode = 'full')
  ndvi_mon = monthly_pattern_cal(ndvi_full)
  
  month =  c('JAN','FEB','MAR','APR','MAY',
             "JUN",'JUL','AUG','SEP',"OCT",'NOV',"DEC")
  d = data.frame(month,gpcc_mon,gws_mon,eva_mon)
  
  dm = reshape2::melt(d,'month')
  
  dm$month = factor(dm$month,levels = month)
  
  p = ggplot()+
    geom_line(data = dm,aes(x = month,y = value, color = variable,group = variable))+
    theme_bw()+
    theme(
      panel.background = element_rect(fill = 'transparent'),
      axis.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      axis.title = element_text(color = 'black',size = 14,face = 'bold',hjust = 0.5),
      legend.position = 'bottom',
      legend.direction = 'horizontal',
      legend.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      legend.title = element_text(color = 'black',size = 14, face = 'bold',hjust = 0.5),
      strip.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5)
    )+
    guides(color = guide_legend(nrow = 1))+
    xlab('Date (month)')+
    ylab('Index')
  
  p
}
monthly_pattern_cal<-function(
  index
){
  
  #start = 2003-01-01
  #end = 2017-12-01
  
  indexm = matrix(index,nrow = 12)
  
  mean_fun<-function(x){
    tmp = mean(x,na.rm = T)
  }
  indexm = apply(indexm,1,mean_fun)
  return(indexm)
  
}
monthly_pattern_convey_rates <- function(
  
){
  mode = c('ato','as','eu')
  
  region_file = paste0('cluster_shp/',mode,'/',mode,1:4,'.shp')
  
  input_file = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
  input_file = paste0(input_file,'/output/convey_rate_df')
  
  sum_fun <- function(x){
    x = sum(x,na.rm = T)
  }
  
  convey_rate_b = 1
  for(i in 1:length(input_file)){
    ato_input = paste0(input_file[i],'/',mode[1],'.csv')
    as_input = paste0(input_file[i],'/',mode[2],'.csv')
    eu_input = paste0(input_file[i],'/',mode[3],'.csv')
    
    ato = fread(ato_input)
    as = fread(as_input)
    eu = fread(eu_input)
    
    ato_contr_value_agg = aggregate(ato$contr_value,list(ato$region_label),sum_fun)
    as_contr_value_agg = aggregate(as$contr_value,list(as$region_label),sum_fun)
    eu_contr_value_agg = aggregate(eu$contr_value,list(eu$region_label),sum_fun)
    
    ato_uptake_agg = aggregate(ato$uptake_in_region, list(ato$region_label),sum_fun)
    as_uptake_agg = aggregate(as$uptake_in_region,list(as$region_label),sum_fun)
    eu_uptake_agg = aggregate(eu$uptake_in_region,list(eu$region_label),sum_fun)
    
    ato_convey_rate = abs(ato_contr_value_agg[,2])/ato_uptake_agg[,2]
    as_convey_rate = abs(as_contr_value_agg[,2])/as_uptake_agg[,2]
    eu_convey_rate = abs(eu_contr_value_agg[,2])/eu_uptake_agg[,2]
    
    
    
    full_id = 1:4
    
    if(length(ato_convey_rate)<4){
      ato_id = ato_uptake_agg[,1]
      idin = which(full_id %in% ato_id)
      notinid = full_id[-idin]
      
      ato_convey_rate = c(ato_convey_rate,rep(0,length(notinid)))
      ato_id = c(ato_id,notinid)
      
    }else{
      ato_id = full_id
    }
    
    if(length(as_convey_rate)<4){
      as_id = as_uptake_agg[,1]
      idin = which(full_id %in% as_id)
      notinid = full_id[-idin]
      
      as_convey_rate = c(as_convey_rate,rep(0,length(notinid)))
      as_id = c(as_id,notinid)
    }else{
      as_id = full_id
    }
    
    if(length(eu_convey_rate)<4){
      eu_id = eu_uptake_agg[,1]
      idin = which(full_id %in% eu_id)
      notinid = full_id[-idin]
      
      eu_convey_rate = c(eu_convey_rate,rep(0,length(notinid)))
      eu_id = c(eu_id,notinid)
    }else{
      eu_id = full_id
    }
    
    
    ato_df = data.frame(id = ato_id,
                        convey_rate = ato_convey_rate)
    as_df = data.frame(id = as_id,
                       convey_rate = as_convey_rate)
    eu_df = data.frame(id = eu_id,
                       convey_rate = eu_convey_rate)
    
    
    s_ato = order(ato_df[,1])
    s_as = order(as_df[,1])
    s_eu = order(eu_df[,1])
    
    ato_df = ato_df[s_ato,]
    as_df = as_df[s_as,]
    eu_df = eu_df[s_eu,]
    
    ato_df$id = paste0('ato',ato_df$id)
    as_df$id = paste0('as',as_df$id)
    eu_df$id = paste0('eu',eu_df$id)
    
    ret_df = rbind(ato_df,as_df,eu_df)
    
    convey_rate_b = cbind(convey_rate_b,ret_df$convey_rate)
    print(i)
  }
  
  convey_rate_df = convey_rate_b[,-1]
  
  
  sub_month_min_analys<-function(x){
    xm = matrix(x,nrow = 12)
    
    min_fun <- function(y){
      y = min(y,na.rm = T)
      return(y)
    }
    
    xm = apply(xm,1,min_fun)
    
    return(xm)
  }
  
  sub_month_max_analys<-function(x){
    xm = matrix(x,nrow = 12)
    
    max_fun <- function(y){
      y = max(y,na.rm = T)
      return(y)
    }
    
    xm = apply(xm,1,max_fun)
    
    return(xm)
  }
  
  sub_month_mean_analys<-function(x){
    xm = matrix(x,nrow = 12)
    
    mean_fun <- function(y){
      y = mean(y,na.rm = T)
      return(y)
    }
    
    xm = apply(xm,1,mean_fun)
    
    return(xm)
  }
  
  convey_rate_mon_min = apply(convey_rate_df,1,sub_month_min_analys)
  convey_rate_mon_max = apply(convey_rate_df,1,sub_month_max_analys)
  convey_rate_mon_mean = apply(convey_rate_df,1,sub_month_mean_analys)
  
  convey_rate_mon_min = t(convey_rate_mon_min)
  convey_rate_mon_max = t(convey_rate_mon_max)
  convey_rate_mon_mean = t(convey_rate_mon_mean)
  
  mon_name = c('JAN','FEB','MAR','APR','MAY','JUN',"JUL",'AUG','SEP','OCT','NOV','DEC')
  
  colnames(convey_rate_mon_min) = mon_name
  colnames(convey_rate_mon_max) = mon_name
  colnames(convey_rate_mon_mean) = mon_name
  
  convey_rate_mon_max = data.frame(id = ret_df[,1],convey_rate_mon_max)
  convey_rate_mon_min = data.frame(id = ret_df[,1],convey_rate_mon_min)
  convey_rate_mon_mean = data.frame(id = ret_df[,1],convey_rate_mon_mean)
  
  convey_rate_mon_max = as.data.frame(convey_rate_mon_max)
  convey_rate_mon_min = as.data.frame(convey_rate_mon_min)
  convey_rate_mon_mean = as.data.frame(convey_rate_mon_mean)
  
  fwrite(convey_rate_mon_max,'analysis_output/convey_rate_mon_max.csv')
  fwrite(convey_rate_mon_min,'analysis_output/convey_rate_mon_min.csv')
  fwrite(convey_rate_mon_mean,'analysis_output/convey_rate_mon_mean.csv')
  
  convey_rate_mon_max = read.csv('analysis_output/convey_rate_mon_max.csv',
                                 header = T)
  convey_rate_mon_min = read.csv('analysis_output/convey_rate_mon_min.csv',
                                 header = T)
  convey_rate_mon_mean = read.csv('analysis_output/convey_rate_mon_mean.csv',
                                  header = T)
  
  df_max = melt(convey_rate_mon_max,'id')
  df_min = melt(convey_rate_mon_min,'id')
  df_mean = melt(convey_rate_mon_mean,'id')
  
  df_max$variable = factor(df_max$variable,
                           levels = mon_name)
  
  df_min$variable = factor(df_min$variable,
                           levels = mon_name)
  
  df_mean$variable = factor(df_mean$variable,
                           levels = mon_name)
  
  
  match_mon_id <-function(x){
    if(x == 'JAN'){
      x = 1
    }else if(x =='FEB'){
      x = 2
    }else if(x =='MAR'){
      x = 3
    }else if(x =='APR'){
      x = 4
    }else if(x =='MAY'){
      x = 5
    }else if(x =='JUN'){
      x = 6
    }else if(x =='JUL'){
      x = 7
    }else if(x =='AUG'){
      x = 8
    }else if(x =='SEP'){
      x = 9
    }else if(x =='OCT'){
      x = 10
    }else if(x =='NOV'){
      x = 11
    }else if(x =='DEC'){
      x = 12
    }
  }
  
  df_max$monid = sapply(df_max$variable,match_mon_id)
  df_min$monid = sapply(df_min$variable,match_mon_id)
  df_mean$monid = sapply(df_mean$variable,match_mon_id)
  
  df_rib = df_max
  colnames(df_rib) = c('id','variable','max','monid')
  df_rib$min = df_min$value
  
  pmax = ggplot()+
    geom_ribbon(data = df_rib,aes(x = monid,ymax = max,ymin = min),
                fill = 'grey80',alpha = 0.5)+
    geom_line(data = df_mean,aes(x = monid,y = value,color = id))+
    scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12),
                       labels = mon_name)+
    facet_wrap(~id,nrow = 4,scales = 'free')+
    theme_bw()
  
  
  
  
}
monthly_sst_land_temperate_analysis <- function(
  
){
  sst = data_management('global_era5_sst')
  tas = data_management('global_era5_temperature')
  
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  sst = crop(sst,extent(-180,180,0,90))
  #sst = mask(sst,world)
  tas = crop(tas,world)
  tas = mask(tas,world)
  
  tas = tas[[1:174]]
  sst = sst[[1:174]]
  
  janid = seq(1,174,12)
  febid = seq(2,174,12)
  marid = seq(3,174,12)
  aprid = seq(4,174,12)
  mayid = seq(5,174,12)
  junid = seq(6,174,12)
  julid = seq(7,174,12)
  augid = seq(8,174,12)
  sepid = seq(9,174,12)
  octid = seq(10,174,12)
  novid = seq(11,174,12)
  decid = seq(12,174,12)
  
  monid = list(janid,febid,marid,aprid,
               mayid,junid,julid,augid,
               sepid,octid,novid,decid)
  
  
  
  monid <<- monid
  sst <<- sst
  tas <<- tas
  
  cell_mean_fun_sst<-function(i){
    tmpid = monid[[i]]
    tmpsst = sst[[tmpid]]
    
    sub_cal_mean_bycell <-function(x){
      x = mean(x,na.rm = T)
      return(x)
    }
    
    library(raster)
    library(doParallel)
    beginCluster(12)
    mon_mean = clusterR(tmpsst,calc,
                        args = list(fun = sub_cal_mean_bycell))
    endCluster()
    gc()
    return(mon_mean)
  }
  cell_mean_fun_tas<-function(i){
    tmpid = monid[[i]]
    tmptas = tas[[tmpid]]
    
    sub_cal_mean_bycell <-function(x){
      x = mean(x,na.rm = T)
      return(x)
    }
    
    library(raster)
    library(doParallel)
    beginCluster(12)
    mon_mean = clusterR(tmptas,calc,
                        args = list(fun = sub_cal_mean_bycell))
    endCluster()
    gc()
    return(mon_mean)
  }
  
  i = 1:length(monid)
  mon_mean_sst = lapply(i,cell_mean_fun_sst)
  mon_mean_tas = lapply(i,cell_mean_fun_tas)
  
  mon_mean_sst = stack(mon_mean_sst)
  mon_mean_tas = stack(mon_mean_tas)
  
  mon_sst_df = as.data.frame(mon_mean_sst,xy = T)
  mon_tas_df = as.data.frame(mon_mean_tas,xy = T)
  
  colnames(mon_sst_df) = c('long','lat',toupper(month.abb))
  colnames(mon_tas_df) = c('long','lat',toupper(month.abb))
  
  mon_sst_dfm = reshape2::melt(mon_sst_df,
                               c('long','lat'))
  mon_tas_dfm = reshape2::melt(mon_tas_df,
                               c('long','lat'))
  
  naid_sst = which(is.na(mon_sst_dfm$value))
  naid_tas = which(is.na(mon_tas_dfm$value))
  
  mon_sst_dfm = mon_sst_dfm[-naid_sst,]
  mon_tas_dfm = mon_tas_dfm[-naid_tas,]
  
  mon_sst_dfm$value = mon_sst_dfm$value - 273.15
  mon_tas_dfm$value = mon_tas_dfm$value - 273.15
  
  
  mon_ssttas = rbind(mon_sst_dfm,mon_tas_dfm)
  ptas_tas = ggplot()+
    geom_tile(data = mon_ssttas,
              aes(x = long,y = lat,
                  fill = value))+
    scale_fill_distiller(palette = 'Spectral')+
    geom_polygon(data = world,
                 aes(x = long,y = lat,group = group),
                 color = 'black',
                 size = 0.5,
                 fill = 'transparent')+
    geom_polygon(data = shp_com,
                 aes(x = long,y= lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    facet_wrap(~variable,nrow = 4)+
    theme_bw()
  
}


nc_to_df <- function(
  a
){
  
  
  long = try(ncvar_get(a,'longitude'),
             silent = T)
  lat = try(ncvar_get(a,'latitude'),
            silent = T)
  
  if('try-error' %in% class(long)){
    long = ncvar_get(a,'lon')
  }
  
  if('try-error' %in% class(lat)){
    lat = ncvar_get(a,'lat')
  }
  
  nlong = dim(long)
  nlat = dim(lat)
  
  tos = ncvar_get(a,'tos')
  
  n = dim(tos)[3]
  
  long = as.vector(long)
  lat = as.vector(lat)
  
  long <<- long
  lat <<- lat
  tos <<- tos
  i <<- 1:n
  subs_fun <- function(i){
    library(raster)
    tmptos = tos[,,i]
    tmptos = as.vector(tmptos)
    return(tmptos)
  }
  
  ret <- lapply(i,subs_fun)
  ret = do.call('cbind',ret)
  
  df = data.frame(
    long = long,
    lat = lat,
    ret
  )
  
  return(df)
  
}
nc_to_df <- function(
  
){
  a = nc_open(files_in_full2)
  
  long = ncvar_get(a,'longitude')
  lat = ncvar_get(a,'latitude')
  
  nlong = dim(long)
  nlat = dim(lat)
  
  tos = ncvar_get(a,'tos')
  
  n = dim(tos)[3]
  
  long = as.vector(long)
  lat = as.vector(lat)
  
  long <<- long
  lat <<- lat
  tos <<- tos
  i <<- 1:n
  subs_fun <- function(i){
    library(raster)
    tmptos = tos[,,i]
    tmptos = as.vector(tmptos)
   
    return(tmptos)
  }
  
  ret <- lapply(i,subs_fun)
  
  
}
ndvi_in_xinjiang <- function(
  mode = 'trend'
){
  library(raster)
  library(ncdf4)
  library(ggplot2)
  #source('/home/share/R_project/xinjiang_vapor/data_management.R')
  #ndvi = data_management(mode = 'ndvi')
  #writeRaster(ndvi,'/media/sdb5/Data/data_in_nc/ndvi_2003_2017.nc')
  
  ndvi = stack('/media/sdb5/Data/data_in_nc/ndvi_2003_2017.nc')
  ndvib = 1
  for(i in 1:dim(ndvi)[[3]]){
    tmp= cellStats(ndvi[[i]],'mean')
    ndvib = c(ndvib,tmp)
  }
  ndvib = ndvib[-1]
  if(mode == 'trend'){
    ndvib = trend_index(ndvib,start = c(2003,1),fre = 12)
  }else{
    ndvib = ndvib
  }
  
  return(ndvib)
  #date = seq(as.Date('2003-01-01'),as.Date('2017-12-01'),'1 month')
  
  #df = data.frame(date,ndvi = ndvib)
  #p = ggplot()+
  #  geom_line(data = df,aes(x = date,y = ndvi),color = 'blue')
  
  #p  
}
north_land_shp_pre<-function(
  
){
  
  # land shp 
  land_path = '/media/sdb1/shp/world_continent_shp/'
  files = list.files(land_path,pattern = '*.shp$',full.names = T)
  files = files[1:4]
  
  con_li = list()
  for(i in 1:length(files)){
    con_li = c(con_li,shapefile(files[i]))
  }
  
  con_name = c("north_africa",'asia','europe','north_america')
  mask_crop_north<-function(x){
    cr_ex = extent(extent(x)[1],extent(x)[2],0,extent(x)[4])
    tmpx = crop(x,cr_ex)
  }
  
  
  msk_ret = lapply(con_li,mask_crop_north)
  
  
  #dir.create('/media/sdb1/shp/north_land')
  ofiles = paste0(con_name,'.shp')
  output = paste0('/media/sdb1/shp/north_land/',ofiles)
  
  for(i in 1:length(output)){
    shapefile(msk_ret[[i]],output[i])
  }
  
  
}
outter_cal_contri_rate2<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/check_output_number.R')
  input_data = check_output_number()
  
  system.time(cal_contri_rate2(input_data))
}
outter_cal_convey_by_region_based_on_cmip6<-function(
  
){
  mode = c('hist_ssp245','hist_ssp585')
  
  lapply(mode,cal_convey_by_region_based_on_cmip6)
  
  
}
outter_cal_eva_in_each_region_based_cmip6<-function(
  
){
  models = c('ACCESS-ESM1-5','BCC-CSM2-MR',
             'CanESM5','GFDL-ESM4','IPSL-CM6A-LR',
             'MIROC6','MRI-ESM2-0','NorESM2-LM')
  pattern1 = rep('hist_ssp245',8)
  source('/home/share/R_project/xinjiang_vapor/cal_eva_in_each_region_based_cmip6.R')
  mapply(cal_eva_in_each_region_based_cmip6,models,pattern1)
  
  print('Pass pattern1')
  pattern2 = rep('hist_ssp585',8)
  mapply(cal_eva_in_each_region_based_cmip6,models,pattern2)
}
outter_cal_mean_traj <- function(
  
){
  
  source('/home/share/R_project/xinjiang_vapor/cluster_traj_routes.R')
  input_data = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
  input_data = paste0(input_data,'/output')
  
  #input_data = input_data[1:180]
  cluster_traj_routes(input_data) 
  
}
outter_cal_released_xinjiang<-function(
  
){
  input_data = check_output_number()
  full = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
  full = paste0(full,'/output')
  
  id = which(full == input_data[1])
  id = id-1
  input_data = c(full[id],input_data)
  
  main_cal_relesed_inxinjiang(input_data)
}
outter_cal_temp_in_each_region_based_on_cmip6 <-function(
  
){
  models = c('ACCESS-ESM1-5','BCC-CSM2-MR',
             'CanESM5','GFDL-ESM4','IPSL-CM6A-LR',
             'MIROC6','MRI-ESM2-0','NorESM2-LM')
  pattern1 = rep('hist_ssp245',8)
  source('/home/share/R_project/xinjiang_vapor/cal_temp_in_each_region_based_cmip6.R')
  mapply(cal_temp_in_each_region_based_cmip6,models,pattern1)
  
  print('Pass pattern1')
  pattern2 = rep('hist_ssp585',8)
  mapply(cal_temp_in_each_region_based_cmip6,models,pattern2)
}
outter_cluster_basedon_allpart <- function(
  
){
  
  # label id for each sub squared region for first points
  # 
  source('/home/share/R_project/xinjiang_vapor/cluster_basedon_allpart.R')
  mode = c('ato','as','eu')
  
  sapply(mode,cluster_basedon_allpart)
  
}
outter_control_cal_released_in_xinjiang_jishui <- function(
  
){
  input_file = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
  input_file = paste0(input_file,'/output')
  
  source('/home/share/R_project/xinjiang_vapor/cal_released_in_xinjiang_jishui.R')
  system.time(cal_released_in_xinjiang_jishui(input_file))
  
  
  
  source('/home/share/R_project/xinjiang_vapor/match_convey_and_rel_by_region.R')
  
  input_file = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
  system.time(match_convey_and_rel_by_region(input_file))
  
  
  source('/home/share/R_project/xinjiang_vapor/cal_convey_rate_by_region.R')
  input_file = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
  cal_convey_rate_by_region(input_file)
  
}
outter_filter_cmip6_data_to_date<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/filter_cmip6_data_to_date.R')
  filter_cmip6_data_to_date('E')
  filter_cmip6_data_to_date('Pr')
  filter_cmip6_data_to_date('T')
  
  source('/home/share/R_project/xinjiang_vapor/combine_cmip6_data_his_ssp.R')
  combine_cmip6_data_his_ssp('E')
  combine_cmip6_data_his_ssp('Pr')
  combine_cmip6_data_his_ssp('T')
  
  source('/home/share/R_project/xinjiang_vapor/adjust_extent_cmip6_hist_ssp585.R')
  adjust_extent_cmip6_hist_ssp585()
  
}
outter_mask_crop_cmip6_pme<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/mask_crop_cmip6_pme.R')
  mode = c('ato','as','eu')
  
  mask_crop_cmip6_pme(mode[1])
  mode = c('ato','as','eu')
  mask_crop_cmip6_pme(mode[2])
  mode = c('ato','as','eu')
  mask_crop_cmip6_pme(mode[3])
  
}
outter_mask_crop_cmip6 <- function(
  
){
  mode =c('ato','as','eu')
  source('/home/share/R_project/xinjiang_vapor/mask_crop_cmip6.R')
  system.time(mask_crop_cmip6(mode[1]))
  system.time(mask_crop_cmip6(mode[2]))
  system.time(mask_crop_cmip6(mode[3]))
}
outter_predict_tws_based_on_cmip6<-function(
  
){
  models = c('ACCESS-ESM1-5','BCC-CSM2-MR',
             'CanESM5','GFDL-ESM4','IPSL-CM6A-LR',
             'MIROC6','MRI-ESM2-0','NorESM2-LM')
  pattern1 = rep('hist_ssp245',8)
  
  source('/home/share/R_project/xinjiang_vapor/predic_tws_model_cmip6.R')
  
  
  ret_north_train = 1
  ret_north_test = 1
  ret_north_project = 1
  
  ret_south_train = 1
  ret_south_test = 1
  ret_south_project = 1
  
  
  output = 'simu_cmip6_tws'
  dir.create(output)
  output = paste0(output,'/',pattern1[1])
  dir.create(output)
  
  filesname = paste0(c('north_train','north_test','north_project',
                       'south_train','south_test','south_project'),'.csv')
  output = paste0(output,'/',filesname)
  
  
  for(i in 1:8){
    ret_box = predic_tws_model_cmip6(models[i],pattern1[i])
    
    ret_north = ret_box[[1]]
    ret_south = ret_box[[2]]
    
    
    ret_north_train = cbind(ret_north_train,
                            ret_north[[1]])
    ret_north_test = cbind(ret_north_test,
                           ret_north[[2]])
    ret_north_project = cbind(ret_north_project,
                              ret_north[[3]])
    
    ret_south_train = cbind(ret_south_train,
                            ret_south[[1]])
    ret_south_test = cbind(ret_south_test,
                           ret_south[[2]])
    ret_south_project = cbind(ret_south_project,
                              ret_south[[3]])
    
  }
  ret_north_test = ret_north_test[,-1]
  ret_north_train = ret_north_train[,-1]
  ret_north_project = ret_north_project[,-1]
  
  ret_south_train = ret_south_train[,-1]
  ret_south_test = ret_south_test[,-1]
  ret_south_project = ret_south_project[,-1]
  
  colnames(ret_north_test) = models
  colnames(ret_north_train) = models
  colnames(ret_south_train) = models
  colnames(ret_south_test) = models
  colnames(ret_south_project) = models
  colnames(ret_north_project) = models
  
  print(ncol(ret_north_project))
  
  fwrite(ret_north_train,output[1])
  fwrite(ret_north_test,output[2])
  fwrite(ret_north_project,output[3])
  
  fwrite(ret_south_train,output[4])
  fwrite(ret_south_test,output[5])
  fwrite(ret_south_project,output[6])
  
  
  ######## project cmip6 ssp585
  
  pattern1 = rep('hist_ssp585',8)
  
  source('/home/share/R_project/xinjiang_vapor/predic_tws_model_cmip6.R')
  
  
  ret_north_train = 1
  ret_north_test = 1
  ret_north_project = 1

  ret_south_train = 1
  ret_south_test = 1
  ret_south_project = 1

  
  output = 'simu_cmip6_tws'
  dir.create(output)
  output = paste0(output,'/',pattern1[1])
  dir.create(output)
  
  filesname = paste0(c('north_train','north_test','north_project',
                       'south_train','south_test','south_project'),'.csv')
  output = paste0(output,'/',filesname)
  
  
  for(i in 1:8){
    ret_box = predic_tws_model_cmip6(models[i],pattern1[i])
    
    ret_north = ret_box[[1]]
    ret_south = ret_box[[2]]
    
    
    ret_north_train = cbind(ret_north_train,
                            ret_north[[1]])
    ret_north_test = cbind(ret_north_test,
                           ret_north[[2]])
    ret_north_project = cbind(ret_north_project,
                              ret_north[[3]])
    
    ret_south_train = cbind(ret_south_train,
                            ret_south[[1]])
    ret_south_test = cbind(ret_south_test,
                           ret_south[[2]])
    ret_south_project = cbind(ret_south_project,
                              ret_south[[3]])
    
  }
  ret_north_test = ret_north_test[,-1]
  ret_north_train = ret_north_train[,-1]
  ret_north_project = ret_north_project[,-1]
  
  ret_south_train = ret_south_train[,-1]
  ret_south_test = ret_south_test[,-1]
  ret_south_project = ret_south_project[,-1]
  
  colnames(ret_north_test) = models
  colnames(ret_north_train) = models
  colnames(ret_south_train) = models
  colnames(ret_south_test) = models
  colnames(ret_south_project) = models
  colnames(ret_north_project) = models
  
  fwrite(ret_north_train,output[1])
  fwrite(ret_north_test,output[2])
  fwrite(ret_north_project,output[3])
  
  fwrite(ret_south_train,output[4])
  fwrite(ret_south_test,output[5])
  fwrite(ret_south_project,output[6])
  
  
}
outter_re_order_cmip6_ep_sum<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/re_order_cmip6_ep_sum.R')
  mode = c('hist_ssp245','hist_ssp585')
  lapply(mode,re_order_cmip6_ep_sum)
}
pev_season_analysis<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  source('/home/share/R_project/xinjiang_vapor/trend_index.R')
  era5 = data_management(mode = 'era5_tevapor')
  
  era5_li = as.list(era5)
  era5_mean_ext<-function(x){
    xmean = cellStats(x,'mean')
    return(xmean)
  }
  
  
  era5_mean = lapply(era5_li,era5_mean_ext)
  era5_mean = do.call('c',era5_mean)
  era5_mean = -1*era5_mean*1000
  
  eva_mon = matrix(era5_mean,nrow = 12)
  
  mon_mean_fun<-function(x){
    xm = mean(x,na.rm = T)
    return(xm)
  }
  
  eva_mon_pattern = apply(eva_mon,1,mon_mean_fun)
  
  
}
pl_contr_traj<-function(
  
){
  # import contribution
  
  input_contr = 'analysis_output/contr_in_source_variance_new.csv'
  contr_full = fread(input_contr)
  contr_full = as.data.frame(contr_full)
  sou_names = contr_full[,1]
  contr_full = contr_full[,-1]
  
  mon_analysis<-function(x){
    
    xm = matrix(x,nrow = 12)
    mean_fun<-function(x){
      xm = mean(x,na.rm = T)
      return(xm)
    }
    max_fun <-function(x){
      xm = max(x,na.rm = T)
      return(xm)
    }
    
    min_fun <-function(x){
      xm = min(x,na.rm = T)
      return(xm)
    }
    
    xmean = apply(xm,1,mean_fun)
    xmax = apply(xm,1,max_fun)
    xmin = apply(xm,1,min_fun)
    
    ret = data.frame(xmean,xmax,xmin)
    return(ret)
  }
  
  mon_contr = apply(contr_full,1,mon_analysis)
  
  mon_contrb_mean = 1
  mon_contrb_max = 1
  mon_contrb_min = 1
  for(i in 1:length(mon_contr)){
    tmp = mon_contr[[i]]
    tmp1 = data.frame(xmean = tmp[,1],
                      sou_name = sou_names[i])
    tmp2 = data.frame(xmax = tmp[,2],
                      sou_name = sou_names[i])
    tmp3 = data.frame(xmin = tmp[,3],
                      sou_name = sou_names[i])
    
    mon_contrb_mean = rbind(mon_contrb_mean,tmp1)
    mon_contrb_max = rbind(mon_contrb_max,tmp2)
    mon_contrb_min = rbind(mon_contrb_min,tmp3)
  }
  mon_contrb_mean = mon_contrb_mean[-1,]
  mon_contrb_max = mon_contrb_max[-1,]
  mon_contrb_min = mon_contrb_min[-1,]
  
  
  xjid = which(mon_contrb_mean$sou_names =='xj')
  
  mon_contrb_mean$xmean[xjid] = -1*mon_contrb_mean$xmean[xjid]
  mon_contrb_max$xmax[xjid] = -1*mon_contrb_max$xmax[xjid]
  mon_contrb_min$xmin[xjid] = -1*mon_contrb_min$xmin[xjid]  
  
  
  mon = c('JAN','FEB','MAR','APR',
          'MAY','JUN','JUL','AUG',
          "SEP",'OCT','NOV','DEC')
  
  mon = factor(mon,levels = mon)
  
  mon_contrb_mean$mon = mon
  mon_contrb_max$mon = mon
  mon_contrb_min$mon = mon
  
  
  mon_contrb_mean$type = 'Mean'
  mon_contrb_max$type = "Max"
  mon_contrb_min$type = 'Min'
  
  colnames(mon_contrb_mean) = c('value','sou_names','mon','type')
  colnames(mon_contrb_max) = c('value','sou_names','mon','type')
  colnames(mon_contrb_min) = c('value','sou_names','mon','type')
  
  bar_df = rbind(mon_contrb_mean,
                 mon_contrb_max,
                 mon_contrb_min)
  
  bar_df$sou_names = factor(bar_df$sou_names,levels = sou_names )
  pbar = ggplot()+
    geom_bar(data = bar_df,aes(x = mon,y = value,fill = sou_names),
             stat = 'identity',position = 'stack',width = 0.5)+
    coord_flip()+
    facet_wrap(~type,ncol = 3)+
    theme_bw()+
    theme(
      panel.background = element_rect(fill = 'transparent'),
      axis.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      axis.title.x = element_text(color = 'black',size = 14,face = 'bold',hjust = 0.5),
      axis.title.y= element_blank(),
      legend.position = 'none',
      legend.direction = 'horizontal',
      legend.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      legend.title = element_text(color = 'black',size = 14, face = 'bold',hjust = 0.5),
      strip.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      plot.margin = unit('cm',c(0,0,1,0))
    )+
    guides(fill = guide_legend(nrow = 1))+
    #xlab('Date (month)')+
    ylab('Contribution rates')
    
  pbar
  
  # import traj 
  source('/home/share/R_project/xinjiang_vapor/traj_import.R')
  traj = traj_import()
  traj = do.call('rbind',traj)
  
  traj_dateid = traj %>%
    group_by(uni_id)%>%
    mutate(dateid = row_number())
  
  traj$dateid = traj_dateid$dateid 
  
  traj<<- traj
  
  con_mon_mean <- function(x){
    ids = which(traj$sou_mon == x)
    
    df_full = traj[ids,]
    id1 = which(!is.na(df_full$contr_rates))
    xid = substr(x,1,2)
    
    print(x)
    contr_df = df_full[id1,]
    loc1 = contr_df[,1:2]
    if(xid == 'po'){
     re = which(loc1$long < (-100))
     loc1 = loc1[re,]
     contr_df = contr_df[re,]
     print(nrow(loc1))
    }
    
    
    if(nrow(loc1)<5){
      cl = 1:nrow(loc1)
      clm = 1:nrow(loc1)
    }else{
      cl = kmeans(loc1,5)
      cl = cl$cluster
      clm = 1:5
    }
   
    contr_df$cluster = cl
    
   
    cl_li = list()
    #sum_contr_rates =1
    for(j in 1:length(unique(cl))){
      idt = which(contr_df$cluster == clm[j])
      tmpdfs = as.data.frame(contr_df[idt,])
      cl_li = c(cl_li,list(tmpdfs))
    }
    cl_li <<- cl_li
    df_full<<-df_full
    
    cal_mean_route <- function(x){
      library(dplyr)
    
      mean_fun2 <-function(x){
        xm = mean(x,na.rm = T)
        return(xm)
      }
      ids = which(df_full$uni_id %in% x$uni_id)
      
      trajtmp = df_full[ids,]
      trajret = data.frame(
        long = aggregate(trajtmp$long,list(trajtmp$dateid),mean)[,2],
        lat = aggregate(trajtmp$lat,list(trajtmp$dateid),mean)[,2],
        height = aggregate(trajtmp$height,list(trajtmp$dateid),mean)[,2],
        sou_mon = unique(trajtmp$sou_mon),
        source_name = unique(trajtmp$source_name),
        cluster = unique(x$cluster),
        mon = unique(x$mon)
      )
      return(trajret)
    }
    
    cl_df = lapply(cl_li,cal_mean_route)
    cl_df = do.call(rbind,cl_df)
    
    cl_df$uni_id2 = paste0(cl_df$sou_mon,'_',cl_df$cluster)
  
    return(cl_df)
  }
  
  mean_traj_mon = lapply(unique(traj$sou_mon),con_mon_mean)
  traj1 = do.call(rbind,mean_traj_mon)
  
  world = shp_management('world')
  xj = shp_management('xinjiang')
  
  world = crop(world,extent(-180,180,0,90))
  
  ptraj = ggplot()+
    geom_polygon(data = world,aes(x = long,y = lat,group = group),fill = 'transparent',color = 'black')+
    geom_polygon(data = xj,aes(x = long,y = lat,group = group),fill = 'transparent',color = 'black')+
    #geom_point(data = traj2,aes(x = long,y = lat,color = source_name),alpha= 0.4)
    geom_path(data = traj1,aes(x = long,y = lat,color = source_name,group = uni_id2))+
    #facet_wrap(~mon,nrow = 3)+
    #scale_color_npg()+
    theme_bw()+
    theme(
      panel.background = element_rect(fill = 'transparent'),
      axis.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      axis.title = element_text(color = 'black',size = 14,face = 'bold',hjust = 0.5),
      legend.position = 'none',
      legend.direction = 'horizontal',
      legend.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      legend.title = element_text(color = 'black',size = 14, face = 'bold',hjust = 0.5),
      strip.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5)
    )+
    guides(color = guide_legend(nrow = 1))+
    xlab('Longitude')+
    ylab('Latitude')
  
  # p var analysis 
  
  library(data.table)
  source('/home/share/R_project/xinjiang_vapor/trend_index.R')
  source('/home/share/R_project/xinjiang_vapor/stand_fun.R')
  contr = fread('analysis_output/contr_in_source_variance_new.csv')
  source('/home/share/R_project/xinjiang_vapor/stand_fun.R')
  sou_name = contr[,1]
  contr = contr[,-1]  
  sum_fun<-function(x){
    x = sum(x,na.rm = T)
  }
  
  contr_sum = apply(contr,2,sum_fun)
  
  contr_sum = as.numeric(contr_sum)
  contr_sum_t = trend_index(contr_sum,c(2003,1),12)
  
  # gpcc 
  source('/home/share/R_project/xinjiang_vapor/gpcc_pr_in_xinjiang.R')
  gpcc_trend = gpcc_pr_in_xinjiang()
  
  # gws
  source('/home/share/R_project/xinjiang_vapor/gws_in_xinjiang.R')
  gws_trend = gws_in_xinjiang()
  
  
  contr_sums = stand_fun(contr_sum_t)
  gpcc_s = stand_fun(gpcc_trend)
  tws_s = stand_fun(gws_trend)
  tws_s = c(tws_s,rep(NA,6))
  date = seq(as.Date('2003-07-01'),
             as.Date('2017-06-01'),
             '1 month')
  
  linedf = data.frame(date,CONTR = contr_sums,PR=gpcc_s,TWS=tws_s)
  linedfm = melt(linedf,'date')
  
  pline = ggplot()+
    geom_line(data = linedfm,aes(x = date,y = value,color = variable),size = 1)+
    scale_color_npg()+
    theme_bw()+
    theme(
      panel.background = element_rect(fill = 'transparent'),
      axis.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      axis.title = element_text(color = 'black',size = 14,face = 'bold',hjust = 0.5),
      legend.position = 'none',
      legend.direction = 'horizontal',
      legend.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      legend.title = element_text(color = 'black',size = 14, face = 'bold',hjust = 0.5),
      strip.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5)
    )+
    guides(color = guide_legend(nrow = 1))+
    xlab('Date')+
    ylab('Indices')
  
  pc = plot_grid(ptraj,pline,align = 'v',axis = 'lr',ncol = 1,
                 rel_widths = 1,rel_heights = 1)
  pbar = ggplot()+
    geom_bar(data = bar_df,aes(x = mon,y = value,fill = sou_names),
             stat = 'identity',position = 'stack',width = 0.5)+
    coord_flip()+
    facet_wrap(~type,ncol = 3)+
    theme_bw()+
    theme(
      panel.background = element_rect(fill = 'transparent'),
      axis.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      axis.title.x = element_text(color = 'black',size = 14,face = 'bold',hjust = 0.5),
      axis.title.y= element_blank(),
      legend.position = 'none',
      legend.direction = 'horizontal',
      legend.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      legend.title = element_text(color = 'black',size = 14, face = 'bold',hjust = 0.5),
      strip.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5)
    )+
    guides(fill = guide_legend(nrow = 1))+
    #xlab('Date (month)')+
    ylab('Contribution rates')
  pc2 = plot_grid(pc,pbar,align = 'h',nrow = 1,axis = 'none',
                  rel_heights = c(1,1),rel_widths = c(10,7))
  
  leg1 = get_legend(pline+theme(legend.position = 'bottom'))
  leg2 = get_legend(ptraj+theme(legend.position = 'bottom'))
  leg3 = get_legend(pbar+theme(legend.position = 'bottom'))
  
  leg1 = as_ggplot(leg1)
  leg2 = as_ggplot(leg2)
  leg3 = as_ggplot(leg3)
  
  png()
  
  png('plot/pc_traj2.png',
      height = 30,
      width = 30,
      units = 'cm',
      res = 800)
  print(pc2)
  dev.off()
  
  png('plot/pc_traj2_leg1.png',
      height = 30,
      width = 30,
      units = 'cm',
      res = 800)
  print(leg1)
  dev.off()
  
  png('plot/pc_traj2_leg2.png',
      height = 30,
      width = 30,
      units = 'cm',
      res = 800)
  print(leg2)
  dev.off()
  
  png('plot/pc_traj2_leg3.png',
      height = 30,
      width = 30,
      units = 'cm',
      res = 800)
  print(leg3)
  dev.off()
  
}

  
plot_all_particles_traj<-function(
  input_data
){
  input ="alldates_output.csv"
  input = paste0(input_data,'/',input)
  
  mat = fread(input)
  df = as.data.frame(mat)
  
  shp = shapefile('/usr/local/flexpart_bk1/shp/world.shp')
  df = d1
  df$epd= c(0,eqd)
  df$cuts = cut(df$epd,breaks=c(-50,0,120))
  
  p = ggplot()+
    geom_polygon(data = shp,aes(x = long,y = lat,group = group),fill = 'grey50',color = 'transparent',
                 size = 0.5)+
    geom_path(data = df,aes(x = long, y = lat,group = type,color = varep))+
    geom_point(data = df,aes(x = long,y = lat,group = type,color = varep))+
    scale_fill_discrete(palette= "Spectral")+
    
    xlab('Longitude')+
    ylab('Latitude')
  
  
  
  png('test2.png',
      height = 22,
      width = 30,
      units = 'cm',
      res = 800)
  print(p)
  dev.off()
}
plot3d_traj<-function(
  
){
  # input dem
  
  dem = data_management('global_dem')
  
  dem1 = crop(dem,extent(0,180,-90,90))
  dem2 = crop(dem,extent(180,360,-90,90))
  extent(dem2) = extent(-180,0,-90,90)
  dem = merge(dem2,dem1)
  
  dem = crop(dem,extent(-180,180,0,90))
  
  library(rayshader)
  library(dplyr)
  library(plotly)
  
  demdf = raster_to_matrix(dem)
  
  # input traj 
  library(data.table)
  traj_df = fread('analysis_output/monthly_kmeans_traj_rbind.csv')
  traj_df = as.data.frame(traj_df)
  
  library(RColorBrewer)
  library(ggplot2)
  mypal = colorRampPalette(brewer.pal(10,'Spectral'))(length(unique(traj_df$group)))
  
  demxy = as.data.frame(demdf,xy = T)
  long1 = sort(as.numeric(unique(demxy$x)))
  lat1 = sort(as.numeric(unique(demxy$y)))
  
  fig1 = #traj_df %>%
    #group_by(group,long) %>%
    #group_by(group,lat) %>%
    #group_by(group,height) %>%
    plot_ly(data = traj_df,x = ~ lat,
            y = ~ long,
            z = ~ height,
            type = 'scatter3d',
            #type = 'scatter',
            mode = 'lines',
            color = ~ group,
            group = ~group ,
            line = list(color = mypal,width = 1)) %>%
    #plot_ly()%>%
    add_surface(x = ~ lat1, y = ~long1, z = ~demdf)
  
  #
  #x = as.numeric(demdf$x)
  #y = as.numeric(demdf$y)
  z = as.matrix(demdf$z,nrow = 1)
  fig2 = 
    plot_ly(#x = ~x,
            #y = ~y,
            #z = ~z,
            type = 'surface') %>%
    add_surface(z = ~z) %>%
    layout(
      scene = list(
        xaxis = list(nticks = 20),
        zaxis = list(nticks = 4),
        camera = list(eye = list(x = 0, y = -1, z = 0.5)),
        aspectratio = list(x = .9, y = .8, z = 0.2)))


  
}
predic_tws_model_cmip6 <-function(
  model_name,
  pattern 
){
  i = 1:2
  #i = 2
  model_name <<- model_name
  pattern <<- pattern 
  
  predict_model_mean <-function(i){
    files_moun = c('north_moun','south_moun')
    files_jishui = c('north_jishui','south_jishui')
    
    # input conveid vapor
    con_amount_moun  = paste0('convey_amount_based_on_cmip6_in_target/',
                              pattern,'/',
                              'mean/',
                              model_name,
                              '/',
                              files_moun[i],
                              '.csv')
    con_amount_jishui = paste0('convey_amount_based_on_cmip6_in_target/',
                               pattern,'/',
                               'mean/',
                               model_name,
                               '/',
                               files_jishui[i],
                               '.csv')
    con_amount_moun = as.data.frame(fread(con_amount_moun))
    con_amount_jishui = as.data.frame(fread(con_amount_jishui))
    
    if(ncol(con_amount_moun) !=12){
      colnames(con_amount_moun) = paste0('pr_mount',1:11)
    }else{
      colnames(con_amount_moun) = paste0('pr_mount',1:12)
    }
    
    if(ncol(con_amount_jishui) !=12){
      colnames(con_amount_jishui) = paste0('pr_jishui',1:11)  
    }else{
      colnames(con_amount_jishui) = paste0('pr_jishui',1:12)  
    }
    
    
    
    con_moun_sum = apply(con_amount_moun,2,sum)
    con_jishui_sum = apply(con_amount_jishui,2,sum)
    
    id_re_moun = as.numeric(which(con_moun_sum < 5000))
    id_re_jishui = as.numeric(which(con_jishui_sum < 5000))
    
    print(id_re_moun)
    print(id_re_jishui)
    if(length(id_re_moun)>0){
      con_amount_moun = con_amount_moun[,-id_re_moun]
    }
    if(length(id_re_jishui)>0){
      con_amount_jishui = con_amount_jishui[,-id_re_jishui]
    }
    
    # import evaporation in mount and palin
    eva_input = 'eva_in_target_cmip6/'
    eva_input = paste0(eva_input,pattern)
    eva_input = paste0(eva_input,'/',model_name)
    
    eva_input_moun = paste0(eva_input,'/',files_moun[i],'.csv')
    eva_input_jishui = paste0(eva_input,'/',files_jishui[i],'.csv')
   
    eva_moun = as.data.frame(fread(eva_input_moun))
    eva_jishui = as.data.frame(fread(eva_input_jishui))
    
    eva_moun = eva_moun*-1
    eva_jishui = eva_jishui *-1
    
    # import t in mountain
    t_input = 'temp_in_target_cmip6/'
    t_input = paste0(t_input,'/',pattern)
    t_input = paste0(t_input,'/',model_name)
    
    t_input_moun = paste0(t_input,'/',files_moun[i],'.csv')
    t_moun = as.data.frame(fread(t_input_moun))
    t_moun = as.numeric(t_moun[,1])
    t_moun = t_moun -273.15
    
    # import tws 
    input_tws = 'tws_in_target/'
    input_tws = paste0(input_tws,files_jishui[i],'.csv')
    
    tws_jishui = as.data.frame(fread(input_tws))
    
    stand_fun1 <-function(x){
      x= (x-mean(x))/(max(x)-min(x))
    }
    
    stand_fun2 <-function(x){
      x= (x)/(max(x)-min(x))
    }
    df = data.frame(
      tws = stand_fun2(tws_jishui[,1]),
      con_amount_moun[1:174,],
      con_amount_jishui[1:174,],
      eva_moun = eva_moun[1:174,],
      eva_jishui =eva_jishui[1:174,],
      t = t_moun[1:174]
    )
    df2 = df[,-1]
    
    
    df2 = apply(df2,2,stand_fun1)
    df = data.frame(tws = df$tws,
                    df2)
    
    df_project = data.frame(
      con_amount_moun[175:576,],
      con_amount_jishui[175:576,],
      eva_moun = eva_moun[175:576,],
      eva_jishui = eva_jishui[175:576,],
      t = t_moun[175:576]
    )
    
    df_project = apply(df_project,2,stand_fun1)
    
    #if(i ==2){
    #  df = data.frame(tws = df$tws,
                      #con_amount_moun[1:174,],
                      #eva_jishui = df$eva_jishui,
    #                  t = t_moun[1:174])
    #  df_project = data.frame(
    #    t = t_moun[175:576]
    #  )
    #  df_project$t = stand_fun1(df_project$t)
    #}
    
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws.R')
    ret = random_forest_model_tws(df,df_project)
  }
  print(model_name)
  ret_box = lapply(i,predict_model_mean)
  
  return(ret_box)
  
}
predict_model_based_era5_proj_by_cmip6 <- function(
  
){
  
  # era5 model
  library(data.table)
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  source('/home/share/R_project/xinjiang_vapor/source_id_identify.R')
  
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:180,]
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:180,]
  
  sst_mean1 = 'era5_sst_mean/ato/region1/era5_sst_mean.csv'
  sst_mean3 = 'era5_sst_mean/ato/region3/era5_sst_mean.csv'
  
  sst1= as.data.frame(fread(sst_mean1))
  sst3 = as.data.frame(fread(sst_mean3))
  
  era5_sst = cbind(sst1,sst3)
  era5_sst = era5_sst[1:174,]
  era5_sst = as.matrix(era5_sst)
  
  era5_pme = pe_in_source[,c(5,7)] - pet_sum[,c(5,7)]
  era5_pme = as.matrix(era5_pme)
  era5_pme = era5_pme[1:174,]
  
  source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
  era5_sst = trend_fun(era5_sst)
  era5_pme = trend_fun(era5_pme)
  
  naid = which(is.na(era5_sst[,1]))
  era5_sst = era5_sst[-naid,]
  era5_pme = era5_pme[-naid,]
  
  # import tws
  input_tws = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws = fread(input_tws)
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  tws = as.data.frame(tws)
  tws = tws[,-1]
  twsdf = tws[,id_box]
  colnames(twsdf) = paste0('SW',1:10)
  twsdf <<- twsdf
  
  i = 1:ncol(twsdf)
  i <<- i
  era5_pme <<- era5_pme
  era5_sst <<- era5_sst
  
  # import pme1 pme3 cmip6
  input_sst = list.files('analysis_output/cmip6_by_model/sst',
                         full.names = T)
  input_pme = list.files('analysis_output/cmip6_by_model/pme',
                         full.names = T)
  
  
  
  sst = lapply(lapply(input_sst,fread),as.data.frame)
  pme = lapply(lapply(input_pme,fread),as.data.frame)
  
  sst_trend = sst
  pme_trend = pme
  #sst_trend = lapply(sst,trend_fun)
  #pme_trend = lapply(pme,trend_fun)
  
  sst1_ssp245 = sst_trend[[1]]
  sst1_ssp585 = sst_trend[[2]]
  sst3_ssp245 = sst_trend[[3]]
  sst3_ssp585 = sst_trend[[4]]
  
  pme1_ssp245 = pme_trend[[1]]
  pme1_ssp585 = pme_trend[[2]]
  pme3_ssp245 = pme_trend[[3]]
  pme3_ssp585 = pme_trend[[4]]
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(sst1_ssp245) = modelnames
  colnames(sst1_ssp585) = modelnames
  colnames(sst3_ssp245) = modelnames
  colnames(sst3_ssp585) = modelnames
  
  colnames(pme1_ssp245) = modelnames
  colnames(pme1_ssp585) = modelnames
  colnames(pme3_ssp245) = modelnames
  colnames(pme3_ssp585) = modelnames
  
  sst1_ssp245 <<- sst1_ssp245
  sst1_ssp585 <<- sst1_ssp585
  sst3_ssp245 <<- sst3_ssp245
  sst3_ssp585 <<- sst3_ssp585
  
  pme1_sst245 <<- pme1_ssp245
  pme3_ssp245 <<- pme3_ssp245
  pme1_ssp585 <<- pme1_ssp585
  pme3_ssp585 <<- pme3_ssp585
  
  source('/home/share/R_project/xinjiang_vapor/sub_train_based_era5_cmip6_ssp245.R')
  source('/home/share/R_project/xinjiang_vapor/sub_train_based_era5_cmip6_ssp585.R')
  
  ret245 = sub_train_based_era5_cmip6_ssp245()
  ret585 = sub_train_based_era5_cmip6_ssp585()
  
  ret245mean = ret245[[1]]
  ret245maxmin = ret245[[2]]
  
  path = 'analysis_output/fig4/project_tws'
  dir.create(path)
  output_ret245mean = paste0(path,'/tws245_mean.csv')
  output_ret245maxmin = paste0(path,'/tws245_maxmin.csv')
  
  fwrite(ret245mean,output_ret245mean)
  fwrite(ret245maxmin,output_ret245maxmin)
  
  ret585mean = ret585[[1]]
  ret585maxmin = ret585[[2]]
  
  path = 'analysis_output/fig4/project_tws'
  dir.create(path)
  output_ret585mean = paste0(path,'/tws585_mean.csv')
  output_ret585maxmin = paste0(path,'/tws585_maxmin.csv')
  
  fwrite(ret585mean,output_ret585mean)
  fwrite(ret585maxmin,output_ret585maxmin)
  
  
}
predict_model_based_on_convey<-function(
  
){
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  gpcc_pr = paste0('gpcc_pr_in_target/',files,'.csv')
  era5_pr = paste0('era5_pr_in_target/',files,'.csv')
  
  con_amount_input = paste0('convey_amount_based_era5_in_target')
  
  
  # 2003-2013
  # 2013-2017
  i = 1:4
  predict_model_mean<-function(i){
    files = c('north_moun','north_jishui','south_moun','south_jishui')
    gpcc_pr = paste0('gpcc_pr_in_target/',files[i],'.csv')
    print(gpcc_pr)
    era5_pr = paste0('era5_pr_in_target/',files[i],'.csv')
    con_amount_input = paste0('convey_amount_based_era5_in_target/mean/',
                              files[i],'.csv')
    
    gpcc = fread(gpcc_pr)
    con_amount = fread(con_amount_input)
    
    colnames(gpcc) = 'gpcc_pr'
    colnames(con_amount) = paste0('pr',1:12)
    
    gpcc = as.data.frame(gpcc)
    con_amount = as.data.frame(con_amount)
    
    con_sum = apply(con_amount,2,sum)
    id_re = as.numeric(which(con_sum <100))
    if(length(id_re)>0){
      con_amount = con_amount[,-id_re]  
    }
    
    df = data.frame(gpcc,con_amount)
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_test.R')
    #pre_fun  = lm(gpcc_pr ~ ., data= df)
    
    #print(id_re)
    #fit = pre_fun$fitted.values
    ret = random_forest_model_test(df)
    #return(cbind(gpcc$gpcc_pr,fit))
    return(ret)
  }
  
  ret_box = lapply(i,predict_model_mean)
  
  
  trend_li_fun<- function(x){
    txb = 1
    for(i in 1:ncol(x)){
      tx = ts(x[,i],start = c(2003,1),frequency = 12)
      tx = decompose(tx)$trend
      txb = cbind(txb,tx)
    }
    txb = txb[,-1]
    return(txb)
  }
  
  rts  = lapply(ret_box,trend_li_fun)
  naid = which(is.na(rts[[1]][,1]))
  
  rts_north_moun = ret_box[[1]]
  rts_north_jishui = ret_box[[2]]
  rts_south_moun = ret_box[[3]]
  rts_south_jishui = ret_box[[4]]
  
  date = seq(as.Date('2003-01-01'),as.Date('2017-12-01'),'1 month')
  date = date[1:(nrow(rts_north_jishui))]
  rts_df1 = data.frame(date = date,
                        gpcc = rts_north_moun[,1],
                       simu = rts_north_moun[,2],
                       type= 'North_mountain')
  rts_df2 = data.frame(
    date = date,
    gpcc = rts_north_jishui[,1],
    simu = rts_north_jishui[,2],
    type = 'North_plain'
  )
  
  rts_df3 = data.frame(
    date = date,
    gpcc = rts_south_moun[,1],
    simu = rts_south_moun[,2],
    type = 'South_mountain'
  )
  
  rts_df4 = data.frame(
    date = date,
    gpcc = rts_south_jishui[,1],
    simu = rts_south_jishui[,2],
    type = 'South_plain'
  )
  
  rts_df1 = rts_df1[-naid,]
  rts_df2 = rts_df2[-naid,]
  rts_df3 = rts_df3[-naid,]
  rts_df4 = rts_df4[-naid,]
  
  df = rbind(rts_df1,rts_df2,rts_df3,rts_df4)
  pbar = ggplot()+
    geom_point(data = df,aes(x = gpcc,y =  simu),color = 'blue',
               size = 1)+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
  
  rts_df1 = reshape2::melt(rts_df1,c('date','type'))
  rts_df2 = reshape2::melt(rts_df2,c('date','type'))
  rts_df3 = reshape2::melt(rts_df3,c('date','type'))
  rts_df4 = reshape2::melt(rts_df4,c('date','type'))
  
  library(ggplot2)
  df = rbind(rts_df1,rts_df2,rts_df3,rts_df4)
  
  p = ggplot()+
    geom_line(data = df,aes(x = date,y = value,color = variable))+
    scale_color_manual(values = c('blue','green'))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
   
  
  
}
predict_snowmelt_based_on_pr_e <-function(
  
){
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  snowm = paste0('snowmelt_in_target/',files,'csv')
  tmean = paste0('temperature_in_target/',files,'.csv')
  
  
  #gpcc_pr = paste0('gpcc_pr_in_target/',files,'.csv')
  
  i = 1:2
  
  predict_model_mean <-function(i){
    files = c('north_moun','south_moun')
    snowm = paste0('snowmelt_in_target/',files,'.csv')
    tmean = paste0('temperature_in_target/',files,'.csv')
    
    con_amount_input = paste0('convey_amount_based_era5_in_target/mean/',
                              files[i],'.csv')
    snowm = fread(snowm[i])
    tmean = fread(tmean[i])
    con_amount = fread(con_amount_input)
    
    snowm = as.data.frame(snowm)
    tmean = as.data.frame(tmean)
    con_amount = as.data.frame(con_amount)
    
    colnames(snowm) = 'snowm' # jsut for model, means snowm
    colnames(tmean) = 'tmean'
    colnames(con_amount) = paste0('pr',1:12)
    
    con_sum = apply(con_amount,2,sum)
    id_re = as.numeric(which(con_sum <100))
    if(length(id_re)>0){
      con_amount = con_amount[,-id_re]  
    }
    
    df = data.frame(snowm,tmean,con_amount)
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_snowm.R')
    ret = random_forest_model_snowm(df)
    
    return(ret)
    
  }
  
  ret_box = lapply(i,predict_model_mean)
  
  trend_li_fun<- function(x){
    txb = 1
    for(i in 1:ncol(x)){
      tx = ts(x[,i],start = c(2003,1),frequency = 12)
      tx = decompose(tx)$trend
      txb = cbind(txb,tx)
    }
    txb = txb[,-1]
    return(txb)
  }
  
  rts  = lapply(ret_box,trend_li_fun)
  naid = which(is.na(rts[[1]][,1]))
  
  rts_north_moun = ret_box[[1]]
  rts_south_moun = ret_box[[2]]
  
  date = seq(as.Date('2003-01-01'),as.Date('2017-12-01'),'1 month')
  date = date[1:(nrow(rts_north_jishui))]
  
  rts_df1 = data.frame(date = date,
                       snowm = rts_north_moun[,1],
                       simu = rts_north_moun[,2],
                       type= 'North_mountain')
  rts_df2 = data.frame(
    date = date,
    snowm = rts_south_moun[,1],
    simu = rts_south_moun[,2],
    type = 'South_mountain'
  )
  
  rts_df1 = rts_df1[-naid,]
  rts_df2 = rts_df2[-naid,]
  
  df = rbind(rts_df1,rts_df2)
  
  
  output = 'simu_df_snowmelt'
  dir.create(output)
  output = paste0(output,c('/north_moun.csv','/south_moun.csv'))
  
  fwrite(rts_df1,output[1])
  fwrite(rts_df2,output[2])
  
  
  
  pbar = ggplot()+
    geom_point(data = df,aes(x = snowm,y =  simu),color = 'blue',
               size = 1)+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
  pbar
  
  
  
}
predict_tws_based_on_convey_eva<-function(
  
){
  i = 1:2
  
  predict_model_mean <-function(i){
    
    files_moun = c('north_moun','south_moun')
    files_jishui = c('north_jishui','south_jishui')
    
    # input conveid vapor
    con_amount_moun  = paste0('convey_amount_based_era5_eva_in_target/mean/',
                              files_moun[i],
                              '.csv')
    con_amount_jishui = paste0('convey_amount_based_era5_eva_in_target/mean/',
                               files_jishui[i],
                               '.csv')
    
    con_amount_moun = as.data.frame(fread(con_amount_moun))
    con_amount_jishui = as.data.frame(fread(con_amount_jishui))
    
    colnames(con_amount_moun) = paste0('pr_mount',1:12)
    colnames(con_amount_jishui) = paste0('pr_jishui',1:12)
    
    con_moun_sum = apply(con_amount_moun,2,sum)
    con_jishui_sum = apply(con_amount_jishui,2,sum)
    
    con_moun_sum = as.numeric(con_moun_sum)/180
    con_jishui_sum = as.numeric(con_jishui_sum)/180
    
    id_re_moun = as.numeric(which(con_moun_sum < 1000))
    id_re_jishui = as.numeric(which(con_jishui_sum < 1000))
    
    print(id_re_moun)
    print(id_re_jishui)
    if(length(id_re_moun)>0){
      con_amount_moun = con_amount_moun[,-id_re_moun]
    }
    if(length(id_re_jishui)>0){
      con_amount_jishui = con_amount_jishui[,-id_re_jishui]
    }
    
    # import evaporation in mount and palin
    eva_input = 'evaporation_in_target/'
    eva_input_moun = paste0(eva_input,files_moun[i],'.csv')
    eva_input_jishui = paste0(eva_input,files_jishui[i],'.csv')
    
    eva_moun = as.data.frame(fread(eva_input_moun))
    eva_jishui = as.data.frame(fread(eva_input_jishui))
    
    eva_moun = eva_moun *-1
    eva_jishui = eva_jishui *-1
    
    # import t in mountain
    t_input = 'temperature_in_target/'
    t_input_moun = paste0(t_input,files_moun[i],'.csv')
    t_moun = as.data.frame(fread(t_input_moun))
    t_moun = t_moun -273.15
    
    # import tws 
    input_tws = 'tws_in_target/'
    input_tws = paste0(input_tws,files_jishui[i],'.csv')
    
    tws_jishui = as.data.frame(fread(input_tws))
    
    stand_fun1 <-function(x){
      x= (x-mean(x))/(max(x)-min(x))
    }
    
    stand_fun2 <-function(x){
      x= (x)/(max(x)-min(x))
    }
    df = data.frame(
      tws = stand_fun2(tws_jishui[,1]),
      con_amount_moun[1:174,],
      con_amount_jishui[1:174,],
      eva_moun = eva_moun[1:174,],
      eva_jishui =eva_jishui[1:174,],
      t = t_moun[1:174,]
    )
    df2 = df[,-1]
    
    
    df2 = apply(df2,2,stand_fun1)
    df = data.frame(tws = df$tws,
                    df2)
    #if(i ==2){
    #  df = data.frame(tws = df$tws,
    #                  #con_amount_moun[1:174,],
    #                  #eva_jishui = df$eva_jishui,
    #                  t = t_moun[1:174,])
    #}
    
    
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws.R')
    ret = random_forest_model_tws(df)
    
  }
  
  ret_box = lapply(i,predict_model_mean)
  
  trend_li_fun<- function(x){
    txb = 1
    for(i in 1:ncol(x)){
      tx = ts(x[,i],start = c(2003,1),frequency = 12)
      tx = decompose(tx)$trend
      txb = cbind(txb,tx)
    }
    txb = txb[,-1]
    return(txb)
  }
  
  
  rts_north_jishui = ret_box[[1]][[1]]
  rts_south_jishui= ret_box[[2]][[1]]
  rts_north_jishui_test = ret_box[[1]][[2]]
  rts_south_jishui_test = ret_box[[2]][[2]]
  
  
  files = c('north_tws_train_mean.csv',
            'south_tws_train_mean.csv',
            'north_tws_test_mean.csv',
            'south_tws_test_mean.csv')
  
  
  output = paste0('output_simu_tws/',files)
  
  ret_box = list(rts_north_jishui,rts_south_jishui,
                 rts_north_jishui_test,rts_south_jishui_test)
  fwrite(ret_box[[1]],output[1])
  fwrite(ret_box[[2]],output[2])
  fwrite(ret_box[[3]],output[3])
  fwrite(ret_box[[4]],output[4])
  
  
  
  #rts  = lapply(ret_box,trend_li_fun)
  #naid = which(is.na(rts[[1]][,1]))
  
  #rts_north_jishui = rts[[1]]
  #rts_south_jishui= rts[[2]]
  #rts_north_jishui_test = rts[[3]]
  #rts_south_jishui_test = rts[[4]]
  
  date = seq(as.Date('2003-01-01'),as.Date('2017-12-01'),'1 month')
  date_train = date[1:121]
  date_test = date[122:174]
  
  rts_df1 = data.frame(date = date_train,
                       tws = rts_north_jishui[,1],
                       simu = rts_north_jishui[,2],
                       type= 'North_plain_train')
  rts_df2 = data.frame(
    date = date_train,
    tws = rts_south_jishui[,1],
    simu = rts_south_jishui[,2],
    type = 'South_plain_train'
  )
  
  rts_df3 = data.frame(date = date_test,
                       tws = rts_north_jishui_test[,1],
                       simu = rts_north_jishui_test[,2],
                       type= 'North_plain_test')
  rts_df4 = data.frame(
    date = date_test,
    tws = rts_south_jishui_test[,1],
    simu = rts_south_jishui_test[,2],
    type = 'South_plain_test'
  )
  
  #rts_df1 = rts_df1[-naid,]
  #rts_df2 = rts_df2[-naid,]
  
  df = rbind(rts_df1,rts_df2,
             rts_df3,rts_df4)
  
  pbar = ggplot()+
    geom_point(data = df,aes(x = tws,y =  simu),color = 'blue',
               size = 1)+
    geom_abline(data = df,aes(slope = 1,intercept = 0))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
  pbar
  
  
  dfm = melt(df,c('date','type'))
  pline = ggplot()+
    geom_line(data = dfm,aes(x = date,y = value,
                             color = variable))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
}


























predict_tws_based_on_convey_linear<-function(
  
){
  i = 1:2
  
  predict_model_mean <-function(i){
    
    files_moun = c('north_moun','south_moun')
    files_jishui = c('north_jishui','south_jishui')
    
    # input conveid vapor
    con_amount_moun  = paste0('convey_amount_based_era5_in_target/mean/',
                              files_moun[i],
                              '.csv')
    con_amount_jishui = paste0('convey_amount_based_era5_in_target/mean/',
                               files_jishui[i],
                               '.csv')
    
    con_amount_moun = as.data.frame(fread(con_amount_moun))
    con_amount_jishui = as.data.frame(fread(con_amount_jishui))
    
    colnames(con_amount_moun) = paste0('pr_mount',1:12)
    colnames(con_amount_jishui) = paste0('pr_jishui',1:12)
    
    con_moun_sum = apply(con_amount_moun,2,sum)
    con_jishui_sum = apply(con_amount_jishui,2,sum)
    
    id_re_moun = as.numeric(which(con_moun_sum < 5000))
    id_re_jishui = as.numeric(which(con_jishui_sum < 5000))
    
    if(length(id_re_moun)>0){
      con_amount_moun = con_amount_moun[,-id_re_moun]
    }
    if(length(id_re_jishui)>0){
      con_amount_jishui = con_amount_jishui[,-id_re_jishui]
    }
    
    # import evaporation in mount and palin
    eva_input = 'evaporation_in_target/'
    eva_input_moun = paste0(eva_input,files_moun[i],'.csv')
    eva_input_jishui = paste0(eva_input,files_jishui[i],'.csv')
    
    eva_moun = as.data.frame(fread(eva_input_moun))
    eva_jishui = as.data.frame(fread(eva_input_jishui))
    
    eva_moun = eva_moun *-1
    eva_jishui = eva_jishui *-1
    
    # import t in mountain
    t_input = 'temperature_in_target/'
    t_input_moun = paste0(t_input,files_moun[i],'.csv')
    t_moun = as.data.frame(fread(t_input_moun))
    t_moun = t_moun -273.15
    
    # import tws 
    input_tws = 'tws_in_target/'
    input_tws = paste0(input_tws,files_jishui[i],'.csv')
    
    tws_jishui = as.data.frame(fread(input_tws))
    
    df = data.frame(
      tws = tws_jishui[,1],
      con_amount_moun[1:174,],
      con_amount_jishui[1:174,],
      eva_moun = eva_moun[1:174,],
      eva_jishui =eva_jishui[1:174,],
      t = t_moun[1:174,]
    )
    #source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws.R')
    #ret = random_forest_model_tws(df)
    source('/home/share/R_project/xinjiang_vapor/liner_model.R')
    ret = liner_model(df)
    return(ret)
  }
  
  ret_box = lapply(i,predict_model_mean)
  
  trend_li_fun<- function(x){
    txb = 1
    for(i in 1:ncol(x)){
      tx = ts(x[,i],start = c(2003,1),frequency = 12)
      tx = decompose(tx)$trend
      txb = cbind(txb,tx)
    }
    txb = txb[,-1]
    return(txb)
  }
  
  rts  = lapply(ret_box,trend_li_fun)
  naid = which(is.na(rts[[1]][,1]))
  
  rts_north_jishui = ret_box[[1]]
  rts_south_jishui= ret_box[[2]]
  
  rts_north_jishui = rts[[1]]
  rts_south_jishui= rts[[2]]
  
  
  date = seq(as.Date('2003-01-01'),as.Date('2017-12-01'),'1 month')
  date = date[1:(nrow(rts_north_jishui))]
  
  rts_df1 = data.frame(date = date,
                       tws = rts_north_jishui[,1],
                       simu = rts_north_jishui[,2],
                       type= 'North_plain')
  rts_df2 = data.frame(
    date = date,
    tws = rts_south_jishui[,1],
    simu = rts_south_jishui[,2],
    type = 'South_plain'
  )
  
  rts_df1 = rts_df1[-naid,]
  rts_df2 = rts_df2[-naid,]
  
  df = rbind(rts_df1,rts_df2)
  
  pbar = ggplot()+
    geom_point(data = df,aes(x = tws,y =  simu),color = 'blue',
               size = 1)+
    geom_abline(data = df,aes(slope = 1,intercept = 0))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
  pbar
  
  
  dfm = melt(df,c('date','type'))
  pline = ggplot()+
    geom_line(data = dfm,aes(x = date,y = value,
                             color = variable))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
}


























predict_tws_based_on_convey_pe<-function(
  
){
  i = 1:2
  
  predict_model_mean <-function(i){
    
    files_moun = c('north_moun','south_moun')
    files_jishui = c('north_jishui','south_jishui')
    
    # input conveid vapor
    con_amount_moun  = paste0('convey_amount_based_era5_pe_in_target/mean/',
                              files_moun[i],
                              '.csv')
    con_amount_jishui = paste0('convey_amount_based_era5_pe_in_target/mean/',
                               files_jishui[i],
                               '.csv')
    
    con_amount_moun = as.data.frame(fread(con_amount_moun))
    con_amount_jishui = as.data.frame(fread(con_amount_jishui))
    
    colnames(con_amount_moun) = paste0('pr_mount',1:12)
    colnames(con_amount_jishui) = paste0('pr_jishui',1:12)
    
    con_moun_sum = apply(con_amount_moun,2,sum)
    con_jishui_sum = apply(con_amount_jishui,2,sum)
    
    id_re_moun = as.numeric(which(con_moun_sum < 5000))
    id_re_jishui = as.numeric(which(con_jishui_sum < 5000))
    
    print(id_re_moun)
    print(id_re_jishui)
    if(length(id_re_moun)>0){
      con_amount_moun = con_amount_moun[,-id_re_moun]
    }
    if(length(id_re_jishui)>0){
      con_amount_jishui = con_amount_jishui[,-id_re_jishui]
    }
    
    # import evaporation in mount and palin
    eva_input = 'evaporation_in_target/'
    eva_input_moun = paste0(eva_input,files_moun[i],'.csv')
    eva_input_jishui = paste0(eva_input,files_jishui[i],'.csv')
    
    eva_moun = as.data.frame(fread(eva_input_moun))
    eva_jishui = as.data.frame(fread(eva_input_jishui))
    
    eva_moun = eva_moun *-1
    eva_jishui = eva_jishui *-1
    
    # import t in mountain
    t_input = 'temperature_in_target/'
    t_input_moun = paste0(t_input,files_moun[i],'.csv')
    t_moun = as.data.frame(fread(t_input_moun))
    t_moun = t_moun -273.15
    
    # import tws 
    input_tws = 'tws_in_target/'
    input_tws = paste0(input_tws,files_jishui[i],'.csv')
    
    tws_jishui = as.data.frame(fread(input_tws))
    
    stand_fun1 <-function(x){
      x= (x-mean(x))/(max(x)-min(x))
    }
    
    stand_fun2 <-function(x){
      x= (x)/(max(x)-min(x))
    }
    df = data.frame(
      tws = stand_fun2(tws_jishui[,1]),
      con_amount_moun[1:174,],
      con_amount_jishui[1:174,],
      eva_moun = eva_moun[1:174,],
      eva_jishui =eva_jishui[1:174,],
      t = t_moun[1:174,]
    )
    df2 = df[,-1]
    
    
    df2 = apply(df2,2,stand_fun1)
    df = data.frame(tws = df$tws,
                    df2)
    if(i ==2){
      df = data.frame(tws = df$tws,
                      #con_amount_moun[1:174,],
                      #eva_jishui = df$eva_jishui,
                      t = t_moun[1:174,])
    }
    
    
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws.R')
    ret = random_forest_model_tws(df)
    
  }
  
  ret_box = lapply(i,predict_model_mean)
  
  trend_li_fun<- function(x){
    txb = 1
    for(i in 1:ncol(x)){
      tx = ts(x[,i],start = c(2003,1),frequency = 12)
      tx = decompose(tx)$trend
      txb = cbind(txb,tx)
    }
    txb = txb[,-1]
    return(txb)
  }
  
  
  rts_north_jishui = ret_box[[1]][[1]]
  rts_south_jishui= ret_box[[2]][[1]]
  rts_north_jishui_test = ret_box[[1]][[2]]
  rts_south_jishui_test = ret_box[[2]][[2]]
  
  
  files = c('north_tws_train_mean.csv',
            'south_tws_train_mean.csv',
            'north_tws_test_mean.csv',
            'south_tws_test_mean.csv')
  
  
  output = paste0('output_simu_tws/',files)
  
  ret_box = list(rts_north_jishui,rts_south_jishui,
                 rts_north_jishui_test,rts_south_jishui_test)
  fwrite(ret_box[[1]],output[1])
  fwrite(ret_box[[2]],output[2])
  fwrite(ret_box[[3]],output[3])
  fwrite(ret_box[[4]],output[4])
  #rts  = lapply(ret_box,trend_li_fun)
  #naid = which(is.na(rts[[1]][,1]))
  
  #rts_north_jishui = rts[[1]]
  #rts_south_jishui= rts[[2]]
  #rts_north_jishui_test = rts[[3]]
  #rts_south_jishui_test = rts[[4]]
  
  date = seq(as.Date('2003-01-01'),as.Date('2017-12-01'),'1 month')
  date_train = date[1:121]
  date_test = date[122:174]
  
  rts_df1 = data.frame(date = date_train,
                       tws = rts_north_jishui[,1],
                       simu = rts_north_jishui[,2],
                       type= 'North_plain_train')
  rts_df2 = data.frame(
    date = date_train,
    tws = rts_south_jishui[,1],
    simu = rts_south_jishui[,2],
    type = 'South_plain_train'
  )
  
  rts_df3 = data.frame(date = date_test,
                       tws = rts_north_jishui_test[,1],
                       simu = rts_north_jishui_test[,2],
                       type= 'North_plain_test')
  rts_df4 = data.frame(
    date = date_test,
    tws = rts_south_jishui_test[,1],
    simu = rts_south_jishui_test[,2],
    type = 'South_plain_test'
  )
  
  #rts_df1 = rts_df1[-naid,]
  #rts_df2 = rts_df2[-naid,]
  
  df = rbind(rts_df1,rts_df2,
             rts_df3,rts_df4)
  
  pbar = ggplot()+
    geom_point(data = df,aes(x = tws,y =  simu),color = 'blue',
               size = 1)+
    geom_abline(data = df,aes(slope = 1,intercept = 0))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
  pbar
  
  
  dfm = melt(df,c('date','type'))
  pline = ggplot()+
    geom_line(data = dfm,aes(x = date,y = value,
                             color = variable))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
}


























predict_tws_based_on_convey<-function(
  
){
  i = 1:2
  
  predict_model_mean <-function(i){
    
    files_moun = c('north_moun','south_moun')
    files_jishui = c('north_jishui','south_jishui')
    
    # input conveid vapor
    con_amount_moun  = paste0('convey_amount_based_era5_in_target/mean/',
                              files_moun[i],
                              '.csv')
    con_amount_jishui = paste0('convey_amount_based_era5_in_target/mean/',
                                files_jishui[i],
                                '.csv')
    
    con_amount_moun = as.data.frame(fread(con_amount_moun))
    con_amount_jishui = as.data.frame(fread(con_amount_jishui))
    
    colnames(con_amount_moun) = paste0('pr_mount',1:12)
    colnames(con_amount_jishui) = paste0('pr_jishui',1:12)
    
    con_moun_sum = apply(con_amount_moun,2,sum)
    con_jishui_sum = apply(con_amount_jishui,2,sum)
    
    id_re_moun = as.numeric(which(con_moun_sum < 5000))
    id_re_jishui = as.numeric(which(con_jishui_sum < 5000))
    
    print(id_re_moun)
    print(id_re_jishui)
    if(length(id_re_moun)>0){
      con_amount_moun = con_amount_moun[,-id_re_moun]
    }
    if(length(id_re_jishui)>0){
      con_amount_jishui = con_amount_jishui[,-id_re_jishui]
    }
    
    # import evaporation in mount and palin
    eva_input = 'evaporation_in_target/'
    eva_input_moun = paste0(eva_input,files_moun[i],'.csv')
    eva_input_jishui = paste0(eva_input,files_jishui[i],'.csv')
    
    eva_moun = as.data.frame(fread(eva_input_moun))
    eva_jishui = as.data.frame(fread(eva_input_jishui))
    
    eva_moun = eva_moun *-1
    eva_jishui = eva_jishui *-1
    
    # import t in mountain
    t_input = 'temperature_in_target/'
    t_input_moun = paste0(t_input,files_moun[i],'.csv')
    t_moun = as.data.frame(fread(t_input_moun))
    t_moun = t_moun -273.15
    
    # import tws 
    input_tws = 'tws_in_target/'
    input_tws = paste0(input_tws,files_jishui[i],'.csv')
    
    tws_jishui = as.data.frame(fread(input_tws))
    
    stand_fun1 <-function(x){
      x= (x-mean(x))/(max(x)-min(x))
    }
    
    stand_fun2 <-function(x){
      x= (x)/(max(x)-min(x))
    }
    df = data.frame(
      tws = stand_fun2(tws_jishui[,1]),
      con_amount_moun[1:174,],
      con_amount_jishui[1:174,],
      eva_moun = eva_moun[1:174,],
      eva_jishui =eva_jishui[1:174,],
      t = t_moun[1:174,]
    )
    df2 = df[,-1]
    
    
    df2 = apply(df2,2,stand_fun1)
    df = data.frame(tws = df$tws,
                    df2)
    if(i ==2){
      df = data.frame(tws = df$tws,
                      #con_amount_moun[1:174,],
                      #eva_jishui = df$eva_jishui,
                      t = t_moun[1:174,])
    }
    
    
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws.R')
    ret = random_forest_model_tws(df)

  }
  
  ret_box = lapply(i,predict_model_mean)
  
  trend_li_fun<- function(x){
    txb = 1
    for(i in 1:ncol(x)){
      tx = ts(x[,i],start = c(2003,1),frequency = 12)
      tx = decompose(tx)$trend
      txb = cbind(txb,tx)
    }
    txb = txb[,-1]
    return(txb)
  }
  
  
  rts_north_jishui = ret_box[[1]][[1]]
  rts_south_jishui= ret_box[[2]][[1]]
  rts_north_jishui_test = ret_box[[1]][[2]]
  rts_south_jishui_test = ret_box[[2]][[2]]
  
  
  files = c('north_tws_train_mean.csv',
            'south_tws_train_mean.csv',
            'north_tws_test_mean.csv',
            'south_tws_test_mean.csv')
  
  
  output = paste0('output_simu_tws/',files)
  
  ret_box = list(rts_north_jishui,rts_south_jishui,
                 rts_north_jishui_test,rts_south_jishui_test)
  fwrite(ret_box[[1]],output[1])
  fwrite(ret_box[[2]],output[2])
  fwrite(ret_box[[3]],output[3])
  fwrite(ret_box[[4]],output[4])
  #rts  = lapply(ret_box,trend_li_fun)
  #naid = which(is.na(rts[[1]][,1]))
  
  #rts_north_jishui = rts[[1]]
  #rts_south_jishui= rts[[2]]
  #rts_north_jishui_test = rts[[3]]
  #rts_south_jishui_test = rts[[4]]
  
  date = seq(as.Date('2003-01-01'),as.Date('2017-12-01'),'1 month')
  date_train = date[1:121]
  date_test = date[122:174]
  
  rts_df1 = data.frame(date = date_train,
                       tws = rts_north_jishui[,1],
                       simu = rts_north_jishui[,2],
                       type= 'North_plain_train')
  rts_df2 = data.frame(
    date = date_train,
    tws = rts_south_jishui[,1],
    simu = rts_south_jishui[,2],
    type = 'South_plain_train'
  )
  
  rts_df3 = data.frame(date = date_test,
                       tws = rts_north_jishui_test[,1],
                       simu = rts_north_jishui_test[,2],
                       type= 'North_plain_test')
  rts_df4 = data.frame(
    date = date_test,
    tws = rts_south_jishui_test[,1],
    simu = rts_south_jishui_test[,2],
    type = 'South_plain_test'
  )
  
  #rts_df1 = rts_df1[-naid,]
  #rts_df2 = rts_df2[-naid,]
  
  df = rbind(rts_df1,rts_df2,
             rts_df3,rts_df4)
  
  pbar = ggplot()+
    geom_point(data = df,aes(x = tws,y =  simu),color = 'blue',
               size = 1)+
    geom_abline(data = df,aes(slope = 1,intercept = 0))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
  pbar
  
  
  dfm = melt(df,c('date','type'))
  pline = ggplot()+
    geom_line(data = dfm,aes(x = date,y = value,
                             color = variable))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
}


























predict_tws_basedon_pr_and_e <-function(
  
){
  mode = c('north_moun','north_jishui',
           'south_moun','south_jishui')
  
  # model
  tws = pr_plain - e_plain + pr_moun-e_moun
  # import 
  
  
  
}
predict_tws_max_based_on_convey<-function(
  
){
  i = 1:2
  
  predict_model_mean <-function(i){
    
    files_moun = c('north_moun','south_moun')
    files_jishui = c('north_jishui','south_jishui')
    
    # input conveid vapor
    con_amount_moun  = paste0('convey_amount_based_era5_in_target/max/',
                              files_moun[i],
                              '.csv')
    con_amount_jishui = paste0('convey_amount_based_era5_in_target/max/',
                               files_jishui[i],
                               '.csv')
    
    con_amount_moun = as.data.frame(fread(con_amount_moun))
    con_amount_jishui = as.data.frame(fread(con_amount_jishui))
    
    colnames(con_amount_moun) = paste0('pr_mount',1:12)
    colnames(con_amount_jishui) = paste0('pr_jishui',1:12)
    
    con_moun_sum = apply(con_amount_moun,2,sum)
    con_jishui_sum = apply(con_amount_jishui,2,sum)
    
    id_re_moun = as.numeric(which(con_moun_sum < 5000))
    id_re_jishui = as.numeric(which(con_jishui_sum < 5000))
    
    print(id_re_moun)
    print(id_re_jishui)
    if(length(id_re_moun)>0){
      con_amount_moun = con_amount_moun[,-id_re_moun]
    }
    if(length(id_re_jishui)>0){
      con_amount_jishui = con_amount_jishui[,-id_re_jishui]
    }
    
    # import evaporation in mount and palin
    eva_input = 'evaporation_in_target/'
    eva_input_moun = paste0(eva_input,files_moun[i],'.csv')
    eva_input_jishui = paste0(eva_input,files_jishui[i],'.csv')
    
    eva_moun = as.data.frame(fread(eva_input_moun))
    eva_jishui = as.data.frame(fread(eva_input_jishui))
    
    eva_moun = eva_moun *-1
    eva_jishui = eva_jishui *-1
    
    # import t in mountain
    t_input = 'temperature_in_target/'
    t_input_moun = paste0(t_input,files_moun[i],'.csv')
    t_moun = as.data.frame(fread(t_input_moun))
    t_moun = t_moun -273.15
    
    # import tws 
    input_tws = 'tws_in_target/'
    input_tws = paste0(input_tws,files_jishui[i],'.csv')
    
    tws_jishui = as.data.frame(fread(input_tws))
    
    stand_fun1 <-function(x){
      x= (x-mean(x))/(max(x)-min(x))
    }
    
    stand_fun2 <-function(x){
      x= (x)/(max(x)-min(x))
    }
    df = data.frame(
      tws = stand_fun2(tws_jishui[,1]),
      con_amount_moun[1:174,],
      con_amount_jishui[1:174,],
      eva_moun = eva_moun[1:174,],
      eva_jishui =eva_jishui[1:174,],
      t = t_moun[1:174,]
    )
    df2 = df[,-1]
    
    df2 = apply(df2,2,stand_fun1)
    df = data.frame(tws = df$tws,
                    df2)
    
    
    
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws.R')
    ret = random_forest_model_tws(df)
    
  }
  
  ret_box = lapply(i,predict_model_mean)
  
  trend_li_fun<- function(x){
    txb = 1
    for(i in 1:ncol(x)){
      tx = ts(x[,i],start = c(2003,1),frequency = 12)
      tx = decompose(tx)$trend
      txb = cbind(txb,tx)
    }
    txb = txb[,-1]
    return(txb)
  }
  
  files = c('north_tws_train_max.csv',
            'south_tws_train_max.csv',
            'north_tws_test_max.csv',
            'south_tws_test_max.csv')
  
  output = paste0('output_simu_tws/',files)
  
  rts_north_jishui = ret_box[[1]][[1]]
  rts_south_jishui= ret_box[[2]][[1]]
  rts_north_jishui_test = ret_box[[1]][[2]]
  rts_south_jishui_test = ret_box[[2]][[2]]
  
  ret_box = list(rts_north_jishui,rts_south_jishui,
                 rts_north_jishui_test,rts_south_jishui_test)
  fwrite(ret_box[[1]],output[1])
  fwrite(ret_box[[2]],output[2])
  fwrite(ret_box[[3]],output[3])
  fwrite(ret_box[[4]],output[4])
  #rts  = lapply(ret_box,trend_li_fun)
  #naid = which(is.na(rts[[1]][,1]))
  
  #rts_north_jishui = rts[[1]]
  #rts_south_jishui= rts[[2]]
  #rts_north_jishui_test = rts[[3]]
  #rts_south_jishui_test = rts[[4]]
  
  date = seq(as.Date('2003-01-01'),as.Date('2017-12-01'),'1 month')
  date_train = date[1:121]
  date_test = date[122:174]
  
  rts_df1 = data.frame(date = date_train,
                       tws = rts_north_jishui[,1],
                       simu = rts_north_jishui[,2],
                       type= 'North_plain_train')
  rts_df2 = data.frame(
    date = date_train,
    tws = rts_south_jishui[,1],
    simu = rts_south_jishui[,2],
    type = 'South_plain_train'
  )
  
  rts_df3 = data.frame(date = date_test,
                       tws = rts_north_jishui_test[,1],
                       simu = rts_north_jishui_test[,2],
                       type= 'North_plain_test')
  rts_df4 = data.frame(
    date = date_test,
    tws = rts_south_jishui_test[,1],
    simu = rts_south_jishui_test[,2],
    type = 'South_plain_test'
  )
  
  #rts_df1 = rts_df1[-naid,]
  #rts_df2 = rts_df2[-naid,]
  
  df = rbind(rts_df1,rts_df2,
             rts_df3,rts_df4)
  
  pbar = ggplot()+
    geom_point(data = df,aes(x = tws,y =  simu),color = 'blue',
               size = 1)+
    geom_abline(data = df,aes(slope = 1,intercept = 0))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
  pbar
  
  
  dfm = melt(df,c('date','type'))
  pline = ggplot()+
    geom_line(data = dfm,aes(x = date,y = value,
                             color = variable))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
}


























predict_tws_min_based_on_convey<-function(
  
){
  i = 1:2
  
  predict_model_mean <-function(i){
    
    files_moun = c('north_moun','south_moun')
    files_jishui = c('north_jishui','south_jishui')
    
    # input conveid vapor
    con_amount_moun  = paste0('convey_amount_based_era5_in_target/min/',
                              files_moun[i],
                              '.csv')
    con_amount_jishui = paste0('convey_amount_based_era5_in_target/min/',
                               files_jishui[i],
                               '.csv')
    
    con_amount_moun = as.data.frame(fread(con_amount_moun))
    con_amount_jishui = as.data.frame(fread(con_amount_jishui))
    
    colnames(con_amount_moun) = paste0('pr_mount',1:12)
    colnames(con_amount_jishui) = paste0('pr_jishui',1:12)
    
    con_moun_sum = apply(con_amount_moun,2,sum)
    con_jishui_sum = apply(con_amount_jishui,2,sum)
    
    id_re_moun = as.numeric(which(con_moun_sum < 5000))
    id_re_jishui = as.numeric(which(con_jishui_sum < 5000))
    
    print(id_re_moun)
    print(id_re_jishui)
    if(length(id_re_moun)>0){
      con_amount_moun = con_amount_moun[,-id_re_moun]
    }
    if(length(id_re_jishui)>0){
      con_amount_jishui = con_amount_jishui[,-id_re_jishui]
    }
    
    # import evaporation in mount and palin
    eva_input = 'evaporation_in_target/'
    eva_input_moun = paste0(eva_input,files_moun[i],'.csv')
    eva_input_jishui = paste0(eva_input,files_jishui[i],'.csv')
    
    eva_moun = as.data.frame(fread(eva_input_moun))
    eva_jishui = as.data.frame(fread(eva_input_jishui))
    
    eva_moun = eva_moun *-1
    eva_jishui = eva_jishui *-1
    
    # import t in mountain
    t_input = 'temperature_in_target/'
    t_input_moun = paste0(t_input,files_moun[i],'.csv')
    t_moun = as.data.frame(fread(t_input_moun))
    t_moun = t_moun -273.15
    
    # import tws 
    input_tws = 'tws_in_target/'
    input_tws = paste0(input_tws,files_jishui[i],'.csv')
    
    tws_jishui = as.data.frame(fread(input_tws))
    
    stand_fun1 <-function(x){
      x= (x-mean(x))/(max(x)-min(x))
    }
    
    stand_fun2 <-function(x){
      x= (x)/(max(x)-min(x))
    }
    df = data.frame(
      tws = stand_fun2(tws_jishui[,1]),
      con_amount_moun[1:174,],
      con_amount_jishui[1:174,],
      eva_moun = eva_moun[1:174,],
      eva_jishui =eva_jishui[1:174,],
      t = t_moun[1:174,]
    )
    df2 = df[,-1]
    
    df2 = apply(df2,2,stand_fun1)
    df = data.frame(tws = df$tws,
                    df2)
    
    
    
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws.R')
    ret = random_forest_model_tws(df)
    
  }
  
  ret_box = lapply(i,predict_model_mean)
  
  trend_li_fun<- function(x){
    txb = 1
    for(i in 1:ncol(x)){
      tx = ts(x[,i],start = c(2003,1),frequency = 12)
      tx = decompose(tx)$trend
      txb = cbind(txb,tx)
    }
    txb = txb[,-1]
    return(txb)
  }
  
  
  rts_north_jishui = ret_box[[1]][[1]]
  rts_south_jishui= ret_box[[2]][[1]]
  rts_north_jishui_test = ret_box[[1]][[2]]
  rts_south_jishui_test = ret_box[[2]][[2]]
  
  dir.create('output_simu_tws')
  
  files = c('north_tws_train_min.csv',
            'south_tws_train_min.csv',
            'north_tws_test_min.csv',
            'south_tws_test_min.csv')
  
  output = paste0('output_simu_tws/',files)
  
  
  ret_box = list(rts_north_jishui,rts_south_jishui,
                 rts_north_jishui_test,rts_south_jishui_test)
  fwrite(ret_box[[1]],output[1])
  fwrite(ret_box[[2]],output[2])
  fwrite(ret_box[[3]],output[3])
  fwrite(ret_box[[4]],output[4])
  
  #rts  = lapply(ret_box,trend_li_fun)
  #naid = which(is.na(rts[[1]][,1]))
  
  #rts_north_jishui = rts[[1]]
  #rts_south_jishui= rts[[2]]
  #rts_north_jishui_test = rts[[3]]
  #rts_south_jishui_test = rts[[4]]
  
  date = seq(as.Date('2003-01-01'),as.Date('2017-12-01'),'1 month')
  date_train = date[1:121]
  date_test = date[122:174]
  
  rts_df1 = data.frame(date = date_train,
                       tws = rts_north_jishui[,1],
                       simu = rts_north_jishui[,2],
                       type= 'North_plain_train')
  rts_df2 = data.frame(
    date = date_train,
    tws = rts_south_jishui[,1],
    simu = rts_south_jishui[,2],
    type = 'South_plain_train'
  )
  
  rts_df3 = data.frame(date = date_test,
                       tws = rts_north_jishui_test[,1],
                       simu = rts_north_jishui_test[,2],
                       type= 'North_plain_test')
  rts_df4 = data.frame(
    date = date_test,
    tws = rts_south_jishui_test[,1],
    simu = rts_south_jishui_test[,2],
    type = 'South_plain_test'
  )
  
  #rts_df1 = rts_df1[-naid,]
  #rts_df2 = rts_df2[-naid,]
  
  df = rbind(rts_df1,rts_df2,
             rts_df3,rts_df4)
  
  pbar = ggplot()+
    geom_point(data = df,aes(x = tws,y =  simu),color = 'blue',
               size = 1)+
    geom_abline(data = df,aes(slope = 1,intercept = 0))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
  pbar
  
  
  dfm = melt(df,c('date','type'))
  pline = ggplot()+
    geom_line(data = dfm,aes(x = date,y = value,
                             color = variable))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
}


























predict_tws_model_pe_eva <-function(
  
){
  
  
  i = 1:2
  predict_model<-function(i){
    files_moun = c('north_moun','south_moun')
    files_jishui = c('north_jishui','south_jishui')
    
    
    input_pe = 'precp_minus_evapor_in_target/'
    input_pe = paste0(input_pe,files_jishui,'.csv')
    
    input_snowm = 'snowmelt_in_target/'
    input_snowm = paste0(input_snowm,files_moun,'.csv')
    
    input_tws = 'tws_in_target/'
    input_tws = paste0(input_tws,files_jishui,'.csv')
    
    pe = as.data.frame(fread(input_pe[i]))
    snowm = as.data.frame(fread(input_snowm[i]))
    
    tws = as.data.frame(fread(input_tws[i]))
    
    df = data.frame(tws = tws[,1],
                    pe = pe[1:174,1],
                    snowm = snowm[1:174,1])
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws.R')
    ret = random_forest_model_tws(df)
    
    return(ret)
  }
  
  ret_box = lapply(i,predict_model)
  
  trend_li_fun<- function(x){
    txb = 1
    for(i in 1:ncol(x)){
      tx = ts(x[,i],start = c(2003,1),frequency = 12)
      tx = decompose(tx)$trend
      txb = cbind(txb,tx)
    }
    txb = txb[,-1]
    return(txb)
  }
  
  rts  = lapply(ret_box,trend_li_fun)
  naid = which(is.na(rts[[1]][,1]))
  
  rts_north_jishui = ret_box[[1]]
  rts_south_jishui= ret_box[[2]]
  
  date = seq(as.Date('2003-01-01'),as.Date('2017-12-01'),'1 month')
  date = date[1:(nrow(rts_north_jishui))]
  
  rts_df1 = data.frame(date = date,
                       tws = rts_north_jishui[,1],
                       simu = rts_north_jishui[,2],
                       type= 'North_plain')
  rts_df2 = data.frame(
    date = date,
    tws = rts_south_jishui[,1],
    simu = rts_south_jishui[,2],
    type = 'South_plain'
  )

  #rts_df1 = rts_df1[-naid,]
  #rts_df2 = rts_df2[-naid,]
  
  df = rbind(rts_df1,rts_df2)
  
  
  output = 'simu_df_tws_injishui'
  dir.create(output)
  output = paste0(output,c('/north_jishui.csv','/south_jishui.csv'))
  
  fwrite(rts_df1,output[1])
  fwrite(rts_df2,output[2])
  
  
  
  pbar = ggplot()+
    geom_point(data = df,aes(x = tws,y =  simu),color = 'blue',
               size = 1)+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
  pbar
  
  
  dfm = melt(df,c('date','type'))
  pline = ggplot()+
    geom_line(data = dfm,aes(x = date,y = value,
                             color = variable))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
  
  
  
  
  
  
  
  
}
preproces_oscar_wind_file<-function(
  
){
  library(raster)
  input = '/media/sdb5/Data/oscar_ocean_current/year'
  input = list.files(input,full.names = T)
  files = list.files(input)
  
  mean_each_year <- function(input,var = 'u'){
    library(raster)
    if(var == 'u'){
      output = 'analysis_output/fig4/multi_mean_u.nc'
    }else{
      output = 'analysis_output/fig4/multi_mean_v.nc'
    }
    mean_fun <- function(x){
      x = mean(x,na.rm = T)
      return(x)
    }
    tmpbox = list()
    for(i in 1:length(input)){
      tmp = stack(input[i],varname = var)
      beginCluster(14)
      tmpmean = clusterR(tmp,calc,
                           args = list(fun = mean_fun))
      endCluster()
      tmpbox = c(tmpbox,tmpmean)
      gc()
    }
    tmpbox = do.call('stack',tmpbox)
    
    beginCluster(14)
    tmpmean = clusterR(tmpbox,calc,
                       args = list(fun = mean_fun))
    endCluster()
    
    writeRaster(tmpmean,output,format = 'CDF',
                overwrite = T)
  }
  
  mean_each_year(input,'u')
  mean_each_year(input,'v')
  
  input_u = 'analysis_output/fig4/multi_mean_u.nc'
  input_v = 'analysis_output/fig4/multi_mean_v.nc'
  
  world = shp_management('world')
  
  u = stack(input_u)
  v = stack(input_v)
  
  u1 = crop(u,extent(extent(u)[1],180,-90,90))
  u2 = crop(u,extent(180,360+extent(u)[1],-90,90))
  diff = extent(u)[2]-extent(u)[1]
  
  extent(u2) = extent(180-360,
                      extent(u)[1],
                      extent(u2)[3],
                      extent(u2)[4])
  
  u = merge(u1,u2)
  
  v1 = crop(v,extent(extent(v)[1],180,-90,90))
  v2 = crop(v,extent(180,360+extent(v)[1],-90,90))
  diff = extent(v)[2]-extent(v)[1]
  
  extent(v2) = extent(180-360,
                      extent(v)[1],
                      extent(v2)[3],
                      extent(v2)[4])
  
  v = merge(v1,v2)
  
  u = crop(u,extent(-128,38,0,90))
  v = crop(v,extent(-128,38,0,90))

  ato = shapefile('/media/sdb1/shp/ato_dissolve/ato_diso.shp')
  
  u = mask(u,ato)
  v = mask(v,ato)
  
  u = as.data.frame(u,xy = T)
  v = as.data.frame(v,xy = T)
  
  cur_df = 
    data.frame(
      long = u$x,
      lat = u$y,
      u = u$layer,
      v = v$layer
    )
  
  naid = which(is.na(cur_df$u))
  cur_df = cur_df[-naid,]
  
  fwrite(cur_df,'analysis_output/fig4/current_df.csv')
  idbig = which(cur_df$u>0 &
                  cur_df$v >0)
  
  cur_df = cur_df[idbig,]
  library(scales)
  
  cur_df$u = cur_df$u *10
  cur_df$v = cur_df$v *10
  #cur_df$u = rescale(cur_df$u,c(1,10))
  #cur_df$v = rescale(cur_df$v,c(1,10))
  
  pview = ggplot()+
    geom_segment(data = cur_df[c(TRUE,rep(NA,40)),],
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 30,unit(0.25,'cm'),
                               type = 'open'))
  
  cur_df1 = kmeans(cur_df1[,1:2],100)
  
  loc = cur_df1$centers
  
  
  
  pview = ggplot()+
    geom_segment(data = cur_df[c(TRUE,rep(NA,40)),],
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 30,unit(0.25,'cm'),
                               type = 'open'))+
    facet_wrap(~cluster,nrow = 2)
  
  
  
  return()
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
}
project_tws_along_wind_based_cmip6<-function(
  
){
  sub_data_process<-function(){
    mode = c('ssp245','ssp585')
    source('/home/share/R_project/xinjiang_vapor/extract_region_sum_value_of_pmeato13.R')
    source('/home/share/R_project/xinjiang_vapor/extract_mean_value_of_cmip6_over_ato13.R')
    
    extract_mean_value_of_cmip6_over_ato13(mode[1])
    extract_mean_value_of_cmip6_over_ato13(mode[2])
    extract_region_sum_value_of_pmeato13(mode[1])
    extract_region_sum_value_of_pmeato13(mode[2])
  }
  
  input_sst = list.files('analysis_output/cmip6_by_model/sst',
                          full.names = T)
  input_pme = list.files('analysis_output/cmip6_by_model/pme',
                         full.names = T)
  
  
  sst = lapply(lapply(input_sst,fread),as.data.frame)
  pme = lapply(lapply(input_pme,fread),as.data.frame)
  
  trend_fun <- function(x){
    
    sub_fun <-function(x){
      x = ts(x,start = c(2003,1),
             frequency = 12)
      x = decompose(x)$trend
      
      xt = as.numeric(x)
      stand_fun <-function(y){
        y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
      }
      xy  = stand_fun(xt)
      return(xy)
    }
    xm = apply(x,2,sub_fun)
    return(xm)
  }
  
  sst_trend = lapply(sst,trend_fun)
  pme_trend = lapply(pme,trend_fun)
  
  sst1_ssp245 = sst_trend[[1]]
  sst1_ssp585 = sst_trend[[2]]
  sst3_ssp245 = sst_trend[[3]]
  sst3_ssp585 = sst_trend[[4]]
  
  pme1_ssp245 = pme_trend[[1]]
  pme1_ssp585 = pme_trend[[2]]
  pme3_ssp245 = pme_trend[[3]]
  pme3_ssp585 = pme_trend[[4]]

  
  # import tws
  input_tws = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws = fread(input_tws)
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  tws = as.data.frame(tws)
  tws = tws[,-1]
  twsdf = tws[,id_box]
  
  twsdf <<- twsdf
  colnames(twsdf) = paste0('SW',1:10)
  
  sst1_ssp245 <<- sst1_ssp245
  sst1_ssp585 <<- sst1_ssp585
  sst3_ssp245 <<- sst3_ssp245
  sst3_ssp585 <<- sst3_ssp585
  
  pme1_sst245 <<- pme1_ssp245
  pme3_ssp245 <<- pme3_ssp245
  pme1_ssp585 <<- pme1_ssp585
  pme3_ssp585 <<- pme3_ssp585
  
  i = 1:ncol(twsdf)
  i <<- i
  sub_train_fun <-function(i){
    
    tws_sw = twsdf[,i]
    naid = which(is.na(tws_sw))
    tws_sw = tws_sw[-naid]
    tws_sw <<- tws_sw
    
    # sp245 data
    ###############
    pme1_tv245 = pme1_ssp245[1:174,]
    pme3_tv245 = pme3_ssp245[1:174,]
    sst1_tv245 = sst1_ssp245[1:174,]
    sst3_tv245 = sst3_ssp245[1:174,]
    
    pme1_tv245 = pme1_tv245[-naid,]
    pme3_tv245 = pme3_tv245[-naid,]
    sst1_tv245 = sst1_tv245[-naid,]
    sst3_tv245 = sst3_tv245[-naid,]
    
    pme1_pj245 = pme1_ssp245[175:570,]
    pme3_pj245 = pme3_ssp245[175:570,]
    sst1_pj245 = sst1_ssp245[175:570,]
    sst3_pj245 = sst3_ssp245[175:570,]
    
    pme1_tv245 <<- pme1_tv245
    pme3_tv245 <<- pme3_tv245
    sst1_tv245 <<- sst1_tv245
    sst3_tv245 <<- sst3_tv245
    
    pme1_pj245 <<- pme1_pj245
    pme3_pj245 <<- pme3_pj245
    sst1_pj245 <<- sst1_pj245
    sst3_pj245 <<- sst3_pj245
    ###############
    j = 1:ncol(sst1_tv245)
    j <<- j
    ssp245_fun <-function(j){
      df = data.frame(
        tws = tws_sw,
        pme1 = pme1_tv245[,j],
        pme3 = pme3_tv245[,j],
        sst1 = sst1_tv245[,j],
        sst3 = sst3_tv245[,j]
      )
      
      df_project = data.frame(
        pme1 = pme1_pj245[,j],
        pme3 = pme3_pj245[,j],
        sst1 = sst1_pj245[,j],
        sst3 = sst3_pj245[,j]
      )
      source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws_cmip6.R')
      ret_box = random_forest_model_tws_cmip6(df,
                                              df_project)
    }
    
    ret245 <- lapply(j,ssp245_fun)
    
    #### 
    # 585
    # ssp585 data
    ###############
    pme1_tv585 = pme1_ssp585[1:174,]
    pme3_tv585 = pme3_ssp585[1:174,]
    sst1_tv585 = sst1_ssp585[1:174,]
    sst3_tv585 = sst3_ssp585[1:174,]
    
    pme1_tv585 = pme1_tv585[-naid,]
    pme3_tv585 = pme3_tv585[-naid,]
    sst1_tv585 = sst1_tv585[-naid,]
    sst3_tv585 = sst3_tv585[-naid,]
    
    pme1_pj585 = pme1_ssp585[175:570,]
    pme3_pj585 = pme3_ssp585[175:570,]
    sst1_pj585 = sst1_ssp585[175:570,]
    sst3_pj585 = sst3_ssp585[175:570,]
    
    pme1_tv585 <<- pme1_tv585
    pme3_tv585 <<- pme3_tv585
    sst1_tv585 <<- sst1_tv585
    sst3_tv585 <<- sst3_tv585
    
    pme1_pj585 <<- pme1_pj585
    pme3_pj585 <<- pme3_pj585
    sst1_pj585 <<- sst1_pj585
    sst3_pj585 <<- sst3_pj585
    ###############
    j = 1:ncol(sst1_tv585)
    j <<- j
    ssp585_fun <-function(j){
      df = data.frame(
        tws = tws_sw,
        pme1 = pme1_tv585[,j],
        pme3 = pme3_tv585[,j],
        sst1 = sst1_tv585[,j],
        sst3 = sst3_tv585[,j]
      )
      
      df_project = data.frame(
        pme1 = pme1_pj585[,j],
        pme3 = pme3_pj585[,j],
        sst1 = sst1_pj585[,j],
        sst3 = sst3_pj585[,j]
      )
      source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws_cmip6.R')
      ret_box = random_forest_model_tws_cmip6(df,
                                              df_project)
    }
    
    ret585 <- lapply(j,ssp585_fun)
    
    ret_li = list(ret245,ret585)
    return(ret_li)
  }
  
  library(doParallel)
  cl = makeCluster(10)
  clusterExport(cl,c('twsdf','i','sst1_ssp245',
                     'sst3_ssp245','sst1_ssp585',
                     'sst3_ssp585',
                     'pme1_ssp245',
                     'pme1_ssp585',
                     'pme3_ssp245',
                     'pme3_ssp585'))
  ret_df = parLapply(cl,i,sub_train_fun)
  stopCluster(cl)
  
  
  ret_df = o
  
  
  
  
  
  
  
}
project_tws_along_wind_based_validated_cmip6<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/import_validate_sst.R')
  source('/home/share/R_project/xinjiang_vapor/import_validate_pme_cmip6.R')
  sst = import_validate_sst()
  pme = import_validate_pme_cmip6()
  
  sst_trend = sst
  pme_trend = pme
  #sst_trend = lapply(sst,trend_fun)
  #pme_trend = lapply(pme,trend_fun)
  
  sst1_ssp245 = sst_trend[[1]]
  sst1_ssp585 = sst_trend[[2]]
  sst3_ssp245 = sst_trend[[3]]
  sst3_ssp585 = sst_trend[[4]]
  
  pme1_ssp245 = pme_trend[[1]]
  pme1_ssp585 = pme_trend[[2]]
  pme3_ssp245 = pme_trend[[3]]
  pme3_ssp585 = pme_trend[[4]]
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(sst1_ssp245) = modelnames
  colnames(sst1_ssp585) = modelnames
  colnames(sst3_ssp245) = modelnames
  colnames(sst3_ssp585) = modelnames
  
  colnames(pme1_ssp245) = modelnames
  colnames(pme1_ssp585) = modelnames
  colnames(pme3_ssp245) = modelnames
  colnames(pme3_ssp585) = modelnames
  
  # import tws
  input_tws = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws = fread(input_tws)
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  tws = as.data.frame(tws)
  tws = tws[,-1]
  twsdf = tws[,id_box]
  
  twsdf <<- twsdf
  colnames(twsdf) = paste0('SW',1:10)
  
  sst1_ssp245 <<- sst1_ssp245
  sst1_ssp585 <<- sst1_ssp585
  sst3_ssp245 <<- sst3_ssp245
  sst3_ssp585 <<- sst3_ssp585
  
  pme1_sst245 <<- pme1_ssp245
  pme3_ssp245 <<- pme3_ssp245
  pme1_ssp585 <<- pme1_ssp585
  pme3_ssp585 <<- pme3_ssp585
  
  i = 1:ncol(twsdf)
  i <<- i
  sub_train_fun <-function(i){
    
    tws_sw = twsdf[,i]
    naid = which(is.na(tws_sw))
    tws_sw = tws_sw[-naid]
    tws_sw <<- tws_sw
    
    trend_fun <- function(x){
      
      sub_fun <-function(x){
        x = ts(x,start = c(2003,1),
               frequency = 12)
        x = decompose(x)$trend
        
        xt = as.numeric(x)
        stand_fun <-function(y){
          y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
        }
        xy  = stand_fun(xt)
        return(xy)
      }
      xm = apply(x,2,sub_fun)
      return(xm)
    }
    # sp245 data
    ###############
    pme1_tv245 = pme1_ssp245[1:174,]
    pme3_tv245 = pme3_ssp245[1:174,]
    sst1_tv245 = sst1_ssp245[1:174,]
    sst3_tv245 = sst3_ssp245[1:174,]
    
    pme1_tv245 = trend_fun(pme1_tv245)
    pme3_tv245 = trend_fun(pme3_tv245)
    sst1_tv245 = trend_fun(sst1_tv245)
    sst3_tv245 = trend_fun(sst3_tv245)
    
    pme1_tv245 = pme1_tv245[-naid,]
    pme3_tv245 = pme3_tv245[-naid,]
    sst1_tv245 = sst1_tv245[-naid,]
    sst3_tv245 = sst3_tv245[-naid,]
    
    pme1_pj245 = pme1_ssp245[175:576,]
    pme3_pj245 = pme3_ssp245[175:576,]
    sst1_pj245 = sst1_ssp245[175:576,]
    sst3_pj245 = sst3_ssp245[175:576,]
    
    pme1_pj245 = trend_fun(pme1_pj245)
    pme3_pj245 = trend_fun(pme3_pj245)
    sst1_pj245 = trend_fun(sst1_pj245)
    sst3_pj245 = trend_fun(sst3_pj245)
    
    naid = which(is.na(pme1_pj245[,1]))
    naidfut <<- naid
    
    pme1_pj245 = pme1_pj245[-naid,]
    pme3_pj245 = pme3_pj245[-naid,]
    sst1_pj245 = sst1_pj245[-naid,]
    sst3_pj245 = sst3_pj245[-naid,]
    
    pme1_tv245 <<- pme1_tv245
    pme3_tv245 <<- pme3_tv245
    sst1_tv245 <<- sst1_tv245
    sst3_tv245 <<- sst3_tv245
    
    pme1_pj245 <<- pme1_pj245
    pme3_pj245 <<- pme3_pj245
    sst1_pj245 <<- sst1_pj245
    sst3_pj245 <<- sst3_pj245
    ###############
    j = 1:ncol(sst1_tv245)
    j <<- j
    ssp245_fun <-function(j){
      df = data.frame(
        tws = tws_sw,
        pme1 = pme1_tv245[,j],
        pme3 = pme3_tv245[,j],
        sst1 = sst1_tv245[,j],
        sst3 = sst3_tv245[,j]
      )
      
      df_project = data.frame(
        pme1 = pme1_pj245[,j],
        pme3 = pme3_pj245[,j],
        sst1 = sst1_pj245[,j],
        sst3 = sst3_pj245[,j]
      )
      source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws_cmip6.R')
      ret_box = random_forest_model_tws_cmip6(df,
                                              df_project)
    }
    
    ret245 <- lapply(j,ssp245_fun)
    
    #### 
    # 585
    # ssp585 data
    ###############
    pme1_tv585 = pme1_ssp585[1:174,]
    pme3_tv585 = pme3_ssp585[1:174,]
    sst1_tv585 = sst1_ssp585[1:174,]
    sst3_tv585 = sst3_ssp585[1:174,]
    
    pme1_tv585 = trend_fun(pme1_tv585)
    pme3_tv585 = trend_fun(pme3_tv585)
    sst1_tv585 = trend_fun(sst1_tv585)
    sst3_tv585 = trend_fun(sst3_tv585)
    
    naid = which(is.na(pme1_tv585[,1]))
    pme1_tv585 = pme1_tv585[-naid,]
    pme3_tv585 = pme3_tv585[-naid,]
    sst1_tv585 = sst1_tv585[-naid,]
    sst3_tv585 = sst3_tv585[-naid,]
    
    pme1_pj585 = pme1_ssp585[175:576,]
    pme3_pj585 = pme3_ssp585[175:576,]
    sst1_pj585 = sst1_ssp585[175:576,]
    sst3_pj585 = sst3_ssp585[175:576,]
    
    pme1_pj585 = trend_fun(pme1_pj585)
    pme3_pj585 = trend_fun(pme3_pj585)
    sst1_pj585 = trend_fun(sst1_pj585)
    sst3_pj585 = trend_fun(sst3_pj585)
    
    naidfut = which(is.na(pme1_pj585[,1]))
    naidfut <<- naidfut
    
    pme1_pj585 = pme1_pj585[-naidfut,]
    pme3_pj585 = pme3_pj585[-naidfut,]
    sst1_pj585 = sst1_pj585[-naidfut,]
    sst3_pj585 = sst3_pj585[-naidfut,]
    
    pme1_tv585 <<- pme1_tv585
    pme3_tv585 <<- pme3_tv585
    sst1_tv585 <<- sst1_tv585
    sst3_tv585 <<- sst3_tv585
    
    pme1_pj585 <<- pme1_pj585
    pme3_pj585 <<- pme3_pj585
    sst1_pj585 <<- sst1_pj585
    sst3_pj585 <<- sst3_pj585
    ###############
    j = 1:ncol(sst1_tv585)
    j <<- j
    ssp585_fun <-function(j){
      df = data.frame(
        tws = tws_sw,
        pme1 = pme1_tv585[,j],
        pme3 = pme3_tv585[,j],
        sst1 = sst1_tv585[,j],
        sst3 = sst3_tv585[,j]
      )
      
      df_project = data.frame(
        pme1 = pme1_pj585[,j],
        pme3 = pme3_pj585[,j],
        sst1 = sst1_pj585[,j],
        sst3 = sst3_pj585[,j]
      )
      source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws_cmip6.R')
      ret_box = random_forest_model_tws_cmip6(df,
                                              df_project)
    }
    
    ret585 <- lapply(j,ssp585_fun)
    
    ret_li = list(ret245,ret585)
    return(ret_li)
  }
  
  library(doParallel)
  cl = makeCluster(10)
  clusterExport(cl,c('twsdf','i','sst1_ssp245',
                     'sst3_ssp245','sst1_ssp585',
                     'sst3_ssp585',
                     'pme1_ssp245',
                     'pme1_ssp585',
                     'pme3_ssp245',
                     'pme3_ssp585'))
  ret_df = parLapply(cl,i,sub_train_fun)
  stopCluster(cl)
  
  source('/home/share/R_project/xinjiang_vapor/cor_filter_fun.R')
  cor_mat = cor_filter_fun(ret_df)
  cor_mat <<- cor_mat
  
  i = 1:length(ret_df)
  SW = paste0('SW',1:10)
  SW <<- SW
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  ssp245_proj_extract_fun_mean <-function(i){
    tmpli = ret_df[[i]][[1]]
    j = 1:length(tmpli)
    tmpli <<- tmpli
    sub_fun_ex <-function(j){
      tmpproj = tmpli[[j]][[3]][,2]
      return(tmpproj)
    }
    tmpproj = lapply(j,sub_fun_ex)
    tmpproj = do.call(cbind,tmpproj)
    colnames(tmpproj) = modelnames
    
    tmpcor = as.numeric(cor_mat[,i])
    idless = which(tmpcor >= 0.5)
    tmpproj = tmpproj[,idless]
    
    tmpproj = apply(tmpproj,1,mean,na.rm = T)
    
    date = tmpli[[1]][[3]][,1]
    
    tmpproj = data.frame(date = date,tmpproj)
    tmpproj = reshape2::melt(tmpproj,'date')
    tmpproj$type = SW[i]
    return(tmpproj)
  }
  
  proj_df = lapply(i,ssp245_proj_extract_fun_mean)
  
  projdf = do.call(rbind,proj_df)
  
  i = 1:length(ret_df)
  ssp245_proj_extract_fun_max <-function(i){
    tmpli = ret_df[[i]][[1]]
    j = 1:length(tmpli)
    tmpli <<- tmpli
    sub_fun_ex <-function(j){
      tmpproj = tmpli[[j]][[3]][,2]
      return(tmpproj)
    }
    tmpproj = lapply(j,sub_fun_ex)
    tmpproj = do.call(cbind,tmpproj)
    colnames(tmpproj) = modelnames
    
    tmpcor = as.numeric(cor_mat[,i])
    idless = which(tmpcor >= 0.5)
    tmpproj = tmpproj[,idless]
    
    tmpproj = apply(tmpproj,1,max,na.rm = T)
    
    
    date = tmpli[[1]][[3]][,1]
    
    tmpproj = data.frame(date = date,tmpproj)
    tmpproj = reshape2::melt(tmpproj,'date')
    tmpproj$type = SW[i]
    return(tmpproj)
  }
  
  proj_df_max = lapply(i,ssp245_proj_extract_fun_max)
  
  projdf_max = do.call(rbind,proj_df_max)
  
  i = 1:length(ret_df)
  ssp245_proj_extract_fun_min <-function(i){
    tmpli = ret_df[[i]][[1]]
    j = 1:length(tmpli)
    tmpli <<- tmpli
    sub_fun_ex <-function(j){
      tmpproj = tmpli[[j]][[3]][,2]
      return(tmpproj)
    }
    tmpproj = lapply(j,sub_fun_ex)
    tmpproj = do.call(cbind,tmpproj)
    colnames(tmpproj) = modelnames
    
    tmpcor = as.numeric(cor_mat[,i])
    idless = which(tmpcor >= 0.5)
    tmpproj = tmpproj[,idless]
    
    tmpproj = apply(tmpproj,1,min,na.rm = T)
    
    date = tmpli[[1]][[3]][,1]
    
    tmpproj = data.frame(date = date,tmpproj)
    tmpproj = reshape2::melt(tmpproj,'date')
    tmpproj$type = SW[i]
    return(tmpproj)
  }
  
  proj_df_min = lapply(i,ssp245_proj_extract_fun_min)
  
  projdf_min = do.call(rbind,proj_df_min)
  
  
  projdfmaxmin = data.frame(projdf_max,
                            min = projdf_min$value)
  
  date_proj = unique(projdf_min$date)
  pme1_fut_245 = apply(pme1_ssp245[175:576,],
                       1,mean)
  pme1_fut_245 = trend_fun(pme1_fut_245)
  naid = which(is.na(pme1_fut_245))
  pme1_fut_245 = pme1_fut_245[-naid]
  pme1_fut_245 = data.frame(
    date = date_proj,
    pme1_fut_245
  )
  pme1_fut_245 = reshape2::melt(pme1_fut_245,
                                'date')
  
  pme3_fut_245 = apply(pme3_ssp245[175:576,],
                       1,mean)
  pme3_fut_245 = trend_fun(pme3_fut_245)
  naid = which(is.na(pme3_fut_245))
  pme3_fut_245 = pme3_fut_245[-naid]
  pme3_fut_245 = data.frame(
    date = date_proj,
    pme3_fut_245
  )
  pme3_fut_245 = reshape2::melt(pme3_fut_245,
                                'date')
  pme13_fut_245 = rbind(pme1_fut_245,
                        pme3_fut_245)
  
  
  library(ggsci)
  pal1 = pal_npg(alpha = 1)(8)
  projsw1 = projdf[which(projdf$type == "SW1"),]
  p = ggplot()+
    geom_ribbon(data = projdfmaxmin,
                aes(x = date,ymin = min,
                    ymax = value),
                fill = pal1[2],
                alpha = 0.5)+
    geom_line(data = projdf,aes(x = date,y = value,
                                #color =variable,
                                group = variable),
              size = 0.5,color = pal1[8])+
    #geom_line(data = pme13_fut_245,
    #          aes(x = date,y = value,
    #              color = variable),
    #          size = 1)+
    
    scale_color_manual(values = pal1)+
    facet_wrap(~type,nrow = 2)+
    theme_bw()
  
  p
}
project_tws_along_with_linear_model<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/import_validate_sst.R')
  source('/home/share/R_project/xinjiang_vapor/import_validate_pme_cmip6.R')
  sst = import_validate_sst()
  pme = import_validate_pme_cmip6()
  
  sst_trend = sst
  pme_trend = pme
  #sst_trend = lapply(sst,trend_fun)
  #pme_trend = lapply(pme,trend_fun)
  
  sst1_ssp245 = sst_trend[[1]]
  sst1_ssp585 = sst_trend[[2]]
  sst3_ssp245 = sst_trend[[3]]
  sst3_ssp585 = sst_trend[[4]]
  
  pme1_ssp245 = pme_trend[[1]]
  pme1_ssp585 = pme_trend[[2]]
  pme3_ssp245 = pme_trend[[3]]
  pme3_ssp585 = pme_trend[[4]]
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(sst1_ssp245) = modelnames
  colnames(sst1_ssp585) = modelnames
  colnames(sst3_ssp245) = modelnames
  colnames(sst3_ssp585) = modelnames
  
  colnames(pme1_ssp245) = modelnames
  colnames(pme1_ssp585) = modelnames
  colnames(pme3_ssp245) = modelnames
  colnames(pme3_ssp585) = modelnames
  
  # import tws
  input_tws = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws = fread(input_tws)
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  tws = as.data.frame(tws)
  tws = tws[,-1]
  twsdf = tws[,id_box]
  
  twsdf <<- twsdf
  colnames(twsdf) = paste0('SW',1:10)
  
  sst1_ssp245 <<- sst1_ssp245
  sst1_ssp585 <<- sst1_ssp585
  sst3_ssp245 <<- sst3_ssp245
  sst3_ssp585 <<- sst3_ssp585
  
  pme1_sst245 <<- pme1_ssp245
  pme3_ssp245 <<- pme3_ssp245
  pme1_ssp585 <<- pme1_ssp585
  pme3_ssp585 <<- pme3_ssp585
  
  i = 1:ncol(twsdf)
  i <<- i
  sub_train_fun <-function(i){
    
    tws_sw = twsdf[,i]
    naid = which(is.na(tws_sw))
    tws_sw = tws_sw[-naid]
    tws_sw <<- tws_sw
    
    trend_fun <- function(x){
      
      sub_fun <-function(x){
        x = ts(x,start = c(2003,1),
               frequency = 12)
        x = decompose(x)$trend
        
        xt = as.numeric(x)
        stand_fun <-function(y){
          y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
        }
        xy  = stand_fun(xt)
        return(xy)
      }
      xm = apply(x,2,sub_fun)
      return(xm)
    }
    # sp245 data
    ###############
    pme1_tv245 = pme1_ssp245[1:174,]
    pme3_tv245 = pme3_ssp245[1:174,]
    sst1_tv245 = sst1_ssp245[1:174,]
    sst3_tv245 = sst3_ssp245[1:174,]
    
    pme1_tv245 = trend_fun(pme1_tv245)
    pme3_tv245 = trend_fun(pme3_tv245)
    sst1_tv245 = trend_fun(sst1_tv245)
    sst3_tv245 = trend_fun(sst3_tv245)
    
    pme1_tv245 = pme1_tv245[-naid,]
    pme3_tv245 = pme3_tv245[-naid,]
    sst1_tv245 = sst1_tv245[-naid,]
    sst3_tv245 = sst3_tv245[-naid,]
    
    pme1_pj245 = pme1_ssp245[175:576,]
    pme3_pj245 = pme3_ssp245[175:576,]
    sst1_pj245 = sst1_ssp245[175:576,]
    sst3_pj245 = sst3_ssp245[175:576,]
    
    pme1_pj245 = trend_fun(pme1_pj245)
    pme3_pj245 = trend_fun(pme3_pj245)
    sst1_pj245 = trend_fun(sst1_pj245)
    sst3_pj245 = trend_fun(sst3_pj245)
    
    naid = which(is.na(pme1_pj245[,1]))
    naidfut <<- naid
    
    pme1_pj245 = pme1_pj245[-naid,]
    pme3_pj245 = pme3_pj245[-naid,]
    sst1_pj245 = sst1_pj245[-naid,]
    sst3_pj245 = sst3_pj245[-naid,]
    
    pme1_tv245 <<- pme1_tv245
    pme3_tv245 <<- pme3_tv245
    sst1_tv245 <<- sst1_tv245
    sst3_tv245 <<- sst3_tv245
    
    pme1_pj245 <<- pme1_pj245
    pme3_pj245 <<- pme3_pj245
    sst1_pj245 <<- sst1_pj245
    sst3_pj245 <<- sst3_pj245
    ###############
    j = 1:ncol(sst1_tv245)
    j <<- j
    ssp245_fun <-function(j){
      df = data.frame(
        tws = tws_sw,
        pme1 = pme1_tv245[,j],
        pme3 = pme3_tv245[,j],
        sst1 = sst1_tv245[,j],
        sst3 = sst3_tv245[,j]
      )
      
      df_project = data.frame(
        pme1 = pme1_pj245[,j],
        pme3 = pme3_pj245[,j],
        sst1 = sst1_pj245[,j],
        sst3 = sst3_pj245[,j]
      )
      #source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws_cmip6.R')
      source('/home/share/R_project/xinjiang_vapor/linear_project_model.R')
      ret = linear_project_model(df,df_project)
    }
    
    ret245 <- lapply(j,ssp245_fun)
    
    #### 
    # 585
    # ssp585 data
    ###############
    pme1_tv585 = pme1_ssp585[1:174,]
    pme3_tv585 = pme3_ssp585[1:174,]
    sst1_tv585 = sst1_ssp585[1:174,]
    sst3_tv585 = sst3_ssp585[1:174,]
    
    pme1_tv585 = trend_fun(pme1_tv585)
    pme3_tv585 = trend_fun(pme3_tv585)
    sst1_tv585 = trend_fun(sst1_tv585)
    sst3_tv585 = trend_fun(sst3_tv585)
    
    naid = which(is.na(pme1_tv585[,1]))
    pme1_tv585 = pme1_tv585[-naid,]
    pme3_tv585 = pme3_tv585[-naid,]
    sst1_tv585 = sst1_tv585[-naid,]
    sst3_tv585 = sst3_tv585[-naid,]
    
    pme1_pj585 = pme1_ssp585[175:576,]
    pme3_pj585 = pme3_ssp585[175:576,]
    sst1_pj585 = sst1_ssp585[175:576,]
    sst3_pj585 = sst3_ssp585[175:576,]
    
    pme1_pj585 = trend_fun(pme1_pj585)
    pme3_pj585 = trend_fun(pme3_pj585)
    sst1_pj585 = trend_fun(sst1_pj585)
    sst3_pj585 = trend_fun(sst3_pj585)
    
    naidfut = which(is.na(pme1_pj585[,1]))
    naidfut <<- naidfut
    
    pme1_pj585 = pme1_pj585[-naidfut,]
    pme3_pj585 = pme3_pj585[-naidfut,]
    sst1_pj585 = sst1_pj585[-naidfut,]
    sst3_pj585 = sst3_pj585[-naidfut,]
    
    pme1_tv585 <<- pme1_tv585
    pme3_tv585 <<- pme3_tv585
    sst1_tv585 <<- sst1_tv585
    sst3_tv585 <<- sst3_tv585
    
    pme1_pj585 <<- pme1_pj585
    pme3_pj585 <<- pme3_pj585
    sst1_pj585 <<- sst1_pj585
    sst3_pj585 <<- sst3_pj585
    ###############
    j = 1:ncol(sst1_tv585)
    j <<- j
    ssp585_fun <-function(j){
      df = data.frame(
        tws = tws_sw,
        pme1 = pme1_tv585[,j],
        pme3 = pme3_tv585[,j],
        sst1 = sst1_tv585[,j],
        sst3 = sst3_tv585[,j]
      )
      
      df_project = data.frame(
        pme1 = pme1_pj585[,j],
        pme3 = pme3_pj585[,j],
        sst1 = sst1_pj585[,j],
        sst3 = sst3_pj585[,j]
      )
      source('/home/share/R_project/xinjiang_vapor/linear_project_model.R')
      ret_box = linear_project_model(df,df_project)
    }
    
    ret585 <- lapply(j,ssp585_fun)
    
    ret_li = list(ret245,ret585)
    return(ret_li)
  }
  
  library(doParallel)
  cl = makeCluster(10)
  clusterExport(cl,c('twsdf','i','sst1_ssp245',
                     'sst3_ssp245','sst1_ssp585',
                     'sst3_ssp585',
                     'pme1_ssp245',
                     'pme1_ssp585',
                     'pme3_ssp245',
                     'pme3_ssp585'))
  ret_df = parLapply(cl,i,sub_train_fun)
  stopCluster(cl)
  
  
  i = 1:length(ret_df)
  SW = paste0('SW',1:10)
  SW <<- SW
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  ssp245_proj_extract_fun_mean <-function(i){
    tmpli = ret_df[[i]][[1]]
    j = 1:length(tmpli)
    tmpli <<- tmpli
    sub_fun_ex <-function(j){
      tmpproj = tmpli[[j]][[3]][,2]
      return(tmpproj)
    }
    tmpproj = lapply(j,sub_fun_ex)
    tmpproj = do.call(cbind,tmpproj)
    colnames(tmpproj) = modelnames
    tmpproj = apply(tmpproj,1,mean,na.rm = T)
    
    date = tmpli[[1]][[3]][,1]
    
    tmpproj = data.frame(date = date,tmpproj)
    tmpproj = reshape2::melt(tmpproj,'date')
    tmpproj$type = SW[i]
    return(tmpproj)
  }
  
  proj_df = lapply(i,ssp245_proj_extract_fun_mean)
  
  projdf = do.call(rbind,proj_df)
  
  i = 1:length(ret_df)
  ssp245_proj_extract_fun_max <-function(i){
    tmpli = ret_df[[i]][[1]]
    j = 1:length(tmpli)
    tmpli <<- tmpli
    sub_fun_ex <-function(j){
      tmpproj = tmpli[[j]][[3]][,2]
      return(tmpproj)
    }
    tmpproj = lapply(j,sub_fun_ex)
    tmpproj = do.call(cbind,tmpproj)
    colnames(tmpproj) = modelnames
    tmpproj = apply(tmpproj,1,max,na.rm = T)
    
    date = tmpli[[1]][[3]][,1]
    
    tmpproj = data.frame(date = date,tmpproj)
    tmpproj = reshape2::melt(tmpproj,'date')
    tmpproj$type = SW[i]
    return(tmpproj)
  }
  
  proj_df_max = lapply(i,ssp245_proj_extract_fun_max)
  
  projdf_max = do.call(rbind,proj_df_max)
  
  i = 1:length(ret_df)
  ssp245_proj_extract_fun_min <-function(i){
    tmpli = ret_df[[i]][[1]]
    j = 1:length(tmpli)
    tmpli <<- tmpli
    sub_fun_ex <-function(j){
      tmpproj = tmpli[[j]][[3]][,2]
      return(tmpproj)
    }
    tmpproj = lapply(j,sub_fun_ex)
    tmpproj = do.call(cbind,tmpproj)
    colnames(tmpproj) = modelnames
    tmpproj = apply(tmpproj,1,min,na.rm = T)
    
    date = tmpli[[1]][[3]][,1]
    
    tmpproj = data.frame(date = date,tmpproj)
    tmpproj = reshape2::melt(tmpproj,'date')
    tmpproj$type = SW[i]
    return(tmpproj)
  }
  
  proj_df_min = lapply(i,ssp245_proj_extract_fun_min)
  
  projdf_min = do.call(rbind,proj_df_min)
  
  
  projdfmaxmin = data.frame(projdf_max,
                            min = projdf_min$value)
  
  date_proj = unique(projdf_min$date)
  pme1_fut_245 = apply(pme1_ssp245[175:576,],
                       1,mean)
  pme1_fut_245 = trend_fun(pme1_fut_245)
  naid = which(is.na(pme1_fut_245))
  pme1_fut_245 = pme1_fut_245[-naid]
  pme1_fut_245 = data.frame(
    date = date_proj,
    pme1_fut_245
  )
  pme1_fut_245 = reshape2::melt(pme1_fut_245,
                                'date')
  
  pme3_fut_245 = apply(pme3_ssp245[175:576,],
                       1,mean)
  pme3_fut_245 = trend_fun(pme3_fut_245)
  naid = which(is.na(pme3_fut_245))
  pme3_fut_245 = pme3_fut_245[-naid]
  pme3_fut_245 = data.frame(
    date = date_proj,
    pme3_fut_245
  )
  pme3_fut_245 = reshape2::melt(pme3_fut_245,
                                'date')
  pme13_fut_245 = rbind(pme1_fut_245,
                        pme3_fut_245)
  
  
  library(ggsci)
  pal1 = pal_npg(alpha = 1)(8)
  projsw1 = projdf[which(projdf$type == "SW1"),]
  p = ggplot()+
    geom_ribbon(data = projdfmaxmin,
                aes(x = date,ymin = min,
                    ymax = value),
                fill = pal1[2],
                alpha = 0.5)+
    geom_line(data = projdf,aes(x = date,y = value,
                                #color =variable,
                                group = variable),
              size = 0.5,color = pal1[8])+
    geom_line(data = pme13_fut_245,
              aes(x = date,y = value,
                  color = variable),
              size = 1)+
    
    scale_color_manual(values = pal1)+
    facet_wrap(~type,nrow = 2)+
    theme_bw()
  
  p 
}
project_tws_raster_based_on_era5_cmip6 <- function(
  
){
  library(data.table)
  library(raster)
  library(doParallel)
  
  # era5 model
  dir.create('analysis_output/fig4/pme')
  library(data.table)
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  source('/home/share/R_project/xinjiang_vapor/source_id_identify.R')
  
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:180,]
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:180,]
  
  sst_mean1 = 'era5_sst_mean/ato/region1/era5_sst_mean.csv'
  sst_mean3 = 'era5_sst_mean/ato/region3/era5_sst_mean.csv'
  
  sst1= as.data.frame(fread(sst_mean1))
  sst3 = as.data.frame(fread(sst_mean3))
  
  era5_sst = cbind(sst1,sst3)
  era5_sst = era5_sst[1:174,]
  era5_sst = as.matrix(era5_sst)
  
  era5_pme = pe_in_source[,c(5,7)] - pet_sum[,c(5,7)]
  era5_pme = as.matrix(era5_pme)
  era5_pme = era5_pme[1:174,]
  
  source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
  era5_sst = trend_fun(era5_sst)
  era5_pme = trend_fun(era5_pme)
  
  naid = which(is.na(era5_sst[,1]))
  era5_sst = era5_sst[-naid,]
  era5_pme = era5_pme[-naid,]
  
  era5_pme <<- era5_pme
  era5_sst <<- era5_sst
  
  # import pme1 pme3 cmip6
  input_sst = list.files('analysis_output/cmip6_by_model/sst',
                         full.names = T)
  input_pme = list.files('analysis_output/cmip6_by_model/pme',
                         full.names = T)
  
  
  
  sst = lapply(lapply(input_sst,fread),as.data.frame)
  pme = lapply(lapply(input_pme,fread),as.data.frame)
  
  sst_trend = sst
  pme_trend = pme
  #sst_trend = lapply(sst,trend_fun)
  #pme_trend = lapply(pme,trend_fun)
  
  sst1_ssp245 = sst_trend[[1]]
  sst1_ssp585 = sst_trend[[2]]
  sst3_ssp245 = sst_trend[[3]]
  sst3_ssp585 = sst_trend[[4]]
  
  pme1_ssp245 = pme_trend[[1]]
  pme1_ssp585 = pme_trend[[2]]
  pme3_ssp245 = pme_trend[[3]]
  pme3_ssp585 = pme_trend[[4]]
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(sst1_ssp245) = modelnames
  colnames(sst1_ssp585) = modelnames
  colnames(sst3_ssp245) = modelnames
  colnames(sst3_ssp585) = modelnames
  
  colnames(pme1_ssp245) = modelnames
  colnames(pme1_ssp585) = modelnames
  colnames(pme3_ssp245) = modelnames
  colnames(pme3_ssp585) = modelnames
  
  sst1_ssp245 <<- sst1_ssp245
  sst1_ssp585 <<- sst1_ssp585
  sst3_ssp245 <<- sst3_ssp245
  sst3_ssp585 <<- sst3_ssp585
  
  pme1_sst245 <<- pme1_ssp245
  pme3_ssp245 <<- pme3_ssp245
  pme1_ssp585 <<- pme1_ssp585
  pme3_ssp585 <<- pme3_ssp585
  
  
  # import tws raster
  input_tws_subs = '/media/sdb5/Data/grace_tws_masked'
  input_tws_subs = list.files(input_tws_subs,
                              full.names = T)
  
  cal_ssp_tws <- function(i){
    tmptws = stack(input_tws_subs[i])
    
    twsdf = as.data.frame(tmptws,xy = T)
    naid = which(is.na(twsdf[,3]))
    
    twsdf = twsdf[-naid,]
    loc = twsdf[,1:2]
    twsdf = twsdf[,-c(1,2)]
    
    twsdf = t(twsdf)
    
    j = 1:ncol(twsdf)
    
    train_model <- function(j){
      source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
      tmptwsv = trend_fun(twsdf[,j])
      naid = which(is.na(tmptwsv))
      tmptwsv = tmptwsv[-naid]
      df = data.frame(
        tws = tmptwsv,
        pme3 = era5_pme[,2]
      )
      source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws_era5_cmip6.R')
      system.time(ret <- random_forest_model_tws_era5_cmip6(df))
      ############
      pme3_pj245 = as.matrix(pme3_ssp245[175:576,])
      source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
      pme3_pj245 = trend_fun(pme3_pj245)
      naid = which(is.na(pme3_pj245[,1]))
      pme3_pj245 = pme3_pj245[-naid,]
      
      pme3_pj585 = as.matrix(pme3_ssp585[175:576,])
      source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
      pme3_pj585 = trend_fun(pme3_pj585)
      naid = which(is.na(pme3_pj585[,1]))
      pme3_pj585 = pme3_pj585[-naid,]
      ############
      model_best = ret[[3]]
      tws245b = 1
      tws585b = 1
      for(k in 1:ncol(pme3_pj245)){
        df245 = data.frame(pme3 = pme3_pj245[,k])
        df585 = data.frame(pme3 = pme3_pj585[,k])
        tws245 = predict(model_best,df245)
        tws585 = predict(model_best,df585)
        tws245b = cbind(tws245b,tws245)
        tws585b = cbind(tws585b,tws585)
      }
      tws245b = tws245b[,-1]
      tws585b = tws585b[,-1]
      
      tws245mean = apply(tws245b,1,mean)
      tws585mean = apply(tws585b,1,mean)
      
      source('/home/share/R_project/xinjiang_vapor/mmkTrend.R')
      mmk1 = mmkTrend(tws245mean)
      mmk2 = mmkTrend(tws585mean)
      
      ret = data.frame(
        SST245 = mmk1$Zc,
        SST585 = mmk2$Zc
      )      
      return(ret)
    }

    library(doParallel)
    cl = makeCluster(100)
    clusterExport(cl,c('j','twsdf','era5_pme',
                       'pme3_ssp245','pme3_ssp585'
                       ))
    system.time(retmmk <- parLapply(cl,j,
                                    train_model))
    stopCluster(cl)
    gc()
    
    retmmk = do.call('rbind',retmmk)
    retmmk = data.frame(
      long = loc[,1],
      lat = loc[,2],
      retmmk
    )
    return(retmmk)
  }
  
  i = 1:10
  
  ret_tws = lapply(i,cal_ssp_tws)
  ret_tws = do.call('rbind',ret_tws)
  
  fwrite(ret_tws,'tws_mmk_subs.csv')
  
}
project_tws_raster_based_validate_cmip6<-function(
  
){
  # import tws raster
  input_tws_subs = '/media/sdb5/Data/grace_tws_masked'
  input_tws_subs = list.files(input_tws_subs,
                              full.names = T)
  # import validate cmip6 pme13
  # import validate cmip6 sst13
  source('/home/share/R_project/xinjiang_vapor/import_validate_sst.R')
  source('/home/share/R_project/xinjiang_vapor/import_validate_pme_cmip6.R')
  sst = import_validate_sst()
  pme = import_validate_pme_cmip6()
  
  sst1_ssp245 = sst[[1]]
  sst1_ssp585 = sst[[2]]
  sst3_ssp245 = sst[[3]]
  sst3_ssp585 = sst[[4]]
  
  pme1_ssp245 = pme[[1]]
  pme1_ssp585 = pme[[2]]
  pme3_ssp245 = pme[[3]]
  pme3_ssp585 = pme[[4]]
  
  modelnames = c('ACCESS-ESM1-5',
                 'BCC-CSM2-MR',
                 'CanESM5',
                 'GFDL-ESM4',
                 'IPSL-CM6A-LR',
                 'MIROC6',
                 'MRI-ESM2-0',
                 'NorESM2-LM')
  
  modelnames <<- modelnames
  
  colnames(sst1_ssp245) = modelnames
  colnames(sst1_ssp585) = modelnames
  colnames(sst3_ssp245) = modelnames
  colnames(sst3_ssp585) = modelnames
  
  colnames(pme1_ssp245) = modelnames
  colnames(pme1_ssp585) = modelnames
  colnames(pme3_ssp245) = modelnames
  colnames(pme3_ssp585) = modelnames
  
  sst1_ssp245 <<- sst1_ssp245
  sst1_ssp585 <<- sst1_ssp585
  sst3_ssp245 <<- sst3_ssp245
  sst3_ssp585 <<- sst3_ssp585
  
  pme1_sst245 <<- pme1_ssp245
  pme3_ssp245 <<- pme3_ssp245
  pme1_ssp585 <<- pme1_ssp585
  pme3_ssp585 <<- pme3_ssp585
  
  # training by sub windows
  sub_train_fun_raster245 <- function(i){
    library(raster)
    library(ncdf4)
    # tws raster to df trend
    tws_raster = stack(input_tws_subs[i])
    twsdf = as.data.frame(tws_raster,xy  = T)
    loctws = twsdf[,1:2]
    twsdf = twsdf[,-c(1,2)]
    
    natws = which(is.na(twsdf[,1]))
    twsdf = twsdf[-natws,]
    loctws = loctws[-natws,]
    
    twsdf = t(twsdf)
    trend_fun_hist <- function(x){
      
      sub_fun <-function(x){
        x = ts(x,start = c(2003,1),
               frequency = 12)
        x = decompose(x)$trend
        
        xt = as.numeric(x)
        stand_fun <-function(y){
          y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
        }
        xy  = stand_fun(xt)
        return(xy)
      }
      xm = apply(x,2,sub_fun)
      return(xm)
    }
    trend_fun_fut <- function(x){
      
      sub_fun <-function(x){
        x = ts(x,start = c(2017,7),
               frequency = 12)
        x = decompose(x)$trend
        
        xt = as.numeric(x)
        stand_fun <-function(y){
          y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
        }
        xy  = stand_fun(xt)
        return(xy)
      }
      xm = apply(x,2,sub_fun)
      return(xm)
    }
    
    twsdf_trend = trend_fun_hist(twsdf)
    naidtws = which(is.na(twsdf_trend[,1]))
    twsdf_trend = twsdf_trend[-naidtws,]
    
    # pme and sst data
    ###############
    pme1_tv245 = pme1_ssp245[1:174,]
    pme3_tv245 = pme3_ssp245[1:174,]
    sst1_tv245 = sst1_ssp245[1:174,]
    sst3_tv245 = sst3_ssp245[1:174,]
    
    pme1_tv245 = trend_fun_hist(pme1_tv245)
    pme3_tv245 = trend_fun_hist(pme3_tv245)
    sst1_tv245 = trend_fun_hist(sst1_tv245)
    sst3_tv245 = trend_fun_hist(sst3_tv245)
    
    pme1_tv245 = pme1_tv245[-naid,]
    pme3_tv245 = pme3_tv245[-naid,]
    sst1_tv245 = sst1_tv245[-naid,]
    sst3_tv245 = sst3_tv245[-naid,]
    
    pme1_pj245 = pme1_ssp245[175:576,]
    pme3_pj245 = pme3_ssp245[175:576,]
    sst1_pj245 = sst1_ssp245[175:576,]
    sst3_pj245 = sst3_ssp245[175:576,]
    
    pme1_pj245 = trend_fun_fut(pme1_pj245)
    pme3_pj245 = trend_fun_fut(pme3_pj245)
    sst1_pj245 = trend_fun_fut(sst1_pj245)
    sst3_pj245 = trend_fun_fut(sst3_pj245)
    
    pme1_tv245 <<- pme1_tv245
    pme3_tv245 <<- pme3_tv245
    sst1_tv245 <<- sst1_tv245
    sst3_tv245 <<- sst3_tv245
    
    pme1_pj245 <<- pme1_pj245
    pme3_pj245 <<- pme3_pj245
    sst1_pj245 <<- sst1_pj245
    sst3_pj245 <<- sst3_pj245
    
    ###############
    
    j = 1:ncol(twsdf_trend)
    j <<- j
    
    k = 1:ncol(sst1_tv245)
    k <<- k
    
    sub_project_fun <- function(j){
      tmptws = twsdf_trend[,j]
      
      sub_projct245 <- function(k){
        df = data.frame(
          tws = tmptws,
          pme1 = pme1_tv245[,j],
          pme3 = pme3_tv245[,j],
          sst1 = sst1_tv245[,j],
          sst3 = sst3_tv245[,j]
        )
        df_project = data.frame(
          pme1 = pme1_pj245[,j],
          pme3 = pme3_pj245[,j],
          sst1 = sst1_pj245[,j],
          sst3 = sst3_pj245[,j]
        )
        source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws_cmip6_raster.R')
        ret_box = random_forest_model_tws_cmip6_raster(df,df_project)
        
        return(ret_box)
      }
      ret245 <- lapply(k,sub_projct245)
      ret245 <- do.call('cbind',ret245)
      ret245_mean = apply(ret245,1,mean,na.rm = T)
      ret245_mean = as.numeric(ret245_mean)
      
      source('/home/share/R_project/xinjiang_vapor/mmkTrend.R')
      ret245trend = mmkTrend(ret245_mean)$Zc
      
      return(ret245trend)
      
    }
    
    library(doParallel)
    cl = makeCluster(90)
    clusterExport(cl,c('j','k','twsdf_trend',
                       'pme1_tv245',
                       'pme3_tv245',
                       'sst1_tv245',
                       'sst3_tv245',
                       'pme1_pj245',
                       'pme3_pj245','sst1_pj245',
                       'sst3_pj245'))
    ret_tws245_li = parLapply(cl,j,sub_project_fun)
    stopCluster(cl)
    
    ret_tws245_mmk = do.call('cbind',ret_tws245_li)
    
    ret_mmk = data.frame(
      long = loctws[,1],
      lat = loctws[,2],
      mmk = ret_tws245_mmk
    )
    
    return(ret_mmk)
    
  }
  sub_train_fun_raster585 <- function(i){
    library(raster)
    library(ncdf4)
    # tws raster to df trend
    tws_raster = stack(input_tws_subs[i])
    twsdf = as.data.frame(tws_raster,xy  = T)
    loctws = twsdf[,1:2]
    twsdf = twsdf[,-c(1,2)]
    
    natws = which(is.na(twsdf[,1]))
    twsdf = twsdf[-natws,]
    loctws = loctws[-natws,]
    
    twsdf = t(twsdf)
    trend_fun_hist <- function(x){
      
      sub_fun <-function(x){
        x = ts(x,start = c(2003,1),
               frequency = 12)
        x = decompose(x)$trend
        
        xt = as.numeric(x)
        stand_fun <-function(y){
          y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
        }
        xy  = stand_fun(xt)
        return(xy)
      }
      xm = apply(x,2,sub_fun)
      return(xm)
    }
    trend_fun_fut <- function(x){
      
      sub_fun <-function(x){
        x = ts(x,start = c(2017,7),
               frequency = 12)
        x = decompose(x)$trend
        
        xt = as.numeric(x)
        stand_fun <-function(y){
          y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
        }
        xy  = stand_fun(xt)
        return(xy)
      }
      xm = apply(x,2,sub_fun)
      return(xm)
    }
    
    twsdf_trend = trend_fun_hist(twsdf)
    naidtws = which(is.na(twsdf_trend[,1]))
    twsdf_trend = twsdf_trend[-naidtws,]
    
    # pme and sst data
    ###############
    pme1_tv585 = pme1_ssp585[1:174,]
    pme3_tv585 = pme3_ssp585[1:174,]
    sst1_tv585 = sst1_ssp585[1:174,]
    sst3_tv585 = sst3_ssp585[1:174,]
    
    pme1_tv585 = trend_fun_hist(pme1_tv585)
    pme3_tv585 = trend_fun_hist(pme3_tv585)
    sst1_tv585 = trend_fun_hist(sst1_tv585)
    sst3_tv585 = trend_fun_hist(sst3_tv585)
    
    pme1_tv585 = pme1_tv585[-naid,]
    pme3_tv585 = pme3_tv585[-naid,]
    sst1_tv585 = sst1_tv585[-naid,]
    sst3_tv585 = sst3_tv585[-naid,]
    
    pme1_pj585 = pme1_ssp585[175:576,]
    pme3_pj585 = pme3_ssp585[175:576,]
    sst1_pj585 = sst1_ssp585[175:576,]
    sst3_pj585 = sst3_ssp585[175:576,]
    
    pme1_pj585 = trend_fun_fut(pme1_pj585)
    pme3_pj585 = trend_fun_fut(pme3_pj585)
    sst1_pj585 = trend_fun_fut(sst1_pj585)
    sst3_pj585 = trend_fun_fut(sst3_pj585)
    
    pme1_tv585 <<- pme1_tv585
    pme3_tv585 <<- pme3_tv585
    sst1_tv585 <<- sst1_tv585
    sst3_tv585 <<- sst3_tv585
    
    pme1_pj585 <<- pme1_pj585
    pme3_pj585 <<- pme3_pj585
    sst1_pj585 <<- sst1_pj585
    sst3_pj585 <<- sst3_pj585
    
    ###############
    
    j = 1:ncol(twsdf_trend)
    j <<- j
    
    k = 1:ncol(sst1_tv585)
    k <<- k
    
    sub_project_fun <- function(j){
      tmptws = twsdf_trend[,j]
      
      sub_projct585 <- function(k){
        df = data.frame(
          tws = tmptws,
          pme1 = pme1_tv585[,j],
          pme3 = pme3_tv585[,j],
          sst1 = sst1_tv585[,j],
          sst3 = sst3_tv585[,j]
        )
        df_project = data.frame(
          pme1 = pme1_pj585[,j],
          pme3 = pme3_pj585[,j],
          sst1 = sst1_pj585[,j],
          sst3 = sst3_pj585[,j]
        )
        source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws_cmip6_raster.R')
        ret_box = random_forest_model_tws_cmip6_raster(df,df_project)
        
        return(ret_box)
      }
      ret585 <- lapply(k,sub_projct585)
      ret585 <- do.call('cbind',ret585)
      ret585_mean = apply(ret585,1,mean,na.rm = T)
      ret585_mean = as.numeric(ret585_mean)
      
      source('/home/share/R_project/xinjiang_vapor/mmkTrend.R')
      ret585trend = mmkTrend(ret585_mean)$Zc
      
      return(ret585trend)
      
    }
    
    library(doParallel)
    cl = makeCluster(90)
    clusterExport(cl,c('j','k','twsdf_trend',
                       'pme1_tv585',
                       'pme3_tv585',
                       'sst1_tv585',
                       'sst3_tv585',
                       'pme1_pj585',
                       'pme3_pj585','sst1_pj585',
                       'sst3_pj585'))
    ret_tws585_li = parLapply(cl,j,sub_project_fun)
    stopCluster(cl)
    
    ret_tws585_mmk = do.call('cbind',ret_tws585_li)
    
    ret_mmk = data.frame(
      long = loctws[,1],
      lat = loctws[,2],
      mmk = ret_tws585_mmk
    )
    
    return(ret_mmk)
    
  }
  
  i = 1:10
  i <<- i
  
  retmmk245 = lapply(i,sub_train_fun_raster245)
  retmmk585 = lapply(i,sub_train_fun_raster585)
  # bind the raster 
  retmmk245 = do.call('rbind',retmmk245)
  retmmk585 = do.call('rbind',retmmk585)
  
  output = ''
  outputname = c('twsmmk_fut_245.csv',
                 'twsmmk_fut_585.csv')
  output = paste0(output,'/',outputname)
  fwrite(retmmk245,output[1])
  fwrite(retmmk585,output[2])
  
  
}
project_tws_to_csv <-function(
  ret_df
){
  dir.create('analysis_output/fig4/project_tws_subs')
  output_train = 'analysis_output/fig4/project_tws_subs/train'
  output_valid245 = 'analysis_output/fig4/project_tws_subs/valid245'
  output_valid585 = 'analysis_output/fig4/project_tws_subs/valid585'
  
  output_ssp245 = 'analysis_output/fig4/project_tws_subs/ssp245'
  output_ssp585 = 'analysis_output/fig4/project_tws_subs/ssp585'
  
  dir.create(output_train)
  dir.create(output_valid585)
  dir.create(output_valid245)
  dir.create(output_ssp245)
  dir.create(output_ssp585)
  
  files = paste0('SW',1:10,'.csv')
  output_train = paste0(output_train,'/',
                        files)
  output_valid245 = paste0(output_valid245,'/',
                        files)
  output_valid585 = paste0(output_valid585,'/',
                           files)
  output_ssp245 = paste0(output_ssp245,'/',
                         files)
  output_ssp585 = paste0(output_ssp585,'/',
                         files)
  model_names = c('ACCESS-ESM1-5',
                  'BCC-CSM2-MR',
                  'CanESM5',
                  'GFDL-ESM4',
                  'IPSL-CM6A-LR',
                  'MIROC6',
                  'MRI-ESM2-0',
                  'NorESM2-LM')
  # export train 245 ssp 245 proj
  for(i in 1:10){
    train_box = 1
    obs_box = 1
    for(j in 1:8){
      tmptrain = ret_df[[i]][[1]][[j]][[1]]
      train_box = cbind(train_box,tmptrain[,2])
      obs_box = cbind(obs_box,tmptrain[,1])
    }
    train_box = train_box[,-1]
    colnames(train_box) = model_names
    obs_box = obs_box[,-1]
    obs_box = obs_box[,1]
    train_tws = data.frame(
      tws = obs_box,
      train_box
    )
    fwrite(train_box,output_train[i])
    print(paste0('output: ',output_train[i]))
    
    # export validate ssp 245  
    ssp245_box =1
    obs_box = 1
    for(j in 1:8){
      tmpssp245 = ret_df[[i]][[1]][[j]][[2]]
      ssp245_box = cbind(ssp245_box,tmpssp245[,2])
      obs_box = cbind(obs_box,tmpssp245[,1])
    }    
    ssp245_box = ssp245_box[,-1]
    colnames(ssp245_box)= model_names
    obs_box = obs_box[,-1]
    obs_box = obs_box[,1]
    
    valid_ssp245 = data.frame(
      tws = obs_box,
      ssp245_box
    )
    
    fwrite(valid_ssp245,output_valid245[i])
    print(paste0('output: ',output_valid245[i]))
    
    # export validate ssp 585  
    ssp585_box =1
    obs_box = 1
    for(j in 1:8){
      tmpssp585 = ret_df[[i]][[2]][[j]][[2]]
      ssp585_box = cbind(ssp585_box,tmpssp585[,2])
      obs_box = cbind(obs_box,tmpssp585[,1])
    }    
    ssp585_box = ssp585_box[,-1]
    colnames(ssp585_box)= model_names
    obs_box = obs_box[,-1]
    obs_box = obs_box[,1]
    
    valid_ssp585 = data.frame(
      tws = obs_box,
      ssp585_box
    )
    
    fwrite(valid_ssp585,output_valid585[i])
    print(paste0('output: ',output_valid585[i]))
    
    # export projection ssp 245  
    proj245_box =1
    date_box = 1
    for(j in 1:8){
      tmpproj245 = ret_df[[i]][[1]][[j]][[3]]
      proj245_box = cbind(proj245_box,tmpproj245[,2])
      date_box = cbind(date_box,tmpproj245[,1])
    }    
    proj245_box = proj245_box[,-1]
    colnames(proj245_box)= model_names
    date_box = date_box[,-1]
    date_box = date_box[,1]
    
    proj245 = data.frame(
      date = date_box,
      proj245_box
    )
    
    fwrite(proj245,output_ssp245[i])
    print(paste0('output: ',output_ssp245[i]))
    
    # export projection ssp 245  
    proj585_box =1
    date_box = 1
    for(j in 1:8){
      tmpproj585 = ret_df[[i]][[2]][[j]][[3]]
      proj585_box = cbind(proj585_box,tmpproj585[,2])
      date_box = cbind(date_box,tmpproj585[,1])
    }    
    proj585_box = proj585_box[,-1]
    colnames(proj585_box)= model_names
    date_box = date_box[,-1]
    date_box = date_box[,1]
    
    proj585 = data.frame(
      date = date_box,
      proj585_box
    )
    
    fwrite(proj585,output_ssp585[i])
    print(paste0('output: ',output_ssp585[i]))
    
    
  }
  
  
  
}
random_forest_model_pr_cmip6<-function(
  df,df_project
){
  # libr
  library(randomForest)
  
  set.seed(100)
  id_train = sample(nrow(df),0.7*nrow(df),replace = FALSE)
  #id_train = 1:round(0.7*nrow(df))
  train = df[id_train,]
  test = df[-id_train,]
  
  set.seed(432)
  model_ini = randomForest(pr ~ ., data = train,
                           importance = T,
                           ntree = 500,
                           mtry = 3
                           
  )
  
  # PREDICTING WITH INITIAL MODEL
  pred_train = as.numeric(predict(model_ini,train))
  pred_test =  as.numeric(predict(model_ini,test))
  
  library(caret)
  # tune mtry
  mtry_len = ncol(df)-1
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = 1:mtry_len)
  
  set.seed(432)
  rf_mtry = train(pr ~ .,
                  data = train,
                  method = 'rf',
                  tuneGrid = tuneGrid,
                  trControl = trControl,
                  importance = T
  )
  
  rf_mtry_res = rf_mtry$results[,1:2]
  
  id_mtry = which.min(rf_mtry_res$RMSE)
  
  rf_mtry_best = rf_mtry_res[id_mtry,1]
  
  
  # find number of trees
  
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = rf_mtry_best)
  
  mod_par_cart = 1
  for(ntree in seq(100,1000,100)){
    set.seed(432)
    rf_mtry = train(pr ~ .,
                    data = train,
                    method = 'rf',
                    ntree = ntree,
                    tuneGrid = tuneGrid,
                    trControl = trControl,
                    importance = T
    )
    
    rf_mod = rf_mtry$results[,c(1,2)]
    rf_mod = cbind(rf_mod,ntree)
    mod_par_cart = rbind(mod_par_cart,rf_mod)
  }
  mod_par_cart = mod_par_cart[-1,]
  
  id_best = which.min(mod_par_cart$RMSE)
  
  ntree_best = mod_par_cart[id_best,3]
  
  set.seed(432)
  
  model_best = randomForest(pr ~ ., data = train,
                            importance = T,
                            ntree = ntree_best,
                            mtry = rf_mtry_best
  )
  
  p_train_best = as.numeric(predict(model_best,train))
  p_test_best = as.numeric(predict(model_best,test))
  
  
  
  train_id = 1:(nrow(df)*0.7)
  train_in_order = df[train_id,]
  test_in_order = df[-train_id,]
  
  p_train_in_order = as.numeric(predict(model_best,
                                        train_in_order))
  
  p_test_in_order = as.numeric(predict(model_best,
                                       test_in_order))
  
  
  p_project = as.numeric(predict(model_best,
                                 df_project))
  date = seq(as.Date('2003-01-01'),as.Date('2050-12-01'),'1 month')
  date_proj = date[175:570]
  return(list(data.frame(train_in_order$pr,
                         p_train_in_order),
              data.frame(test_in_order$pr,
                         p_test_in_order),
              data.frame(date = date_proj,
                         pr_project = p_project)))
  
  return(list(data.frame(p_train_in_order),
              data.frame(p_test_in_order),
              data.frame(p_project)))
}










random_forest_model_snowm<-function(
  df 
){
  # libr
  library(randomForest)
  
  set.seed(100)
  id_train = sample(nrow(df),0.7*nrow(df),replace = FALSE)
  
  train = df[id_train,]
  test = df[-id_train,]
  
  set.seed(432)
  model_ini = randomForest(snowm ~ ., data = train,
                           importance = T,
                           ntree = 500,
                           mtry = 3
  )
  
  # PREDICTING WITH INITIAL MODEL
  pred_train = as.numeric(predict(model_ini,train))
  pred_test =  as.numeric(predict(model_ini,test))
  
  library(caret)
  # tune mtry
  mtry_len = ncol(df)-1
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = 1:mtry_len)
  
  set.seed(432)
  rf_mtry = train(snowm ~ .,
                  data = train,
                  method = 'rf',
                  tuneGrid = tuneGrid,
                  trControl = trControl,
                  importance = T)
  
  rf_mtry_res = rf_mtry$results[,1:2]
  
  id_mtry = which.min(rf_mtry_res$RMSE)
  
  rf_mtry_best = rf_mtry_res[id_mtry,1]
  
  
  # find number of trees
  
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = rf_mtry_best)
  
  mod_par_cart = 1
  for(ntree in seq(100,1000,100)){
    set.seed(432)
    rf_mtry = train(snowm ~ .,
                    data = train,
                    method = 'rf',
                    ntree = ntree,
                    tuneGrid = tuneGrid,
                    trControl = trControl,
                    importance = T)
    
    rf_mod = rf_mtry$results[,c(1,3)]
    rf_mod = cbind(rf_mod,ntree)
    mod_par_cart = rbind(mod_par_cart,rf_mod)
  }
  mod_par_cart = mod_par_cart[-1,]
  
  id_best = which.min(mod_par_cart$Rsquared)
  
  ntree_best = mod_par_cart[id_best,3]
  
  set.seed(432)
  
  model_best = randomForest(snowm ~ ., data = train,
                            importance = T,
                            ntree = ntree_best,
                            mtry = rf_mtry_best)
  
  p_train_best = as.numeric(predict(model_best,train))
  p_test_best = as.numeric(predict(model_best,test))
  
  
  
  train_id = 1:(nrow(df)*0.7)
  train_in_order = df[train_id,]
  test_in_order = df[-train_id,]
  
  p_train_in_order = as.numeric(predict(model_best,
                                        train_in_order))
  
  p_test_in_order = as.numeric(predict(model_best,
                                       test_in_order))
  
  
  return(cbind(test_in_order$snowm,
               p_test_in_order))
}










random_forest_model_sst_cmip6<-function(
  df,df_sstoject
){
  # libr
  library(randomForest)
  
  set.seed(100)
  id_train = sample(nrow(df),0.7*nrow(df),replace = FALSE)
  #id_train = 1:round(0.7*nrow(df))
  train = df[id_train,]
  test = df[-id_train,]
  
  set.seed(432)
  model_ini = randomForest(sst ~ ., data = train,
                           importance = T,
                           ntree = 500,
                           mtry = 3
                           
  )
  
  # predictING WITH INITIAL MODEL
  ssted_train = as.numeric(predict(model_ini,train))
  ssted_test =  as.numeric(predict(model_ini,test))
  
  library(caret)
  # tune mtry
  mtry_len = ncol(df)-1
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = 1:mtry_len)
  
  set.seed(432)
  rf_mtry = train(sst ~ .,
                  data = train,
                  method = 'rf',
                  tuneGrid = tuneGrid,
                  trControl = trControl,
                  importance = T
  )
  
  rf_mtry_res = rf_mtry$results[,1:2]
  
  id_mtry = which.min(rf_mtry_res$RMSE)
  
  rf_mtry_best = rf_mtry_res[id_mtry,1]
  
  
  # find number of trees
  
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = rf_mtry_best)
  
  mod_par_cart = 1
  for(ntree in seq(100,1000,100)){
    set.seed(432)
    rf_mtry = train(sst ~ .,
                    data = train,
                    method = 'rf',
                    ntree = ntree,
                    tuneGrid = tuneGrid,
                    trControl = trControl,
                    importance = T
    )
    
    rf_mod = rf_mtry$results[,c(1,2)]
    rf_mod = cbind(rf_mod,ntree)
    mod_par_cart = rbind(mod_par_cart,rf_mod)
  }
  mod_par_cart = mod_par_cart[-1,]
  
  id_best = which.min(mod_par_cart$RMSE)
  
  ntree_best = mod_par_cart[id_best,3]
  
  set.seed(432)
  
  model_best = randomForest(sst ~ ., data = train,
                            importance = T,
                            ntree = ntree_best,
                            mtry = rf_mtry_best
  )
  
  p_train_best = as.numeric(predict(model_best,train))
  p_test_best = as.numeric(predict(model_best,test))
  
  
  
  train_id = 1:(nrow(df)*0.7)
  train_in_order = df[train_id,]
  test_in_order = df[-train_id,]
  
  p_train_in_order = as.numeric(predict(model_best,
                                        train_in_order))
  
  p_test_in_order = as.numeric(predict(model_best,
                                       test_in_order))
  
  
  p_sstoject = as.numeric(predict(model_best,
                                 df_sstoject))
  date = seq(as.Date('2003-01-01'),as.Date('2050-12-01'),'1 month')
  date_sstoj = date[175:570]
  return(list(data.frame(train_in_order$sst,
                         p_train_in_order),
              data.frame(test_in_order$sst,
                         p_test_in_order),
              data.frame(date = date_sstoj,
                         sst_sstoject = p_sstoject)))
  
  return(list(data.frame(p_train_in_order),
              data.frame(p_test_in_order),
              data.frame(p_sstoject)))
}










random_forest_model_test<-function(
  df 
){
  # libr
  library(randomForest)
  
  set.seed(100)
  id_train = sample(nrow(df),0.7*nrow(df),replace = FALSE)
  
  train = df[id_train,]
  test = df[-id_train,]
  
  set.seed(432)
  model_ini = randomForest(gpcc_pr ~ ., data = train,
                           importance = T,
                           ntree = 500,
                           mtry = 3
                           )
  
  # PREDICTING WITH INITIAL MODEL
  pred_train = as.numeric(predict(model_ini,train))
  pred_test =  as.numeric(predict(model_ini,test))
  
  library(caret)
  # tune mtry
  mtry_len = ncol(df)-1
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = 1:mtry_len)
  
  set.seed(432)
  rf_mtry = train(gpcc_pr ~ .,
                  data = train,
                  method = 'rf',
                  tuneGrid = tuneGrid,
                  trControl = trControl,
                  importance = T)
  
  rf_mtry_res = rf_mtry$results[,1:2]
  
  id_mtry = which.min(rf_mtry_res$RMSE)
  
  rf_mtry_best = rf_mtry_res[id_mtry,1]
  
  
  # find number of trees
  
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = rf_mtry_best)
  
  mod_par_cart = 1
  for(ntree in seq(100,1000,100)){
    set.seed(432)
    rf_mtry = train(gpcc_pr ~ .,
                    data = train,
                    method = 'rf',
                    ntree = ntree,
                    tuneGrid = tuneGrid,
                    trControl = trControl,
                    importance = T)
    
    rf_mod = rf_mtry$results[,c(1,3)]
    rf_mod = cbind(rf_mod,ntree)
    mod_par_cart = rbind(mod_par_cart,rf_mod)
  }
  mod_par_cart = mod_par_cart[-1,]
  
  id_best = which.min(mod_par_cart$Rsquared)
  
  ntree_best = mod_par_cart[id_best,3]
  
  set.seed(432)
  
  model_best = randomForest(gpcc_pr ~ ., data = train,
                            importance = T,
                            ntree = ntree_best,
                            mtry = rf_mtry_best)
  
  p_train_best = as.numeric(predict(model_best,train))
  p_test_best = as.numeric(predict(model_best,test))
  
  
  
  train_id = 1:(nrow(df)*0.7)
  train_in_order = df[train_id,]
  test_in_order = df[-train_id,]
  
  p_train_in_order = as.numeric(predict(model_best,
                             train_in_order))
  
  p_test_in_order = as.numeric(predict(model_best,
                                       test_in_order))
  
  
  return(cbind(test_in_order$gpcc_pr,
               p_test_in_order))
}










random_forest_model_tws_cmip6_raster<-function(
  df,df_project
){
  # libr
  library(randomForest)
  
  set.seed(100)
  id_train = sample(nrow(df),0.7*nrow(df),replace = FALSE)
  #id_train = 1:round(0.7*nrow(df))
  train = df[id_train,]
  test = df[-id_train,]
  
  set.seed(432)
  model_ini = randomForest(tws ~ ., data = train,
                           importance = T,
                           ntree = 500,
                           mtry = 3
                           
  )
  
  # PREDICTING WITH INITIAL MODEL
  pred_train = as.numeric(predict(model_ini,train))
  pred_test =  as.numeric(predict(model_ini,test))
  
  library(caret)
  # tune mtry
  mtry_len = ncol(df)-1
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = 1:mtry_len)
  
  set.seed(432)
  rf_mtry = train(tws ~ .,
                  data = train,
                  method = 'rf',
                  tuneGrid = tuneGrid,
                  trControl = trControl,
                  importance = T
  )
  
  rf_mtry_res = rf_mtry$results[,1:2]
  
  id_mtry = which.min(rf_mtry_res$RMSE)
  
  rf_mtry_best = rf_mtry_res[id_mtry,1]
  
  
  # find number of trees
  
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = rf_mtry_best)
  
  mod_par_cart = 1
  for(ntree in seq(100,1000,100)){
    set.seed(432)
    rf_mtry = train(tws ~ .,
                    data = train,
                    method = 'rf',
                    ntree = ntree,
                    tuneGrid = tuneGrid,
                    trControl = trControl,
                    importance = T
    )
    
    rf_mod = rf_mtry$results[,c(1,2)]
    rf_mod = cbind(rf_mod,ntree)
    mod_par_cart = rbind(mod_par_cart,rf_mod)
  }
  mod_par_cart = mod_par_cart[-1,]
  
  id_best = which.min(mod_par_cart$RMSE)
  
  ntree_best = mod_par_cart[id_best,3]
  
  set.seed(432)
  
  model_best = randomForest(tws ~ ., data = train,
                            importance = T,
                            ntree = ntree_best,
                            mtry = rf_mtry_best
  )
  
  p_train_best = as.numeric(predict(model_best,train))
  p_test_best = as.numeric(predict(model_best,test))
  
  
  tws_project = as.numeric(predict(model_best,
                                 df_project))
  
  
  return(tws_project)
  
}










random_forest_model_tws_cmip6<-function(
  df,df_project
){
  # libr
  library(randomForest)
  
  set.seed(100)
  id_train = sample(nrow(df),0.7*nrow(df),replace = FALSE)
  #id_train = 1:round(0.7*nrow(df))
  train = df[id_train,]
  test = df[-id_train,]
  
  set.seed(432)
  model_ini = randomForest(tws ~ ., data = train,
                           importance = T,
                           ntree = 500,
                           mtry = 3
                           
  )
  
  # PREDICTING WITH INITIAL MODEL
  pred_train = as.numeric(predict(model_ini,train))
  pred_test =  as.numeric(predict(model_ini,test))
  
  library(caret)
  # tune mtry
  mtry_len = ncol(df)-1
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = 1:mtry_len)
  
  set.seed(432)
  rf_mtry = train(tws ~ .,
                  data = train,
                  method = 'rf',
                  tuneGrid = tuneGrid,
                  trControl = trControl,
                  importance = T
  )
  
  rf_mtry_res = rf_mtry$results[,1:2]
  
  id_mtry = which.min(rf_mtry_res$RMSE)
  
  rf_mtry_best = rf_mtry_res[id_mtry,1]
  
  
  # find number of trees
  
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = rf_mtry_best)
  
  mod_par_cart = 1
  for(ntree in seq(100,1000,100)){
    set.seed(432)
    rf_mtry = train(tws ~ .,
                    data = train,
                    method = 'rf',
                    ntree = ntree,
                    tuneGrid = tuneGrid,
                    trControl = trControl,
                    importance = T
    )
    
    rf_mod = rf_mtry$results[,c(1,2)]
    rf_mod = cbind(rf_mod,ntree)
    mod_par_cart = rbind(mod_par_cart,rf_mod)
  }
  mod_par_cart = mod_par_cart[-1,]
  
  id_best = which.min(mod_par_cart$RMSE)
  
  ntree_best = mod_par_cart[id_best,3]
  
  set.seed(432)
  
  model_best = randomForest(tws ~ ., data = train,
                            importance = T,
                            ntree = ntree_best,
                            mtry = rf_mtry_best
  )
  
  p_train_best = as.numeric(predict(model_best,train))
  p_test_best = as.numeric(predict(model_best,test))
  
  
  
  train_id = 1:(nrow(df)*0.7)
  train_in_order = df[train_id,]
  test_in_order = df[-train_id,]
  
  p_train_in_order = as.numeric(predict(model_best,
                                        train_in_order))
  
  p_test_in_order = as.numeric(predict(model_best,
                                       test_in_order))
  
  
  p_project = as.numeric(predict(model_best,
                                 df_project))
  date = seq(as.Date('2003-01-01'),as.Date('2050-12-01'),'1 month')
  
  date_proj = date[175:576]
  a = ts(175:576,start = c(2017,7),
         frequency = 12)
  a = decompose(a)$trend
  naidfut = which(is.na(a))
  
  date_proj = date_proj[-naidfut]
  
  
  return(list(data.frame(train_in_order$tws,
                    p_train_in_order),
              data.frame(test_in_order$tws,
                    p_test_in_order),
              data.frame(date = date_proj,
                         tws_project = p_project)))
  
  return(list(data.frame(p_train_in_order),
              data.frame(p_test_in_order),
              data.frame(p_project)))
}










random_forest_model_tws_era5_cmip6<-function(
  df
){
  # libr
  library(randomForest)
  
  set.seed(100)
  id_train = sample(nrow(df),0.7*nrow(df),replace = FALSE)
  #id_train = 1:round(0.7*nrow(df))
  train = df[id_train,]
  test = df[-id_train,]
  
  set.seed(432)
  model_ini = randomForest(tws ~ ., data = train,
                           importance = T,
                           ntree = 500,
                           mtry = 3
                           
  )
  
  # PREDICTING WITH INITIAL MODEL
  pred_train = as.numeric(predict(model_ini,train))
  pred_test =  as.numeric(predict(model_ini,test))
  
  library(caret)
  # tune mtry
  mtry_len = ncol(df)-1
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = 1:mtry_len)
  
  set.seed(432)
  rf_mtry = train(tws ~ .,
                  data = train,
                  method = 'rf',
                  tuneGrid = tuneGrid,
                  trControl = trControl,
                  importance = T
  )
  
  rf_mtry_res = rf_mtry$results[,1:2]
  
  id_mtry = which.min(rf_mtry_res$RMSE)
  
  rf_mtry_best = rf_mtry_res[id_mtry,1]
  
  
  # find number of trees
  
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = rf_mtry_best)
  
  mod_par_cart = 1
  for(ntree in seq(100,1000,100)){
    set.seed(432)
    rf_mtry = train(tws ~ .,
                    data = train,
                    method = 'rf',
                    ntree = ntree,
                    tuneGrid = tuneGrid,
                    trControl = trControl,
                    importance = T
    )
    
    rf_mod = rf_mtry$results[,c(1,2)]
    rf_mod = cbind(rf_mod,ntree)
    mod_par_cart = rbind(mod_par_cart,rf_mod)
  }
  mod_par_cart = mod_par_cart[-1,]
  
  id_best = which.min(mod_par_cart$RMSE)
  
  ntree_best = mod_par_cart[id_best,3]
  
  set.seed(432)
  
  model_best = randomForest(tws ~ ., data = train,
                            importance = T,
                            ntree = ntree_best,
                            mtry = rf_mtry_best
  )
  
  p_train_best = as.numeric(predict(model_best,train))
  p_test_best = as.numeric(predict(model_best,test))
  
  
  
  train_id = 1:(nrow(df)*0.7)
  train_in_order = df[train_id,]
  test_in_order = df[-train_id,]
  
  p_train_in_order = as.numeric(predict(model_best,
                                        train_in_order))
  
  p_test_in_order = as.numeric(predict(model_best,
                                       test_in_order))
  
  
  return(list(data.frame(train_in_order$tws,
                         p_train_in_order),
              data.frame(test_in_order$tws,
                         p_test_in_order),
              model_best))
  
  return(list(data.frame(p_train_in_order),
              data.frame(p_test_in_order),
              data.frame(p_project)))
}










random_forest_model_tws<-function(
  df,df_project
){
  # libr
  library(randomForest)
  
  set.seed(100)
  id_train = sample(nrow(df),0.7*nrow(df),replace = FALSE)
  #id_train = 1:round(0.7*nrow(df))
  train = df[id_train,]
  test = df[-id_train,]
  
  set.seed(432)
  model_ini = randomForest(tws ~ ., data = train,
                           importance = T,
                           ntree = 500,
                           mtry = 3
                           
  )
  
  # PREDICTING WITH INITIAL MODEL
  pred_train = as.numeric(predict(model_ini,train))
  pred_test =  as.numeric(predict(model_ini,test))
  
  library(caret)
  # tune mtry
  mtry_len = ncol(df)-1
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = 1:mtry_len)
  
  set.seed(432)
  rf_mtry = train(tws ~ .,
                  data = train,
                  method = 'rf',
                  tuneGrid = tuneGrid,
                  trControl = trControl,
                  importance = T
                  )
  
  rf_mtry_res = rf_mtry$results[,1:2]
  
  id_mtry = which.min(rf_mtry_res$RMSE)
  
  rf_mtry_best = rf_mtry_res[id_mtry,1]
  
  
  # find number of trees
  
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = rf_mtry_best)
  
  mod_par_cart = 1
  for(ntree in seq(100,1000,100)){
    set.seed(432)
    rf_mtry = train(tws ~ .,
                    data = train,
                    method = 'rf',
                    ntree = ntree,
                    tuneGrid = tuneGrid,
                    trControl = trControl,
                    importance = T
                    )
    
    rf_mod = rf_mtry$results[,c(1,2)]
    rf_mod = cbind(rf_mod,ntree)
    mod_par_cart = rbind(mod_par_cart,rf_mod)
  }
  mod_par_cart = mod_par_cart[-1,]
  
  id_best = which.min(mod_par_cart$RMSE)
  
  ntree_best = mod_par_cart[id_best,3]
  
  set.seed(432)
  
  model_best = randomForest(tws ~ ., data = train,
                            importance = T,
                            ntree = ntree_best,
                            mtry = rf_mtry_best
                            )
  
  p_train_best = as.numeric(predict(model_best,train))
  p_test_best = as.numeric(predict(model_best,test))
  
  
  
  train_id = 1:(nrow(df)*0.7)
  train_in_order = df[train_id,]
  test_in_order = df[-train_id,]
  
  p_train_in_order = as.numeric(predict(model_best,
                                        train_in_order))
  
  p_test_in_order = as.numeric(predict(model_best,
                                       test_in_order))
  
  
  p_project = as.numeric(predict(model_best,
                                 df_project))
  return(list(cbind(train_in_order$tws,
               p_train_in_order),
              cbind(test_in_order$tws,
                    p_test_in_order)))
  
  return(list(data.frame(p_train_in_order),
              data.frame(p_test_in_order),
              data.frame(p_project)))
}










re_order_cmip6_ep_sum<-function(
  mode
){
  #reorder cmip6 ep sum by model
  model_name = c('ACCESS-ESM1-5','BCC-CSM2-MR',
                 'CanESM5','GFDL-ESM4','IPSL-CM6A-LR',
                 'MIROC6','MRI-ESM2-0','NorESM2-LM')
  
  # input ep of cmip6
  input = 'cmip6_ep_sum'
  source_name = c('as','ato','eu')
  
  input1 = paste0(input,'/',source_name)
  input2 = paste0(input1,'/',mode)
  input3 = rep(input2,each = 4)
  region = paste0('region',1:4)
  
  input3 = paste0(input3,'/',rep(region,3))
  
  list_fun <-function(x){
    x = list.files(x,full.names = T)
  }
  input3 = lapply(input3,list_fun) 
  input3 = do.call(c,input3)
  
  print(input3)
  
  cmip6 = lapply(input3,fread)
  cmip6 = lapply(cmip6,as.data.frame)
  
  cmip6 = do.call(cbind,cmip6)
  
  model1_id = seq(1,ncol(cmip6),8)
  model2_id = seq(2,ncol(cmip6),8)
  model3_id = seq(3,ncol(cmip6),8)
  model4_id = seq(4,ncol(cmip6),8)
  model5_id = seq(5,ncol(cmip6),8)
  model6_id = seq(6,ncol(cmip6),8)
  model7_id = seq(7,ncol(cmip6),8)
  model8_id = seq(8,ncol(cmip6),8)
  
  model1 = cmip6[,model1_id]
  model2 = cmip6[,model2_id]
  model3 = cmip6[,model3_id]
  model4 = cmip6[,model4_id]
  model5 = cmip6[,model5_id]
  model6 = cmip6[,model6_id]
  model7 = cmip6[,model7_id]
  model8 = cmip6[,model8_id]
  
  
  colnames = paste0(rep(c('as','ato','eu'),each = 4),1:4)
  
  if(mode == 'hist_ssp585'){
    colnames = colnames[1:11]
  }
  
  colnames(model1) = colnames
  colnames(model2) = colnames
  colnames(model3) = colnames
  colnames(model4) = colnames
  colnames(model5) = colnames
  colnames(model6) = colnames
  colnames(model7) = colnames
  colnames(model8) = colnames
  
  # output 
  #######
  output = 'cmip6_ep_sum_by_model'
  dir.create(output)
  output = paste0(output,'/',mode)
  lapply(output,dir.create)
  
  output2 = rep(output,each = length(model_name))
  output2 = paste0(output2,'/',model_name)
  lapply(output2,dir.create)
 
  output2 = paste0(output2,'/ep_sum.csv')
  
  models = list(model1,model2,
                model3,model4,
                model5,model6,model7,model8)
  
  output2 <<- output2
  models <<- models
  output_fun<-function(i){
    fwrite(models[[i]],output2[i])
  }
  i = 1:8
  lapply(i,output_fun)
}






re_preprocess_cmip6_ssp585<-function(
  
){
  attrs = c('E','Pr','T')
  source('/home/share/R_project/xinjiang_vapor/filter_cmip6_data_to_date.R')
  filter_cmip6_data_to_date('E')
  filter_cmip6_data_to_date('Pr')
  filter_cmip6_data_to_date('T')
  print('Pass filter')

  source('/home/share/R_project/xinjiang_vapor/combine_cmip6_data_his_ssp.R')
  combine_cmip6_data_his_ssp('E')
  combine_cmip6_data_his_ssp('Pr')
  combine_cmip6_data_his_ssp('T')
  
  print('Pass combine')
  
  source('/home/share/R_project/xinjiang_vapor/adjust_extent_cmip6_hist_ssp585.R')
  adjust_extent_cmip6_hist_ssp585()
  print('pass adjust')
  
  #mask and crop 
  source('/home/share/R_project/xinjiang_vapor/mask_crop_cmip6_ssp585.R')
  mode =c('ato','as','eu')
  #source('/home/share/R_project/xinjiang_vapor/mask_crop_cmip6.R')
  system.time(mask_crop_cmip6_ssp585(mode[1]))
  system.time(mask_crop_cmip6_ssp585(mode[2]))
  system.time(mask_crop_cmip6_ssp585(mode[3]))
  
  print('pass mask')
  
  # cal ep 
  source('/home/share/R_project/xinjiang_vapor/cal_sum_ep_ssp585.R')
  cal_sum_ep_hist_ssp585(mode[1])
  cal_sum_ep_hist_ssp585(mode[2])
  cal_sum_ep_hist_ssp585(mode[3])
  
  # reorder
  source('/home/share/R_project/xinjiang_vapor/re_order_cmip6_ep_sum.R')
  mode = c('hist_ssp585')
  re_order_cmip6_ep_sum(mode)
  print('pass regroup files')
  
  # cal temperature based ssp585
  models = c('ACCESS-ESM1-5','BCC-CSM2-MR',
             'CanESM5','GFDL-ESM4','IPSL-CM6A-LR',
             'MIROC6','MRI-ESM2-0','NorESM2-LM')
  pattern2 = rep('hist_ssp585',8)
  mapply(cal_temp_in_each_region_based_cmip6,models,pattern2)
  print('pass temper')
  
  
}
released_total_var<-function(
  
){
  input = list.files('/media/sdb1/xinjiang_output_file/',full.names = T)
  input = paste0(input,'/output/total_released.csv')
  
  rtb = 1
  for(i in 1:length(input)){
    tmp = read.csv(input[i],header = T)
    rtb = rbind(rtb,tmp)
  }
  rtb = rtb[-1,]
  rtb = rtb[,-1]
  
  write.csv(rtb,'analysis_output/total_released_03_17.csv')
  
}
search_which_cl_tr <- function(x)
{
  xs = x[1]
  xe = x[length(x)]
  
  xsl <<- which(xfull == xs)[1]
  xel = which(xfull == xe)
  xel = xel[length(xel)]
  
  xes <<- xfull[xsl:xel]
  select_first_loc<-function(id){
    tmpmark = which(xes == id)
    return(tmpmark)
  }
  
  ret_id = lapply(x,select_first_loc)
  
  
  mean_long_cal<-function(id){
    id = id+xsl -1
    longtmp = df_full_for_cl[id,1]
    
    if(length(longtmp)<38){
      lentmp = length(longtmp)
      lack = 38 - lentmp
      longtmp = c(rep(NA,lack),longtmp)
    }else if(length(longtmp)>38){
      len = length(longtmp)/2
      longtmp = longtmp[1:len]
    }
    return(longtmp)
  }
  
  mean_lat_cal<-function(id){
    id = id+xsl -1
    lattmp = df_full_for_cl[id,2]
    if(length(lattmp)<38){
      lentmp = length(lattmp)
      lack = 38 - lentmp
      lattmp = c(rep(NA,lack),lattmp)
    }else if(length(lattmp)>38){
      len = length(lattmp)/2
      lattmp = lattmp[1:len]
    }
    return(lattmp)
  }
  
  mean_hei_cal<-function(id){
    id = id+xsl -1
    heitmp = df_full_for_cl[id,3]
    if(length(heitmp)<38){
      lentmp = length(heitmp)
      lack = 38 - lentmp
      heitmp = c(rep(NA,lack),heitmp)
    }else if(length(heitmp)>38){
      len = length(heitmp)/2
      heitmp = heitmp[1:len]
    }
    return(heitmp)
  }
  
  mean_fun<-function(x){
    x = mean(x,na.rm = T)
    return(x)
  }
  longb = lapply(ret_id,mean_long_cal)

  
  longb = do.call('rbind',longb)
  #print('pass here')
  latb = lapply(ret_id,mean_lat_cal)
  latb = do.call('rbind',latb)
  #print('pass here2')
  heib = lapply(ret_id,mean_hei_cal)
  heib = do.call('rbind',heib)
  #print('pass here3')
  #return(list(longb,latb,heib))
  
  longb = apply(longb,2,mean_fun)
  latb = apply(latb,2,mean_fun)
  heib = apply(heib,2,mean_fun)
  
  ret_box = data.frame(mean_long = longb,
                       mean_lat = latb,
                       mean_height = heib)
    
  
  
  
  #print(length(unique(ret_box)))
  return(ret_box)
  
}
search_which_full_acc1_cloud <- function(x)
{
  xs = x[1]
  xe = x[length(x)]
  
  #source('/home/share/R_project/xinjiang_vapor/mask_via_each_ocean_for_contri_cal_cloud.R')
  #source('/home/share/R_project/xinjiang_vapor/mask_points_solo_shp_cloud.R')
  
  dir.create('tmp')
  # in ocean
  input_tmp_masdf = 'tmp/tmp_mas_df.csv'
  input_tmp_masdfr = 'tmp/tmp_mas_df_r.csv'
  
  mas_df = fread(input_tmp_masdf)
  
  xfull1 = mas_df$type
  xsl1 = which(xfull1 == xs)[1]
  xel1 = which(xfull1 == xe)
  xel1 = xel1[length(xel1)]
  
  xes1 <<- xfull1[xsl1:xel1]
  df_sce1<<- mas_df[xsl1:xel1,] # in ocean
  rm(mas_df)
  
  print('pass here')
  cal_dep_for_each_p_in_source<-function(id){
    #print(id)
    library(raster)
    library(data.table)
    tmpmark = which(xes1 == id)
    df_sce1 = data.table(df_sce1[tmpmark,])
    # in source region
    #print(df_sce)
    #print(shp_ocean)
    df_source_var = sum(df_sce1$varep)
    
    ret = data.table(df_sce1[1,1:3],df_sce1[1,5])
    ret$varep_insource = df_source_var
    #ret_first_row$var_contr = df_var_contr
    #ret_first_row$names = names
    return(ret)
  }
  
  ret_in_source = lapply(x,cal_dep_for_each_p_in_source)
  ret_in_source = do.call('rbind',ret_in_source)
  
  fwrite(ret_in_source,'tmp/ret_insource.csv')
  rm(ret_in_source)
  
  
  mas_df_route = fread(input_tmp_masdfr)
  
  xfull1 = mas_df_route$type
  xsl1 = which(xfull1 == xs)[1]
  xel1 = which(xfull1 == xe)
  xel1 = xel1[length(xel1)]
  
  xes1 <<- xfull1[xsl1:xel1]
  df_sce1<<- mas_df_route[xsl1:xel1,] # in ocean
  
  ret_in_route = lapply(x,cal_dep_for_each_p_in_source)
  ret_in_route = do.call('rbind',ret_in_route)
  
  ret_in_source  = fread('tmp/ret_insource.csv')
  
  ret_contri = data.frame(long = ret_in_source[,1],
                          lat = ret_in_source[,2],
                          height = ret_in_source[,3],
                          type = ret_in_source[,4],
                          net_ep_ocean = ret_in_source[,5] - abs(ret_in_route[,5]))
  
  rm(ret_in_source)
  rm(ret_in_route)
  rm(df_sce1)
  #print(nrow(ret_in_route))
  #print(nrow(ret_in_source))
  return(ret_contri)
  
}
search_which_full_acc1 <- function(x)
{
  xs = x[1]
  xe = x[length(x)]
  
  source('/home/share/R_project/xinjiang_vapor/mask_via_each_ocean_for_contri_cal.R')
  source('/home/share/R_project/xinjiang_vapor/mask_points_solo_shp.R')
  
  # in ocean
  input_tmp_masdf = 'tmp/tmp_mas_df.csv'
  input_tmp_masdfr = 'tmp/tmp_mas_df_r.csv'
  
  mas_df = fread(input_tmp_masdf)
  
  xfull1 = mas_df$type
  xsl1 = which(xfull1 == xs)[1]
  xel1 = which(xfull1 == xe)
  xel1 = xel1[length(xel1)]
  
  xes1 <<- xfull1[xsl1:xel1]
  df_sce1<<- mas_df[xsl1:xel1,] # in ocean
  rm(mas_df)
  
  print('pass here')
  cal_dep_for_each_p_in_source<-function(id){
    #print(id)
    library(raster)
    library(data.table)
    tmpmark = which(xes1 == id)
    df_sce1 = data.table(df_sce1[tmpmark,])
    # in source region
    #print(df_sce)
    #print(shp_ocean)
    df_source_var = sum(df_sce1$varep)
    
    ret = data.table(df_sce1[1,1:3],df_sce1[1,5])
    ret$varep_insource = df_source_var
    #ret_first_row$var_contr = df_var_contr
    #ret_first_row$names = names
    return(ret)
  }
  
  ret_in_source = lapply(x,cal_dep_for_each_p_in_source)
  ret_in_source = do.call('rbind',ret_in_source)
  
  fwrite(ret_in_source,'tmp/ret_insource.csv')
  rm(ret_in_source)
  
  
  mas_df_route = fread(input_tmp_masdfr)
  
  xfull1 = mas_df_route$type
  xsl1 = which(xfull1 == xs)[1]
  xel1 = which(xfull1 == xe)
  xel1 = xel1[length(xel1)]
  
  xes1 <<- xfull1[xsl1:xel1]
  df_sce1<<- mas_df_route[xsl1:xel1,] # in ocean
  
  ret_in_route = lapply(x,cal_dep_for_each_p_in_source)
  ret_in_route = do.call('rbind',ret_in_route)
  
  ret_in_source  = fread('tmp/ret_insource.csv')
  
  ret_contri = data.frame(long = ret_in_source[,1],
                         lat = ret_in_source[,2],
                         height = ret_in_source[,3],
                         type = ret_in_source[,4],
                         net_ep_ocean = ret_in_source[,5] - abs(ret_in_route[,5]))
  
  rm(ret_in_source)
  rm(ret_in_route)
  rm(df_sce1)
  #print(nrow(ret_in_route))
  #print(nrow(ret_in_source))
  return(ret_contri)
  
}
search_which_full_as_bu_xinjiang_cloud <- function(x)
{
  xs = x[1]
  xe = x[length(x)]
  
  #source('/home/share/R_project/xinjiang_vapor/mask_via_each_ocean_for_contri_cal.R')
  #source('/home/share/R_project/xinjiang_vapor/mask_points_solo_shp.R')
  
  # in ocean
  input_tmp_masdf = 'tmp/tmp_mas_df.csv'
  mas_df = fread(input_tmp_masdf)
  
  xfull1 = mas_df$type
  xsl1 = which(xfull1 == xs)[1]
  xel1 = which(xfull1 == xe)
  xel1 = xel1[length(xel1)]
  
  xes1 <<- xfull1[xsl1:xel1]
  df_sce1<<- mas_df[xsl1:xel1,] # in ocean
  
  rm(mas_df)
  
  print('pass here')
  cal_dep_for_each_p_in_source<-function(id){
    #print(id)
    library(raster)
    library(data.table)
    tmpmark = which(xes1 == id)
    df_sce1 = data.table(df_sce1[tmpmark,])
    # in source region
    #print(df_sce)
    #print(shp_ocean)
    df_source_var = sum(df_sce1$varep)
    
    ret = data.table(df_sce1[1,1:3],df_sce1[1,5])
    ret$varep_insource = df_source_var
    #ret_first_row$var_contr = df_var_contr
    #ret_first_row$names = names
    return(ret)
  }
  
  ret_in_source = lapply(x,cal_dep_for_each_p_in_source)
  ret_in_source = do.call('rbind',ret_in_source)
  
  
  return(ret_in_source)
  
}
search_which_full_as_bu_xinjiang <- function(x)
{
  xs = x[1]
  xe = x[length(x)]
  
  source('/home/share/R_project/xinjiang_vapor/mask_via_each_ocean_for_contri_cal.R')
  source('/home/share/R_project/xinjiang_vapor/mask_points_solo_shp.R')
  
  # in ocean
  input_tmp_masdf = 'tmp/tmp_mas_df.csv'
  mas_df = fread(input_tmp_masdf)
  
  xfull1 = mas_df$type
  xsl1 = which(xfull1 == xs)[1]
  xel1 = which(xfull1 == xe)
  xel1 = xel1[length(xel1)]
  
  xes1 <<- xfull1[xsl1:xel1]
  df_sce1<<- mas_df[xsl1:xel1,] # in ocean
  
  rm(mas_df)
  
  print('pass here')
  cal_dep_for_each_p_in_source<-function(id){
    #print(id)
    library(raster)
    library(data.table)
    tmpmark = which(xes1 == id)
    df_sce1 = data.table(df_sce1[tmpmark,])
    # in source region
    #print(df_sce)
    #print(shp_ocean)
    df_source_var = sum(df_sce1$varep)
    
    ret = data.table(df_sce1[1,1:3],df_sce1[1,5])
    ret$varep_insource = df_source_var
    #ret_first_row$var_contr = df_var_contr
    #ret_first_row$names = names
    return(ret)
  }
  
  ret_in_source = lapply(x,cal_dep_for_each_p_in_source)
  ret_in_source = do.call('rbind',ret_in_source)
  
  
  return(ret_in_source)
  
}
search_which_full <- function(x)
{
  xs = x[1]
  xe = x[length(x)]
  
  xsl = which(xfull == xs)[1]
  xel = which(xfull == xe)
  xel = xel[length(xel)]
  
  xes <<- xfull[xsl:xel]
  df_sce<<- df_cal_dep[xsl:xel,]
  shp_ocean = shp_management(pattern = 'ocean',names=names)
  shp_xinjiang = shp_management(pattern = 'xinjiang')
  
  shp_ocean <<- shp_ocean
  shp_xinjiang <<- shp_xinjiang
  cal_dep_for_each_p<-function(id){
    #print(id)
    library(raster)
    tmpmark = which(xes == id)
    df_sce = df_sce[tmpmark,]
    source('/home/share/R_project/xinjiang_vapor/shp_management.R')
    source('/home/share/R_project/xinjiang_vapor/mask_points_solo_shp.R')
    # in source region
    #print(df_sce)
    #print(shp_ocean)
    in_source_id = mask_points_solo_shp(df_sce,shp_ocean)
    df_source = df_sce[in_source_id,]
    df_source_var = sum(df_source$varep)
    
    in_xinjiang_id = mask_points_solo_shp(df_sce,shp_xinjiang)
    #df_xinjiang = df_sce[in_xinjiang_id,]
    #df_xinjiang_var = sum(df_xinjiang$varep)
    
    nrow_df = 1:nrow(df_sce)
    in_route_id = nrow_df[-c(in_source_id,in_xinjiang_id)]
    
    if(length(in_route_id) ==0){
      df_route_var = 0
    }else{
      df_route = df_sce[in_route_id,]
      df_route_var = sum(df_route$varep)
    }
    
    df_var_contr = df_source_var - abs(df_route_var)
    
    #ret_first_row = df_sce[1,]
    #ret_first_row$var_contr = df_var_contr
    #ret_first_row$names = names
    return(df_var_contr)
  }
  #ret_box <- lapply(x,cal_dep_for_each_p)
  
  x<<-x
  cl = makeCluster(15)
  clusterExport(cl,c('df_sce','xes','names','x'))
  system.time(
    ret_box <- parLapply(cl,x,cal_dep_for_each_p)
  )
  stopCluster(cl)
  
  ret_box = do.call('rbind',ret_box)
  
  
  return(ret_box)
  
}
search_which_not_in <- function(x)
{
  xs = x[1]
  xe = x[length(x)]
  
  xsl = which(xfull == xs)[1]
  xel = which(xfull == xe)
  xel = xel[length(xel)]
  
  xes <<- xfull[xsl:xel]
  select_first_loc<-function(id){
    tmpmark = which(xes == id)
    return(tmpmark)
  }
  
  ret_box = lapply(x,select_first_loc)
  ret_box = do.call('c',ret_box)
  ret_box = ret_box+(xsl-1)
  #print(length(unique(ret_box)))
  return(ret_box)
  
}
search_which <- function(x)
{
  xs = x[1]
  xe = x[length(x)]
  
  xsl = which(xfull == xs)[1]
  xel = which(xfull == xe)
  xel = xel[length(xel)]
  
  xes <<- xfull[xsl:xel]
  select_first_loc<-function(id){
    tmpmark = which(xes == id)
    tmpmark = tmpmark[1]
    return(tmpmark)
  }
  
  ret_box = lapply(x,select_first_loc)
  ret_box = do.call('c',ret_box)
  ret_box = ret_box+(xsl-1)
  #print(length(unique(ret_box)))
  return(ret_box)
  
}
season_analysis<-function(
  
){
  
  df = fread('contr_in_source_variance.csv')
  df = as.data.frame(df)
  sou_names = df[,1]
  df = df[,-1]
  
  
  
  monthly_anal<-function(x){
    x = matrix(x,nrow = 12,byrow = F)
    mean_fun <- function(x){
      x = mean(x,na.rm = T)
    }
    xmean = apply(x,2,mean_fun)
    return(xmean)
  }
  
  df_mon_mean = apply(df,1,monthly_anal)
  df_mon_mean = as.data.frame(df_mon_mean)
  colnames(df_mon_mean) = sou_names
  
  sum_pos<-function(x){
    xs = sum(x[which(x>0)])
    return(xs)
  }
  
  df_sum_mon = apply(df_mon_mean,1,sum_pos)
  
  
  library(reshape2)
  month =  c('JAN','FEB','MAR','APR','MAY',
                            "JUN",'JUL','AUG','SEP',"OCT",'NOV',"DEC")
  
  df_mon_mean = as.data.frame(df_mon_mean)
  df_mon_mean$month = month
  df_mon_mean_m = reshape2::melt(df_mon_mean,'month')
  
  library(RColorBrewer) 
  mycolors = colorRampPalette(brewer.pal(11,'Spectral'))(7)
  mycolors = rev(mycolors)
  mycolors[1] = 'white'
  colnames(df_mon_mean_m) = c('Month','SourceType','value')
  
  df_mon_mean_m$Ratio = cut(df_mon_mean_m$value,breaks = c(-10,0,10,20,30,40,50,60))
  df_mon_mean_m$Month = factor(df_mon_mean_m$Month,levels = month)
  df_mon_mean_m$SourceType = factor(df_mon_mean_m$SourceType,levels = sou_names)
  
  
  p1 = ggplot()+
    geom_tile(data = df_mon_mean_m, aes(x = Month, y = SourceType, fill = Ratio),color = 'black')+
    #scale_fill_distiller(palette = 1)
    scale_fill_manual(values = mycolors)+
    theme_bw()+
    theme(
      panel.background = element_rect(fill = 'transparent'),
      axis.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      axis.title = element_text(color = 'black',size = 14,face = 'bold',hjust = 0.5),
      legend.position = 'bottom',
      legend.direction = 'horizontal',
      legend.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      legend.title = element_text(color = 'black',size = 14, face = 'bold',hjust = 0.5)
    )+
    guides(fill = guide_legend(nrow = 1))
  dir.create('plot')
  png('plot/contr_monthly_var.png',
      height = 20,
      width = 21,
      units = 'cm',
      res = 800)
  print(p1)
  dev.off()
  
  
  
}
shp_management_cloud <- function(
  pattern = 'ocean',
  names = 'ao'
){
  library(raster)
  if(pattern == 'ocean'){
    # ocean shp 
    ocean_path = '~/shp/ocean_shp'
    files = list.files(ocean_path,pattern = '*.shp$',full.names = T)
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    
    idr = which(oce_names == names)
    
    tmpshp = shapefile(files[idr])
    return(tmpshp)
    
  }else if(pattern == 'land'){
    # order: ao, 
    # land shp 
    land_path = '~/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == names)
    
    tmpshp = shapefile(files[idr])
    return(tmpshp)
  }else if(pattern =='as_bu_xinjiang'){
    path = '~/shp/asia_bu_xinjiang/'
    files = list.files(path,pattern = '*.shp$',full.names = T)
    
    tmpshp = shapefile(files)
  }else if(pattern == 'xinjiang'){
    shp_path = '/usr/local/flexpart_bk1/shp/Xinjiang_border.shp'
    tmpshp = shapefile(shp_path)
    return(tmpshp)
    
  }else if(pattern == 'combine_ocean'){
    xinjiang = shapefile('/usr/local/flexpart_bk1/shp/Xinjiang_border.shp')
    ocean_path = '~/shp/ocean_shp'
    files = list.files(ocean_path,pattern = '*.shp$',full.names = T)
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    
    idr = which(oce_names == names)
    
    tmpshp = shapefile(files[idr])
    tmpshp = do.call('bind',list(xinjiang,tmpshp))
    return(tmpshp)
  }else if(pattern == 'combine_land'){
    xinjiang = shapefile('/usr/local/flexpart_bk1/shp/Xinjiang_border.shp')
    
    land_path = '~/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == names)
    
    tmpshp = shapefile(files[idr])
    tmpshp = do.call('bind',list(xinjiang,tmpshp))
    return(tmpshp)
  }else if(pattern == 'world'){
    shp_path = '~/shp/world_continent.shp'
    tmpshp= shapefile(shp_path)
    return(tmpshp)
  }
  
  
  
  
  
  
  
}



shp_management <- function(
  pattern = 'ocean',
  names = 'ao'
){
  library(raster)
  if(pattern == 'ocean'){
    # ocean shp 
    ocean_path = '/media/sdb1/shp/ocean_shp'
    files = list.files(ocean_path,pattern = '*.shp$',full.names = T)
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    
    idr = which(oce_names == names)
    
    tmpshp = shapefile(files[idr])
    return(tmpshp)
    
  }else if(pattern == 'land'){
    # order: ao, 
    # land shp 
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == names)
    
    tmpshp = shapefile(files[idr])
    return(tmpshp)
  }else if(pattern =='as_bu_xinjiang'){
    path = '/media/sdb1/shp/asia_bu_xinjiang/'
    files = list.files(path,pattern = '*.shp$',full.names = T)
    
    tmpshp = shapefile(files)
  }else if(pattern == 'xinjiang'){
    shp_path = '/usr/local/flexpart_bk1/shp/Xinjiang_border.shp'
    tmpshp = shapefile(shp_path)
    return(tmpshp)
    
  }else if(pattern == 'combine_ocean'){
    xinjiang = shapefile('/usr/local/flexpart_bk1/shp/Xinjiang_border.shp')
    ocean_path = '/media/sdb1/shp/ocean_shp'
    files = list.files(ocean_path,pattern = '*.shp$',full.names = T)
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    
    idr = which(oce_names == names)
    
    tmpshp = shapefile(files[idr])
    tmpshp = do.call('bind',list(xinjiang,tmpshp))
    return(tmpshp)
  }else if(pattern == 'combine_land'){
    xinjiang = shapefile('/usr/local/flexpart_bk1/shp/Xinjiang_border.shp')
    
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == names)
    
    tmpshp = shapefile(files[idr])
    tmpshp = do.call('bind',list(xinjiang,tmpshp))
    return(tmpshp)
  }else if(pattern == 'china'){
    shp_path = '/media/sdb1/shp/China/China.shp'
    tmpshp= shapefile(shp_path)
    return(tmpshp)
  }else if(pattern == 'world'){
    shp_path = '/media/sdb1/shp/world_continent.shp'
    tmpshp= shapefile(shp_path)
    return(tmpshp)
  }else if(pattern == 'world_country'){
    shp_path = '/media/sdb1/shp/world_country/world.shp'
    tmpshp= shapefile(shp_path)
    return(tmpshp)
  }else if(pattern == 'world_include_ocean'){
    shp_path = '/media/sdb1/shp/world_oce.shp'
    tmpshp= shapefile(shp_path)
    return(tmpshp)
  }else if(pattern == 'shamo'){
    shp_path = '/media/sdb1/shp/north_land/shamo.shp'
    tmpshp = shapefile(shp_path)
    return(tmpshp)
  }else if(pattern == 'xinjiang_jishui_south'){
    shp_path = '/media/sdb1/shp/xinjiang_jishui/south_shp1.shp'
    tmpshp = shapefile(shp_path)
    return(tmpshp)
  }else if(pattern == 'xinjiang_jishui_north'){
    shp_path = '/media/sdb1/shp/xinjiang_jishui/north_shp1.shp'
    tmpshp = shapefile(shp_path)
    return(tmpshp)
  }else if(pattern == 'xinjiang_south'){
    shp_path = '/media/sdb1/shp/xinjiang_jishui/South_Xinjiang.shp'
    tmpshp = shapefile(shp_path)
    return(tmpshp)
  }else if(pattern == 'xinjiang_north'){
    shp_path = '/media/sdb1/shp/xinjiang_jishui/North_Xinjiang.shp'
    tmpshp = shapefile(shp_path)
    return(tmpshp)
  }
  
  
  
  
  
  
  
}


  
  
si_appendix_plot <-function(
  
){
  
  
  
  # spatiotemporal evolution of monthly mean TWS anomalies
  # and PMEATO anomalies
  source('/home/share/R_project/xinjiang_vapor/mmk_monthly_analysis.R')
  mmk_monthly_analysis()
}
slope_select<-function(
  index
){
  i = 2
  diff_back_box =1
  tp_box = 1
  diff_front_box = 1
  while(i <=(length(index)-12)){
    
    diff_front = index[i] - index[i-1]
    diff_back = index[i+1] - index[i]
    #diff_front2 = index[i] - index[i-2]
    #diff_back2 = index[i+2] - index[i]
    
    
    #print(diff_back)
    if(diff_front >0 & 
       diff_back >0){
      
    }else if(diff_front <0 &
             diff_back <0){
      
    }else{
      tp_box = c(tp_box,i)
      
    }
    #diff_front_box = c(diff_front_box,diff_front)
    #diff_back_box = c(diff_back_box,diff_back)
    i = i+1
  }
  #diff_back_box = diff_back_box[-1]
  #diff_front_box = diff_front_box[-1]
  
  
  tp_box = tp_box[-1]
  return(tp_box)  
}
source_fun<-function(
  
){
  files = list.files('/home/share/R_project/xinjiang_vapor',pattern = '.R$',full.names = T)
  sapply(files,source)
}
source_id_by_convey_amount <-function(
  pattern = 'north'
){
  i = 1:4
  order_fun<-function(i){
    files = c('north_moun','north_jishui','south_moun','south_jishui')
    
    con_amount_input = paste0('convey_amount_based_era5_eva_in_target/mean/',
                              files[i],'.csv')
    
    con_amount = fread(con_amount_input)
    con_amount = as.data.frame(con_amount)
    
    con_sum = apply(con_amount,2,sum)
    con_sum = as.numeric(con_sum)/180
    
    id_re = as.numeric(which(con_sum <1000))
    con_sum = con_sum[-id_re]
    order = order(con_sum,decreasing = T)
    
    return(order)
  }
  order = lapply(i,order_fun)
  
  order_north = c(order[[1]],order[[2]])
  order_south = c(order[[3]],order[[4]])
  
  order_north = as.numeric(unique(order_north))
  order_south = as.numeric(unique(order_south))
  if(pattern == 'north'){
    return(order_north)
  }else{
    return(order_south)
  }
  
}
source_id_identify <-function(
  pattern = 'north'
){
  i = 1:4
  id_re_fun<-function(i){
    files = c('north_moun','north_jishui','south_moun','south_jishui')
    
    con_amount_input = paste0('convey_amount_based_era5_eva_in_target/mean/',
                              files[i],'.csv')
    
    con_amount = fread(con_amount_input)
    con_amount = as.data.frame(con_amount)
    
    con_sum = apply(con_amount,2,sum)
    con_sum = as.numeric(con_sum)/180
    id_re = as.numeric(which(con_sum <1000))
    
    
    return(id_re)
  }
  id_re = lapply(i,id_re_fun)
  
  id_north = c(id_re[[1]],id_re[[2]])
  id_south = c(id_re[[3]],id_re[[4]])
  
  id_north = as.numeric(unique(id_north))
  id_south = as.numeric(unique(id_south))
  if(pattern == 'north'){
    return(id_north)
  }else{
    return(id_south)
  }
  
}
spatial_monthly_evo_tas_mmk <- function(
  
){
  library(ggplot2)
  library(data.table)
  
  input_tas_mean = 'analysis_output/fig3/landtas_mmk.csv'
  tas_mean = fread(input_tas_mean)
  tas_mean = as.data.frame(tas_mean)
  
  natas = which(is.na(tas_mean[,3]))
  tas_mean = tas_mean[-natas,]
  
  tas_mean = as.data.frame(tas_mean)
  colnames(tas_mean) = c('long','lat',
                         toupper(month.abb))
  
  tas_meamm  = reshape2::melt(tas_mean,c('long','lat'))
  idbigzero <- which(tas_meamm$value >=0)
  tas_meamm = tas_meamm[idbigzero,]
  
  idbig1000 <- which(tas_meamm$value>10)
  tas_meamm = tas_meamm[-idbig1000,]
  
  tas_meamm$cuts = cut(tas_meamm$value,
                       breaks = c(seq(0,10,2)),
                       right = F)
  mypal = colorRampPalette(brewer.pal(11,'Spectral'))(5)
  p = ggplot()+
    geom_polygon(data = world,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    geom_polygon(data = xj,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    
    geom_tile(data = tas_meamm,aes(
      x = long,y = lat,fill = cuts
    ))+
    scale_fill_manual(values = mypal)+
    facet_wrap(~variable,nrow = 4)+
    theme_bw()
}
spatial_monthly_evolution_tas_mean<-function(
  
){
  library(ggplot2)
  library(data.table)
  
  input_tas_mean = 'analysis_output/fig3/landtas_mean.csv'
  tas_mean = fread(input_tas_mean)
  tas_mean = as.data.frame(tas_mean)
  
  natas = which(is.na(tas_mean$tmptasmean))
  tas_mean = tas_mean[-natas,]
  
  tas_mean = as.data.frame(tas_mean)
  colnames(tas_mean) = c('long','lat',
                         toupper(month.abb))
  
  tas_meamm  = reshape2::melt(tas_mean,c('long','lat'))
  idbigzero <- which(tas_meamm$value >=0)
  tas_meamm = tas_meamm[idbigzero,]
  
  tas_meamm$cuts = cut(tas_meamm$value,
                       breaks = c(seq(0,40,5),90) )
  p = ggplot()+
    geom_polygon(data = world,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    geom_polygon(data = xj,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    
    geom_tile(data = tas_meamm,aes(
      x = long,y = lat,fill = cuts
    ))+
    scale_fill_brewer(palette = 'Spectral',
                      direction = -1)+
    facet_wrap(~variable,nrow = 4)+
    theme_bw()
  
  
  
  
}
spatio_tws_evolu<-function(
  
){
  input_tws_mean = 'analysis_output/fig3/twsmean_mon.csv'
  input_pme_mean = 'analysis_output/fig3/pmemean_mon.csv'
  
  tws_mean = fread(input_tws_mean)
  tws_mean = as.data.frame(tws_mean)
  pme_mean = as.data.frame(fread(input_pme_mean))
  
  
  naidtws = which(is.na(tws_mean$JAN))
  tws_mean = tws_mean[-naidtws,]
  loc = tws_mean[,1:2]
  tws_mean = tws_mean[,-c(1,2)]
  
  
  naidpme = which(is.na(pme_mean$JAN))
  pme_mean = pme_mean[-naidpme,]
  loc_pme = pme_mean[,1:2]
  pme_mean = pme_mean[,-c(1,2)]

  #tws_mean = apply(tws_mean,2,class_fun)
  
  tws_mean = apply(tws_mean,1,sum,na.rm = T)
  pme_mean = apply(pme_mean,1,sum,na.rm = T)
  
  twsdf = data.frame(
    long = loc[,1],
    lat = loc[,2],
    twsclass = tws_mean
  )
  
  coordinates(twsdf) = ~long+lat
  gridded(twsdf) = T
  twsdf = raster(twsdf)
  
  shp_as = shp_management('land','as')
  shp_eu = shp_management('land','eu')
  shp_naf = shp_management('land','naf')
  shp_as_eu = bind(shp_as,shp_eu,shp_naf)
  ex_as_ato = extent(shp_as_eu)
  ex_as_ato = extent(-50,ex_as_ato[2],ex_as_ato[3],
                     ex_as_ato[4])
  
  twsdf = crop(twsdf,ex_as_ato)
  twsdf = mask(twsdf,shp_as_eu)
  twsdf = as.data.frame(twsdf,xy =T)
  colnames(twsdf) = c('long','lat','twsclass')
  
  dem = raster('global_dem/global_dem.nc')
  
  dem1 = crop(dem,extent(0,180,-90,90))
  dem2 = crop(dem,extent(180,360,-90,90))
  extent(dem2) = extent(-180,0,-90,90)
  dem = merge(dem2,dem1)
  
  
  dem_crop = crop(dem,ex_as_ato)
  dem_crop = mask(dem_crop,shp_as_eu)
  
  dem_cropdf = as.data.frame(dem_crop,
                             xy = T)
  
  colnames(dem_cropdf) = c('long','lat','dem')
  naiddem = which(is.na(dem_cropdf$dem))
  
  dem_cropdf = dem_cropdf[-naiddem,]
  dem_cropdf$type = '(b) Spatial evolution of the sum of monthly TWS and PMEATO anomalies'
  
  
  
  pmedf <-data.frame(
    long = loc_pme[,1],
    lat = loc_pme[,2],
    pmeclass = pme_mean
  )
  
  twsdfm = reshape2::melt(twsdf,
                           c('long','lat'))
  pmedfm = reshape2::melt(pmedf,
                          c('long','lat'))
  
  lessid = which(twsdfm$value<0)
  #lessid_pme = which(pmedfm$value < 0)
  
  #pmedfm = pmedfm[lessid_pme,]
  twsdfm = twsdfm[lessid,]
  
  pmedfm$cuts = cut(pmedfm$value,
                    breaks = c(-140,seq(0,500,100),540),
                    right = F)
  twsdfm$cuts = cut(twsdfm$value,
                     breaks = c(-1900,
                              seq(-500,-200,100),
                              seq(-100,0,10)),
                    right=F)
  
  mycolor = colorRampPalette(
    brewer.pal(11,'Spectral'))(15)
  pmecolor = colorRampPalette(
    brewer.pal(11,'Spectral'))(7)
  
  shp_subs =  'sub_windows'
  num = 1:19
  input_shp = paste0(shp_subs,'/sub_window',num,'.shp')
  shp_subs = do.call('bind',lapply(input_shp,shapefile))
  
  library(ggnewscale)
  source('/home/share/R_project/xinjiang_vapor/month_longit_evolution.R')
  tws_meanm_agg = month_longit_evolution()
  tile_col = colorRampPalette(
    brewer.pal(11,'Spectral')
  )(30)
  tile_col = tile_col[c(1:15,23:29)]
  
  twsdfm$type = '(b) Spatial evolution of the sum of monthly TWS and PMEATO anomalies'
  tws_meanm_agg$type = '(a) Monthly Evolution of Mean TWS Anomaly alongside Longitude'
  pmedfm$type = '(b) Spatial evolution of the sum of monthly TWS and PMEATO anomalies'
  #fwrite(twsdfm,'analysis_output/fig3/tws_month_sum.csv')
  tws_meanm_agg$Indices_class = cut(tws_meanm_agg$value,
                                breaks = c(seq(-60,-10,5),
                                           seq(-5,0,1),
                                           seq(10,140,20)))
  
  world = shp_management('world')
  xj = shp_management('xinjiang')
  world= crop(world,extent(-180,180,0,90))
  
  world_df =fortify(world)
  xj_df = fortify(xj)
  #shp_com_df = fortify(shp_com)
  shp_subs_df = fortify(shp_subs)
  
  world_df$type = '(b) Spatial evolution of the sum of monthly TWS and PMEATO anomalies'
  xj_df$type = '(b) Spatial evolution of the sum of monthly TWS and PMEATO anomalies'
  #shp_com_df$type = '(b) Spatial evolution of the sum of monthly TWS and PMEATO anomalies'
  shp_subs_df$type = '(b) Spatial evolution of the sum of monthly TWS and PMEATO anomalies'
  
  
  land_scale = data.frame(
    xstart = c(-180,-180),
    xend = c(180,180),
    ystart = c(30,60),
    yend = c(30,60),
    type = '(b) Spatial evolution of the sum of monthly TWS and PMEATO anomalies'
  )
  fontsize = 12
  text_theme_set = theme(
    ##############
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
    ##############
  )
  p1 = ggplot()+
    geom_tile(data = tws_meanm_agg,
              aes(x = Longitude,
                  y = Time,
                  fill = Indices_class
              ))+
    scale_fill_manual(values = tile_col)+
    xlim(c(-180,180))+
    geom_vline(xintercept = 130)+
    geom_vline(xintercept = 0)+
    geom_vline(xintercept = -94.75)+
    theme_bw()+
    text_theme_set
  
  # input of currents ocean
  cur_df = as.data.frame(
    fread('analysis_output/fig4/current_df.csv')
  )
  
  idless50 = which(cur_df$lat <= 50)
  cur_df = cur_df[idless50,]
  
  idbig1 = which(cur_df$u>0 &
                   cur_df$v >0)
  idbig2 = which(cur_df$u<0 &
                   cur_df$v >0)
  
  cur_df1 = cur_df[idbig1,]
  cur_df2 = cur_df[idbig2,]
  
  cid1 = seq(1,nrow(cur_df1),30)
  cid2 = seq(1,nrow(cur_df2),200)
  
  cur_df1 = cur_df1[cid1,]
  cur_df2 = cur_df2[cid2,]
  
  
  cols_cur = c('#2988AE','#30376E')
  
  cluster_traj_df = fread('analysis_output/fig2/cluster_traj_df.csv')
  cluster_traj_df = as.data.frame(cluster_traj_df)
  route_col = pal_npg()(10)[4]
  route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
  
  route_col = colorRampPalette(brewer.pal(
    9,'Blues'
  ))(20)
  
  p2 = ggplot()+
    ##############
    geom_polygon(data = world_df,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    
    geom_tile(data = twsdfm,
              aes(x = long,y = lat,fill = cuts))+
    
    scale_fill_manual(values = mycolor,
                      guide = guide_legend(
                        title = 'TWS_MON_SUM',
                        nrow = 3))+
    new_scale_fill()+
    geom_tile(data = pmedfm,
              aes(x = long,y = lat,fill = cuts))+
    scale_fill_manual(values = pmecolor,
                      guide = guide_legend(
                        title = 'PME_MON_SUM',
                        nrow = 3))+
    geom_polygon(data = xj_df,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    
    geom_segment(data = land_scale,
              aes(x = xstart,xend = xend,
                  y = ystart,yend = yend),
              linetype = 'dashed',
              color = 'black',
              size = 0.5)+
    geom_vline(xintercept = 130)+
    stat_contour(data = dem_cropdf,
                 aes(x = long,y = lat,
                     z = dem),
                 breaks = c(2000))+
    geom_segment(data = cur_df1,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.15,'cm'),
                               type = 'open'),
                 color = cols_cur[1])+
    geom_segment(data = cur_df2,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.2,'cm'),
                               type = 'open'),
                 color = cols_cur[2])+
    
    ##############
    theme_bw()
  
  traj_points  = data.frame(
    x = c(0,20,39,50,85,115,30,39,20,-10,-90,-25,-45,-60),
    y = c(50,45,51,40,43,36,58,32,28,25,18,5,25,40)
  )
  traj_points1  = data.frame(
    x = c(0,20,39,50),
    y = c(50,45,51,40)
  )
  
  traj_points2  = data.frame(
    x = c(30,39,50),
    y = c(58,51,40)
  )
  traj_points3  = data.frame(
    x = c(-10,20,39,50),
    y = c(25,28,32,40)
  )
  traj_points4 = data.frame(
    x = c(50,85,115),
    y = c(40,43,36)
  )
  
  traj_points5 = data.frame(
    x = c(-90,-45),
    y = c(18,25)
  )
  
  traj_points6 = data.frame(
    x = c(-25,-10),
    y = c(5,25)
  )
  
  
  traj_points7 = data.frame(
    x = c(-45,0),
    y = c(25,50)
  )
  
  
  
  traj_points8 = data.frame(
    x = c(-90,-60,0),
    y = c(18,40,50)
  )
  
  traj_points9 = data.frame(
    x = c(-25,-45),
    y = c(5,25)
  )
  p2 = p2+
    geom_point(data = traj_points,
               aes(x = x,y = y),
               size = 5,
               color = 'blue',
               shape = 1)+
    geom_point(data = traj_points,
               aes(x = x,y = y),
               size = 6,
               color = '#4876FF',
               shape = 1)+
    geom_point(data = traj_points,
               aes(x = x,y = y),
               size = 7,
               color = '#4876FF',
               shape = 1)+
    geom_path(data  =traj_points1,
              aes(x = x,y = y),
              size = 1,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))+
    geom_path(data  =traj_points2,
              aes(x = x,y = y),
              size = 1,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))+
    geom_path(data  =traj_points3,
              aes(x = x,y = y),
              size = 1,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))+
    geom_path(data  =traj_points4,
              aes(x = x,y = y),
              size = 2,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))+
    geom_path(data  =traj_points5,
              aes(x = x,y = y),
              size = 1,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))+
    geom_path(data  =traj_points6,
              aes(x = x,y = y),
              size = 1,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))+
    geom_path(data  =traj_points7,
              aes(x = x,y = y),
              size = 1,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))+
    geom_path(data  =traj_points8,
              aes(x = x,y = y),
              size = 1,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))+
    geom_path(data  =traj_points9,
              aes(x = x,y = y),
              size = 1,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))
 
  
  
  p2 = p2+text_theme_set+
    geom_vline(xintercept = 0)+
    geom_vline(xintercept = -94.75)+
    theme(
      strip.text = element_blank()
    )
  
  
  world_crop = crop(world,
                    extent(0,130,30,60))
  
  world_df_crop = fortify(world_crop,xy = T)
  
  p3 = ggplot()+
    ##############
    geom_polygon(data = world_df_crop,
                             aes(x = long,y = lat,group = group),
                             fill = 'transparent',
                             color = 'black',
                             size = 0.5)+
    
    geom_tile(data = twsdfm,
              aes(x = long,y = lat,fill = cuts))+
    
    scale_fill_manual(values = mycolor)+
    new_scale_fill()+
    geom_tile(data = pmedfm,
              aes(x = long,y = lat,fill = cuts))+
    scale_fill_manual(values = pmecolor)+
    geom_polygon(data = xj_df,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    #geom_vline(xintercept = 130)+
    stat_contour(data = dem_cropdf,
                 aes(x = long,y = lat,
                     z = dem),
                 breaks = c(2000))+
    xlim(c(0,130))+
    ylim(c(30,60))+
    ##############
    theme_bw()
  p3 = p3+
    geom_text_contour(
      data = dem_cropdf,
      aes(x = long,y = lat,
          z = dem),
      breaks = 2000,
      size = 5,
      check_overlap = T
    )
    
  p3 = p3+text_theme_set
  
  p3 = p3+
    geom_point(data = traj_points,
               aes(x = x,y = y),
               size = 5,
               color = 'blue',
               shape = 1)+
    geom_point(data = traj_points,
               aes(x = x,y = y),
               size = 6,
               color = '#4876FF',
               shape = 1)+
    geom_point(data = traj_points,
               aes(x = x,y = y),
               size = 7,
               color = '#4876FF',
               shape = 1)+
    geom_path(data  =traj_points1,
              aes(x = x,y = y),
              size = 1,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))+
    geom_path(data  =traj_points2,
              aes(x = x,y = y),
              size = 1,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))+
    geom_path(data  =traj_points3,
              aes(x = x,y = y),
              size = 1,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))+
    geom_path(data  =traj_points4,
              aes(x = x,y = y),
              size = 2,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))
  
  world_crop2 = crop(world,
                     extent(-94.75,180,30,60))
  world_crop2_df = fortify(world_crop2,xy = T)
  textdf = data.frame(
    x = c(140),
    y = c(59),
    label = c('(E180.00°, N60.00°)')
  )
  textdf2 = data.frame(
    label = '(W94.75°, N30.00°)',
    x  = -55,
    y = 31
  )
  p4 = ggplot()+
    ##############
  geom_polygon(data = world_crop2_df,
               aes(x = long,y = lat,group = group),
               fill = 'grey80',
               color = 'black',
               size = 0.5,
               alpha = 0.7)+
    ##############
    theme_void()+
    xlim(-94.75,180)+
    ylim(30,60)+
    geom_vline(xintercept = -94.75)+
    geom_vline(xintercept = 180)+
    geom_hline(yintercept = 30)+
    geom_hline(yintercept = 60)+
    #coord_fixed(1.3)+
    theme(
      legend.position = 'none'
    )
  
  p1 = p1 + theme(
    legend.position = 'none',
    axis.title = element_blank()
  )
  
  p3 = p3+theme(
    legend.position = 'none',
    axis.title = element_blank()
  )
  
  p2 = p2+theme(
    legend.position = 'none',
    axis.title = element_blank()
  )
  
  
  library(cowplot)
  
  p23 = plot_grid(
    p1,p2,p3,
    align = 'hv',
    axis = 'lr',
    rel_widths = c(1,1,1),
    rel_heights = c(1.5,2,2),
    ncol = 1
  )
  
  p234 = ggdraw()+
    draw_plot(p23)+
    draw_plot(p4,x = 0.06, y = 0.82,
              width = 0.23,height = 0.1)
  
  
  
  
  dir.create('main_plot/fig3')
  png('main_plot/fig3/fig3_3.png',
      height = 27,
      width = 25,
      units = 'cm',
      res = 800)
  print(p234)
  dev.off()
  
  p1_leg = p1+theme(
    legend.position = 'bottom'
  )+
  guides(fill = guide_legend(nrow = 3))
  
  p2_leg = p2+theme(
    legend.position = 'bottom'
  )
  
  library(ggpubr)
  p1_leg = get_legend(p1_leg)
  p2_leg = get_legend(p2_leg)
  p1_leg = as_ggplot(p1_leg)
  p2_leg = as_ggplot(p2_leg)
  
  
  png('main_plot/fig3/fig3_leg1.png',
      height = 5,
      width = 28,
      units = 'cm',
      res = 800)
  print(p1_leg)
  dev.off()
  png('main_plot/fig3/fig3_leg2.png',
      height =5,
      width = 40,
      units = 'cm',
      res = 800)
  print(p2_leg)
  dev.off()
}
speed_up_krige<-function(
  df,
  locdf
){
  library(maps)
  library(fields)
  library(ggplot2)
  library(geoR)
  library(maptools)
  library(png)
  700
  df = loc1
  
  locdf = df[,1:2]
  
  subs_long = seq(-180,180,180)
  subs_lat = seq(-60,90,75)
  
  subslong1 = rep(subs_long[1:2],2)
  subslong2 = rep(subs_long[2:3],2)
  
  subslat1 = rep(subs_lat[1:2],each = 2)
  subslat2 = rep(subs_lat[2:3],each = 2)
  
  cond = cbind(subslong1,subslong2,subslat1,subslat2)
  
  i = 1:nrow(cond)
  cond <<- cond
  df <<- df
  locdf <<- locdf
  group_by_df <-function(i){
    longdf = locdf[,1]
    latdf = locdf[,2]
    
    id = which(longdf >=cond[i,1] &
                 longdf <=cond[i,2] &
                 latdf >= cond[i,3] &
                 latdf <= cond[i,4])
    return(id)
  }
  
  idli = lapply(i,group_by_df)
  idli <<- idli
  i <<- 1:length(idli)
  idre_fun <-function(i){
    len = length(idli[[i]])
    if(len == 0){
      return(i)
    }
  }
  idtell = lapply(i,idre_fun)
  idtell = do.call('c',idtell)
  
  idli = idli[-idtell]
  cond = cond[-idtell,]
  
  i = 1:length(idli)
  len_tell<-function(i){
    len = length(idli[[i]])
    return(len)
  }
  lens = lapply(i,len_tell)
  lens = do.call('c',lens)
  
  i <<- 1:length(idli)
  df <<- df
  cond <<- cond
  idli <<- idli
  
  long = seq(-180,180,0.5)
  lat = seq(-60,90,0.5)
  grid = expand.grid(long,lat)
  
  world = shp_management('world')
  
  inusa <-map.where(world,x=grid[,1],y=grid[,2])
  inusa <-!is.na(inusa)
  grid <-grid[inusa,]
  
  grid2 <<- grid
  
  cluster_krig <-function(i){
    
    library(gstat)
    library(raster)
    library(sp)
    idgrid = which(grid2[,1]>=cond[i,1]&
               grid2[,1]<=cond[i,2]&
               grid2[,2]>=cond[i,3]&
               grid2[,2]<=cond[i,4])
    
    tmpgrid = grid2[idgrid,]
    tmpgridloc = tmpgrid
    
    tmpgrid = SpatialPoints(tmpgrid)
    gridded(tmpgrid) = T
    
    m <- vgm(.59, "Sph", 874, .04)
    tmpdf = df[idli[[i]],]
    colnames(tmpdf) = c('long','lat','pr')
    coordinates(tmpdf) = ~long+lat
    
    tmpx = krige(pr~1,tmpdf,tmpgrid,
              model = m,beta = 5.9)
    
    pred = tmpx$var1.pred
    pred[which(pred<0)] = 0
    ret = data.frame(
      long = tmpgridloc[,1],
      lat = tmpgridloc[,2],
      pr = pred
    )
    return(ret)
  }
  
  cl = makeCluster(14)
  clusterExport(cl,c('i','cond','grid2',
                     'df','idli'))
  system.time(retdf <- parLapply(cl,i,cluster_krig))
  stopCluster(cl)
  
  retdf = do.call('rbind',retdf)
  
  xpred = x$var1.pred
  xpred[which(xpred<0)] =0
  retdf$pr - x$var1.pred
  
  coordinates(retdf) = ~long+lat
  gridded(retdf) = T
  r2 = raster(retdf)
  plot(r2)
}

































speed_up_krige2<-function(
  df,
  locdf
){
  library(maps)
  library(fields)
  library(ggplot2)
  library(geoR)
  library(maptools)
  library(png)
  library(maps)
  library(fields)
  library(ggplot2)
  library(geoR)
  library(maptools)
  library(png)
  700
  df = loc1
  
  locdf = df[,1:2]
  
  
  
  long = seq(-180,180,0.5)
  lat = seq(-60,90,0.5)
  grid = expand.grid(long,lat)
  
  world = shp_management(pattern = 'land',names = 'eu')
  
  inusa <-map.where(world,x=grid[,1],y=grid[,2])
  inusa <-!is.na(inusa)
  grid <-grid[inusa,]
  
  grid2 <<- grid
  
  cond = extent(world)
  
  cluster_krig <-function(i){
    
    library(gstat)
    library(raster)
    library(sp)
    idgrid = which(grid2[,1]>=cond[1]&
                     grid2[,1]<=cond[2]&
                     grid2[,2]>=cond[i,3]&
                     grid2[,2]<=cond[i,4])
    
    tmpgrid = grid2[idgrid,]
    tmpgridloc = tmpgrid
    
    tmpgrid = SpatialPoints(tmpgrid)
    gridded(tmpgrid) = T
    
    m <- vgm(.59, "Sph", 874, .04)
    tmpdf = df[idli[[i]],]
    colnames(tmpdf) = c('long','lat','pr')
    coordinates(tmpdf) = ~long+lat
    
    tmpx = krige(pr~1,tmpdf,tmpgrid,
                 model = m,beta = 5.9)
    
    pred = tmpx$var1.pred
    pred[which(pred<0)] = 0
    ret = data.frame(
      long = tmpgridloc[,1],
      lat = tmpgridloc[,2],
      pr = pred
    )
    return(ret)
  }
  
  cl = makeCluster(14)
  clusterExport(cl,c('i','cond','grid2',
                     'df','idli'))
  system.time(retdf <- parLapply(cl,i,cluster_krig))
  stopCluster(cl)
  
  retdf = do.call('rbind',retdf)
  
  xpred = x$var1.pred
  xpred[which(xpred<0)] =0
  retdf$pr - x$var1.pred
  
  coordinates(retdf) = ~long+lat
  gridded(retdf) = T
  r2 = raster(retdf)
  plot(r2)
}

































spei_fun<-function(x,scale=3){
  library(SPEI)
  x = ts(x,c(2003,1),frequency = 12)
  spei3 = spei(x,scale)
  spei3 = spei3$fitted
  return(spei3)
}
sst_analysis <-function(
  
){
  # cal mean sst analysis 
  input_ato_shp = paste0('cluster_shp/ato/ato',
                         1:4,'.shp')
  
  sst = data_management('global_era5_sst')
  sst = sst[[1:174]]
  sst = sst - 273.15
  
  sub_mean_fun<-function(x){
    x = cellStats(x,'mean')
    return(x)
  }
  trend_fun <-function(x){
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    
    xt = as.numeric(xt)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }
  ato_sst = 1
  
  for(i in 1:4){
    tmpshp = shapefile(input_ato_shp[i])
    
    tmpsst = crop(sst,tmpshp)
    tmpsst = as.list(tmpsst)
    
    sst_mean = lapply(tmpsst,sub_mean_fun)
    
    sst_mean = do.call('c',sst_mean)
    sst_mean = sst_mean[1:174]
    
    sst_meant = trend_fun(sst_mean)
    
    ato_sst = cbind(ato_sst,sst_meant)
  }
  ato_sst =ato_sst[,-1]
  
  output = 'analysis_output/ato_mean_trend_sst.csv'
  write.csv(ato_sst,output)
  
}
sst_mean_monthly_analysis<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  sst = data_management('global_era5_sst')
  world = shp_management('world')
  
  world = crop(world,extent(-180,180,0,90))
  
  sst = crop(sst,world)
  sst = mask(sst,world)
  
  janid = seq(1,174,12)
  febid = seq(2,174,12)
  marid = seq(3,174,12)
  aprid = seq(4,174,12)
  mayid = seq(5,174,12)
  junid = seq(6,174,12)
  julid = seq(7,174,12)
  augid = seq(8,174,12)
  sepid = seq(9,174,12)
  octid = seq(10,174,12)
  novid = seq(11,174,12)
  decid = seq(12,174,12)
  
  monid = list(janid,febid,marid,aprid,
               mayid,junid,julid,augid,
               sepid,octid,novid,decid)
  
  
  
  monid <<- monid
  sst <<- sst
  
  cell_mean_fun <-function(i){
    tmpid = monid[[i]]
    tmptws = tws[[tmpid]]
    
    
    tmptwsdf = as.data.frame(tmptws,
                             xy = T)
    loc = tmptwsdf[,1:2]
    tmptwsdf = tmptwsdf[,-c(1,2)]
    
    tmptwsmean = apply(tmptwsdf,1,mean
                       ,na.rm = T)
    retbox = cbind(loc,tmptwsmean)
    return(retbox)
  }
  i = 1:length(monid)
  mon_mean_box = lapply(i,cell_mean_fun)
  
  sstmean1 = mon_mean_box[[1]]
  sstmean2 = mon_mean_box[[2]][,3]
  sstmean3 = mon_mean_box[[3]][,3]
  sstmean4 = mon_mean_box[[4]][,3]
  sstmean5 = mon_mean_box[[5]][,3]
  sstmean6 = mon_mean_box[[6]][,3]
  sstmean7 = mon_mean_box[[7]][,3]
  sstmean8 = mon_mean_box[[8]][,3]
  sstmean9 = mon_mean_box[[9]][,3]
  sstmean10 = mon_mean_box[[10]][,3]
  sstmean11 = mon_mean_box[[11]][,3]
  sstmean12 = mon_mean_box[[12]][,3]
  
  sstmean_mon = cbind(sstmean1,
                      sstmean2,
                      sstmean3,
                      sstmean4,
                      sstmean5,
                      sstmean6,
                      sstmean7,
                      sstmean8,
                      sstmean9,
                      sstmean10,
                      sstmean11,
                      sstmean12)
  
  output_sst_mean = 'analysis_output/fig3/ocesst_mean.csv'
  #fwrite(mon_mean_box,output_sst_mean)
  fwrite(sstmean_mon,output_sst_mean)
  
  
}
stand_fun<-function(
  x,mode = 'other'
){
  if(mode == "grace"){
    xs= x/(max(x)-min(x))  
  }else{
    xs= (x -mean(x))/(max(x)-min(x))
  }
  
  return(xs)
}
sub_cal_mean_eva_in_source<-function(
  mode = 'ato'
){
  
  # input file 
  input = '/media/sdb5/Data/era5_eva_masked_in_source'
  input = paste0(input ,'/',mode)
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/era5_source_eva_2003_2017.nc')
  input <<- input  
  # output
  output = 'era5_eva_mean'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output = paste0(output,'/region',1:4)
  sapply(output,dir.create)
  output = paste0(output,'/era5_eva_mean.csv')
  
  output <<- output
  # cal ep sum 
  
  sum_ep <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    tmp = stack(input[i])
    
    sum_fun <-function(x){
      x = cellStats(x,'mean',na.rm = T)
      return(x)
    }
    
    tmp = as.list(tmp)
    ret = lapply(tmp,sum_fun)
    ret = do.call(c,ret)
    
    ret = as.numeric(ret)
    #$id = which(ret <0)
    #ret[id] = 0
    
    ret =  matrix(ret,ncol =1)
    colnames(ret) = 'ERA5'
    
    fwrite(ret,output[i])
  }
  
  i <<- 1:4
  library(doParallel)
  
  cl = makeCluster(4)
  clusterExport(cl,c('i','input','output'))
  parLapply(cl,i,sum_ep)
  stopCluster(cl)
  
  print(paste0('Pass',mode))
  
}
sub_cal_mean_pe_in_source<-function(
  mode = 'ato'
){
  
  # input file 
  input = '/media/sdb5/Data/era5_pe_masked'
  input = paste0(input ,'/',mode)
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/era5_source_pe_2003_2017.nc')
  input <<- input  
  # output
  output = 'era5_pe_mean'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output = paste0(output,'/region',1:4)
  sapply(output,dir.create)
  output = paste0(output,'/era5_pe_sum.csv')
  
  output <<- output
  # cal ep sum 
  
  sum_ep <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    tmp = stack(input[i])
    
    sum_fun <-function(x){
      x = cellStats(x,'mean',na.rm = T)
      return(x)
    }
    
    tmp = as.list(tmp)
    ret = lapply(tmp,sum_fun)
    ret = do.call(c,ret)
    
    ret = as.numeric(ret)
    #$id = which(ret <0)
    #ret[id] = 0
    
    ret =  matrix(ret,ncol =1)
    colnames(ret) = 'ERA5'
    
    fwrite(ret,output[i])
  }
  
  i <<- 1:4
  library(doParallel)
  
  cl = makeCluster(4)
  clusterExport(cl,c('i','input','output'))
  parLapply(cl,i,sum_ep)
  stopCluster(cl)
  
  print(paste0('Pass',mode))
  
}
sub_cal_mean_pr_in_source<-function(
  mode = 'ato'
){
  
  # input file 
  input = '/media/sdb5/Data/era5_pr_masked'
  input = paste0(input ,'/',mode)
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/era5_source_pr_2003_2017.nc')
  input <<- input  
  # output
  output = 'era5_pr_mean'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output = paste0(output,'/region',1:4)
  sapply(output,dir.create)
  output = paste0(output,'/era5_pr_mean.csv')
  
  output <<- output
  # cal ep sum 
  
  sum_ep <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    tmp = stack(input[i])
    
    sum_fun <-function(x){
      x = cellStats(x,'mean',na.rm = T)
      return(x)
    }
    
    tmp = as.list(tmp)
    ret = lapply(tmp,sum_fun)
    ret = do.call(c,ret)
    
    ret = as.numeric(ret)
    #$id = which(ret <0)
    #ret[id] = 0
    
    ret =  matrix(ret,ncol =1)
    colnames(ret) = 'ERA5'
    
    fwrite(ret,output[i])
  }
  
  i <<- 1:4
  library(doParallel)
  
  cl = makeCluster(4)
  clusterExport(cl,c('i','input','output'))
  parLapply(cl,i,sum_ep)
  stopCluster(cl)
  
  print(paste0('Pass',mode))
  
}
sub_cal_mean_sst_in_source<-function(
  mode = 'ato'
){
  
  # input file 
  input = '/media/sdb5/Data/era5_sst_masked'
  input = paste0(input ,'/',mode)
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/era5_source_sst_2003_2017.nc')
  input <<- input  
  # output
  output = 'era5_sst_mean'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output = paste0(output,'/region',1:4)
  sapply(output,dir.create)
  output = paste0(output,'/era5_sst_mean.csv')
  
  output <<- output
  # cal ep sum 
  
  sum_ep <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    tmp = stack(input[i])
    
    sum_fun <-function(x){
      x = cellStats(x,'mean',na.rm = T)
      return(x)
    }
    
    tmp = as.list(tmp)
    ret = lapply(tmp,sum_fun)
    ret = do.call(c,ret)
    
    ret = as.numeric(ret)
    #$id = which(ret <0)
    #ret[id] = 0
    
    ret =  matrix(ret,ncol =1)
    colnames(ret) = 'ERA5'
    
    fwrite(ret,output[i])
  }
  
  i <<- 1:4
  library(doParallel)
  
  cl = makeCluster(4)
  clusterExport(cl,c('i','input','output'))
  parLapply(cl,i,sum_ep)
  stopCluster(cl)
  
  print(paste0('Pass',mode))
  
}
sub_cal_mean_tas_in_source<-function(
  mode = 'ato'
){
  
  # input file 
  input = '/media/sdb5/Data/era5_tas_masked'
  input = paste0(input ,'/',mode)
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/era5_source_tas_2003_2017.nc')
  input <<- input  
  # output
  output = 'era5_tas_mean'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output = paste0(output,'/region',1:4)
  sapply(output,dir.create)
  output = paste0(output,'/era5_tas_mean.csv')
  
  output <<- output
  # cal ep sum 
  
  sum_ep <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    tmp = stack(input[i])
    
    sum_fun <-function(x){
      x = cellStats(x,'mean',na.rm = T)
      return(x)
    }
    
    tmp = as.list(tmp)
    ret = lapply(tmp,sum_fun)
    ret = do.call(c,ret)
    
    ret = as.numeric(ret)
    #$id = which(ret <0)
    #ret[id] = 0
    
    ret =  matrix(ret,ncol =1)
    colnames(ret) = 'ERA5'
    
    fwrite(ret,output[i])
  }
  
  i <<- 1:4
  library(doParallel)
  
  cl = makeCluster(4)
  clusterExport(cl,c('i','input','output'))
  parLapply(cl,i,sum_ep)
  stopCluster(cl)
  
  print(paste0('Pass',mode))
  
}
sub_cal_random_forest_importance<-function(
  df
){
  # libr
  library(randomForest)
  
  set.seed(100)
  id_train = sample(nrow(df),0.7*nrow(df),replace = FALSE)
  #id_train = 1:round(0.7*nrow(df))
  train = df[id_train,]
  test = df[-id_train,]
  
  set.seed(432)
  model_ini = randomForest(tws ~ ., data = train,
                           importance = T,
                           ntree = 500,
                           mtry = 3
                           
  )
  
  # PREDICTING WITH INITIAL MODEL
  pred_train = as.numeric(predict(model_ini,train))
  pred_test =  as.numeric(predict(model_ini,test))
  
  library(caret)
  # tune mtry
  mtry_len = ncol(df)-1
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = 1:mtry_len)
  
  set.seed(432)
  rf_mtry = train(tws ~ .,
                  data = train,
                  method = 'rf',
                  tuneGrid = tuneGrid,
                  trControl = trControl,
                  importance = T
  )
  
  rf_mtry_res = rf_mtry$results[,1:2]
  
  id_mtry = which.min(rf_mtry_res$RMSE)
  
  rf_mtry_best = rf_mtry_res[id_mtry,1]
  
  
  # find number of trees
  
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = rf_mtry_best)
  
  mod_par_cart = 1
  for(ntree in seq(100,1000,100)){
    set.seed(432)
    rf_mtry = train(tws ~ .,
                    data = train,
                    method = 'rf',
                    ntree = ntree,
                    tuneGrid = tuneGrid,
                    trControl = trControl,
                    importance = T
    )
    
    rf_mod = rf_mtry$results[,c(1,2)]
    rf_mod = cbind(rf_mod,ntree)
    mod_par_cart = rbind(mod_par_cart,rf_mod)
  }
  mod_par_cart = mod_par_cart[-1,]
  
  id_best = which.min(mod_par_cart$RMSE)
  
  ntree_best = mod_par_cart[id_best,3]
  
  set.seed(432)
  
  model_best = randomForest(tws ~ ., data = train,
                            importance = T,
                            ntree = ntree_best,
                            mtry = rf_mtry_best
  )

  importance = model_best$importance
  
  return(importance)
  
}











sub_cal_sum_ep_in_source<-function(
  mode = 'ato'
){
  
  # input file 
  input = '/media/sdb5/Data/era5_ep_masked'
  input = paste0(input ,'/',mode)
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/era5_source_ep_2003_2017.nc')
  input <<- input  
  # output
  output = 'era5_ep_sum'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output = paste0(output,'/region',1:4)
  sapply(output,dir.create)
  output = paste0(output,'/era5_ep_sum.csv')
  
  output <<- output
  # cal ep sum 
  
  sum_ep <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    tmp = stack(input[i])
    
    sum_fun <-function(x){
      x = cellStats(x,'sum',na.rm = T)
      return(x)
    }
    
    tmp = as.list(tmp)
    ret = lapply(tmp,sum_fun)
    ret = do.call(c,ret)
    
    ret = as.numeric(ret)
    id = which(ret <0)
    ret[id] = 0
    
    ret =  matrix(ret,ncol =1)
    colnames(ret) = 'ERA5'
    
    fwrite(ret,output[i])
  }
  
  i <<- 1:4
  library(doParallel)
  
  cl = makeCluster(4)
  clusterExport(cl,c('i','input','output'))
  parLapply(cl,i,sum_ep)
  stopCluster(cl)
  
  print(paste0('Pass',mode))
  
}
sub_cal_sum_eva_in_source<-function(
  mode = 'ato'
){
  
  # input file 
  input = '/media/sdb5/Data/era5_eva_masked_in_source'
  input = paste0(input ,'/',mode)
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/era5_source_eva_2003_2017.nc')
  input <<- input  
  # output
  output = 'era5_eva_sum'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output = paste0(output,'/region',1:4)
  sapply(output,dir.create)
  output = paste0(output,'/era5_eva_sum.csv')
  
  output <<- output
  # cal ep sum 
  
  sum_ep <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    tmp = stack(input[i])
    
    sum_fun <-function(x){
      x = cellStats(x,'sum',na.rm = T)
      return(x)
    }
    
    tmp = as.list(tmp)
    ret = lapply(tmp,sum_fun)
    ret = do.call(c,ret)
    
    ret = as.numeric(ret)
    #$id = which(ret <0)
    #ret[id] = 0
    
    ret =  matrix(ret,ncol =1)
    colnames(ret) = 'ERA5'
    
    fwrite(ret,output[i])
  }
  
  i <<- 1:4
  library(doParallel)
  
  cl = makeCluster(4)
  clusterExport(cl,c('i','input','output'))
  parLapply(cl,i,sum_ep)
  stopCluster(cl)
  
  print(paste0('Pass',mode))
  
}
sub_cal_sum_pe_in_source<-function(
  mode = 'ato'
){
  
  # input file 
  input = '/media/sdb5/Data/era5_pe_masked'
  input = paste0(input ,'/',mode)
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/era5_source_pe_2003_2017.nc')
  input <<- input  
  # output
  output = 'era5_pe_sum'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output = paste0(output,'/region',1:4)
  sapply(output,dir.create)
  output = paste0(output,'/era5_pe_sum.csv')
  
  output <<- output
  # cal ep sum 
  
  sum_ep <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    tmp = stack(input[i])
    
    sum_fun <-function(x){
      x = cellStats(x,'sum',na.rm = T)
      return(x)
    }
    
    tmp = as.list(tmp)
    ret = lapply(tmp,sum_fun)
    ret = do.call(c,ret)
    
    ret = as.numeric(ret)
    #$id = which(ret <0)
    #ret[id] = 0
    
    ret =  matrix(ret,ncol =1)
    colnames(ret) = 'ERA5'
    
    fwrite(ret,output[i])
  }
  
  i <<- 1:4
  library(doParallel)
  
  cl = makeCluster(4)
  clusterExport(cl,c('i','input','output'))
  parLapply(cl,i,sum_ep)
  stopCluster(cl)
  
  print(paste0('Pass',mode))
  
}
sub_cal_sum_pet_in_source<-function(
  mode = 'ato'
){
  
  # input file 
  input = '/media/sdb5/Data/era5_pet_masked'
  input = paste0(input ,'/',mode)
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/era5_source_pet_2003_2017.nc')
  input <<- input  
  # output
  output = 'era5_pet_sum'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output = paste0(output,'/region',1:4)
  sapply(output,dir.create)
  output = paste0(output,'/era5_pet_sum.csv')
  
  output <<- output
  # cal ep sum 
  
  sum_ep <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    tmp = stack(input[i])
    
    sum_fun <-function(x){
      x = cellStats(x,'sum',na.rm = T)
      return(x)
    }
    
    tmp = as.list(tmp)
    ret = lapply(tmp,sum_fun)
    ret = do.call(c,ret)
    
    ret = as.numeric(ret)
    #$id = which(ret <0)
    #ret[id] = 0
    
    ret =  matrix(ret,ncol =1)
    colnames(ret) = 'ERA5'
    
    fwrite(ret,output[i])
  }
  
  i <<- 1:4
  library(doParallel)
  
  cl = makeCluster(4)
  clusterExport(cl,c('i','input','output'))
  parLapply(cl,i,sum_ep)
  stopCluster(cl)
  
  print(paste0('Pass',mode))
  
}
sub_cal_sum_pr_in_source_based_gpcc<-function(
  mode = 'ato'
){
  
  # input file 
  input = '/media/sdb5/Data/gpcc_pr_masked'
  input = paste0(input ,'/',mode)
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/gpcc_source_pr_2003_2017.nc')
  input <<- input  
  # output
  output = 'gpcc_pr_sum'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output = paste0(output,'/region',1:4)
  sapply(output,dir.create)
  output = paste0(output,'/gpcc_pr_sum.csv')
  
  output <<- output
  # cal ep sum 
  
  sum_ep <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    tmp = stack(input[i])
    
    sum_fun <-function(x){
      x = cellStats(x,'sum',na.rm = T)
      return(x)
    }
    
    tmp = as.list(tmp)
    ret = lapply(tmp,sum_fun)
    ret = do.call(c,ret)
    
    ret = as.numeric(ret)
    #$id = which(ret <0)
    #ret[id] = 0
    
    ret =  matrix(ret,ncol =1)
    colnames(ret) = 'gpcc'
    
    fwrite(ret,output[i])
  }
  
  i <<- 1:4
  library(doParallel)
  
  cl = makeCluster(4)
  clusterExport(cl,c('i','input','output'))
  parLapply(cl,i,sum_ep)
  stopCluster(cl)
  
  print(paste0('Pass',mode))
  
}
sub_cal_sum_pr_in_source<-function(
  mode = 'ato'
){
  
  # input file 
  input = '/media/sdb5/Data/era5_pr_masked'
  input = paste0(input ,'/',mode)
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/era5_source_pr_2003_2017.nc')
  input <<- input  
  # output
  output = 'era5_pr_sum'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output = paste0(output,'/region',1:4)
  sapply(output,dir.create)
  output = paste0(output,'/era5_pr_sum.csv')
  
  output <<- output
  # cal ep sum 
  
  sum_ep <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    tmp = stack(input[i])
    
    sum_fun <-function(x){
      x = cellStats(x,'sum',na.rm = T)
      return(x)
    }
    
    tmp = as.list(tmp)
    ret = lapply(tmp,sum_fun)
    ret = do.call(c,ret)
    
    ret = as.numeric(ret)
    #$id = which(ret <0)
    #ret[id] = 0
    
    ret =  matrix(ret,ncol =1)
    colnames(ret) = 'ERA5'
    
    fwrite(ret,output[i])
  }
  
  i <<- 1:4
  library(doParallel)
  
  cl = makeCluster(4)
  clusterExport(cl,c('i','input','output'))
  parLapply(cl,i,sum_ep)
  stopCluster(cl)
  
  print(paste0('Pass',mode))
  
}
sub_cal_sum_tws_in_source<-function(
  mode = 'ato'
){
  
  # input file 
  input = '/media/sdb5/Data/tws_in_source'
  input = paste0(input ,'/',mode)
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/tws_in_source_2003_2017.nc')
  input <<- input  
  # output
  output = 'tws_in_source'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output = paste0(output,'/region',1:4)
  sapply(output,dir.create)
  output = paste0(output,'/tws_sum.csv')
  
  output <<- output
  # cal ep sum 
  
  sum_ep <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    tmp = stack(input[i])
    
    sum_fun <-function(x){
      x = cellStats(x,'sum',na.rm = T)
      return(x)
    }
    
    tmp = as.list(tmp)
    ret = lapply(tmp,sum_fun)
    ret = do.call(c,ret)
    
    ret = as.numeric(ret)
    #$id = which(ret <0)
    #ret[id] = 0
    
    ret =  matrix(ret,ncol =1)
    colnames(ret) = 'TWS'
    
    fwrite(ret,output[i])
  }
  
  i <<- 1:4
  library(doParallel)
  
  cl = makeCluster(4)
  clusterExport(cl,c('i','input','output'))
  parLapply(cl,i,sum_ep)
  stopCluster(cl)
  
  print(paste0('Pass',mode))
  
}
sub_train_based_era5_cmip6_ssp245 <- function(
  
){
  SWs = paste0('SW',1:10)
  path = 'analysis_output/figS8-11'
  dir.create(path)
  output_train_245 = paste0(path,'/train_ssp245')
  output_valid_245 = paste0(path,'/valid_ssp245')
  output_imp_245 = paste0(path,'/import_ssp245')
  
  dir.create(output_train_245)
  dir.create(output_valid_245)
  dir.create(output_imp_245)
  
  output_train_245 = paste0(output_train_245,'/',
                            SWs,'.csv')
  output_valid_245 = paste0(output_valid_245,'/',
                            SWs,'.csv')
  output_imp_245 = paste0(output_imp_245,
                          '/',SWs,'.csv')
  
  SWs<<- SWs
  output_train_245 <<- output_train_245
  output_valid_245 <<- output_valid_245
  output_imp_245<<- output_imp_245
  
  sub_train_fun245 <-function(i){
    print(i)
    tws_sw = twsdf[,i]
    naid = which(is.na(tws_sw))
    tws_sw = tws_sw[-naid]
    tws_sw <<- tws_sw
    
    # building up model between tws and 
    # grace 
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws_era5_cmip6.R')
    df = data.frame(
      tws = tws_sw,
      pme1 = era5_pme[,1],
      pme3 = era5_pme[,2]
      #sst1 = era5_sst[,1],
      #sst3 = era5_sst[,2]
    )
    
    pme1_pj245 = as.matrix(pme1_ssp245[175:576,])
    pme3_pj245 = as.matrix(pme3_ssp245[175:576,])
    #sst1_pj245 = as.matrix(sst1_ssp245[175:576,])
    sst3_pj245 = as.matrix(sst3_ssp245[175:576,])
    
    source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
    pme1_pj245 = trend_fun(pme1_pj245)
    pme3_pj245 = trend_fun(pme3_pj245)
    #sst1_pj245 = trend_fun(sst1_pj245)
    sst3_pj245 = trend_fun(sst3_pj245)
    
    naid = which(is.na(pme3_pj245[,1]))
    pme3_pj245 = pme3_pj245[-naid,]
    sst3_pj245 = sst3_pj245[-naid,]
    pme1_pj245 = pme1_pj245[-naid,]
    
    ret_box = random_forest_model_tws_era5_cmip6(df)
    ret_box_train = ret_box[[1]]
    ret_box_valid = ret_box[[2]]
    model_best = ret_box[[3]]
    
    impmat = model_best$importance
    
    colnames(ret_box_train) = c('TWS_OBS',
                                'TWS_PROJ')
    colnames(ret_box_valid) = c('TWS_OBS',
                                "TWS_PROJ")
    
    ret_box_train$SWs = SWs[i]
    ret_box_valid$SWs = SWs[i]
    
    library(data.table)
    fwrite(ret_box_train
           ,output_train_245[i])
    fwrite(ret_box_valid,
           output_valid_245[i])
    fwrite(impmat,
           output_imp_245[i])
    
    
    pred_mean_box = 1
    pred_max_box = 1
    pred_min_box = 1
    
    for(j in 1:ncol(pme3_pj245)){
      df_project = data.frame(
        pme1= pme1_pj245[,j],
        pme3 = pme3_pj245[,j]
        #sst3 = sst3_pj245[,j]
      )
      cl_con_inter <- function(x){
        c(mean(x),quantile(x,c(0.05,0.95)))
      }
      
      pred_tws = predict(model_best,
                         df_project,
                         predict.all = T)
      pred_box = t(apply(pred_tws$individual,
                         1,cl_con_inter))
      
      pred_mean = predict(model_best,
                          df_project)
      pred_max = pred_box[,3]
      pred_min = pred_box[,2]
      
      pred_mean_box = cbind(pred_mean_box,
                            pred_mean)
      pred_max_box = cbind(pred_max_box,
                           pred_max)
      pred_min_box = cbind(pred_min_box,
                           pred_min)
    }
    pred_mean_box = pred_mean_box[,-1]
    pred_min_box = pred_min_box[,-1]
    pred_max_box = pred_max_box[,-1]
    
    pred_mean = apply(pred_mean_box,1,mean)
    pred_max = apply(pred_max_box,1,mean)
    pred_min = apply(pred_min_box,1,mean)
    
    rets = data.frame(
      mean = pred_mean,
      max = pred_max,
      min = pred_min
    )  
    return(rets)
    
    
  }
  
  i = 1:10
  
  i <<- i
  library(doParallel)
  cl = makeCluster(10)
  clusterExport(cl,c('i','twsdf',
                     'era5_pme','era5_sst',
                     'pme3_ssp245',
                     'sst3_ssp245',
                     'pme1_ssp245',
                     'sst1_ssp245'))
  system.time(ret245 <- parLapply(cl,i,
                                  sub_train_fun245))
  stopCluster(cl)
  
  extract_mean_pred <- function(x){
    retmean = 1
    for(i in 1:10){
      retmean = cbind(retmean,x[[i]][,1])
    }
    retmean = retmean[,-1]
    colnames(retmean) = paste0('SW',1:10)
    return(retmean)
  }
  extract_max_pred <- function(x){
    retmax = 1
    for(i in 1:10){
      retmax = cbind(retmax,x[[i]][,2])
    }
    retmax = retmax[,-1]
    colnames(retmax) = paste0('SW',1:10)
    return(retmax)
  }
  extract_min_pred <- function(x){
    retmin = 1
    for(i in 1:10){
      retmin = cbind(retmin,x[[i]][,3])
    }
    retmin = retmin[,-1]
    colnames(retmin) = paste0('SW',1:10)
    return(retmin)
  }
  
  ret_mean = extract_mean_pred(ret245)
  ret_max = extract_max_pred(ret245)
  ret_min = extract_min_pred(ret245)
  
  
  date = seq(as.Date('2018-01-01'),
             as.Date('2050-06-01'),
             '1 month')
  ret_mean = data.frame(
    date =date,
    ret_mean
  )
  
  ret_max = data.frame(
    date = date,
    ret_max
  )
  
  ret_min = data.frame(
    date = date,
    ret_min 
  )
  
  ret_mean = reshape2::melt(ret_mean,'date')
  ret_max = reshape2::melt(ret_max,'date')
  ret_min = reshape2::melt(ret_min,'date')
  
  ret_maxmin = data.frame(
    ret_max[,1:2],
    max = ret_max[,3],
    min = ret_min[,3]
  )
  colnames(ret_mean) = c('date','variable','SSP245')
  
  return(list(ret_mean,ret_maxmin))
}
sub_train_based_era5_cmip6_ssp585 <- function(
  
){
  
  SWs = paste0('SW',1:10)
  path = 'analysis_output/figS8-11'
  dir.create(path)
  output_train_585 = paste0(path,'/train_ssp585')
  output_valid_585 = paste0(path,'/valid_ssp585')
  output_imp_585 = paste0(path,'/import_ssp585')
  
  dir.create(output_train_585)
  dir.create(output_valid_585)
  dir.create(output_imp_585)
  
  output_train_585 = paste0(output_train_585,'/',
                            SWs,'.csv')
  output_valid_585 = paste0(output_valid_585,'/',
                            SWs,'.csv')
  output_imp_585 = paste0(output_imp_585,
                          '/',SWs,'.csv')
  
  SWs<<- SWs
  output_train_585 <<- output_train_585
  output_valid_585 <<- output_valid_585
  output_imp_585<<- output_imp_585
  
  
  sub_train_fun585 <-function(i){
    print(i)
    tws_sw = twsdf[,i]
    naid = which(is.na(tws_sw))
    tws_sw = tws_sw[-naid]
    tws_sw <<- tws_sw
    
    # building up model between tws and 
    # grace 
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws_era5_cmip6.R')
    df = data.frame(
      tws = tws_sw,
      pme1 = era5_pme[,1],
      pme3 = era5_pme[,2]
      #sst1 = era5_sst[,1],
      #sst3 = era5_sst[,2]
    )
    
    pme1_pj585 = as.matrix(pme1_ssp585[175:576,])
    pme3_pj585 = as.matrix(pme3_ssp585[175:576,])
    #sst1_pj585 = as.matrix(sst1_ssp585[175:576,])
    sst3_pj585 = as.matrix(sst3_ssp585[175:576,])
    
    source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
    pme1_pj585 = trend_fun(pme1_pj585)
    pme3_pj585 = trend_fun(pme3_pj585)
    #sst1_pj585 = trend_fun(sst1_pj585)
    sst3_pj585 = trend_fun(sst3_pj585)
    
    naid = which(is.na(pme3_pj585[,1]))
    pme3_pj585 = pme3_pj585[-naid,]
    sst3_pj585 = sst3_pj585[-naid,]
    pme1_pj585 = pme1_pj585[-naid,]
    
    ret_box = random_forest_model_tws_era5_cmip6(df)
    ret_box_train = ret_box[[1]]
    ret_box_valid = ret_box[[2]]
    model_best = ret_box[[3]]
    
    impmat = model_best$importance
    
    colnames(ret_box_train) = c('TWS_OBS',
                                'TWS_PROJ')
    colnames(ret_box_valid) = c('TWS_OBS',
                                "TWS_PROJ")
    
    ret_box_train$SWs = SWs[i]
    ret_box_valid$SWs = SWs[i]
    
    library(data.table)
    fwrite(ret_box_train
           ,output_train_585[i])
    fwrite(ret_box_valid,
           output_valid_585[i])
    fwrite(impmat,
           output_imp_585[i])
    
    pred_mean_box = 1
    pred_max_box = 1
    pred_min_box = 1
    
    for(j in 1:ncol(pme3_pj585)){
      df_project = data.frame(
        pme1= pme1_pj585[,j],
        pme3 = pme3_pj585[,j]
        #sst3 = sst3_pj585[,j]
      )
      cl_con_inter <- function(x){
        c(mean(x),quantile(x,c(0.05,0.95)))
      }
      
      
      pred_tws = predict(model_best,
                         df_project,
                         predict.all = T)
      pred_box = t(apply(pred_tws$individual,
                         1,cl_con_inter))
      
      pred_mean = predict(model_best,
                          df_project)
      pred_max = pred_box[,3]
      pred_min = pred_box[,2]
        
      pred_mean_box = cbind(pred_mean_box,
                           pred_mean)
      pred_max_box = cbind(pred_max_box,
                           pred_max)
      pred_min_box = cbind(pred_min_box,
                           pred_min)
    }
    pred_mean_box = pred_mean_box[,-1]
    pred_min_box = pred_min_box[,-1]
    pred_max_box = pred_max_box[,-1]
    
    pred_mean = apply(pred_mean_box,1,mean)
    pred_max = apply(pred_max_box,1,mean)
    pred_min = apply(pred_min_box,1,mean)
    
    rets = data.frame(
      mean = pred_mean,
      max = pred_max,
      min = pred_min
    )  
    return(rets)
    
  }
  
  i = 1:10
  
  i <<- i
  library(doParallel)
  cl = makeCluster(10)
  clusterExport(cl,c('i','twsdf',
                     'era5_pme','era5_sst',
                     'pme3_ssp585',
                     'sst3_ssp585',
                     'pme1_ssp585',
                     'sst1_ssp585'))
  system.time(ret585 <- parLapply(cl,i,
                                  sub_train_fun585))
  stopCluster(cl)
  
  
  extract_mean_pred <- function(x){
    retmean = 1
    for(i in 1:10){
      retmean = cbind(retmean,x[[i]][,1])
    }
    retmean = retmean[,-1]
    colnames(retmean) = paste0('SW',1:10)
    return(retmean)
  }
  extract_max_pred <- function(x){
    retmax = 1
    for(i in 1:10){
      retmax = cbind(retmax,x[[i]][,2])
    }
    retmax = retmax[,-1]
    colnames(retmax) = paste0('SW',1:10)
    return(retmax)
  }
  extract_min_pred <- function(x){
    retmin = 1
    for(i in 1:10){
      retmin = cbind(retmin,x[[i]][,3])
    }
    retmin = retmin[,-1]
    colnames(retmin) = paste0('SW',1:10)
    return(retmin)
  }
  
  
  ret_mean = extract_mean_pred(ret585)
  ret_max = extract_max_pred(ret585)
  ret_min = extract_min_pred(ret585)
  
  
  date = seq(as.Date('2018-01-01'),
             as.Date('2050-06-01'),
             '1 month')
  ret_mean = data.frame(
    date =date,
    ret_mean
  )
  
  ret_max = data.frame(
    date = date,
    ret_max
  )
  
  ret_min = data.frame(
    date = date,
    ret_min 
  )
  
  ret_mean = reshape2::melt(ret_mean,'date')
  ret_max = reshape2::melt(ret_max,'date')
  ret_min = reshape2::melt(ret_min,'date')
  
  ret_maxmin = data.frame(
    ret_max[,1:2],
    max = ret_max[,3],
    min = ret_min[,3]
  )
  colnames(ret_mean) = c('date','variable','SSP585')
  
  return(list(ret_mean,ret_maxmin))
}
test_rm_var<-function(
  
){
  generate_random_df <- function(
    i
  ){
    d =runif(100000,i,1000)
    return(d)
  }
  
  for(i in 1:100){
    d = generate_random_df(i)
    d = cbind(d,d,d,d)
    fwrite(d,'test_mem.csv')
    rm(d)
    
  }
}
 traj_import <- function(
   
 ){
   library(data.table)
   input_traj = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
   input_traj = paste0(input_traj,'/output/mean_route_released/mean_route_released.csv')
   
   traj_df = lapply(input_traj,fread)
   traj_df = lapply(traj_df,as.data.frame)
   
   for(i in 1:length(traj_df)){
     yearmon = substr(input_traj[[i]],42,47)
     mon1 = as.numeric(substr(input_traj[[i]],46,47))
     
     mon = c('JAN','FEB','MAR','APR',
                    'MAY','JUN','JUL','AUG',
                    "SEP",'OCT','NOV','DEC')
     mon = mon[mon1]
     
     traj_df[[i]]$uni_id = paste0(traj_df[[i]]$source_name,'_',traj_df[[i]]$cluster,
                                  '_',yearmon)
     
     traj_df[[i]]$sou_mon = paste0(traj_df[[i]]$source_name,'_',mon)
     traj_df[[i]]$mon = mon
   }
   return(traj_df)
 }
traj_plot_fun_by_mon<-function(
  
  
){
  monname = c('JAN','FEB','MAR','APR','MAY',"JUN",
              'JUL',"AUG",'SEP','OCT','NOV',"DEC")
  input_monthly_traj = 'monthly_kmeans_traj'
  #dir.create(input_monthly_traj)
  input_monthly_traj = paste0(input_monthly_traj,'/',
                               monname,'.csv')
  
  df = lapply(input_monthly_traj,fread)
  traj_df_by_mon = do.call('rbind',df)
  traj_df_by_mon$group = paste0(traj_df_by_mon$month,'_',
                                traj_df_by_mon$routeid)
  
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management("world")
  world = crop(world,extent(-180,180,0,90))
  
  xj = shp_management('xinjiang')
  
  library(RColorBrewer)
  mycolor = colorRampPalette(brewer.pal(11,'Spectral'))(12)
  
  
  
  library(ggplot2)
  # Trajectory Plot
  #####
  p = ggplot()+
    geom_polygon(data = world,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 1)+
    geom_polygon(data = xj,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 1)+
    geom_path(data = traj_df_by_mon,aes(x = long,y = lat,
                                        group = group,
                                        color = month))+
    scale_color_manual(values = mycolor)+
    facet_wrap(~month,nrow = 4)+
    theme_bw()
  #####
  return()
  
}
trend_fun <- function(x){
  
  sub_fun_his <-function(x){
    x = ts(x,start = c(2003,1),
           frequency = 12)
    x = decompose(x)$trend
    
    xt = as.numeric(x)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }
  sub_fun_fut <-function(x){
    x = ts(x,start = c(2017,7),
           frequency = 12)
    x = decompose(x)$trend
    
    xt = as.numeric(x)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }
  
  
  if(is.null(ncol(x))){
    x = as.numeric(x)
    if(length(x)<=174){
      xm = sub_fun_his(x)
    }else{
      xm = sub_fun_fut(x)
    }
    
  }else{
    if(nrow(x)<=174){
      xm = apply(x,2,sub_fun_his)
    }else{
      xm = apply(x,2,sub_fun_fut)
    }
    
    
  }
  return(xm)
}
trend_funRaster <-function(x){
  x = as.numeric(x)
  xtell = mean(x)
  if(is.na(xtell)){
    x = NA
  }else{
    xt = ts(x,start = c(2003,1),
            frequency = 12)
    xt = decompose(xt)$trend
    xt = as.numeric(xt)
    naid = which(is.na(xt))
    xt = xt[-naid]
    xt = as.numeric(xt)
    xt = xt/(max(xt) - min(xt))
    source('/home/share/R_project/xinjiang_vapor/mmkTrend.R')
    
    mmk = mmkTrend(xt)$Zc
    mmk = as.numeric(mmk)
    x = mmk
  }
  return(x)
}
trend_index<-function(
  x,
  start=c(2003,1),
  fre = 12
){
  
  xts = ts(x,start = start,frequency = fre)
  xtrend = decompose(xts)$trend
  naid = which(is.na(xtrend))
  xtrend =xtrend[-naid]
  return(xtrend)
}
tws_mmk_analysis <-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  
  tws = data_management('grace')
  library(raster)
  mmk_cal <-function(x){
    source('/home/share/R_project/xinjiang_vapor/mmkTrend.R')
    if(!anyNA(x)){
      mt = mmkTrend(x)$Zc
    }else{
      mt = NA
    }
    return(mt)
  }
  xj = shp_management('xinjiang')
  
  tws = crop(tws,xj)
  tws = mask(tws,xj)
  
  tws_mmk = calc(tws,mmk_cal)
  
  
  beginCluster(12)
  z1 <- clusterR(tws,calc,args = list(fun = mmk_cal),export = 'tws')
  endCluster()
  
}
validate_cmip6_pme_linear <-function(
  
){
  dir.create('analysis_output/fig4/pme_linear')
  library(data.table)
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  source('/home/share/R_project/xinjiang_vapor/source_id_identify.R')
  
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:180,]
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:180,]
  
  era5_pme = pe_in_source[,c(5,7)] - pet_sum[,c(5,7)]
  
  input_pme_cmip6 = list.files('analysis_output/cmip6_by_model/pme',
                               full.names = T)
  pme_cmip6 = lapply(lapply(input_pme_cmip6,fread),as.data.frame)
  
  pme1_ssp245_train = pme_cmip6[[1]][1:180,]
  pme1_ssp585_train = pme_cmip6[[2]][1:180,]
  pme3_ssp245_train = pme_cmip6[[3]][1:180,]
  pme3_ssp585_train = pme_cmip6[[4]][1:180,]
  
  pme1_ssp245_proj = pme_cmip6[[1]][181:576,]
  pme1_ssp585_proj = pme_cmip6[[2]][181:576,]
  pme3_ssp245_proj = pme_cmip6[[3]][181:576,]
  pme3_ssp585_proj = pme_cmip6[[4]][181:576,]
  
  pme1_ssp245_train<<- pme1_ssp245_train
  pme1_ssp585_train <<- pme1_ssp585_train
  pme3_ssp245_train<<- pme3_ssp245_train
  pme3_ssp585_train <<- pme3_ssp585_train
  pme1_ssp245_proj <<- pme1_ssp245_proj
  pme1_ssp585_proj <<- pme1_ssp585_proj
  pme3_ssp245_proj <<- pme3_ssp245_proj
  pme3_ssp585_proj <<- pme3_ssp585_proj
  
  i = 1:ncol(pme1_ssp245_train)
  correct_fun1_ssp245 <-function(i){
    df = data.frame(
      pr = era5_pme[,1],
      cmip6 = pme1_ssp245_train[,i]
    )
    df_project = data.frame(
      cmip6 = pme1_ssp245_proj[,i]
    )
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_pr_cmip6.R')
    ret = random_forest_model_pr_cmip6(df,df_project)
    return(ret)
  }
  correct_fun1_ssp585 <-function(i){
    df = data.frame(
      pr = era5_pme[,1],
      cmip6 = pme1_ssp585_train[,i]
    )
    df_project = data.frame(
      cmip6 = pme1_ssp585_proj[,i]
    )
    #source('/home/share/R_project/xinjiang_vapor/random_forest_model_pr_cmip6.R')
    ret = random_forest_model_pr_cmip6(df,df_project)
    return(ret)
  }
  correct_fun3_ssp245 <-function(i){
    df = data.frame(
      pr = era5_pme[,2],
      cmip6 = pme3_ssp245_train[,i]
    )
    df_project = data.frame(
      cmip6 = pme3_ssp245_proj[,i]
    )
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_pr_cmip6.R')
    ret = random_forest_model_pr_cmip6(df,df_project)
    return(ret)
  }
  correct_fun3_ssp585 <-function(i){
    df = data.frame(
      pr = era5_pme[,2],
      cmip6 = pme3_ssp585_train[,i]
    )
    df_project = data.frame(
      cmip6 = pme3_ssp585_proj[,i]
    )
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_pr_cmip6.R')
    ret = random_forest_model_pr_cmip6(df,df_project)
    return(ret)
  }
  
  ret1_245 = lapply(i,correct_fun1_ssp245)
  ret1_585 = lapply(i,correct_fun1_ssp585)
  ret3_245 = lapply(i,correct_fun3_ssp245)
  ret3_585 = lapply(i,correct_fun3_ssp585)
  
  ret1_245 <<- ret1_245
  ret1_585 <<- ret1_585
  ret3_585 <<- ret3_585
  ret3_245 <<- ret3_245
  
  i = 1:ncol(pme1_ssp245_train)
  extract_train1_pr245 <- function(i){
    if(i!=1){
      tmp = ret1_245[[i]][[1]][,2]
    }else{
      tmp = ret1_245[[i]][[1]]
    }
    return(tmp)
  }
  extract_train1_pr585 <- function(i){
    if(i !=1){
      tmp = ret1_585[[i]][[1]][,2]
      
    }else{
      tmp = ret1_585[[i]][[1]]
      
    }
    return(tmp)
  }
  extract_train3_pr245 <- function(i){
    if(i !=1){
      tmp = ret3_245[[i]][[1]][,2]
    }else{
      tmp = ret3_245[[i]][[1]]
    }
    
    return(tmp)
  }
  extract_train3_pr585 <- function(i){
    if(i !=1){
      tmp = ret3_585[[i]][[1]][,2]
    }else{
      tmp = ret3_585[[i]][[1]]
    }
    
    return(tmp)
  }
  ret1_245_train = lapply(i,extract_train1_pr245)
  ret3_245_train = lapply(i,extract_train3_pr245)
  ret1_585_train = lapply(i,extract_train1_pr585)
  ret3_585_train = lapply(i,extract_train3_pr585)
  
  ret1_245_train = do.call(cbind,ret1_245_train)
  ret3_245_train = do.call(cbind,ret3_245_train)
  ret1_585_train = do.call(cbind,ret1_585_train)
  ret3_585_train = do.call(cbind,ret3_585_train)
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(ret1_245_train) = c('ERA5',modelnames)
  colnames(ret3_245_train) = c('ERA5',modelnames)
  colnames(ret1_585_train) = c('ERA5',modelnames)
  colnames(ret3_585_train) = c('ERA5',modelnames)
  
  datefull = seq(as.Date('2003-01-01'),
                 as.Date('2050-12-01'),
                 '1 month')
  
  ret1_245_train = data.frame(date = datefull[1:126],
                              ret1_245_train)
  ret1_585_train = data.frame(date = datefull[1:126],
                              ret1_585_train)
  ret3_245_train = data.frame(date = datefull[1:126],
                              ret3_245_train)
  ret3_585_train = data.frame(date = datefull[1:126],
                              ret3_585_train)
  
  fwrite(ret1_245_train,'analysis_output/fig4/pme/pme_ato1_245_train.csv')
  fwrite(ret1_585_train,'analysis_output/fig4/pme/pme_ato1_585_train.csv')
  fwrite(ret3_245_train,'analysis_output/fig4/pme/pme_ato3_245_train.csv')
  fwrite(ret3_585_train,'analysis_output/fig4/pme/pme_ato3_585_train.csv')
  
  
  df1 = reshape2::melt(ret1_245_train,'date')
  df2 = reshape2::melt(ret1_585_train,'date')
  df3 = reshape2::melt(ret3_245_train,'date')
  df4 = reshape2::melt(ret3_585_train,'date')
  
  er1 = ret1_245_train[,1:2]
  er3 = ret3_245_train[,1:2]
  
  p1 = ggplot()+
    geom_line(data = df1,
              aes(x = date,
                  y = value,
                  color = variable))+
    geom_line(data = er1,
              aes(x = date,y = ERA5),
              color = 'black',size = 1)+
    scale_color_npg()+
    facet_wrap(~variable,nrow = 2)+
    theme_bw()
  
  # fut 
  i = 1:ncol(pme1_ssp245_train)
  extract_fut1_pr245 <- function(i){
    if(i!=1){
      tmp = ret1_245[[i]][[3]]
    }else{
      tmp = ret1_245[[i]][[3]]
    }
    return(tmp)
  }
  extract_fut1_pr585 <- function(i){
    if(i !=1){
      tmp = ret1_585[[i]][[3]]
      
    }else{
      tmp = ret1_585[[i]][[3]]
      
    }
    return(tmp)
  }
  extract_fut3_pr245 <- function(i){
    if(i !=1){
      tmp = ret3_245[[i]][[3]]
    }else{
      tmp = ret3_245[[i]][[3]]
    }
    
    return(tmp)
  }
  extract_fut3_pr585 <- function(i){
    if(i !=1){
      tmp = ret3_585[[i]][[3]]
    }else{
      tmp = ret3_585[[i]][[3]]
    }
    
    return(tmp)
  }
  
  
  ret_fut1_245 = lapply(i,extract_fut1_pr245)
  ret_fut1_585 = lapply(i,extract_fut1_pr585)
  ret_fut3_245 = lapply(i,extract_fut3_pr245)
  ret_fut3_585 = lapply(i,extract_fut3_pr585)
  
  ret_fut1_245 <<- ret_fut1_245
  ret_fut1_585 <<- ret_fut1_585
  ret_fut3_245 <<- ret_fut3_245
  ret_fut3_585 <<- ret_fut3_585
  
  ret_to_df1 <-function(i){
    x = ret_fut1_245[[i]][,2]
    return(x)
  }
  ret_to_df2 <-function(i){
    x = ret_fut1_585[[i]][,2]
    return(x)
  }
  ret_to_df3 <-function(i){
    x = ret_fut3_245[[i]][,2]
    return(x)
  }
  ret_to_df4 <-function(i){
    x = ret_fut3_585[[i]][,2]
    return(x)
  }
  
  df_fut1 = data.frame(
    ret_fut1_245[[1]],
    do.call('cbind',lapply(i,ret_to_df1))[,-1]
  )
  df_fut2 = data.frame(
    ret_fut1_585[[1]],
    do.call('cbind',lapply(i,ret_to_df2))[,-1]
  )
  
  df_fut3 = data.frame(
    ret_fut3_245[[1]],
    do.call('cbind',lapply(i,ret_to_df3))[,-1]
  )
  df_fut4 = data.frame(
    ret_fut3_585[[1]],
    do.call('cbind',lapply(i,ret_to_df4))[,-1]
  )
  
  #df_fut1 = trend_fun_fut(df_fut1)
  #df_fut2 = trend_fun_fut(df_fut2)
  #df_fut3 = trend_fun_fut(df_fut3)
  #df_fut4 = trend_fun_fut(df_fut4)
  
  colnames(df_fut1) = c('date',modelnames)
  colnames(df_fut2) = c('date',modelnames)
  colnames(df_fut3) = c('date',modelnames)
  colnames(df_fut4) = c('date',modelnames)
  
  df_fut1m = reshape2::melt(df_fut1,'date')
  df_fut2m = reshape2::melt(df_fut2,'date')
  df_fut3m = reshape2::melt(df_fut3,'date')
  df_fut4m = reshape2::melt(df_fut4,'date')
  
  df_fut1m$type = 'SSP245_Pr1'
  df_fut2m$type = 'SSP585_Pr1'
  df_fut3m$type = 'SSP245_Pr3'
  df_fut4m$type = 'SSP585_Pr3'
  
  dffutm = rbind(df_fut1m,df_fut2m,
                 df_fut3m,df_fut4m)
  
  dir.create('analysis_output/fig4/pme')
  fwrite(df_fut1,'analysis_output/fig4/pme/pme_ato1_ssp245_proj.csv')
  fwrite(df_fut2,'analysis_output/fig4/pme/pme_ato1_ssp585_proj.csv')
  fwrite(df_fut3,'analysis_output/fig4/pme/pme_ato3_ssp245_proj.csv')
  fwrite(df_fut4,'analysis_output/fig4/pme/pme_ato3_ssp585_proj.csv')
  
  
  p = ggplot()+
    geom_line(data = dffutm,
              aes(x = date,y= value,
                  color = type,
                  group = type),
              size = 1)+
    scale_color_npg()+
    facet_wrap(~variable,nrow = 4)+
    theme_bw()
  
  extract_test1_pr245 <- function(i){
    if(i!=1){
      tmp = ret1_245[[i]][[2]][,2]
    }else{
      tmp = ret1_245[[i]][[2]]
    }
    return(tmp)
  }
  extract_test1_pr585 <- function(i){
    if(i !=1){
      tmp = ret1_585[[i]][[2]][,2]
      
    }else{
      tmp = ret1_585[[i]][[2]]
      
    }
    return(tmp)
  }
  extract_test3_pr245 <- function(i){
    if(i !=1){
      tmp = ret3_245[[i]][[2]][,2]
    }else{
      tmp = ret3_245[[i]][[2]]
    }
    
    return(tmp)
  }
  extract_test3_pr585 <- function(i){
    if(i !=1){
      tmp = ret3_585[[i]][[2]][,2]
    }else{
      tmp = ret3_585[[i]][[2]]
    }
    
    return(tmp)
  }
  
  ret1_245_test = lapply(i,extract_test1_pr245)
  ret1_585_test = lapply(i,extract_test1_pr585)
  ret3_245_test = lapply(i,extract_test3_pr245)
  ret3_585_test = lapply(i,extract_test3_pr585)
  
  ret1_245_test = do.call(cbind,ret1_245_test)
  ret3_245_test = do.call(cbind,ret3_245_test)
  ret1_585_test = do.call(cbind,ret1_585_test)
  ret3_585_test = do.call(cbind,ret3_585_test)
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(ret1_245_test) = c('ERA5',modelnames)
  colnames(ret3_245_test) = c('ERA5',modelnames)
  colnames(ret1_585_test) = c('ERA5',modelnames)
  colnames(ret3_585_test) = c('ERA5',modelnames)
  
  datefull = seq(as.Date('2003-01-01'),
                 as.Date('2050-12-01'),
                 '1 month')
  
  ret1_245_test = data.frame(date = datefull[127:180],
                             ret1_245_test)
  ret1_585_test = data.frame(date = datefull[127:180],
                             ret1_585_test)
  ret3_245_test = data.frame(date = datefull[127:180],
                             ret3_245_test)
  ret3_585_test = data.frame(date = datefull[127:180],
                             ret3_585_test)
  
  fwrite(ret1_245_test,'analysis_output/fig4/pme/pme_ato1_245_test.csv')
  fwrite(ret1_585_test,'analysis_output/fig4/pme/pme_ato1_585_test.csv')
  fwrite(ret3_245_test,'analysis_output/fig4/pme/pme_ato3_245_test.csv')
  fwrite(ret3_585_test,'analysis_output/fig4/pme/pme_ato3_585_test.csv')
  
}







validate_cmip6_pme <-function(
  
){
  dir.create('analysis_output/fig4/pme')
  library(data.table)
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  source('/home/share/R_project/xinjiang_vapor/source_id_identify.R')
  
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:180,]
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:180,]
  
  era5_pme = pe_in_source[,c(5,7)] - pet_sum[,c(5,7)]
  
  input_pme_cmip6 = list.files('analysis_output/cmip6_by_model/pme',
                         full.names = T)
  pme_cmip6 = lapply(lapply(input_pme_cmip6,fread),as.data.frame)
  
  pme1_ssp245_train = pme_cmip6[[1]][1:180,]
  pme1_ssp585_train = pme_cmip6[[2]][1:180,]
  pme3_ssp245_train = pme_cmip6[[3]][1:180,]
  pme3_ssp585_train = pme_cmip6[[4]][1:180,]
  
  pme1_ssp245_proj = pme_cmip6[[1]][181:576,]
  pme1_ssp585_proj = pme_cmip6[[2]][181:576,]
  pme3_ssp245_proj = pme_cmip6[[3]][181:576,]
  pme3_ssp585_proj = pme_cmip6[[4]][181:576,]
  
  pme1_ssp245_train<<- pme1_ssp245_train
  pme1_ssp585_train <<- pme1_ssp585_train
  pme3_ssp245_train<<- pme3_ssp245_train
  pme3_ssp585_train <<- pme3_ssp585_train
  pme1_ssp245_proj <<- pme1_ssp245_proj
  pme1_ssp585_proj <<- pme1_ssp585_proj
  pme3_ssp245_proj <<- pme3_ssp245_proj
  pme3_ssp585_proj <<- pme3_ssp585_proj
  
  i = 1:ncol(pme1_ssp245_train)
  correct_fun1_ssp245 <-function(i){
    df = data.frame(
      pr = era5_pme[,1],
      cmip6 = pme1_ssp245_train[,i]
    )
    df_project = data.frame(
      cmip6 = pme1_ssp245_proj[,i]
    )
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_pr_cmip6.R')
    ret = random_forest_model_pr_cmip6(df,df_project)
    return(ret)
  }
  correct_fun1_ssp585 <-function(i){
    df = data.frame(
      pr = era5_pme[,1],
      cmip6 = pme1_ssp585_train[,i]
    )
    df_project = data.frame(
      cmip6 = pme1_ssp585_proj[,i]
    )
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_pr_cmip6.R')
    ret = random_forest_model_pr_cmip6(df,df_project)
    return(ret)
  }
  correct_fun3_ssp245 <-function(i){
    df = data.frame(
      pr = era5_pme[,2],
      cmip6 = pme3_ssp245_train[,i]
    )
    df_project = data.frame(
      cmip6 = pme3_ssp245_proj[,i]
    )
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_pr_cmip6.R')
    ret = random_forest_model_pr_cmip6(df,df_project)
    return(ret)
  }
  correct_fun3_ssp585 <-function(i){
    df = data.frame(
      pr = era5_pme[,2],
      cmip6 = pme3_ssp585_train[,i]
    )
    df_project = data.frame(
      cmip6 = pme3_ssp585_proj[,i]
    )
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_pr_cmip6.R')
    ret = random_forest_model_pr_cmip6(df,df_project)
    return(ret)
  }
  
  ret1_245 = lapply(i,correct_fun1_ssp245)
  ret1_585 = lapply(i,correct_fun1_ssp585)
  ret3_245 = lapply(i,correct_fun3_ssp245)
  ret3_585 = lapply(i,correct_fun3_ssp585)
  
  ret1_245 <<- ret1_245
  ret1_585 <<- ret1_585
  ret3_585 <<- ret3_585
  ret3_245 <<- ret3_245
  
  i = 1:ncol(pme1_ssp245_train)
  extract_train1_pr245 <- function(i){
    if(i!=1){
      tmp = ret1_245[[i]][[1]][,2]
    }else{
      tmp = ret1_245[[i]][[1]]
    }
    return(tmp)
  }
  extract_train1_pr585 <- function(i){
    if(i !=1){
      tmp = ret1_585[[i]][[1]][,2]
      
    }else{
      tmp = ret1_585[[i]][[1]]
      
    }
    return(tmp)
  }
  extract_train3_pr245 <- function(i){
    if(i !=1){
      tmp = ret3_245[[i]][[1]][,2]
    }else{
      tmp = ret3_245[[i]][[1]]
    }
    
    return(tmp)
  }
  extract_train3_pr585 <- function(i){
    if(i !=1){
      tmp = ret3_585[[i]][[1]][,2]
    }else{
      tmp = ret3_585[[i]][[1]]
    }
    
    return(tmp)
  }
  ret1_245_train = lapply(i,extract_train1_pr245)
  ret3_245_train = lapply(i,extract_train3_pr245)
  ret1_585_train = lapply(i,extract_train1_pr585)
  ret3_585_train = lapply(i,extract_train3_pr585)
  
  ret1_245_train = do.call(cbind,ret1_245_train)
  ret3_245_train = do.call(cbind,ret3_245_train)
  ret1_585_train = do.call(cbind,ret1_585_train)
  ret3_585_train = do.call(cbind,ret3_585_train)
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(ret1_245_train) = c('ERA5',modelnames)
  colnames(ret3_245_train) = c('ERA5',modelnames)
  colnames(ret1_585_train) = c('ERA5',modelnames)
  colnames(ret3_585_train) = c('ERA5',modelnames)
  
  datefull = seq(as.Date('2003-01-01'),
             as.Date('2050-12-01'),
             '1 month')
  
  ret1_245_train = data.frame(date = datefull[1:126],
                              ret1_245_train)
  ret1_585_train = data.frame(date = datefull[1:126],
                              ret1_585_train)
  ret3_245_train = data.frame(date = datefull[1:126],
                              ret3_245_train)
  ret3_585_train = data.frame(date = datefull[1:126],
                              ret3_585_train)
  
  fwrite(ret1_245_train,'analysis_output/fig4/pme/pme_ato1_245_train.csv')
  fwrite(ret1_585_train,'analysis_output/fig4/pme/pme_ato1_585_train.csv')
  fwrite(ret3_245_train,'analysis_output/fig4/pme/pme_ato3_245_train.csv')
  fwrite(ret3_585_train,'analysis_output/fig4/pme/pme_ato3_585_train.csv')
  
  
  df1 = reshape2::melt(ret1_245_train,'date')
  df2 = reshape2::melt(ret1_585_train,'date')
  df3 = reshape2::melt(ret3_245_train,'date')
  df4 = reshape2::melt(ret3_585_train,'date')

  er1 = ret1_245_train[,1:2]
  er3 = ret3_245_train[,1:2]
  
  p1 = ggplot()+
    geom_line(data = df1,
              aes(x = date,
                  y = value,
                  color = variable))+
    geom_line(data = er1,
              aes(x = date,y = ERA5),
              color = 'black',size = 1)+
    scale_color_npg()+
    facet_wrap(~variable,nrow = 2)+
    theme_bw()
    
  # fut 
  i = 1:ncol(pme1_ssp245_train)
  extract_fut1_pr245 <- function(i){
    if(i!=1){
      tmp = ret1_245[[i]][[3]]
    }else{
      tmp = ret1_245[[i]][[3]]
    }
    return(tmp)
  }
  extract_fut1_pr585 <- function(i){
    if(i !=1){
      tmp = ret1_585[[i]][[3]]
      
    }else{
      tmp = ret1_585[[i]][[3]]
      
    }
    return(tmp)
  }
  extract_fut3_pr245 <- function(i){
    if(i !=1){
      tmp = ret3_245[[i]][[3]]
    }else{
      tmp = ret3_245[[i]][[3]]
    }
    
    return(tmp)
  }
  extract_fut3_pr585 <- function(i){
    if(i !=1){
      tmp = ret3_585[[i]][[3]]
    }else{
      tmp = ret3_585[[i]][[3]]
    }
    
    return(tmp)
  }
  
  
  ret_fut1_245 = lapply(i,extract_fut1_pr245)
  ret_fut1_585 = lapply(i,extract_fut1_pr585)
  ret_fut3_245 = lapply(i,extract_fut3_pr245)
  ret_fut3_585 = lapply(i,extract_fut3_pr585)
  
  ret_fut1_245 <<- ret_fut1_245
  ret_fut1_585 <<- ret_fut1_585
  ret_fut3_245 <<- ret_fut3_245
  ret_fut3_585 <<- ret_fut3_585
  
  ret_to_df1 <-function(i){
    x = ret_fut1_245[[i]][,2]
    return(x)
  }
  ret_to_df2 <-function(i){
    x = ret_fut1_585[[i]][,2]
    return(x)
  }
  ret_to_df3 <-function(i){
    x = ret_fut3_245[[i]][,2]
    return(x)
  }
  ret_to_df4 <-function(i){
    x = ret_fut3_585[[i]][,2]
    return(x)
  }
  
  df_fut1 = data.frame(
    ret_fut1_245[[1]],
    do.call('cbind',lapply(i,ret_to_df1))[,-1]
  )
  df_fut2 = data.frame(
    ret_fut1_585[[1]],
    do.call('cbind',lapply(i,ret_to_df2))[,-1]
  )
  
  df_fut3 = data.frame(
    ret_fut3_245[[1]],
    do.call('cbind',lapply(i,ret_to_df3))[,-1]
  )
  df_fut4 = data.frame(
    ret_fut3_585[[1]],
    do.call('cbind',lapply(i,ret_to_df4))[,-1]
  )
  
  #df_fut1 = trend_fun_fut(df_fut1)
  #df_fut2 = trend_fun_fut(df_fut2)
  #df_fut3 = trend_fun_fut(df_fut3)
  #df_fut4 = trend_fun_fut(df_fut4)
  
  colnames(df_fut1) = c('date',modelnames)
  colnames(df_fut2) = c('date',modelnames)
  colnames(df_fut3) = c('date',modelnames)
  colnames(df_fut4) = c('date',modelnames)
  
  df_fut1m = reshape2::melt(df_fut1,'date')
  df_fut2m = reshape2::melt(df_fut2,'date')
  df_fut3m = reshape2::melt(df_fut3,'date')
  df_fut4m = reshape2::melt(df_fut4,'date')
  
  df_fut1m$type = 'SSP245_Pr1'
  df_fut2m$type = 'SSP585_Pr1'
  df_fut3m$type = 'SSP245_Pr3'
  df_fut4m$type = 'SSP585_Pr3'
  
  dffutm = rbind(df_fut1m,df_fut2m,
                 df_fut3m,df_fut4m)
  
  dir.create('analysis_output/fig4/pme')
  fwrite(df_fut1,'analysis_output/fig4/pme/pme_ato1_ssp245_proj.csv')
  fwrite(df_fut2,'analysis_output/fig4/pme/pme_ato1_ssp585_proj.csv')
  fwrite(df_fut3,'analysis_output/fig4/pme/pme_ato3_ssp245_proj.csv')
  fwrite(df_fut4,'analysis_output/fig4/pme/pme_ato3_ssp585_proj.csv')
  
  
    p = ggplot()+
      geom_line(data = dffutm,
                aes(x = date,y= value,
                    color = type,
                    group = type),
                size = 1)+
      scale_color_npg()+
      facet_wrap(~variable,nrow = 4)+
      theme_bw()
  
  extract_test1_pr245 <- function(i){
      if(i!=1){
        tmp = ret1_245[[i]][[2]][,2]
      }else{
        tmp = ret1_245[[i]][[2]]
      }
      return(tmp)
    }
  extract_test1_pr585 <- function(i){
      if(i !=1){
        tmp = ret1_585[[i]][[2]][,2]
        
      }else{
        tmp = ret1_585[[i]][[2]]
        
      }
      return(tmp)
    }
  extract_test3_pr245 <- function(i){
      if(i !=1){
        tmp = ret3_245[[i]][[2]][,2]
      }else{
        tmp = ret3_245[[i]][[2]]
      }
      
      return(tmp)
    }
  extract_test3_pr585 <- function(i){
      if(i !=1){
        tmp = ret3_585[[i]][[2]][,2]
      }else{
        tmp = ret3_585[[i]][[2]]
      }
      
      return(tmp)
    }
    
  ret1_245_test = lapply(i,extract_test1_pr245)
  ret1_585_test = lapply(i,extract_test1_pr585)
  ret3_245_test = lapply(i,extract_test3_pr245)
  ret3_585_test = lapply(i,extract_test3_pr585)
  
  ret1_245_test = do.call(cbind,ret1_245_test)
  ret3_245_test = do.call(cbind,ret3_245_test)
  ret1_585_test = do.call(cbind,ret1_585_test)
  ret3_585_test = do.call(cbind,ret3_585_test)
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(ret1_245_test) = c('ERA5',modelnames)
  colnames(ret3_245_test) = c('ERA5',modelnames)
  colnames(ret1_585_test) = c('ERA5',modelnames)
  colnames(ret3_585_test) = c('ERA5',modelnames)
  
  datefull = seq(as.Date('2003-01-01'),
                 as.Date('2050-12-01'),
                 '1 month')
  
  ret1_245_test = data.frame(date = datefull[127:180],
                             ret1_245_test)
  ret1_585_test = data.frame(date = datefull[127:180],
                             ret1_585_test)
  ret3_245_test = data.frame(date = datefull[127:180],
                             ret3_245_test)
  ret3_585_test = data.frame(date = datefull[127:180],
                             ret3_585_test)
  
  fwrite(ret1_245_test,'analysis_output/fig4/pme/pme_ato1_245_test.csv')
  fwrite(ret1_585_test,'analysis_output/fig4/pme/pme_ato1_585_test.csv')
  fwrite(ret3_245_test,'analysis_output/fig4/pme/pme_ato3_245_test.csv')
  fwrite(ret3_585_test,'analysis_output/fig4/pme/pme_ato3_585_test.csv')
  
}







validate_cmip6_sst <-function(
  
){
  library(data.table)
  sst_in_source1 = fread('era5_sst_mean/ato/region1/era5_sst_mean.csv')
  sst_in_source3 = fread('era5_sst_mean/ato/region3/era5_sst_mean.csv')
  
  sst_in_source1 = as.data.frame(sst_in_source1)
  sst_in_source3 = as.data.frame(sst_in_source3)
  
  sst_in_source = data.frame(
    sst1 = sst_in_source1[,1],
    sst3 = sst_in_source3[,1])
  
  input_sst = list.files('analysis_output/cmip6_by_model/sst',
                         full.names = T)
  
  sst = lapply(lapply(input_sst,fread),as.data.frame)
  
  sst1_ssp245_train = sst[[1]][1:180,]
  sst1_ssp585_train = sst[[2]][1:180,]
  sst3_ssp245_train = sst[[3]][1:180,]
  sst3_ssp585_train = sst[[4]][1:180,]
  
  sst1_ssp245_proj = sst[[1]][181:576,]
  sst1_ssp585_proj = sst[[2]][181:576,]
  sst3_ssp245_proj = sst[[3]][181:576,]
  sst3_ssp585_proj = sst[[4]][181:576,]
  
  sst1_ssp245_train<<- sst1_ssp245_train
  sst1_ssp585_train <<- sst1_ssp585_train
  sst3_ssp245_train<<- sst3_ssp245_train
  sst3_ssp585_train <<- sst3_ssp585_train
  sst1_ssp245_proj <<- sst1_ssp245_proj
  sst1_ssp585_proj <<- sst1_ssp585_proj
  sst3_ssp245_proj <<- sst3_ssp245_proj
  sst3_ssp585_proj <<- sst3_ssp585_proj
  
  i = 1:ncol(sst1_ssp245_train)
  correct_fun1_ssp245 <-function(i){
    df = data.frame(
      sst = sst_in_source[,1],
      cmip6 = sst1_ssp245_train[,i]
    )
    df_project = data.frame(
      cmip6 = sst1_ssp245_proj[,i]
    )
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_sst_cmip6.R')
    ret = random_forest_model_sst_cmip6(df,df_project)
    return(ret)
  }
  correct_fun1_ssp585 <-function(i){
    df = data.frame(
      sst = sst_in_source[,1],
      cmip6 = sst1_ssp585_train[,i]
    )
    df_project = data.frame(
      cmip6 = sst1_ssp585_proj[,i]
    )
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_sst_cmip6.R')
    ret = random_forest_model_sst_cmip6(df,df_project)
    return(ret)
  }
  correct_fun3_ssp245 <-function(i){
    df = data.frame(
      sst = sst_in_source[,2],
      cmip6 = sst3_ssp245_train[,i]
    )
    df_project = data.frame(
      cmip6 = sst3_ssp245_proj[,i]
    )
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_sst_cmip6.R')
    ret = random_forest_model_sst_cmip6(df,df_project)
    return(ret)
  }
  correct_fun3_ssp585 <-function(i){
    df = data.frame(
      sst = sst_in_source[,2],
      cmip6 = sst3_ssp585_train[,i]
    )
    df_project = data.frame(
      cmip6 = sst3_ssp585_proj[,i]
    )
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_sst_cmip6.R')
    ret = random_forest_model_sst_cmip6(df,df_project)
    return(ret)
  }
  
  ret1_245 = lapply(i,correct_fun1_ssp245)
  ret1_585 = lapply(i,correct_fun1_ssp585)
  ret3_245 = lapply(i,correct_fun3_ssp245)
  ret3_585 = lapply(i,correct_fun3_ssp585)
  
  ret1_245 <<- ret1_245
  ret1_585 <<- ret1_585
  ret3_585 <<- ret3_585
  ret3_245 <<- ret3_245
  
  i = 1:ncol(sst1_ssp245_train)
  extract_train1_pr245 <- function(i){
    if(i!=1){
      tmp = ret1_245[[i]][[1]][,2]
    }else{
      tmp = ret1_245[[i]][[1]]
    }
    return(tmp)
  }
  extract_train1_pr585 <- function(i){
    if(i !=1){
      tmp = ret1_585[[i]][[1]][,2]
      
    }else{
      tmp = ret1_585[[i]][[1]]
      
    }
    return(tmp)
  }
  extract_train3_pr245 <- function(i){
    if(i !=1){
      tmp = ret3_245[[i]][[1]][,2]
    }else{
      tmp = ret3_245[[i]][[1]]
    }
    
    return(tmp)
  }
  extract_train3_pr585 <- function(i){
    if(i !=1){
      tmp = ret3_585[[i]][[1]][,2]
    }else{
      tmp = ret3_585[[i]][[1]]
    }
    
    return(tmp)
  }
  
  ret1_245_train = lapply(i,extract_train1_pr245)
  ret3_245_train = lapply(i,extract_train3_pr245)
  ret1_585_train = lapply(i,extract_train1_pr585)
  ret3_585_train = lapply(i,extract_train3_pr585)
  
  ret1_245_train = do.call(cbind,ret1_245_train)
  ret3_245_train = do.call(cbind,ret3_245_train)
  ret1_585_train = do.call(cbind,ret1_585_train)
  ret3_585_train = do.call(cbind,ret3_585_train)
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(ret1_245_train) = c('ERA5',modelnames)
  colnames(ret3_245_train) = c('ERA5',modelnames)
  colnames(ret1_585_train) = c('ERA5',modelnames)
  colnames(ret3_585_train) = c('ERA5',modelnames)
  
  datefull = seq(as.Date('2003-01-01'),
                 as.Date('2050-12-01'),
                 '1 month')
  
  ret1_245_train = data.frame(date = datefull[1:126],
                              ret1_245_train)
  ret1_585_train = data.frame(date = datefull[1:126],
                              ret1_585_train)
  ret3_245_train = data.frame(date = datefull[1:126],
                              ret3_245_train)
  ret3_585_train = data.frame(date = datefull[1:126],
                              ret3_585_train)
  
  dir.create('analysis_output/fig4/sst')
  fwrite(ret1_245_train,'analysis_output/fig4/sst/sst_ato1_245_train.csv')
  fwrite(ret1_585_train,'analysis_output/fig4/sst/sst_ato1_585_train.csv')
  fwrite(ret3_245_train,'analysis_output/fig4/sst/sst_ato3_245_train.csv')
  fwrite(ret3_585_train,'analysis_output/fig4/sst/sst_ato3_585_train.csv')
  
  
  df1 = reshape2::melt(ret1_245_train,'date')
  df2 = reshape2::melt(ret1_585_train,'date')
  df3 = reshape2::melt(ret3_245_train,'date')
  df4 = reshape2::melt(ret3_585_train,'date')
  
  er1 = ret1_245_train[,1:2]
  er3 = ret3_245_train[,1:2]
  
  p1 = ggplot()+
    geom_line(data = df1,
              aes(x = date,
                  y = value,
                  color = variable))+
    geom_line(data = er1,
              aes(x = date,y = ERA5),
              color = 'black',size = 1)+
    scale_color_npg()+
    facet_wrap(~variable,nrow = 2)+
    theme_bw()
  
  # fut 
  i = 1:ncol(sst1_ssp245_train)
  extract_fut1_pr245 <- function(i){
    if(i!=1){
      tmp = ret1_245[[i]][[3]]
    }else{
      tmp = ret1_245[[i]][[3]]
    }
    return(tmp)
  }
  extract_fut1_pr585 <- function(i){
    if(i !=1){
      tmp = ret1_585[[i]][[3]]
      
    }else{
      tmp = ret1_585[[i]][[3]]
      
    }
    return(tmp)
  }
  extract_fut3_pr245 <- function(i){
    if(i !=1){
      tmp = ret3_245[[i]][[3]]
    }else{
      tmp = ret3_245[[i]][[3]]
    }
    
    return(tmp)
  }
  extract_fut3_pr585 <- function(i){
    if(i !=1){
      tmp = ret3_585[[i]][[3]]
    }else{
      tmp = ret3_585[[i]][[3]]
    }
    
    return(tmp)
  }
  
  
  ret_fut1_245 = lapply(i,extract_fut1_pr245)
  ret_fut1_585 = lapply(i,extract_fut1_pr585)
  ret_fut3_245 = lapply(i,extract_fut3_pr245)
  ret_fut3_585 = lapply(i,extract_fut3_pr585)
  
  ret_fut1_245 <<- ret_fut1_245
  ret_fut1_585 <<- ret_fut1_585
  ret_fut3_245 <<- ret_fut3_245
  ret_fut3_585 <<- ret_fut3_585
  
  ret_to_df1 <-function(i){
    x = ret_fut1_245[[i]][,2]
    return(x)
  }
  ret_to_df2 <-function(i){
    x = ret_fut1_585[[i]][,2]
    return(x)
  }
  ret_to_df3 <-function(i){
    x = ret_fut3_245[[i]][,2]
    return(x)
  }
  ret_to_df4 <-function(i){
    x = ret_fut3_585[[i]][,2]
    return(x)
  }
  
  df_fut1 = data.frame(
    ret_fut1_245[[1]],
    do.call('cbind',lapply(i,ret_to_df1))[,-1]
  )
  df_fut2 = data.frame(
    ret_fut1_585[[1]],
    do.call('cbind',lapply(i,ret_to_df2))[,-1]
  )
  
  df_fut3 = data.frame(
    ret_fut3_245[[1]],
    do.call('cbind',lapply(i,ret_to_df3))[,-1]
  )
  df_fut4 = data.frame(
    ret_fut3_585[[1]],
    do.call('cbind',lapply(i,ret_to_df4))[,-1]
  )
  
  
  colnames(df_fut1) = c('date',modelnames)
  colnames(df_fut2) = c('date',modelnames)
  colnames(df_fut3) = c('date',modelnames)
  colnames(df_fut4) = c('date',modelnames)
  
  df_fut1m = reshape2::melt(df_fut1,'date')
  df_fut2m = reshape2::melt(df_fut2,'date')
  df_fut3m = reshape2::melt(df_fut3,'date')
  df_fut4m = reshape2::melt(df_fut4,'date')
  
  df_fut1m$type = 'SSP245_SST1'
  df_fut2m$type = 'SSP585_SST1'
  df_fut3m$type = 'SSP245_SST3'
  df_fut4m$type = 'SSP585_SST3'
  
  dffutm = rbind(df_fut1m,df_fut2m,
                 df_fut3m,df_fut4m)
  
  dir.create('analysis_output/fig4')
  fwrite(df_fut1,'analysis_output/fig4/sst/sst_ato1_ssp245_proj.csv')
  fwrite(df_fut2,'analysis_output/fig4/sst/sst_ato1_ssp585_proj.csv')
  fwrite(df_fut3,'analysis_output/fig4/sst/sst_ato3_ssp245_proj.csv')
  fwrite(df_fut4,'analysis_output/fig4/sst/sst_ato3_ssp585_proj.csv')
  
  
  p = ggplot()+
    geom_line(data = dffutm,
              aes(x = date,y= value,
                  color = type,
                  group = type),
              size = 1)+
    scale_color_npg()+
    facet_wrap(~variable,nrow = 4)+
    theme_bw()
  
  extract_test1_pr245 <- function(i){
    if(i!=1){
      tmp = ret1_245[[i]][[2]][,2]
    }else{
      tmp = ret1_245[[i]][[2]]
    }
    return(tmp)
  }
  extract_test1_pr585 <- function(i){
    if(i !=1){
      tmp = ret1_585[[i]][[2]][,2]
      
    }else{
      tmp = ret1_585[[i]][[2]]
      
    }
    return(tmp)
  }
  extract_test3_pr245 <- function(i){
    if(i !=1){
      tmp = ret3_245[[i]][[2]][,2]
    }else{
      tmp = ret3_245[[i]][[2]]
    }
    
    return(tmp)
  }
  extract_test3_pr585 <- function(i){
    if(i !=1){
      tmp = ret3_585[[i]][[2]][,2]
    }else{
      tmp = ret3_585[[i]][[2]]
    }
    
    return(tmp)
  }
  
  ret1_245_test = lapply(i,extract_test1_pr245)
  ret1_585_test = lapply(i,extract_test1_pr585)
  ret3_245_test = lapply(i,extract_test3_pr245)
  ret3_585_test = lapply(i,extract_test3_pr585)
  
  ret1_245_test = do.call(cbind,ret1_245_test)
  ret3_245_test = do.call(cbind,ret3_245_test)
  ret1_585_test = do.call(cbind,ret1_585_test)
  ret3_585_test = do.call(cbind,ret3_585_test)
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(ret1_245_test) = c('ERA5',modelnames)
  colnames(ret3_245_test) = c('ERA5',modelnames)
  colnames(ret1_585_test) = c('ERA5',modelnames)
  colnames(ret3_585_test) = c('ERA5',modelnames)
  
  datefull = seq(as.Date('2003-01-01'),
                 as.Date('2050-12-01'),
                 '1 month')
  
  ret1_245_test = data.frame(date = datefull[127:180],
                             ret1_245_test)
  ret1_585_test = data.frame(date = datefull[127:180],
                             ret1_585_test)
  ret3_245_test = data.frame(date = datefull[127:180],
                             ret3_245_test)
  ret3_585_test = data.frame(date = datefull[127:180],
                             ret3_585_test)
  
  fwrite(ret1_245_test,'analysis_output/fig4/sst/sst_ato1_245_test.csv')
  fwrite(ret1_585_test,'analysis_output/fig4/sst/sst_ato1_585_test.csv')
  fwrite(ret3_245_test,'analysis_output/fig4/sst/sst_ato3_245_test.csv')
  fwrite(ret3_585_test,'analysis_output/fig4/sst/sst_ato3_585_test.csv')
  
}







var_analysis_between_epsource_p <- function(
  
){
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  gpcc_pr = paste0('gpcc_pr_in_target/',files,'.csv')
  era5_pr = paste0('era5_pr_in_target/',files,'.csv')
  
  con_amount_input = paste0('convey_amount_based_era5_in_target')
  
  
  # 2003-2013
  # 2013-2017
  i = 1:4
  var_fun <-function(i){
    files = c('north_moun','north_jishui','south_moun','south_jishui')
    gpcc_pr = paste0('gpcc_pr_in_target/',files[i],'.csv')
    print(gpcc_pr)
    #era5_pr = paste0('era5_pr_in_target/',files[i],'.csv')
    con_amount_input = paste0('convey_amount_based_era5_in_target/mean/',
                              files[i],'.csv')
    
    gpcc = fread(gpcc_pr)
    con_amount = fread(con_amount_input)
    
    colnames(gpcc) = 'gpcc_pr'
    colnames(con_amount) = paste0('pr',1:12)
    
    gpcc = as.data.frame(gpcc)
    con_amount = as.data.frame(con_amount)
    
    con_sum = apply(con_amount,2,sum)
    id_re = as.numeric(which(con_sum <100))
    if(length(id_re)>0){
      con_amount = con_amount[,-id_re]  
    }
    
    df = data.frame(gpcc,con_amount)
    
    trend_fun <- function(x){
      xa = (x -mean(x))/(max(x) - min(x))
      xt = ts(xa,start = c(2003,1),frequency = 12)
      xt = decompose(xt)$trend
      return(xt)
    }
    df = apply(df,2,trend_fun)
    
    
    
    date = seq(as.Date('2003-01-01'),as.Date('2017-12-01'),'1 month')
    df = data.frame(date,df)
    
    dfm = melt(df,'date')
    
    pvar = ggplot()+
      geom_line(data = dfm,aes(x = date,y = value,
                               color = variable))+
      facet_wrap(~variable,nrow = 4,scales = 'free')+
      theme_bw()
  }
}

























var_analysis_cmip6_project_tws <-function(
  
){
  input = 'simu_cmip6_tws'
  pattern = c('hist_ssp245','hist_ssp585')
  
  input = paste0(input,'/',pattern)
  
  i = 1:2
  input <<- input
  
  
  trend_cmip6_proj<-function(x){
    tx = ts(x,c(2017,7),frequency = 12)
    ttx = decompose(tx)$trend
    stand_trend <-function(x){
      xt = (x -mean(x,na.rm = T))/(max(x,na.rm=T) - min(x,na.rm = T))
      return(xt)
    }
    ttx = stand_trend(ttx)
    return(ttx)
  }
  trend_cmip6_train<-function(x){
    tx = ts(x,c(2003,1),frequency = 12)
    ttx = decompose(tx)$trend
    stand_trend <-function(x){
      xt = (x -mean(x,na.rm = T))/(max(x,na.rm=T) - min(x,na.rm = T))
      return(xt)
    }
    ttx = stand_trend(ttx)
    return(ttx)
  }
  trend_cmip6_test<-function(x){
    tx = ts(x,c(2013,2),frequency = 12)
    ttx = decompose(tx)$trend
    stand_trend <-function(x){
      xt = (x -mean(x,na.rm = T))/(max(x,na.rm=T) - min(x,na.rm = T))
      return(xt)
    }
    ttx = stand_trend(ttx)
    
    return(ttx)
  }
  
  
  
  sub_var<-function(i){
    input1 = list.files(input[i],full.names = T)
    
    proj_box = lapply(input1[c(1,4)],fread)
    test_box = lapply(input1[c(2,5)],fread)
    train_box = lapply(input1[c(3,6)],fread)
    
    proj_box = lapply(proj_box,as.data.frame)
    test_box = lapply(test_box,as.data.frame)
    train_box = lapply(train_box,as.data.frame)
    
    north_proj = proj_box[[1]]
    north_test = test_box[[1]]
    north_train = train_box[[1]]
    
    south_proj = proj_box[[2]]
    south_test = test_box[[2]]
    south_train = train_box[[2]]
    
    
    north_proj_trend = north_proj
    south_proj_trend = south_proj
    north_test_trend = north_test
    south_test_trend = south_test
    north_train_trend = north_train
    south_train_trend = south_train
    
    north_proj_trend = apply(north_proj,2,trend_cmip6_proj)
    south_proj_trend = apply(south_proj,2,trend_cmip6_proj)
    
    north_test_trend = apply(north_test,2,trend_cmip6_test)
    south_test_trend = apply(south_test,2,trend_cmip6_test)
    
    north_train_trend = apply(north_train,2,trend_cmip6_train)
    south_train_trend = apply(south_train,2,trend_cmip6_train)
    
    return(list(north_train_trend,
                south_train_trend,
                north_test_trend,
                south_test_trend,
                north_proj_trend,
                south_proj_trend))
    
  }
  
  ret_box = lapply(i,sub_var)
  ret_box1 = ret_box[[1]] #ssp245
  ret_box2 = ret_box[[2]] #ssp585
  
  # import cmip6 tws ssp245
  north_train_trend_ssp245 = ret_box1[[1]]
  south_train_trend_ssp245 = ret_box1[[2]]
  north_test_trend_ssp245 = ret_box1[[3]]
  south_test_trend_ssp245 = ret_box1[[4]]
  north_proj_trend_ssp245 = ret_box1[[5]]
  south_proj_trend_ssp585 = ret_box1[[6]]
  
  north_train_trend_ssp585 = ret_box2[[1]]
  south_train_trend_ssp585 = ret_box2[[2]]
  north_test_trend_ssp585 = ret_box2[[3]]
  south_test_trend_ssp585 = ret_box2[[4]]
  north_proj_trend_ssp585 = ret_box2[[5]]
  south_proj_trend_ssp585 = ret_box2[[6]]
  # import tws
  ##########################
  stand_fun1 <-function(x){
    x= x/(max(x)-min(x))
  }
  
  input_tws = 'tws_in_target/'
  files_jishui = c('north_jishui','south_jishui')
  
  input_tws_north = paste0(input_tws,files_jishui[1],'.csv')
  input_tws_south = paste0(input_tws,files_jishui[2],'.csv')
  
  north_tws_jishui = as.data.frame(fread(input_tws_north))
  south_tws_jishui = as.data.frame(fread(input_tws_south)[,1])
  
  north_tws_jishui = as.numeric(north_tws_jishui[,1])
  south_tws_jishui = as.numeric(south_tws_jishui[,1])
  
  north_tws = stand_fun1(north_tws_jishui)
  south_tws = stand_fun1(south_tws_jishui)
  
  north_tws_train = north_tws[1:121]
  south_tws_train = south_tws[1:121]
  north_tws_test = north_tws[122:174]
  south_tws_test = south_tws[122:174]
  
  #north_tws_train = trend_cmip6_train(north_tws_train)
  #south_tws_train = trend_cmip6_train(south_tws_train)
  #north_tws_test = trend_cmip6_test(north_tws_test)
  #south_tws_test = trend_cmip6_test(south_tws_test)
  ##########################
  
  var_compare <- function(date,tws,df){
    df = data.frame(date,df)
    df = reshape2::melt(df,'date')
    df_tws = data.frame(date,tws)
    
    pline = ggplot()+
      geom_line(data = df,aes(x = date,y = value))+
      geom_line(data = df_tws,aes(x = date,y = tws),
                color = 'black',linetype = 'dashed')+
      facet_wrap(~variable,nrow = 2,scales = 'free')+
      theme_bw()
    
    pline
  }
  pl_ribbion_fun1 <-function(date,tws,df){
    df1 = data.frame(date,mean = df$xmean,
                         tws = tws)
    
    df1 = reshape2::melt(df1,'date')
    
    df_rib = data.frame(date,xmin = df$xmin,
                        xmax = df$xmax)
    
    
    pline = ggplot()+
      geom_line(data = df1,aes(x = date,y = value,
                              color = variable))+
      geom_ribbon(data = df_rib,aes(x = date, ymin = xmin,
                                    ymax = xmax),
                  fill = 'grey80',alpha = 0.5,color = 'transparent')+
      theme_bw()
    
    pline
    
    
  }
  
  date_train = seq(as.Date('2003-01-01'),as.Date('2013-01-01'),
                   '1 month')
  date_test = seq(as.Date('2013-02-01'),as.Date('2017-06-01'),
                  '1 month')
  date_proj = seq(as.Date('2017-07-01'),as.Date('2050-12-11'),
                  '1 month')
  
  statistc_cal_fun<-function(x){
    mean_fun <-function(x){
      x = mean(x,na.rm = T)
      return(x)
    }  
    max_fun <-function(x){
      x = max(x,na.rm = T)
      return(x)
    }  
    
    min_fun <-function(x){
      x = min(x,na.rm = T)
      return(x)
    }  
    
    xmean = apply(x,1,mean_fun)
    xmin = apply(x,1,min_fun)
    xmax = apply(x,1,max_fun)
    d = data.frame(xmin,xmean,xmax)
    return(d)
  }
  
  north_train_trend_ssp245 = statistc_cal_fun(north_train_trend_ssp245)
  north_train_trend_ssp245 = statistc_cal_fun(north_train_trend_ssp245)
  pl_ribbion_fun1(date_train,north_tws_train,north_train_trend_ssp245)
  pl_ribbion_fun1(date_test,north_tws_test,north_test_trend_ssp245)
  
  # var compare 245
  var_compare(date_train,north_tws_train,north_train_trend_ssp245)
  var_compare(date_test,north_tws_test,north_test_trend_ssp245)
  var_compare(date_train,south_tws_train,south_train_trend_ssp245)
  var_compare(date_test,south_tws_test,south_test_trend_ssp245)
  
  # var compare 585
  var_compare(date_train,north_tws_train,north_train_trend_ssp585)
  var_compare(date_test,north_tws_test,north_test_trend_ssp585)
  var_compare(date_train,south_tws_train,south_train_trend_ssp585)
  var_compare(date_test,south_tws_test,south_test_trend_ssp585)
  
  north_proj_df = data.frame(date = date_proj,north_proj_trend)
  north_proj_dfm = reshape2::melt(north_proj_df,'date')
  
  pline = ggplot()+
    geom_line(data = north_proj_dfm,aes(x = date,y = value,color = variable))+
    facet_wrap(~variable,nrow = 2,scales = 'free')+
    theme_bw()
  
  south_proj_df = data.frame(date = date_proj,south_proj_trend)
  south_proj_dfm = reshape2::melt(south_proj_df,'date')
  
  pline2 = ggplot()+
    geom_line(data = south_proj_dfm,aes(x = date,y = value))+
    facet_wrap(~variable,nrow = 2,scales = 'free')+
    theme_bw()
  
  
  
}
var_analysis<-function(
  
){
  library(data.table)
  source('/home/share/R_project/xinjiang_vapor/trend_index.R')
  source('/home/share/R_project/xinjiang_vapor/stand_fun.R')
  contr = fread('analysis_output/contr_in_source_variance_new.csv')
  source('/home/share/R_project/xinjiang_vapor/stand_fun.R')
  sou_name = contr[,1]
  contr = contr[,-1]  
  sum_fun<-function(x){
    x = sum(x,na.rm = T)
  }
  
  contr_sum = apply(contr,2,sum_fun)
  
  contr_sum = as.numeric(contr_sum)
  contr_sum_t = trend_index(contr_sum,c(2003,1),12)
  
  # gpcc 
  source('/home/share/R_project/xinjiang_vapor/gpcc_pr_in_xinjiang.R')
  gpcc_trend = gpcc_pr_in_xinjiang()
  
  # gws
  source('/home/share/R_project/xinjiang_vapor/gws_in_xinjiang.R')
  gws_trend = gws_in_xinjiang()
  
  # era5_evpor
  source('/home/share/R_project/xinjiang_vapor/era5_evapor.R')
  era5_eva = era5_evapor()
  
  # era5_temper
  source('/home/share/R_project/xinjiang_vapor/era5_temper.R')
  era5t = era5_tmp()
  
  # ndvi 
  source('/home/share/R_project/xinjiang_vapor/ndvi_in_xinjiang.R')
  ndvi = ndvi_in_xinjiang()
  
  # tt_released
  tt_re = data_management(mode = 'total_released')
  tt_re_t = trend_index(tt_re,start = c(2003,1),fre = 12)
  tt_re_s = stand_fun(tt_re_t)
  
  
  contr_sum_s = stand_fun(contr_sum_t)
  gpcc_s = stand_fun(gpcc_trend)
  gws_s = stand_fun(gws_trend)
  eva_s = stand_fun(era5_eva)
  t_s = stand_fun(era5t)
  ndvi_s = stand_fun(ndvi)
  
  date = seq(as.Date('2003-07-01'),
             as.Date('2017-06-01'),'1 month')
  
  eva_p = stand_fun(era5_eva - gpcc_trend)
  df = data.frame(date,gpcc_s,gws_s,eva_s)
  library(ggplot2)
  library(reshape2)
  dfm = melt(df,'date')
  
  
  p = ggplot()+
    geom_line(data = dfm,aes(x = date,y = value,color = variable),size = 1)+
    theme_bw()+
    theme(
      panel.background = element_rect(fill = 'transparent'),
      axis.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      axis.title = element_text(color = 'black',size = 14,face = 'bold',hjust = 0.5),
      legend.position = 'bottom',
      legend.direction = 'horizontal',
      legend.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      legend.title = element_text(color = 'black',size = 14, face = 'bold',hjust = 0.5),
      strip.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5)
    )+
    guides(color = guide_legend(nrow = 1))+
    xlab('Date (month)')+
    ylab('Index')
    
  png('plot/co-var.png',
      height = 15,
      width = 21,
      units = 'cm',
      res = 800)
  print(p)
  dev.off()
  
  
  
}
wind_fileds_at_different_level<-function(
  
){
  input_files = list.files('/media/sdb1/xinjiang_output_file',
                           full.names = T)
  
  
  input_files <<- input_files
  input_land = paste0(input_files,'/output/contr_released_land')
  input_ocean = paste0(input_files,'/output/contr_released_ocean')
  input_land <<- input_land
  input_ocean <<- input_ocean
  
  fread_in <- function(x){
    
    x = list.files(x,full.names = T)
    print(x)
    x = lapply(x,fread)
    x = lapply(x,as.data.frame)
    rbind_fun <- function(x){return(x[,1:3])}
    x = lapply(x,rbind_fun)
    x = do.call(rbind,x)
    return(x)
  }
  
  land_df = lapply(input_land,fread_in)
  oce_df = lapply(input_ocean,fread_in)
  
  land_df = lapply(land_df,as.data.frame)
  oce_df = lapply(oce_df,as.data.frame)
  
  land_df = do.call(rbind,land_df)
  oce_df = do.call(rbind,oce_df)
  
  height = c(land_df[,3],oce_df[,3])
  long = c(land_df[,1],oce_df[,1])
  lat = c(land_df[,2],oce_df[,2])
  
  df = data.frame(long,lat,height)
  height = aggregate(df$height,list(long,lat),mean)
  
  
  
  
}
world_ocean_shp <-function(
  
){
  shp_path = '/root/下载/World_Seas_IHO_v3'
  files = list.files(shp_path,full.names = T,pattern = '.shp$')
  shp = shapefile(files)
  shp <<- shp
  
  names_shp = shp$NAME
  tran_to_li <- function(name){
    shp_sub = shp[shp$NAME == name,]
    ex = extent(shp_sub)[3]
    if(ex >= 0){
      return(shp_sub)
    }
  }
  system.time(ret_shp_li <- lapply(names_shp,tran_to_li))
  
  id_re = 1
  for(i in 1:length(ret_shp_li)){
    if(is.null(ret_shp_li[[i]])){
      id_re = c(id_re, i)
    }
  }
  id_re = id_re[-1]
  ret_shp_li = ret_shp_li[-id_re]
  
  # get Atlantic Ocean
  shp_ato = shp[shp$NAME == 'North Atlantic Ocean',]
  shp_indian = shp[shp$NAME == 'Indian Ocean',]
  cr_ex = extent(extent(shp_indian)[1],extent(shp_indian)[2],0,extent(shp_indian)[4])
  shp_indian = crop(shp_indian,cr_ex)
  
  ret_shp_li = c(ret_shp_li,shp_ato,shp_indian)
  # import label csv 
  labels_csv = read.csv('/media/sdb1/shp/names_north_ocean_shp.csv')
  labels_csv = labels_csv[,-1]
  
  po_li = list()
  ato_li = list()
  ao_li = list()
  io_li = list()
  ms_li = list()
  rs_li = list()
  bs_li = list()
  
  for(i in 1:length(ret_shp_li)){
    tmpname = ret_shp_li[[i]]$NAME
    tmpid_in_label = which(as.character(labels_csv$Sea) == tmpname)
    
    if(length(tmpid_in_label) == 1){
      tmpocean = labels_csv[tmpid_in_label,2]
    }else{
      tmpocean ='NA'
      #print(tmpname)
    }
    
    if(tmpocean == "PO" |tmpname =='North Pacific Ocean' ){
      po_li = c(po_li,ret_shp_li[[i]])
    }else if(tmpocean == 'ATO'|tmpname =='North Atlantic Ocean'){# atlantic seaw
      ato_li = c(ato_li, ret_shp_li[[i]])
    }else if(tmpocean == 'AO'|tmpname =='Arctic Ocean'){# artic sea
      ao_li = c(ao_li,ret_shp_li[[i]])
      #print(tmpocean)
    }else if(tmpocean == 'IO'|tmpname =='Indian Ocean'){ # indian sea
      io_li = c(io_li, ret_shp_li[[i]])
    }else if(tmpocean == 'MS'|tmpname =='Mediterranean Sea - Eastern Basin'|tmpname == 'Mediterranean Sea - Western Basin'){# medi sea
      ms_li = c(ms_li,ret_shp_li[[i]])
    }else if(tmpocean == 'RS'|tmpname =='Red Sea'){ # red sea
      rs_li = c(rs_li,ret_shp_li[[i]])
    }else if(tmpocean == 'BS'|tmpname =='BS'){ # black sea
      bs_li = c(bs_li,ret_shp_li[[i]])
    }
  }
  
  sth_china_sea = shp[shp$NAME == 'South China Sea',]
  po_li = c(po_li,sth_china_sea)
  
  ara_bin_sea = shp[shp$NAME =='Arabian Sea',]
  io_li = c(io_li, ara_bin_sea)
  
  id_non = 1
  for(i in 1:length(ao_li)){
    if(extent(ao_li[[i]])[4]<62){
      id_non = c(id_non,i)
    }
  }
  id_non = id_non[-1]
  
  kt_sea = ao_li[[id_non]]
  ao_li = ao_li[-id_non]
  ato_li = c(ato_li,kt_sea)
  
  # combine shps
  po_li_b = do.call('bind',po_li)
  ato_li_b = do.call('bind',ato_li)
  ao_li_b = do.call('bind',ao_li)
  io_li_b = do.call('bind',io_li)
  ms_li_b = do.call('bind',ms_li)
  rs_li_b = do.call('bind',rs_li)
  bs_li_b = do.call('bind',bs_li)
  
  cat_sea = shapefile('/media/sdb1/shp/caspian_sea.shp')
  
  #dir.create('/media/sdb1/shp/ocean_shp')
  output = paste0('/media/sdb1/shp/ocean_shp/',c('po','ato','ao','io','ms','rs','bs','cs'),
                  '.shp')
  out_li = list(po_li_b,ato_li_b,ao_li_b,io_li_b,ms_li_b,rs_li_b,bs_li_b,cat_sea)
  
  for(i in 1:length(out_li)){
    shapefile(out_li[[i]],output[i])
  }
  
  p = ggplot()+
    geom_polygon(data = po_li_b,aes(x = long,y = lat,group = group),fill = 'blue')+
    geom_polygon(data = ato_li_b,aes(x = long,y = lat,group = group),fill = 'yellow')+
    geom_polygon(data = ao_li_b,aes(x = long,y = lat,group = group),fill = 'red')+
    geom_polygon(data = io_li_b,aes(x = long,y = lat,group = group),fill = 'pink')+
    geom_polygon(data = ms_li_b,aes(x = long,y = lat,group = group),fill = 'grey')+
    geom_polygon(data = rs_li_b,aes(x = long,y = lat,group = group),fill = 'green')+
    geom_polygon(data = bs_li_b,aes(x = long,y = lat,group = group),fill = 'black')+
    geom_polygon(data = shp,aes(x = long,y = lat,group= group),fill = 'transparent',
                 color = 'black')
  
  
  

}
library(raster)
library(doParallel)
#tmptws is raster stack
beginCluster(12)
mon_mean = clusterR(tmptws,calc,
                    args = list(fun = mmkfunRaster))
endCluster()
generate_sub_windows<-function(
  
){
  # aim 
  # to pursure the routes of terrestrial water storage
  
  
  latex = seq(30,60,10)
  longex = seq(-20,100,20)
  
  latex_start = latex[1:3]
  latex_end = latex[2:4]
  
  longex_start = longex[1:6]
  longex_end = longex[2:7]
  
  ex_li = list()
  
  for(i in 1:6){
    longextmp = c(longex_start[i],
               longex_end[i])
    tmp_li1 = list()
    for(j in 1:3){
      lat_start = latex_start[j]
      lat_end = latex_end[j]
      tmpextent = c(longextmp,lat_start,lat_end)
      tmpextent = extent(tmpextent)
      tmppoly  = as(tmpextent,'SpatialPolygons')
      tmp_li1[j] = tmppoly
    }
    
    ex_li = c(ex_li,tmp_li1)
  }
  
  output_poly = 'sub_windows'
  dir.create(output_poly)
  num = 1:length(ex_li)
  output_poly = paste0(output_poly,'/sub_window',num,'.shp')
  
  for(i in 1:length(ex_li)){
    print(i)
    shapefile(ex_li[[i]],filename = output_poly[i],overwrite = T)
  }
  
  # adding shp gansu hexi zoulang
  
  ex_add = extent(100,120,35,45)
  ex_add = as(ex_add,'SpatialPolygons')
  shapefile(ex_add,'sub_windows/sub_window19.shp',
            overwrite = T)
  
  
  
  
  
  
}
gpcc_pr_in_xinjiang <- function(
  mode = 'trend'
){
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  gpcc = data_management(mode = 'gpcc')
  
  gpcc_pr = 1
  
  for(i in 1:dim(gpcc)[3]){
    tmpmean = cellStats(gpcc[[i]],'mean')
    gpcc_pr = c(gpcc_pr,tmpmean)
  }
  gpcc_pr = gpcc_pr[-1]
  
  if(mode == 'trend'){
    gpcc_pr_trend = trend_index(gpcc_pr,c(2003,1),fre =12)
  }else{
    gpcc_pr_trend = gpcc_pr
  }
  
  
  return(gpcc_pr_trend)
  
    
}
gpcc_season_analysis<-function(
  
){
  
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  gpcc = data_management(mode = 'gpcc')
  
  gpcc_pr = 1
  
  for(i in 1:dim(gpcc)[3]){
    tmpmean = cellStats(gpcc[[i]],'mean')
    gpcc_pr = c(gpcc_pr,tmpmean)
  }
  gpcc_pr = gpcc_pr[-1]
  
  gpcc_pr_mon = matrix(gpcc_pr,nrow = 12)
  
  mon_mean_fun<-function(x){
    xm = mean(x,na.rm = T)
    return(xm)
  }
  gpcc_pr_mon_pattern = apply(gpcc_pr_mon,1,mon_mean_fun)
  
}
group_matrix_by_id<-function(x){ # df_xinjiang as input
  step = nrow(x)/100
  ids = round(seq(1,nrow(x),step))
  ide = ids -1
  ide = ide[-1]
  ide = c(ide,nrow(x))
  
  # ide position to value{
  for(i in 1:(length(ide)-1)){
    tmpid = ide[i]
    tmptype = x[tmpid,]$type
    typeid = which(x$type == tmptype)
    print(typeid)
    typeidmax = max(typeid)
    if(typeidmax>tmpid){
      ide[i] = typeidmax
      ids[i+1] = ide[i]+1
    }
  }
  li = list()
  for(i in 1:length(ide)){
    tmps= ids[i]
    tmpe = ide[i]
    li[[i]]= x[tmps:tmpe,]
  }
  return(li)
}
gws_in_xinjiang <- function(
  mode = 'trend'
){
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  gws = data_management(mode = 'grace')
  
  gws_meanb = 1
  for(i in 1:dim(gws)[[3]]){
    tmp = cellStats(gws[[i]],'mean')
    gws_meanb = c(gws_meanb,tmp)
  }
  gws_meanb = gws_meanb[-1]
  
  gws_mean = gws_meanb
  
  if(mode == 'trend'){
    gws_mean_trend = trend_index(gws_mean,start = c(2003,1),fre=12)
  }else{
    gws_mean_trend = gws_mean
  }
  
  
  return(gws_mean_trend)
}
import_cmip6_combined<-function(
  mode = 'hist_ssp245',
  var = 'E',
  model_name
){
  input = '/media/root/Shen_drive1/CMIP6_combined/'
  input = paste0(input,'/',var)
  input = paste0(input,'/',mode)
  
  input =list.files(input,full.names = T)
  
  models = c('ACCESS-ESM1-5','BCC-CSM2-MR',
                 'CanESM5','GFDL-ESM4','IPSL-CM6A-LR',
                 'MIROC6','MRI-ESM2-0','NorESM2-LM')
  
  id = which(models == model_name)
  print(model_name)
  ncfile = stack(input[id])
  return(ncfile)
  
}
import_country_longlat <-function(
  country_name
){
  country_label <- as.data.frame(
    fread('/media/sdb5/Vapor_projcts/Vapor_tibet/main_plot_data/fig3/country_label.csv')
  )
  country_label = country_label[-which(country_label$name == 'Hong Kong'|
                                         country_label$name == 'Macau'),]
  country_label$latitude[which(country_label$name=='India')]=
    country_label$latitude[which(country_label$name=='India')]+2
  
  citys = shp_management('china_city')
  city_china = citys[citys$PINYIN %in%
                       c('Wulumuqi','Shijiazhuang'),]
  city_china = as.data.frame(city_china,xy = T)
  city_china1 = data.frame(
    country = c('NCP','XJ'),
    latitude = city_china$coords.x2,
    longitude = city_china$coords.x1,
    name = c('North China Plain','Xinjiang')
  )
  
  country_label = rbind(country_label,city_china1)
  
  i = 1:length(country_name)
  
  sub_find_loc <- function(i){
    tmp = which(country_label$name == country_name[i])
    long = country_label$longitude[tmp]
    lat = country_label$latitude[tmp]
    
    retdf = data.frame(
      long = long,
      lat = lat,
      code = country_label$country[tmp]
    )
    return(retdf)
  }
  
  country_loc = do.call(rbind,
                        lapply(i,sub_find_loc))
  
  country_loc$country = country_name
  
  
  return(country_loc)
}
import_gdp_df <-function(
  mode = 'gdp'
){
  
  if(mode == 'gdp'){
    input = 'NC_mod_xinjiang/fig_impact_human/gdp.csv'
    type = 'GDP'
  }else{
    input = 'NC_mod_xinjiang/fig_impact_human/gdp_growth_ratio.csv'
    type = 'GDP_GR'
  }
  df = read.csv(input,header = T)
  
  countrys = df[,1]
  df = df[,-1]
  df = t(df)
  stand_fun <- function(x){
    x = as.numeric(x)
    x = (x-mean(x,na.rm = T))/(max(x,na.rm = T)-min(x,na.rm = T))
  }
  
  df = apply(df,2,stand_fun)
 
  colnames(df) = countrys
  df = data.frame(
    year = 2003:2016,
    df
  )
  
  dfm = reshape2::melt(df,'year')
  dfm$type = type
  return(dfm)
}
import_importance_data_figs1011<-function(
  
){
  input245 = 'analysis_output/figS8-11/import_ssp245'
  input585 = 'analysis_output/figS8-11/import_ssp585'
  
  files = paste0('SW',1:10,'.csv')
  
  input245 = paste0(input245,'/',files)
  input585 = paste0(input585,'/',files)
  
  imp245 = 1
  imp585 = 1
  
  SWs = paste0('SW',1:10)
  for(i in 1:length(input245)){
    tmp245 = as.data.frame(fread(input245[i]))[,2]
    tmp585 = as.data.frame(fread(input585[i]))[,2]
    
    tmp245 = data.frame(
      PME = c('PME1','PME3'),
      SWs = SWs[i],
      IncNodePurity=tmp245
    )
    tmp585 = data.frame(
      PME = c('PME1','PME3'),
      SWs = SWs[i],
      IncNodePurity = tmp585
    )
    
    imp245 = rbind(imp245,tmp245)
    imp585 = rbind(imp585,tmp585)
    
  }
  imp245 = imp245[-1,]
  imp585 = imp585[-1,]
  
  return(list(imp245,imp585))
}
import_IncMSE_data_figs1011<-function(
  
){
  input245 = 'analysis_output/figS8-11/import_ssp245'
  input585 = 'analysis_output/figS8-11/import_ssp585'
  
  files = paste0('SW',1:10,'.csv')
  
  input245 = paste0(input245,'/',files)
  input585 = paste0(input585,'/',files)
  
  imp245 = 1
  imp585 = 1
  
  SWs = paste0('SW',1:10)
  for(i in 1:length(input245)){
    tmp245 = as.data.frame(fread(input245[i]))[,1]*100
    tmp585 = as.data.frame(fread(input585[i]))[,1]*100
    
    tmp245 = data.frame(
      PME = c('PME1','PME3'),
      SWs = SWs[i],
      IncMSE=tmp245
    )
    tmp585 = data.frame(
      PME = c('PME1','PME3'),
      SWs = SWs[i],
      IncMSE = tmp585
    )
    
    imp245 = rbind(imp245,tmp245)
    imp585 = rbind(imp585,tmp585)
    
  }
  imp245 = imp245[-1,]
  imp585 = imp585[-1,]
  
  return(list(imp245,imp585))
}
import_pe_in_source <-function(
  input = 'era5_pe_mean',
  name = 'era5_pe_sum.csv'
){
  
  mode = c('as','ato','eu')
  
  input = paste0(input,'/',rep(mode,each = 4))
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/',name)
  
  tmpb = 1
  for(i in 1:length(input)){
    tmp = fread(input[i])
    tmp = as.data.frame(tmp)
    tmpb = cbind(tmpb,tmp)
  }
  
  tmpb = tmpb[,-1]
  colnames(tmpb) = paste0('pr',1:12)
  
  return(tmpb)
  
}
import_pme_ato_correct <- function(
  year= T
){
  input_pme = list.files('analysis_output/cmip6_by_model/pme_proj_trend',
                         full.names = T)
  pme = lapply(lapply(input_pme,fread),as.data.frame)
  pme_trend = pme
  
  pme1_ssp245 = pme_trend[[1]]
  pme1_ssp585 = pme_trend[[2]]
  pme3_ssp245 = pme_trend[[3]]
  pme3_ssp585 = pme_trend[[4]]
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(pme1_ssp245) = modelnames
  colnames(pme1_ssp585) = modelnames
  colnames(pme3_ssp245) = modelnames
  colnames(pme3_ssp585) = modelnames
  
  trend_fun <- function(x){
    
    sub_fun <-function(x){
      x = ts(x,start = c(2003,1),
             frequency = 12)
      x = decompose(x)$trend
      
      xt = as.numeric(x)
      stand_fun <-function(y){
        y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
      }
      xy  = stand_fun(xt)
      return(xy)
    }
    xm = apply(x,2,sub_fun)
    return(xm)
  }
  
  pme1_pj245 = pme1_ssp245[1:390,]
  pme3_pj245 = pme3_ssp245[1:390,]
  pme1_pj585 = pme1_ssp585[1:390,]
  pme3_pj585 = pme3_ssp585[1:390,]
  
  
  to_year_ato <- function(x){
    x = c(x,rep(NA ,6))
    xm = matrix(x,nrow = 12)
    xm = apply(xm,2,sum,na.rm = T)
    #stand_fun <- function(x){
    #  xm = (x -mean(x,na.rm = T))/(max(x,na.rm = T)-min(x,na.rm = T))
    #}
    #xm = stand_fun(xm)
    return(xm)
  }
  
  if(year){
    pme1_pj585 = apply(pme1_pj585,2,to_year_ato)
    pme3_pj585 = apply(pme3_pj585,2,to_year_ato)
    
    pme1_pj245 = apply(pme1_pj245,2,to_year_ato)
    pme3_pj245 = apply(pme3_pj245,2,to_year_ato)
    
    pme1_pj245m = apply(pme1_pj245,1,mean)
    pme3_pj245m = apply(pme3_pj245,1,mean)
    pme1_pj585m = apply(pme1_pj585,1,mean)
    pme3_pj585m = apply(pme3_pj585,1,mean)
    
    
    df = data.frame(
      date = 2018:2050,
      SSP245_PME1 = pme1_pj245m,
      SSP245_PME3 = pme3_pj245m,
      SSP585_PME1 = pme1_pj585m,
      SSP585_PME3 = pme3_pj585m
    )
    
  }
  
  df = reshape2::melt(df,'date')
  colnames(df) = c('date','type',"value")
  
  
  return(df)
}
import_pme_ato_fig4<-function(
  year = T
){
  
  input_sst = list.files('analysis_output/cmip6_by_model/sst',
                         full.names = T)
  input_pme = list.files('analysis_output/cmip6_by_model/pme',
                         full.names = T)
  
  
  
  sst = lapply(lapply(input_sst,fread),as.data.frame)
  pme = lapply(lapply(input_pme,fread),as.data.frame)
  
  sst_trend = sst
  pme_trend = pme
  
  sst1_ssp245 = sst_trend[[1]]
  sst1_ssp585 = sst_trend[[2]]
  sst3_ssp245 = sst_trend[[3]]
  sst3_ssp585 = sst_trend[[4]]
  
  pme1_ssp245 = pme_trend[[1]]
  pme1_ssp585 = pme_trend[[2]]
  pme3_ssp245 = pme_trend[[3]]
  pme3_ssp585 = pme_trend[[4]]
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(sst1_ssp245) = modelnames
  colnames(sst1_ssp585) = modelnames
  colnames(sst3_ssp245) = modelnames
  colnames(sst3_ssp585) = modelnames
  
  colnames(pme1_ssp245) = modelnames
  colnames(pme1_ssp585) = modelnames
  colnames(pme3_ssp245) = modelnames
  colnames(pme3_ssp585) = modelnames
  
  trend_fun <- function(x){
    
    sub_fun <-function(x){
      x = ts(x,start = c(2003,1),
             frequency = 12)
      x = decompose(x)$trend
      
      xt = as.numeric(x)
      stand_fun <-function(y){
        y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
      }
      xy  = stand_fun(xt)
      return(xy)
    }
    xm = apply(x,2,sub_fun)
    return(xm)
  }
  
  pme1_pj245 = pme1_ssp245[175:576,]
  pme3_pj245 = pme3_ssp245[175:576,]
  sst1_pj245 = sst1_ssp245[175:576,]
  sst3_pj245 = sst3_ssp245[175:576,]
  
  pme1_pj245 = trend_fun(pme1_pj245)
  pme3_pj245 = trend_fun(pme3_pj245)
  sst1_pj245 = trend_fun(sst1_pj245)
  sst3_pj245 = trend_fun(sst3_pj245)
  
  naid = which(is.na(pme1_pj245[,1]))
  naidfut <<- naid
  
  pme1_pj245 = pme1_pj245[-naid,]
  pme3_pj245 = pme3_pj245[-naid,]
  sst1_pj245 = sst1_pj245[-naid,]
  sst3_pj245 = sst3_pj245[-naid,]
  
  pme1_pj585 = pme1_ssp585[175:576,]
  pme3_pj585 = pme3_ssp585[175:576,]
  sst1_pj585 = sst1_ssp585[175:576,]
  sst3_pj585 = sst3_ssp585[175:576,]
  
  pme1_pj585 = trend_fun(pme1_pj585)
  pme3_pj585 = trend_fun(pme3_pj585)
  sst1_pj585 = trend_fun(sst1_pj585)
  sst3_pj585 = trend_fun(sst3_pj585)
  
  naidfut = which(is.na(pme1_pj585[,1]))
  naidfut <<- naidfut
  
  pme1_pj585 = pme1_pj585[-naidfut,]
  pme3_pj585 = pme3_pj585[-naidfut,]
  sst1_pj585 = sst1_pj585[-naidfut,]
  sst3_pj585 = sst3_pj585[-naidfut,]
  
  to_year_ato <- function(x){
    x = c(x,rep(NA ,6))
    xm = matrix(x,nrow = 12)
    xm = apply(xm,2,sum,na.rm = T)
    #stand_fun <- function(x){
    #  xm = (x -mean(x,na.rm = T))/(max(x,na.rm = T)-min(x,na.rm = T))
    #}
    #xm = stand_fun(xm)
    return(xm)
  }
  
  if(year){
    pme1_pj585 = apply(pme1_pj585,2,to_year_ato)
    pme3_pj585 = apply(pme3_pj585,2,to_year_ato)
    sst1_pj585 = apply(sst1_pj585,2,to_year_ato)
    sst3_pj585 = apply(sst3_pj585,2,to_year_ato)
    
    pme1_pj245 = apply(pme1_pj245,2,to_year_ato)
    pme3_pj245 = apply(pme3_pj245,2,to_year_ato)
    sst1_pj245 = apply(sst1_pj245,2,to_year_ato)
    sst3_pj245 = apply(sst3_pj245,2,to_year_ato)
    
    pme1_pj245m = apply(pme1_pj245,1,mean)
    pme3_pj245m = apply(pme3_pj245,1,mean)
    pme1_pj585m = apply(pme1_pj585,1,mean)
    pme3_pj585m = apply(pme3_pj585,1,mean)
    
    
    df = data.frame(
      date = 2018:2050,
      SSP245_PME1 = pme1_pj245m,
      SSP245_PME3 = pme3_pj245m,
      SSP585_PME1 = pme1_pj585m,
      SSP585_PME3 = pme3_pj585m
    )
    
  }else{
    pme1_pj245m = apply(pme1_pj245,1,mean)
    pme3_pj245m = apply(pme3_pj245,1,mean)
    pme1_pj585m = apply(pme1_pj585,1,mean)
    pme3_pj585m = apply(pme3_pj585,1,mean)
    
    
    df = data.frame(
      date = seq(as.Date('2018-01-01'),
                 as.Date('2050-06-01'),
                 '1 month'),
      SSP245_PME1 = pme1_pj245m,
      SSP245_PME3 = pme3_pj245m,
      SSP585_PME1 = pme1_pj585m,
      SSP585_PME3 = pme3_pj585m
    )
  }
  
  
  df = reshape2::melt(df,'date')
  colnames(df) = c('date','type',"value")
 
  
  return(df)
}
import_project_tws_subs <- function(
  input,
  year = T
){
  library(data.table)
  files = paste0(input,'/SW',1:10,'.csv')
  ptws = lapply(lapply(files,fread),
                as.data.frame)
  
  cor_mat = fread('analysis_output/fig4/train_cor_tws.csv')
  cor_mat = as.data.frame(cor_mat)
  cor_mat <<- cor_mat

  ptws <<- ptws
  type = paste0('SW',1:10)
  type <<- type
  i = 1:10
  process_mean_fun <- function(i){
    tmp = ptws[[i]]
    date = seq(as.Date('2018-01-01'),
               as.Date('2050-06-01'),
               '1 month')
    tmp = tmp[,-1]
    
    tmpcor= cor_mat[,i]
    id = which(tmpcor>0.5)
    tmp = tmp[,id]
    tmp = apply(tmp,1,mean,na.rm = T)
    
    tmpdf = data.frame(
      date = date,
      tws = as.numeric(tmp),
      type= type[i]
    )
    
  }
  process_max_fun <- function(i){
    tmp = ptws[[i]]
    date = seq(as.Date('2018-01-01'),
               as.Date('2050-06-01'),
               '1 month')
    tmp = tmp[,-1]
    
    tmpcor= cor_mat[,i]
    id = which(tmpcor>0.5)
    tmp = tmp[,id]
    tmp = apply(tmp,1,max,na.rm = T)
    
    tmpdf = data.frame(
      date = date,
      tws = as.numeric(tmp),
      type= type[i]
    )
    
  }
  process_min_fun <- function(i){
    tmp = ptws[[i]]
    date = seq(as.Date('2018-01-01'),
               as.Date('2050-06-01'),
               '1 month')
    tmp = tmp[,-1]
    
    tmpcor= cor_mat[,i]
    id = which(tmpcor>0.5)
    tmp = tmp[,id]
    tmp = apply(tmp,1,min,na.rm = T)
    
    tmpdf = data.frame(
      date = date,
      tws = as.numeric(tmp),
      type= type[i]
    )
    
  }
  
  to_year <- function(x){
    x1 = c(x[,2],rep(NA,6))
    xm = matrix(x1,nrow = 12)
    xm = apply(xm,2,mean,na.rm = T)
    year = 2018:2050
    type = x[,3][1]
    xm = data.frame(
      date = year,
      tws = xm,
      type = type
    )
    return(xm)
  }
  
  ptws_mean = lapply(i,process_mean_fun)
  ptws_min = lapply(i,process_min_fun)
  ptws_max = lapply(i,process_max_fun)
  
  ptws_year_mean = lapply(ptws_mean,to_year)
  ptws_year_min = lapply(ptws_min,to_year)
  ptws_year_max = lapply(ptws_max,to_year)
  
  ptws_mean = do.call('rbind',ptws_mean)
  ptws_min = do.call('rbind',ptws_min)
  ptws_max = do.call('rbind',ptws_max)
  
  ptws_year_mean = do.call('rbind',
                           ptws_year_mean)
  ptws_year_max = do.call('rbind',
                          ptws_year_max)
  ptws_year_min = do.call('rbind',
                          ptws_year_min)
  
  ptws_year_maxmin = data.frame(
    date = ptws_year_max$date,
    max = ptws_year_max$tws,
    min = ptws_year_min$tws,
    type = ptws_year_min$type
  )
  
  ptwsmaxmin = data.frame(
    date = ptws_max$date,
    max = ptws_max$tws,
    min = ptws_min$tws,
    type = ptws_max$type
  )
  
  type = paste0('SW',1:10)
  ptws_mean$type = factor(ptws_mean$type,
                          levels = type)
  ptwsmaxmin$type = factor(ptwsmaxmin$type,
                           levels = type)
  
  ptws_year_mean$type = factor(ptws_year_mean$type,
                               levels = type)
  ptws_year_maxmin$type = factor(ptws_year_maxmin$type,
                                 levels = type)
  if(year){
    return(list(ptws_year_mean,
                ptws_year_maxmin))
  }else{
    return(list(ptws_mean,
                ptwsmaxmin))
  }
  
  
  
}
import_tws_mmk <- function(
  
){
  shp_as = shp_management('land','as')
  shp_eu = shp_management('land','eu')
  shp_naf = shp_management('land','naf')
  shp_as_eu = bind(shp_as,shp_eu,shp_naf)
  
  twsmmk_land = raster('analysis_output/tws_mmk.nc')
  twsmmk_land = mask(twsmmk_land,shp_as_eu)
  
  ex_as_ato = extent(shp_as_eu)
  ex_as_ato = extent(-50,ex_as_ato[2],ex_as_ato[3],
                     ex_as_ato[4])
  
  twsmmk_land = crop(twsmmk_land,ex_as_ato)
  twsmmk_land = as.data.frame(twsmmk_land,
                              xy = T)
  colnames(twsmmk_land) = c('long','lat',"value")
  lesszerotws = which(twsmmk_land$value<0)
  twsmmk_land = twsmmk_land[lesszerotws,]
  
  twsmmk_land$cuts = cut(twsmmk_land$value,
                         breaks = c(-700,seq(-20,0,2)))
  
  return(twsmmk_land)
  
}
import_validate_pme_cmip6 <-function(
  
){
  
  input_pme = 'analysis_output/fig4/pme'
  input_pme_train = list.files(input_pme,
                               full.names = T,
                               pattern = '*train.csv$')
  input_pme_test = list.files(input_pme,
                              full.names = T,
                              pattern = '*test.csv$')
  input_pme_fut = list.files(input_pme,
                             full.names = T,
                             pattern = '*proj.csv$')
  
  pme_train = lapply(lapply(input_pme_train,fread),
                     as.data.frame)
  pme_test = lapply(lapply(input_pme_test,fread),
                    as.data.frame)
  pme_fut = lapply(lapply(input_pme_fut,fread),
                   as.data.frame)
  
  
  remove_abundant_info_train_test <-function(x){
    x = x[,-c(1,2)]
    return(x)
  }
  remove_abundant_info_fut <-function(x){
    x = x[,-1]
    return(x)
  }
  
  pme_train = lapply(pme_train,remove_abundant_info_train_test)
  pme_test = lapply(pme_test,remove_abundant_info_train_test)
  pme_fut = lapply(pme_fut,remove_abundant_info_fut)
  
  pmeli = list()
  for(i in 1:length(pme_train)){
    tmp1 = pme_train[[i]]
    tmp2 = pme_test[[i]]
    tmp3 = pme_fut[[i]]
    modelnames = c('ACCESS-ESM1-5',
                   'BCC-CSM2-MR',
                   'CanESM5',
                   'GFDL-ESM4',
                   'IPSL-CM6A-LR',
                   'MIROC6',
                   'MRI-ESM2-0',
                   'NorESM2-LM')
    colnames(tmp1) = modelnames
    colnames(tmp2) = modelnames
    colnames(tmp3) = modelnames
    
    tmp = rbind(tmp1,tmp2,tmp3)
    colnames(tmp) = modelnames
    pmeli[[i]] = tmp
  }
  return(pmeli)
}
import_validate_sst <-function(
  
){
  
  input_sst = 'analysis_output/fig4/sst'
  input_sst_train = list.files(input_sst,
                               full.names = T,
                               pattern = '*train.csv$')
  input_sst_test = list.files(input_sst,
                              full.names = T,
                              pattern = '*test.csv$')
  input_sst_fut = list.files(input_sst,
                             full.names = T,
                             pattern = '*proj.csv$')
  
  sst_train = lapply(lapply(input_sst_train,fread),
                     as.data.frame)
  sst_test = lapply(lapply(input_sst_test,fread),
                    as.data.frame)
  sst_fut = lapply(lapply(input_sst_fut,fread),
                   as.data.frame)
  
  
  remove_abundant_info_train_test <-function(x){
    x = x[,-c(1,2)]
    return(x)
  }
  remove_abundant_info_fut <-function(x){
    x = x[,-1]
    return(x)
  }
  
  sst_train = lapply(sst_train,remove_abundant_info_train_test)
  sst_test = lapply(sst_test,remove_abundant_info_train_test)
  sst_fut = lapply(sst_fut,remove_abundant_info_fut)
  
  sstli = list()
  for(i in 1:length(sst_train)){
    tmp1 = sst_train[[i]]
    tmp2 = sst_test[[i]]
    tmp3 = sst_fut[[i]]
    modelnames = c('ACCESS-ESM1-5',
                   'BCC-CSM2-MR',
                   'CanESM5',
                   'GFDL-ESM4',
                   'IPSL-CM6A-LR',
                   'MIROC6',
                   'MRI-ESM2-0',
                   'NorESM2-LM')
    
    colnames(tmp1) = modelnames
    colnames(tmp2) = modelnames
    colnames(tmp3) = modelnames
    
    tmp = rbind(tmp1,tmp2,tmp3)
    colnames(tmp) = modelnames
    tmp = tmp - 273.15
    sstli[[i]] = tmp
  }
  return(sstli)
}
import_validate_tws_sws245 <- function(
  
){
  input_valid = 'analysis_output/figS8-11/valid_ssp245'
  input_train = 'analysis_output/figS8-11/train_ssp245'
  
  files = paste0('SW',1:10,'.csv')
  input_valid = paste0(input_valid,'/',files)
  input_train = paste0(input_train,'/',files)
  
  ret_com = 1
  cor_box = 1
  for(i in 1:length(input_valid)){
    tmpval = as.data.frame(fread(input_valid[i]))
    tmptrain = as.data.frame(fread(input_train[i]))
    
    tmpval$type = 'Validation'
    tmptrain$type = 'Train'
    
    tmpcombine = rbind(tmptrain,tmpval)
    tmpcor = cor(tmpcombine[,1],tmpcombine[,2])
    cor_box = c(cor_box,tmpcor)
    ret_com = rbind(ret_com,tmpcombine)
  }
  ret_com = ret_com[-1,]
  cor_box = cor_box[-1]
  cor_box = data.frame(
    SWs = paste0('SW',1:10),
    Cor = cor_box
  )
  
  return(list(ret_com,cor_box))
} 
import_validate_tws_sws585 <- function(
  
){
  input_valid = 'analysis_output/figS8-11/valid_ssp585'
  input_train = 'analysis_output/figS8-11/train_ssp585'
  
  files = paste0('SW',1:10,'.csv')
  input_valid = paste0(input_valid,'/',files)
  input_train = paste0(input_train,'/',files)
  
  ret_com = 1
  cor_box = 1
  for(i in 1:length(input_valid)){
    tmpval = as.data.frame(fread(input_valid[i]))
    tmptrain = as.data.frame(fread(input_train[i]))
    
    tmpval$type = 'Validation'
    tmptrain$type = 'Train'
    
    tmpcombine = rbind(tmptrain,tmpval)
    tmpcor = cor(tmpcombine[,1],tmpcombine[,2])
    cor_box = c(cor_box,tmpcor)
    
    ret_com = rbind(ret_com,tmpcombine)
  }
  ret_com = ret_com[-1,]
  cor_box = cor_box[-1]
  cor_box = data.frame(
    SWs = paste0('SW',1:10),
    Cor = cor_box
  )
  
  return(list(ret_com,cor_box))
} 
kriging <- function(
  df,
  resolution = 1
){
  library(rgdal)
  library(tmap)
  library(raster)
  library(ggplot2)
  library(maptools)
  library(maps)
  library(gstat)
  library(RColorBrewer)
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  #shp = shp_management('world_include_ocean')
  shp = crop(shp,raster::extent(-180,180,0,90))
  
  minlong = min(df$long)
  minlat = min(df$lat)
  maxlong = max(df$long)
  maxlat = max(df$lat)
  
  
  shp = crop(shp,raster::extent(minlong,maxlong,
                        minlat,maxlat))
  
  long_shp = extent(shp)[1:2]
  lat_shp = extent(shp)[3:4]
  
  long_p = seq(min(long_shp),max(long_shp),by =resolution )
  lat_p = seq(min(lat_shp),max(lat_shp),by = resolution)

  s_p = expand.grid(long_p,lat_p)
  inusa = map.where(x = s_p[,1],y = s_p[,2])
  inusa = !is.na(inusa)
  s_p = s_p[inusa,]
  
  colnames(s_p) = c('long','lat')
  
  coordinates(s_p) = ~ long + lat
  gridded(s_p) = T
  fullgrid(s_p) = F
  proj4string(s_p) = crs(shp)
  
  print("Pass Phase 1")
  
  pr = as.numeric(df[,3])
  na_index = which(is.na(pr))
    
  df = data.frame(long=df[,1],lat=df[,2],pr=as.numeric(df[,3]))
  df2 = df
  if(length(na_index)>0){
    df = df[-na_index,] 
  }
  coordinates(df) = ~ long+lat
  proj4string(df) = crs(shp)
  print("Pass Phase 2")
  #df_r = raster(df)
  f1 = as.formula(pr ~ long+lat)
    
  var.sampl = variogram(f1,df,cloud =F,
                        cutoff = 100000,
                        width = 89900)
  dat.fit = fit.variogram(var.sampl,fit.ranges = F,
                          fit.sills = F,
                          vgm(psill = 14,model = 'Sph',
                              range = 590000,
                              nugget = 0))
  
  
  dat.krig = krige(f1,df,s_p,dat.fit)
  dat.r = raster(dat.krig)

  #writeRaster(dat.r,'raster.tif',format = 'GTiff',overwrite = T)
  krg.res = as.data.frame(dat.r,xy = T)
  colnames(krg.res) = c('long','lat','pr')
  
  mycolor = colorRampPalette(brewer.pal(11,'Spectral'))(12)
  
  return(krg.res)
  p = ggplot()+
    geom_tile(data = krg.res,aes(x = long,y = lat,fill = pr),
              color = 'transparent')+
    #geom_point(data = df2,aes(x = long,y = lat),color = 'black',
    #           shape =1, size = 5)+
    scale_fill_gradientn(colours = mycolor)+
    theme_bw()+
    theme(
      axis.text =  element_text(face = 'bold',color = 'black',size = 12),
      axis.title =  element_text(face = 'bold',color = 'black',size = 14, hjust = .5),
      legend.text = element_text(face = 'bold',color = 'black',size = 12),
      legend.title = element_blank(),
      legend.position = 'bottom',
      legend.direction = 'horizontal',
      legend.key.width = unit(2,'cm')
    )+
    xlab('Longitude')+
    ylab('Latitude')
  
  return(p)
  png('krige.png',
      height = 20,
      width = 20,
      units = 'cm',
      res = 800)
  print(p)
  dev.off()
  
}





























land_dic_gong_glass_glc <- function(
  
){
  land_dic = c('0'= 'No data',
               '10' = 'Cropland',
               '20' = 'Forest',
               '30' = 'Grassland',
               '40' = 'Shrubland',
               '70' = 'Tundra',
               '90' = 'Barren land',
               '100' = 'Snow/ice')
  return(land_dic)
}
land_tas_mean_monthly_analysis <- function(
  
){
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  tas = data_management('global_era5_temperature')
  tas = tas - 273.15
  #tas = tas[[1:180]]
  world = shp_management('world')
  
  world = crop(world,extent(-180,180,0,90))
  
  tas = crop(tas,world)
  tas = mask(tas,world)
  
  janid = seq(1,180,12)
  febid = seq(2,180,12)
  marid = seq(3,180,12)
  aprid = seq(4,180,12)
  mayid = seq(5,180,12)
  junid = seq(6,180,12)
  julid = seq(7,180,12)
  augid = seq(8,180,12)
  sepid = seq(9,180,12)
  octid = seq(10,180,12)
  novid = seq(11,180,12)
  decid = seq(12,180,12)
  
  monid = list(janid,febid,marid,aprid,
               mayid,junid,julid,augid,
               sepid,octid,novid,decid)
  
  
  
  monid <<- monid
  tas <<- tas
  
  cell_mean_fun <-function(i){
    tmpid = monid[[i]]
    tmptas = tas[[tmpid]]
    
    
    tmptasdf = as.data.frame(tmptas,
                             xy = T)
    loc = tmptasdf[,1:2]
    tmptasdf = tmptasdf[,-c(1,2)]
    
    tmptasmean = apply(tmptasdf,1,mean
                       ,na.rm = T)
    retbox = cbind(loc,tmptasmean)
    return(retbox)
  }
  i = 1:length(monid)
  mon_mean_box = lapply(i,cell_mean_fun)
  
  tasmean1 = mon_mean_box[[1]]
  tasmean2 = mon_mean_box[[2]][,3]
  tasmean3 = mon_mean_box[[3]][,3]
  tasmean4 = mon_mean_box[[4]][,3]
  tasmean5 = mon_mean_box[[5]][,3]
  tasmean6 = mon_mean_box[[6]][,3]
  tasmean7 = mon_mean_box[[7]][,3]
  tasmean8 = mon_mean_box[[8]][,3]
  tasmean9 = mon_mean_box[[9]][,3]
  tasmean10 = mon_mean_box[[10]][,3]
  tasmean11 = mon_mean_box[[11]][,3]
  tasmean12 = mon_mean_box[[12]][,3]
  
  tasmean_mon = cbind(tasmean1,
                     tasmean2,
                     tasmean3,
                     tasmean4,
                     tasmean5,
                     tasmean6,
                     tasmean7,
                     tasmean8,
                     tasmean9,
                     tasmean10,
                     tasmean11,
                     tasmean12)
  
  output_tas_mean = 'analysis_output/fig3/landtas_mean.csv'
  #fwrite(mon_mean_box,output_tas_mean)
  fwrite(tasmean_mon,output_tas_mean)
  
  
}
land_tas_mmk_monthly_analysis <- function(
  
){
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  tas = data_management('global_era5_temperature')
  tas = tas - 273.15
  #tas = tas[[1:180]]
  world = shp_management('world')
  
  world = crop(world,extent(-180,180,0,90))
  
  tas = crop(tas,world)
  tas = mask(tas,world)
  
  janid = seq(1,180,12)
  febid = seq(2,180,12)
  marid = seq(3,180,12)
  aprid = seq(4,180,12)
  mayid = seq(5,180,12)
  junid = seq(6,180,12)
  julid = seq(7,180,12)
  augid = seq(8,180,12)
  sepid = seq(9,180,12)
  octid = seq(10,180,12)
  novid = seq(11,180,12)
  decid = seq(12,180,12)
  
  monid = list(janid,febid,marid,aprid,
               mayid,junid,julid,augid,
               sepid,octid,novid,decid)
  
  
  
  monid <<- monid
  tas <<- tas
  
  cell_mmk_fun <-function(i){
    tmpid = monid[[i]]
    tmptas = tas[[tmpid]]
    
    
    tmptasdf = as.data.frame(tmptas,
                             xy = T)
    loc = tmptasdf[,1:2]
    tmptasdf = tmptasdf[,-c(1,2)]
    tmptasdf <<- tmptasdf
    
    j <<- 1:nrow(tmptasdf)
    
    sub_fun <- function(j){
      tmptasv = as.numeric(tmptasdf[j,])
      source('/home/share/R_project/xinjiang_vapor/mmk_fundf.R')
      tmpmmk = mmk_fundf(tmptasv)
      return(tmpmmk)
    }
    
    
    cl = makeCluster(14)
    clusterExport(cl,c('tmptasdf','j'))
    tmptasmmk <- parLapply(cl,j,sub_fun)
    stopCluster(cl)
    
    tmptasmmk = do.call('c',tmptasmmk)
    
    retbox = cbind(loc,tmptasmmk)
    return(retbox)
  }
  i = 1:length(monid)
  mon_mmk_box = lapply(i,cell_mmk_fun)
  
  tasmmk1 = mon_mmk_box[[1]]
  tasmmk2 = mon_mmk_box[[2]][,3]
  tasmmk3 = mon_mmk_box[[3]][,3]
  tasmmk4 = mon_mmk_box[[4]][,3]
  tasmmk5 = mon_mmk_box[[5]][,3]
  tasmmk6 = mon_mmk_box[[6]][,3]
  tasmmk7 = mon_mmk_box[[7]][,3]
  tasmmk8 = mon_mmk_box[[8]][,3]
  tasmmk9 = mon_mmk_box[[9]][,3]
  tasmmk10 = mon_mmk_box[[10]][,3]
  tasmmk11 = mon_mmk_box[[11]][,3]
  tasmmk12 = mon_mmk_box[[12]][,3]
  
  tasmmk_mon = cbind(tasmmk1,
                      tasmmk2,
                      tasmmk3,
                      tasmmk4,
                      tasmmk5,
                      tasmmk6,
                      tasmmk7,
                      tasmmk8,
                      tasmmk9,
                      tasmmk10,
                      tasmmk11,
                      tasmmk12)
  
  output_tas_mmk = 'analysis_output/fig3/landtas_mmk.csv'
  #fwrite(mon_mmk_box,output_tas_mmk)
  fwrite(tasmmk_mon,output_tas_mmk)
  
  
}
linear_project_model <-function(
  df,df_project
){
  train_id = 1:(nrow(df)*0.7)
  train_in_order = df[train_id,]
  test_in_order = df[-train_id,]
  
  lmmodel = lm(tws~.,data = train_in_order)
  
  projtws = lmmodel$fitted.values
  
  coeff = lmmodel$coefficients
  
  train_tws = coeff[1]+coeff[2]*train_in_order[,2]+
    coeff[3]*train_in_order[,3]+
    coeff[4]*train_in_order[,4]+
    coeff[5]*train_in_order[,5]
  
  test_tws = coeff[1]+coeff[2]*test_in_order[,2]+
    coeff[3]*test_in_order[,3]+
    coeff[4]*test_in_order[,4]+
    coeff[5]*test_in_order[,5]
  
  proj_tws = coeff[1]+coeff[1]+coeff[2]*df_project[,1]+
    coeff[3]*df_project[,2]+
    coeff[4]*df_project[,3]+
    coeff[5]*df_project[,4]
  
  date = seq(as.Date('2003-01-01'),as.Date('2050-12-01'),'1 month')
  
  date_proj = date[175:576]
  a = ts(175:576,start = c(2017,7),
         frequency = 12)
  a = decompose(a)$trend
  naidfut = which(is.na(a))
  
  date_proj = date_proj[-naidfut]
  
  ret_train = data.frame(train_tws,train_in_order$tws)
  ret_test = data.frame(test_tws,test_in_order$tws)
  ret_proj = data.frame(date_proj,proj_tws)
  return(list(ret_train,ret_test,ret_proj))
  
}
linear_validate_pme <- function(
  df,df_project
){
  
  train_id = 1:(nrow(df)*0.7)
  train_in_order = df[train_id,]
  test_in_order = df[-train_id,]
  
  lmmodel = lm(pr~.,data = train_in_order)
  
  projtws = lmmodel$fitted.values
  
  return(cor(projtws,train_in_order[,1]))
}
liner_model <-function(
  df
){
  set.seed(100)
  id_train = sample(nrow(df),0.7*nrow(df),replace = FALSE)
  
  train = df[id_train,]
  test = df[-id_train,]
  
  model = lm(tws ~ ., data = df)
  
  pred_train = as.numeric(predict(model,train))
  pred_test = as.numeric(predict(model,test))
  
  train_id = 1:round(nrow(df)*0.7)
  train_in_order = df[train_id,]
  test_in_order = df[-train_id,]
  
  pred_train_in_order = predict(model,train_in_order)
  pred_test_in_order = predict(model,test_in_order)
  
  return(cbind(test_in_order$tws,pred_test_in_order))
}
main_analysis_yrb_crop_project<-function(
  
){
 # flexpart simulation
 # project in super computer 
 # post_preoce  
 
 # sub_crop_analysis 
}
main_analysis <- function(
  
){
  library(raster)
  library(maps)
  library(maptools)
  library(ggplot2)
  library(reshape2)
  library(RColorBrewer)
  library(data.table)
  library(foreach)
  library(doParallel)
  library(parallel)
  library(snow)
  # 0. Preprocess the loc and attributes
  source('/home/share/R_project/xinjiang_vapor/main_data_preprocess.R')
  source('/home/share/R_project/xinjiang_vapor/main_data_preprocess_mpi.R')
  #input_data_test = '/usr/local/flexpart_bk1/output'
  #input_data_test = '/media/sdb5/xinjiang200302/output'
  source('/home/share/R_project/xinjiang_vapor/check_output_number.R')
  input_data = check_output_number()
  gc()
  source('/home/share/R_project/xinjiang_vapor/back_chose_within_boundury.R')
  #main_data_preprocess_mpi(input_data) # input data refers to output path for all simulations
  
  #system.time(main_data_preprocess(input_data))# exports alldates_output.csv time budget 57.772s

  
  rm(list = ls())
  source('/home/share/R_project/xinjiang_vapor/check_output_number.R')
  source('/home/share/R_project/xinjiang_vapor/back_chose_within_boundury.R')
  input_data = check_output_number()
  system.time(back_chose_within_boundury(input_data)) #exports df_released_inxinjiang.csv time budget 393.866s
  gc()
  
  # world ocean shp combining
  # world_ocean_shp()
  
  # calculation the mid value along the route
  rm(list = ls())
  source('/home/share/R_project/xinjiang_vapor/check_output_number.R')
  source('/home/share/R_project/xinjiang_vapor/back_chose_within_boundury.R')
  input_data = check_output_number()
  source('/home/share/R_project/xinjiang_vapor/main_cal_dp_whole_route_mpi.R')
  # time budget: 90.094 s
  # export /var_whole_route_mid.csv
  system.time(main_cal_dp_whole_route_mpi(input_data))  
  gc()
  
  
  # mask mid df via continent and ocean 
  rm(list = ls())
  source('/home/share/R_project/xinjiang_vapor/check_output_number.R')
  source('/home/share/R_project/xinjiang_vapor/back_chose_within_boundury.R')
  input_data = check_output_number()
  source('/home/share/R_project/xinjiang_vapor/mask_points_via_world_continent.R')
  # time cost:555.474 s
  system.time(mask_points_via_world_continent(input_data)) # 
  gc()
  
  # cal sum dep in source and route region for lands and ocean respectively
  # for all particles
  source('/home/share/R_project/xinjiang_vapor/cal_dep_by_each_source_type.R')
  system.time(cal_dep_by_each_source_type(input_data))
  
  # cal total released in xinjiang region
  source('/home/share/R_project/xinjiang_vapor/main_cal_dqt_in_xinjiang.R')
  system.time(main_cal_dqt_in_xinjiang(input_data))
  
  # cal contribution rate
  source('/home/share/R_project/xinjiang_vapor/cal_contri_rate.R')
  system.time(cal_contri_rate(input_data))
  
  # cluster mean route
  source('/home/share/R_project/xinjiang_vapor/cluster_in_source.R')
  source('/home/share/R_project/xinjiang_vapor/mean_route_by_cl.R')
  system.time(cluster_in_source(input_data))
  
  # cal convey routes 
  cal_convey_rate_by_type()
  # monthly pattern analysis of convey routes
  source('/home/share/R_project/xinjiang_vapor/monthly_pattern_convey_rates.R')
  monthly_pattern_convey_rates()
  
  # filter date and combine hist and ssp 
  source('/home/share/R_project/xinjiang_vapor/outter_filter_cmip6_data_to_date.R')
  outter_filter_cmip6_data_to_date()
  
  # calculation of E-P in source region at particle scale
  source('/home/share/R_project/xinjiang_vapor/cal_ep_in_source_region.R')
  cal_ep_in_source_region()
  
  #outter_mask_crop_cmip6
  source('/home/share/R_project/xinjiang_vapor/outter_mask_crop_cmip6.R')
  outter_mask_crop_cmip6()
}
main_cal_dp_whole_route_mpi<-function(
  input_data
){
  
  library(raster)
  library(maps)
  library(maptools)
  library(ggplot2)
  library(reshape2)
  library(RColorBrewer)
  library(data.table)
  library(foreach)
  library(doParallel)
  library(parallel)
  library(snow)
  sub_cal<-function(input_sub)
  {
    print(input_sub)
    df = fread(paste0(input_sub,'/df_released_inxinjiang.csv'))
    #df = as.data.frame(df)
    # data_structure
    # c('long','lat','height','ep','type')
    
    # diveded as 100 groups
    group_id_xinjiang<-function(x){ # df_xinjiang as input
      step = nrow(x)/100
      ids = round(seq(1,nrow(x),step))
      ide = ids -1
      ide = ide[-1]
      ide = c(ide,nrow(x))
      
      # ide position to value{
      for(i in 1:(length(ide)-1)){
        tmpid = ide[i]
        tmptype = x[tmpid,]$type
        typeid = which(x$type == tmptype)
        print(typeid)
        typeidmax = max(typeid)
        if(typeidmax>tmpid){
          ide[i] = typeidmax
          ids[i+1] = ide[i]+1
        }
      }
      li = list()
      for(i in 1:length(ide)){
        tmps= ids[i]
        tmpe = ide[i]
        li[[i]]= x[tmps:tmpe,]
      }
      return(li)
    }
    li <<- group_id_xinjiang(df)
    #
    print('main_cal_dp_whole_route_mpi: pass group id!')
    source('/home/share/R_project/xinjiang_vapor/cal_dp_sub_pal.R')
    
    cl = makeCluster(15)
    clusterExport(cl,c('li'))
    system.time(
      ret_box <- parLapply(cl,li,cal_dp_sub_pal)
    )
    stopCluster(cl)
  
    ret_box = do.call('rbind',ret_box) # 
    
    print('main_cal_dp_whole_route_mpi: pass caclulation!')
    var_whole_route = ret_box
    # long lat height for mid, varep refers to variance of ep
    output = paste0(input_sub,'/var_whole_route_mid.csv')
    
    fwrite(var_whole_route,output)
    
  }
  sapply(input_data,sub_cal)
  
}
main_cal_dqt_in_xinjiang <- function(
  input_data
){
  library(raster)
  library(maps)
  library(maptools)
  library(ggplot2)
  library(reshape2)
  library(RColorBrewer)
  library(data.table)
  library(foreach)
  library(doParallel)
  library(parallel)
  library(snow)
  
  sub_cal_dqt <- function(
    input_sub
  ){
    # global variables
    # df_full
    
    # find not full index 
    source('/home/share/R_project/xinjiang_vapor/find_not_in_index.R')
    find_not_in_index(input_sub)
    
    df = fread(paste0(input_sub,'/masked_var_whole_route_mid.csv'))
    df_full <<- df
    
    source('/home/share/R_project/xinjiang_vapor/mask_via_each_ocean_dep_inxinjiang.R')
    mas_df = mask_via_each_ocean_dep_inxinjiang(df_full,names ='xj',pattern = 'xinjiang')
    
    tt_release = sum(mas_df$varep[which(mas_df$varep<0)])
    
    tt_release = abs(tt_release)
        
    output = paste0(input_sub,'/totoal_release_in_xinjiang')
    dir.create(output)
    output = paste0(output, '/total_released.csv')
    
    write.csv(tt_release,output)
   
    
  }
  sapply(input_data,sub_cal_dqt)
}
main_cal_dqt_mpi<-function(
  input_data
){
  
  source('/home/share/R_project/xinjiang_vapor/group_matrix_by_id.R')
  source('/home/share/R_project/xinjiang_vapor/calc_each_dqt_group.R')
  
  sub_cal<-function(input_sub)
  {
    source('/home/share/R_project/xinjiang_vapor/group_matrix_by_id.R')
    source('/home/share/R_project/xinjiang_vapor/calc_each_dqt_group.R')
    
    df = fread(paste0(input_sub,'/var_whole_route_mid.csv'))
    df = as.data.frame(df)
    # data_structure
    # c('long','lat','height','ep','type')
    
    # Calculation of total released in Xinjiang Extent
    shp_path = '/usr/local/flexpart_bk1/shp/Xinjiang_border.shp'
    xinjiang_shp = shapefile(shp_path)
    ## crop releasing zone
    dfc = df
    coordinates(dfc) = ~ long+lat
    proj4string(dfc) = "+proj=longlat +datum=WGS84 +no_defs"
    df_m = over(dfc,xinjiang_shp)
    df_index = which(!is.na(df_m[,1]))
    df_m = dfc[df_index,]
    df_xinjiang = as.data.frame(df_m,xy = T)
    #back chosing id
    id_inzone = unique(df_xinjiang$type)
    
    df_full <<- df
    df_xinjiang <<- df_xinjiang
    
    group_id_route<-function(x){ # df_xinjiang as input
      step = nrow(x)/100
      ids = round(seq(1,nrow(x),step))
      ide = ids -1
      ide = ide[-1]
      ide = c(ide,nrow(x))
      
      # ide position to value{
      for(i in 1:(length(ide)-1)){
        tmpid = ide[i]
        tmptype = x[tmpid,]$type
        typeid = which(x$type == tmptype)
        print(typeid)
        typeidmax = max(typeid)
        if(typeidmax>tmpid){
          ide[i] = typeidmax
          ids[i+1] = ide[i]+1
        }
      }
      li = list()
      for(i in 1:length(ide)){
        tmps= ids[i]
        tmpe = ide[i]
        li[[i]]= x[tmps:tmpe,]
      }
      return(li)
    }
    li_xinjiang = group_id_route(df_xinjiang)
    
    system.time(ret_box <- lapply(li_xinjiang,calc_each_dqt_group))
    ret_box = do.call('c',ret_box) # 
    tt_release = sum(ret_box)
    
    return(ret_box)
    print(tt_release)
    output = paste0(input_sub,'/totoal_release_in_xinjiang')
    dir.create(output)
    output = paste0(output, '/total_released.csv')
    
    write.csv(tt_release,output)
    
    
  }
  
  ret = sapply(input_data,sub_cal)
  return(ret)
}
main_cal_dqt<-function(
  input_data
){
  
  
  sub_cal<-function(input_sub)
  {
     df = fread(paste0(input_sub,'/var_whole_route_mid.csv'))
     df = as.data.frame(df)
     # data_structure
     # c('long','lat','height','ep','type')
     
     # Calculation of total released in Xinjiang Extent
     shp_path = '/usr/local/flexpart_bk1/shp/Xinjiang_border.shp'
     xinjiang_shp = shapefile(shp_path)
     ## crop releasing zone
     dfc = df
     coordinates(dfc) = ~ long+lat
     proj4string(dfc) = "+proj=longlat +datum=WGS84 +no_defs"
     df_m = over(dfc,xinjiang_shp)
     df_index = which(!is.na(df_m[,1]))
     df_m = dfc[df_index,]
     df_xinjiang = as.data.frame(df_m,xy = T)
     #back chosing id
     id_inzone = unique(df_xinjiang$type)
     
     df <<- df
     df_xinjiang <<- df_xinjiang
     calc_each_dqt_inzone <- function(id_inzone){
       tmpid = which(df_xinjiang$type == id_inzone)
       
       if(length(tmpid)==1){
         tmpidfull = which(df$type == id_inzone)
         len1 = length(tmpidfull)
         len2 = len1 -1
         tmpdf = df[c(len1,len2),]
         
         tmpdq = tmpdf$ep[2] - tmpdf$ep[1]
       }else if (length(tmpid) ==2){
         tmpdf = df_xinjiang[tmpid,]
         tmpdq = tmpdf$ep[2] - tmpdf$ep[1]
       }else{
         len1 = length(tmpid)
         len2 = len1 - 1
         tmpdq1 = df_xinjiang$ep[2:len1]
         tmpdq2 = df_xinjiang$ep[1:len2]
         tmpdq = tmpdq2-tmpdq1
         tmpdq = sum(tmpdq)
       }
       return(tmpdq)
     }
     
     dqinzone = sapply(id_inzone,calc_each_dqt_inzone)
     
     p = ggplot()+
       geom_polygon(data = xinjiang_shp,aes(x = long,y = lat,group = group),fill= 'white')+
       geom_point(data = df_xinjiang,aes(x = long,y = lat),color= 'blue')
     
     png('plot_point.png',
         height = 15,
         width = 20,
         units = 'cm',
         res = 800)
     print(p)
     dev.off()
     
     
     
     
     
     
     calc_per_traj <- function(id){
       tmpid = which(df$type == id)
       dfpt = df[tmpid,]
       
       
     }
   
  }
  
  
}
main_cal_relesed_inxinjiang <- function(
  input_data
){
  library(raster)
  library(maps)
  library(maptools)
  library(ggplot2)
  library(reshape2)
  library(RColorBrewer)
  library(data.table)
  library(foreach)
  library(doParallel)
  library(parallel)
  library(snow)
  
  sub_cal_dqt <- function(
    input_sub
  ){
    # global variables
    # df_full
    
    # find not full index 
    #source('/home/share/R_project/xinjiang_vapor/find_not_in_index.R')
    #find_not_in_index(input_sub)
    
    print(input_sub)
    df = fread(paste0(input_sub,'/masked_var_whole_route_mid.csv'))
    df_full <<- df
    
    source('/home/share/R_project/xinjiang_vapor/mask_via_each_ocean_dep_inxinjiang.R')
    mas_df = mask_via_each_ocean_dep_inxinjiang(df_full,names ='xj',pattern = 'xinjiang')
    
    sum_fun_neg<-function(x){
      xs = sum(x[which(x <0)])
    }
    
    released_by_type = aggregate(mas_df$varep,list(mas_df$type),sum_fun_neg)
    #released_by_type = released_by_type[-which(released_by_type$x == 0),]
    
    tt_release = sum(released_by_type$x)
    
    output_released = paste0(input_sub,'/released_by_type.csv')
    fwrite(released_by_type,output_released)
    
    # cal 
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    input_ocean_contr = paste0(input_sub,'/contr_ocean')
    input_ocean_contr = paste0(input_ocean_contr,'/',oce_names,'.csv')
    
    output_ocean_contr = paste0(input_sub,'/contr_released_ocean')
    dir.create(output_ocean_contr)
    output_ocean_contr = paste0(output_ocean_contr,'/',oce_names,'.csv')
  
    
    source('/home/share/R_project/xinjiang_vapor/match_by_id.R')
    
    sub_find_oce_fun<-function(i){
      if(file.exists(input_ocean_contr[i])){
        match_by_id(output_released,input_ocean_contr[i],mode = oce_names[i],output_ocean_contr[i])  
      }
    }
    
    i = 1:length(oce_names)
    lapply(i,sub_find_oce_fun)
    
    
    con_names = c('as','xj','eu','naf','na')
    input_land_contr = paste0(input_sub,'/contr_land')
    input_land_contr = paste0(input_land_contr,'/',con_names,'.csv')
    
    output_land_contr = paste0(input_sub,'/contr_released_land')
    dir.create(output_land_contr)
    output_land_contr = paste0(output_land_contr,'/',con_names,'.csv')
    
    
    sub_find_con_fun<-function(i){
      if(file.exists(input_land_contr[i])){
        match_by_id(output_released,input_land_contr[i],mode = con_names[i],output_land_contr[i])  
      }
      
    }
    
    i = 1:length(con_names)
    lapply(i,sub_find_con_fun)
    
    
    
  }
  sapply(input_data,sub_cal_dqt)
}
main_cluster<-function(
  input_data
){
  library(doParallel)
  library(snow)
  library(foreach)
  library(parallel)
  library(factoextra)
  library(vegan)
  
  
  sub_cluster<-function(input_sub){
    input_file = paste0(input_sub,'/alldates_output.csv')
    df = fread(input_file)
    
    id = unique(df$type)
    id <<- as.numeric(id)
    idfull <<- df$type
    
    ids = id
    xfull <<- df$type
    group_id <- function(x){
      step = round(length(x) /100)
      ids = seq(1,length(x),step)
      ide = ids -1
      ide = ide[-1]
      ide = c(ide,length(x))
      xl = list()
      for(i in 1:length(ids)){
        stmp = ids[i]
        etmp = ide[i]
        tmp = x[stmp:etmp]
        xl[[i]] = tmp
      }
      return(xl)
    }
    idsl = group_id(ids)
    system.time(ret_b <- lapply(idsl, search_which))
  
    ret_box = do.call('c',ret_b)
    
    df = as.data.frame(df)
    df_first = df[ret_box,1:4]
  
    
    ca_clust = cascadeKM(df_first,1,10,iter = 10)
    cal_best = as.numeric(which.max(ca_clust$results[2,]))
    
    cluster_mod = kmeans(df_first,4)
    cluster = cluster_mod$cluster
    
    df_first$cluster = cluster
    output_cl = paste0(input_sub,'/output_cluster.csv')
    
    #fwrite(ret_box,output_cl)
    
    
    p = ggplot()+
      geom_point(data = df_first,aes(x = long,y = lat,color =cluster))+
      geom_polygon(data = shp,aes(x = long,y= lat,group = group),
                   color = 'black',fill = 'transparent')+
      scale_color_distiller(palette = 'Spectral')+
      theme_bw()
    p
  }
  sapply(input_data,sub_cluster)
  
  
  
}
main_data_preprocess_mpi<-function(
  input_data
){
  
  sub_data_preprocess_mpi<-function(
    input_sub # sub input file of input_data
    
  ){
    parnum = 500000
    input_loc = list.files(input_sub,pattern = '*loc.csv$',full.names = T)
    input_attr = list.files(input_sub,pattern = '*var.csv$',full.names = T)
    input_mass = list.files(input_sub,pattern = '*mass.csv$',full.names = T)
    
    # reverse the time from source to region
    #input_loc = rev(input_loc)
    #input_attr = rev(input_attr)
    #input_mass = rev(input_mass)
    
    longb = 1
    latb = 1
    heightb = 1
    epb = 1
    for(i in 1:length(input_loc)){
      loctmp = fread(input_loc[i])
      attrtmp = fread(input_attr[i])
      masstmp = fread(input_mass[i])
      
      loctmp = as.data.frame(loctmp)
      attrtmp = as.data.frame(attrtmp)
      masstmp = as.data.frame(masstmp)
      
      longtmp = loctmp[,1]
      lattmp = loctmp[,2]
      height = loctmp[,3]
      sh = attrtmp[,1]
      mass = masstmp[,1]
      
      if(is.na(mean(sh))){
        sh = rep(0,length(sh))
      }
      
      ep = sh*mass
      #print(length(longtmp))
      
      if(length(longtmp) < parnum){
        less_num = parnum - length(longtmp)
        longtmp = c(longtmp,rep(NA,less_num))
        lattmp = c(lattmp,rep(NA,less_num))
        height = c(height,rep(NA,less_num))
        ep = c(ep,rep(NA,less_num))
      }
      
      longb = rbind(longb,longtmp)
      latb = rbind(latb,lattmp)
      heightb = rbind(heightb,height)
      epb = rbind(epb,ep)
    }
    longb = longb[-1,]
    latb = latb[-1,]
    heightb = heightb[-1,]
    epb = epb[-1,]
    
    longb <<- longb
    latb <<- latb
    heightb <<- heightb
    epb <<- epb
    
    print(ncol(longb))
    
    # mpi modification starts here
    
    mpi_trans<-function(ncolid){
      longtmp = longb[,ncolid]
      lattmp = latb[,ncolid]
      height = heightb[,ncolid]
      ep = epb[,ncolid]
      type = ncolid
      mattmp = cbind(longtmp,lattmp,height,ep,type)
      
      return(mattmp)
    }
    
    #cl = makeCluster(detectCores()-1)
    cl = makeCluster(2)
    clusterExport(cl,c('longb','latb','heightb','epb'))
    system.time(
      mat <- parLapply(cl,1:ncol(longb),mpi_trans)
    )
    stopCluster(cl)
    
    matr = do.call('rbind',mat)
    
    colnames(matr) = c('long','lat','height','ep','type')
    
    naid = which(is.na(matr[,1]))
    matr = matr[-naid,]
    output_mat = paste0(input_sub,'/alldates_output.csv')
    print(output_mat)
    fwrite(matr,output_mat)
    #return(mat)
    
  }
  
  sapply(input_data,sub_data_preprocess_mpi)
}
main_data_preprocess<-function(
  input_data
){
  
  sub_data_preprocess<-function(
    input_sub # sub input file of input_data
   
  ){
    parnum = 500000
    input_loc = list.files(input_sub,pattern = '*loc.csv$',full.names = T)
    input_attr = list.files(input_sub,pattern = '*var.csv$',full.names = T)
    input_mass = list.files(input_sub,pattern = '*mass.csv$',full.names = T)
    
    # reverse the time from source to region
    #input_loc = rev(input_loc)
    #input_attr = rev(input_attr)
    #input_mass = rev(input_mass)
    
    longb = 1
    latb = 1
    heightb = 1
    epb = 1
    for(i in 1:length(input_loc)){
      loctmp = fread(input_loc[i])
      attrtmp = fread(input_attr[i])
      masstmp = fread(input_mass[i])
      
      loctmp = as.data.frame(loctmp)
      attrtmp = as.data.frame(attrtmp)
      masstmp = as.data.frame(masstmp)
      
      longtmp = loctmp[,1]
      lattmp = loctmp[,2]
      height = loctmp[,3]
      sh = attrtmp[,1]
      mass = masstmp[,1]
      
      if(is.na(mean(sh))){
        sh = rep(0,length(sh))
      }
      
      ep = sh*mass
      print(length(longtmp))
      
      if(length(longtmp) < parnum){
        less_num = parnum - length(longtmp)
        longtmp = c(longtmp,rep(NA,less_num))
        lattmp = c(lattmp,rep(NA,less_num))
        height = c(height,rep(NA,less_num))
        ep = c(ep,rep(NA,less_num))
      }
      
      longb = rbind(longb,longtmp)
      latb = rbind(latb,lattmp)
      heightb = rbind(heightb,height)
      epb = rbind(epb,ep)
    }
    longb = longb[-1,]
    latb = latb[-1,]
    heightb = heightb[-1,]
    epb = epb[-1,]
    
    print(ncol(longb))
    type = rep(1:ncol(longb),each = nrow(longb))
    
    print('start as vector')
    longtmp = as.vector(longb)
    lattmp = as.vector(latb)
    heigthtmp = as.vector(heightb)
    eptmp = as.vector(epb)
    
    mat = cbind(longtmp,lattmp,heigthtmp,eptmp,type)
    mat = as.data.frame(mat)
    
    colnames(mat) = c('long','lat','height','ep','type')
    
    naid = which(is.na(mat[,1]))
    mat = mat[-naid,]
    output_mat = paste0(input_sub,'/alldates_output.csv')
    print(output_mat)
    fwrite(mat,output_mat)
    #return(mat)
    
  }
  
  sapply(input_data,sub_data_preprocess)
}
main_plot_xinjiang_vapor <-function(
  
){
  # Fig 1 
  # (a) Long term Contribution Rates
  # (b) Study Area Regionalization 
  # (c) Monthly pattern of contribution 
  source('/home/share/R_project/xinjiang_vapor/fig1_plot_xinjiang_vapor.R')
  fig1_plot_xinjiang_vapor()
  
  
}
main_plot <- function(
  
){
  # plot management 
  source('/home/share/R_project/xinjiang_vapor/fig1_plot_xinjiang_vapor.R')
  fig1_plot_xinjiang_vapor()
  
  # fig2 
  source('/home/share/R_project/xinjiang_vapor/fig2_plot_xinjiang_vapor.R')
}
main_proj_cmip6_pme_and_proj_tws <- function(
  
){
  bias_correct_cmip6_pme_trend()
  bias_correct_cmip6_pme_trend1()
  correct_fut_pme_trend()
  correct_fut_pme_trend1()
  
  predict_model_based_era5_proj_by_cmip6_proj_trend()
  fig4_projection_of_tws_subs_version4_proj_trend()
}
main_supplementary_figures <- function(
  
){
  # figs 8 plot done 
  # era5 traing and validation model
  source('/home/share/R_project/xinjiang_vapor/figs8_plot.R')
  figs8_plot()
  
  # figs 9 plot
  # era5 random forest model importance
  source('/home/share/R_project/xinjiang_vapor/figs10_plot.R')
  figs10_plot()
  
  # figs 10 plot
  # cor barplot projection based on cmip6 pme and tws in sws
  source('/home/share/R_project/xinjiang_vapor/figs_cmip6_tws_pme_cor.R')
  figs_cmip6_tws_pme_cor()
  
  # figs.
  
}
mask_crop_cmip6_pme<- function(
  mode = 'ato'
){
  #input file 
  input_cmip6 = '/media/root/Shen_drive1/CMIP6_combined'
  e_hist_ssp245 = list.files(paste0(input_cmip6,'/E/hist_ssp245'),full.names = T)
  e_hist_ssp585 = list.files(paste0(input_cmip6,'/E/hist_ssp585'),full.names = T)
  pr_hist_ssp245 = list.files(paste0(input_cmip6,'/Pr/hist_ssp245'),full.names = T)
  pr_hist_ssp585 = list.files(paste0(input_cmip6,'/Pr/hist_ssp585'),full.names = T)
  
  e_hist_ssp245 <<- e_hist_ssp245
  e_hist_ssp585 <<- e_hist_ssp585
  pr_hist_ssp245 <<- pr_hist_ssp245
  pr_hist_ssp585 <<- pr_hist_ssp585
  
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  # output file
  
  
  
  
  # 3. cal the sum of total ep
  # units of evapor = mm/s to mm/month *86400*30.5
  # units of pr = mm/s to mm/month *86400*30.5
  
  output_ep = '/media/root/Shen_drive1/CMIP6_pme'
  dir.create(output_ep)
  output_ep = paste0(output_ep,'/',mode)
  dir.create(output_ep)
  
  ep_ssp245 = paste0(output_ep,'/hist_ssp245')
  ep_ssp585 = paste0(output_ep,'/hist_ssp585')
  
  dir.create(ep_ssp245)
  dir.create(ep_ssp585)
  
  ep_ssp245_region = paste0(ep_ssp245,'/','region',1:4)
  ep_ssp585_region = paste0(ep_ssp585,'/','region',1:4)
  
  sapply(ep_ssp245_region,dir.create)
  sapply(ep_ssp585_region,dir.create)
  
  output_name245 = list.files(paste0(input_cmip6,'/E/hist_ssp245'))
  output_name585 = list.files(paste0(input_cmip6,'/E/hist_ssp585'))
  
  output_region245 = paste0(rep(ep_ssp245_region,8),'/',rep(output_name245,each = 4))
  output_region585 = paste0(rep(ep_ssp585_region,8),'/',rep(output_name585,each = 4))
  
  output_region245 = list(output_region245[1:4],
                          output_region245[5:8],
                          output_region245[9:12],
                          output_region245[13:16],
                          output_region245[17:20],
                          output_region245[21:24],
                          output_region245[25:28],
                          output_region245[29:32])
  output_region585 = list(output_region585[1:4],
                          output_region585[5:8],
                          output_region585[9:12],
                          output_region585[13:16],
                          output_region585[17:20],
                          output_region585[21:24],
                          output_region585[25:28],
                          output_region585[29:32])
  output_region245 <<- output_region245
  output_region585 <<- output_region585
  
  mode <<- mode
  sub_mask_hist_ssp245 <- function(i){
    # using 2003-201412 to training
    library(raster)
    library(ncdf4)
    
    tmpe = stack(e_hist_ssp245[i])
    tmppr = stack(pr_hist_ssp245[i])
    
    tmpe = tmpe*86400*30.5
    tmppr = tmppr*86400*30.5
    
    tmpep = tmppr-tmpe
    
    poly = shapefile(input_poly)
    
    # 1. mask by shapefile polygon 
    tmpep = mask(tmpep,poly)
    # 2. crop by sub-regions 
    r1 = shapefile(input_crop[1])    
    r2 = shapefile(input_crop[2])    
    r3 = shapefile(input_crop[3])    
    r4 = shapefile(input_crop[4])    
    
    tmpep1 <- crop(tmpep,r1)
    tmpep2 <- crop(tmpep,r2)
    tmpep3 <- crop(tmpep,r3)
    tmpep4 <- crop(tmpep,r4)
    
    
    tmpoutput1 = output_region245[[i]][1]
    tmpoutput2 = output_region245[[i]][2]
    tmpoutput3 = output_region245[[i]][3]
    tmpoutput4 = output_region245[[i]][4]
    
    writeRaster(tmpep1,tmpoutput1,format = 'CDF',overwrite = T)
    writeRaster(tmpep2,tmpoutput2,format = 'CDF',overwrite = T)
    writeRaster(tmpep3,tmpoutput3,format = 'CDF',overwrite = T)
    
    if(mode == 'eu' & i ==3){
      tmpep4  = as.data.frame(tmpep4,xy = T)
      library(data.table)
      fwrite(tmpep4,'/media/root/Shen_drive1/CMIP6_pme/eu/hist_ssp245/region4/his245_CanESM5_200301_205012.csv')
    } else{
      writeRaster(tmpep4,tmpoutput4,format = 'CDF',overwrite = T)
    }
    
    
    
    
  }
  
  sub_mask_hist_ssp585 <- function(i){
    # using 2003-201412 to training
    library(raster)
    library(ncdf4)
    
    tmpe = stack(e_hist_ssp585[i])
    tmppr = stack(pr_hist_ssp585[i])
    
    tmpe = tmpe*86400*30.5
    tmppr = tmppr*86400*30.5
    
    tmpep = tmppr-tmpe
    
    poly = shapefile(input_poly)
    
    # 1. mask by shapefile polygon 
    tmpep = mask(tmpep,poly)
    # 2. crop by sub-regions 
    r1 = shapefile(input_crop[1])    
    r2 = shapefile(input_crop[2])    
    r3 = shapefile(input_crop[3])    
    r4 = shapefile(input_crop[4])    
    
    tmpep1 <<- crop(tmpep,r1)
    tmpep2 <<- crop(tmpep,r2)
    tmpep3 <<- crop(tmpep,r3)
    tmpep4 <<- crop(tmpep,r4)
    
    tmpoutput1 = output_region585[[i]][1]
    tmpoutput2 = output_region585[[i]][2]
    tmpoutput3 = output_region585[[i]][3]
    tmpoutput4 = output_region585[[i]][4]
    
    writeRaster(tmpep1,tmpoutput1,format = 'CDF',overwrite = T)
    writeRaster(tmpep2,tmpoutput2,format = 'CDF',overwrite = T)
    writeRaster(tmpep3,tmpoutput3,format = 'CDF',overwrite = T)
    
    if(mode == 'eu' & i ==3){
      tmpep4  = as.data.frame(tmpep4,xy = T)
      library(data.table)
      fwrite(tmpep4,'/media/root/Shen_drive1/CMIP6_pme/eu/hist_ssp585/region4/his585_CanESM5_200301_205012.csv')
    } else{
      writeRaster(tmpep4,tmpoutput4,format = 'CDF',overwrite = T)
    }
    
    
    
  }
  
  i = 1:length(e_hist_ssp245)
  i <<- i
  library(doParallel)
  #cl = makeCluster(8)
  #clusterExport(cl,c('e_hist_ssp245','pr_hist_ssp245','input_poly','input_crop',
  #                   'output_region245'))
  #system.time(parLapply(cl,i,sub_mask_hist_ssp245))
  #stopCluster(cl)
  
  
  cl = makeCluster(8)
  clusterExport(cl,c('e_hist_ssp585','pr_hist_ssp585','input_poly','input_crop',
                     'output_region585'))
  system.time(parLapply(cl,i,sub_mask_hist_ssp585))
  stopCluster(cl)
  
  print(paste0('pass_',mode))  
}
mask_crop_cmip6_ssp585 <- function(
  mode = 'ato'
){
  #input file 
  input_cmip6 = '/media/root/Shen_drive1/CMIP6_combined'
  e_hist_ssp245 = list.files(paste0(input_cmip6,'/E/hist_ssp245'),full.names = T)
  e_hist_ssp585 = list.files(paste0(input_cmip6,'/E/hist_ssp585'),full.names = T)
  pr_hist_ssp245 = list.files(paste0(input_cmip6,'/Pr/hist_ssp245'),full.names = T)
  pr_hist_ssp585 = list.files(paste0(input_cmip6,'/Pr/hist_ssp585'),full.names = T)
  
  e_hist_ssp245 <<- e_hist_ssp245
  e_hist_ssp585 <<- e_hist_ssp585
  pr_hist_ssp245 <<- pr_hist_ssp245
  pr_hist_ssp585 <<- pr_hist_ssp585
  
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  # output file
  
  
  
  
  # 3. cal the sum of total ep
  # units of evapor = mm/s to mm/month *86400*30.5
  # units of pr = mm/s to mm/month *86400*30.5
  
  output_ep = '/media/root/Shen_drive1/CMIP6_pme'
  dir.create(output_ep)
  output_ep = paste0(output_ep,'/',mode)
  dir.create(output_ep)
  
  ep_ssp245 = paste0(output_ep,'/hist_ssp245')
  ep_ssp585 = paste0(output_ep,'/hist_ssp585')
  
  dir.create(ep_ssp245)
  dir.create(ep_ssp585)
  
  ep_ssp245_region = paste0(ep_ssp245,'/','region',1:4)
  ep_ssp585_region = paste0(ep_ssp585,'/','region',1:4)
  
  sapply(ep_ssp245_region,dir.create)
  sapply(ep_ssp585_region,dir.create)
  
  output_name245 = list.files(paste0(input_cmip6,'/E/hist_ssp245'))
  output_name585 = list.files(paste0(input_cmip6,'/E/hist_ssp585'))
  
  output_region245 = paste0(rep(ep_ssp245_region,8),'/',rep(output_name245,each = 4))
  output_region585 = paste0(rep(ep_ssp585_region,8),'/',rep(output_name585,each = 4))
  
  output_region245 = list(output_region245[1:4],
                          output_region245[5:8],
                          output_region245[9:12],
                          output_region245[13:16],
                          output_region245[17:20],
                          output_region245[21:24],
                          output_region245[25:28],
                          output_region245[29:32])
  output_region585 = list(output_region585[1:4],
                          output_region585[5:8],
                          output_region585[9:12],
                          output_region585[13:16],
                          output_region585[17:20],
                          output_region585[21:24],
                          output_region585[25:28],
                          output_region585[29:32])
  output_region245 <<- output_region245
  output_region585 <<- output_region585
  
  mode <<- mode
  sub_mask_hist_ssp245 <- function(i){
    # using 2003-201412 to training
    library(raster)
    library(ncdf4)
    
    tmpe = stack(e_hist_ssp245[i])
    tmppr = stack(pr_hist_ssp245[i])
    
    tmpe = tmpe*86400*30.5
    tmppr = tmppr*86400*30.5
    
    tmpep = tmppr-tmpe
    
    poly = shapefile(input_poly)
    
    # 1. mask by shapefile polygon 
    tmpep = mask(tmpep,poly)
    # 2. crop by sub-regions 
    r1 = shapefile(input_crop[1])    
    r2 = shapefile(input_crop[2])    
    r3 = shapefile(input_crop[3])    
    r4 = shapefile(input_crop[4])    
    
    tmpep1 <- crop(tmpep,r1)
    tmpep2 <- crop(tmpep,r2)
    tmpep3 <- crop(tmpep,r3)
    tmpep4 <- crop(tmpep,r4)
    
    
    tmpoutput1 = output_region245[[i]][1]
    tmpoutput2 = output_region245[[i]][2]
    tmpoutput3 = output_region245[[i]][3]
    tmpoutput4 = output_region245[[i]][4]
    
    writeRaster(tmpep1,tmpoutput1,format = 'CDF',overwrite = T)
    writeRaster(tmpep2,tmpoutput2,format = 'CDF',overwrite = T)
    writeRaster(tmpep3,tmpoutput3,format = 'CDF',overwrite = T)
    
    if(mode == 'eu' & i ==3){
      tmpep4  = as.data.frame(tmpep4,xy = T)
      library(data.table)
      fwrite(tmpep4,'/media/root/Shen_drive1/CMIP6_e-p/eu/hist_ssp245/region4/his245_CanESM5_200301_205012.csv')
    } else{
      writeRaster(tmpep4,tmpoutput4,format = 'CDF',overwrite = T)
    }
    
    
    
    
  }
  
  sub_mask_hist_ssp585 <- function(i){
    # using 2003-201412 to training
    library(raster)
    library(ncdf4)
    
    tmpe = stack(e_hist_ssp585[i])
    tmppr = stack(pr_hist_ssp585[i])
    
    tmpe = tmpe*86400*30.5
    tmppr = tmppr*86400*30.5
    
    tmpep = tmpe-tmppr
    
    poly = shapefile(input_poly)
    
    # 1. mask by shapefile polygon 
    tmpep = mask(tmpep,poly)
    # 2. crop by sub-regions 
    r1 = shapefile(input_crop[1])    
    r2 = shapefile(input_crop[2])    
    r3 = shapefile(input_crop[3])    
    r4 = shapefile(input_crop[4])    
    
    tmpep1 <<- crop(tmpep,r1)
    tmpep2 <<- crop(tmpep,r2)
    tmpep3 <<- crop(tmpep,r3)
    tmpep4 <<- crop(tmpep,r4)
    
    tmpoutput1 = output_region585[[i]][1]
    tmpoutput2 = output_region585[[i]][2]
    tmpoutput3 = output_region585[[i]][3]
    tmpoutput4 = output_region585[[i]][4]
    
    writeRaster(tmpep1,tmpoutput1,format = 'CDF',overwrite = T)
    writeRaster(tmpep2,tmpoutput2,format = 'CDF',overwrite = T)
    writeRaster(tmpep3,tmpoutput3,format = 'CDF',overwrite = T)
    
    if(mode == 'eu' & i ==3){
      tmpep4  = as.data.frame(tmpep4,xy = T)
      library(data.table)
      fwrite(tmpep4,'/media/root/Shen_drive1/CMIP6_e-p/eu/hist_ssp585/region4/his585_CanESM5_200301_205012.csv')
    } else{
      writeRaster(tmpep4,tmpoutput4,format = 'CDF',overwrite = T)
    }
    
    
    
  }
  
  #i = 1:length(e_hist_ssp245)
  #i <<- i
  #library(doParallel)
  #cl = makeCluster(8)
  #clusterExport(cl,c('e_hist_ssp245','pr_hist_ssp245','input_poly','input_crop',
  #                   'output_region245'))
  #system.time(parLapply(cl,i,sub_mask_hist_ssp245))
  #stopCluster(cl)
  
  
  cl = makeCluster(8)
  clusterExport(cl,c('e_hist_ssp585','pr_hist_ssp585','input_poly','input_crop',
                     'output_region585'))
  system.time(parLapply(cl,i,sub_mask_hist_ssp585))
  stopCluster(cl)
  
  print(paste0('pass_',mode))  
}
mask_crop_cmip6_sst<- function(
  mode = 'ato'
){
  library(raster)
  library(data.table)
  library(ncdf4)
  #input file 
  input_cmip6 = '/media/root/Shen_drive1/CMIP6_combined'
  sst_hist_ssp245 = list.files(paste0(input_cmip6,'/SST/hist_ssp245'),full.names = T)
  sst_hist_ssp585 = list.files(paste0(input_cmip6,'/SST/hist_ssp585'),full.names = T)
  
  sst_hist_ssp245 <<- sst_hist_ssp245
  sst_hist_ssp585 <<- sst_hist_ssp585
  
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  # output file
  
  
  
  
  # 3. cal the sum of total ep
  # units of evapor = mm/s to mm/month *86400*30.5
  # units of pr = mm/s to mm/month *86400*30.5
  
  output_sst = '/media/root/Shen_drive1/CMIP6_mask_sst'
  dir.create(output_sst)
  output_ep = paste0(output_sst,'/',mode)
  dir.create(output_sst)
  
  sst_ssp245 = paste0(output_sst,'/hist_ssp245')
  sst_ssp585 = paste0(output_sst,'/hist_ssp585')
  
  dir.create(sst_ssp245)
  dir.create(sst_ssp585)
  
  sst_ssp245_region = paste0(sst_ssp245,'/','region',1:4)
  sst_ssp585_region = paste0(sst_ssp585,'/','region',1:4)
  
  sapply(sst_ssp245_region,dir.create)
  sapply(sst_ssp585_region,dir.create)
  
  output_name245 = list.files(paste0(input_cmip6,'/SST/hist_ssp245'))
  output_name585 = list.files(paste0(input_cmip6,'/SST/hist_ssp585'))
  
  output_region245 = paste0(rep(sst_ssp245_region,8),'/',rep(output_name245,each = 4))
  output_region585 = paste0(rep(sst_ssp585_region,8),'/',rep(output_name585,each = 4))
  
  output_region245 = list(output_region245[1:4],
                          output_region245[5:8],
                          output_region245[9:12],
                          output_region245[13:16],
                          output_region245[17:20],
                          output_region245[21:24],
                          output_region245[25:28],
                          output_region245[29:32])
  output_region585 = list(output_region585[1:4],
                          output_region585[5:8],
                          output_region585[9:12],
                          output_region585[13:16],
                          output_region585[17:20],
                          output_region585[21:24],
                          output_region585[25:28],
                          output_region585[29:32])
  output_region245 <<- output_region245
  output_region585 <<- output_region585
  
  mode <<- mode
  sub_mask_hist_ssp245 <- function(i){
    # using 2003-201412 to training
    library(raster)
    library(ncdf4)
    library(data.table)
    
    tmpsst = try(stack(sst_hist_ssp245[i]),
               silent = T)
    poly = shapefile(input_poly)
    
    r1 = shapefile(input_crop[1])    
    r2 = shapefile(input_crop[2])    
    r3 = shapefile(input_crop[3])    
    r4 = shapefile(input_crop[4]) 
    if('try-error' %in% class(tmpsst)){
      tmpsst = fread(sst_hist_ssp245[i])
      tmpsst = as.data.frame(tmpsst)
      
      loc = tmpsst[,1:3]
      naid = which(is.na(loc[,3]))
      
      loc  =loc[-naid,]
      tmpsst = tmpsst[-naid,]
      
      loc = tmpsst[,1:2]
      # import sub regions
      r1e = extent(r1)
      r2e = extent(r2)
      r3e = extent(r3)
      r4e = extent(r4)
      
      id1 = which(loc[,1]>=r1e[1] &
                    loc[,1]<=r1e[2] &
                    loc[,2]>=r1e[3] &
                    loc[,2]<=r1e[4])
      id2 = which(loc[,1]>=r2e[1] &
                    loc[,1]<=r2e[2] &
                    loc[,2]>=r2e[3] &
                    loc[,2]<=r2e[4])
      id3 = which(loc[,1]>=r3e[1] &
                    loc[,1]<=r3e[2] &
                    loc[,2]>=r3e[3] &
                    loc[,2]<=r3e[4])
      id4 = which(loc[,1]>=r4e[1] &
                    loc[,1]<=r4e[2] &
                    loc[,2]>=r4e[3] &
                    loc[,2]<=r4e[4])
      
      tmpsst1 = tmpsst[id1,]
      tmpsst2 = tmpsst[id2,]
      tmpsst3 = tmpsst[id3,]
      tmpsst4 = tmpsst[id4,]
      
      tmpoutput1 = output_region245[[i]][1]
      tmpoutput2 = output_region245[[i]][2]
      tmpoutput3 = output_region245[[i]][3]
      tmpoutput4 = output_region245[[i]][4]
      
      fwrite(tmpsst1,tmpoutput1)
      fwrite(tmpsst2,tmpoutput2)
      fwrite(tmpsst3,tmpoutput3)
      fwrite(tmpsst4,tmpoutput4)
      
    }else{
      tmpsst = mask(tmpsst,poly)
      
      tmpsst1 <- crop(tmpsst,r1)
      tmpsst2 <- crop(tmpsst,r2)
      tmpsst3 <- crop(tmpsst,r3)
      tmpsst4 <- crop(tmpsst,r4)
      
      
      tmpoutput1 = output_region245[[i]][1]
      tmpoutput2 = output_region245[[i]][2]
      tmpoutput3 = output_region245[[i]][3]
      tmpoutput4 = output_region245[[i]][4]
      
      writeRaster(tmpsst1,tmpoutput1,format = 'CDF',overwrite = T)
      writeRaster(tmpsst2,tmpoutput2,format = 'CDF',overwrite = T)
      writeRaster(tmpsst3,tmpoutput3,format = 'CDF',overwrite = T)
      writeRaster(tmpsst4,tmpoutput4,format = 'CDF',overwrite = T)
    }
    
  }
  
  sub_mask_hist_ssp585 <- function(i){
    # using 2003-201412 to training
    library(raster)
    library(ncdf4)
    library(data.table)
    
    tmpsst = try(stack(sst_hist_ssp585[i]),
                 silent = T)
    poly = shapefile(input_poly)
    
    r1 = shapefile(input_crop[1])    
    r2 = shapefile(input_crop[2])    
    r3 = shapefile(input_crop[3])    
    r4 = shapefile(input_crop[4]) 
    if('try-error' %in% class(tmpsst)){
      tmpsst = fread(sst_hist_ssp585[i])
      tmpsst = as.data.frame(tmpsst)
      
      naid = which(is.na(tmpsst[,3]))
      tmpsst = tmpsst[-naid,]
      
      loc = tmpsst[,1:2]
      # import sub regions
      r1e = extent(r1)
      r2e = extent(r2)
      r3e = extent(r3)
      r4e = extent(r4)
      
      id1 = which(loc[,1]>=r1e[1] &
                    loc[,1]<=r1e[2] &
                    loc[,2]>=r1e[3] &
                    loc[,2]<=r1e[4])
      id2 = which(loc[,1]>=r2e[1] &
                    loc[,1]<=r2e[2] &
                    loc[,2]>=r2e[3] &
                    loc[,2]<=r2e[4])
      id3 = which(loc[,1]>=r3e[1] &
                    loc[,1]<=r3e[2] &
                    loc[,2]>=r3e[3] &
                    loc[,2]<=r3e[4])
      id4 = which(loc[,1]>=r4e[1] &
                    loc[,1]<=r4e[2] &
                    loc[,2]>=r4e[3] &
                    loc[,2]<=r4e[4])
      
      tmpsst1 = tmpsst[id1,]
      tmpsst2 = tmpsst[id2,]
      tmpsst3 = tmpsst[id3,]
      tmpsst4 = tmpsst[id4,]
      
      tmpoutput1 = output_region585[[i]][1]
      tmpoutput2 = output_region585[[i]][2]
      tmpoutput3 = output_region585[[i]][3]
      tmpoutput4 = output_region585[[i]][4]
      
      fwrite(tmpsst1,tmpoutput1)
      fwrite(tmpsst2,tmpoutput2)
      fwrite(tmpsst3,tmpoutput3)
      fwrite(tmpsst4,tmpoutput4)
      
    }else{
      tmpsst = mask(tmpsst,poly)
      
      tmpsst1 <- crop(tmpsst,r1)
      tmpsst2 <- crop(tmpsst,r2)
      tmpsst3 <- crop(tmpsst,r3)
      tmpsst4 <- crop(tmpsst,r4)
      
      
      tmpoutput1 = output_region585[[i]][1]
      tmpoutput2 = output_region585[[i]][2]
      tmpoutput3 = output_region585[[i]][3]
      tmpoutput4 = output_region585[[i]][4]
      
      writeRaster(tmpsst1,tmpoutput1,format = 'CDF',overwrite = T)
      writeRaster(tmpsst2,tmpoutput2,format = 'CDF',overwrite = T)
      writeRaster(tmpsst3,tmpoutput3,format = 'CDF',overwrite = T)
      writeRaster(tmpsst4,tmpoutput4,format = 'CDF',overwrite = T)
    }
    
  }
  
  
  i = 1:length(sst_hist_ssp245)
  i <<- i
  
  for(i in 1:8){
    #sub_mask_hist_ssp245(i)
    sub_mask_hist_ssp585(i)
    print(i)
  }
  
  print(paste0('pass_',mode))  
}
mask_crop_cmip6 <- function(
  mode = 'ato'
){
  #input file 
  input_cmip6 = '/media/root/Shen_drive1/CMIP6_combined'
  e_hist_ssp245 = list.files(paste0(input_cmip6,'/E/hist_ssp245'),full.names = T)
  e_hist_ssp585 = list.files(paste0(input_cmip6,'/E/hist_ssp585'),full.names = T)
  pr_hist_ssp245 = list.files(paste0(input_cmip6,'/Pr/hist_ssp245'),full.names = T)
  pr_hist_ssp585 = list.files(paste0(input_cmip6,'/Pr/hist_ssp585'),full.names = T)
  
  e_hist_ssp245 <<- e_hist_ssp245
  e_hist_ssp585 <<- e_hist_ssp585
  pr_hist_ssp245 <<- pr_hist_ssp245
  pr_hist_ssp585 <<- pr_hist_ssp585
  
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  # output file
  
  
  
  
  # 3. cal the sum of total ep
  # units of evapor = mm/s to mm/month *86400*30.5
  # units of pr = mm/s to mm/month *86400*30.5
  
  output_ep = '/media/root/Shen_drive1/CMIP6_e-p'
  dir.create(output_ep)
  output_ep = paste0(output_ep,'/',mode)
  dir.create(output_ep)
  
  ep_ssp245 = paste0(output_ep,'/hist_ssp245')
  ep_ssp585 = paste0(output_ep,'/hist_ssp585')
  
  dir.create(ep_ssp245)
  dir.create(ep_ssp585)
  
  ep_ssp245_region = paste0(ep_ssp245,'/','region',1:4)
  ep_ssp585_region = paste0(ep_ssp585,'/','region',1:4)
  
  sapply(ep_ssp245_region,dir.create)
  sapply(ep_ssp585_region,dir.create)
  
  output_name245 = list.files(paste0(input_cmip6,'/E/hist_ssp245'))
  output_name585 = list.files(paste0(input_cmip6,'/E/hist_ssp585'))
  
  output_region245 = paste0(rep(ep_ssp245_region,8),'/',rep(output_name245,each = 4))
  output_region585 = paste0(rep(ep_ssp585_region,8),'/',rep(output_name585,each = 4))
  
  output_region245 = list(output_region245[1:4],
                          output_region245[5:8],
                          output_region245[9:12],
                          output_region245[13:16],
                          output_region245[17:20],
                          output_region245[21:24],
                          output_region245[25:28],
                          output_region245[29:32])
  output_region585 = list(output_region585[1:4],
                          output_region585[5:8],
                          output_region585[9:12],
                          output_region585[13:16],
                          output_region585[17:20],
                          output_region585[21:24],
                          output_region585[25:28],
                          output_region585[29:32])
  output_region245 <<- output_region245
  output_region585 <<- output_region585
  
  mode <<- mode
  sub_mask_hist_ssp245 <- function(i){
    # using 2003-201412 to training
    library(raster)
    library(ncdf4)
    
    tmpe = stack(e_hist_ssp245[i])
    tmppr = stack(pr_hist_ssp245[i])
    
    tmpe = tmpe*86400*30.5
    tmppr = tmppr*86400*30.5
    
    tmpep = tmpe-tmppr
    
    poly = shapefile(input_poly)
    
    # 1. mask by shapefile polygon 
    tmpep = mask(tmpep,poly)
    # 2. crop by sub-regions 
    r1 = shapefile(input_crop[1])    
    r2 = shapefile(input_crop[2])    
    r3 = shapefile(input_crop[3])    
    r4 = shapefile(input_crop[4])    
    
    tmpep1 <- crop(tmpep,r1)
    tmpep2 <- crop(tmpep,r2)
    tmpep3 <- crop(tmpep,r3)
    tmpep4 <- crop(tmpep,r4)
    
    
    tmpoutput1 = output_region245[[i]][1]
    tmpoutput2 = output_region245[[i]][2]
    tmpoutput3 = output_region245[[i]][3]
    tmpoutput4 = output_region245[[i]][4]
    
    writeRaster(tmpep1,tmpoutput1,format = 'CDF',overwrite = T)
    writeRaster(tmpep2,tmpoutput2,format = 'CDF',overwrite = T)
    writeRaster(tmpep3,tmpoutput3,format = 'CDF',overwrite = T)
    
    if(mode == 'eu' & i ==3){
      tmpep4  = as.data.frame(tmpep4,xy = T)
      library(data.table)
      fwrite(tmpep4,'/media/root/Shen_drive1/CMIP6_e-p/eu/hist_ssp245/region4/his245_CanESM5_200301_205012.csv')
    } else{
      writeRaster(tmpep4,tmpoutput4,format = 'CDF',overwrite = T)
    }
    
    
    
    
  }
  
  sub_mask_hist_ssp585 <- function(i){
    # using 2003-201412 to training
    library(raster)
    library(ncdf4)
    
    tmpe = stack(e_hist_ssp585[i])
    tmppr = stack(pr_hist_ssp585[i])
    
    tmpe = tmpe*86400*30.5
    tmppr = tmppr*86400*30.5
    
    tmpep = tmpe-tmppr
    
    poly = shapefile(input_poly)
    
    # 1. mask by shapefile polygon 
    tmpep = mask(tmpep,poly)
    # 2. crop by sub-regions 
    r1 = shapefile(input_crop[1])    
    r2 = shapefile(input_crop[2])    
    r3 = shapefile(input_crop[3])    
    r4 = shapefile(input_crop[4])    
    
    tmpep1 <<- crop(tmpep,r1)
    tmpep2 <<- crop(tmpep,r2)
    tmpep3 <<- crop(tmpep,r3)
    tmpep4 <<- crop(tmpep,r4)
    
    tmpoutput1 = output_region585[[i]][1]
    tmpoutput2 = output_region585[[i]][2]
    tmpoutput3 = output_region585[[i]][3]
    tmpoutput4 = output_region585[[i]][4]
    
    writeRaster(tmpep1,tmpoutput1,format = 'CDF',overwrite = T)
    writeRaster(tmpep2,tmpoutput2,format = 'CDF',overwrite = T)
    writeRaster(tmpep3,tmpoutput3,format = 'CDF',overwrite = T)
    
    if(mode == 'eu' & i ==3){
      tmpep4  = as.data.frame(tmpep4,xy = T)
      library(data.table)
      fwrite(tmpep4,'/media/root/Shen_drive1/CMIP6_e-p/eu/hist_ssp585/region4/his585_CanESM5_200301_205012.csv')
    } else{
      writeRaster(tmpep4,tmpoutput4,format = 'CDF',overwrite = T)
    }
    
    
    
  }
  
  i = 1:length(e_hist_ssp245)
  i <<- i
  library(doParallel)
  cl = makeCluster(8)
  clusterExport(cl,c('e_hist_ssp245','pr_hist_ssp245','input_poly','input_crop',
                     'output_region245'))
  system.time(parLapply(cl,i,sub_mask_hist_ssp245))
  stopCluster(cl)
  
  
  cl = makeCluster(8)
  clusterExport(cl,c('e_hist_ssp585','pr_hist_ssp585','input_poly','input_crop',
                     'output_region585'))
  system.time(parLapply(cl,i,sub_mask_hist_ssp585))
  stopCluster(cl)
  
  print(paste0('pass_',mode))  
}
mask_era5_e_pr <- function(
  mode = 'ato'
){
  # date 2003 - 2017
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  era5_pr = data_management('era5_pr_include_ocean')
  era5_e = data_management('era5_e_include_ocean')
  era5_e = era5_e * -1
  
  era5_ep = era5_e - era5_pr
  era5_ep <<- era5_ep
  
  ### input shp
  #######
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  #######
  i = 1:4
  print(i)
  i <<- i
  
  ###output
  output_era5_ep_masked = '/media/sdb5/Data/era5_ep_masked'
  dir.create(output_era5_ep_masked)
  
  output1 = paste0(output_era5_ep_masked,'/',mode)
  dir.create(output1)
  output2 = paste0(output1,'/region',1:4)
  sapply(output2,dir.create)
  
  output2 = paste0(output2,'/era5_source_ep_2003_2017.nc')
  
  output2 <<- output2
  
  sub_mask <- function(i){
    library(raster)
    library(ncdf4)
    tmpraster = era5_ep
    
    poly = shapefile(input_poly)
    
    r = mask(tmpraster,poly)
    
    crop1 = shapefile(input_crop[i])
    
    r1 = crop(r,crop1)
    
    writeRaster(r1,output2[i],format = 'CDF',overwrite = T)
  }
  
  library(doParallel)
  cl = makeCluster(4)
  clusterExport(cl,c('i','input_poly','input_crop','era5_ep','output2'))
  system.time(parLapply(cl,i,sub_mask))
  stopCluster(cl)
  
  print(paste0('Pass ',mode))
  
  
  
}
mask_era5_eva <- function(
  mode = 'ato'
){
  # date 2003 - 2017
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  #era5_pr = data_management('era5_pr_include_ocean')
  era5_e = data_management('era5_e_include_ocean')
  era5_e = era5_e * -1
  
  era5_ep = era5_e
  era5_ep <<- era5_ep
  
  ### input shp
  #######
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  #######
  i = 1:4
  print(i)
  i <<- i
  
  ###output
  output_era5_ep_masked = '/media/sdb5/Data/era5_eva_masked_in_source'
  dir.create(output_era5_ep_masked)
  
  output1 = paste0(output_era5_ep_masked,'/',mode)
  dir.create(output1)
  output2 = paste0(output1,'/region',1:4)
  sapply(output2,dir.create)
  
  output2 = paste0(output2,'/era5_source_eva_2003_2017.nc')
  
  output2 <<- output2
  
  sub_mask <- function(i){
    library(raster)
    library(ncdf4)
    tmpraster = era5_ep
    
    poly = shapefile(input_poly)
    
    r = mask(tmpraster,poly)
    
    crop1 = shapefile(input_crop[i])
    
    r1 = crop(r,crop1)
    
    writeRaster(r1,output2[i],format = 'CDF',overwrite = T)
  }
  
  library(doParallel)
  cl = makeCluster(4)
  clusterExport(cl,c('i','input_poly','input_crop','era5_ep','output2'))
  system.time(parLapply(cl,i,sub_mask))
  stopCluster(cl)
  
  print(paste0('Pass ',mode))
  
  
  
}
mask_era5_p_er <- function(
  mode = 'ato'
){
  # date 2003 - 2017
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  era5_pr = data_management('era5_pr_include_ocean')
  era5_e = data_management('era5_e_include_ocean')
  era5_e = era5_e * -1
  
  era5_ep = era5_pr - era5_e
  era5_ep <<- era5_ep
  
  ### input shp
  #######
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  #######
  i = 1:4
  print(i)
  i <<- i
  
  ###output
  output_era5_ep_masked = '/media/sdb5/Data/era5_pe_masked'
  dir.create(output_era5_ep_masked)
  
  output1 = paste0(output_era5_ep_masked,'/',mode)
  dir.create(output1)
  output2 = paste0(output1,'/region',1:4)
  sapply(output2,dir.create)
  
  output2 = paste0(output2,'/era5_source_pe_2003_2017.nc')
  
  output2 <<- output2
  
  sub_mask <- function(i){
    library(raster)
    library(ncdf4)
    tmpraster = era5_ep
    
    poly = shapefile(input_poly)
    
    r = mask(tmpraster,poly)
    
    crop1 = shapefile(input_crop[i])
    
    r1 = crop(r,crop1)
    
    writeRaster(r1,output2[i],format = 'CDF',overwrite = T)
  }
  
  library(doParallel)
  cl = makeCluster(4)
  clusterExport(cl,c('i','input_poly','input_crop','era5_ep','output2'))
  system.time(parLapply(cl,i,sub_mask))
  stopCluster(cl)
  
  print(paste0('Pass ',mode))
  
  
  
}
mask_era5_p <- function(
  mode = 'ato'
){
  # date 2003 - 2017
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  era5_pr = data_management('era5_pr_include_ocean')
  #era5_e = data_management('era5_e_include_ocean')
  #era5_e = era5_e * -1
  
  era5_ep = era5_pr
  era5_ep <<- era5_ep
  
  ### input shp
  #######
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  #######
  i = 1:4
  print(i)
  i <<- i
  
  ###output
  output_era5_ep_masked = '/media/sdb5/Data/era5_pr_masked'
  dir.create(output_era5_ep_masked)
  
  output1 = paste0(output_era5_ep_masked,'/',mode)
  dir.create(output1)
  output2 = paste0(output1,'/region',1:4)
  sapply(output2,dir.create)
  
  output2 = paste0(output2,'/era5_source_pr_2003_2017.nc')
  
  output2 <<- output2
  
  sub_mask <- function(i){
    library(raster)
    library(ncdf4)
    tmpraster = era5_ep
    
    poly = shapefile(input_poly)
    
    r = mask(tmpraster,poly)
    
    crop1 = shapefile(input_crop[i])
    
    r1 = crop(r,crop1)
    
    writeRaster(r1,output2[i],format = 'CDF',overwrite = T)
  }
  
  library(doParallel)
  cl = makeCluster(4)
  clusterExport(cl,c('i','input_poly','input_crop','era5_ep','output2'))
  system.time(parLapply(cl,i,sub_mask))
  stopCluster(cl)
  
  print(paste0('Pass ',mode))
  
  
  
}
mask_era5_poten_evap<-function(
  mode = 'ato'
){
  # date 2003 - 2017
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  era5_pr = data_management('global_era5_poten_evap')
  #era5_e = data_management('era5_e_include_ocean')
  #era5_e = era5_e * -1
  
  era5_ep = era5_pr
  era5_ep <<- era5_ep
  
  ### input shp
  #######
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  #######
  i = 1:4
  print(i)
  i <<- i
  
  ###output
  output_era5_ep_masked = '/media/sdb5/Data/era5_pet_masked2'
  dir.create(output_era5_ep_masked)
  
  output1 = paste0(output_era5_ep_masked,'/',mode)
  dir.create(output1)
  output2 = paste0(output1,'/region',1:4)
  sapply(output2,dir.create)
  
  output2 = paste0(output2,'/era5_source_pet_2003_2017.nc')
  
  output2 <<- output2
  
  sub_mask <- function(i){
    library(raster)
    library(ncdf4)
    tmpraster = era5_ep
    
    poly = shapefile(input_poly)
    
    r = mask(tmpraster,poly)
    
    crop1 = shapefile(input_crop[i])
    
    r1 = crop(r,crop1)
    
    writeRaster(r1,output2[i],format = 'CDF',overwrite = T)
  }
  
  library(doParallel)
  cl = makeCluster(4)
  clusterExport(cl,c('i','input_poly','input_crop','era5_ep','output2'))
  system.time(parLapply(cl,i,sub_mask))
  stopCluster(cl)
  
  print(paste0('Pass ',mode))
  
}
mask_era5_sst<-function(
  mode = 'ato'
){
  # date 2003 - 2017
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  era5_pr = data_management('global_era5_sst')
  #era5_e = data_management('era5_e_include_ocean')
  #era5_e = era5_e * -1
  
  era5_ep = era5_pr
  era5_ep <<- era5_ep
  
  ### input shp
  #######
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  #######
  i = 1:4
  print(i)
  i <<- i
  
  ###output
  output_era5_ep_masked = '/media/sdb5/Data/era5_sst_masked'
  dir.create(output_era5_ep_masked)
  
  output1 = paste0(output_era5_ep_masked,'/',mode)
  dir.create(output1)
  output2 = paste0(output1,'/region',1:4)
  sapply(output2,dir.create)
  
  output2 = paste0(output2,'/era5_source_sst_2003_2017.nc')
  
  output2 <<- output2
  
  sub_mask <- function(i){
    library(raster)
    library(ncdf4)
    tmpraster = era5_ep
    
    poly = shapefile(input_poly)
    
    r = mask(tmpraster,poly)
    
    crop1 = shapefile(input_crop[i])
    
    r1 = crop(r,crop1)
    
    writeRaster(r1,output2[i],format = 'CDF',overwrite = T)
  }
  
  library(doParallel)
  cl = makeCluster(4)
  clusterExport(cl,c('i','input_poly','input_crop','era5_ep','output2'))
  system.time(parLapply(cl,i,sub_mask))
  stopCluster(cl)
  
  print(paste0('Pass ',mode))
  
}
mask_era5_temperature<-function(
  mode = 'ato'
){
  # date 2003 - 2017
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  era5_pr = data_management('global_era5_temperature')
  #era5_e = data_management('era5_e_include_ocean')
  #era5_e = era5_e * -1
  
  era5_ep = era5_pr
  era5_ep <<- era5_ep
  
  ### input shp
  #######
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  #######
  i = 1:4
  print(i)
  i <<- i
  
  ###output
  output_era5_ep_masked = '/media/sdb5/Data/era5_tas_masked'
  dir.create(output_era5_ep_masked)
  
  output1 = paste0(output_era5_ep_masked,'/',mode)
  dir.create(output1)
  output2 = paste0(output1,'/region',1:4)
  sapply(output2,dir.create)
  
  output2 = paste0(output2,'/era5_source_tas_2003_2017.nc')
  
  output2 <<- output2
  
  sub_mask <- function(i){
    library(raster)
    library(ncdf4)
    tmpraster = era5_ep
    
    poly = shapefile(input_poly)
    
    r = mask(tmpraster,poly)
    
    crop1 = shapefile(input_crop[i])
    
    r1 = crop(r,crop1)
    
    writeRaster(r1,output2[i],format = 'CDF',overwrite = T)
  }
  
  library(doParallel)
  cl = makeCluster(4)
  clusterExport(cl,c('i','input_poly','input_crop','era5_ep','output2'))
  system.time(parLapply(cl,i,sub_mask))
  stopCluster(cl)
  
  print(paste0('Pass ',mode))
  
}
mask_gpcc_p <- function(
  mode = 'ato'
){
  # date 2003 - 2017
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  era5_pr = data_management('gpcc_full')
  #era5_e = data_management('era5_e_include_ocean')
  #era5_e = era5_e * -1
  
  era5_ep = era5_pr
  era5_ep <<- era5_ep
  
  ### input shp
  #######
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  #######
  i = 1:4
  print(i)
  i <<- i
  
  ###output
  output_era5_ep_masked = '/media/sdb5/Data/gpcc_pr_masked'
  dir.create(output_era5_ep_masked)
  
  output1 = paste0(output_era5_ep_masked,'/',mode)
  dir.create(output1)
  output2 = paste0(output1,'/region',1:4)
  sapply(output2,dir.create)
  
  output2 = paste0(output2,'/gpcc_source_pr_2003_2017.nc')
  
  output2 <<- output2
  
  sub_mask <- function(i){
    library(raster)
    library(ncdf4)
    tmpraster = era5_ep
    
    poly = shapefile(input_poly)
    
    r = mask(tmpraster,poly)
    
    crop1 = shapefile(input_crop[i])
    
    r1 = crop(r,crop1)
    
    writeRaster(r1,output2[i],format = 'CDF',overwrite = T)
  }
  
  library(doParallel)
  cl = makeCluster(4)
  clusterExport(cl,c('i','input_poly','input_crop','era5_ep','output2'))
  system.time(parLapply(cl,i,sub_mask))
  stopCluster(cl)
  
  print(paste0('Pass ',mode))
  
  
  
}
mask_grace_tws <- function(
  mode = 'ato'
){
  # date 2003 - 2017
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  tws = data_management('grace')
  #era5_e = data_management('era5_e_include_ocean')
  #era5_e = era5_e * -1
  
  era5_ep = tws
  era5_ep <<- era5_ep
  
  ### input shp
  #######
  # input_shp
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  library(raster)
  if(mode == 'ato'){
    input_poly = '/media/sdb1/shp/ocean_shp/shp_combind/ato_diso.shp'
  }else{
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == mode)
    input_poly = files[idr]
  }
  input_poly <<- input_poly
  
  # input crop 
  input_crop = paste0('cluster_shp/',mode)
  input_crop = list.files(input_crop, pattern = '*shp$',full.names = T)
  input_crop = input_crop[1:4]
  input_crop <<- input_crop
  #######
  i = 1:4
  print(i)
  i <<- i
  
  ###output
  output_era5_ep_masked = '/media/sdb5/Data/tws_in_source'
  dir.create(output_era5_ep_masked)
  
  output1 = paste0(output_era5_ep_masked,'/',mode)
  dir.create(output1)
  output2 = paste0(output1,'/region',1:4)
  sapply(output2,dir.create)
  
  output2 = paste0(output2,'/tws_in_source_2003_2017.nc')
  
  output2 <<- output2
  
  sub_mask <- function(i){
    library(raster)
    library(ncdf4)
    tmpraster = era5_ep
    
    poly = shapefile(input_poly)
    
    r = mask(tmpraster,poly)
    
    crop1 = shapefile(input_crop[i])
    
    r1 = crop(r,crop1)
    
    writeRaster(r1,output2[i],format = 'CDF',overwrite = T)
  }
  
  library(doParallel)
  cl = makeCluster(4)
  clusterExport(cl,c('i','input_poly','input_crop','era5_ep','output2'))
  system.time(parLapply(cl,i,sub_mask))
  stopCluster(cl)
  
  print(paste0('Pass ',mode))
  
  
  
}
mask_points_for_south_xinjiang <-function(
  df_ocean,
  pattern = 'ocean'
){
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world_shp <<- shp_management(pattern = pattern)
  
  df_fullid<<-df_ocean$type
  idu = unique(df_ocean$type)
  df_full = df_ocean
  df_full <<- df_full
  
  group_id_vector<-function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  
  
  gpd <<- group_id_vector(idu)
  source('/home/share/R_project/xinjiang_vapor/mask_points_with_shp.R')
  
  cl = makeCluster(13)
  clusterExport(cl,c('gpd','df_fullid','df_full','world_shp'))
  system.time(
    ret_test_id <- parLapply(cl,gpd,mask_points_with_shp)
  )
  stopCluster(cl)
  
  ret_test_id = do.call('c',ret_test_id)
  
  return(ret_test_id)
}
mask_points_solo_shp<-function(
  df_in,shp
){
  # mask points df with solo thread
  # demands input of df and shp
  library(raster)
  library(maps)
  library(maptools)
  library(data.table)
  dfsce = df_in
  coordinates(dfsce) = ~ long+lat
  proj4string(dfsce) = "+proj=longlat +datum=WGS84 +no_defs"
  
  df_m = over(dfsce,shp)
  df_index = which(!is.na(df_m[,1]))
  return(df_index)
}
mask_points_via_poly_pal_path_mode<-function(
  df_sce,shp_path
){
  # inputdata sec
  # df_sce
  # ncols: long, lat, height, type 
  # group by type short time 
  library(raster)
  library(maps)
  library(maptools)
  library(data.table)
  
  pattern = 'shp_path'
  if(pattern == 'shp_path'){
    world_shp <<- shapefile(shp_path)  
  }else{
    world_shp <<- shp_path
  }
  
  
  df_fullid <<- df_sce$type
  idu = unique(df_sce$type)
  df_full <<- df_sce
  group_id_vector<-function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  
  gpd <<- group_id_vector(idu)
  
  cl = makeCluster(15)
  clusterExport(cl,c('gpd','df_fullid','df_full','world_shp'))
  system.time(
    ret_test_id <- parLapply(cl,gpd,mask_points_with_shp)
  )
  stopCluster(cl)
  ret_test_id = do.call('c',ret_test_id)
  return(ret_test_id)
  
}
mask_points_via_poly_pal<-function(
  df_sce,shp_path
){
  # inputdata sec
  # df_sce
  # ncols: long, lat, height, type 
  # group by type short time 
  library(raster)
  library(maps)
  library(maptools)
  library(data.table)
  
  pattern = 'shp_direct'
  if(pattern == 'shp_path'){
    world_shp <<- shapefile(shp_path)  
  }else{
    world_shp <<- shp_path
  }
  
  
  df_fullid <<- df_sce$type
  idu = unique(df_sce$type)
  df_full <<- df_sce
  group_id_vector<-function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  
  gpd <<- group_id_vector(idu)
  source('/home/share/R_project/xinjiang_vapor/mask_points_with_shp.R')
  cl = makeCluster(13)
  clusterExport(cl,c('gpd','df_fullid','df_full','world_shp'))
  system.time(
    ret_test_id <- parLapply(cl,gpd,mask_points_with_shp)
  )
  stopCluster(cl)
  ret_test_id = do.call('c',ret_test_id)
  return(ret_test_id)
  
}
 mask_points_via_world_continent <- function(
  input_data
){
  
  sub_mask <- function(input_sub){
    source('/home/share/R_project/xinjiang_vapor/mask_points_with_shp.R')
    source('/home/share/R_project/xinjiang_vapor/search_which.R')
    source('/home/share/R_project/xinjiang_vapor/shp_management.R')
    
    df = fread(paste0(input_sub,'/var_whole_route_mid.csv'))
    #df = as.data.frame(df)
    # data_structure
    # c('long','lat','height','ep','type')
    
    # select initialized  id 
    ids = unique(df$type)
    xfull <<- df$type
    df_fullid <<- df$type
    group_id <- function(x){
      step = round(length(x) /100)
      ids = seq(1,length(x),step)
      ide = ids -1
      ide = ide[-1]
      ide = c(ide,length(x))
      xl = list()
      for(i in 1:length(ids)){
        stmp = ids[i]
        etmp = ide[i]
        tmp = x[stmp:etmp]
        xl[[i]] = tmp
      }
      return(xl)
    }
    idsl = group_id(ids)
    system.time(ret_first_id <- lapply(idsl, search_which))
    ret_first_id = do.call('c',ret_first_id)
    
    df_sce = df[ret_first_id,]
    print('mask_points_via_world_continent:_pass return first id phase_')
    # Mask points with shp 
    source('/home/share/R_project/xinjiang_vapor/mask_points_via_poly_pal_path_mode.R')
    shp_path = '/media/sdb1/shp/world_continent.shp'
    ret_test_id = mask_points_via_poly_pal_path_mode(df_sce,shp_path)
    
    df_in_land = df_sce[ret_test_id,]
    df_in_ocean = df_sce[-ret_test_id,]
    
    print('mask_points_via_world_continent:_pass divid land and ocean phase_')
    # mask with each continents
    
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    output_path = paste0(input_sub,'/df_first_ocean')
    dir.create(output_path)
    output_ocean = paste0(output_path,'/',oce_names,'.csv')
    source('/home/share/R_project/xinjiang_vapor/mask_via_each_ocean.R')
    
    for(i in 1:length(oce_names)){
      tmp = mask_via_each_ocean(df_in_ocean,oce_names[i],pattern = 'ocean')
      write.csv(tmp,output_ocean[i])
      print(i)
    }
    print('mask_points_via_world_continent:_pass mask with each ocean phase_')
    # mask with each lands
    con_names = c('as','xj','eu','naf','na')
    output_path = paste0(input_sub,'/df_first_land')
    output_land = paste0(output_path,'/',con_names,'.csv')
    
    for(i in 1:length(con_names)){
      if(con_names[i] =='as'){
        tmp =  mask_via_each_ocean(df_in_land,con_names[i],pattern = 'as_bu_xinjiang')
        write.csv(tmp,output_land[i])
      }else if(con_names[i] =='xj'){
        tmp =  mask_via_each_ocean(df_in_land,con_names[i],pattern = 'xinjiang')
        write.csv(tmp,output_land[i])
      }else{
        tmp = mask_via_each_ocean(df_in_land,con_names[i],pattern = 'land')
        write.csv(tmp,output_land[i])
      }
      
      print(i)
    }
    
    print('mask_points_via_world_continent:_pass mask with each land phase_')
    print(input_sub)
    
  }
  
  sapply(input_data,sub_mask)
  
  gc()
  rm("df")
  rm("df_in_ocean")
  rm("df_in_land")
  rm("ids")
  rm("df_fullid")
  rm("xfull")
  rm("df_sce")
  rm("tmp")
  rm('df_full')
  print('rm done!')
  
}
mask_points_with_shp_cloud<-function(
  x
){
  # sub functions for mask_points_via_poly_pal 
  # has sepcific requirements on global variables declared in above function
  
  sid = min(which(df_fullid == x[1]))
  eid = max(which(df_fullid == x[length(x)]))
  idc = sid:eid
  #print(length(idc))
  
  mask_pal <- function(idc){
    library(raster)
    library(maps)
    library(maptools)
    library(data.table)
    input_df_full = 'tmp/df_full.csv'
    df_full = fread(input_df_full)
    dfsce = df_full[idc,]
    rm(df_full)
    coordinates(dfsce) = ~ long+lat
    proj4string(dfsce) = "+proj=longlat +datum=WGS84 +no_defs"
    
    df_m = over(dfsce,world_shp)
    df_land_index = which(!is.na(df_m[,1]))
    rm(df_m)
    rm(dfsce)
    return(df_land_index)
  }
  
  ret_mask_id = mask_pal(idc)
  ret_mask_id = ret_mask_id + sid -1
  
  
  return(ret_mask_id)
  
}
mask_points_with_shp<-function(
  x
){
  # sub functions for mask_points_via_poly_pal 
  # has sepcific requirements on global variables declared in above function
 
  sid = min(which(df_fullid == x[1]))
  eid = max(which(df_fullid == x[length(x)]))
  idc = sid:eid
  #print(length(idc))
  
  mask_pal <- function(idc){
    library(raster)
    library(maps)
    library(maptools)
    library(data.table)
    #input_df_full = 'tmp/df_full.csv'
    #df_full = fread(input_df_full)
    dfsce = df_full[idc,]
    rm(df_full)
    coordinates(dfsce) = ~ long+lat
    proj4string(dfsce) = "+proj=longlat +datum=WGS84 +no_defs"
    
    df_m = over(dfsce,world_shp)
    df_land_index = which(!is.na(df_m[,1]))
    rm(df_m)
    rm(dfsce)
    return(df_land_index)
  }
  
  ret_mask_id = mask_pal(idc)
  ret_mask_id = ret_mask_id + sid -1
  
  
  return(ret_mask_id)
  
}
mask_via_each_ocean_dep_inxinjiang <-function(
  df_ocean,
  names = 'ao',
  pattern = 'ocean'
){
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world_shp <<- shp_management(names = names,pattern = pattern)
  
  df_fullid <<- df_ocean$type
  idu = unique(df_ocean$type)
  df_full <<- df_ocean
  
  #input_df_full = 'tmp/df_full.csv'
  #fwrite(df_full,input_df_full)
  #rm(df_full)
  
  group_id_vector<-function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  
  gpd <<- group_id_vector(idu)
  source('/home/share/R_project/xinjiang_vapor/mask_points_with_shp.R')
  
  
  cl = makeCluster(15)
  clusterExport(cl,c('gpd','df_fullid','world_shp','df_full'))
  system.time(
    ret_test_id <- parLapply(cl,gpd,mask_points_with_shp)
  )
  stopCluster(cl)
  
  ret_test_id = do.call('c',ret_test_id)
  
  tmpid = df_ocean[ret_test_id,]
  #tmpid = tmpid$type # return type
  
  return(tmpid)
}
mask_via_each_ocean_for_contri_cal_cloud <-function(
  df_ocean,
  names = 'ao',
  pattern = 'ocean'
){
  source('~/shp_management_cloud.R')
  world_shp <<- shp_management_cloud(names = names,pattern = pattern)
  
  df_fullid<<-df_ocean$type
  idu = unique(df_ocean$type)
  df_full = df_ocean
  group_id_vector<-function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  
  input_df_full = 'tmp/df_full.csv'
  fwrite(df_full,input_df_full)
  rm(df_full)
  
  gpd <<- group_id_vector(idu)
  source('~/mask_points_with_shp_cloud.R')
  
  cl = makeCluster(15)
  clusterExport(cl,c('gpd','df_fullid','world_shp'))
  system.time(
    ret_test_id <- parLapply(cl,gpd,mask_points_with_shp_cloud)
  )
  stopCluster(cl)
  
  ret_test_id = do.call('c',ret_test_id)
  
  if(pattern == 'combine_ocean' | pattern =='combine_land'){
    tmpid = df_ocean[-ret_test_id,]
    #return(tmpid)
  }else{
    tmpid = df_ocean[ret_test_id,]
  }
  
  #tmpid = tmpid$type # return type
  
  return(tmpid)
}
mask_via_each_ocean_for_contri_cal <-function(
  df_ocean,
  names = 'ao',
  pattern = 'ocean'
){
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world_shp <<- shp_management(names = names,pattern = pattern)
  
  df_fullid<<-df_ocean$type
  idu = unique(df_ocean$type)
  df_full = df_ocean
  group_id_vector<-function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  
  input_df_full = 'tmp/df_full.csv'
  fwrite(df_full,input_df_full)
  rm(df_full)
  
  gpd <<- group_id_vector(idu)
  source('/home/share/R_project/xinjiang_vapor/mask_points_with_shp.R')
  
  cl = makeCluster(15)
  clusterExport(cl,c('gpd','df_fullid','world_shp'))
  system.time(
    ret_test_id <- parLapply(cl,gpd,mask_points_with_shp)
  )
  stopCluster(cl)
  
  ret_test_id = do.call('c',ret_test_id)
  
  if(pattern == 'combine_ocean' | pattern =='combine_land'){
    tmpid = df_ocean[-ret_test_id,]
    #return(tmpid)
  }else{
    tmpid = df_ocean[ret_test_id,]
  }
  
  #tmpid = tmpid$type # return type
  
  return(tmpid)
}
mask_via_each_ocean <-function(
  df_ocean,
  names = 'ao',
  pattern = 'ocean'
){
  print(names)
  world_shp <<- shp_management(names = names,pattern = pattern)
  
  df_fullid <<- df_ocean$type
  idu = unique(df_ocean$type)
  df_full <<- df_ocean
  group_id_vector<-function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  
  gpd <<- group_id_vector(idu)
  source('/home/share/R_project/xinjiang_vapor/mask_points_with_shp.R')
  
  cl = makeCluster(15)
  clusterExport(cl,c('gpd','df_fullid','df_full','world_shp'))
  system.time(
    ret_test_id <- parLapply(cl,gpd,mask_points_with_shp)
  )
  stopCluster(cl)
  
  ret_test_id = do.call('c',ret_test_id)
  
  tmpid = df_ocean[ret_test_id,]
  tmpid = tmpid$type # return type
  
  return(tmpid)
}
match_by_id<-function(
 output_released,input_contr,mode = 'ao',output
){
  #output_released,input_ocean_contr[i],mode = oce_names[i],output_ocean_contr[i]
  # released calculation
  re_in_aim = fread(output_released)
  re_in_aim = as.data.frame(re_in_aim)
  tt_release = abs(sum(re_in_aim[,2]))
  
  # contr first matrix
  contr_df = fread(input_contr)
  contr_df = as.data.frame(contr_df)
  
  
  if(mode == 'xj'){
    contr_df_above0 = contr_df[which(contr_df$varep_insource<0),] # less zero relesed
    ids_released = which(re_in_aim[,1] %in% contr_df_above0$type)
    re_in_released = re_in_aim[ids_released,]
    
    contr_df_above_released = contr_df_above0[which(contr_df_above0$type %in% re_in_released[,1]),]
    contr_df_above_released$contr_value = re_in_released[,2]
    contr_df_above_released$contr_rate = re_in_released[,2]/tt_release
    
    fwrite(contr_df_above_released,output)
    
  }else{
    contr_df_above0 = contr_df[which(contr_df$varep_insource>0),]
    ids_released = which(re_in_aim[,1] %in% contr_df_above0$type)
    re_in_released = re_in_aim[ids_released,]
    
    contr_df_above_released = contr_df_above0[which(contr_df_above0$type %in% re_in_released[,1]),]
    contr_df_above_released$contr_value = re_in_released[,2]
    contr_df_above_released$contr_rate = abs(re_in_released[,2])/tt_release
    
    fwrite(contr_df_above_released,output)
  }
  
  
  
}
match_convey_and_rel_by_region <- function(
  input_file
){
  
  sub_match <- function(
    input
  ){
    print(paste0('Start ',input))
    
    input_rel_by_region = paste0(input,'/output/xinjiang_release')
    input_rel_north = paste0(input_rel_by_region,'/north')
    input_rel_south = paste0(input_rel_by_region,'/south')
    
    input_rel_north_jishui = paste0(input_rel_north,'/jishui_re.csv')
    input_rel_north_moun = paste0(input_rel_north,'/moun_re.csv')
    
    input_rel_south_jishui = paste0(input_rel_south,'/jishui_re.csv')
    input_rel_south_moun = paste0(input_rel_south,'/moun_re.csv')
    
    input_uptake = paste0(input,'/output/convey_rate_df')
    input_uptake_as = paste0(input_uptake,'/as.csv')
    input_uptake_ato = paste0(input_uptake,'/ato.csv')
    input_uptake_eu = paste0(input_uptake,'/eu.csv')
    
    uptake_as = fread(input_uptake_as)
    uptake_ato = fread(input_uptake_ato)
    uptake_eu = fread(input_uptake_eu)
    
    north_jishui = fread(input_rel_north_jishui)
    north_moun = fread(input_rel_north_moun)
    
    output = paste0(input,'/output/combine_uptake_rel_by_region')
    dir.create(output)
    output_north = paste0(output,'/north')
    output_south = paste0(output,'/south')
    dir.create(output_south)
    dir.create(output_north)
    
    output_north_jishui_as = paste0(output_north,'/jishui_as.csv')
    output_north_jishui_ato = paste0(output_north,'/jishui_ato.csv')
    output_north_jishui_eu = paste0(output_north,'/jishui_eu.csv')
    
    output_north_moun_as = paste0(output_north,'/moun_as.csv')
    output_north_moun_ato = paste0(output_north,'/moun_ato.csv')
    output_north_moun_eu = paste0(output_north,'/moun_eu.csv')
    
    
    match_fun <- function(rel_df,uptake_df,output_file){
      library(dplyr)
      
      tmpid = which(uptake_df$type %in% rel_df$type)
      
      uptake_rel_df = uptake_df[tmpid,]
      
      uptake_rel_df = data.frame(long = uptake_rel_df$long,
                                 lat =  uptake_rel_df$lat,
                                 height = uptake_rel_df$height,
                                 type = uptake_rel_df$type,
                                 uptake = uptake_rel_df$uptake_in_region,
                                 region_id = uptake_rel_df$region_label)
      
      tmpid2 = which(rel_df$type %in% uptake_rel_df$type)
      rel_df_over = rel_df[tmpid2,]
      
      uptake_rel_df$release = rel_df_over$release
      
      fwrite(uptake_rel_df,output_file)
      
    }
    
    match_fun(north_jishui,uptake_as,output_north_jishui_as)
    match_fun(north_jishui,uptake_ato,output_north_jishui_ato)
    match_fun(north_jishui,uptake_eu,output_north_jishui_eu)
    
    match_fun(north_moun,uptake_as,output_north_moun_as)
    match_fun(north_moun,uptake_ato,output_north_moun_ato)
    match_fun(north_moun,uptake_eu,output_north_moun_eu)
    
    print("Pass North")
    south_jishui = fread(input_rel_south_jishui)
    south_moun = fread(input_rel_south_moun)
    
    
    output_south_jishui_as = paste0(output_south,'/jishui_as.csv')
    output_south_jishui_ato = paste0(output_south,'/jishui_ato.csv')
    output_south_jishui_eu = paste0(output_south,'/jishui_eu.csv')
    
    output_south_moun_as = paste0(output_south,'/moun_as.csv')
    output_south_moun_ato = paste0(output_south,'/moun_ato.csv')
    output_south_moun_eu = paste0(output_south,'/moun_eu.csv')
    
    match_fun(south_jishui,uptake_as,output_south_jishui_as)
    match_fun(south_jishui,uptake_ato,output_south_jishui_ato)
    match_fun(south_jishui,uptake_eu,output_south_jishui_eu)
    
    match_fun(south_moun,uptake_as,output_south_moun_as)
    match_fun(south_moun,uptake_ato,output_south_moun_ato)
    match_fun(south_moun,uptake_eu,output_south_moun_eu)
    print('Pass South')
    print(paste0('Pass ',input))
  }
  
  sapply(input_file,sub_match)
    
}
mean_route_by_cl<-function(
  cl_liin
){
  

  
  cl_contr = sum(cl_liin$contr_rate)
  
  #print('1')
  ids = cl_liin$type
  ids = sort(ids)
  xfull <<- df_full_for_cl$type
  df_fullid <<- df_full_for_cl$type
  group_id <- function(x){
    step = round(length(x) /100)
    ids = seq(1,length(x),step)
    ide = ids -1
    ide = ide[-1]
    ide = c(ide,length(x))
    xl = list()
    for(i in 1:length(ids)){
      stmp = ids[i]
      etmp = ide[i]
      tmp = x[stmp:etmp]
      xl[[i]] = tmp
    }
    return(xl)
  }
  if(length(ids) < 100){
    idsl = list(ids)
  }else{
    idsl = group_id(ids) 
  }
  
  source('/home/share/R_project/xinjiang_vapor/search_which_cl_tr.R')
  system.time(ret_box <- lapply(idsl, search_which_cl_tr))
  
  
  
  mean_fun<-function(x){
    x = mean(x,na.rm = T)
    return(x)
  }
  
  mean_outter_long<-function(x){
    longtmp1 = x[,1]
    return(longtmp1)
  }
  mean_outter_lat<-function(x){
    lattmp1 = x[,2]
    return(lattmp1)
  }
  mean_outter_hei<-function(x){
    heitmp1 = x[,3]
    return(heitmp1)
  }
  
  long_o = lapply(ret_box,mean_outter_long)
  lat_o = lapply(ret_box,mean_outter_lat)
  hei_o = lapply(ret_box,mean_outter_hei)
  
  
  long_o = do.call('rbind',long_o)
  lat_o = do.call('rbind',lat_o)
  hei_o = do.call('rbind',hei_o)
  
  long_o = apply(long_o,2,mean_fun)
  lat_o = apply(lat_o,2,mean_fun)
  hei_o = apply(hei_o,2,mean_fun)
  
  mean_ret_df = data.frame(mean_long = long_o,
                           mean_lat = lat_o,
                           mean_hei = hei_o,
                           contr_r = c(cl_contr,rep(NA,(length(long_o)-1))),
                           cluster = unique(cl_liin$cluster))
  return(mean_ret_df)
  
}
mmk_analysis_pme_ato <-function(
  
){
  input_pr_mask = '/media/sdb5/Data/era5_pr_masked/ato'
  input_pr_mask = list.files(input_pr_mask,
                             full.names = T)
  input_pr_mask = do.call('c',
                          lapply(input_pr_mask,
                                 list.files,
                                 full.names = T))
  input_pet_mask = '/media/sdb5/Data/era5_pet_masked/ato'
  input_pet_mask = list.files(input_pet_mask,
                              full.names = T)
  input_pet_mask = do.call('c',
                           lapply(input_pet_mask,
                                  list.files,
                                  full.names = T))
  
  import_ato_nc <-function(x){
    x = stack(x)
    return(x)
  }
  
  pr_li = lapply(input_pr_mask,
                 import_ato_nc)
  pet_li = lapply(input_pet_mask,
                  import_ato_nc)
  
  pr_ato = do.call('merge',pr_li)
  pet_ato = do.call('merge',pet_li)
  
  pr_ato = pr_ato*30.5
  pme_ato = pr_ato - pet_ato
  
  trans_funRaster <- function(x){
    natell = mean(x)
    if(is.na(natell)){
      return(NA)
    }else{
      xts = ts(x, start = c(2003,1),
               frequency = 12)
      xtst = decompose(xts)$trend
      xtst = 
    }
  }
  
  library(doParallel)
  beginCluster(12)

  pme_mmk = clusterR(pme_ato,calc,args = list(fun = mmkfunRaster))
  endCluster()
  
  output_pme_mmk = 'analysis_output/fig2/pme_ato_mmk.nc'
  writeRaster(pme_mmk,output_pme_mmk,
              format = 'CDF',overwrite = T)  
  
  pme_mmkdf = as.data.frame(pme_mmk,xy = T)
  colnames(pme_mmkdf) = c('long','lat',
                          'pme_mmk')
  
  lessid = which(pme_mmkdf$pme_mmk <0)
  
  pme_mmkdf_less = pme_mmkdf[lessid,]

  pme_mmkdf_less$cuts = 
    cut(pme_mmkdf_less$pme_mmk,
        breaks = c(-45,-10,seq(-9,0,1)))
  
  
  shp_ato = paste0('cluster_shp/ato/','ato',1:4,'.shp')
  shp_ato1 = shapefile(shp_ato[[1]])
  shp_ato2 = shapefile(shp_ato[[2]])
  shp_ato3 = shapefile(shp_ato[[3]])
  shp_ato4 = shapefile(shp_ato[[4]])
  
  pmmk_atopme = ggplot()+
  ######
    geom_polygon(data = shp_ato1,
                 aes(x = long,y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_polygon(data = shp_ato2,
                 aes(x = long,y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_polygon(data = shp_ato3,
                 aes(x = long,y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_polygon(data = shp_ato4,
                 aes(x = long,y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_tile(data = pme_mmkdf_less,
              aes(x = long,y = lat,
                  fill = cuts))+
    scale_fill_brewer(palette = 'Spectral')+
    theme_bw()
  ######
  
  pme_mmkdf$cuts = cut(pme_mmkdf$pme_mmk,
                       breaks = c(-45,-10,seq(-8,0,2),
                                  seq(2,10,2),
                                  50,110))
  naidmmk = which(is.na(pme_mmkdf$pme_mmk))
  pme_mmkdf = pme_mmkdf[-naidmmk,]
  library(RColorBrewer)
  mypal = colorRampPalette(brewer.pal(11,'Spectral'))(13)
  
  pmmk_atopme_full = ggplot()+
    geom_polygon(data = shp_ato1,
                 aes(x = long,y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_polygon(data = shp_ato2,
                 aes(x = long,y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_polygon(data = shp_ato3,
                 aes(x = long,y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_polygon(data = shp_ato4,
                 aes(x = long,y = lat,
                     group = group),
                 color = 'black',
                 fill = 'transparent',
                 size = 0.5)+
    geom_tile(data = pme_mmkdf,
              aes(x = long,y = lat,
                  fill = cuts))+
    scale_fill_manual(values = mypal)+
    #scale_fill_brewer(palette = 'Spectral')+
    theme_bw()
    
  
  pme_mmk1 = crop(pme_mmk,shp_ato1)
  pme_mmk2 = crop(pme_mmk,shp_ato2)
  pme_mmk3 = crop(pme_mmk,shp_ato3)
  pme_mmk4 = crop(pme_mmk,shp_ato4)
  
  
}









mmk_analysis_sst_ato <-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/mmk_fundf.R')
  input_sst_mask = '/media/sdb5/Data/era5_sst_masked/ato'
  input_sst_mask = list.files(input_sst_mask,
                              full.names = T)
  input_sst_mask = do.call('c',
                           lapply(input_sst_mask,
                                  list.files,
                                  full.names = T))
  
  import_ato_nc <-function(x){
    x = stack(x)
    return(x)
  }
  
  sst_li = lapply(input_sst_mask,
                  import_ato_nc)
  
  sst_ato = do.call('merge',sst_li)
  
  sst_ato = sst_ato - 273.15
  sst_atodf  = as.data.frame(sst_ato,
                             xy = T)
  
  naidsst = which(is.na(sst_atodf$layer.1))
  sst_atodf = sst_atodf[-naidsst,]
  
  loc = sst_atodf[,c(1,2)]
  sst_atodf = sst_atodf[,-c(1,2)]
  
  sst_atodf = t(sst_atodf)
  
  i = 1:ncol(sst_atodf)
  i <<- i
  sst_atodf <<- sst_atodf
  sub_cal_fun <-function(i){
    tmp = as.numeric(sst_atodf[,i])
    source('/home/share/R_project/xinjiang_vapor/mmk_fundf.R')
    tmp = mmk_fundf(tmp)
    return(tmp)
  }
  
  
  library(doParallel)
  cl = makeCluster(14)
  clusterExport(cl,c('i','sst_atodf'))
  system.time(ret_mmk_sst <-parLapply(cl,i,sub_cal_fun))
  stopCluster(cl)
  
  mmk_sst = do.call('c',ret_mmk_sst)
  mmk_df = data.frame(
    long = loc[,1],
    lat = loc[,2],
    mmk_sst = mmk_sst
  )
  naidsst = which(is.na(mmk_sst))
  mmk_df = mmk_df[-naidsst,]
  output_sst_mmk = 'analysis_output/fig2/sst_mmk.csv'
  fwrite(mmk_df,output_sst_mmk)
  
  mmk_df$cuts = cut(mmk_df$mmk_sst,
                    breaks = c(-20,seq(-10,10,2.5)))
  
  library(metR)
  lessid = which(mmk_df$mmk_sst >0)
  mmk_df = mmk_df[lessid,]
  
  bigdf =  mmk_df[,1:3]
  bigdf$mmk_sst = 1
  coordinates(bigdf) = ~long+lat
  gridded(bigdf) = T
  bigdf = raster(bigdf)
  
  bigdf_poly = rasterToPolygons(bigdf,dissolve = T)
  shapefile(bigdf_poly,'analysis_output/fig2/sst_big0.shp')
  psstmmk = ggplot()+
    ######
  geom_polygon(data = world,
               aes(x = long,y = lat,
                   group = group),
               color = 'black',
               fill = 'transparent',
               size = 0.5)+
    geom_tile(data = mmk_df,
              aes(x = long,y = lat,
                  fill = cuts))+
    geom_contour(data = mmk_df,
              aes(x = long,y = lat,
                  z = mmk_sst),
              binwidth = 2.5)+
    geom_text_contour(
      data = mmk_df,
      aes(x = long,y = lat,z = mmk_sst),
      binwidth = 2.5,
      check_overlap = T,
      size = 5
    )+
    scale_color_brewer(palette = 'Spectral')+
    scale_fill_brewer(palette = 'Spectral')+
    theme_bw()
  ######
  
}









mmk_fundf <-function(x){
  x = as.numeric(x)
  xtell = mean(x)
  if(is.na(xtell)){
    x = NA
  }else{
    x = as.numeric(x)
    source('/home/share/R_project/xinjiang_vapor/mmkTrend.R')
    
    mmk = mmkTrend(x)$Zc
    mmk = as.numeric(mmk)
    x = mmk
  }
  return(x)
}
mmk_monthly_analysis <-function(
  
){
  tws = data_management('grace')
  world = shp_management('world')
  
  world = crop(world,extent(-180,180,0,90))
  
  tws = crop(tws,world)
  tws = mask(tws,world)
  
  
  janid = seq(1,174,12)
  febid = seq(2,174,12)
  marid = seq(3,174,12)
  aprid = seq(4,174,12)
  mayid = seq(5,174,12)
  junid = seq(6,174,12)
  julid = seq(7,174,12)
  augid = seq(8,174,12)
  sepid = seq(9,174,12)
  octid = seq(10,174,12)
  novid = seq(11,174,12)
  decid = seq(12,174,12)
  
  monid = list(janid,febid,marid,aprid,
               mayid,junid,julid,augid,
               sepid,octid,novid,decid)
  
  
  
  monid <<- monid
  tws <<- tws
  
  cell_mean_fun <-function(i){
    tmpid = monid[[i]]
    tmptws = tws[[tmpid]]
    
    
    tmptwsdf = as.data.frame(tmptws,
                             xy = T)
    loc = tmptwsdf[,1:2]
    tmptwsdf = tmptwsdf[,-c(1,2)]
    
    tmptwsmean = apply(tmptwsdf,1,mean
                       ,na.rm = T)
    retbox = cbind(loc,tmptwsmean)
    return(retbox)
  }
  
  i = 1:length(monid)
  mon_mean_box = lapply(i,cell_mean_fun)
  
  twsmmk1 = mon_mean_box[[1]]
  twsmmk2 = mon_mean_box[[2]][,3]
  twsmmk3 = mon_mean_box[[3]][,3]
  twsmmk4 = mon_mean_box[[4]][,3]
  twsmmk5 = mon_mean_box[[5]][,3]
  twsmmk6 = mon_mean_box[[6]][,3]
  twsmmk7 = mon_mean_box[[7]][,3]
  twsmmk8 = mon_mean_box[[8]][,3]
  twsmmk9 = mon_mean_box[[9]][,3]
  twsmmk10 = mon_mean_box[[10]][,3]
  twsmmk11 = mon_mean_box[[11]][,3]
  twsmmk12 = mon_mean_box[[12]][,3]
  
  twsmmk_mon = cbind(twsmmk1,
                     twsmmk2,
                     twsmmk3,
                     twsmmk4,
                     twsmmk5,
                     twsmmk6,
                     twsmmk7,
                     twsmmk8,
                     twsmmk9,
                     twsmmk10,
                     twsmmk11,
                     twsmmk12)
  

  colnames(twsmmk_mon) = c('long','lat',
                           toupper(month.abb))
  dir.create('analysis_output/fig3')
  #output = 'analysis_output/fig3/twsmean_mon.csv'
  
  #fwrite(twsmmk_mon,output)
  #twsmean_mon = twsmmk_mon
  twsmmk_mon = fread('analysis_output/fig3/twsmean_mon.csv')
  twsmmk_mon =as.data.frame(twsmmk_mon)
  
  loc = twsmmk_mon[,1:2]
  twsmmk_mon = twsmmk_mon[,-c(1,2)]
  idnan = which(is.na(twsmmk_mon$JAN))
  
  loc = loc[-idnan,]
  twsmmk_mon = twsmmk_mon[-idnan,]
  
  shp_as = shp_management('land','as')
  shp_eu = shp_management('land','eu')
  shp_naf = shp_management('land','naf')
  shp_as_eu = bind(shp_as,shp_eu,shp_naf)
  ex_as_ato = extent(shp_as_eu)
  ex_as_ato = extent(-50,ex_as_ato[2],ex_as_ato[3],
                     ex_as_ato[4])
  
  i <<- 1:12
  loc <<- loc
  shp_as_eu <<- shp_as_eu
  ex_as_ato <<- ex_as_ato
  twsmmk_mon <<- twsmmk_mon
  
  crop_mask_sub <- function(i){
    tmp = twsmmk_mon[,i]
    tmp = as.numeric(tmp)
    tmpdf = data.frame(loc,tmp)
    
    coordinates(tmpdf) = ~long + lat
    gridded(tmpdf) = T
    tmpdf = raster(tmpdf)
    
    tmpdf = mask(tmpdf,shp_as_eu)
    tmpdf = crop(tmpdf,ex_as_ato)
    
    tmpdf = as.data.frame(tmpdf,xy = T)
    
    return(tmpdf)
    
  }
  
  full_df_li = lapply(i,crop_mask_sub)
  
  full_df = data.frame(
    long = full_df_li[[1]][,1],
    lat = full_df_li[[1]][,2],
    JAN = full_df_li[[1]][,3],
    FEB = full_df_li[[2]][,3],
    MAR = full_df_li[[3]][,3],
    APR = full_df_li[[4]][,3],
    MAY = full_df_li[[5]][,3],
    JUN = full_df_li[[6]][,3],
    JUL = full_df_li[[7]][,3],
    AUG = full_df_li[[8]][,3],
    SEP = full_df_li[[9]][,3],
    OCT = full_df_li[[10]][,3],
    NOV = full_df_li[[11]][,3],
    DEC = full_df_li[[12]][,3]
  )
  
  idnan = which(is.na(full_df$JAN))
  full_df = full_df[-idnan,]
  fulldfm = reshape2::melt(full_df,
                           c('long','lat'))
  
  lessid= which(fulldfm$value<0)
  fulldfm = fulldfm[lessid,]
  fulldfm$cuts = cut(fulldfm$value,
                     breaks = c(-50,-20,seq(-10,0,1)))
  tws_fill = colorRampPalette(
    brewer.pal(11,'Spectral')
  )(12)
  
  # import pme pattern 
  input_pme_mean = 'analysis_output/fig3/pmemean_mon.csv'
  pme_mean = as.data.frame(fread(input_pme_mean))
  naidpme = which(is.na(pme_mean$JAN))
  pme_mean = pme_mean[-naidpme,]
  
  pme_df = reshape2::melt(pme_mean,
                          c('long','lat'))
  
  pme_df$pme_cuts = cut(pme_df$value,
                        breaks = c(-375,-200,
                                   seq(-100,100,10),
                                   200,
                                   400,
                                   700
                                   ))
  
  pme_fill = colorRampPalette(
    brewer.pal(11,'Spectral')
  )(25)
  
  fulldfm$variable = factor(fulldfm$variable,
                            levels = c(toupper(month.abb)[1:12]))
  pme_df$variable = factor(pme_df$variable,
                           levels = c(toupper(month.abb)[1:12]))
  monname = c('JAN','FEB','MAR','APR','MAY',"JUN",
              'JUL',"AUG",'SEP','OCT','NOV',"DEC")
  input_monthly_traj = 'monthly_kmeans_traj'
  #dir.create(input_monthly_traj)
  input_monthly_traj = paste0(input_monthly_traj,'/',
                              monname,'.csv')
  
  df = lapply(input_monthly_traj,fread)
  traj_df_by_mon = do.call('rbind',df)
  traj_df_by_mon$group = paste0(traj_df_by_mon$month,'_',
                                traj_df_by_mon$routeid)
  traj_df_by_mon$variable = traj_df_by_mon$month
  traj_df_by_mon$variable = factor(traj_df_by_mon$variable,
                                   levels = c(toupper(month.abb)[1:12]))
  
  label_df = data.frame(
    x = rep(-170,12),
    y = rep(10,12),
    label = paste0('(',c(letters[1:12]),')'),
    variable = c(toupper(month.abb)[1:12])
    
  )
  
  # input of currents ocean
  cur_df = as.data.frame(
    fread('analysis_output/fig4/current_df.csv')
  )
  
  idless50 = which(cur_df$lat <= 50)
  cur_df = cur_df[idless50,]
  
  idbig1 = which(cur_df$u>0 &
                   cur_df$v >0)
  idbig2 = which(cur_df$u<0 &
                   cur_df$v >0)
  
  cur_df1 = cur_df[idbig1,]
  cur_df2 = cur_df[idbig2,]
  
  cid1 = seq(1,nrow(cur_df1),30)
  cid2 = seq(1,nrow(cur_df2),200)
  
  cur_df1 = cur_df1[cid1,]
  cur_df2 = cur_df2[cid2,]
  
  
  cols_cur = c('#E6E6FA','#FFE4E1')
  
  p1 = ggplot()+
    ###################
    geom_polygon(data = world,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    
    geom_tile(data = fulldfm,
              aes(x = long,y = lat,fill = cuts))+
    scale_fill_manual(values = tws_fill,
                      guide = guide_legend(nrow = 4,
                                           title.position = 'top',
                                           title = 'TWS_MON_MEAN'))+
    new_scale_fill()+
    geom_tile(data = pme_df,
              aes(x = long,y = lat,fill = pme_cuts))+
    scale_fill_manual(values = pme_fill,
                      guide = guide_legend(nrow = 4,
                                           title.position = 'top',
                                           title = 'PME_MON_MEAN'))+
    geom_polygon(data = xj,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    geom_path(data = traj_df_by_mon,aes(x = long,y = lat,
                                        group = group),
              color = '#3A5FCD',size = 0.5 )+
    geom_hline(yintercept = 30,linetype  = 'dashed',
               size = 0.5)+
    geom_hline(yintercept = 60,linetype  = 'dashed',
               size = 0.5)+
    #scale_color_manual(values = mycolor)+
    geom_text(data = label_df,
              aes(x = x,y = y,label = label),
              fontface =  'bold',
              color = 'black',
              size = 5)+
    
    facet_wrap(~variable)+
    ###################
    theme_bw()+
    #guides(fill = guide_legend(nrow = 2))+
    xlab('Longitude')+
    ylab('Latitude')
  
  fontsize = 12
  text_theme_set = theme(
    ##########
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize,
      face = 'bold'),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
    ##########
  )
  
  p1 = p1+ text_theme_set+
    theme(
      legend.position = 'none'
    )
  
  
  p2 = ggplot()+
    ###################
  geom_polygon(data = world,
               aes(x = long,y = lat,group = group),
               fill = 'transparent',
               color = 'black',
               size = 0.5)+
    
    geom_tile(data = fulldfm,
              aes(x = long,y = lat,fill = cuts),
              show.legend = F)+
    scale_fill_manual(values = tws_fill)+
    new_scale_fill()+
    geom_tile(data = pme_df,
              aes(x = long,y = lat,fill = pme_cuts))+
    scale_fill_manual(values = pme_fill,
                      guide = guide_legend(nrow = 4,
                                           title.position = 'top',
                                           title = 'PME_MON_MEAN'))+
    geom_polygon(data = xj,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    geom_path(data = traj_df_by_mon,aes(x = long,y = lat,
                                        group = group),
              color = '#3A5FCD',size = 0.5 )+
    geom_hline(yintercept = 30,linetype  = 'dashed',
               size = 0.5)+
    geom_hline(yintercept = 60,linetype  = 'dashed',
               size = 0.5)+
    #scale_color_manual(values = mycolor)+
    geom_text(data = label_df,
              aes(x = x,y = y,label = label),
              fontface =  'bold',
              color = 'black',
              size = 5)+
    facet_wrap(~variable)+
    ###################
  theme_bw()+
    #guides(fill = guide_legend(nrow = 2))+
    theme(
      legend.position = 'bottom'
    )+
    text_theme_set
  
  p2_leg = as_ggplot(get_legend(p2))
  
  p3 = ggplot()+
    ###################
  geom_polygon(data = world,
               aes(x = long,y = lat,group = group),
               fill = 'transparent',
               color = 'black',
               size = 0.5)+
    
    geom_tile(data = fulldfm,
              aes(x = long,y = lat,fill = cuts))+
    scale_fill_manual(values = tws_fill,
                      guide = guide_legend(nrow = 4,
                                           title.position = 'top',
                                           title = 'TWS_MON_MEAN'))+
    new_scale_fill()+
    geom_tile(data = pme_df,
              aes(x = long,y = lat,fill = pme_cuts),
              show.legend = F)+
    scale_fill_manual(values = pme_fill)+
    geom_polygon(data = xj,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    geom_path(data = traj_df_by_mon,aes(x = long,y = lat,
                                        group = group),
              color = '#3A5FCD',size = 0.5 )+
    geom_hline(yintercept = 30,linetype  = 'dashed',
               size = 0.5)+
    geom_hline(yintercept = 60,linetype  = 'dashed',
               size = 0.5)+
    #scale_color_manual(values = mycolor)+
    geom_text(data = label_df,
              aes(x = x,y = y,label = label),
              fontface =  'bold',
              color = 'black',
              size = 5)+
    facet_wrap(~variable)+
    ###################
  theme_bw()+
    #guides(fill = guide_legend(nrow = 2))+
    theme(
      legend.position = 'bottom'
    )+text_theme_set
  
  p3_leg = as_ggplot(get_legend(p3))
  
  leg = plot_grid(
    p3_leg,p2_leg,
    nrow = 1,
    rel_heights = c(1,1),
    align = 'hv',
    axis = 'b'
  )
  library(cowplot)
  p123 = plot_grid(
    p1,leg,
    axis = 'l',
    align = 'h',
    ncol = 1,
    rel_heights = c(8,1),
    rel_widths = c(1,0.5)
  )
  p1 = p1+theme(legend.position = 'bottom')
  dir.create('main_plot/SI')
  dir.create('main_plot/SI/Monthly_mean_tws_anomaly_evolu')

  png('main_plot/SI/Monthly_mean_tws_anomaly_evolu/Monthly_mean_tws_anomaly_evolu4.png',
             height = 25,
             width = 35,
             units = 'cm',
             res = 800)
  
  print(p1)
  dev.off()
  png('main_plot/SI/Monthly_mean_tws_anomaly_evolu/leg1.png',
      height = 5,
      width = 35,
      units = 'cm',
      res = 800)
  
  print(leg)
  dev.off()
  
}
mmk_trend_analysis_for_subs_ato_mean <- function(
  
){
  input_tws = 'analysis_output/fig4/project_tws'
  input_tws = list.files(input_tws,full.names = T)
  
  tws245_mean = as.data.frame(
    fread(input_tws[2])
  )
  tws585_mean = as.data.frame(
    fread(input_tws[4])
  )
  colnames(tws245_mean) = c('date',
                            'variable',
                            'value')
  colnames(tws585_mean) = c('date',
                            'variable',
                            'value')
  
  vars = paste0('SW',1:10)
  mmks245 = 1
  mmks585 = 1
  for(i in 1:length(vars)){
    tmpid = which(tws245_mean$variable %in% vars[i])
    tmptws245 = tws245_mean[tmpid,3]
    tmptws585 = tws585_mean[tmpid,3]
    
    mmk245 = mmkTrend(as.numeric(tmptws245))$Zc
    mmk585 = mmkTrend(as.numeric(tmptws585))$Zc
    
    mmks245 = c(mmks245,mmk245)
    mmks585 = c(mmks585,mmk585)
  }
  mmks245 = mmks245[-1]
  mmks585 = mmks585[-1]

  dftws_mmk_245 = data.frame(
    Region = vars,
    MMK = mmks245
  )
  dftws_mmk_585 = data.frame(
    Region = vars,
    MMK = mmks585
  )
  
  output_mean_mmk = 'analysis_output/fig4/bars_mmk_mean'
  dir.create(output_mean_mmk)
  output1 = paste0(output_mean_mmk,'/','substws_mmk245.csv')
  output2 = paste0(output_mean_mmk,'/','substws_mmk585.csv')
  
  fwrite(dftws_mmk_245,output1)
  fwrite(dftws_mmk_585,output2)
  
  ## mmk analysis for pme1 and pme3
  source('/home/share/R_project/xinjiang_vapor/import_pme_ato_fig4.R')
  dfpme = import_pme_ato_fig4(T)
  
  vars1 = c('SSP245_PME1','SSP245_PME3')
  vars2 = c('SSP585_PME1','SSP585_PME3')
  
  mmks_245 = 1
  mmks_585 = 1
  for(i in 1:length(vars1)){
    tmp1 = dfpme[which(dfpme$type %in% vars1[i]),3]
    tmp2 = dfpme[which(dfpme$type %in% vars2[i]),3]
    
    tmp1mmk = mmkTrend(as.numeric(tmp1))$Zc
    tmp2mmk = mmkTrend(as.numeric(tmp2))$Zc
    
    mmks_245 = c(mmks_245,tmp1mmk)
    mmks_585 = c(mmks_585,tmp2mmk)
  }
  mmks_245 = mmks_245[-1]
  mmks_585 = mmks_585[-1]
  
  output3 = paste0(output_mean_mmk,'/',
                   'pme_mmk_ssp245.csv')
  output4 = paste0(output_mean_mmk,'/',
                   'pme_mmk_ssp585.csv')
  atodfmmks_245 = data.frame(
    Region = c('ATO1','ATO3'),
    MMK = mmks_245
  )
  atodfmmks_585 = data.frame(
    Region = c('ATO1','ATO3'),
    MMK = mmks_585
  )
  
  fwrite(atodfmmks_245,output3)
  fwrite(atodfmmks_585,output4)
  
  
    
  
}
mmk_trend_analysis_pme_ato <- function(
  
){
  input_pme_ato = '/media/root/Shen_drive1/CMIP6_pme/ato'
  
  input = list.files(input_pme_ato,full.names = T)
  input245 = input[1]
  input585 = input[2]
  
  input245 = list.files(input245,full.names = T)
  input585 = list.files(input585,full.names = T)
  
  input_shp = list.files('cluster_shp/ato',
                         pattern = '*.shp$',
                         full.names = T)[1:4]
  
  output = 'analysis_output/fig4/atopmemmk_raster'
  dir.create(output)
  
  output245 = paste0(output,'/ssp245')
  output585 = paste0(output,'/ssp585')
  
  dir.create(output245)
  dir.create(output585)
  
  output245 = paste0(output245,'/','region',1:4)
  output585 = paste0(output585,'/','region',1:4)
  
  lapply(output245,dir.create)
  lapply(output585,dir.create)
  
  modelnames = c('ACCESS-ESM1-5',
                 'BCC-CSM2-MR',
                 'CanESM5',
                 'GFDL-ESM4',
                 'IPSL-CM6A-LR',
                 'MIROC6',
                 'MRI-ESM2-0',
                 'NorESM2-LM')
  outfiles = paste0(modelnames,'_2018_2020_','mmk.nc')
  
  r1whole = list()
  r2whole = list()
  for(i in 1:4){
    print(i)
    tmpin245 = list.files(input245[i],full.names = T)
    tmpin585 = list.files(input585[i],full.names = T)
    
    tmpoutput245 = output245[i]
    tmpoutput585 = output585[i]    
    
    r1li = list()
    r2li = list()
    for(j in 1:length(tmpin245)){
      tmpr245 = stack(tmpin245[j])
      tmpr585 = stack(tmpin585[j])
      
      tmpr245df = as.data.frame(tmpr245,xy = T)
      tmpr585df = as.data.frame(tmpr585,xy = T)
      
      naid1 = which(is.na(tmpr245df[,3]))
      naid2 = which(is.na(tmpr585df[,3]))
      
      tmpr245df = tmpr245df[-naid1,]
      tmpr585df = tmpr585df[-naid2,]
      
      loc245 = tmpr245df[,1:2]
      loc585 = tmpr585df[,1:2]
      
      df245 = t(tmpr245df[,-c(1,2)])
      df585 = t(tmpr585df[,-c(1,2)])
      
      loc2018 = length(2003:2017)*12-5
      loc2050 = nrow(df245)
      
      df245 = df245[loc2018:loc2050,]
      df585 = df585[loc2018:loc2050,]
      
      source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
      df245 = trend_fun(df245)
      df585 = trend_fun(df585)
      
      naid = which(is.na(df245[,1]))
      df245 = df245[-naid,]
      df585 = df585[-naid,]
      
      sub_cal_mmk245 <- function(k){
        source('/home/share/R_project/xinjiang_vapor/mmkTrend.R')
        x = df245[,k]
        x = as.numeric(x)
        if(!is.na(mean(x))){
          mmk = mmkTrend(x)$Zc
        }else{
          mmk = NA
        }
        return(mmk)
      }
      sub_cal_mmk585 <- function(k){
        source('/home/share/R_project/xinjiang_vapor/mmkTrend.R')
        x = df585[,k]
        x = as.numeric(x)
        if(!is.na(mean(x))){
          mmk = mmkTrend(x)$Zc
        }else{
          mmk = NA
        }
        return(mmk)
      }
      
      k = 1:ncol(df245)
      k <<- k
      df245 <<-df245
      df585 <<- df585
      
      cl = makeCluster(10)
      clusterExport(cl,c('k','df245'))
      system.time(mmk245 <- parLapply(cl,k,
                                       sub_cal_mmk245))
      stopCluster(cl)
      
      cl = makeCluster(10)
      clusterExport(cl,c('k','df585'))
      system.time(mmk585 <- parLapply(cl,k,
                                       sub_cal_mmk585))
      stopCluster(cl)
      
      mmk245 = do.call('c',mmk245)
      mmk585 = do.call('c',mmk585)
      
      mmk245 = data.frame(
        long = loc245[,1],
        lat = loc245[,2],
        mmk = mmk245
      )
      mmk585 = data.frame(
        long = loc585[,1],
        lat = loc585[,2],
        mmk = mmk585
      )
      
      coordinates(mmk245) = ~long+lat
      gridded(mmk245) = T
      r1 = raster(mmk245)
      
      coordinates(mmk585) = ~long+lat
      gridded(mmk585) = T
      r2 = raster(mmk585)
      
      tmpres = res(r1)
      
      if(tmpres[1] != 1.125 |
         tmpres[2] != 1.125){
        
        refer = stack(tmpin245[2])[[1]]
        r1 = resample(r1,refer)
        r2 = resample(r2,refer)
      }
     
      output_245_raster = paste0(tmpoutput245,'/',
                                 outfiles[j])
      output_585_raster = paste0(tmpoutput585,
                                 '/',
                                 outfiles[j])
      library(ncdf4)
      library(raster)
      writeRaster(r1,output_245_raster,
                  overwrite =T)
      
      writeRaster(r2,output_585_raster,
                  overwrite = T)
      
      r1li = c(r1li,r1)
      r2li = c(r2li,r2)
      
    }
    
    r1li1 = try(stack(r1li),silent = T)
    r2li1 = try(stack(r2li),silent = T)
    
    if('try-error' %in% class(r1li1) | 
       'try-error' %in% class(r2li1)){
      
      for(k in 1:length(r1li)){
       if(k != 2 | k!=7){
         r1li[[k]] = crop(r1li[[k]],
                          extent(r1li[[2]]))
         r2li[[k]] = crop(r2li[[k]],
                          extent(r2li[[2]]))
       }
      }
      r1li1 = stack(r1li)
      r2li1 = stack(r2li)
    }
    
    r1_mean = calc(r1li1,mean,na.rm = T)
    r2_mean = calc(r2li1,mean,na.rm= T)
    
    r1whole = c(r1whole,r1_mean)
    r2whole = c(r2whole,r2_mean)
  }
  
  r1whole = do.call('merge',r1whole)
  r2whole = do.call('merge',r2whole)
  
  output_mean_r1 = 'analysis_output/fig4/ato_mmk_ssp245.nc'
  output_mean_r2 = 'analysis_output/fig4/ato_mmk_ssp585.nc'
  
  writeRaster(r1whole,output_mean_r1,
              overwrite = T)
  writeRaster(r2whole,output_mean_r2,
              overwrite = T)
  
  
}
mmk_tws_analysis <-function(
  
){
  tws = data_management('grace')
  
  beginCluster(12)
  tws_mmk = clusterR(tws,calc,
                     args = list(fun=mmkfun))
  endCluster()
  
  
  tws = mask(tws,world)
  
  tws = crop(tws,world)
  tws = mask(tws,world)
  
  tws_mmk_df = as.data.frame(tws_mmk,xy = T)
  
  id = which(is.na(tws_mmk_df$layer))
  tws_mmk_df = tws_mmk_df[-id,]
  tws_mmk_df = tws_mmk_df[-which(tws_mmk_df$layer>0),]
  
  
  tws_mmk_df$cuts = cut(tws_mmk_df$layer,
                        breaks = c(-700,seq(-20,0,2)))
  fwrite(tws_mmk_df,'analysis_output/fig2/tws_mmk_df.csv')
  fwrite(cluster_traj_df,'analysis_output/fig2/cluster_traj_df.csv')
  pmmk = ggplot()+
    geom_polygon(data = world,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    geom_tile(data = tws_mmk_df,
              aes(x = x,y= y,fill = cuts))+
    geom_polygon(data = xj,
                 aes(x = long,y= lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    geom_polygon(data = shp_com,
                 aes(x = long,y= lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    scale_fill_brewer(palette = 'Spectral')+
    geom_path(data = cluster_traj_df,aes(x = long,y = lat,
                                         group = routeid,
                                         color = factor(routeid)),
              size = 1,
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="closed"))+
    theme_bw()
}
mmk_tws_trend_analysis <-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  
  tws = data_management('grace')
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  tws = crop(tws,world)
  tws = mask(tws,world)
  
  twsdf = as.data.frame(tws,xy = T)
  loc = twsdf[,1:2]
  twsdf = twsdf[,-c(1,2)]
  
  library(doParallel)
  library(raster)
  twsdf <<- twsdf
  sub_cal_twsmmk <- function(i){
    source('/home/share/R_project/xinjiang_vapor/trend_funRaster.R')
    x = twsdf[i,]
    xm = trend_funRaster(x)
    return(xm)
  }
  i <<- 1:nrow(twsdf)
  cl = makeCluster(14)
  clusterExport(cl,c('twsdf','i'))
  system.time(twsmmk <- parLapply(cl,i,sub_cal_twsmmk))
  stopCluster(cl)
  
  twsmmkdf = do.call('c',twsmmk)
  twsmmkdf = data.frame(loc,twsmmkdf)
  
  colnames(twsmmkdf) = c('long','lat','twsmmk')
  
  xj= shp_management('xinjiang')
  cluster_traj_df = read.csv('analysis_output/fig2/cluster_traj_df.csv',
                             header = T)
  
  naidmmk = which(is.na(twsmmkdf$twsmmk))
  twsmmkdf = twsmmkdf[-naidmmk,]
  lessid = which(twsmmkdf$twsmmk<0)
  twsmmkdf = twsmmkdf[lessid,]
  
  twsmmkdf$cuts = cut(twsmmkdf$twsmmk,
                      breaks = seq(-24,0,2))
  pmmk = ggplot()+
    geom_polygon(data = world,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    geom_tile(data = twsmmkdf,
              aes(x = long,y= lat,fill = cuts))+
    geom_polygon(data = xj,
                 aes(x = long,y= lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    #geom_polygon(data = shp_com,
    #             aes(x = long,y= lat,group = group),
    #             fill = 'transparent',
    #             color = 'black',
    #            size = 0.5)+
    scale_fill_brewer(palette = 'Spectral')+
    geom_path(data = cluster_traj_df,aes(x = long,y = lat,
                                         group = routeid,
                                         color = factor(routeid)),
              size = 1,
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="closed"))+
    theme_bw()
  
  
  
  
  
}
mmkfunRaster<-function(x){
  xmean = mean(x)
  if(is.na(xmean)){
    x = NA
  }else{
    source('/home/share/R_project/xinjiang_vapor/mmkTrend.R')
    x = mmkTrend(x)$Zc
    x = as.numeric(x)
  }
  return(x)
}
mmkTrend <-function(x, ci = .95) {
    x = x
    z = NULL
    z0 = NULL
    pval = NULL
    pval0 = NULL
    S = 0
    Tau = NULL
    essf = NULL
    ci = ci
    if (is.vector(x) == FALSE) {
      stop("Input data must be a vector")
    }
    if (any(is.finite(x) == FALSE)) {
      x[-c(which(is.finite(x) == FALSE))] -> x
      warning("The input vector contains non-finite numbers. An attempt was made to remove them")
    }
    n <- length(x)
    for (i in 1:(n-1)) {
      for (j in (i+1):n) {
        S = S + sign(x[j]-x[i])
      }
    }
    acf(rank(lm(x ~ I(1:n))$resid), lag.max=(n-1), plot=FALSE)$acf[-1] -> ro
    qnorm((1+ci)/2)/sqrt(n) -> sig
    rep(NA,length(ro)) -> rof
    for (i in 1:(length(ro))) {
      if(ro[i] > sig || ro[i] < -sig) {
        rof[i] <- ro[i]
      } else {
        rof[i] = 0
      }
    }
    2 / (n*(n-1)*(n-2)) -> cte
    ess=0
    for (i in 1:(n-1)) {          
      ess = ess + (n-i)*(n-i-1)*(n-i-2)*rof[i]
    }
    essf = 1 + ess*cte
    var.S = n*(n-1)*(2*n+5)*(1/18) 
    if(length(unique(x)) < n) {
      unique(x) -> aux
      for (i in 1:length(aux)) {
        length(which(x == aux[i])) -> tie
        if (tie > 1) {
          var.S = var.S - tie*(tie-1)*(2*tie+5)*(1/18)  
        }
      }
    }
    VS = var.S * essf            
    if (S == 0) {
      z = 0
      z0 = 0
    }
    if (S > 0) {
      z = (S-1)/sqrt(VS) 
      z0 = (S-1)/sqrt(var.S)
    } else {
      z = (S+1)/sqrt(VS) 
      z0 = (S+1)/sqrt(var.S)
    }      
    pval = 2*pnorm(-abs(z))
    pval0 = 2*pnorm(-abs(z0)) 
    Tau = S/(.5*n*(n-1))
    rep(NA, times=(n^2-n)/2) -> V
    k = 0
    for (i in 2:n) {
      for (j in 1:i) {
        k = k+1
        V[k] = (x[i]-x[j])/(i-j)
        
      }
    }
    median(na.omit(V)) -> slp
    return(list("Z" = z0, "p.value" = pval0, "Zc" = z, "Corrected p.value" = pval, "tau" = Tau, "N/N*s" = essf, "Sen's Slope" = slp))
  }
modify_parttotext<-function(
  
){
  inputpath = '/media/sdb5'
  files = list.files(inputpath,pattern = 'xinjiang[0-9]*',full.names = T)
  fname = 'parttotext.m'
  files = paste0(files,'/',fname)
  
  for (i in 1:length(files)){
    f = files[i]
    fc = readLines(f)
    fc[11] = 'for i = 1:39'
    writeLines(fc,f)
    print(i)
  }
  
}
month_lat_evolution<-function(
  
){
  input_tws_mean = 'analysis_output/fig3/twsmean_mon.csv'
  
  tws_mean = fread(input_tws_mean)
  tws_mean = as.data.frame(tws_mean)
  
  naidtws = which(is.na(tws_mean$JAN))
  tws_mean = tws_mean[-naidtws,]
  
  tws_meanm = reshape2::melt(tws_mean,c('long','lat'))
  lessid = which(tws_meanm$value<0)
  
  tws_meanm = tws_meanm[lessid,]
  
  tws_meanm_agg = aggregate(tws_meanm$value,
                            list(tws_meanm$lat,
                                 tws_meanm$variable),
                            mean)
  
  colnames(tws_meanm_agg) = c('Latitude',
                              'Time',
                              'TWS')
  
  tws_meanm_agg$Time = factor(
    tws_meanm_agg$Time,
    levels = toupper(month.abb)
  )
  
  id = which(tws_meanm_agg$Latitude<=60 &
               tws_meanm_agg$Latitude>=30)
  tws_meanm_agg = tws_meanm_agg[id,]
  
  tws_meanm_agg$TWS_CLASS = cut(tws_meanm_agg$TWS,
                                breaks = seq(-10,0,1))
  tile_col = colorRampPalette(
    brewer.pal(11,'Spectral')
  )(13)
  
  ptile = ggplot()+
    geom_tile(data = tws_meanm_agg,
              aes(y = Latitude,
                  x = Time,
                  fill = TWS_CLASS
              ))+
    scale_fill_manual(values = tile_col)+
    theme_bw()
  
  ptile
  
  #return(tws_meanm_agg)
  
  
  
  
  
  
  
}
month_longit_evolution<-function(
  
){
  shp_as = shp_management('land','as')
  shp_eu = shp_management('land','eu')
  shp_naf = shp_management('land','naf')
  shp_as_eu = bind(shp_as,shp_eu,shp_naf)
  
  shp_oce = list.files('cluster_shp/ato',
                       full.names = T,
                       pattern = '*.shp$')[1:4]
  shp_oce = do.call('bind',lapply(shp_oce,shapefile))
  ex_as_ato = extent(shp_as_eu)
  ex_as_ato = extent(-50,ex_as_ato[2],ex_as_ato[3],
                     ex_as_ato[4])
  
  input_tws_mean = 'analysis_output/fig3/twsmean_mon.csv'
  input_pme_mean = 'analysis_output/fig3/pmemean_mon.csv'
  
  pme_mean = as.data.frame(fread(input_pme_mean))
  tws_mean = fread(input_tws_mean)
  tws_mean = as.data.frame(tws_mean)
  
  naidtws = which(is.na(tws_mean$JAN))
  naidpme = which(is.na(pme_mean$JAN))
  tws_mean = tws_mean[-naidtws,]
  pme_mean = pme_mean[-naidpme,]
  
  ex_chos = which(tws_mean$long<=180 & 
                    tws_mean$long >= -20)
  
  tws_mean = tws_mean[ex_chos,]
  
  ex_chos2 = which(tws_mean$lat <=60 &
                     tws_mean$lat >=30)
  
  #ex_chos3 = which(tws_mean$lat <=60 &
  #                   tws_mean$lat >=50)
  
  #ex_chos4 = which(tws_mean$lat <=50 &
  #                   tws_mean$lat >=40)
  
  #ex_chos5 = which(tws_mean$lat <=40 &
  #                   tws_mean$lat >=30)
  tws_mean = tws_mean[ex_chos2,]
  ex_chos2 = which(pme_mean$lat <=60 &
                     pme_mean$lat >=30)
  pme_mean = pme_mean[ex_chos2,]
  
  tws_meanm = reshape2::melt(tws_mean,c('long','lat'))
  pme_meanm = reshape2::melt(pme_mean,c('long','lat'))
  
  lessid = which(tws_meanm$value<0)
  
  tws_meanm = tws_meanm[lessid,]
  
  tws_meanm_agg = aggregate(tws_meanm$value,
                            list(tws_meanm$long,
                                 tws_meanm$variable),
                            mean)
  pme_meanm_agg = aggregate(pme_meanm$value,
                            list(pme_meanm$long,
                                 pme_meanm$variable),
                            mean)
  tws_meanm_agg$Group.1 = tws_meanm_agg$Group.1 + 0.125
  tws_meanm_agg = rbind(pme_meanm_agg,tws_meanm_agg)
  colnames(tws_meanm_agg) = c('Longitude',
                              'Time',
                              'value')
  
  tws_meanm_agg$Time = factor(
    tws_meanm_agg$Time,
    levels = toupper(month.abb)
  )
  
  tws_meanm_agg$cuts = cut(tws_meanm_agg$value,
                                breaks = c(seq(-60,0,5),
                                           seq(10,140,20)))
  tile_col = colorRampPalette(
    brewer.pal(11,'Spectral')
  )(23)
  
  ptile = ggplot()+
    geom_tile(data = tws_meanm_agg,
              aes(x = Longitude,
                  y = Time,
                  fill = cuts
                  ))+
    geom_vline(xintercept = -50)+
    scale_fill_manual(values = tile_col)+
    theme_bw()
  
  ptile
  
  return(tws_meanm_agg)
  
  
  
  
  
  
  
}
monthly_contri_structure_validation <-function(
  
){
  # import contribution
  
  input_contr = 'analysis_output/contr_in_source_variance_new.csv'
  contr_full = fread(input_contr)
  contr_full = as.data.frame(contr_full)
  contr_full = abs(contr_full)
  sou_names = contr_full[,1]
  sou_names = toupper(sou_names)
  contr_full = contr_full[,-1]
  
  mon_analysis<-function(x){
    
    xm = matrix(x,nrow = 12)
    mean_fun<-function(x){
      xm = mean(x,na.rm = T)
      return(xm)
    }
    max_fun <-function(x){
      xm = max(x,na.rm = T)
      return(xm)
    }
    
    min_fun <-function(x){
      xm = min(x,na.rm = T)
      return(xm)
    }
    
    xmean = apply(xm,1,mean_fun)
    xmax = apply(xm,1,max_fun)
    xmin = apply(xm,1,min_fun)
    
    ret = data.frame(xmean,xmax,xmin)
    return(ret)
  }
  mon_contr = apply(contr_full,1,mon_analysis)
  
  mon_df = do.call('rbind',mon_contr)
  mon_sou_names = rep(sou_names,each = 12)
  mon = c('JAN',"FEB",'MAR','APR',
          'MAY','JUN','JUL','AUG',"SEP",'OCT','NOV','DEC')
  mon = rep(mon,13)
  
  colnames(mon_df)  = c('Contr_mean','Contr_max','Contr_min')
  mon_df = as.data.frame(mon_df)
  mon_df$Month = mon
  mon_df$Source = mon_sou_names
  
  library(reshape2)
  
  mon_df_m = melt(mon_df,c('Month','Source'))
  
  library(ggplot2)
  mon_df_m$Month = factor(mon_df_m$Month,
                          levels =  c('JAN',"FEB",'MAR','APR',
                                      'MAY','JUN','JUL','AUG',"SEP",'OCT','NOV','DEC'))
  mon_df_m$Source = factor(mon_df_m$Source,
                           levels = sou_names)
  
  mon_df_m$value[which(mon_df_m$value<0)] = abs( mon_df_m$value[which(mon_df_m$value<0)])
  mon_df_m$cuts = cut(mon_df_m$value,breaks = c(0,1,5,10,20,30,40,50,60),right = FALSE)
  
  pvar = ggplot()+
    geom_tile(data = mon_df_m,aes(x = Month,y = Source,fill = cuts))+
    scale_fill_brewer(palette = 'Spectral')+
    facet_wrap(~variable,nrow = 1,ncol = 3)
  
  
  # monthly for each year 
  annual_distr_df = contr_full
  
  annual_df_reorder <- function(x){
    xm = matrix(x,nrow = 12)
    colnames(xm) = paste0('year',2003:2017)
    
    mon = c('JAN',"FEB",'MAR','APR',
            'MAY','JUN','JUL','AUG',"SEP",'OCT','NOV','DEC')
    
    xdf = data.frame(mon,xm)
    library(reshape2)
    xdf = melt(xdf,'mon')
    return(xdf)
  }
  
  annual_df = apply(annual_distr_df,1,annual_df_reorder)
  an_sou_names = rep(sou_names,each = nrow(annual_df[[1]]))
  annual_df = do.call('rbind',annual_df)
  
  annual_df$Source = an_sou_names
  annual_df$mon = factor(annual_df$mon,levels =  c('JAN',"FEB",'MAR','APR',
                                                   'MAY','JUN','JUL','AUG',"SEP",'OCT','NOV','DEC'))
  
  annual_df$group = paste0(annual_df$Source,annual_df$variable)
  library(RColorBrewer)
  
  color = colorRampPalette(brewer.pal(11,'Spectral'))(13)
 
  annual_df$monid =rep(1:12,length(2003:2017)*length(sou_names))
  mon_df$monid = rep(1:12,length(sou_names))
  
  pan = ggplot()+
    
    geom_ribbon(data = mon_df,aes(x = monid,ymin = Contr_min,ymax = Contr_max,group= Source),
                fill= 'grey70',alpha = 0.5)+
    geom_point(data = annual_df,aes(x = monid,y = value, color = Source))+
    geom_line(data = mon_df,aes(x = monid,y = Contr_mean,color = Source))+
    
    #geom_path(data = annual_df,aes(x= mon,y = value, group = variable))+
    scale_color_manual(values = color)+
    scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12),
                       labels =c('JAN',"FEB",'MAR','APR',
                                 'MAY','JUN','JUL','AUG',"SEP",'OCT','NOV','DEC'))+
    facet_wrap(~Source,ncol = 4,scales = 'free')+
    theme_bw()
  
  
  # rank the contribution
  rank_fun <-function(x){
    sumx = sum(x,na.rm = T)
    r = x/sumx
    return(r)
  }
  
  rank_mat = apply(contr_full,2,rank_fun)
  rank_mean = apply(rank_mat,1,mean,na.rm = T)*100
  rank_max = apply(rank_mat,1,max,na.rm = T)*100
  rank_min = apply(rank_mat,1,min,na.rm = T)*100
  
}
monthly_convey_by_region_analysis <-function(
  
){
  
  input_files = list.files('/media/sdb1/xinjiang_output_file/',full.names = T)
  input_files = paste0(input_files,'/output/convey_rate_by_region.csv')
  
  #order = c('as','ato','eu')
  
  con_box = 1
  for(i in 1:length(input_files)){
    convey_rate = fread(input_files[i])
    names = convey_rate[,3]
    convey_rate = convey_rate[,2]
    con_box = cbind(con_box,convey_rate)
  }
  con_box = con_box[,-1]
  
  con_box = as.matrix(con_box)
  
  cal_mon_max <- function(x){
    x = matrix(x,nrow = 12)
    
    max_fun <-function(y){
      y = max(y,na.rm = T)
      return(y)
    }
    
    xm = apply(x,1,max_fun)
    return(xm)
  }
  
  cal_mon_min <- function(x){
    x = matrix(x,nrow = 12)
    
    min_fun <-function(y){
      y = min(y,na.rm = T)
      return(y)
    }
    
    xm = apply(x,1,min_fun)
    return(xm)
  }
  
  cal_mon_mean <- function(x){
    x = matrix(x,nrow = 12)
    
    mean_fun <-function(y){
      y = mean(y,na.rm = T)
      return(y)
    }
    
    xm = apply(x,1,mean_fun)
    return(xm)
  }
  
  con_max = apply(con_box,1,cal_mon_max)
  con_mean = apply(con_box,1,cal_mon_mean)
  con_min = apply(con_box,1,cal_mon_min)
  
  con_max = t(con_max)
  con_mean = t(con_mean)
  con_min = t(con_min)
  
  mon_name = c('JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT',
               'NOV','DEC')
  
  colnames(con_max) = mon_name
  colnames(con_min) = mon_name
  colnames(con_mean) = mon_name

  con_max = data.frame(
    re_group = names$groups,
    con_max
  )
  
  con_min = data.frame(
    re_group = names$groups,
    con_min
  )
  
  con_mean = data.frame(
    re_group = names$groups,
    con_mean
  )
  
  con_max_df = reshape2::melt(con_max,'re_group')
  
  con_min_df = reshape2::melt(con_min,'re_group')
  
  con_mean_df = reshape2::melt(con_mean,'re_group')
  
  date_match<-function(x){
    mon_name = c('JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT',
                 'NOV','DEC')
    id = which(mon_name == x)
    return(id)
  }
  
  date = sapply(con_max_df$variable,date_match)
  
  con_max_df$date = date
  con_min_df$date = date
  con_mean_df$date = date
  
  region = c('north_jishui','north_moun','south_jishui',"south_mon")
  region = rep(region,each = 3)
  region = paste0(region,'_',c('as','ato','eu'))
  region = rep(region,each = 4)
  region = rep(region,12)
  
  con_max_df$region = region
  con_min_df$region = region
  con_mean_df$region = region
  
  ribbion_df = con_max_df
  ribbion_df$min = con_min_df$value
  ribbion_df$max = con_max_df$value
  
  output = 'analysis_output'
  output_min = paste0(output,'/convey_rate_by_region_min.csv')
  output_max = paste0(output,'/convey_rate_by_region_max.csv')
  output_mean = paste0(output,'/convey_rate_by_region_mean.csv')
  
  fwrite(con_min,output_min)
  fwrite(con_max,output_max)
  fwrite(con_mean,output_mean)
  
  library(ggplot2)
  pmean = ggplot()+
    geom_line(data = con_mean_df,aes(x = date,y = value,color = re_group),size = 0.5)+
    geom_ribbon(data = ribbion_df,aes(x = date,ymin=min,ymax=max,group = re_group),
                fill = 'grey80',alpha = 0.5)+
    scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12),
                       labels = mon_name)+
    facet_wrap(~region,nrow = 4,scales = 'free')+
    theme_bw()+
    theme(
      legend.position = 'none'
    )
  
}
monthly_pattern_analysis<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/monthly_pattern_cal.R')
  # gpcc 
  source('/home/share/R_project/xinjiang_vapor/gpcc_pr_in_xinjiang.R')
  gpcc_full = gpcc_pr_in_xinjiang(mode = 'full')
  gpcc_mon = monthly_pattern_cal(gpcc_full)
  # gws
  source('/home/share/R_project/xinjiang_vapor/gws_in_xinjiang.R')
  gws_full = gws_in_xinjiang(mode = 'full')
  gws_mon = monthly_pattern_cal(gws_full)
  # era5_evpor
  source('/home/share/R_project/xinjiang_vapor/era5_evapor.R')
  eva_full = era5_evapor(mode = 'full')
  eva_mon = monthly_pattern_cal(eva_full)
  # era5_temper
  source('/home/share/R_project/xinjiang_vapor/era5_temper.R')
  t_full = era5_tmp(mode = 'full')
  t_mon = monthly_pattern_cal(t_full)
  # ndvi 
  source('/home/share/R_project/xinjiang_vapor/ndvi_in_xinjiang.R')
  ndvi_full = ndvi_in_xinjiang(mode = 'full')
  ndvi_mon = monthly_pattern_cal(ndvi_full)
  
  month =  c('JAN','FEB','MAR','APR','MAY',
             "JUN",'JUL','AUG','SEP',"OCT",'NOV',"DEC")
  d = data.frame(month,gpcc_mon,gws_mon,eva_mon)
  
  dm = reshape2::melt(d,'month')
  
  dm$month = factor(dm$month,levels = month)
  
  p = ggplot()+
    geom_line(data = dm,aes(x = month,y = value, color = variable,group = variable))+
    theme_bw()+
    theme(
      panel.background = element_rect(fill = 'transparent'),
      axis.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      axis.title = element_text(color = 'black',size = 14,face = 'bold',hjust = 0.5),
      legend.position = 'bottom',
      legend.direction = 'horizontal',
      legend.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      legend.title = element_text(color = 'black',size = 14, face = 'bold',hjust = 0.5),
      strip.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5)
    )+
    guides(color = guide_legend(nrow = 1))+
    xlab('Date (month)')+
    ylab('Index')
  
  p
}
monthly_pattern_cal<-function(
  index
){
  
  #start = 2003-01-01
  #end = 2017-12-01
  
  indexm = matrix(index,nrow = 12)
  
  mean_fun<-function(x){
    tmp = mean(x,na.rm = T)
  }
  indexm = apply(indexm,1,mean_fun)
  return(indexm)
  
}
monthly_pattern_convey_rates <- function(
  
){
  mode = c('ato','as','eu')
  
  region_file = paste0('cluster_shp/',mode,'/',mode,1:4,'.shp')
  
  input_file = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
  input_file = paste0(input_file,'/output/convey_rate_df')
  
  sum_fun <- function(x){
    x = sum(x,na.rm = T)
  }
  
  convey_rate_b = 1
  for(i in 1:length(input_file)){
    ato_input = paste0(input_file[i],'/',mode[1],'.csv')
    as_input = paste0(input_file[i],'/',mode[2],'.csv')
    eu_input = paste0(input_file[i],'/',mode[3],'.csv')
    
    ato = fread(ato_input)
    as = fread(as_input)
    eu = fread(eu_input)
    
    ato_contr_value_agg = aggregate(ato$contr_value,list(ato$region_label),sum_fun)
    as_contr_value_agg = aggregate(as$contr_value,list(as$region_label),sum_fun)
    eu_contr_value_agg = aggregate(eu$contr_value,list(eu$region_label),sum_fun)
    
    ato_uptake_agg = aggregate(ato$uptake_in_region, list(ato$region_label),sum_fun)
    as_uptake_agg = aggregate(as$uptake_in_region,list(as$region_label),sum_fun)
    eu_uptake_agg = aggregate(eu$uptake_in_region,list(eu$region_label),sum_fun)
    
    ato_convey_rate = abs(ato_contr_value_agg[,2])/ato_uptake_agg[,2]
    as_convey_rate = abs(as_contr_value_agg[,2])/as_uptake_agg[,2]
    eu_convey_rate = abs(eu_contr_value_agg[,2])/eu_uptake_agg[,2]
    
    
    
    full_id = 1:4
    
    if(length(ato_convey_rate)<4){
      ato_id = ato_uptake_agg[,1]
      idin = which(full_id %in% ato_id)
      notinid = full_id[-idin]
      
      ato_convey_rate = c(ato_convey_rate,rep(0,length(notinid)))
      ato_id = c(ato_id,notinid)
      
    }else{
      ato_id = full_id
    }
    
    if(length(as_convey_rate)<4){
      as_id = as_uptake_agg[,1]
      idin = which(full_id %in% as_id)
      notinid = full_id[-idin]
      
      as_convey_rate = c(as_convey_rate,rep(0,length(notinid)))
      as_id = c(as_id,notinid)
    }else{
      as_id = full_id
    }
    
    if(length(eu_convey_rate)<4){
      eu_id = eu_uptake_agg[,1]
      idin = which(full_id %in% eu_id)
      notinid = full_id[-idin]
      
      eu_convey_rate = c(eu_convey_rate,rep(0,length(notinid)))
      eu_id = c(eu_id,notinid)
    }else{
      eu_id = full_id
    }
    
    
    ato_df = data.frame(id = ato_id,
                        convey_rate = ato_convey_rate)
    as_df = data.frame(id = as_id,
                       convey_rate = as_convey_rate)
    eu_df = data.frame(id = eu_id,
                       convey_rate = eu_convey_rate)
    
    
    s_ato = order(ato_df[,1])
    s_as = order(as_df[,1])
    s_eu = order(eu_df[,1])
    
    ato_df = ato_df[s_ato,]
    as_df = as_df[s_as,]
    eu_df = eu_df[s_eu,]
    
    ato_df$id = paste0('ato',ato_df$id)
    as_df$id = paste0('as',as_df$id)
    eu_df$id = paste0('eu',eu_df$id)
    
    ret_df = rbind(ato_df,as_df,eu_df)
    
    convey_rate_b = cbind(convey_rate_b,ret_df$convey_rate)
    print(i)
  }
  
  convey_rate_df = convey_rate_b[,-1]
  
  
  sub_month_min_analys<-function(x){
    xm = matrix(x,nrow = 12)
    
    min_fun <- function(y){
      y = min(y,na.rm = T)
      return(y)
    }
    
    xm = apply(xm,1,min_fun)
    
    return(xm)
  }
  
  sub_month_max_analys<-function(x){
    xm = matrix(x,nrow = 12)
    
    max_fun <- function(y){
      y = max(y,na.rm = T)
      return(y)
    }
    
    xm = apply(xm,1,max_fun)
    
    return(xm)
  }
  
  sub_month_mean_analys<-function(x){
    xm = matrix(x,nrow = 12)
    
    mean_fun <- function(y){
      y = mean(y,na.rm = T)
      return(y)
    }
    
    xm = apply(xm,1,mean_fun)
    
    return(xm)
  }
  
  convey_rate_mon_min = apply(convey_rate_df,1,sub_month_min_analys)
  convey_rate_mon_max = apply(convey_rate_df,1,sub_month_max_analys)
  convey_rate_mon_mean = apply(convey_rate_df,1,sub_month_mean_analys)
  
  convey_rate_mon_min = t(convey_rate_mon_min)
  convey_rate_mon_max = t(convey_rate_mon_max)
  convey_rate_mon_mean = t(convey_rate_mon_mean)
  
  mon_name = c('JAN','FEB','MAR','APR','MAY','JUN',"JUL",'AUG','SEP','OCT','NOV','DEC')
  
  colnames(convey_rate_mon_min) = mon_name
  colnames(convey_rate_mon_max) = mon_name
  colnames(convey_rate_mon_mean) = mon_name
  
  convey_rate_mon_max = data.frame(id = ret_df[,1],convey_rate_mon_max)
  convey_rate_mon_min = data.frame(id = ret_df[,1],convey_rate_mon_min)
  convey_rate_mon_mean = data.frame(id = ret_df[,1],convey_rate_mon_mean)
  
  convey_rate_mon_max = as.data.frame(convey_rate_mon_max)
  convey_rate_mon_min = as.data.frame(convey_rate_mon_min)
  convey_rate_mon_mean = as.data.frame(convey_rate_mon_mean)
  
  fwrite(convey_rate_mon_max,'analysis_output/convey_rate_mon_max.csv')
  fwrite(convey_rate_mon_min,'analysis_output/convey_rate_mon_min.csv')
  fwrite(convey_rate_mon_mean,'analysis_output/convey_rate_mon_mean.csv')
  
  convey_rate_mon_max = read.csv('analysis_output/convey_rate_mon_max.csv',
                                 header = T)
  convey_rate_mon_min = read.csv('analysis_output/convey_rate_mon_min.csv',
                                 header = T)
  convey_rate_mon_mean = read.csv('analysis_output/convey_rate_mon_mean.csv',
                                  header = T)
  
  df_max = melt(convey_rate_mon_max,'id')
  df_min = melt(convey_rate_mon_min,'id')
  df_mean = melt(convey_rate_mon_mean,'id')
  
  df_max$variable = factor(df_max$variable,
                           levels = mon_name)
  
  df_min$variable = factor(df_min$variable,
                           levels = mon_name)
  
  df_mean$variable = factor(df_mean$variable,
                           levels = mon_name)
  
  
  match_mon_id <-function(x){
    if(x == 'JAN'){
      x = 1
    }else if(x =='FEB'){
      x = 2
    }else if(x =='MAR'){
      x = 3
    }else if(x =='APR'){
      x = 4
    }else if(x =='MAY'){
      x = 5
    }else if(x =='JUN'){
      x = 6
    }else if(x =='JUL'){
      x = 7
    }else if(x =='AUG'){
      x = 8
    }else if(x =='SEP'){
      x = 9
    }else if(x =='OCT'){
      x = 10
    }else if(x =='NOV'){
      x = 11
    }else if(x =='DEC'){
      x = 12
    }
  }
  
  df_max$monid = sapply(df_max$variable,match_mon_id)
  df_min$monid = sapply(df_min$variable,match_mon_id)
  df_mean$monid = sapply(df_mean$variable,match_mon_id)
  
  df_rib = df_max
  colnames(df_rib) = c('id','variable','max','monid')
  df_rib$min = df_min$value
  
  pmax = ggplot()+
    geom_ribbon(data = df_rib,aes(x = monid,ymax = max,ymin = min),
                fill = 'grey80',alpha = 0.5)+
    geom_line(data = df_mean,aes(x = monid,y = value,color = id))+
    scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12),
                       labels = mon_name)+
    facet_wrap(~id,nrow = 4,scales = 'free')+
    theme_bw()
  
  
  
  
}
monthly_sst_land_temperate_analysis <- function(
  
){
  sst = data_management('global_era5_sst')
  tas = data_management('global_era5_temperature')
  
  world = shp_management('world')
  world = crop(world,extent(-180,180,0,90))
  
  sst = crop(sst,extent(-180,180,0,90))
  #sst = mask(sst,world)
  tas = crop(tas,world)
  tas = mask(tas,world)
  
  tas = tas[[1:174]]
  sst = sst[[1:174]]
  
  janid = seq(1,174,12)
  febid = seq(2,174,12)
  marid = seq(3,174,12)
  aprid = seq(4,174,12)
  mayid = seq(5,174,12)
  junid = seq(6,174,12)
  julid = seq(7,174,12)
  augid = seq(8,174,12)
  sepid = seq(9,174,12)
  octid = seq(10,174,12)
  novid = seq(11,174,12)
  decid = seq(12,174,12)
  
  monid = list(janid,febid,marid,aprid,
               mayid,junid,julid,augid,
               sepid,octid,novid,decid)
  
  
  
  monid <<- monid
  sst <<- sst
  tas <<- tas
  
  cell_mean_fun_sst<-function(i){
    tmpid = monid[[i]]
    tmpsst = sst[[tmpid]]
    
    sub_cal_mean_bycell <-function(x){
      x = mean(x,na.rm = T)
      return(x)
    }
    
    library(raster)
    library(doParallel)
    beginCluster(12)
    mon_mean = clusterR(tmpsst,calc,
                        args = list(fun = sub_cal_mean_bycell))
    endCluster()
    gc()
    return(mon_mean)
  }
  cell_mean_fun_tas<-function(i){
    tmpid = monid[[i]]
    tmptas = tas[[tmpid]]
    
    sub_cal_mean_bycell <-function(x){
      x = mean(x,na.rm = T)
      return(x)
    }
    
    library(raster)
    library(doParallel)
    beginCluster(12)
    mon_mean = clusterR(tmptas,calc,
                        args = list(fun = sub_cal_mean_bycell))
    endCluster()
    gc()
    return(mon_mean)
  }
  
  i = 1:length(monid)
  mon_mean_sst = lapply(i,cell_mean_fun_sst)
  mon_mean_tas = lapply(i,cell_mean_fun_tas)
  
  mon_mean_sst = stack(mon_mean_sst)
  mon_mean_tas = stack(mon_mean_tas)
  
  mon_sst_df = as.data.frame(mon_mean_sst,xy = T)
  mon_tas_df = as.data.frame(mon_mean_tas,xy = T)
  
  colnames(mon_sst_df) = c('long','lat',toupper(month.abb))
  colnames(mon_tas_df) = c('long','lat',toupper(month.abb))
  
  mon_sst_dfm = reshape2::melt(mon_sst_df,
                               c('long','lat'))
  mon_tas_dfm = reshape2::melt(mon_tas_df,
                               c('long','lat'))
  
  naid_sst = which(is.na(mon_sst_dfm$value))
  naid_tas = which(is.na(mon_tas_dfm$value))
  
  mon_sst_dfm = mon_sst_dfm[-naid_sst,]
  mon_tas_dfm = mon_tas_dfm[-naid_tas,]
  
  mon_sst_dfm$value = mon_sst_dfm$value - 273.15
  mon_tas_dfm$value = mon_tas_dfm$value - 273.15
  
  
  mon_ssttas = rbind(mon_sst_dfm,mon_tas_dfm)
  ptas_tas = ggplot()+
    geom_tile(data = mon_ssttas,
              aes(x = long,y = lat,
                  fill = value))+
    scale_fill_distiller(palette = 'Spectral')+
    geom_polygon(data = world,
                 aes(x = long,y = lat,group = group),
                 color = 'black',
                 size = 0.5,
                 fill = 'transparent')+
    geom_polygon(data = shp_com,
                 aes(x = long,y= lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    facet_wrap(~variable,nrow = 4)+
    theme_bw()
  
}


nc_attaching_significance <- function(
  
){
  # adding fig2 
  source("/home/share/R_project/xinjiang_vapor/fig2_line_plot_significance.R")
  fig2_line_plot_significance()
  
  # fig S3 significance
  source("/home/share/R_project/xinjiang_vapor/calc_figs3_sig.R")
  calc_figs3_sig()
  source("/home/share/R_project/xinjiang_vapor/calc_figS6_sig.R")
  calc_figS6_sig()
  #
  
}
nc_to_df <- function(
  a
){
  
  
  long = try(ncvar_get(a,'longitude'),
             silent = T)
  lat = try(ncvar_get(a,'latitude'),
            silent = T)
  
  if('try-error' %in% class(long)){
    long = ncvar_get(a,'lon')
  }
  
  if('try-error' %in% class(lat)){
    lat = ncvar_get(a,'lat')
  }
  
  nlong = dim(long)
  nlat = dim(lat)
  
  tos = ncvar_get(a,'tos')
  
  n = dim(tos)[3]
  
  long = as.vector(long)
  lat = as.vector(lat)
  
  long <<- long
  lat <<- lat
  tos <<- tos
  i <<- 1:n
  subs_fun <- function(i){
    library(raster)
    tmptos = tos[,,i]
    tmptos = as.vector(tmptos)
    return(tmptos)
  }
  
  ret <- lapply(i,subs_fun)
  ret = do.call('cbind',ret)
  
  df = data.frame(
    long = long,
    lat = lat,
    ret
  )
  
  return(df)
  
}
nc_to_df <- function(
  
){
  a = nc_open(files_in_full2)
  
  long = ncvar_get(a,'longitude')
  lat = ncvar_get(a,'latitude')
  
  nlong = dim(long)
  nlat = dim(lat)
  
  tos = ncvar_get(a,'tos')
  
  n = dim(tos)[3]
  
  long = as.vector(long)
  lat = as.vector(lat)
  
  long <<- long
  lat <<- lat
  tos <<- tos
  i <<- 1:n
  subs_fun <- function(i){
    library(raster)
    tmptos = tos[,,i]
    tmptos = as.vector(tmptos)
   
    return(tmptos)
  }
  
  ret <- lapply(i,subs_fun)
  
  
}
ndvi_in_xinjiang <- function(
  mode = 'trend'
){
  library(raster)
  library(ncdf4)
  library(ggplot2)
  #source('/home/share/R_project/xinjiang_vapor/data_management.R')
  #ndvi = data_management(mode = 'ndvi')
  #writeRaster(ndvi,'/media/sdb5/Data/data_in_nc/ndvi_2003_2017.nc')
  
  ndvi = stack('/media/sdb5/Data/data_in_nc/ndvi_2003_2017.nc')
  ndvib = 1
  for(i in 1:dim(ndvi)[[3]]){
    tmp= cellStats(ndvi[[i]],'mean')
    ndvib = c(ndvib,tmp)
  }
  ndvib = ndvib[-1]
  if(mode == 'trend'){
    ndvib = trend_index(ndvib,start = c(2003,1),fre = 12)
  }else{
    ndvib = ndvib
  }
  
  return(ndvib)
  #date = seq(as.Date('2003-01-01'),as.Date('2017-12-01'),'1 month')
  
  #df = data.frame(date,ndvi = ndvib)
  #p = ggplot()+
  #  geom_line(data = df,aes(x = date,y = ndvi),color = 'blue')
  
  #p  
}
north_land_shp_pre<-function(
  
){
  
  # land shp 
  land_path = '/media/sdb1/shp/world_continent_shp/'
  files = list.files(land_path,pattern = '*.shp$',full.names = T)
  files = files[1:4]
  
  con_li = list()
  for(i in 1:length(files)){
    con_li = c(con_li,shapefile(files[i]))
  }
  
  con_name = c("north_africa",'asia','europe','north_america')
  mask_crop_north<-function(x){
    cr_ex = extent(extent(x)[1],extent(x)[2],0,extent(x)[4])
    tmpx = crop(x,cr_ex)
  }
  
  
  msk_ret = lapply(con_li,mask_crop_north)
  
  
  #dir.create('/media/sdb1/shp/north_land')
  ofiles = paste0(con_name,'.shp')
  output = paste0('/media/sdb1/shp/north_land/',ofiles)
  
  for(i in 1:length(output)){
    shapefile(msk_ret[[i]],output[i])
  }
  
  
}
outter_cal_contri_rate2<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/check_output_number.R')
  input_data = check_output_number()
  
  system.time(cal_contri_rate2(input_data))
}
outter_cal_convey_by_region_based_on_cmip6<-function(
  
){
  mode = c('hist_ssp245','hist_ssp585')
  
  lapply(mode,cal_convey_by_region_based_on_cmip6)
  
  
}
outter_cal_eva_in_each_region_based_cmip6<-function(
  
){
  models = c('ACCESS-ESM1-5','BCC-CSM2-MR',
             'CanESM5','GFDL-ESM4','IPSL-CM6A-LR',
             'MIROC6','MRI-ESM2-0','NorESM2-LM')
  pattern1 = rep('hist_ssp245',8)
  source('/home/share/R_project/xinjiang_vapor/cal_eva_in_each_region_based_cmip6.R')
  mapply(cal_eva_in_each_region_based_cmip6,models,pattern1)
  
  print('Pass pattern1')
  pattern2 = rep('hist_ssp585',8)
  mapply(cal_eva_in_each_region_based_cmip6,models,pattern2)
}
outter_cal_mean_traj <- function(
  
){
  
  source('/home/share/R_project/xinjiang_vapor/cluster_traj_routes.R')
  input_data = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
  input_data = paste0(input_data,'/output')
  
  #input_data = input_data[1:180]
  cluster_traj_routes(input_data) 
  
}
outter_cal_released_xinjiang<-function(
  
){
  input_data = check_output_number()
  full = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
  full = paste0(full,'/output')
  
  id = which(full == input_data[1])
  id = id-1
  input_data = c(full[id],input_data)
  
  main_cal_relesed_inxinjiang(input_data)
}
outter_cal_temp_in_each_region_based_on_cmip6 <-function(
  
){
  models = c('ACCESS-ESM1-5','BCC-CSM2-MR',
             'CanESM5','GFDL-ESM4','IPSL-CM6A-LR',
             'MIROC6','MRI-ESM2-0','NorESM2-LM')
  pattern1 = rep('hist_ssp245',8)
  source('/home/share/R_project/xinjiang_vapor/cal_temp_in_each_region_based_cmip6.R')
  mapply(cal_temp_in_each_region_based_cmip6,models,pattern1)
  
  print('Pass pattern1')
  pattern2 = rep('hist_ssp585',8)
  mapply(cal_temp_in_each_region_based_cmip6,models,pattern2)
}
outter_cluster_basedon_allpart <- function(
  
){
  
  # label id for each sub squared region for first points
  # 
  source('/home/share/R_project/xinjiang_vapor/cluster_basedon_allpart.R')
  mode = c('ato','as','eu')
  
  sapply(mode,cluster_basedon_allpart)
  
}
outter_control_cal_released_in_xinjiang_jishui <- function(
  
){
  input_file = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
  input_file = paste0(input_file,'/output')
  
  source('/home/share/R_project/xinjiang_vapor/cal_released_in_xinjiang_jishui.R')
  system.time(cal_released_in_xinjiang_jishui(input_file))
  
  
  
  source('/home/share/R_project/xinjiang_vapor/match_convey_and_rel_by_region.R')
  
  input_file = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
  system.time(match_convey_and_rel_by_region(input_file))
  
  
  source('/home/share/R_project/xinjiang_vapor/cal_convey_rate_by_region.R')
  input_file = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
  cal_convey_rate_by_region(input_file)
  
}
outter_filter_cmip6_data_to_date<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/filter_cmip6_data_to_date.R')
  filter_cmip6_data_to_date('E')
  filter_cmip6_data_to_date('Pr')
  filter_cmip6_data_to_date('T')
  
  source('/home/share/R_project/xinjiang_vapor/combine_cmip6_data_his_ssp.R')
  combine_cmip6_data_his_ssp('E')
  combine_cmip6_data_his_ssp('Pr')
  combine_cmip6_data_his_ssp('T')
  
  source('/home/share/R_project/xinjiang_vapor/adjust_extent_cmip6_hist_ssp585.R')
  adjust_extent_cmip6_hist_ssp585()
  
}
outter_mask_crop_cmip6_pme<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/mask_crop_cmip6_pme.R')
  mode = c('ato','as','eu')
  
  mask_crop_cmip6_pme(mode[1])
  mode = c('ato','as','eu')
  mask_crop_cmip6_pme(mode[2])
  mode = c('ato','as','eu')
  mask_crop_cmip6_pme(mode[3])
  
}
outter_mask_crop_cmip6 <- function(
  
){
  mode =c('ato','as','eu')
  source('/home/share/R_project/xinjiang_vapor/mask_crop_cmip6.R')
  system.time(mask_crop_cmip6(mode[1]))
  system.time(mask_crop_cmip6(mode[2]))
  system.time(mask_crop_cmip6(mode[3]))
}
outter_predict_tws_based_on_cmip6<-function(
  
){
  models = c('ACCESS-ESM1-5','BCC-CSM2-MR',
             'CanESM5','GFDL-ESM4','IPSL-CM6A-LR',
             'MIROC6','MRI-ESM2-0','NorESM2-LM')
  pattern1 = rep('hist_ssp245',8)
  
  source('/home/share/R_project/xinjiang_vapor/predic_tws_model_cmip6.R')
  
  
  ret_north_train = 1
  ret_north_test = 1
  ret_north_project = 1
  
  ret_south_train = 1
  ret_south_test = 1
  ret_south_project = 1
  
  
  output = 'simu_cmip6_tws'
  dir.create(output)
  output = paste0(output,'/',pattern1[1])
  dir.create(output)
  
  filesname = paste0(c('north_train','north_test','north_project',
                       'south_train','south_test','south_project'),'.csv')
  output = paste0(output,'/',filesname)
  
  
  for(i in 1:8){
    ret_box = predic_tws_model_cmip6(models[i],pattern1[i])
    
    ret_north = ret_box[[1]]
    ret_south = ret_box[[2]]
    
    
    ret_north_train = cbind(ret_north_train,
                            ret_north[[1]])
    ret_north_test = cbind(ret_north_test,
                           ret_north[[2]])
    ret_north_project = cbind(ret_north_project,
                              ret_north[[3]])
    
    ret_south_train = cbind(ret_south_train,
                            ret_south[[1]])
    ret_south_test = cbind(ret_south_test,
                           ret_south[[2]])
    ret_south_project = cbind(ret_south_project,
                              ret_south[[3]])
    
  }
  ret_north_test = ret_north_test[,-1]
  ret_north_train = ret_north_train[,-1]
  ret_north_project = ret_north_project[,-1]
  
  ret_south_train = ret_south_train[,-1]
  ret_south_test = ret_south_test[,-1]
  ret_south_project = ret_south_project[,-1]
  
  colnames(ret_north_test) = models
  colnames(ret_north_train) = models
  colnames(ret_south_train) = models
  colnames(ret_south_test) = models
  colnames(ret_south_project) = models
  colnames(ret_north_project) = models
  
  print(ncol(ret_north_project))
  
  fwrite(ret_north_train,output[1])
  fwrite(ret_north_test,output[2])
  fwrite(ret_north_project,output[3])
  
  fwrite(ret_south_train,output[4])
  fwrite(ret_south_test,output[5])
  fwrite(ret_south_project,output[6])
  
  
  ######## project cmip6 ssp585
  
  pattern1 = rep('hist_ssp585',8)
  
  source('/home/share/R_project/xinjiang_vapor/predic_tws_model_cmip6.R')
  
  
  ret_north_train = 1
  ret_north_test = 1
  ret_north_project = 1

  ret_south_train = 1
  ret_south_test = 1
  ret_south_project = 1

  
  output = 'simu_cmip6_tws'
  dir.create(output)
  output = paste0(output,'/',pattern1[1])
  dir.create(output)
  
  filesname = paste0(c('north_train','north_test','north_project',
                       'south_train','south_test','south_project'),'.csv')
  output = paste0(output,'/',filesname)
  
  
  for(i in 1:8){
    ret_box = predic_tws_model_cmip6(models[i],pattern1[i])
    
    ret_north = ret_box[[1]]
    ret_south = ret_box[[2]]
    
    
    ret_north_train = cbind(ret_north_train,
                            ret_north[[1]])
    ret_north_test = cbind(ret_north_test,
                           ret_north[[2]])
    ret_north_project = cbind(ret_north_project,
                              ret_north[[3]])
    
    ret_south_train = cbind(ret_south_train,
                            ret_south[[1]])
    ret_south_test = cbind(ret_south_test,
                           ret_south[[2]])
    ret_south_project = cbind(ret_south_project,
                              ret_south[[3]])
    
  }
  ret_north_test = ret_north_test[,-1]
  ret_north_train = ret_north_train[,-1]
  ret_north_project = ret_north_project[,-1]
  
  ret_south_train = ret_south_train[,-1]
  ret_south_test = ret_south_test[,-1]
  ret_south_project = ret_south_project[,-1]
  
  colnames(ret_north_test) = models
  colnames(ret_north_train) = models
  colnames(ret_south_train) = models
  colnames(ret_south_test) = models
  colnames(ret_south_project) = models
  colnames(ret_north_project) = models
  
  fwrite(ret_north_train,output[1])
  fwrite(ret_north_test,output[2])
  fwrite(ret_north_project,output[3])
  
  fwrite(ret_south_train,output[4])
  fwrite(ret_south_test,output[5])
  fwrite(ret_south_project,output[6])
  
  
}
outter_re_order_cmip6_ep_sum<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/re_order_cmip6_ep_sum.R')
  mode = c('hist_ssp245','hist_ssp585')
  lapply(mode,re_order_cmip6_ep_sum)
}
pev_season_analysis<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  source('/home/share/R_project/xinjiang_vapor/trend_index.R')
  era5 = data_management(mode = 'era5_tevapor')
  
  era5_li = as.list(era5)
  era5_mean_ext<-function(x){
    xmean = cellStats(x,'mean')
    return(xmean)
  }
  
  
  era5_mean = lapply(era5_li,era5_mean_ext)
  era5_mean = do.call('c',era5_mean)
  era5_mean = -1*era5_mean*1000
  
  eva_mon = matrix(era5_mean,nrow = 12)
  
  mon_mean_fun<-function(x){
    xm = mean(x,na.rm = T)
    return(xm)
  }
  
  eva_mon_pattern = apply(eva_mon,1,mon_mean_fun)
  
  
}
pl_contr_traj<-function(
  
){
  # import contribution
  
  input_contr = 'analysis_output/contr_in_source_variance_new.csv'
  contr_full = fread(input_contr)
  contr_full = as.data.frame(contr_full)
  sou_names = contr_full[,1]
  contr_full = contr_full[,-1]
  
  mon_analysis<-function(x){
    
    xm = matrix(x,nrow = 12)
    mean_fun<-function(x){
      xm = mean(x,na.rm = T)
      return(xm)
    }
    max_fun <-function(x){
      xm = max(x,na.rm = T)
      return(xm)
    }
    
    min_fun <-function(x){
      xm = min(x,na.rm = T)
      return(xm)
    }
    
    xmean = apply(xm,1,mean_fun)
    xmax = apply(xm,1,max_fun)
    xmin = apply(xm,1,min_fun)
    
    ret = data.frame(xmean,xmax,xmin)
    return(ret)
  }
  
  mon_contr = apply(contr_full,1,mon_analysis)
  
  mon_contrb_mean = 1
  mon_contrb_max = 1
  mon_contrb_min = 1
  for(i in 1:length(mon_contr)){
    tmp = mon_contr[[i]]
    tmp1 = data.frame(xmean = tmp[,1],
                      sou_name = sou_names[i])
    tmp2 = data.frame(xmax = tmp[,2],
                      sou_name = sou_names[i])
    tmp3 = data.frame(xmin = tmp[,3],
                      sou_name = sou_names[i])
    
    mon_contrb_mean = rbind(mon_contrb_mean,tmp1)
    mon_contrb_max = rbind(mon_contrb_max,tmp2)
    mon_contrb_min = rbind(mon_contrb_min,tmp3)
  }
  mon_contrb_mean = mon_contrb_mean[-1,]
  mon_contrb_max = mon_contrb_max[-1,]
  mon_contrb_min = mon_contrb_min[-1,]
  
  
  xjid = which(mon_contrb_mean$sou_names =='xj')
  
  mon_contrb_mean$xmean[xjid] = -1*mon_contrb_mean$xmean[xjid]
  mon_contrb_max$xmax[xjid] = -1*mon_contrb_max$xmax[xjid]
  mon_contrb_min$xmin[xjid] = -1*mon_contrb_min$xmin[xjid]  
  
  
  mon = c('JAN','FEB','MAR','APR',
          'MAY','JUN','JUL','AUG',
          "SEP",'OCT','NOV','DEC')
  
  mon = factor(mon,levels = mon)
  
  mon_contrb_mean$mon = mon
  mon_contrb_max$mon = mon
  mon_contrb_min$mon = mon
  
  
  mon_contrb_mean$type = 'Mean'
  mon_contrb_max$type = "Max"
  mon_contrb_min$type = 'Min'
  
  colnames(mon_contrb_mean) = c('value','sou_names','mon','type')
  colnames(mon_contrb_max) = c('value','sou_names','mon','type')
  colnames(mon_contrb_min) = c('value','sou_names','mon','type')
  
  bar_df = rbind(mon_contrb_mean,
                 mon_contrb_max,
                 mon_contrb_min)
  
  bar_df$sou_names = factor(bar_df$sou_names,levels = sou_names )
  pbar = ggplot()+
    geom_bar(data = bar_df,aes(x = mon,y = value,fill = sou_names),
             stat = 'identity',position = 'stack',width = 0.5)+
    coord_flip()+
    facet_wrap(~type,ncol = 3)+
    theme_bw()+
    theme(
      panel.background = element_rect(fill = 'transparent'),
      axis.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      axis.title.x = element_text(color = 'black',size = 14,face = 'bold',hjust = 0.5),
      axis.title.y= element_blank(),
      legend.position = 'none',
      legend.direction = 'horizontal',
      legend.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      legend.title = element_text(color = 'black',size = 14, face = 'bold',hjust = 0.5),
      strip.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      plot.margin = unit('cm',c(0,0,1,0))
    )+
    guides(fill = guide_legend(nrow = 1))+
    #xlab('Date (month)')+
    ylab('Contribution rates')
    
  pbar
  
  # import traj 
  source('/home/share/R_project/xinjiang_vapor/traj_import.R')
  traj = traj_import()
  traj = do.call('rbind',traj)
  
  traj_dateid = traj %>%
    group_by(uni_id)%>%
    mutate(dateid = row_number())
  
  traj$dateid = traj_dateid$dateid 
  
  traj<<- traj
  
  con_mon_mean <- function(x){
    ids = which(traj$sou_mon == x)
    
    df_full = traj[ids,]
    id1 = which(!is.na(df_full$contr_rates))
    xid = substr(x,1,2)
    
    print(x)
    contr_df = df_full[id1,]
    loc1 = contr_df[,1:2]
    if(xid == 'po'){
     re = which(loc1$long < (-100))
     loc1 = loc1[re,]
     contr_df = contr_df[re,]
     print(nrow(loc1))
    }
    
    
    if(nrow(loc1)<5){
      cl = 1:nrow(loc1)
      clm = 1:nrow(loc1)
    }else{
      cl = kmeans(loc1,5)
      cl = cl$cluster
      clm = 1:5
    }
   
    contr_df$cluster = cl
    
   
    cl_li = list()
    #sum_contr_rates =1
    for(j in 1:length(unique(cl))){
      idt = which(contr_df$cluster == clm[j])
      tmpdfs = as.data.frame(contr_df[idt,])
      cl_li = c(cl_li,list(tmpdfs))
    }
    cl_li <<- cl_li
    df_full<<-df_full
    
    cal_mean_route <- function(x){
      library(dplyr)
    
      mean_fun2 <-function(x){
        xm = mean(x,na.rm = T)
        return(xm)
      }
      ids = which(df_full$uni_id %in% x$uni_id)
      
      trajtmp = df_full[ids,]
      trajret = data.frame(
        long = aggregate(trajtmp$long,list(trajtmp$dateid),mean)[,2],
        lat = aggregate(trajtmp$lat,list(trajtmp$dateid),mean)[,2],
        height = aggregate(trajtmp$height,list(trajtmp$dateid),mean)[,2],
        sou_mon = unique(trajtmp$sou_mon),
        source_name = unique(trajtmp$source_name),
        cluster = unique(x$cluster),
        mon = unique(x$mon)
      )
      return(trajret)
    }
    
    cl_df = lapply(cl_li,cal_mean_route)
    cl_df = do.call(rbind,cl_df)
    
    cl_df$uni_id2 = paste0(cl_df$sou_mon,'_',cl_df$cluster)
  
    return(cl_df)
  }
  
  mean_traj_mon = lapply(unique(traj$sou_mon),con_mon_mean)
  traj1 = do.call(rbind,mean_traj_mon)
  
  world = shp_management('world')
  xj = shp_management('xinjiang')
  
  world = crop(world,extent(-180,180,0,90))
  
  ptraj = ggplot()+
    geom_polygon(data = world,aes(x = long,y = lat,group = group),fill = 'transparent',color = 'black')+
    geom_polygon(data = xj,aes(x = long,y = lat,group = group),fill = 'transparent',color = 'black')+
    #geom_point(data = traj2,aes(x = long,y = lat,color = source_name),alpha= 0.4)
    geom_path(data = traj1,aes(x = long,y = lat,color = source_name,group = uni_id2))+
    #facet_wrap(~mon,nrow = 3)+
    #scale_color_npg()+
    theme_bw()+
    theme(
      panel.background = element_rect(fill = 'transparent'),
      axis.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      axis.title = element_text(color = 'black',size = 14,face = 'bold',hjust = 0.5),
      legend.position = 'none',
      legend.direction = 'horizontal',
      legend.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      legend.title = element_text(color = 'black',size = 14, face = 'bold',hjust = 0.5),
      strip.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5)
    )+
    guides(color = guide_legend(nrow = 1))+
    xlab('Longitude')+
    ylab('Latitude')
  
  # p var analysis 
  
  library(data.table)
  source('/home/share/R_project/xinjiang_vapor/trend_index.R')
  source('/home/share/R_project/xinjiang_vapor/stand_fun.R')
  contr = fread('analysis_output/contr_in_source_variance_new.csv')
  source('/home/share/R_project/xinjiang_vapor/stand_fun.R')
  sou_name = contr[,1]
  contr = contr[,-1]  
  sum_fun<-function(x){
    x = sum(x,na.rm = T)
  }
  
  contr_sum = apply(contr,2,sum_fun)
  
  contr_sum = as.numeric(contr_sum)
  contr_sum_t = trend_index(contr_sum,c(2003,1),12)
  
  # gpcc 
  source('/home/share/R_project/xinjiang_vapor/gpcc_pr_in_xinjiang.R')
  gpcc_trend = gpcc_pr_in_xinjiang()
  
  # gws
  source('/home/share/R_project/xinjiang_vapor/gws_in_xinjiang.R')
  gws_trend = gws_in_xinjiang()
  
  
  contr_sums = stand_fun(contr_sum_t)
  gpcc_s = stand_fun(gpcc_trend)
  tws_s = stand_fun(gws_trend)
  tws_s = c(tws_s,rep(NA,6))
  date = seq(as.Date('2003-07-01'),
             as.Date('2017-06-01'),
             '1 month')
  
  linedf = data.frame(date,CONTR = contr_sums,PR=gpcc_s,TWS=tws_s)
  linedfm = melt(linedf,'date')
  
  pline = ggplot()+
    geom_line(data = linedfm,aes(x = date,y = value,color = variable),size = 1)+
    scale_color_npg()+
    theme_bw()+
    theme(
      panel.background = element_rect(fill = 'transparent'),
      axis.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      axis.title = element_text(color = 'black',size = 14,face = 'bold',hjust = 0.5),
      legend.position = 'none',
      legend.direction = 'horizontal',
      legend.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      legend.title = element_text(color = 'black',size = 14, face = 'bold',hjust = 0.5),
      strip.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5)
    )+
    guides(color = guide_legend(nrow = 1))+
    xlab('Date')+
    ylab('Indices')
  
  pc = plot_grid(ptraj,pline,align = 'v',axis = 'lr',ncol = 1,
                 rel_widths = 1,rel_heights = 1)
  pbar = ggplot()+
    geom_bar(data = bar_df,aes(x = mon,y = value,fill = sou_names),
             stat = 'identity',position = 'stack',width = 0.5)+
    coord_flip()+
    facet_wrap(~type,ncol = 3)+
    theme_bw()+
    theme(
      panel.background = element_rect(fill = 'transparent'),
      axis.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      axis.title.x = element_text(color = 'black',size = 14,face = 'bold',hjust = 0.5),
      axis.title.y= element_blank(),
      legend.position = 'none',
      legend.direction = 'horizontal',
      legend.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      legend.title = element_text(color = 'black',size = 14, face = 'bold',hjust = 0.5),
      strip.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5)
    )+
    guides(fill = guide_legend(nrow = 1))+
    #xlab('Date (month)')+
    ylab('Contribution rates')
  pc2 = plot_grid(pc,pbar,align = 'h',nrow = 1,axis = 'none',
                  rel_heights = c(1,1),rel_widths = c(10,7))
  
  leg1 = get_legend(pline+theme(legend.position = 'bottom'))
  leg2 = get_legend(ptraj+theme(legend.position = 'bottom'))
  leg3 = get_legend(pbar+theme(legend.position = 'bottom'))
  
  leg1 = as_ggplot(leg1)
  leg2 = as_ggplot(leg2)
  leg3 = as_ggplot(leg3)
  
  png()
  
  png('plot/pc_traj2.png',
      height = 30,
      width = 30,
      units = 'cm',
      res = 800)
  print(pc2)
  dev.off()
  
  png('plot/pc_traj2_leg1.png',
      height = 30,
      width = 30,
      units = 'cm',
      res = 800)
  print(leg1)
  dev.off()
  
  png('plot/pc_traj2_leg2.png',
      height = 30,
      width = 30,
      units = 'cm',
      res = 800)
  print(leg2)
  dev.off()
  
  png('plot/pc_traj2_leg3.png',
      height = 30,
      width = 30,
      units = 'cm',
      res = 800)
  print(leg3)
  dev.off()
  
}

  
plot_all_particles_traj<-function(
  input_data
){
  input ="alldates_output.csv"
  input = paste0(input_data,'/',input)
  
  mat = fread(input)
  df = as.data.frame(mat)
  
  shp = shapefile('/usr/local/flexpart_bk1/shp/world.shp')
  df = d1
  df$epd= c(0,eqd)
  df$cuts = cut(df$epd,breaks=c(-50,0,120))
  
  p = ggplot()+
    geom_polygon(data = shp,aes(x = long,y = lat,group = group),fill = 'grey50',color = 'transparent',
                 size = 0.5)+
    geom_path(data = df,aes(x = long, y = lat,group = type,color = varep))+
    geom_point(data = df,aes(x = long,y = lat,group = type,color = varep))+
    scale_fill_discrete(palette= "Spectral")+
    
    xlab('Longitude')+
    ylab('Latitude')
  
  
  
  png('test2.png',
      height = 22,
      width = 30,
      units = 'cm',
      res = 800)
  print(p)
  dev.off()
}
plot3d_traj<-function(
  
){
  # input dem
  
  dem = data_management('global_dem')
  
  dem1 = crop(dem,extent(0,180,-90,90))
  dem2 = crop(dem,extent(180,360,-90,90))
  extent(dem2) = extent(-180,0,-90,90)
  dem = merge(dem2,dem1)
  
  dem = crop(dem,extent(-180,180,0,90))
  
  library(rayshader)
  library(dplyr)
  library(plotly)
  
  demdf = raster_to_matrix(dem)
  
  # input traj 
  library(data.table)
  traj_df = fread('analysis_output/monthly_kmeans_traj_rbind.csv')
  traj_df = as.data.frame(traj_df)
  
  library(RColorBrewer)
  library(ggplot2)
  mypal = colorRampPalette(brewer.pal(10,'Spectral'))(length(unique(traj_df$group)))
  
  demxy = as.data.frame(demdf,xy = T)
  long1 = sort(as.numeric(unique(demxy$x)))
  lat1 = sort(as.numeric(unique(demxy$y)))
  
  fig1 = #traj_df %>%
    #group_by(group,long) %>%
    #group_by(group,lat) %>%
    #group_by(group,height) %>%
    plot_ly(data = traj_df,x = ~ lat,
            y = ~ long,
            z = ~ height,
            type = 'scatter3d',
            #type = 'scatter',
            mode = 'lines',
            color = ~ group,
            group = ~group ,
            line = list(color = mypal,width = 1)) %>%
    #plot_ly()%>%
    add_surface(x = ~ lat1, y = ~long1, z = ~demdf)
  
  #
  #x = as.numeric(demdf$x)
  #y = as.numeric(demdf$y)
  z = as.matrix(demdf$z,nrow = 1)
  fig2 = 
    plot_ly(#x = ~x,
            #y = ~y,
            #z = ~z,
            type = 'surface') %>%
    add_surface(z = ~z) %>%
    layout(
      scene = list(
        xaxis = list(nticks = 20),
        zaxis = list(nticks = 4),
        camera = list(eye = list(x = 0, y = -1, z = 0.5)),
        aspectratio = list(x = .9, y = .8, z = 0.2)))


  
}
predic_tws_model_cmip6 <-function(
  model_name,
  pattern 
){
  i = 1:2
  #i = 2
  model_name <<- model_name
  pattern <<- pattern 
  
  predict_model_mean <-function(i){
    files_moun = c('north_moun','south_moun')
    files_jishui = c('north_jishui','south_jishui')
    
    # input conveid vapor
    con_amount_moun  = paste0('convey_amount_based_on_cmip6_in_target/',
                              pattern,'/',
                              'mean/',
                              model_name,
                              '/',
                              files_moun[i],
                              '.csv')
    con_amount_jishui = paste0('convey_amount_based_on_cmip6_in_target/',
                               pattern,'/',
                               'mean/',
                               model_name,
                               '/',
                               files_jishui[i],
                               '.csv')
    con_amount_moun = as.data.frame(fread(con_amount_moun))
    con_amount_jishui = as.data.frame(fread(con_amount_jishui))
    
    if(ncol(con_amount_moun) !=12){
      colnames(con_amount_moun) = paste0('pr_mount',1:11)
    }else{
      colnames(con_amount_moun) = paste0('pr_mount',1:12)
    }
    
    if(ncol(con_amount_jishui) !=12){
      colnames(con_amount_jishui) = paste0('pr_jishui',1:11)  
    }else{
      colnames(con_amount_jishui) = paste0('pr_jishui',1:12)  
    }
    
    
    
    con_moun_sum = apply(con_amount_moun,2,sum)
    con_jishui_sum = apply(con_amount_jishui,2,sum)
    
    id_re_moun = as.numeric(which(con_moun_sum < 5000))
    id_re_jishui = as.numeric(which(con_jishui_sum < 5000))
    
    print(id_re_moun)
    print(id_re_jishui)
    if(length(id_re_moun)>0){
      con_amount_moun = con_amount_moun[,-id_re_moun]
    }
    if(length(id_re_jishui)>0){
      con_amount_jishui = con_amount_jishui[,-id_re_jishui]
    }
    
    # import evaporation in mount and palin
    eva_input = 'eva_in_target_cmip6/'
    eva_input = paste0(eva_input,pattern)
    eva_input = paste0(eva_input,'/',model_name)
    
    eva_input_moun = paste0(eva_input,'/',files_moun[i],'.csv')
    eva_input_jishui = paste0(eva_input,'/',files_jishui[i],'.csv')
   
    eva_moun = as.data.frame(fread(eva_input_moun))
    eva_jishui = as.data.frame(fread(eva_input_jishui))
    
    eva_moun = eva_moun*-1
    eva_jishui = eva_jishui *-1
    
    # import t in mountain
    t_input = 'temp_in_target_cmip6/'
    t_input = paste0(t_input,'/',pattern)
    t_input = paste0(t_input,'/',model_name)
    
    t_input_moun = paste0(t_input,'/',files_moun[i],'.csv')
    t_moun = as.data.frame(fread(t_input_moun))
    t_moun = as.numeric(t_moun[,1])
    t_moun = t_moun -273.15
    
    # import tws 
    input_tws = 'tws_in_target/'
    input_tws = paste0(input_tws,files_jishui[i],'.csv')
    
    tws_jishui = as.data.frame(fread(input_tws))
    
    stand_fun1 <-function(x){
      x= (x-mean(x))/(max(x)-min(x))
    }
    
    stand_fun2 <-function(x){
      x= (x)/(max(x)-min(x))
    }
    df = data.frame(
      tws = stand_fun2(tws_jishui[,1]),
      con_amount_moun[1:174,],
      con_amount_jishui[1:174,],
      eva_moun = eva_moun[1:174,],
      eva_jishui =eva_jishui[1:174,],
      t = t_moun[1:174]
    )
    df2 = df[,-1]
    
    
    df2 = apply(df2,2,stand_fun1)
    df = data.frame(tws = df$tws,
                    df2)
    
    df_project = data.frame(
      con_amount_moun[175:576,],
      con_amount_jishui[175:576,],
      eva_moun = eva_moun[175:576,],
      eva_jishui = eva_jishui[175:576,],
      t = t_moun[175:576]
    )
    
    df_project = apply(df_project,2,stand_fun1)
    
    #if(i ==2){
    #  df = data.frame(tws = df$tws,
                      #con_amount_moun[1:174,],
                      #eva_jishui = df$eva_jishui,
    #                  t = t_moun[1:174])
    #  df_project = data.frame(
    #    t = t_moun[175:576]
    #  )
    #  df_project$t = stand_fun1(df_project$t)
    #}
    
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws.R')
    ret = random_forest_model_tws(df,df_project)
  }
  print(model_name)
  ret_box = lapply(i,predict_model_mean)
  
  return(ret_box)
  
}
predict_model_based_era5_proj_by_cmip6_proj_trend <- function(
  
){
  
  # era5 model
  library(data.table)
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  source('/home/share/R_project/xinjiang_vapor/source_id_identify.R')
  
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:180,]
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:180,]
  
  sst_mean1 = 'era5_sst_mean/ato/region1/era5_sst_mean.csv'
  sst_mean3 = 'era5_sst_mean/ato/region3/era5_sst_mean.csv'
  
  sst1= as.data.frame(fread(sst_mean1))
  sst3 = as.data.frame(fread(sst_mean3))
  
  era5_sst = cbind(sst1,sst3)
  era5_sst = era5_sst[1:174,]
  era5_sst = as.matrix(era5_sst)
  
  era5_pme = pe_in_source[,c(5,7)] - pet_sum[,c(5,7)]
  era5_pme = as.matrix(era5_pme)
  era5_pme = era5_pme[1:174,]
  
  source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
  era5_sst = trend_fun(era5_sst)
  era5_pme = trend_fun(era5_pme)
  
  naid = which(is.na(era5_sst[,1]))
  era5_sst = era5_sst[-naid,]
  era5_pme = era5_pme[-naid,]
  
  # import tws
  input_tws = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws = fread(input_tws)
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  tws = as.data.frame(tws)
  tws = tws[,-1]
  twsdf = tws[,id_box]
  colnames(twsdf) = paste0('SW',1:10)
  twsdf <<- twsdf
  
  i = 1:ncol(twsdf)
  i <<- i
  era5_pme <<- era5_pme
  era5_sst <<- era5_sst
  
  # import pme1 pme3 cmip6
  input_sst = list.files('analysis_output/cmip6_by_model/sst',
                         full.names = T)
  input_pme = list.files('analysis_output/cmip6_by_model/pme_proj_trend',
                         full.names = T)
  
  sst = lapply(lapply(input_sst,fread),as.data.frame)
  pme = lapply(lapply(input_pme,fread),as.data.frame)
  
  sst_trend = sst
  pme_trend = pme
  #sst_trend = lapply(sst,trend_fun)
  #pme_trend = lapply(pme,trend_fun)
  
  sst1_ssp245 = sst_trend[[1]]
  sst1_ssp585 = sst_trend[[2]]
  sst3_ssp245 = sst_trend[[3]]
  sst3_ssp585 = sst_trend[[4]]
  
  pme1_ssp245 = pme_trend[[1]]
  pme1_ssp585 = pme_trend[[2]]
  pme3_ssp245 = pme_trend[[3]]
  pme3_ssp585 = pme_trend[[4]]
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(pme1_ssp245) = modelnames
  colnames(pme1_ssp585) = modelnames
  colnames(pme3_ssp245) = modelnames
  colnames(pme3_ssp585) = modelnames
  
  sst1_ssp245 <<- sst1_ssp245
  sst1_ssp585 <<- sst1_ssp585
  sst3_ssp245 <<- sst3_ssp245
  sst3_ssp585 <<- sst3_ssp585
  
  pme1_sst245 <<- pme1_ssp245
  pme3_ssp245 <<- pme3_ssp245
  pme1_ssp585 <<- pme1_ssp585
  pme3_ssp585 <<- pme3_ssp585
  
  
  source('/home/share/R_project/xinjiang_vapor/sub_train_based_era5_cmip6_ssp245_proj_trend.R')
  source('/home/share/R_project/xinjiang_vapor/sub_train_based_era5_cmip6_ssp585_proj_trend.R')
  
  ret245 = sub_train_based_era5_cmip6_ssp245_proj_trend()
  ret585 = sub_train_based_era5_cmip6_ssp585_proj_trend()
  
  ret245mean = ret245[[1]]
  ret245maxmin = ret245[[2]]
  
  path = 'analysis_output/fig4/project_tws_proj_trend'
  dir.create(path)
  output_ret245mean = paste0(path,'/tws245_mean.csv')
  output_ret245maxmin = paste0(path,'/tws245_maxmin.csv')
  
  fwrite(ret245mean,output_ret245mean)
  fwrite(ret245maxmin,output_ret245maxmin)
  
  ret585mean = ret585[[1]]
  ret585maxmin = ret585[[2]]
  
  path = 'analysis_output/fig4/project_tws_proj_trend'
  dir.create(path)
  output_ret585mean = paste0(path,'/tws585_mean.csv')
  output_ret585maxmin = paste0(path,'/tws585_maxmin.csv')
  
  fwrite(ret585mean,output_ret585mean)
  fwrite(ret585maxmin,output_ret585maxmin)
  
  
}
predict_model_based_era5_proj_by_cmip6_proj <- function(
  
){
  
  # era5 model
  library(data.table)
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  source('/home/share/R_project/xinjiang_vapor/source_id_identify.R')
  
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:180,]
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:180,]
  
  sst_mean1 = 'era5_sst_mean/ato/region1/era5_sst_mean.csv'
  sst_mean3 = 'era5_sst_mean/ato/region3/era5_sst_mean.csv'
  
  sst1= as.data.frame(fread(sst_mean1))
  sst3 = as.data.frame(fread(sst_mean3))
  
  era5_sst = cbind(sst1,sst3)
  era5_sst = era5_sst[1:174,]
  era5_sst = as.matrix(era5_sst)
  
  era5_pme = pe_in_source[,c(5,7)] - pet_sum[,c(5,7)]
  era5_pme = as.matrix(era5_pme)
  era5_pme = era5_pme[1:174,]
  
  source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
  era5_sst = trend_fun(era5_sst)
  era5_pme = trend_fun(era5_pme)
  
  naid = which(is.na(era5_sst[,1]))
  era5_sst = era5_sst[-naid,]
  era5_pme = era5_pme[-naid,]
  
  # import tws
  input_tws = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws = fread(input_tws)
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  tws = as.data.frame(tws)
  tws = tws[,-1]
  twsdf = tws[,id_box]
  colnames(twsdf) = paste0('SW',1:10)
  twsdf <<- twsdf
  
  i = 1:ncol(twsdf)
  i <<- i
  era5_pme <<- era5_pme
  era5_sst <<- era5_sst
  
  # import pme1 pme3 cmip6
  input_sst = list.files('analysis_output/cmip6_by_model/sst',
                         full.names = T)
  input_pme = list.files('analysis_output/cmip6_by_model/pme_proj',
                         full.names = T)
  
  sst = lapply(lapply(input_sst,fread),as.data.frame)
  pme = lapply(lapply(input_pme,fread),as.data.frame)
  
  sst_trend = sst
  pme_trend = pme
  #sst_trend = lapply(sst,trend_fun)
  #pme_trend = lapply(pme,trend_fun)
  
  sst1_ssp245 = sst_trend[[1]]
  sst1_ssp585 = sst_trend[[2]]
  sst3_ssp245 = sst_trend[[3]]
  sst3_ssp585 = sst_trend[[4]]
  
  pme1_ssp245 = pme_trend[[1]]
  pme1_ssp585 = pme_trend[[2]]
  pme3_ssp245 = pme_trend[[3]]
  pme3_ssp585 = pme_trend[[4]]
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(pme1_ssp245) = modelnames
  colnames(pme1_ssp585) = modelnames
  colnames(pme3_ssp245) = modelnames
  colnames(pme3_ssp585) = modelnames
  
  sst1_ssp245 <<- sst1_ssp245
  sst1_ssp585 <<- sst1_ssp585
  sst3_ssp245 <<- sst3_ssp245
  sst3_ssp585 <<- sst3_ssp585
  
  pme1_sst245 <<- pme1_ssp245
  pme3_ssp245 <<- pme3_ssp245
  pme1_ssp585 <<- pme1_ssp585
  pme3_ssp585 <<- pme3_ssp585
  
  
  source('/home/share/R_project/xinjiang_vapor/sub_train_based_era5_cmip6_ssp245_proj.R')
  source('/home/share/R_project/xinjiang_vapor/sub_train_based_era5_cmip6_ssp585_proj.R')
  
  ret245 = sub_train_based_era5_cmip6_ssp245_proj()
  ret585 = sub_train_based_era5_cmip6_ssp585_proj()
  
  ret245mean = ret245[[1]]
  ret245maxmin = ret245[[2]]
  
  path = 'analysis_output/fig4/project_tws_proj'
  dir.create(path)
  output_ret245mean = paste0(path,'/tws245_mean.csv')
  output_ret245maxmin = paste0(path,'/tws245_maxmin.csv')
  
  fwrite(ret245mean,output_ret245mean)
  fwrite(ret245maxmin,output_ret245maxmin)
  
  ret585mean = ret585[[1]]
  ret585maxmin = ret585[[2]]
  
  path = 'analysis_output/fig4/project_tws_proj'
  dir.create(path)
  output_ret585mean = paste0(path,'/tws585_mean.csv')
  output_ret585maxmin = paste0(path,'/tws585_maxmin.csv')
  
  fwrite(ret585mean,output_ret585mean)
  fwrite(ret585maxmin,output_ret585maxmin)
  
  
}
predict_model_based_era5_proj_by_cmip6 <- function(
  
){
  
  # era5 model
  library(data.table)
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  source('/home/share/R_project/xinjiang_vapor/source_id_identify.R')
  
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:180,]
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:180,]
  
  sst_mean1 = 'era5_sst_mean/ato/region1/era5_sst_mean.csv'
  sst_mean3 = 'era5_sst_mean/ato/region3/era5_sst_mean.csv'
  
  sst1= as.data.frame(fread(sst_mean1))
  sst3 = as.data.frame(fread(sst_mean3))
  
  era5_sst = cbind(sst1,sst3)
  era5_sst = era5_sst[1:174,]
  era5_sst = as.matrix(era5_sst)
  
  era5_pme = pe_in_source[,c(5,7)] - pet_sum[,c(5,7)]
  era5_pme = as.matrix(era5_pme)
  era5_pme = era5_pme[1:174,]
  
  source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
  era5_sst = trend_fun(era5_sst)
  era5_pme = trend_fun(era5_pme)
  
  naid = which(is.na(era5_sst[,1]))
  era5_sst = era5_sst[-naid,]
  era5_pme = era5_pme[-naid,]
  
  # import tws
  input_tws = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws = fread(input_tws)
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  tws = as.data.frame(tws)
  tws = tws[,-1]
  twsdf = tws[,id_box]
  colnames(twsdf) = paste0('SW',1:10)
  twsdf <<- twsdf
  
  i = 1:ncol(twsdf)
  i <<- i
  era5_pme <<- era5_pme
  era5_sst <<- era5_sst
  
  # import pme1 pme3 cmip6
  input_sst = list.files('analysis_output/cmip6_by_model/sst',
                         full.names = T)
  input_pme = list.files('analysis_output/cmip6_by_model/pme',
                         full.names = T)
  
  
  
  sst = lapply(lapply(input_sst,fread),as.data.frame)
  pme = lapply(lapply(input_pme,fread),as.data.frame)
  
  sst_trend = sst
  pme_trend = pme
  #sst_trend = lapply(sst,trend_fun)
  #pme_trend = lapply(pme,trend_fun)
  
  sst1_ssp245 = sst_trend[[1]]
  sst1_ssp585 = sst_trend[[2]]
  sst3_ssp245 = sst_trend[[3]]
  sst3_ssp585 = sst_trend[[4]]
  
  pme1_ssp245 = pme_trend[[1]]
  pme1_ssp585 = pme_trend[[2]]
  pme3_ssp245 = pme_trend[[3]]
  pme3_ssp585 = pme_trend[[4]]
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(sst1_ssp245) = modelnames
  colnames(sst1_ssp585) = modelnames
  colnames(sst3_ssp245) = modelnames
  colnames(sst3_ssp585) = modelnames
  
  colnames(pme1_ssp245) = modelnames
  colnames(pme1_ssp585) = modelnames
  colnames(pme3_ssp245) = modelnames
  colnames(pme3_ssp585) = modelnames
  
  sst1_ssp245 <<- sst1_ssp245
  sst1_ssp585 <<- sst1_ssp585
  sst3_ssp245 <<- sst3_ssp245
  sst3_ssp585 <<- sst3_ssp585
  
  pme1_sst245 <<- pme1_ssp245
  pme3_ssp245 <<- pme3_ssp245
  pme1_ssp585 <<- pme1_ssp585
  pme3_ssp585 <<- pme3_ssp585
  
  source('/home/share/R_project/xinjiang_vapor/sub_train_based_era5_cmip6_ssp245.R')
  source('/home/share/R_project/xinjiang_vapor/sub_train_based_era5_cmip6_ssp585.R')
  
  ret245 = sub_train_based_era5_cmip6_ssp245()
  ret585 = sub_train_based_era5_cmip6_ssp585()
  
  ret245mean = ret245[[1]]
  ret245maxmin = ret245[[2]]
  
  path = 'analysis_output/fig4/project_tws'
  dir.create(path)
  output_ret245mean = paste0(path,'/tws245_mean.csv')
  output_ret245maxmin = paste0(path,'/tws245_maxmin.csv')
  
  fwrite(ret245mean,output_ret245mean)
  fwrite(ret245maxmin,output_ret245maxmin)
  
  ret585mean = ret585[[1]]
  ret585maxmin = ret585[[2]]
  
  path = 'analysis_output/fig4/project_tws'
  dir.create(path)
  output_ret585mean = paste0(path,'/tws585_mean.csv')
  output_ret585maxmin = paste0(path,'/tws585_maxmin.csv')
  
  fwrite(ret585mean,output_ret585mean)
  fwrite(ret585maxmin,output_ret585maxmin)
  
  
}
predict_model_based_on_convey<-function(
  
){
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  gpcc_pr = paste0('gpcc_pr_in_target/',files,'.csv')
  era5_pr = paste0('era5_pr_in_target/',files,'.csv')
  
  con_amount_input = paste0('convey_amount_based_era5_in_target')
  
  
  # 2003-2013
  # 2013-2017
  i = 1:4
  predict_model_mean<-function(i){
    files = c('north_moun','north_jishui','south_moun','south_jishui')
    gpcc_pr = paste0('gpcc_pr_in_target/',files[i],'.csv')
    print(gpcc_pr)
    era5_pr = paste0('era5_pr_in_target/',files[i],'.csv')
    con_amount_input = paste0('convey_amount_based_era5_in_target/mean/',
                              files[i],'.csv')
    
    gpcc = fread(gpcc_pr)
    con_amount = fread(con_amount_input)
    
    colnames(gpcc) = 'gpcc_pr'
    colnames(con_amount) = paste0('pr',1:12)
    
    gpcc = as.data.frame(gpcc)
    con_amount = as.data.frame(con_amount)
    
    con_sum = apply(con_amount,2,sum)
    id_re = as.numeric(which(con_sum <100))
    if(length(id_re)>0){
      con_amount = con_amount[,-id_re]  
    }
    
    df = data.frame(gpcc,con_amount)
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_test.R')
    #pre_fun  = lm(gpcc_pr ~ ., data= df)
    
    #print(id_re)
    #fit = pre_fun$fitted.values
    ret = random_forest_model_test(df)
    #return(cbind(gpcc$gpcc_pr,fit))
    return(ret)
  }
  
  ret_box = lapply(i,predict_model_mean)
  
  
  trend_li_fun<- function(x){
    txb = 1
    for(i in 1:ncol(x)){
      tx = ts(x[,i],start = c(2003,1),frequency = 12)
      tx = decompose(tx)$trend
      txb = cbind(txb,tx)
    }
    txb = txb[,-1]
    return(txb)
  }
  
  rts  = lapply(ret_box,trend_li_fun)
  naid = which(is.na(rts[[1]][,1]))
  
  rts_north_moun = ret_box[[1]]
  rts_north_jishui = ret_box[[2]]
  rts_south_moun = ret_box[[3]]
  rts_south_jishui = ret_box[[4]]
  
  date = seq(as.Date('2003-01-01'),as.Date('2017-12-01'),'1 month')
  date = date[1:(nrow(rts_north_jishui))]
  rts_df1 = data.frame(date = date,
                        gpcc = rts_north_moun[,1],
                       simu = rts_north_moun[,2],
                       type= 'North_mountain')
  rts_df2 = data.frame(
    date = date,
    gpcc = rts_north_jishui[,1],
    simu = rts_north_jishui[,2],
    type = 'North_plain'
  )
  
  rts_df3 = data.frame(
    date = date,
    gpcc = rts_south_moun[,1],
    simu = rts_south_moun[,2],
    type = 'South_mountain'
  )
  
  rts_df4 = data.frame(
    date = date,
    gpcc = rts_south_jishui[,1],
    simu = rts_south_jishui[,2],
    type = 'South_plain'
  )
  
  rts_df1 = rts_df1[-naid,]
  rts_df2 = rts_df2[-naid,]
  rts_df3 = rts_df3[-naid,]
  rts_df4 = rts_df4[-naid,]
  
  df = rbind(rts_df1,rts_df2,rts_df3,rts_df4)
  pbar = ggplot()+
    geom_point(data = df,aes(x = gpcc,y =  simu),color = 'blue',
               size = 1)+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
  
  rts_df1 = reshape2::melt(rts_df1,c('date','type'))
  rts_df2 = reshape2::melt(rts_df2,c('date','type'))
  rts_df3 = reshape2::melt(rts_df3,c('date','type'))
  rts_df4 = reshape2::melt(rts_df4,c('date','type'))
  
  library(ggplot2)
  df = rbind(rts_df1,rts_df2,rts_df3,rts_df4)
  
  p = ggplot()+
    geom_line(data = df,aes(x = date,y = value,color = variable))+
    scale_color_manual(values = c('blue','green'))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
   
  
  
}
predict_snowmelt_based_on_pr_e <-function(
  
){
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  snowm = paste0('snowmelt_in_target/',files,'csv')
  tmean = paste0('temperature_in_target/',files,'.csv')
  
  
  #gpcc_pr = paste0('gpcc_pr_in_target/',files,'.csv')
  
  i = 1:2
  
  predict_model_mean <-function(i){
    files = c('north_moun','south_moun')
    snowm = paste0('snowmelt_in_target/',files,'.csv')
    tmean = paste0('temperature_in_target/',files,'.csv')
    
    con_amount_input = paste0('convey_amount_based_era5_in_target/mean/',
                              files[i],'.csv')
    snowm = fread(snowm[i])
    tmean = fread(tmean[i])
    con_amount = fread(con_amount_input)
    
    snowm = as.data.frame(snowm)
    tmean = as.data.frame(tmean)
    con_amount = as.data.frame(con_amount)
    
    colnames(snowm) = 'snowm' # jsut for model, means snowm
    colnames(tmean) = 'tmean'
    colnames(con_amount) = paste0('pr',1:12)
    
    con_sum = apply(con_amount,2,sum)
    id_re = as.numeric(which(con_sum <100))
    if(length(id_re)>0){
      con_amount = con_amount[,-id_re]  
    }
    
    df = data.frame(snowm,tmean,con_amount)
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_snowm.R')
    ret = random_forest_model_snowm(df)
    
    return(ret)
    
  }
  
  ret_box = lapply(i,predict_model_mean)
  
  trend_li_fun<- function(x){
    txb = 1
    for(i in 1:ncol(x)){
      tx = ts(x[,i],start = c(2003,1),frequency = 12)
      tx = decompose(tx)$trend
      txb = cbind(txb,tx)
    }
    txb = txb[,-1]
    return(txb)
  }
  
  rts  = lapply(ret_box,trend_li_fun)
  naid = which(is.na(rts[[1]][,1]))
  
  rts_north_moun = ret_box[[1]]
  rts_south_moun = ret_box[[2]]
  
  date = seq(as.Date('2003-01-01'),as.Date('2017-12-01'),'1 month')
  date = date[1:(nrow(rts_north_jishui))]
  
  rts_df1 = data.frame(date = date,
                       snowm = rts_north_moun[,1],
                       simu = rts_north_moun[,2],
                       type= 'North_mountain')
  rts_df2 = data.frame(
    date = date,
    snowm = rts_south_moun[,1],
    simu = rts_south_moun[,2],
    type = 'South_mountain'
  )
  
  rts_df1 = rts_df1[-naid,]
  rts_df2 = rts_df2[-naid,]
  
  df = rbind(rts_df1,rts_df2)
  
  
  output = 'simu_df_snowmelt'
  dir.create(output)
  output = paste0(output,c('/north_moun.csv','/south_moun.csv'))
  
  fwrite(rts_df1,output[1])
  fwrite(rts_df2,output[2])
  
  
  
  pbar = ggplot()+
    geom_point(data = df,aes(x = snowm,y =  simu),color = 'blue',
               size = 1)+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
  pbar
  
  
  
}
predict_tws_based_on_convey_eva<-function(
  
){
  i = 1:2
  
  predict_model_mean <-function(i){
    
    files_moun = c('north_moun','south_moun')
    files_jishui = c('north_jishui','south_jishui')
    
    # input conveid vapor
    con_amount_moun  = paste0('convey_amount_based_era5_eva_in_target/mean/',
                              files_moun[i],
                              '.csv')
    con_amount_jishui = paste0('convey_amount_based_era5_eva_in_target/mean/',
                               files_jishui[i],
                               '.csv')
    
    con_amount_moun = as.data.frame(fread(con_amount_moun))
    con_amount_jishui = as.data.frame(fread(con_amount_jishui))
    
    colnames(con_amount_moun) = paste0('pr_mount',1:12)
    colnames(con_amount_jishui) = paste0('pr_jishui',1:12)
    
    con_moun_sum = apply(con_amount_moun,2,sum)
    con_jishui_sum = apply(con_amount_jishui,2,sum)
    
    con_moun_sum = as.numeric(con_moun_sum)/180
    con_jishui_sum = as.numeric(con_jishui_sum)/180
    
    id_re_moun = as.numeric(which(con_moun_sum < 1000))
    id_re_jishui = as.numeric(which(con_jishui_sum < 1000))
    
    print(id_re_moun)
    print(id_re_jishui)
    if(length(id_re_moun)>0){
      con_amount_moun = con_amount_moun[,-id_re_moun]
    }
    if(length(id_re_jishui)>0){
      con_amount_jishui = con_amount_jishui[,-id_re_jishui]
    }
    
    # import evaporation in mount and palin
    eva_input = 'evaporation_in_target/'
    eva_input_moun = paste0(eva_input,files_moun[i],'.csv')
    eva_input_jishui = paste0(eva_input,files_jishui[i],'.csv')
    
    eva_moun = as.data.frame(fread(eva_input_moun))
    eva_jishui = as.data.frame(fread(eva_input_jishui))
    
    eva_moun = eva_moun *-1
    eva_jishui = eva_jishui *-1
    
    # import t in mountain
    t_input = 'temperature_in_target/'
    t_input_moun = paste0(t_input,files_moun[i],'.csv')
    t_moun = as.data.frame(fread(t_input_moun))
    t_moun = t_moun -273.15
    
    # import tws 
    input_tws = 'tws_in_target/'
    input_tws = paste0(input_tws,files_jishui[i],'.csv')
    
    tws_jishui = as.data.frame(fread(input_tws))
    
    stand_fun1 <-function(x){
      x= (x-mean(x))/(max(x)-min(x))
    }
    
    stand_fun2 <-function(x){
      x= (x)/(max(x)-min(x))
    }
    df = data.frame(
      tws = stand_fun2(tws_jishui[,1]),
      con_amount_moun[1:174,],
      con_amount_jishui[1:174,],
      eva_moun = eva_moun[1:174,],
      eva_jishui =eva_jishui[1:174,],
      t = t_moun[1:174,]
    )
    df2 = df[,-1]
    
    
    df2 = apply(df2,2,stand_fun1)
    df = data.frame(tws = df$tws,
                    df2)
    #if(i ==2){
    #  df = data.frame(tws = df$tws,
    #                  #con_amount_moun[1:174,],
    #                  #eva_jishui = df$eva_jishui,
    #                  t = t_moun[1:174,])
    #}
    
    
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws.R')
    ret = random_forest_model_tws(df)
    
  }
  
  ret_box = lapply(i,predict_model_mean)
  
  trend_li_fun<- function(x){
    txb = 1
    for(i in 1:ncol(x)){
      tx = ts(x[,i],start = c(2003,1),frequency = 12)
      tx = decompose(tx)$trend
      txb = cbind(txb,tx)
    }
    txb = txb[,-1]
    return(txb)
  }
  
  
  rts_north_jishui = ret_box[[1]][[1]]
  rts_south_jishui= ret_box[[2]][[1]]
  rts_north_jishui_test = ret_box[[1]][[2]]
  rts_south_jishui_test = ret_box[[2]][[2]]
  
  
  files = c('north_tws_train_mean.csv',
            'south_tws_train_mean.csv',
            'north_tws_test_mean.csv',
            'south_tws_test_mean.csv')
  
  
  output = paste0('output_simu_tws/',files)
  
  ret_box = list(rts_north_jishui,rts_south_jishui,
                 rts_north_jishui_test,rts_south_jishui_test)
  fwrite(ret_box[[1]],output[1])
  fwrite(ret_box[[2]],output[2])
  fwrite(ret_box[[3]],output[3])
  fwrite(ret_box[[4]],output[4])
  
  
  
  #rts  = lapply(ret_box,trend_li_fun)
  #naid = which(is.na(rts[[1]][,1]))
  
  #rts_north_jishui = rts[[1]]
  #rts_south_jishui= rts[[2]]
  #rts_north_jishui_test = rts[[3]]
  #rts_south_jishui_test = rts[[4]]
  
  date = seq(as.Date('2003-01-01'),as.Date('2017-12-01'),'1 month')
  date_train = date[1:121]
  date_test = date[122:174]
  
  rts_df1 = data.frame(date = date_train,
                       tws = rts_north_jishui[,1],
                       simu = rts_north_jishui[,2],
                       type= 'North_plain_train')
  rts_df2 = data.frame(
    date = date_train,
    tws = rts_south_jishui[,1],
    simu = rts_south_jishui[,2],
    type = 'South_plain_train'
  )
  
  rts_df3 = data.frame(date = date_test,
                       tws = rts_north_jishui_test[,1],
                       simu = rts_north_jishui_test[,2],
                       type= 'North_plain_test')
  rts_df4 = data.frame(
    date = date_test,
    tws = rts_south_jishui_test[,1],
    simu = rts_south_jishui_test[,2],
    type = 'South_plain_test'
  )
  
  #rts_df1 = rts_df1[-naid,]
  #rts_df2 = rts_df2[-naid,]
  
  df = rbind(rts_df1,rts_df2,
             rts_df3,rts_df4)
  
  pbar = ggplot()+
    geom_point(data = df,aes(x = tws,y =  simu),color = 'blue',
               size = 1)+
    geom_abline(data = df,aes(slope = 1,intercept = 0))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
  pbar
  
  
  dfm = melt(df,c('date','type'))
  pline = ggplot()+
    geom_line(data = dfm,aes(x = date,y = value,
                             color = variable))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
}


























predict_tws_based_on_convey_linear<-function(
  
){
  i = 1:2
  
  predict_model_mean <-function(i){
    
    files_moun = c('north_moun','south_moun')
    files_jishui = c('north_jishui','south_jishui')
    
    # input conveid vapor
    con_amount_moun  = paste0('convey_amount_based_era5_in_target/mean/',
                              files_moun[i],
                              '.csv')
    con_amount_jishui = paste0('convey_amount_based_era5_in_target/mean/',
                               files_jishui[i],
                               '.csv')
    
    con_amount_moun = as.data.frame(fread(con_amount_moun))
    con_amount_jishui = as.data.frame(fread(con_amount_jishui))
    
    colnames(con_amount_moun) = paste0('pr_mount',1:12)
    colnames(con_amount_jishui) = paste0('pr_jishui',1:12)
    
    con_moun_sum = apply(con_amount_moun,2,sum)
    con_jishui_sum = apply(con_amount_jishui,2,sum)
    
    id_re_moun = as.numeric(which(con_moun_sum < 5000))
    id_re_jishui = as.numeric(which(con_jishui_sum < 5000))
    
    if(length(id_re_moun)>0){
      con_amount_moun = con_amount_moun[,-id_re_moun]
    }
    if(length(id_re_jishui)>0){
      con_amount_jishui = con_amount_jishui[,-id_re_jishui]
    }
    
    # import evaporation in mount and palin
    eva_input = 'evaporation_in_target/'
    eva_input_moun = paste0(eva_input,files_moun[i],'.csv')
    eva_input_jishui = paste0(eva_input,files_jishui[i],'.csv')
    
    eva_moun = as.data.frame(fread(eva_input_moun))
    eva_jishui = as.data.frame(fread(eva_input_jishui))
    
    eva_moun = eva_moun *-1
    eva_jishui = eva_jishui *-1
    
    # import t in mountain
    t_input = 'temperature_in_target/'
    t_input_moun = paste0(t_input,files_moun[i],'.csv')
    t_moun = as.data.frame(fread(t_input_moun))
    t_moun = t_moun -273.15
    
    # import tws 
    input_tws = 'tws_in_target/'
    input_tws = paste0(input_tws,files_jishui[i],'.csv')
    
    tws_jishui = as.data.frame(fread(input_tws))
    
    df = data.frame(
      tws = tws_jishui[,1],
      con_amount_moun[1:174,],
      con_amount_jishui[1:174,],
      eva_moun = eva_moun[1:174,],
      eva_jishui =eva_jishui[1:174,],
      t = t_moun[1:174,]
    )
    #source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws.R')
    #ret = random_forest_model_tws(df)
    source('/home/share/R_project/xinjiang_vapor/liner_model.R')
    ret = liner_model(df)
    return(ret)
  }
  
  ret_box = lapply(i,predict_model_mean)
  
  trend_li_fun<- function(x){
    txb = 1
    for(i in 1:ncol(x)){
      tx = ts(x[,i],start = c(2003,1),frequency = 12)
      tx = decompose(tx)$trend
      txb = cbind(txb,tx)
    }
    txb = txb[,-1]
    return(txb)
  }
  
  rts  = lapply(ret_box,trend_li_fun)
  naid = which(is.na(rts[[1]][,1]))
  
  rts_north_jishui = ret_box[[1]]
  rts_south_jishui= ret_box[[2]]
  
  rts_north_jishui = rts[[1]]
  rts_south_jishui= rts[[2]]
  
  
  date = seq(as.Date('2003-01-01'),as.Date('2017-12-01'),'1 month')
  date = date[1:(nrow(rts_north_jishui))]
  
  rts_df1 = data.frame(date = date,
                       tws = rts_north_jishui[,1],
                       simu = rts_north_jishui[,2],
                       type= 'North_plain')
  rts_df2 = data.frame(
    date = date,
    tws = rts_south_jishui[,1],
    simu = rts_south_jishui[,2],
    type = 'South_plain'
  )
  
  rts_df1 = rts_df1[-naid,]
  rts_df2 = rts_df2[-naid,]
  
  df = rbind(rts_df1,rts_df2)
  
  pbar = ggplot()+
    geom_point(data = df,aes(x = tws,y =  simu),color = 'blue',
               size = 1)+
    geom_abline(data = df,aes(slope = 1,intercept = 0))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
  pbar
  
  
  dfm = melt(df,c('date','type'))
  pline = ggplot()+
    geom_line(data = dfm,aes(x = date,y = value,
                             color = variable))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
}


























predict_tws_based_on_convey_pe<-function(
  
){
  i = 1:2
  
  predict_model_mean <-function(i){
    
    files_moun = c('north_moun','south_moun')
    files_jishui = c('north_jishui','south_jishui')
    
    # input conveid vapor
    con_amount_moun  = paste0('convey_amount_based_era5_pe_in_target/mean/',
                              files_moun[i],
                              '.csv')
    con_amount_jishui = paste0('convey_amount_based_era5_pe_in_target/mean/',
                               files_jishui[i],
                               '.csv')
    
    con_amount_moun = as.data.frame(fread(con_amount_moun))
    con_amount_jishui = as.data.frame(fread(con_amount_jishui))
    
    colnames(con_amount_moun) = paste0('pr_mount',1:12)
    colnames(con_amount_jishui) = paste0('pr_jishui',1:12)
    
    con_moun_sum = apply(con_amount_moun,2,sum)
    con_jishui_sum = apply(con_amount_jishui,2,sum)
    
    id_re_moun = as.numeric(which(con_moun_sum < 5000))
    id_re_jishui = as.numeric(which(con_jishui_sum < 5000))
    
    print(id_re_moun)
    print(id_re_jishui)
    if(length(id_re_moun)>0){
      con_amount_moun = con_amount_moun[,-id_re_moun]
    }
    if(length(id_re_jishui)>0){
      con_amount_jishui = con_amount_jishui[,-id_re_jishui]
    }
    
    # import evaporation in mount and palin
    eva_input = 'evaporation_in_target/'
    eva_input_moun = paste0(eva_input,files_moun[i],'.csv')
    eva_input_jishui = paste0(eva_input,files_jishui[i],'.csv')
    
    eva_moun = as.data.frame(fread(eva_input_moun))
    eva_jishui = as.data.frame(fread(eva_input_jishui))
    
    eva_moun = eva_moun *-1
    eva_jishui = eva_jishui *-1
    
    # import t in mountain
    t_input = 'temperature_in_target/'
    t_input_moun = paste0(t_input,files_moun[i],'.csv')
    t_moun = as.data.frame(fread(t_input_moun))
    t_moun = t_moun -273.15
    
    # import tws 
    input_tws = 'tws_in_target/'
    input_tws = paste0(input_tws,files_jishui[i],'.csv')
    
    tws_jishui = as.data.frame(fread(input_tws))
    
    stand_fun1 <-function(x){
      x= (x-mean(x))/(max(x)-min(x))
    }
    
    stand_fun2 <-function(x){
      x= (x)/(max(x)-min(x))
    }
    df = data.frame(
      tws = stand_fun2(tws_jishui[,1]),
      con_amount_moun[1:174,],
      con_amount_jishui[1:174,],
      eva_moun = eva_moun[1:174,],
      eva_jishui =eva_jishui[1:174,],
      t = t_moun[1:174,]
    )
    df2 = df[,-1]
    
    
    df2 = apply(df2,2,stand_fun1)
    df = data.frame(tws = df$tws,
                    df2)
    if(i ==2){
      df = data.frame(tws = df$tws,
                      #con_amount_moun[1:174,],
                      #eva_jishui = df$eva_jishui,
                      t = t_moun[1:174,])
    }
    
    
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws.R')
    ret = random_forest_model_tws(df)
    
  }
  
  ret_box = lapply(i,predict_model_mean)
  
  trend_li_fun<- function(x){
    txb = 1
    for(i in 1:ncol(x)){
      tx = ts(x[,i],start = c(2003,1),frequency = 12)
      tx = decompose(tx)$trend
      txb = cbind(txb,tx)
    }
    txb = txb[,-1]
    return(txb)
  }
  
  
  rts_north_jishui = ret_box[[1]][[1]]
  rts_south_jishui= ret_box[[2]][[1]]
  rts_north_jishui_test = ret_box[[1]][[2]]
  rts_south_jishui_test = ret_box[[2]][[2]]
  
  
  files = c('north_tws_train_mean.csv',
            'south_tws_train_mean.csv',
            'north_tws_test_mean.csv',
            'south_tws_test_mean.csv')
  
  
  output = paste0('output_simu_tws/',files)
  
  ret_box = list(rts_north_jishui,rts_south_jishui,
                 rts_north_jishui_test,rts_south_jishui_test)
  fwrite(ret_box[[1]],output[1])
  fwrite(ret_box[[2]],output[2])
  fwrite(ret_box[[3]],output[3])
  fwrite(ret_box[[4]],output[4])
  #rts  = lapply(ret_box,trend_li_fun)
  #naid = which(is.na(rts[[1]][,1]))
  
  #rts_north_jishui = rts[[1]]
  #rts_south_jishui= rts[[2]]
  #rts_north_jishui_test = rts[[3]]
  #rts_south_jishui_test = rts[[4]]
  
  date = seq(as.Date('2003-01-01'),as.Date('2017-12-01'),'1 month')
  date_train = date[1:121]
  date_test = date[122:174]
  
  rts_df1 = data.frame(date = date_train,
                       tws = rts_north_jishui[,1],
                       simu = rts_north_jishui[,2],
                       type= 'North_plain_train')
  rts_df2 = data.frame(
    date = date_train,
    tws = rts_south_jishui[,1],
    simu = rts_south_jishui[,2],
    type = 'South_plain_train'
  )
  
  rts_df3 = data.frame(date = date_test,
                       tws = rts_north_jishui_test[,1],
                       simu = rts_north_jishui_test[,2],
                       type= 'North_plain_test')
  rts_df4 = data.frame(
    date = date_test,
    tws = rts_south_jishui_test[,1],
    simu = rts_south_jishui_test[,2],
    type = 'South_plain_test'
  )
  
  #rts_df1 = rts_df1[-naid,]
  #rts_df2 = rts_df2[-naid,]
  
  df = rbind(rts_df1,rts_df2,
             rts_df3,rts_df4)
  
  pbar = ggplot()+
    geom_point(data = df,aes(x = tws,y =  simu),color = 'blue',
               size = 1)+
    geom_abline(data = df,aes(slope = 1,intercept = 0))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
  pbar
  
  
  dfm = melt(df,c('date','type'))
  pline = ggplot()+
    geom_line(data = dfm,aes(x = date,y = value,
                             color = variable))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
}


























predict_tws_based_on_convey<-function(
  
){
  i = 1:2
  
  predict_model_mean <-function(i){
    
    files_moun = c('north_moun','south_moun')
    files_jishui = c('north_jishui','south_jishui')
    
    # input conveid vapor
    con_amount_moun  = paste0('convey_amount_based_era5_in_target/mean/',
                              files_moun[i],
                              '.csv')
    con_amount_jishui = paste0('convey_amount_based_era5_in_target/mean/',
                                files_jishui[i],
                                '.csv')
    
    con_amount_moun = as.data.frame(fread(con_amount_moun))
    con_amount_jishui = as.data.frame(fread(con_amount_jishui))
    
    colnames(con_amount_moun) = paste0('pr_mount',1:12)
    colnames(con_amount_jishui) = paste0('pr_jishui',1:12)
    
    con_moun_sum = apply(con_amount_moun,2,sum)
    con_jishui_sum = apply(con_amount_jishui,2,sum)
    
    id_re_moun = as.numeric(which(con_moun_sum < 5000))
    id_re_jishui = as.numeric(which(con_jishui_sum < 5000))
    
    print(id_re_moun)
    print(id_re_jishui)
    if(length(id_re_moun)>0){
      con_amount_moun = con_amount_moun[,-id_re_moun]
    }
    if(length(id_re_jishui)>0){
      con_amount_jishui = con_amount_jishui[,-id_re_jishui]
    }
    
    # import evaporation in mount and palin
    eva_input = 'evaporation_in_target/'
    eva_input_moun = paste0(eva_input,files_moun[i],'.csv')
    eva_input_jishui = paste0(eva_input,files_jishui[i],'.csv')
    
    eva_moun = as.data.frame(fread(eva_input_moun))
    eva_jishui = as.data.frame(fread(eva_input_jishui))
    
    eva_moun = eva_moun *-1
    eva_jishui = eva_jishui *-1
    
    # import t in mountain
    t_input = 'temperature_in_target/'
    t_input_moun = paste0(t_input,files_moun[i],'.csv')
    t_moun = as.data.frame(fread(t_input_moun))
    t_moun = t_moun -273.15
    
    # import tws 
    input_tws = 'tws_in_target/'
    input_tws = paste0(input_tws,files_jishui[i],'.csv')
    
    tws_jishui = as.data.frame(fread(input_tws))
    
    stand_fun1 <-function(x){
      x= (x-mean(x))/(max(x)-min(x))
    }
    
    stand_fun2 <-function(x){
      x= (x)/(max(x)-min(x))
    }
    df = data.frame(
      tws = stand_fun2(tws_jishui[,1]),
      con_amount_moun[1:174,],
      con_amount_jishui[1:174,],
      eva_moun = eva_moun[1:174,],
      eva_jishui =eva_jishui[1:174,],
      t = t_moun[1:174,]
    )
    df2 = df[,-1]
    
    
    df2 = apply(df2,2,stand_fun1)
    df = data.frame(tws = df$tws,
                    df2)
    if(i ==2){
      df = data.frame(tws = df$tws,
                      #con_amount_moun[1:174,],
                      #eva_jishui = df$eva_jishui,
                      t = t_moun[1:174,])
    }
    
    
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws.R')
    ret = random_forest_model_tws(df)

  }
  
  ret_box = lapply(i,predict_model_mean)
  
  trend_li_fun<- function(x){
    txb = 1
    for(i in 1:ncol(x)){
      tx = ts(x[,i],start = c(2003,1),frequency = 12)
      tx = decompose(tx)$trend
      txb = cbind(txb,tx)
    }
    txb = txb[,-1]
    return(txb)
  }
  
  
  rts_north_jishui = ret_box[[1]][[1]]
  rts_south_jishui= ret_box[[2]][[1]]
  rts_north_jishui_test = ret_box[[1]][[2]]
  rts_south_jishui_test = ret_box[[2]][[2]]
  
  
  files = c('north_tws_train_mean.csv',
            'south_tws_train_mean.csv',
            'north_tws_test_mean.csv',
            'south_tws_test_mean.csv')
  
  
  output = paste0('output_simu_tws/',files)
  
  ret_box = list(rts_north_jishui,rts_south_jishui,
                 rts_north_jishui_test,rts_south_jishui_test)
  fwrite(ret_box[[1]],output[1])
  fwrite(ret_box[[2]],output[2])
  fwrite(ret_box[[3]],output[3])
  fwrite(ret_box[[4]],output[4])
  #rts  = lapply(ret_box,trend_li_fun)
  #naid = which(is.na(rts[[1]][,1]))
  
  #rts_north_jishui = rts[[1]]
  #rts_south_jishui= rts[[2]]
  #rts_north_jishui_test = rts[[3]]
  #rts_south_jishui_test = rts[[4]]
  
  date = seq(as.Date('2003-01-01'),as.Date('2017-12-01'),'1 month')
  date_train = date[1:121]
  date_test = date[122:174]
  
  rts_df1 = data.frame(date = date_train,
                       tws = rts_north_jishui[,1],
                       simu = rts_north_jishui[,2],
                       type= 'North_plain_train')
  rts_df2 = data.frame(
    date = date_train,
    tws = rts_south_jishui[,1],
    simu = rts_south_jishui[,2],
    type = 'South_plain_train'
  )
  
  rts_df3 = data.frame(date = date_test,
                       tws = rts_north_jishui_test[,1],
                       simu = rts_north_jishui_test[,2],
                       type= 'North_plain_test')
  rts_df4 = data.frame(
    date = date_test,
    tws = rts_south_jishui_test[,1],
    simu = rts_south_jishui_test[,2],
    type = 'South_plain_test'
  )
  
  #rts_df1 = rts_df1[-naid,]
  #rts_df2 = rts_df2[-naid,]
  
  df = rbind(rts_df1,rts_df2,
             rts_df3,rts_df4)
  
  pbar = ggplot()+
    geom_point(data = df,aes(x = tws,y =  simu),color = 'blue',
               size = 1)+
    geom_abline(data = df,aes(slope = 1,intercept = 0))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
  pbar
  
  
  dfm = melt(df,c('date','type'))
  pline = ggplot()+
    geom_line(data = dfm,aes(x = date,y = value,
                             color = variable))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
}


























predict_tws_basedon_pr_and_e <-function(
  
){
  mode = c('north_moun','north_jishui',
           'south_moun','south_jishui')
  
  # model
  tws = pr_plain - e_plain + pr_moun-e_moun
  # import 
  
  
  
}
predict_tws_max_based_on_convey<-function(
  
){
  i = 1:2
  
  predict_model_mean <-function(i){
    
    files_moun = c('north_moun','south_moun')
    files_jishui = c('north_jishui','south_jishui')
    
    # input conveid vapor
    con_amount_moun  = paste0('convey_amount_based_era5_in_target/max/',
                              files_moun[i],
                              '.csv')
    con_amount_jishui = paste0('convey_amount_based_era5_in_target/max/',
                               files_jishui[i],
                               '.csv')
    
    con_amount_moun = as.data.frame(fread(con_amount_moun))
    con_amount_jishui = as.data.frame(fread(con_amount_jishui))
    
    colnames(con_amount_moun) = paste0('pr_mount',1:12)
    colnames(con_amount_jishui) = paste0('pr_jishui',1:12)
    
    con_moun_sum = apply(con_amount_moun,2,sum)
    con_jishui_sum = apply(con_amount_jishui,2,sum)
    
    id_re_moun = as.numeric(which(con_moun_sum < 5000))
    id_re_jishui = as.numeric(which(con_jishui_sum < 5000))
    
    print(id_re_moun)
    print(id_re_jishui)
    if(length(id_re_moun)>0){
      con_amount_moun = con_amount_moun[,-id_re_moun]
    }
    if(length(id_re_jishui)>0){
      con_amount_jishui = con_amount_jishui[,-id_re_jishui]
    }
    
    # import evaporation in mount and palin
    eva_input = 'evaporation_in_target/'
    eva_input_moun = paste0(eva_input,files_moun[i],'.csv')
    eva_input_jishui = paste0(eva_input,files_jishui[i],'.csv')
    
    eva_moun = as.data.frame(fread(eva_input_moun))
    eva_jishui = as.data.frame(fread(eva_input_jishui))
    
    eva_moun = eva_moun *-1
    eva_jishui = eva_jishui *-1
    
    # import t in mountain
    t_input = 'temperature_in_target/'
    t_input_moun = paste0(t_input,files_moun[i],'.csv')
    t_moun = as.data.frame(fread(t_input_moun))
    t_moun = t_moun -273.15
    
    # import tws 
    input_tws = 'tws_in_target/'
    input_tws = paste0(input_tws,files_jishui[i],'.csv')
    
    tws_jishui = as.data.frame(fread(input_tws))
    
    stand_fun1 <-function(x){
      x= (x-mean(x))/(max(x)-min(x))
    }
    
    stand_fun2 <-function(x){
      x= (x)/(max(x)-min(x))
    }
    df = data.frame(
      tws = stand_fun2(tws_jishui[,1]),
      con_amount_moun[1:174,],
      con_amount_jishui[1:174,],
      eva_moun = eva_moun[1:174,],
      eva_jishui =eva_jishui[1:174,],
      t = t_moun[1:174,]
    )
    df2 = df[,-1]
    
    df2 = apply(df2,2,stand_fun1)
    df = data.frame(tws = df$tws,
                    df2)
    
    
    
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws.R')
    ret = random_forest_model_tws(df)
    
  }
  
  ret_box = lapply(i,predict_model_mean)
  
  trend_li_fun<- function(x){
    txb = 1
    for(i in 1:ncol(x)){
      tx = ts(x[,i],start = c(2003,1),frequency = 12)
      tx = decompose(tx)$trend
      txb = cbind(txb,tx)
    }
    txb = txb[,-1]
    return(txb)
  }
  
  files = c('north_tws_train_max.csv',
            'south_tws_train_max.csv',
            'north_tws_test_max.csv',
            'south_tws_test_max.csv')
  
  output = paste0('output_simu_tws/',files)
  
  rts_north_jishui = ret_box[[1]][[1]]
  rts_south_jishui= ret_box[[2]][[1]]
  rts_north_jishui_test = ret_box[[1]][[2]]
  rts_south_jishui_test = ret_box[[2]][[2]]
  
  ret_box = list(rts_north_jishui,rts_south_jishui,
                 rts_north_jishui_test,rts_south_jishui_test)
  fwrite(ret_box[[1]],output[1])
  fwrite(ret_box[[2]],output[2])
  fwrite(ret_box[[3]],output[3])
  fwrite(ret_box[[4]],output[4])
  #rts  = lapply(ret_box,trend_li_fun)
  #naid = which(is.na(rts[[1]][,1]))
  
  #rts_north_jishui = rts[[1]]
  #rts_south_jishui= rts[[2]]
  #rts_north_jishui_test = rts[[3]]
  #rts_south_jishui_test = rts[[4]]
  
  date = seq(as.Date('2003-01-01'),as.Date('2017-12-01'),'1 month')
  date_train = date[1:121]
  date_test = date[122:174]
  
  rts_df1 = data.frame(date = date_train,
                       tws = rts_north_jishui[,1],
                       simu = rts_north_jishui[,2],
                       type= 'North_plain_train')
  rts_df2 = data.frame(
    date = date_train,
    tws = rts_south_jishui[,1],
    simu = rts_south_jishui[,2],
    type = 'South_plain_train'
  )
  
  rts_df3 = data.frame(date = date_test,
                       tws = rts_north_jishui_test[,1],
                       simu = rts_north_jishui_test[,2],
                       type= 'North_plain_test')
  rts_df4 = data.frame(
    date = date_test,
    tws = rts_south_jishui_test[,1],
    simu = rts_south_jishui_test[,2],
    type = 'South_plain_test'
  )
  
  #rts_df1 = rts_df1[-naid,]
  #rts_df2 = rts_df2[-naid,]
  
  df = rbind(rts_df1,rts_df2,
             rts_df3,rts_df4)
  
  pbar = ggplot()+
    geom_point(data = df,aes(x = tws,y =  simu),color = 'blue',
               size = 1)+
    geom_abline(data = df,aes(slope = 1,intercept = 0))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
  pbar
  
  
  dfm = melt(df,c('date','type'))
  pline = ggplot()+
    geom_line(data = dfm,aes(x = date,y = value,
                             color = variable))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
}


























predict_tws_min_based_on_convey<-function(
  
){
  i = 1:2
  
  predict_model_mean <-function(i){
    
    files_moun = c('north_moun','south_moun')
    files_jishui = c('north_jishui','south_jishui')
    
    # input conveid vapor
    con_amount_moun  = paste0('convey_amount_based_era5_in_target/min/',
                              files_moun[i],
                              '.csv')
    con_amount_jishui = paste0('convey_amount_based_era5_in_target/min/',
                               files_jishui[i],
                               '.csv')
    
    con_amount_moun = as.data.frame(fread(con_amount_moun))
    con_amount_jishui = as.data.frame(fread(con_amount_jishui))
    
    colnames(con_amount_moun) = paste0('pr_mount',1:12)
    colnames(con_amount_jishui) = paste0('pr_jishui',1:12)
    
    con_moun_sum = apply(con_amount_moun,2,sum)
    con_jishui_sum = apply(con_amount_jishui,2,sum)
    
    id_re_moun = as.numeric(which(con_moun_sum < 5000))
    id_re_jishui = as.numeric(which(con_jishui_sum < 5000))
    
    print(id_re_moun)
    print(id_re_jishui)
    if(length(id_re_moun)>0){
      con_amount_moun = con_amount_moun[,-id_re_moun]
    }
    if(length(id_re_jishui)>0){
      con_amount_jishui = con_amount_jishui[,-id_re_jishui]
    }
    
    # import evaporation in mount and palin
    eva_input = 'evaporation_in_target/'
    eva_input_moun = paste0(eva_input,files_moun[i],'.csv')
    eva_input_jishui = paste0(eva_input,files_jishui[i],'.csv')
    
    eva_moun = as.data.frame(fread(eva_input_moun))
    eva_jishui = as.data.frame(fread(eva_input_jishui))
    
    eva_moun = eva_moun *-1
    eva_jishui = eva_jishui *-1
    
    # import t in mountain
    t_input = 'temperature_in_target/'
    t_input_moun = paste0(t_input,files_moun[i],'.csv')
    t_moun = as.data.frame(fread(t_input_moun))
    t_moun = t_moun -273.15
    
    # import tws 
    input_tws = 'tws_in_target/'
    input_tws = paste0(input_tws,files_jishui[i],'.csv')
    
    tws_jishui = as.data.frame(fread(input_tws))
    
    stand_fun1 <-function(x){
      x= (x-mean(x))/(max(x)-min(x))
    }
    
    stand_fun2 <-function(x){
      x= (x)/(max(x)-min(x))
    }
    df = data.frame(
      tws = stand_fun2(tws_jishui[,1]),
      con_amount_moun[1:174,],
      con_amount_jishui[1:174,],
      eva_moun = eva_moun[1:174,],
      eva_jishui =eva_jishui[1:174,],
      t = t_moun[1:174,]
    )
    df2 = df[,-1]
    
    df2 = apply(df2,2,stand_fun1)
    df = data.frame(tws = df$tws,
                    df2)
    
    
    
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws.R')
    ret = random_forest_model_tws(df)
    
  }
  
  ret_box = lapply(i,predict_model_mean)
  
  trend_li_fun<- function(x){
    txb = 1
    for(i in 1:ncol(x)){
      tx = ts(x[,i],start = c(2003,1),frequency = 12)
      tx = decompose(tx)$trend
      txb = cbind(txb,tx)
    }
    txb = txb[,-1]
    return(txb)
  }
  
  
  rts_north_jishui = ret_box[[1]][[1]]
  rts_south_jishui= ret_box[[2]][[1]]
  rts_north_jishui_test = ret_box[[1]][[2]]
  rts_south_jishui_test = ret_box[[2]][[2]]
  
  dir.create('output_simu_tws')
  
  files = c('north_tws_train_min.csv',
            'south_tws_train_min.csv',
            'north_tws_test_min.csv',
            'south_tws_test_min.csv')
  
  output = paste0('output_simu_tws/',files)
  
  
  ret_box = list(rts_north_jishui,rts_south_jishui,
                 rts_north_jishui_test,rts_south_jishui_test)
  fwrite(ret_box[[1]],output[1])
  fwrite(ret_box[[2]],output[2])
  fwrite(ret_box[[3]],output[3])
  fwrite(ret_box[[4]],output[4])
  
  #rts  = lapply(ret_box,trend_li_fun)
  #naid = which(is.na(rts[[1]][,1]))
  
  #rts_north_jishui = rts[[1]]
  #rts_south_jishui= rts[[2]]
  #rts_north_jishui_test = rts[[3]]
  #rts_south_jishui_test = rts[[4]]
  
  date = seq(as.Date('2003-01-01'),as.Date('2017-12-01'),'1 month')
  date_train = date[1:121]
  date_test = date[122:174]
  
  rts_df1 = data.frame(date = date_train,
                       tws = rts_north_jishui[,1],
                       simu = rts_north_jishui[,2],
                       type= 'North_plain_train')
  rts_df2 = data.frame(
    date = date_train,
    tws = rts_south_jishui[,1],
    simu = rts_south_jishui[,2],
    type = 'South_plain_train'
  )
  
  rts_df3 = data.frame(date = date_test,
                       tws = rts_north_jishui_test[,1],
                       simu = rts_north_jishui_test[,2],
                       type= 'North_plain_test')
  rts_df4 = data.frame(
    date = date_test,
    tws = rts_south_jishui_test[,1],
    simu = rts_south_jishui_test[,2],
    type = 'South_plain_test'
  )
  
  #rts_df1 = rts_df1[-naid,]
  #rts_df2 = rts_df2[-naid,]
  
  df = rbind(rts_df1,rts_df2,
             rts_df3,rts_df4)
  
  pbar = ggplot()+
    geom_point(data = df,aes(x = tws,y =  simu),color = 'blue',
               size = 1)+
    geom_abline(data = df,aes(slope = 1,intercept = 0))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
  pbar
  
  
  dfm = melt(df,c('date','type'))
  pline = ggplot()+
    geom_line(data = dfm,aes(x = date,y = value,
                             color = variable))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
}


























predict_tws_model_pe_eva <-function(
  
){
  
  
  i = 1:2
  predict_model<-function(i){
    files_moun = c('north_moun','south_moun')
    files_jishui = c('north_jishui','south_jishui')
    
    
    input_pe = 'precp_minus_evapor_in_target/'
    input_pe = paste0(input_pe,files_jishui,'.csv')
    
    input_snowm = 'snowmelt_in_target/'
    input_snowm = paste0(input_snowm,files_moun,'.csv')
    
    input_tws = 'tws_in_target/'
    input_tws = paste0(input_tws,files_jishui,'.csv')
    
    pe = as.data.frame(fread(input_pe[i]))
    snowm = as.data.frame(fread(input_snowm[i]))
    
    tws = as.data.frame(fread(input_tws[i]))
    
    df = data.frame(tws = tws[,1],
                    pe = pe[1:174,1],
                    snowm = snowm[1:174,1])
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws.R')
    ret = random_forest_model_tws(df)
    
    return(ret)
  }
  
  ret_box = lapply(i,predict_model)
  
  trend_li_fun<- function(x){
    txb = 1
    for(i in 1:ncol(x)){
      tx = ts(x[,i],start = c(2003,1),frequency = 12)
      tx = decompose(tx)$trend
      txb = cbind(txb,tx)
    }
    txb = txb[,-1]
    return(txb)
  }
  
  rts  = lapply(ret_box,trend_li_fun)
  naid = which(is.na(rts[[1]][,1]))
  
  rts_north_jishui = ret_box[[1]]
  rts_south_jishui= ret_box[[2]]
  
  date = seq(as.Date('2003-01-01'),as.Date('2017-12-01'),'1 month')
  date = date[1:(nrow(rts_north_jishui))]
  
  rts_df1 = data.frame(date = date,
                       tws = rts_north_jishui[,1],
                       simu = rts_north_jishui[,2],
                       type= 'North_plain')
  rts_df2 = data.frame(
    date = date,
    tws = rts_south_jishui[,1],
    simu = rts_south_jishui[,2],
    type = 'South_plain'
  )

  #rts_df1 = rts_df1[-naid,]
  #rts_df2 = rts_df2[-naid,]
  
  df = rbind(rts_df1,rts_df2)
  
  
  output = 'simu_df_tws_injishui'
  dir.create(output)
  output = paste0(output,c('/north_jishui.csv','/south_jishui.csv'))
  
  fwrite(rts_df1,output[1])
  fwrite(rts_df2,output[2])
  
  
  
  pbar = ggplot()+
    geom_point(data = df,aes(x = tws,y =  simu),color = 'blue',
               size = 1)+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
  pbar
  
  
  dfm = melt(df,c('date','type'))
  pline = ggplot()+
    geom_line(data = dfm,aes(x = date,y = value,
                             color = variable))+
    facet_wrap(~type,nrow = 2,scales = 'free')+
    theme_bw()
  
  
  
  
  
  
  
  
  
}
preproces_oscar_wind_file<-function(
  
){
  library(raster)
  input = '/media/sdb5/Data/oscar_ocean_current/year'
  input = list.files(input,full.names = T)
  files = list.files(input)
  
  mean_each_year <- function(input,var = 'u'){
    library(raster)
    if(var == 'u'){
      output = 'analysis_output/fig4/multi_mean_u.nc'
    }else{
      output = 'analysis_output/fig4/multi_mean_v.nc'
    }
    mean_fun <- function(x){
      x = mean(x,na.rm = T)
      return(x)
    }
    tmpbox = list()
    for(i in 1:length(input)){
      tmp = stack(input[i],varname = var)
      beginCluster(14)
      tmpmean = clusterR(tmp,calc,
                           args = list(fun = mean_fun))
      endCluster()
      tmpbox = c(tmpbox,tmpmean)
      gc()
    }
    tmpbox = do.call('stack',tmpbox)
    
    beginCluster(14)
    tmpmean = clusterR(tmpbox,calc,
                       args = list(fun = mean_fun))
    endCluster()
    
    writeRaster(tmpmean,output,format = 'CDF',
                overwrite = T)
  }
  
  mean_each_year(input,'u')
  mean_each_year(input,'v')
  
  input_u = 'analysis_output/fig4/multi_mean_u.nc'
  input_v = 'analysis_output/fig4/multi_mean_v.nc'
  
  world = shp_management('world')
  
  u = stack(input_u)
  v = stack(input_v)
  
  u1 = crop(u,extent(extent(u)[1],180,-90,90))
  u2 = crop(u,extent(180,360+extent(u)[1],-90,90))
  diff = extent(u)[2]-extent(u)[1]
  
  extent(u2) = extent(180-360,
                      extent(u)[1],
                      extent(u2)[3],
                      extent(u2)[4])
  
  u = merge(u1,u2)
  
  v1 = crop(v,extent(extent(v)[1],180,-90,90))
  v2 = crop(v,extent(180,360+extent(v)[1],-90,90))
  diff = extent(v)[2]-extent(v)[1]
  
  extent(v2) = extent(180-360,
                      extent(v)[1],
                      extent(v2)[3],
                      extent(v2)[4])
  
  v = merge(v1,v2)
  
  u = crop(u,extent(-128,38,0,90))
  v = crop(v,extent(-128,38,0,90))

  ato = shapefile('/media/sdb1/shp/ato_dissolve/ato_diso.shp')
  
  u = mask(u,ato)
  v = mask(v,ato)
  
  u = as.data.frame(u,xy = T)
  v = as.data.frame(v,xy = T)
  
  cur_df = 
    data.frame(
      long = u$x,
      lat = u$y,
      u = u$layer,
      v = v$layer
    )
  
  naid = which(is.na(cur_df$u))
  cur_df = cur_df[-naid,]
  
  fwrite(cur_df,'analysis_output/fig4/current_df.csv')
  idbig = which(cur_df$u>0 &
                  cur_df$v >0)
  
  cur_df = cur_df[idbig,]
  library(scales)
  
  cur_df$u = cur_df$u *10
  cur_df$v = cur_df$v *10
  #cur_df$u = rescale(cur_df$u,c(1,10))
  #cur_df$v = rescale(cur_df$v,c(1,10))
  
  pview = ggplot()+
    geom_segment(data = cur_df[c(TRUE,rep(NA,40)),],
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 30,unit(0.25,'cm'),
                               type = 'open'))
  
  cur_df1 = kmeans(cur_df1[,1:2],100)
  
  loc = cur_df1$centers
  
  
  
  pview = ggplot()+
    geom_segment(data = cur_df[c(TRUE,rep(NA,40)),],
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 30,unit(0.25,'cm'),
                               type = 'open'))+
    facet_wrap(~cluster,nrow = 2)
  
  
  
  return()
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
}
preprocess_water_use_eurasia<-function(
  
){
  input_country = 'NC_mod_xinjiang/freshwater/abb_region_country.csv'
  input_freshwater = 'NC_mod_xinjiang/freshwater/fresh_water_withdrawl.csv'
  
  library(data.table)
  
  freshwater = as.data.frame(fread(input_freshwater))
  country = as.data.frame(fread(input_country))
  
  freshwater = freshwater[which(freshwater$MEASURE == 'MLN_M3'),]
  region = unique(country$Region)
  region = region[c(3,4,5,6,7)]
  country = country[which(country$Region %in% region),]
  
  country = country[,c(1,2,5)]
  colnames(country) = c('code','region','name')
  
  uni_code = unique(freshwater$LOCATION)
  i = 1:length(uni_code)
  restructure_fun <-function(i){
    tmp = uni_code[i]
    id = which(country$code == tmp)
    
    if(length(id)!=0){
      tmpname = country$name[id][1]
      tmpregion = country$region[id][1]
      tmpcode = tmp
      tmpfreshwater = freshwater[which(freshwater$LOCATION == tmpcode),]
      
      tmpyear = tmpfreshwater$TIME
      tmp_less_year = which(tmpyear < 2000)
      tmpfreshwater = tmpfreshwater[-tmp_less_year,]
      tmpyear = tmpyear[-tmp_less_year]
      fullyear = c(2000:2019)
      j = 1:length(fullyear)
      
      filter_by_year<-function(j){
        
        tmpyear1_id = which(tmpyear == fullyear[j])
        if(length(tmpyear1_id)>0){
          ret_value = tmpfreshwater$Value[tmpyear1_id]
          return(ret_value)
        }else{
          ret_value = NA
          return(ret_value)
        }
        
      }
      
      tmp_wateruse = do.call(c,lapply(j,filter_by_year))
      tmp_wateruse = matrix(tmp_wateruse,
                            ncol = 20)
      colnames(tmp_wateruse)= 2000:2019
      
      retdf = data.frame(
        code = tmpcode,
        country = tmpname,
        region = tmpregion,
        tmp_wateruse
      )
      return(retdf)
      
      
      
      
      
    }
  }
  
  full_df = do.call(rbind,sapply(i,restructure_fun))
  
  full_df_num = full_df[,4:23]
  
  nacheck1 = apply(full_df_num,1,mean,na.rm = T)
  nacheck1 = which(is.nan(nacheck1))
  
  full_df = full_df[-nacheck1,]
  full_df_num = full_df_num[-nacheck1,]
  
  nacheck2 = apply(full_df_num,1,mean)
  nacheck2 = which(is.na(as.numeric(nacheck2)))
  
  full_df_nona = full_df[-nacheck2,]
  full_df_num_nona = full_df_num[-nacheck2,]
  
  
  full_df_inter = full_df[nacheck2,]
  full_df_num_inter = full_df_num[nacheck2,]
  
  i = 1:nrow(full_df_num_inter)
  
  filter_outer_over50 <-function(i){
    tmp = full_df_num_inter[i,]
    tmp = as.numeric(tmp)
    
    naid = which(is.na(tmp))
    ratio = length(naid)/length(tmp)
    if(ratio >= 0.8){
      return(i)
    }
  }
  
  reid = lapply(i,filter_outer_over50)
  reid = do.call(c,reid)
  
  full_df_inter = full_df_inter[-reid,]
  full_df_num_inter = full_df_num_inter[-reid,]
  
  i = 1:nrow(full_df_num_inter)
  i
  library(zoo)
  inter_fun <-function(i){
    tmp = as.numeric(full_df_num_inter[i,])
    tmp
    nonnaid = which(!is.na(tmp))
    tmpc = na.approx(tmp,na.rm = T,rule = 2)
    tmpc
    tmpc[nonnaid] = tmp[nonnaid]
    if(length(tmpc)<20){
      print(i)
      lack = 20 - length(tmpc)
      tmpc = c(tmpc,rep(NA,lack))
    }
    tmpc = matrix(tmpc,ncol = 20)
    colnames(tmpc) = c(2000:2019)
    return(tmpc) 
  }
  
  inter_after_num = do.call(rbind,lapply(i,inter_fun))
  
  naid = which(is.na(apply(inter_after_num,1,mean)))
  if(length(naid)>0){
    inter_after_num = inter_after_num[-naid,]
    full_df_inter = full_df_inter[-naid,]
  }
  
  
  
  full_df_inter = data.frame(
    full_df_inter[,1:3],
    inter_after_num
  )
  
  full_df = rbind(full_df_nona,
                  full_df_inter)
  dir.create('NC_mod_xinjiang/inter_freshwater')
  fwrite(full_df,'NC_mod_xinjiang/inter_freshwater/full_df.csv')
  
  
  
  
}
preview_coeff_fresh_positive <- function(
  coeffddf,countrys,tws_year
){
  
  posid = which(coeffddf$coeff_freshwater_withdraw >=0)
  
  pos_coef_country = countrys[posid]
  
  col_tws = colnames(tws_year)
  
  ncol = which(col_tws %in% pos_coef_country)
  
  dfline1 = data.frame(
    year = 2003:2016,
    tws_year[,ncol]
  )
  
  dfline2 = data.frame(
    year = 2003:2016,
    freshwater[,ncol]
  )
  
  dfline1 = reshape2::melt(dfline1,'year')
  dfline2 = reshape2::melt(dfline2,'year')
  
  dfline1$var = 'tws'
  dfline2$var = 'freshwater'
  
  dfline = rbind(dfline1,dfline2)
  
  p = ggplot()+
    geom_line(data = dfline,aes(x = year,
                                y = value,
                                color = var))+
    facet_wrap(~variable,nrow = 4)+
    theme_bw()
  
  
  
  
}
preview_increasing_tws_country<-function(
  coeffddf,countrys  
){
  posid = which(coeffddf$type == 'increasing_TWS')
  negid = which(coeffddf$type =='declining_TWS')
  
  pos_coeff = coeffddf[posid,]
  neg_coeff = coeffddf[negid,]
  
  pos_country = countrys[posid]
  neg_country = countrys[negid]
  
  # for pos
  pos_negid = which(pos_coeff$coeff_freshwater_withdraw >0)
  neg_negid = which(neg_coeff$coeff_freshwater_withdraw >0)
  
  
  pos_negdf = pos_coeff[pos_negid,]
  neg_negdf = neg_coeff[neg_negid,]
  pos_neg_country = pos_country[pos_negid]
  neg_neg_country = neg_country[neg_negid]
  
  
  pos_neg_dif = abs(pos_negdf$coeff_freshwater_withdraw)-
    (abs(pos_negdf$coeff_pmeato3)+abs(pos_negdf$coeff_pmeato4))
  neg_neg_dif = abs(neg_negdf$coeff_freshwater_withdraw)-
    abs(neg_negdf$coeff_pmeato3)
  
  pos_neg_peo_id = which(pos_neg_dif >0)
  neg_neg_peo_id = which(neg_neg_dif >0)
  
  pos_neg_peo_country = pos_neg_country[pos_neg_peo_id]
  neg_neg_peo_country = neg_neg_country[neg_neg_peo_id]
  
  
  select_country1 = 
    data.frame(country = pos_neg_peo_country,
               type = 'pos_trend')
  select_country2 = 
    data.frame(country  = neg_neg_peo_country,
               type = 'neg_trend')
  
  return(list(select_country1,
              select_country2))
  
  country_label <- as.data.frame(
    fread('/media/sdb5/Vapor_projcts/Vapor_tibet/main_plot_data/fig3/country_label.csv')
  )
  country_label = country_label[-which(country_label$name == 'Hong Kong'|
                                         country_label$name == 'Macau'),]
  country_label$latitude[which(country_label$name=='India')]=
    country_label$latitude[which(country_label$name=='India')]+2
  
  citys = shp_management('china_city')
  city_china = citys[citys$PINYIN %in%
                       c('Wulumuqi','Shijiazhuang'),]
  city_china = as.data.frame(city_china,xy = T)
  city_china1 = data.frame(
    country = c('NCP','XJ'),
    latitude = city_china$coords.x2,
    longitude = city_china$coords.x1,
    name = c('North China Plain','Xinjiang')
  )
  
  country_label = rbind(country_label,city_china1)
  
  country_in1 = which(country_label$name %in% select_country1$country )
  country_in2 = which(country_label$name %in% select_country2$country)
  
  country_in1 = country_label[country_in1,]
  country_in2 = country_label[country_in2,]
  
  country_in1$type = 'pos_tws'
  country_in2$type = 'neg_tws'
  
  country_in = rbind(country_in1,country_in2)
  
  
  world = shp_management('world')
  world = crop(world,extent(-20,180,0,90))
  hsr = shapefile('analysis_output/fig2/combine_sub_window.shp')
  
  p = ggplot()+
    geom_polygon(data = world,
                 aes(x = long,y = lat,
                     group = group),
                 size = 0.5,
                 fill = 'grey80')+
    geom_polygon(data = hsr,
                 aes(x = long,y = lat,
                     group = group),
                 size = 0.5,
                 fill = 'transparent',color = 'black')+
    geom_point(data = country_in,
               aes(x = longitude,y = latitude,
                   color = type),
               size = 3,shape = 1)+
    geom_point(data =country_in,
               aes(x = longitude,y = latitude,
                   color = type),
               size = 2,shape = 16)+
    geom_text(data = country_in,
              aes(x = longitude,y = latitude,
                  label = name))+
    facet_wrap(~type,nrow = 2)+
    theme_bw()
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
}v
project_tws_along_wind_based_cmip6<-function(
  
){
  sub_data_process<-function(){
    mode = c('ssp245','ssp585')
    source('/home/share/R_project/xinjiang_vapor/extract_region_sum_value_of_pmeato13.R')
    source('/home/share/R_project/xinjiang_vapor/extract_mean_value_of_cmip6_over_ato13.R')
    
    extract_mean_value_of_cmip6_over_ato13(mode[1])
    extract_mean_value_of_cmip6_over_ato13(mode[2])
    extract_region_sum_value_of_pmeato13(mode[1])
    extract_region_sum_value_of_pmeato13(mode[2])
  }
  
  input_sst = list.files('analysis_output/cmip6_by_model/sst',
                          full.names = T)
  input_pme = list.files('analysis_output/cmip6_by_model/pme',
                         full.names = T)
  
  
  sst = lapply(lapply(input_sst,fread),as.data.frame)
  pme = lapply(lapply(input_pme,fread),as.data.frame)
  
  trend_fun <- function(x){
    
    sub_fun <-function(x){
      x = ts(x,start = c(2003,1),
             frequency = 12)
      x = decompose(x)$trend
      
      xt = as.numeric(x)
      stand_fun <-function(y){
        y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
      }
      xy  = stand_fun(xt)
      return(xy)
    }
    xm = apply(x,2,sub_fun)
    return(xm)
  }
  
  sst_trend = lapply(sst,trend_fun)
  pme_trend = lapply(pme,trend_fun)
  
  sst1_ssp245 = sst_trend[[1]]
  sst1_ssp585 = sst_trend[[2]]
  sst3_ssp245 = sst_trend[[3]]
  sst3_ssp585 = sst_trend[[4]]
  
  pme1_ssp245 = pme_trend[[1]]
  pme1_ssp585 = pme_trend[[2]]
  pme3_ssp245 = pme_trend[[3]]
  pme3_ssp585 = pme_trend[[4]]

  
  # import tws
  input_tws = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws = fread(input_tws)
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  tws = as.data.frame(tws)
  tws = tws[,-1]
  twsdf = tws[,id_box]
  
  twsdf <<- twsdf
  colnames(twsdf) = paste0('SW',1:10)
  
  sst1_ssp245 <<- sst1_ssp245
  sst1_ssp585 <<- sst1_ssp585
  sst3_ssp245 <<- sst3_ssp245
  sst3_ssp585 <<- sst3_ssp585
  
  pme1_sst245 <<- pme1_ssp245
  pme3_ssp245 <<- pme3_ssp245
  pme1_ssp585 <<- pme1_ssp585
  pme3_ssp585 <<- pme3_ssp585
  
  i = 1:ncol(twsdf)
  i <<- i
  sub_train_fun <-function(i){
    
    tws_sw = twsdf[,i]
    naid = which(is.na(tws_sw))
    tws_sw = tws_sw[-naid]
    tws_sw <<- tws_sw
    
    # sp245 data
    ###############
    pme1_tv245 = pme1_ssp245[1:174,]
    pme3_tv245 = pme3_ssp245[1:174,]
    sst1_tv245 = sst1_ssp245[1:174,]
    sst3_tv245 = sst3_ssp245[1:174,]
    
    pme1_tv245 = pme1_tv245[-naid,]
    pme3_tv245 = pme3_tv245[-naid,]
    sst1_tv245 = sst1_tv245[-naid,]
    sst3_tv245 = sst3_tv245[-naid,]
    
    pme1_pj245 = pme1_ssp245[175:570,]
    pme3_pj245 = pme3_ssp245[175:570,]
    sst1_pj245 = sst1_ssp245[175:570,]
    sst3_pj245 = sst3_ssp245[175:570,]
    
    pme1_tv245 <<- pme1_tv245
    pme3_tv245 <<- pme3_tv245
    sst1_tv245 <<- sst1_tv245
    sst3_tv245 <<- sst3_tv245
    
    pme1_pj245 <<- pme1_pj245
    pme3_pj245 <<- pme3_pj245
    sst1_pj245 <<- sst1_pj245
    sst3_pj245 <<- sst3_pj245
    ###############
    j = 1:ncol(sst1_tv245)
    j <<- j
    ssp245_fun <-function(j){
      df = data.frame(
        tws = tws_sw,
        pme1 = pme1_tv245[,j],
        pme3 = pme3_tv245[,j],
        sst1 = sst1_tv245[,j],
        sst3 = sst3_tv245[,j]
      )
      
      df_project = data.frame(
        pme1 = pme1_pj245[,j],
        pme3 = pme3_pj245[,j],
        sst1 = sst1_pj245[,j],
        sst3 = sst3_pj245[,j]
      )
      source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws_cmip6.R')
      ret_box = random_forest_model_tws_cmip6(df,
                                              df_project)
    }
    
    ret245 <- lapply(j,ssp245_fun)
    
    #### 
    # 585
    # ssp585 data
    ###############
    pme1_tv585 = pme1_ssp585[1:174,]
    pme3_tv585 = pme3_ssp585[1:174,]
    sst1_tv585 = sst1_ssp585[1:174,]
    sst3_tv585 = sst3_ssp585[1:174,]
    
    pme1_tv585 = pme1_tv585[-naid,]
    pme3_tv585 = pme3_tv585[-naid,]
    sst1_tv585 = sst1_tv585[-naid,]
    sst3_tv585 = sst3_tv585[-naid,]
    
    pme1_pj585 = pme1_ssp585[175:570,]
    pme3_pj585 = pme3_ssp585[175:570,]
    sst1_pj585 = sst1_ssp585[175:570,]
    sst3_pj585 = sst3_ssp585[175:570,]
    
    pme1_tv585 <<- pme1_tv585
    pme3_tv585 <<- pme3_tv585
    sst1_tv585 <<- sst1_tv585
    sst3_tv585 <<- sst3_tv585
    
    pme1_pj585 <<- pme1_pj585
    pme3_pj585 <<- pme3_pj585
    sst1_pj585 <<- sst1_pj585
    sst3_pj585 <<- sst3_pj585
    ###############
    j = 1:ncol(sst1_tv585)
    j <<- j
    ssp585_fun <-function(j){
      df = data.frame(
        tws = tws_sw,
        pme1 = pme1_tv585[,j],
        pme3 = pme3_tv585[,j],
        sst1 = sst1_tv585[,j],
        sst3 = sst3_tv585[,j]
      )
      
      df_project = data.frame(
        pme1 = pme1_pj585[,j],
        pme3 = pme3_pj585[,j],
        sst1 = sst1_pj585[,j],
        sst3 = sst3_pj585[,j]
      )
      source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws_cmip6.R')
      ret_box = random_forest_model_tws_cmip6(df,
                                              df_project)
    }
    
    ret585 <- lapply(j,ssp585_fun)
    
    ret_li = list(ret245,ret585)
    return(ret_li)
  }
  
  library(doParallel)
  cl = makeCluster(10)
  clusterExport(cl,c('twsdf','i','sst1_ssp245',
                     'sst3_ssp245','sst1_ssp585',
                     'sst3_ssp585',
                     'pme1_ssp245',
                     'pme1_ssp585',
                     'pme3_ssp245',
                     'pme3_ssp585'))
  ret_df = parLapply(cl,i,sub_train_fun)
  stopCluster(cl)
  
  
  ret_df = o
  
  
  
  
  
  
  
}
project_tws_along_wind_based_validated_cmip6<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/import_validate_sst.R')
  source('/home/share/R_project/xinjiang_vapor/import_validate_pme_cmip6.R')
  sst = import_validate_sst()
  pme = import_validate_pme_cmip6()
  
  sst_trend = sst
  pme_trend = pme
  #sst_trend = lapply(sst,trend_fun)
  #pme_trend = lapply(pme,trend_fun)
  
  sst1_ssp245 = sst_trend[[1]]
  sst1_ssp585 = sst_trend[[2]]
  sst3_ssp245 = sst_trend[[3]]
  sst3_ssp585 = sst_trend[[4]]
  
  pme1_ssp245 = pme_trend[[1]]
  pme1_ssp585 = pme_trend[[2]]
  pme3_ssp245 = pme_trend[[3]]
  pme3_ssp585 = pme_trend[[4]]
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(sst1_ssp245) = modelnames
  colnames(sst1_ssp585) = modelnames
  colnames(sst3_ssp245) = modelnames
  colnames(sst3_ssp585) = modelnames
  
  colnames(pme1_ssp245) = modelnames
  colnames(pme1_ssp585) = modelnames
  colnames(pme3_ssp245) = modelnames
  colnames(pme3_ssp585) = modelnames
  
  # import tws
  input_tws = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws = fread(input_tws)
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  tws = as.data.frame(tws)
  tws = tws[,-1]
  twsdf = tws[,id_box]
  
  twsdf <<- twsdf
  colnames(twsdf) = paste0('SW',1:10)
  
  sst1_ssp245 <<- sst1_ssp245
  sst1_ssp585 <<- sst1_ssp585
  sst3_ssp245 <<- sst3_ssp245
  sst3_ssp585 <<- sst3_ssp585
  
  pme1_sst245 <<- pme1_ssp245
  pme3_ssp245 <<- pme3_ssp245
  pme1_ssp585 <<- pme1_ssp585
  pme3_ssp585 <<- pme3_ssp585
  
  i = 1:ncol(twsdf)
  i <<- i
  sub_train_fun <-function(i){
    
    tws_sw = twsdf[,i]
    naid = which(is.na(tws_sw))
    tws_sw = tws_sw[-naid]
    tws_sw <<- tws_sw
    
    trend_fun <- function(x){
      
      sub_fun <-function(x){
        x = ts(x,start = c(2003,1),
               frequency = 12)
        x = decompose(x)$trend
        
        xt = as.numeric(x)
        stand_fun <-function(y){
          y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
        }
        xy  = stand_fun(xt)
        return(xy)
      }
      xm = apply(x,2,sub_fun)
      return(xm)
    }
    # sp245 data
    ###############
    pme1_tv245 = pme1_ssp245[1:174,]
    pme3_tv245 = pme3_ssp245[1:174,]
    sst1_tv245 = sst1_ssp245[1:174,]
    sst3_tv245 = sst3_ssp245[1:174,]
    
    pme1_tv245 = trend_fun(pme1_tv245)
    pme3_tv245 = trend_fun(pme3_tv245)
    sst1_tv245 = trend_fun(sst1_tv245)
    sst3_tv245 = trend_fun(sst3_tv245)
    
    pme1_tv245 = pme1_tv245[-naid,]
    pme3_tv245 = pme3_tv245[-naid,]
    sst1_tv245 = sst1_tv245[-naid,]
    sst3_tv245 = sst3_tv245[-naid,]
    
    pme1_pj245 = pme1_ssp245[175:576,]
    pme3_pj245 = pme3_ssp245[175:576,]
    sst1_pj245 = sst1_ssp245[175:576,]
    sst3_pj245 = sst3_ssp245[175:576,]
    
    pme1_pj245 = trend_fun(pme1_pj245)
    pme3_pj245 = trend_fun(pme3_pj245)
    sst1_pj245 = trend_fun(sst1_pj245)
    sst3_pj245 = trend_fun(sst3_pj245)
    
    naid = which(is.na(pme1_pj245[,1]))
    naidfut <<- naid
    
    pme1_pj245 = pme1_pj245[-naid,]
    pme3_pj245 = pme3_pj245[-naid,]
    sst1_pj245 = sst1_pj245[-naid,]
    sst3_pj245 = sst3_pj245[-naid,]
    
    pme1_tv245 <<- pme1_tv245
    pme3_tv245 <<- pme3_tv245
    sst1_tv245 <<- sst1_tv245
    sst3_tv245 <<- sst3_tv245
    
    pme1_pj245 <<- pme1_pj245
    pme3_pj245 <<- pme3_pj245
    sst1_pj245 <<- sst1_pj245
    sst3_pj245 <<- sst3_pj245
    ###############
    j = 1:ncol(sst1_tv245)
    j <<- j
    ssp245_fun <-function(j){
      df = data.frame(
        tws = tws_sw,
        pme1 = pme1_tv245[,j],
        pme3 = pme3_tv245[,j],
        sst1 = sst1_tv245[,j],
        sst3 = sst3_tv245[,j]
      )
      
      df_project = data.frame(
        pme1 = pme1_pj245[,j],
        pme3 = pme3_pj245[,j],
        sst1 = sst1_pj245[,j],
        sst3 = sst3_pj245[,j]
      )
      source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws_cmip6.R')
      ret_box = random_forest_model_tws_cmip6(df,
                                              df_project)
    }
    
    ret245 <- lapply(j,ssp245_fun)
    
    #### 
    # 585
    # ssp585 data
    ###############
    pme1_tv585 = pme1_ssp585[1:174,]
    pme3_tv585 = pme3_ssp585[1:174,]
    sst1_tv585 = sst1_ssp585[1:174,]
    sst3_tv585 = sst3_ssp585[1:174,]
    
    pme1_tv585 = trend_fun(pme1_tv585)
    pme3_tv585 = trend_fun(pme3_tv585)
    sst1_tv585 = trend_fun(sst1_tv585)
    sst3_tv585 = trend_fun(sst3_tv585)
    
    naid = which(is.na(pme1_tv585[,1]))
    pme1_tv585 = pme1_tv585[-naid,]
    pme3_tv585 = pme3_tv585[-naid,]
    sst1_tv585 = sst1_tv585[-naid,]
    sst3_tv585 = sst3_tv585[-naid,]
    
    pme1_pj585 = pme1_ssp585[175:576,]
    pme3_pj585 = pme3_ssp585[175:576,]
    sst1_pj585 = sst1_ssp585[175:576,]
    sst3_pj585 = sst3_ssp585[175:576,]
    
    pme1_pj585 = trend_fun(pme1_pj585)
    pme3_pj585 = trend_fun(pme3_pj585)
    sst1_pj585 = trend_fun(sst1_pj585)
    sst3_pj585 = trend_fun(sst3_pj585)
    
    naidfut = which(is.na(pme1_pj585[,1]))
    naidfut <<- naidfut
    
    pme1_pj585 = pme1_pj585[-naidfut,]
    pme3_pj585 = pme3_pj585[-naidfut,]
    sst1_pj585 = sst1_pj585[-naidfut,]
    sst3_pj585 = sst3_pj585[-naidfut,]
    
    pme1_tv585 <<- pme1_tv585
    pme3_tv585 <<- pme3_tv585
    sst1_tv585 <<- sst1_tv585
    sst3_tv585 <<- sst3_tv585
    
    pme1_pj585 <<- pme1_pj585
    pme3_pj585 <<- pme3_pj585
    sst1_pj585 <<- sst1_pj585
    sst3_pj585 <<- sst3_pj585
    ###############
    j = 1:ncol(sst1_tv585)
    j <<- j
    ssp585_fun <-function(j){
      df = data.frame(
        tws = tws_sw,
        pme1 = pme1_tv585[,j],
        pme3 = pme3_tv585[,j],
        sst1 = sst1_tv585[,j],
        sst3 = sst3_tv585[,j]
      )
      
      df_project = data.frame(
        pme1 = pme1_pj585[,j],
        pme3 = pme3_pj585[,j],
        sst1 = sst1_pj585[,j],
        sst3 = sst3_pj585[,j]
      )
      source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws_cmip6.R')
      ret_box = random_forest_model_tws_cmip6(df,
                                              df_project)
    }
    
    ret585 <- lapply(j,ssp585_fun)
    
    ret_li = list(ret245,ret585)
    return(ret_li)
  }
  
  library(doParallel)
  cl = makeCluster(10)
  clusterExport(cl,c('twsdf','i','sst1_ssp245',
                     'sst3_ssp245','sst1_ssp585',
                     'sst3_ssp585',
                     'pme1_ssp245',
                     'pme1_ssp585',
                     'pme3_ssp245',
                     'pme3_ssp585'))
  ret_df = parLapply(cl,i,sub_train_fun)
  stopCluster(cl)
  
  source('/home/share/R_project/xinjiang_vapor/cor_filter_fun.R')
  cor_mat = cor_filter_fun(ret_df)
  cor_mat <<- cor_mat
  
  i = 1:length(ret_df)
  SW = paste0('SW',1:10)
  SW <<- SW
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  ssp245_proj_extract_fun_mean <-function(i){
    tmpli = ret_df[[i]][[1]]
    j = 1:length(tmpli)
    tmpli <<- tmpli
    sub_fun_ex <-function(j){
      tmpproj = tmpli[[j]][[3]][,2]
      return(tmpproj)
    }
    tmpproj = lapply(j,sub_fun_ex)
    tmpproj = do.call(cbind,tmpproj)
    colnames(tmpproj) = modelnames
    
    tmpcor = as.numeric(cor_mat[,i])
    idless = which(tmpcor >= 0.5)
    tmpproj = tmpproj[,idless]
    
    tmpproj = apply(tmpproj,1,mean,na.rm = T)
    
    date = tmpli[[1]][[3]][,1]
    
    tmpproj = data.frame(date = date,tmpproj)
    tmpproj = reshape2::melt(tmpproj,'date')
    tmpproj$type = SW[i]
    return(tmpproj)
  }
  
  proj_df = lapply(i,ssp245_proj_extract_fun_mean)
  
  projdf = do.call(rbind,proj_df)
  
  i = 1:length(ret_df)
  ssp245_proj_extract_fun_max <-function(i){
    tmpli = ret_df[[i]][[1]]
    j = 1:length(tmpli)
    tmpli <<- tmpli
    sub_fun_ex <-function(j){
      tmpproj = tmpli[[j]][[3]][,2]
      return(tmpproj)
    }
    tmpproj = lapply(j,sub_fun_ex)
    tmpproj = do.call(cbind,tmpproj)
    colnames(tmpproj) = modelnames
    
    tmpcor = as.numeric(cor_mat[,i])
    idless = which(tmpcor >= 0.5)
    tmpproj = tmpproj[,idless]
    
    tmpproj = apply(tmpproj,1,max,na.rm = T)
    
    
    date = tmpli[[1]][[3]][,1]
    
    tmpproj = data.frame(date = date,tmpproj)
    tmpproj = reshape2::melt(tmpproj,'date')
    tmpproj$type = SW[i]
    return(tmpproj)
  }
  
  proj_df_max = lapply(i,ssp245_proj_extract_fun_max)
  
  projdf_max = do.call(rbind,proj_df_max)
  
  i = 1:length(ret_df)
  ssp245_proj_extract_fun_min <-function(i){
    tmpli = ret_df[[i]][[1]]
    j = 1:length(tmpli)
    tmpli <<- tmpli
    sub_fun_ex <-function(j){
      tmpproj = tmpli[[j]][[3]][,2]
      return(tmpproj)
    }
    tmpproj = lapply(j,sub_fun_ex)
    tmpproj = do.call(cbind,tmpproj)
    colnames(tmpproj) = modelnames
    
    tmpcor = as.numeric(cor_mat[,i])
    idless = which(tmpcor >= 0.5)
    tmpproj = tmpproj[,idless]
    
    tmpproj = apply(tmpproj,1,min,na.rm = T)
    
    date = tmpli[[1]][[3]][,1]
    
    tmpproj = data.frame(date = date,tmpproj)
    tmpproj = reshape2::melt(tmpproj,'date')
    tmpproj$type = SW[i]
    return(tmpproj)
  }
  
  proj_df_min = lapply(i,ssp245_proj_extract_fun_min)
  
  projdf_min = do.call(rbind,proj_df_min)
  
  
  projdfmaxmin = data.frame(projdf_max,
                            min = projdf_min$value)
  
  date_proj = unique(projdf_min$date)
  pme1_fut_245 = apply(pme1_ssp245[175:576,],
                       1,mean)
  pme1_fut_245 = trend_fun(pme1_fut_245)
  naid = which(is.na(pme1_fut_245))
  pme1_fut_245 = pme1_fut_245[-naid]
  pme1_fut_245 = data.frame(
    date = date_proj,
    pme1_fut_245
  )
  pme1_fut_245 = reshape2::melt(pme1_fut_245,
                                'date')
  
  pme3_fut_245 = apply(pme3_ssp245[175:576,],
                       1,mean)
  pme3_fut_245 = trend_fun(pme3_fut_245)
  naid = which(is.na(pme3_fut_245))
  pme3_fut_245 = pme3_fut_245[-naid]
  pme3_fut_245 = data.frame(
    date = date_proj,
    pme3_fut_245
  )
  pme3_fut_245 = reshape2::melt(pme3_fut_245,
                                'date')
  pme13_fut_245 = rbind(pme1_fut_245,
                        pme3_fut_245)
  
  
  library(ggsci)
  pal1 = pal_npg(alpha = 1)(8)
  projsw1 = projdf[which(projdf$type == "SW1"),]
  p = ggplot()+
    geom_ribbon(data = projdfmaxmin,
                aes(x = date,ymin = min,
                    ymax = value),
                fill = pal1[2],
                alpha = 0.5)+
    geom_line(data = projdf,aes(x = date,y = value,
                                #color =variable,
                                group = variable),
              size = 0.5,color = pal1[8])+
    #geom_line(data = pme13_fut_245,
    #          aes(x = date,y = value,
    #              color = variable),
    #          size = 1)+
    
    scale_color_manual(values = pal1)+
    facet_wrap(~type,nrow = 2)+
    theme_bw()
  
  p
}
project_tws_along_with_linear_model<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/import_validate_sst.R')
  source('/home/share/R_project/xinjiang_vapor/import_validate_pme_cmip6.R')
  sst = import_validate_sst()
  pme = import_validate_pme_cmip6()
  
  sst_trend = sst
  pme_trend = pme
  #sst_trend = lapply(sst,trend_fun)
  #pme_trend = lapply(pme,trend_fun)
  
  sst1_ssp245 = sst_trend[[1]]
  sst1_ssp585 = sst_trend[[2]]
  sst3_ssp245 = sst_trend[[3]]
  sst3_ssp585 = sst_trend[[4]]
  
  pme1_ssp245 = pme_trend[[1]]
  pme1_ssp585 = pme_trend[[2]]
  pme3_ssp245 = pme_trend[[3]]
  pme3_ssp585 = pme_trend[[4]]
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(sst1_ssp245) = modelnames
  colnames(sst1_ssp585) = modelnames
  colnames(sst3_ssp245) = modelnames
  colnames(sst3_ssp585) = modelnames
  
  colnames(pme1_ssp245) = modelnames
  colnames(pme1_ssp585) = modelnames
  colnames(pme3_ssp245) = modelnames
  colnames(pme3_ssp585) = modelnames
  
  # import tws
  input_tws = 'analysis_output/tws_subwindow_2003_2017.csv'
  tws = fread(input_tws)
  id_box = c(4,7,8,9,10,11,13,14,17,19)
  tws = as.data.frame(tws)
  tws = tws[,-1]
  twsdf = tws[,id_box]
  
  twsdf <<- twsdf
  colnames(twsdf) = paste0('SW',1:10)
  
  sst1_ssp245 <<- sst1_ssp245
  sst1_ssp585 <<- sst1_ssp585
  sst3_ssp245 <<- sst3_ssp245
  sst3_ssp585 <<- sst3_ssp585
  
  pme1_sst245 <<- pme1_ssp245
  pme3_ssp245 <<- pme3_ssp245
  pme1_ssp585 <<- pme1_ssp585
  pme3_ssp585 <<- pme3_ssp585
  
  i = 1:ncol(twsdf)
  i <<- i
  sub_train_fun <-function(i){
    
    tws_sw = twsdf[,i]
    naid = which(is.na(tws_sw))
    tws_sw = tws_sw[-naid]
    tws_sw <<- tws_sw
    
    trend_fun <- function(x){
      
      sub_fun <-function(x){
        x = ts(x,start = c(2003,1),
               frequency = 12)
        x = decompose(x)$trend
        
        xt = as.numeric(x)
        stand_fun <-function(y){
          y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
        }
        xy  = stand_fun(xt)
        return(xy)
      }
      xm = apply(x,2,sub_fun)
      return(xm)
    }
    # sp245 data
    ###############
    pme1_tv245 = pme1_ssp245[1:174,]
    pme3_tv245 = pme3_ssp245[1:174,]
    sst1_tv245 = sst1_ssp245[1:174,]
    sst3_tv245 = sst3_ssp245[1:174,]
    
    pme1_tv245 = trend_fun(pme1_tv245)
    pme3_tv245 = trend_fun(pme3_tv245)
    sst1_tv245 = trend_fun(sst1_tv245)
    sst3_tv245 = trend_fun(sst3_tv245)
    
    pme1_tv245 = pme1_tv245[-naid,]
    pme3_tv245 = pme3_tv245[-naid,]
    sst1_tv245 = sst1_tv245[-naid,]
    sst3_tv245 = sst3_tv245[-naid,]
    
    pme1_pj245 = pme1_ssp245[175:576,]
    pme3_pj245 = pme3_ssp245[175:576,]
    sst1_pj245 = sst1_ssp245[175:576,]
    sst3_pj245 = sst3_ssp245[175:576,]
    
    pme1_pj245 = trend_fun(pme1_pj245)
    pme3_pj245 = trend_fun(pme3_pj245)
    sst1_pj245 = trend_fun(sst1_pj245)
    sst3_pj245 = trend_fun(sst3_pj245)
    
    naid = which(is.na(pme1_pj245[,1]))
    naidfut <<- naid
    
    pme1_pj245 = pme1_pj245[-naid,]
    pme3_pj245 = pme3_pj245[-naid,]
    sst1_pj245 = sst1_pj245[-naid,]
    sst3_pj245 = sst3_pj245[-naid,]
    
    pme1_tv245 <<- pme1_tv245
    pme3_tv245 <<- pme3_tv245
    sst1_tv245 <<- sst1_tv245
    sst3_tv245 <<- sst3_tv245
    
    pme1_pj245 <<- pme1_pj245
    pme3_pj245 <<- pme3_pj245
    sst1_pj245 <<- sst1_pj245
    sst3_pj245 <<- sst3_pj245
    ###############
    j = 1:ncol(sst1_tv245)
    j <<- j
    ssp245_fun <-function(j){
      df = data.frame(
        tws = tws_sw,
        pme1 = pme1_tv245[,j],
        pme3 = pme3_tv245[,j],
        sst1 = sst1_tv245[,j],
        sst3 = sst3_tv245[,j]
      )
      
      df_project = data.frame(
        pme1 = pme1_pj245[,j],
        pme3 = pme3_pj245[,j],
        sst1 = sst1_pj245[,j],
        sst3 = sst3_pj245[,j]
      )
      #source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws_cmip6.R')
      source('/home/share/R_project/xinjiang_vapor/linear_project_model.R')
      ret = linear_project_model(df,df_project)
    }
    
    ret245 <- lapply(j,ssp245_fun)
    
    #### 
    # 585
    # ssp585 data
    ###############
    pme1_tv585 = pme1_ssp585[1:174,]
    pme3_tv585 = pme3_ssp585[1:174,]
    sst1_tv585 = sst1_ssp585[1:174,]
    sst3_tv585 = sst3_ssp585[1:174,]
    
    pme1_tv585 = trend_fun(pme1_tv585)
    pme3_tv585 = trend_fun(pme3_tv585)
    sst1_tv585 = trend_fun(sst1_tv585)
    sst3_tv585 = trend_fun(sst3_tv585)
    
    naid = which(is.na(pme1_tv585[,1]))
    pme1_tv585 = pme1_tv585[-naid,]
    pme3_tv585 = pme3_tv585[-naid,]
    sst1_tv585 = sst1_tv585[-naid,]
    sst3_tv585 = sst3_tv585[-naid,]
    
    pme1_pj585 = pme1_ssp585[175:576,]
    pme3_pj585 = pme3_ssp585[175:576,]
    sst1_pj585 = sst1_ssp585[175:576,]
    sst3_pj585 = sst3_ssp585[175:576,]
    
    pme1_pj585 = trend_fun(pme1_pj585)
    pme3_pj585 = trend_fun(pme3_pj585)
    sst1_pj585 = trend_fun(sst1_pj585)
    sst3_pj585 = trend_fun(sst3_pj585)
    
    naidfut = which(is.na(pme1_pj585[,1]))
    naidfut <<- naidfut
    
    pme1_pj585 = pme1_pj585[-naidfut,]
    pme3_pj585 = pme3_pj585[-naidfut,]
    sst1_pj585 = sst1_pj585[-naidfut,]
    sst3_pj585 = sst3_pj585[-naidfut,]
    
    pme1_tv585 <<- pme1_tv585
    pme3_tv585 <<- pme3_tv585
    sst1_tv585 <<- sst1_tv585
    sst3_tv585 <<- sst3_tv585
    
    pme1_pj585 <<- pme1_pj585
    pme3_pj585 <<- pme3_pj585
    sst1_pj585 <<- sst1_pj585
    sst3_pj585 <<- sst3_pj585
    ###############
    j = 1:ncol(sst1_tv585)
    j <<- j
    ssp585_fun <-function(j){
      df = data.frame(
        tws = tws_sw,
        pme1 = pme1_tv585[,j],
        pme3 = pme3_tv585[,j],
        sst1 = sst1_tv585[,j],
        sst3 = sst3_tv585[,j]
      )
      
      df_project = data.frame(
        pme1 = pme1_pj585[,j],
        pme3 = pme3_pj585[,j],
        sst1 = sst1_pj585[,j],
        sst3 = sst3_pj585[,j]
      )
      source('/home/share/R_project/xinjiang_vapor/linear_project_model.R')
      ret_box = linear_project_model(df,df_project)
    }
    
    ret585 <- lapply(j,ssp585_fun)
    
    ret_li = list(ret245,ret585)
    return(ret_li)
  }
  
  library(doParallel)
  cl = makeCluster(10)
  clusterExport(cl,c('twsdf','i','sst1_ssp245',
                     'sst3_ssp245','sst1_ssp585',
                     'sst3_ssp585',
                     'pme1_ssp245',
                     'pme1_ssp585',
                     'pme3_ssp245',
                     'pme3_ssp585'))
  ret_df = parLapply(cl,i,sub_train_fun)
  stopCluster(cl)
  
  
  i = 1:length(ret_df)
  SW = paste0('SW',1:10)
  SW <<- SW
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  ssp245_proj_extract_fun_mean <-function(i){
    tmpli = ret_df[[i]][[1]]
    j = 1:length(tmpli)
    tmpli <<- tmpli
    sub_fun_ex <-function(j){
      tmpproj = tmpli[[j]][[3]][,2]
      return(tmpproj)
    }
    tmpproj = lapply(j,sub_fun_ex)
    tmpproj = do.call(cbind,tmpproj)
    colnames(tmpproj) = modelnames
    tmpproj = apply(tmpproj,1,mean,na.rm = T)
    
    date = tmpli[[1]][[3]][,1]
    
    tmpproj = data.frame(date = date,tmpproj)
    tmpproj = reshape2::melt(tmpproj,'date')
    tmpproj$type = SW[i]
    return(tmpproj)
  }
  
  proj_df = lapply(i,ssp245_proj_extract_fun_mean)
  
  projdf = do.call(rbind,proj_df)
  
  i = 1:length(ret_df)
  ssp245_proj_extract_fun_max <-function(i){
    tmpli = ret_df[[i]][[1]]
    j = 1:length(tmpli)
    tmpli <<- tmpli
    sub_fun_ex <-function(j){
      tmpproj = tmpli[[j]][[3]][,2]
      return(tmpproj)
    }
    tmpproj = lapply(j,sub_fun_ex)
    tmpproj = do.call(cbind,tmpproj)
    colnames(tmpproj) = modelnames
    tmpproj = apply(tmpproj,1,max,na.rm = T)
    
    date = tmpli[[1]][[3]][,1]
    
    tmpproj = data.frame(date = date,tmpproj)
    tmpproj = reshape2::melt(tmpproj,'date')
    tmpproj$type = SW[i]
    return(tmpproj)
  }
  
  proj_df_max = lapply(i,ssp245_proj_extract_fun_max)
  
  projdf_max = do.call(rbind,proj_df_max)
  
  i = 1:length(ret_df)
  ssp245_proj_extract_fun_min <-function(i){
    tmpli = ret_df[[i]][[1]]
    j = 1:length(tmpli)
    tmpli <<- tmpli
    sub_fun_ex <-function(j){
      tmpproj = tmpli[[j]][[3]][,2]
      return(tmpproj)
    }
    tmpproj = lapply(j,sub_fun_ex)
    tmpproj = do.call(cbind,tmpproj)
    colnames(tmpproj) = modelnames
    tmpproj = apply(tmpproj,1,min,na.rm = T)
    
    date = tmpli[[1]][[3]][,1]
    
    tmpproj = data.frame(date = date,tmpproj)
    tmpproj = reshape2::melt(tmpproj,'date')
    tmpproj$type = SW[i]
    return(tmpproj)
  }
  
  proj_df_min = lapply(i,ssp245_proj_extract_fun_min)
  
  projdf_min = do.call(rbind,proj_df_min)
  
  
  projdfmaxmin = data.frame(projdf_max,
                            min = projdf_min$value)
  
  date_proj = unique(projdf_min$date)
  pme1_fut_245 = apply(pme1_ssp245[175:576,],
                       1,mean)
  pme1_fut_245 = trend_fun(pme1_fut_245)
  naid = which(is.na(pme1_fut_245))
  pme1_fut_245 = pme1_fut_245[-naid]
  pme1_fut_245 = data.frame(
    date = date_proj,
    pme1_fut_245
  )
  pme1_fut_245 = reshape2::melt(pme1_fut_245,
                                'date')
  
  pme3_fut_245 = apply(pme3_ssp245[175:576,],
                       1,mean)
  pme3_fut_245 = trend_fun(pme3_fut_245)
  naid = which(is.na(pme3_fut_245))
  pme3_fut_245 = pme3_fut_245[-naid]
  pme3_fut_245 = data.frame(
    date = date_proj,
    pme3_fut_245
  )
  pme3_fut_245 = reshape2::melt(pme3_fut_245,
                                'date')
  pme13_fut_245 = rbind(pme1_fut_245,
                        pme3_fut_245)
  
  
  library(ggsci)
  pal1 = pal_npg(alpha = 1)(8)
  projsw1 = projdf[which(projdf$type == "SW1"),]
  p = ggplot()+
    geom_ribbon(data = projdfmaxmin,
                aes(x = date,ymin = min,
                    ymax = value),
                fill = pal1[2],
                alpha = 0.5)+
    geom_line(data = projdf,aes(x = date,y = value,
                                #color =variable,
                                group = variable),
              size = 0.5,color = pal1[8])+
    geom_line(data = pme13_fut_245,
              aes(x = date,y = value,
                  color = variable),
              size = 1)+
    
    scale_color_manual(values = pal1)+
    facet_wrap(~type,nrow = 2)+
    theme_bw()
  
  p 
}
project_tws_raster_based_on_era5_cmip6 <- function(
  
){
  library(data.table)
  library(raster)
  library(doParallel)
  
  # era5 model
  dir.create('analysis_output/fig4/pme')
  library(data.table)
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  source('/home/share/R_project/xinjiang_vapor/source_id_identify.R')
  
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:180,]
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:180,]
  
  sst_mean1 = 'era5_sst_mean/ato/region1/era5_sst_mean.csv'
  sst_mean3 = 'era5_sst_mean/ato/region3/era5_sst_mean.csv'
  
  sst1= as.data.frame(fread(sst_mean1))
  sst3 = as.data.frame(fread(sst_mean3))
  
  era5_sst = cbind(sst1,sst3)
  era5_sst = era5_sst[1:174,]
  era5_sst = as.matrix(era5_sst)
  
  era5_pme = pe_in_source[,c(5,7)] - pet_sum[,c(5,7)]
  era5_pme = as.matrix(era5_pme)
  era5_pme = era5_pme[1:174,]
  
  source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
  era5_sst = trend_fun(era5_sst)
  era5_pme = trend_fun(era5_pme)
  
  naid = which(is.na(era5_sst[,1]))
  era5_sst = era5_sst[-naid,]
  era5_pme = era5_pme[-naid,]
  
  era5_pme <<- era5_pme
  era5_sst <<- era5_sst
  
  # import pme1 pme3 cmip6
  input_sst = list.files('analysis_output/cmip6_by_model/sst',
                         full.names = T)
  input_pme = list.files('analysis_output/cmip6_by_model/pme',
                         full.names = T)
  
  
  
  sst = lapply(lapply(input_sst,fread),as.data.frame)
  pme = lapply(lapply(input_pme,fread),as.data.frame)
  
  sst_trend = sst
  pme_trend = pme
  #sst_trend = lapply(sst,trend_fun)
  #pme_trend = lapply(pme,trend_fun)
  
  sst1_ssp245 = sst_trend[[1]]
  sst1_ssp585 = sst_trend[[2]]
  sst3_ssp245 = sst_trend[[3]]
  sst3_ssp585 = sst_trend[[4]]
  
  pme1_ssp245 = pme_trend[[1]]
  pme1_ssp585 = pme_trend[[2]]
  pme3_ssp245 = pme_trend[[3]]
  pme3_ssp585 = pme_trend[[4]]
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(sst1_ssp245) = modelnames
  colnames(sst1_ssp585) = modelnames
  colnames(sst3_ssp245) = modelnames
  colnames(sst3_ssp585) = modelnames
  
  colnames(pme1_ssp245) = modelnames
  colnames(pme1_ssp585) = modelnames
  colnames(pme3_ssp245) = modelnames
  colnames(pme3_ssp585) = modelnames
  
  sst1_ssp245 <<- sst1_ssp245
  sst1_ssp585 <<- sst1_ssp585
  sst3_ssp245 <<- sst3_ssp245
  sst3_ssp585 <<- sst3_ssp585
  
  pme1_sst245 <<- pme1_ssp245
  pme3_ssp245 <<- pme3_ssp245
  pme1_ssp585 <<- pme1_ssp585
  pme3_ssp585 <<- pme3_ssp585
  
  
  # import tws raster
  input_tws_subs = '/media/sdb5/Data/grace_tws_masked'
  input_tws_subs = list.files(input_tws_subs,
                              full.names = T)
  
  cal_ssp_tws <- function(i){
    tmptws = stack(input_tws_subs[i])
    
    twsdf = as.data.frame(tmptws,xy = T)
    naid = which(is.na(twsdf[,3]))
    
    twsdf = twsdf[-naid,]
    loc = twsdf[,1:2]
    twsdf = twsdf[,-c(1,2)]
    
    twsdf = t(twsdf)
    
    j = 1:ncol(twsdf)
    
    train_model <- function(j){
      source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
      tmptwsv = trend_fun(twsdf[,j])
      naid = which(is.na(tmptwsv))
      tmptwsv = tmptwsv[-naid]
      df = data.frame(
        tws = tmptwsv,
        pme3 = era5_pme[,2]
      )
      source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws_era5_cmip6.R')
      system.time(ret <- random_forest_model_tws_era5_cmip6(df))
      ############
      pme3_pj245 = as.matrix(pme3_ssp245[175:576,])
      source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
      pme3_pj245 = trend_fun(pme3_pj245)
      naid = which(is.na(pme3_pj245[,1]))
      pme3_pj245 = pme3_pj245[-naid,]
      
      pme3_pj585 = as.matrix(pme3_ssp585[175:576,])
      source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
      pme3_pj585 = trend_fun(pme3_pj585)
      naid = which(is.na(pme3_pj585[,1]))
      pme3_pj585 = pme3_pj585[-naid,]
      ############
      model_best = ret[[3]]
      tws245b = 1
      tws585b = 1
      for(k in 1:ncol(pme3_pj245)){
        df245 = data.frame(pme3 = pme3_pj245[,k])
        df585 = data.frame(pme3 = pme3_pj585[,k])
        tws245 = predict(model_best,df245)
        tws585 = predict(model_best,df585)
        tws245b = cbind(tws245b,tws245)
        tws585b = cbind(tws585b,tws585)
      }
      tws245b = tws245b[,-1]
      tws585b = tws585b[,-1]
      
      tws245mean = apply(tws245b,1,mean)
      tws585mean = apply(tws585b,1,mean)
      
      source('/home/share/R_project/xinjiang_vapor/mmkTrend.R')
      mmk1 = mmkTrend(tws245mean)
      mmk2 = mmkTrend(tws585mean)
      
      ret = data.frame(
        SST245 = mmk1$Zc,
        SST585 = mmk2$Zc
      )      
      return(ret)
    }

    library(doParallel)
    cl = makeCluster(100)
    clusterExport(cl,c('j','twsdf','era5_pme',
                       'pme3_ssp245','pme3_ssp585'
                       ))
    system.time(retmmk <- parLapply(cl,j,
                                    train_model))
    stopCluster(cl)
    gc()
    
    retmmk = do.call('rbind',retmmk)
    retmmk = data.frame(
      long = loc[,1],
      lat = loc[,2],
      retmmk
    )
    return(retmmk)
  }
  
  i = 1:10
  
  ret_tws = lapply(i,cal_ssp_tws)
  ret_tws = do.call('rbind',ret_tws)
  
  fwrite(ret_tws,'tws_mmk_subs.csv')
  
}
project_tws_raster_based_validate_cmip6<-function(
  
){
  # import tws raster
  input_tws_subs = '/media/sdb5/Data/grace_tws_masked'
  input_tws_subs = list.files(input_tws_subs,
                              full.names = T)
  # import validate cmip6 pme13
  # import validate cmip6 sst13
  source('/home/share/R_project/xinjiang_vapor/import_validate_sst.R')
  source('/home/share/R_project/xinjiang_vapor/import_validate_pme_cmip6.R')
  sst = import_validate_sst()
  pme = import_validate_pme_cmip6()
  
  sst1_ssp245 = sst[[1]]
  sst1_ssp585 = sst[[2]]
  sst3_ssp245 = sst[[3]]
  sst3_ssp585 = sst[[4]]
  
  pme1_ssp245 = pme[[1]]
  pme1_ssp585 = pme[[2]]
  pme3_ssp245 = pme[[3]]
  pme3_ssp585 = pme[[4]]
  
  modelnames = c('ACCESS-ESM1-5',
                 'BCC-CSM2-MR',
                 'CanESM5',
                 'GFDL-ESM4',
                 'IPSL-CM6A-LR',
                 'MIROC6',
                 'MRI-ESM2-0',
                 'NorESM2-LM')
  
  modelnames <<- modelnames
  
  colnames(sst1_ssp245) = modelnames
  colnames(sst1_ssp585) = modelnames
  colnames(sst3_ssp245) = modelnames
  colnames(sst3_ssp585) = modelnames
  
  colnames(pme1_ssp245) = modelnames
  colnames(pme1_ssp585) = modelnames
  colnames(pme3_ssp245) = modelnames
  colnames(pme3_ssp585) = modelnames
  
  sst1_ssp245 <<- sst1_ssp245
  sst1_ssp585 <<- sst1_ssp585
  sst3_ssp245 <<- sst3_ssp245
  sst3_ssp585 <<- sst3_ssp585
  
  pme1_sst245 <<- pme1_ssp245
  pme3_ssp245 <<- pme3_ssp245
  pme1_ssp585 <<- pme1_ssp585
  pme3_ssp585 <<- pme3_ssp585
  
  # training by sub windows
  sub_train_fun_raster245 <- function(i){
    library(raster)
    library(ncdf4)
    # tws raster to df trend
    tws_raster = stack(input_tws_subs[i])
    twsdf = as.data.frame(tws_raster,xy  = T)
    loctws = twsdf[,1:2]
    twsdf = twsdf[,-c(1,2)]
    
    natws = which(is.na(twsdf[,1]))
    twsdf = twsdf[-natws,]
    loctws = loctws[-natws,]
    
    twsdf = t(twsdf)
    trend_fun_hist <- function(x){
      
      sub_fun <-function(x){
        x = ts(x,start = c(2003,1),
               frequency = 12)
        x = decompose(x)$trend
        
        xt = as.numeric(x)
        stand_fun <-function(y){
          y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
        }
        xy  = stand_fun(xt)
        return(xy)
      }
      xm = apply(x,2,sub_fun)
      return(xm)
    }
    trend_fun_fut <- function(x){
      
      sub_fun <-function(x){
        x = ts(x,start = c(2017,7),
               frequency = 12)
        x = decompose(x)$trend
        
        xt = as.numeric(x)
        stand_fun <-function(y){
          y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
        }
        xy  = stand_fun(xt)
        return(xy)
      }
      xm = apply(x,2,sub_fun)
      return(xm)
    }
    
    twsdf_trend = trend_fun_hist(twsdf)
    naidtws = which(is.na(twsdf_trend[,1]))
    twsdf_trend = twsdf_trend[-naidtws,]
    
    # pme and sst data
    ###############
    pme1_tv245 = pme1_ssp245[1:174,]
    pme3_tv245 = pme3_ssp245[1:174,]
    sst1_tv245 = sst1_ssp245[1:174,]
    sst3_tv245 = sst3_ssp245[1:174,]
    
    pme1_tv245 = trend_fun_hist(pme1_tv245)
    pme3_tv245 = trend_fun_hist(pme3_tv245)
    sst1_tv245 = trend_fun_hist(sst1_tv245)
    sst3_tv245 = trend_fun_hist(sst3_tv245)
    
    pme1_tv245 = pme1_tv245[-naid,]
    pme3_tv245 = pme3_tv245[-naid,]
    sst1_tv245 = sst1_tv245[-naid,]
    sst3_tv245 = sst3_tv245[-naid,]
    
    pme1_pj245 = pme1_ssp245[175:576,]
    pme3_pj245 = pme3_ssp245[175:576,]
    sst1_pj245 = sst1_ssp245[175:576,]
    sst3_pj245 = sst3_ssp245[175:576,]
    
    pme1_pj245 = trend_fun_fut(pme1_pj245)
    pme3_pj245 = trend_fun_fut(pme3_pj245)
    sst1_pj245 = trend_fun_fut(sst1_pj245)
    sst3_pj245 = trend_fun_fut(sst3_pj245)
    
    pme1_tv245 <<- pme1_tv245
    pme3_tv245 <<- pme3_tv245
    sst1_tv245 <<- sst1_tv245
    sst3_tv245 <<- sst3_tv245
    
    pme1_pj245 <<- pme1_pj245
    pme3_pj245 <<- pme3_pj245
    sst1_pj245 <<- sst1_pj245
    sst3_pj245 <<- sst3_pj245
    
    ###############
    
    j = 1:ncol(twsdf_trend)
    j <<- j
    
    k = 1:ncol(sst1_tv245)
    k <<- k
    
    sub_project_fun <- function(j){
      tmptws = twsdf_trend[,j]
      
      sub_projct245 <- function(k){
        df = data.frame(
          tws = tmptws,
          pme1 = pme1_tv245[,j],
          pme3 = pme3_tv245[,j],
          sst1 = sst1_tv245[,j],
          sst3 = sst3_tv245[,j]
        )
        df_project = data.frame(
          pme1 = pme1_pj245[,j],
          pme3 = pme3_pj245[,j],
          sst1 = sst1_pj245[,j],
          sst3 = sst3_pj245[,j]
        )
        source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws_cmip6_raster.R')
        ret_box = random_forest_model_tws_cmip6_raster(df,df_project)
        
        return(ret_box)
      }
      ret245 <- lapply(k,sub_projct245)
      ret245 <- do.call('cbind',ret245)
      ret245_mean = apply(ret245,1,mean,na.rm = T)
      ret245_mean = as.numeric(ret245_mean)
      
      source('/home/share/R_project/xinjiang_vapor/mmkTrend.R')
      ret245trend = mmkTrend(ret245_mean)$Zc
      
      return(ret245trend)
      
    }
    
    library(doParallel)
    cl = makeCluster(90)
    clusterExport(cl,c('j','k','twsdf_trend',
                       'pme1_tv245',
                       'pme3_tv245',
                       'sst1_tv245',
                       'sst3_tv245',
                       'pme1_pj245',
                       'pme3_pj245','sst1_pj245',
                       'sst3_pj245'))
    ret_tws245_li = parLapply(cl,j,sub_project_fun)
    stopCluster(cl)
    
    ret_tws245_mmk = do.call('cbind',ret_tws245_li)
    
    ret_mmk = data.frame(
      long = loctws[,1],
      lat = loctws[,2],
      mmk = ret_tws245_mmk
    )
    
    return(ret_mmk)
    
  }
  sub_train_fun_raster585 <- function(i){
    library(raster)
    library(ncdf4)
    # tws raster to df trend
    tws_raster = stack(input_tws_subs[i])
    twsdf = as.data.frame(tws_raster,xy  = T)
    loctws = twsdf[,1:2]
    twsdf = twsdf[,-c(1,2)]
    
    natws = which(is.na(twsdf[,1]))
    twsdf = twsdf[-natws,]
    loctws = loctws[-natws,]
    
    twsdf = t(twsdf)
    trend_fun_hist <- function(x){
      
      sub_fun <-function(x){
        x = ts(x,start = c(2003,1),
               frequency = 12)
        x = decompose(x)$trend
        
        xt = as.numeric(x)
        stand_fun <-function(y){
          y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
        }
        xy  = stand_fun(xt)
        return(xy)
      }
      xm = apply(x,2,sub_fun)
      return(xm)
    }
    trend_fun_fut <- function(x){
      
      sub_fun <-function(x){
        x = ts(x,start = c(2017,7),
               frequency = 12)
        x = decompose(x)$trend
        
        xt = as.numeric(x)
        stand_fun <-function(y){
          y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
        }
        xy  = stand_fun(xt)
        return(xy)
      }
      xm = apply(x,2,sub_fun)
      return(xm)
    }
    
    twsdf_trend = trend_fun_hist(twsdf)
    naidtws = which(is.na(twsdf_trend[,1]))
    twsdf_trend = twsdf_trend[-naidtws,]
    
    # pme and sst data
    ###############
    pme1_tv585 = pme1_ssp585[1:174,]
    pme3_tv585 = pme3_ssp585[1:174,]
    sst1_tv585 = sst1_ssp585[1:174,]
    sst3_tv585 = sst3_ssp585[1:174,]
    
    pme1_tv585 = trend_fun_hist(pme1_tv585)
    pme3_tv585 = trend_fun_hist(pme3_tv585)
    sst1_tv585 = trend_fun_hist(sst1_tv585)
    sst3_tv585 = trend_fun_hist(sst3_tv585)
    
    pme1_tv585 = pme1_tv585[-naid,]
    pme3_tv585 = pme3_tv585[-naid,]
    sst1_tv585 = sst1_tv585[-naid,]
    sst3_tv585 = sst3_tv585[-naid,]
    
    pme1_pj585 = pme1_ssp585[175:576,]
    pme3_pj585 = pme3_ssp585[175:576,]
    sst1_pj585 = sst1_ssp585[175:576,]
    sst3_pj585 = sst3_ssp585[175:576,]
    
    pme1_pj585 = trend_fun_fut(pme1_pj585)
    pme3_pj585 = trend_fun_fut(pme3_pj585)
    sst1_pj585 = trend_fun_fut(sst1_pj585)
    sst3_pj585 = trend_fun_fut(sst3_pj585)
    
    pme1_tv585 <<- pme1_tv585
    pme3_tv585 <<- pme3_tv585
    sst1_tv585 <<- sst1_tv585
    sst3_tv585 <<- sst3_tv585
    
    pme1_pj585 <<- pme1_pj585
    pme3_pj585 <<- pme3_pj585
    sst1_pj585 <<- sst1_pj585
    sst3_pj585 <<- sst3_pj585
    
    ###############
    
    j = 1:ncol(twsdf_trend)
    j <<- j
    
    k = 1:ncol(sst1_tv585)
    k <<- k
    
    sub_project_fun <- function(j){
      tmptws = twsdf_trend[,j]
      
      sub_projct585 <- function(k){
        df = data.frame(
          tws = tmptws,
          pme1 = pme1_tv585[,j],
          pme3 = pme3_tv585[,j],
          sst1 = sst1_tv585[,j],
          sst3 = sst3_tv585[,j]
        )
        df_project = data.frame(
          pme1 = pme1_pj585[,j],
          pme3 = pme3_pj585[,j],
          sst1 = sst1_pj585[,j],
          sst3 = sst3_pj585[,j]
        )
        source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws_cmip6_raster.R')
        ret_box = random_forest_model_tws_cmip6_raster(df,df_project)
        
        return(ret_box)
      }
      ret585 <- lapply(k,sub_projct585)
      ret585 <- do.call('cbind',ret585)
      ret585_mean = apply(ret585,1,mean,na.rm = T)
      ret585_mean = as.numeric(ret585_mean)
      
      source('/home/share/R_project/xinjiang_vapor/mmkTrend.R')
      ret585trend = mmkTrend(ret585_mean)$Zc
      
      return(ret585trend)
      
    }
    
    library(doParallel)
    cl = makeCluster(90)
    clusterExport(cl,c('j','k','twsdf_trend',
                       'pme1_tv585',
                       'pme3_tv585',
                       'sst1_tv585',
                       'sst3_tv585',
                       'pme1_pj585',
                       'pme3_pj585','sst1_pj585',
                       'sst3_pj585'))
    ret_tws585_li = parLapply(cl,j,sub_project_fun)
    stopCluster(cl)
    
    ret_tws585_mmk = do.call('cbind',ret_tws585_li)
    
    ret_mmk = data.frame(
      long = loctws[,1],
      lat = loctws[,2],
      mmk = ret_tws585_mmk
    )
    
    return(ret_mmk)
    
  }
  
  i = 1:10
  i <<- i
  
  retmmk245 = lapply(i,sub_train_fun_raster245)
  retmmk585 = lapply(i,sub_train_fun_raster585)
  # bind the raster 
  retmmk245 = do.call('rbind',retmmk245)
  retmmk585 = do.call('rbind',retmmk585)
  
  output = ''
  outputname = c('twsmmk_fut_245.csv',
                 'twsmmk_fut_585.csv')
  output = paste0(output,'/',outputname)
  fwrite(retmmk245,output[1])
  fwrite(retmmk585,output[2])
  
  
}
project_tws_to_csv <-function(
  ret_df
){
  dir.create('analysis_output/fig4/project_tws_subs')
  output_train = 'analysis_output/fig4/project_tws_subs/train'
  output_valid245 = 'analysis_output/fig4/project_tws_subs/valid245'
  output_valid585 = 'analysis_output/fig4/project_tws_subs/valid585'
  
  output_ssp245 = 'analysis_output/fig4/project_tws_subs/ssp245'
  output_ssp585 = 'analysis_output/fig4/project_tws_subs/ssp585'
  
  dir.create(output_train)
  dir.create(output_valid585)
  dir.create(output_valid245)
  dir.create(output_ssp245)
  dir.create(output_ssp585)
  
  files = paste0('SW',1:10,'.csv')
  output_train = paste0(output_train,'/',
                        files)
  output_valid245 = paste0(output_valid245,'/',
                        files)
  output_valid585 = paste0(output_valid585,'/',
                           files)
  output_ssp245 = paste0(output_ssp245,'/',
                         files)
  output_ssp585 = paste0(output_ssp585,'/',
                         files)
  model_names = c('ACCESS-ESM1-5',
                  'BCC-CSM2-MR',
                  'CanESM5',
                  'GFDL-ESM4',
                  'IPSL-CM6A-LR',
                  'MIROC6',
                  'MRI-ESM2-0',
                  'NorESM2-LM')
  # export train 245 ssp 245 proj
  for(i in 1:10){
    train_box = 1
    obs_box = 1
    for(j in 1:8){
      tmptrain = ret_df[[i]][[1]][[j]][[1]]
      train_box = cbind(train_box,tmptrain[,2])
      obs_box = cbind(obs_box,tmptrain[,1])
    }
    train_box = train_box[,-1]
    colnames(train_box) = model_names
    obs_box = obs_box[,-1]
    obs_box = obs_box[,1]
    train_tws = data.frame(
      tws = obs_box,
      train_box
    )
    fwrite(train_box,output_train[i])
    print(paste0('output: ',output_train[i]))
    
    # export validate ssp 245  
    ssp245_box =1
    obs_box = 1
    for(j in 1:8){
      tmpssp245 = ret_df[[i]][[1]][[j]][[2]]
      ssp245_box = cbind(ssp245_box,tmpssp245[,2])
      obs_box = cbind(obs_box,tmpssp245[,1])
    }    
    ssp245_box = ssp245_box[,-1]
    colnames(ssp245_box)= model_names
    obs_box = obs_box[,-1]
    obs_box = obs_box[,1]
    
    valid_ssp245 = data.frame(
      tws = obs_box,
      ssp245_box
    )
    
    fwrite(valid_ssp245,output_valid245[i])
    print(paste0('output: ',output_valid245[i]))
    
    # export validate ssp 585  
    ssp585_box =1
    obs_box = 1
    for(j in 1:8){
      tmpssp585 = ret_df[[i]][[2]][[j]][[2]]
      ssp585_box = cbind(ssp585_box,tmpssp585[,2])
      obs_box = cbind(obs_box,tmpssp585[,1])
    }    
    ssp585_box = ssp585_box[,-1]
    colnames(ssp585_box)= model_names
    obs_box = obs_box[,-1]
    obs_box = obs_box[,1]
    
    valid_ssp585 = data.frame(
      tws = obs_box,
      ssp585_box
    )
    
    fwrite(valid_ssp585,output_valid585[i])
    print(paste0('output: ',output_valid585[i]))
    
    # export projection ssp 245  
    proj245_box =1
    date_box = 1
    for(j in 1:8){
      tmpproj245 = ret_df[[i]][[1]][[j]][[3]]
      proj245_box = cbind(proj245_box,tmpproj245[,2])
      date_box = cbind(date_box,tmpproj245[,1])
    }    
    proj245_box = proj245_box[,-1]
    colnames(proj245_box)= model_names
    date_box = date_box[,-1]
    date_box = date_box[,1]
    
    proj245 = data.frame(
      date = date_box,
      proj245_box
    )
    
    fwrite(proj245,output_ssp245[i])
    print(paste0('output: ',output_ssp245[i]))
    
    # export projection ssp 245  
    proj585_box =1
    date_box = 1
    for(j in 1:8){
      tmpproj585 = ret_df[[i]][[2]][[j]][[3]]
      proj585_box = cbind(proj585_box,tmpproj585[,2])
      date_box = cbind(date_box,tmpproj585[,1])
    }    
    proj585_box = proj585_box[,-1]
    colnames(proj585_box)= model_names
    date_box = date_box[,-1]
    date_box = date_box[,1]
    
    proj585 = data.frame(
      date = date_box,
      proj585_box
    )
    
    fwrite(proj585,output_ssp585[i])
    print(paste0('output: ',output_ssp585[i]))
    
    
  }
  
  
  
}
random_forest_model_pr_cmip6<-function(
  df,df_project
){
  # libr
  library(randomForest)
  
  set.seed(100)
  id_train = sample(nrow(df),0.7*nrow(df),replace = FALSE)
  #id_train = 1:round(0.7*nrow(df))
  train = df[id_train,]
  test = df[-id_train,]
  
  set.seed(432)
  model_ini = randomForest(pr ~ ., data = train,
                           importance = T,
                           ntree = 500,
                           mtry = 3
                           
  )
  
  # PREDICTING WITH INITIAL MODEL
  pred_train = as.numeric(predict(model_ini,train))
  pred_test =  as.numeric(predict(model_ini,test))
  
  library(caret)
  # tune mtry
  mtry_len = ncol(df)-1
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = 1:mtry_len)
  
  set.seed(432)
  rf_mtry = train(pr ~ .,
                  data = train,
                  method = 'rf',
                  tuneGrid = tuneGrid,
                  trControl = trControl,
                  importance = T
  )
  
  rf_mtry_res = rf_mtry$results[,1:2]
  
  id_mtry = which.min(rf_mtry_res$RMSE)
  
  rf_mtry_best = rf_mtry_res[id_mtry,1]
  
  
  # find number of trees
  
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = rf_mtry_best)
  
  mod_par_cart = 1
  for(ntree in seq(100,1000,100)){
    set.seed(432)
    rf_mtry = train(pr ~ .,
                    data = train,
                    method = 'rf',
                    ntree = ntree,
                    tuneGrid = tuneGrid,
                    trControl = trControl,
                    importance = T
    )
    
    rf_mod = rf_mtry$results[,c(1,2)]
    rf_mod = cbind(rf_mod,ntree)
    mod_par_cart = rbind(mod_par_cart,rf_mod)
  }
  mod_par_cart = mod_par_cart[-1,]
  
  id_best = which.min(mod_par_cart$RMSE)
  
  ntree_best = mod_par_cart[id_best,3]
  
  set.seed(432)
  
  model_best = randomForest(pr ~ ., data = train,
                            importance = T,
                            ntree = ntree_best,
                            mtry = rf_mtry_best
  )
  
  p_train_best = as.numeric(predict(model_best,train))
  p_test_best = as.numeric(predict(model_best,test))
  
  
  
  train_id = 1:(nrow(df)*0.7)
  train_in_order = df[train_id,]
  test_in_order = df[-train_id,]
  
  p_train_in_order = as.numeric(predict(model_best,
                                        train_in_order))
  
  p_test_in_order = as.numeric(predict(model_best,
                                       test_in_order))
  
  
  p_project = as.numeric(predict(model_best,
                                 df_project))
  date = seq(as.Date('2003-01-01'),as.Date('2050-12-01'),'1 month')
  date_proj = date[175:570]
  return(list(data.frame(train_in_order$pr,
                         p_train_in_order),
              data.frame(test_in_order$pr,
                         p_test_in_order),
              data.frame(date = date_proj,
                         pr_project = p_project)))
  
  return(list(data.frame(p_train_in_order),
              data.frame(p_test_in_order),
              data.frame(p_project)))
}










random_forest_model_snowm<-function(
  df 
){
  # libr
  library(randomForest)
  
  set.seed(100)
  id_train = sample(nrow(df),0.7*nrow(df),replace = FALSE)
  
  train = df[id_train,]
  test = df[-id_train,]
  
  set.seed(432)
  model_ini = randomForest(snowm ~ ., data = train,
                           importance = T,
                           ntree = 500,
                           mtry = 3
  )
  
  # PREDICTING WITH INITIAL MODEL
  pred_train = as.numeric(predict(model_ini,train))
  pred_test =  as.numeric(predict(model_ini,test))
  
  library(caret)
  # tune mtry
  mtry_len = ncol(df)-1
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = 1:mtry_len)
  
  set.seed(432)
  rf_mtry = train(snowm ~ .,
                  data = train,
                  method = 'rf',
                  tuneGrid = tuneGrid,
                  trControl = trControl,
                  importance = T)
  
  rf_mtry_res = rf_mtry$results[,1:2]
  
  id_mtry = which.min(rf_mtry_res$RMSE)
  
  rf_mtry_best = rf_mtry_res[id_mtry,1]
  
  
  # find number of trees
  
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = rf_mtry_best)
  
  mod_par_cart = 1
  for(ntree in seq(100,1000,100)){
    set.seed(432)
    rf_mtry = train(snowm ~ .,
                    data = train,
                    method = 'rf',
                    ntree = ntree,
                    tuneGrid = tuneGrid,
                    trControl = trControl,
                    importance = T)
    
    rf_mod = rf_mtry$results[,c(1,3)]
    rf_mod = cbind(rf_mod,ntree)
    mod_par_cart = rbind(mod_par_cart,rf_mod)
  }
  mod_par_cart = mod_par_cart[-1,]
  
  id_best = which.min(mod_par_cart$Rsquared)
  
  ntree_best = mod_par_cart[id_best,3]
  
  set.seed(432)
  
  model_best = randomForest(snowm ~ ., data = train,
                            importance = T,
                            ntree = ntree_best,
                            mtry = rf_mtry_best)
  
  p_train_best = as.numeric(predict(model_best,train))
  p_test_best = as.numeric(predict(model_best,test))
  
  
  
  train_id = 1:(nrow(df)*0.7)
  train_in_order = df[train_id,]
  test_in_order = df[-train_id,]
  
  p_train_in_order = as.numeric(predict(model_best,
                                        train_in_order))
  
  p_test_in_order = as.numeric(predict(model_best,
                                       test_in_order))
  
  
  return(cbind(test_in_order$snowm,
               p_test_in_order))
}










random_forest_model_sst_cmip6<-function(
  df,df_sstoject
){
  # libr
  library(randomForest)
  
  set.seed(100)
  id_train = sample(nrow(df),0.7*nrow(df),replace = FALSE)
  #id_train = 1:round(0.7*nrow(df))
  train = df[id_train,]
  test = df[-id_train,]
  
  set.seed(432)
  model_ini = randomForest(sst ~ ., data = train,
                           importance = T,
                           ntree = 500,
                           mtry = 3
                           
  )
  
  # predictING WITH INITIAL MODEL
  ssted_train = as.numeric(predict(model_ini,train))
  ssted_test =  as.numeric(predict(model_ini,test))
  
  library(caret)
  # tune mtry
  mtry_len = ncol(df)-1
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = 1:mtry_len)
  
  set.seed(432)
  rf_mtry = train(sst ~ .,
                  data = train,
                  method = 'rf',
                  tuneGrid = tuneGrid,
                  trControl = trControl,
                  importance = T
  )
  
  rf_mtry_res = rf_mtry$results[,1:2]
  
  id_mtry = which.min(rf_mtry_res$RMSE)
  
  rf_mtry_best = rf_mtry_res[id_mtry,1]
  
  
  # find number of trees
  
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = rf_mtry_best)
  
  mod_par_cart = 1
  for(ntree in seq(100,1000,100)){
    set.seed(432)
    rf_mtry = train(sst ~ .,
                    data = train,
                    method = 'rf',
                    ntree = ntree,
                    tuneGrid = tuneGrid,
                    trControl = trControl,
                    importance = T
    )
    
    rf_mod = rf_mtry$results[,c(1,2)]
    rf_mod = cbind(rf_mod,ntree)
    mod_par_cart = rbind(mod_par_cart,rf_mod)
  }
  mod_par_cart = mod_par_cart[-1,]
  
  id_best = which.min(mod_par_cart$RMSE)
  
  ntree_best = mod_par_cart[id_best,3]
  
  set.seed(432)
  
  model_best = randomForest(sst ~ ., data = train,
                            importance = T,
                            ntree = ntree_best,
                            mtry = rf_mtry_best
  )
  
  p_train_best = as.numeric(predict(model_best,train))
  p_test_best = as.numeric(predict(model_best,test))
  
  
  
  train_id = 1:(nrow(df)*0.7)
  train_in_order = df[train_id,]
  test_in_order = df[-train_id,]
  
  p_train_in_order = as.numeric(predict(model_best,
                                        train_in_order))
  
  p_test_in_order = as.numeric(predict(model_best,
                                       test_in_order))
  
  
  p_sstoject = as.numeric(predict(model_best,
                                 df_sstoject))
  date = seq(as.Date('2003-01-01'),as.Date('2050-12-01'),'1 month')
  date_sstoj = date[175:570]
  return(list(data.frame(train_in_order$sst,
                         p_train_in_order),
              data.frame(test_in_order$sst,
                         p_test_in_order),
              data.frame(date = date_sstoj,
                         sst_sstoject = p_sstoject)))
  
  return(list(data.frame(p_train_in_order),
              data.frame(p_test_in_order),
              data.frame(p_sstoject)))
}










random_forest_model_test<-function(
  df 
){
  # libr
  library(randomForest)
  
  set.seed(100)
  id_train = sample(nrow(df),0.7*nrow(df),replace = FALSE)
  
  train = df[id_train,]
  test = df[-id_train,]
  
  set.seed(432)
  model_ini = randomForest(gpcc_pr ~ ., data = train,
                           importance = T,
                           ntree = 500,
                           mtry = 3
                           )
  
  # PREDICTING WITH INITIAL MODEL
  pred_train = as.numeric(predict(model_ini,train))
  pred_test =  as.numeric(predict(model_ini,test))
  
  library(caret)
  # tune mtry
  mtry_len = ncol(df)-1
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = 1:mtry_len)
  
  set.seed(432)
  rf_mtry = train(gpcc_pr ~ .,
                  data = train,
                  method = 'rf',
                  tuneGrid = tuneGrid,
                  trControl = trControl,
                  importance = T)
  
  rf_mtry_res = rf_mtry$results[,1:2]
  
  id_mtry = which.min(rf_mtry_res$RMSE)
  
  rf_mtry_best = rf_mtry_res[id_mtry,1]
  
  
  # find number of trees
  
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = rf_mtry_best)
  
  mod_par_cart = 1
  for(ntree in seq(100,1000,100)){
    set.seed(432)
    rf_mtry = train(gpcc_pr ~ .,
                    data = train,
                    method = 'rf',
                    ntree = ntree,
                    tuneGrid = tuneGrid,
                    trControl = trControl,
                    importance = T)
    
    rf_mod = rf_mtry$results[,c(1,3)]
    rf_mod = cbind(rf_mod,ntree)
    mod_par_cart = rbind(mod_par_cart,rf_mod)
  }
  mod_par_cart = mod_par_cart[-1,]
  
  id_best = which.min(mod_par_cart$Rsquared)
  
  ntree_best = mod_par_cart[id_best,3]
  
  set.seed(432)
  
  model_best = randomForest(gpcc_pr ~ ., data = train,
                            importance = T,
                            ntree = ntree_best,
                            mtry = rf_mtry_best)
  
  p_train_best = as.numeric(predict(model_best,train))
  p_test_best = as.numeric(predict(model_best,test))
  
  
  
  train_id = 1:(nrow(df)*0.7)
  train_in_order = df[train_id,]
  test_in_order = df[-train_id,]
  
  p_train_in_order = as.numeric(predict(model_best,
                             train_in_order))
  
  p_test_in_order = as.numeric(predict(model_best,
                                       test_in_order))
  
  
  return(cbind(test_in_order$gpcc_pr,
               p_test_in_order))
}










random_forest_model_tws_cmip6_raster<-function(
  df,df_project
){
  # libr
  library(randomForest)
  
  set.seed(100)
  id_train = sample(nrow(df),0.7*nrow(df),replace = FALSE)
  #id_train = 1:round(0.7*nrow(df))
  train = df[id_train,]
  test = df[-id_train,]
  
  set.seed(432)
  model_ini = randomForest(tws ~ ., data = train,
                           importance = T,
                           ntree = 500,
                           mtry = 3
                           
  )
  
  # PREDICTING WITH INITIAL MODEL
  pred_train = as.numeric(predict(model_ini,train))
  pred_test =  as.numeric(predict(model_ini,test))
  
  library(caret)
  # tune mtry
  mtry_len = ncol(df)-1
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = 1:mtry_len)
  
  set.seed(432)
  rf_mtry = train(tws ~ .,
                  data = train,
                  method = 'rf',
                  tuneGrid = tuneGrid,
                  trControl = trControl,
                  importance = T
  )
  
  rf_mtry_res = rf_mtry$results[,1:2]
  
  id_mtry = which.min(rf_mtry_res$RMSE)
  
  rf_mtry_best = rf_mtry_res[id_mtry,1]
  
  
  # find number of trees
  
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = rf_mtry_best)
  
  mod_par_cart = 1
  for(ntree in seq(100,1000,100)){
    set.seed(432)
    rf_mtry = train(tws ~ .,
                    data = train,
                    method = 'rf',
                    ntree = ntree,
                    tuneGrid = tuneGrid,
                    trControl = trControl,
                    importance = T
    )
    
    rf_mod = rf_mtry$results[,c(1,2)]
    rf_mod = cbind(rf_mod,ntree)
    mod_par_cart = rbind(mod_par_cart,rf_mod)
  }
  mod_par_cart = mod_par_cart[-1,]
  
  id_best = which.min(mod_par_cart$RMSE)
  
  ntree_best = mod_par_cart[id_best,3]
  
  set.seed(432)
  
  model_best = randomForest(tws ~ ., data = train,
                            importance = T,
                            ntree = ntree_best,
                            mtry = rf_mtry_best
  )
  
  p_train_best = as.numeric(predict(model_best,train))
  p_test_best = as.numeric(predict(model_best,test))
  
  
  tws_project = as.numeric(predict(model_best,
                                 df_project))
  
  
  return(tws_project)
  
}










random_forest_model_tws_cmip6<-function(
  df,df_project
){
  # libr
  library(randomForest)
  
  set.seed(100)
  id_train = sample(nrow(df),0.7*nrow(df),replace = FALSE)
  #id_train = 1:round(0.7*nrow(df))
  train = df[id_train,]
  test = df[-id_train,]
  
  set.seed(432)
  model_ini = randomForest(tws ~ ., data = train,
                           importance = T,
                           ntree = 500,
                           mtry = 3
                           
  )
  
  # PREDICTING WITH INITIAL MODEL
  pred_train = as.numeric(predict(model_ini,train))
  pred_test =  as.numeric(predict(model_ini,test))
  
  library(caret)
  # tune mtry
  mtry_len = ncol(df)-1
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = 1:mtry_len)
  
  set.seed(432)
  rf_mtry = train(tws ~ .,
                  data = train,
                  method = 'rf',
                  tuneGrid = tuneGrid,
                  trControl = trControl,
                  importance = T
  )
  
  rf_mtry_res = rf_mtry$results[,1:2]
  
  id_mtry = which.min(rf_mtry_res$RMSE)
  
  rf_mtry_best = rf_mtry_res[id_mtry,1]
  
  
  # find number of trees
  
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = rf_mtry_best)
  
  mod_par_cart = 1
  for(ntree in seq(100,1000,100)){
    set.seed(432)
    rf_mtry = train(tws ~ .,
                    data = train,
                    method = 'rf',
                    ntree = ntree,
                    tuneGrid = tuneGrid,
                    trControl = trControl,
                    importance = T
    )
    
    rf_mod = rf_mtry$results[,c(1,2)]
    rf_mod = cbind(rf_mod,ntree)
    mod_par_cart = rbind(mod_par_cart,rf_mod)
  }
  mod_par_cart = mod_par_cart[-1,]
  
  id_best = which.min(mod_par_cart$RMSE)
  
  ntree_best = mod_par_cart[id_best,3]
  
  set.seed(432)
  
  model_best = randomForest(tws ~ ., data = train,
                            importance = T,
                            ntree = ntree_best,
                            mtry = rf_mtry_best
  )
  
  p_train_best = as.numeric(predict(model_best,train))
  p_test_best = as.numeric(predict(model_best,test))
  
  
  
  train_id = 1:(nrow(df)*0.7)
  train_in_order = df[train_id,]
  test_in_order = df[-train_id,]
  
  p_train_in_order = as.numeric(predict(model_best,
                                        train_in_order))
  
  p_test_in_order = as.numeric(predict(model_best,
                                       test_in_order))
  
  
  p_project = as.numeric(predict(model_best,
                                 df_project))
  date = seq(as.Date('2003-01-01'),as.Date('2050-12-01'),'1 month')
  
  date_proj = date[175:576]
  a = ts(175:576,start = c(2017,7),
         frequency = 12)
  a = decompose(a)$trend
  naidfut = which(is.na(a))
  
  date_proj = date_proj[-naidfut]
  
  
  return(list(data.frame(train_in_order$tws,
                    p_train_in_order),
              data.frame(test_in_order$tws,
                    p_test_in_order),
              data.frame(date = date_proj,
                         tws_project = p_project)))
  
  return(list(data.frame(p_train_in_order),
              data.frame(p_test_in_order),
              data.frame(p_project)))
}










random_forest_model_tws_era5_cmip6<-function(
  df
){
  # libr
  library(randomForest)
  
  set.seed(100)
  id_train = sample(nrow(df),0.7*nrow(df),replace = FALSE)
  #id_train = 1:round(0.7*nrow(df))
  train = df[id_train,]
  test = df[-id_train,]
  
  set.seed(432)
  model_ini = randomForest(tws ~ ., data = train,
                           importance = T,
                           ntree = 500,
                           mtry = 3
                           
  )
  
  # PREDICTING WITH INITIAL MODEL
  pred_train = as.numeric(predict(model_ini,train))
  pred_test =  as.numeric(predict(model_ini,test))
  
  library(caret)
  # tune mtry
  mtry_len = ncol(df)-1
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = 1:mtry_len)
  
  set.seed(432)
  rf_mtry = train(tws ~ .,
                  data = train,
                  method = 'rf',
                  tuneGrid = tuneGrid,
                  trControl = trControl,
                  importance = T
  )
  
  rf_mtry_res = rf_mtry$results[,1:2]
  
  id_mtry = which.min(rf_mtry_res$RMSE)
  
  rf_mtry_best = rf_mtry_res[id_mtry,1]
  
  
  # find number of trees
  
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = rf_mtry_best)
  
  mod_par_cart = 1
  for(ntree in seq(100,1000,100)){
    set.seed(432)
    rf_mtry = train(tws ~ .,
                    data = train,
                    method = 'rf',
                    ntree = ntree,
                    tuneGrid = tuneGrid,
                    trControl = trControl,
                    importance = T
    )
    
    rf_mod = rf_mtry$results[,c(1,2)]
    rf_mod = cbind(rf_mod,ntree)
    mod_par_cart = rbind(mod_par_cart,rf_mod)
  }
  mod_par_cart = mod_par_cart[-1,]
  
  id_best = which.min(mod_par_cart$RMSE)
  
  ntree_best = mod_par_cart[id_best,3]
  
  set.seed(432)
  
  model_best = randomForest(tws ~ ., data = train,
                            importance = T,
                            ntree = ntree_best,
                            mtry = rf_mtry_best
  )
  
  p_train_best = as.numeric(predict(model_best,train))
  p_test_best = as.numeric(predict(model_best,test))
  
  
  
  train_id = 1:(nrow(df)*0.7)
  train_in_order = df[train_id,]
  test_in_order = df[-train_id,]
  
  p_train_in_order = as.numeric(predict(model_best,
                                        train_in_order))
  
  p_test_in_order = as.numeric(predict(model_best,
                                       test_in_order))
  
  
  return(list(data.frame(train_in_order$tws,
                         p_train_in_order),
              data.frame(test_in_order$tws,
                         p_test_in_order),
              model_best))
  
  return(list(data.frame(p_train_in_order),
              data.frame(p_test_in_order),
              data.frame(p_project)))
}










random_forest_model_tws<-function(
  df,df_project
){
  # libr
  library(randomForest)
  
  set.seed(100)
  id_train = sample(nrow(df),0.7*nrow(df),replace = FALSE)
  #id_train = 1:round(0.7*nrow(df))
  train = df[id_train,]
  test = df[-id_train,]
  
  set.seed(432)
  model_ini = randomForest(tws ~ ., data = train,
                           importance = T,
                           ntree = 500,
                           mtry = 3
                           
  )
  
  # PREDICTING WITH INITIAL MODEL
  pred_train = as.numeric(predict(model_ini,train))
  pred_test =  as.numeric(predict(model_ini,test))
  
  library(caret)
  # tune mtry
  mtry_len = ncol(df)-1
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = 1:mtry_len)
  
  set.seed(432)
  rf_mtry = train(tws ~ .,
                  data = train,
                  method = 'rf',
                  tuneGrid = tuneGrid,
                  trControl = trControl,
                  importance = T
                  )
  
  rf_mtry_res = rf_mtry$results[,1:2]
  
  id_mtry = which.min(rf_mtry_res$RMSE)
  
  rf_mtry_best = rf_mtry_res[id_mtry,1]
  
  
  # find number of trees
  
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = rf_mtry_best)
  
  mod_par_cart = 1
  for(ntree in seq(100,1000,100)){
    set.seed(432)
    rf_mtry = train(tws ~ .,
                    data = train,
                    method = 'rf',
                    ntree = ntree,
                    tuneGrid = tuneGrid,
                    trControl = trControl,
                    importance = T
                    )
    
    rf_mod = rf_mtry$results[,c(1,2)]
    rf_mod = cbind(rf_mod,ntree)
    mod_par_cart = rbind(mod_par_cart,rf_mod)
  }
  mod_par_cart = mod_par_cart[-1,]
  
  id_best = which.min(mod_par_cart$RMSE)
  
  ntree_best = mod_par_cart[id_best,3]
  
  set.seed(432)
  
  model_best = randomForest(tws ~ ., data = train,
                            importance = T,
                            ntree = ntree_best,
                            mtry = rf_mtry_best
                            )
  
  p_train_best = as.numeric(predict(model_best,train))
  p_test_best = as.numeric(predict(model_best,test))
  
  
  
  train_id = 1:(nrow(df)*0.7)
  train_in_order = df[train_id,]
  test_in_order = df[-train_id,]
  
  p_train_in_order = as.numeric(predict(model_best,
                                        train_in_order))
  
  p_test_in_order = as.numeric(predict(model_best,
                                       test_in_order))
  
  
  p_project = as.numeric(predict(model_best,
                                 df_project))
  return(list(cbind(train_in_order$tws,
               p_train_in_order),
              cbind(test_in_order$tws,
                    p_test_in_order)))
  
  return(list(data.frame(p_train_in_order),
              data.frame(p_test_in_order),
              data.frame(p_project)))
}










re_order_cmip6_ep_sum<-function(
  mode
){
  #reorder cmip6 ep sum by model
  model_name = c('ACCESS-ESM1-5','BCC-CSM2-MR',
                 'CanESM5','GFDL-ESM4','IPSL-CM6A-LR',
                 'MIROC6','MRI-ESM2-0','NorESM2-LM')
  
  # input ep of cmip6
  input = 'cmip6_ep_sum'
  source_name = c('as','ato','eu')
  
  input1 = paste0(input,'/',source_name)
  input2 = paste0(input1,'/',mode)
  input3 = rep(input2,each = 4)
  region = paste0('region',1:4)
  
  input3 = paste0(input3,'/',rep(region,3))
  
  list_fun <-function(x){
    x = list.files(x,full.names = T)
  }
  input3 = lapply(input3,list_fun) 
  input3 = do.call(c,input3)
  
  print(input3)
  
  cmip6 = lapply(input3,fread)
  cmip6 = lapply(cmip6,as.data.frame)
  
  cmip6 = do.call(cbind,cmip6)
  
  model1_id = seq(1,ncol(cmip6),8)
  model2_id = seq(2,ncol(cmip6),8)
  model3_id = seq(3,ncol(cmip6),8)
  model4_id = seq(4,ncol(cmip6),8)
  model5_id = seq(5,ncol(cmip6),8)
  model6_id = seq(6,ncol(cmip6),8)
  model7_id = seq(7,ncol(cmip6),8)
  model8_id = seq(8,ncol(cmip6),8)
  
  model1 = cmip6[,model1_id]
  model2 = cmip6[,model2_id]
  model3 = cmip6[,model3_id]
  model4 = cmip6[,model4_id]
  model5 = cmip6[,model5_id]
  model6 = cmip6[,model6_id]
  model7 = cmip6[,model7_id]
  model8 = cmip6[,model8_id]
  
  
  colnames = paste0(rep(c('as','ato','eu'),each = 4),1:4)
  
  if(mode == 'hist_ssp585'){
    colnames = colnames[1:11]
  }
  
  colnames(model1) = colnames
  colnames(model2) = colnames
  colnames(model3) = colnames
  colnames(model4) = colnames
  colnames(model5) = colnames
  colnames(model6) = colnames
  colnames(model7) = colnames
  colnames(model8) = colnames
  
  # output 
  #######
  output = 'cmip6_ep_sum_by_model'
  dir.create(output)
  output = paste0(output,'/',mode)
  lapply(output,dir.create)
  
  output2 = rep(output,each = length(model_name))
  output2 = paste0(output2,'/',model_name)
  lapply(output2,dir.create)
 
  output2 = paste0(output2,'/ep_sum.csv')
  
  models = list(model1,model2,
                model3,model4,
                model5,model6,model7,model8)
  
  output2 <<- output2
  models <<- models
  output_fun<-function(i){
    fwrite(models[[i]],output2[i])
  }
  i = 1:8
  lapply(i,output_fun)
}






re_preprocess_cmip6_ssp585<-function(
  
){
  attrs = c('E','Pr','T')
  source('/home/share/R_project/xinjiang_vapor/filter_cmip6_data_to_date.R')
  filter_cmip6_data_to_date('E')
  filter_cmip6_data_to_date('Pr')
  filter_cmip6_data_to_date('T')
  print('Pass filter')

  source('/home/share/R_project/xinjiang_vapor/combine_cmip6_data_his_ssp.R')
  combine_cmip6_data_his_ssp('E')
  combine_cmip6_data_his_ssp('Pr')
  combine_cmip6_data_his_ssp('T')
  
  print('Pass combine')
  
  source('/home/share/R_project/xinjiang_vapor/adjust_extent_cmip6_hist_ssp585.R')
  adjust_extent_cmip6_hist_ssp585()
  print('pass adjust')
  
  #mask and crop 
  source('/home/share/R_project/xinjiang_vapor/mask_crop_cmip6_ssp585.R')
  mode =c('ato','as','eu')
  #source('/home/share/R_project/xinjiang_vapor/mask_crop_cmip6.R')
  system.time(mask_crop_cmip6_ssp585(mode[1]))
  system.time(mask_crop_cmip6_ssp585(mode[2]))
  system.time(mask_crop_cmip6_ssp585(mode[3]))
  
  print('pass mask')
  
  # cal ep 
  source('/home/share/R_project/xinjiang_vapor/cal_sum_ep_ssp585.R')
  cal_sum_ep_hist_ssp585(mode[1])
  cal_sum_ep_hist_ssp585(mode[2])
  cal_sum_ep_hist_ssp585(mode[3])
  
  # reorder
  source('/home/share/R_project/xinjiang_vapor/re_order_cmip6_ep_sum.R')
  mode = c('hist_ssp585')
  re_order_cmip6_ep_sum(mode)
  print('pass regroup files')
  
  # cal temperature based ssp585
  models = c('ACCESS-ESM1-5','BCC-CSM2-MR',
             'CanESM5','GFDL-ESM4','IPSL-CM6A-LR',
             'MIROC6','MRI-ESM2-0','NorESM2-LM')
  pattern2 = rep('hist_ssp585',8)
  mapply(cal_temp_in_each_region_based_cmip6,models,pattern2)
  print('pass temper')
  
  
}
released_total_var<-function(
  
){
  input = list.files('/media/sdb1/xinjiang_output_file/',full.names = T)
  input = paste0(input,'/output/total_released.csv')
  
  rtb = 1
  for(i in 1:length(input)){
    tmp = read.csv(input[i],header = T)
    rtb = rbind(rtb,tmp)
  }
  rtb = rtb[-1,]
  rtb = rtb[,-1]
  
  write.csv(rtb,'analysis_output/total_released_03_17.csv')
  
}
search_which_cl_tr <- function(x)
{
  xs = x[1]
  xe = x[length(x)]
  
  xsl <<- which(xfull == xs)[1]
  xel = which(xfull == xe)
  xel = xel[length(xel)]
  
  xes <<- xfull[xsl:xel]
  select_first_loc<-function(id){
    tmpmark = which(xes == id)
    return(tmpmark)
  }
  
  ret_id = lapply(x,select_first_loc)
  
  
  mean_long_cal<-function(id){
    id = id+xsl -1
    longtmp = df_full_for_cl[id,1]
    
    if(length(longtmp)<38){
      lentmp = length(longtmp)
      lack = 38 - lentmp
      longtmp = c(rep(NA,lack),longtmp)
    }else if(length(longtmp)>38){
      len = length(longtmp)/2
      longtmp = longtmp[1:len]
    }
    return(longtmp)
  }
  
  mean_lat_cal<-function(id){
    id = id+xsl -1
    lattmp = df_full_for_cl[id,2]
    if(length(lattmp)<38){
      lentmp = length(lattmp)
      lack = 38 - lentmp
      lattmp = c(rep(NA,lack),lattmp)
    }else if(length(lattmp)>38){
      len = length(lattmp)/2
      lattmp = lattmp[1:len]
    }
    return(lattmp)
  }
  
  mean_hei_cal<-function(id){
    id = id+xsl -1
    heitmp = df_full_for_cl[id,3]
    if(length(heitmp)<38){
      lentmp = length(heitmp)
      lack = 38 - lentmp
      heitmp = c(rep(NA,lack),heitmp)
    }else if(length(heitmp)>38){
      len = length(heitmp)/2
      heitmp = heitmp[1:len]
    }
    return(heitmp)
  }
  
  mean_fun<-function(x){
    x = mean(x,na.rm = T)
    return(x)
  }
  longb = lapply(ret_id,mean_long_cal)

  
  longb = do.call('rbind',longb)
  #print('pass here')
  latb = lapply(ret_id,mean_lat_cal)
  latb = do.call('rbind',latb)
  #print('pass here2')
  heib = lapply(ret_id,mean_hei_cal)
  heib = do.call('rbind',heib)
  #print('pass here3')
  #return(list(longb,latb,heib))
  
  longb = apply(longb,2,mean_fun)
  latb = apply(latb,2,mean_fun)
  heib = apply(heib,2,mean_fun)
  
  ret_box = data.frame(mean_long = longb,
                       mean_lat = latb,
                       mean_height = heib)
    
  
  
  
  #print(length(unique(ret_box)))
  return(ret_box)
  
}
search_which_full_acc1_cloud <- function(x)
{
  xs = x[1]
  xe = x[length(x)]
  
  #source('/home/share/R_project/xinjiang_vapor/mask_via_each_ocean_for_contri_cal_cloud.R')
  #source('/home/share/R_project/xinjiang_vapor/mask_points_solo_shp_cloud.R')
  
  dir.create('tmp')
  # in ocean
  input_tmp_masdf = 'tmp/tmp_mas_df.csv'
  input_tmp_masdfr = 'tmp/tmp_mas_df_r.csv'
  
  mas_df = fread(input_tmp_masdf)
  
  xfull1 = mas_df$type
  xsl1 = which(xfull1 == xs)[1]
  xel1 = which(xfull1 == xe)
  xel1 = xel1[length(xel1)]
  
  xes1 <<- xfull1[xsl1:xel1]
  df_sce1<<- mas_df[xsl1:xel1,] # in ocean
  rm(mas_df)
  
  print('pass here')
  cal_dep_for_each_p_in_source<-function(id){
    #print(id)
    library(raster)
    library(data.table)
    tmpmark = which(xes1 == id)
    df_sce1 = data.table(df_sce1[tmpmark,])
    # in source region
    #print(df_sce)
    #print(shp_ocean)
    df_source_var = sum(df_sce1$varep)
    
    ret = data.table(df_sce1[1,1:3],df_sce1[1,5])
    ret$varep_insource = df_source_var
    #ret_first_row$var_contr = df_var_contr
    #ret_first_row$names = names
    return(ret)
  }
  
  ret_in_source = lapply(x,cal_dep_for_each_p_in_source)
  ret_in_source = do.call('rbind',ret_in_source)
  
  fwrite(ret_in_source,'tmp/ret_insource.csv')
  rm(ret_in_source)
  
  
  mas_df_route = fread(input_tmp_masdfr)
  
  xfull1 = mas_df_route$type
  xsl1 = which(xfull1 == xs)[1]
  xel1 = which(xfull1 == xe)
  xel1 = xel1[length(xel1)]
  
  xes1 <<- xfull1[xsl1:xel1]
  df_sce1<<- mas_df_route[xsl1:xel1,] # in ocean
  
  ret_in_route = lapply(x,cal_dep_for_each_p_in_source)
  ret_in_route = do.call('rbind',ret_in_route)
  
  ret_in_source  = fread('tmp/ret_insource.csv')
  
  ret_contri = data.frame(long = ret_in_source[,1],
                          lat = ret_in_source[,2],
                          height = ret_in_source[,3],
                          type = ret_in_source[,4],
                          net_ep_ocean = ret_in_source[,5] - abs(ret_in_route[,5]))
  
  rm(ret_in_source)
  rm(ret_in_route)
  rm(df_sce1)
  #print(nrow(ret_in_route))
  #print(nrow(ret_in_source))
  return(ret_contri)
  
}
search_which_full_acc1 <- function(x)
{
  xs = x[1]
  xe = x[length(x)]
  
  source('/home/share/R_project/xinjiang_vapor/mask_via_each_ocean_for_contri_cal.R')
  source('/home/share/R_project/xinjiang_vapor/mask_points_solo_shp.R')
  
  # in ocean
  input_tmp_masdf = 'tmp/tmp_mas_df.csv'
  input_tmp_masdfr = 'tmp/tmp_mas_df_r.csv'
  
  mas_df = fread(input_tmp_masdf)
  
  xfull1 = mas_df$type
  xsl1 = which(xfull1 == xs)[1]
  xel1 = which(xfull1 == xe)
  xel1 = xel1[length(xel1)]
  
  xes1 <<- xfull1[xsl1:xel1]
  df_sce1<<- mas_df[xsl1:xel1,] # in ocean
  rm(mas_df)
  
  print('pass here')
  cal_dep_for_each_p_in_source<-function(id){
    #print(id)
    library(raster)
    library(data.table)
    tmpmark = which(xes1 == id)
    df_sce1 = data.table(df_sce1[tmpmark,])
    # in source region
    #print(df_sce)
    #print(shp_ocean)
    df_source_var = sum(df_sce1$varep)
    
    ret = data.table(df_sce1[1,1:3],df_sce1[1,5])
    ret$varep_insource = df_source_var
    #ret_first_row$var_contr = df_var_contr
    #ret_first_row$names = names
    return(ret)
  }
  
  ret_in_source = lapply(x,cal_dep_for_each_p_in_source)
  ret_in_source = do.call('rbind',ret_in_source)
  
  fwrite(ret_in_source,'tmp/ret_insource.csv')
  rm(ret_in_source)
  
  
  mas_df_route = fread(input_tmp_masdfr)
  
  xfull1 = mas_df_route$type
  xsl1 = which(xfull1 == xs)[1]
  xel1 = which(xfull1 == xe)
  xel1 = xel1[length(xel1)]
  
  xes1 <<- xfull1[xsl1:xel1]
  df_sce1<<- mas_df_route[xsl1:xel1,] # in ocean
  
  ret_in_route = lapply(x,cal_dep_for_each_p_in_source)
  ret_in_route = do.call('rbind',ret_in_route)
  
  ret_in_source  = fread('tmp/ret_insource.csv')
  
  ret_contri = data.frame(long = ret_in_source[,1],
                         lat = ret_in_source[,2],
                         height = ret_in_source[,3],
                         type = ret_in_source[,4],
                         net_ep_ocean = ret_in_source[,5] - abs(ret_in_route[,5]))
  
  rm(ret_in_source)
  rm(ret_in_route)
  rm(df_sce1)
  #print(nrow(ret_in_route))
  #print(nrow(ret_in_source))
  return(ret_contri)
  
}
search_which_full_as_bu_xinjiang_cloud <- function(x)
{
  xs = x[1]
  xe = x[length(x)]
  
  #source('/home/share/R_project/xinjiang_vapor/mask_via_each_ocean_for_contri_cal.R')
  #source('/home/share/R_project/xinjiang_vapor/mask_points_solo_shp.R')
  
  # in ocean
  input_tmp_masdf = 'tmp/tmp_mas_df.csv'
  mas_df = fread(input_tmp_masdf)
  
  xfull1 = mas_df$type
  xsl1 = which(xfull1 == xs)[1]
  xel1 = which(xfull1 == xe)
  xel1 = xel1[length(xel1)]
  
  xes1 <<- xfull1[xsl1:xel1]
  df_sce1<<- mas_df[xsl1:xel1,] # in ocean
  
  rm(mas_df)
  
  print('pass here')
  cal_dep_for_each_p_in_source<-function(id){
    #print(id)
    library(raster)
    library(data.table)
    tmpmark = which(xes1 == id)
    df_sce1 = data.table(df_sce1[tmpmark,])
    # in source region
    #print(df_sce)
    #print(shp_ocean)
    df_source_var = sum(df_sce1$varep)
    
    ret = data.table(df_sce1[1,1:3],df_sce1[1,5])
    ret$varep_insource = df_source_var
    #ret_first_row$var_contr = df_var_contr
    #ret_first_row$names = names
    return(ret)
  }
  
  ret_in_source = lapply(x,cal_dep_for_each_p_in_source)
  ret_in_source = do.call('rbind',ret_in_source)
  
  
  return(ret_in_source)
  
}
search_which_full_as_bu_xinjiang <- function(x)
{
  xs = x[1]
  xe = x[length(x)]
  
  source('/home/share/R_project/xinjiang_vapor/mask_via_each_ocean_for_contri_cal.R')
  source('/home/share/R_project/xinjiang_vapor/mask_points_solo_shp.R')
  
  # in ocean
  input_tmp_masdf = 'tmp/tmp_mas_df.csv'
  mas_df = fread(input_tmp_masdf)
  
  xfull1 = mas_df$type
  xsl1 = which(xfull1 == xs)[1]
  xel1 = which(xfull1 == xe)
  xel1 = xel1[length(xel1)]
  
  xes1 <<- xfull1[xsl1:xel1]
  df_sce1<<- mas_df[xsl1:xel1,] # in ocean
  
  rm(mas_df)
  
  print('pass here')
  cal_dep_for_each_p_in_source<-function(id){
    #print(id)
    library(raster)
    library(data.table)
    tmpmark = which(xes1 == id)
    df_sce1 = data.table(df_sce1[tmpmark,])
    # in source region
    #print(df_sce)
    #print(shp_ocean)
    df_source_var = sum(df_sce1$varep)
    
    ret = data.table(df_sce1[1,1:3],df_sce1[1,5])
    ret$varep_insource = df_source_var
    #ret_first_row$var_contr = df_var_contr
    #ret_first_row$names = names
    return(ret)
  }
  
  ret_in_source = lapply(x,cal_dep_for_each_p_in_source)
  ret_in_source = do.call('rbind',ret_in_source)
  
  
  return(ret_in_source)
  
}
search_which_full <- function(x)
{
  xs = x[1]
  xe = x[length(x)]
  
  xsl = which(xfull == xs)[1]
  xel = which(xfull == xe)
  xel = xel[length(xel)]
  
  xes <<- xfull[xsl:xel]
  df_sce<<- df_cal_dep[xsl:xel,]
  shp_ocean = shp_management(pattern = 'ocean',names=names)
  shp_xinjiang = shp_management(pattern = 'xinjiang')
  
  shp_ocean <<- shp_ocean
  shp_xinjiang <<- shp_xinjiang
  cal_dep_for_each_p<-function(id){
    #print(id)
    library(raster)
    tmpmark = which(xes == id)
    df_sce = df_sce[tmpmark,]
    source('/home/share/R_project/xinjiang_vapor/shp_management.R')
    source('/home/share/R_project/xinjiang_vapor/mask_points_solo_shp.R')
    # in source region
    #print(df_sce)
    #print(shp_ocean)
    in_source_id = mask_points_solo_shp(df_sce,shp_ocean)
    df_source = df_sce[in_source_id,]
    df_source_var = sum(df_source$varep)
    
    in_xinjiang_id = mask_points_solo_shp(df_sce,shp_xinjiang)
    #df_xinjiang = df_sce[in_xinjiang_id,]
    #df_xinjiang_var = sum(df_xinjiang$varep)
    
    nrow_df = 1:nrow(df_sce)
    in_route_id = nrow_df[-c(in_source_id,in_xinjiang_id)]
    
    if(length(in_route_id) ==0){
      df_route_var = 0
    }else{
      df_route = df_sce[in_route_id,]
      df_route_var = sum(df_route$varep)
    }
    
    df_var_contr = df_source_var - abs(df_route_var)
    
    #ret_first_row = df_sce[1,]
    #ret_first_row$var_contr = df_var_contr
    #ret_first_row$names = names
    return(df_var_contr)
  }
  #ret_box <- lapply(x,cal_dep_for_each_p)
  
  x<<-x
  cl = makeCluster(15)
  clusterExport(cl,c('df_sce','xes','names','x'))
  system.time(
    ret_box <- parLapply(cl,x,cal_dep_for_each_p)
  )
  stopCluster(cl)
  
  ret_box = do.call('rbind',ret_box)
  
  
  return(ret_box)
  
}
search_which_not_in <- function(x)
{
  xs = x[1]
  xe = x[length(x)]
  
  xsl = which(xfull == xs)[1]
  xel = which(xfull == xe)
  xel = xel[length(xel)]
  
  xes <<- xfull[xsl:xel]
  select_first_loc<-function(id){
    tmpmark = which(xes == id)
    return(tmpmark)
  }
  
  ret_box = lapply(x,select_first_loc)
  ret_box = do.call('c',ret_box)
  ret_box = ret_box+(xsl-1)
  #print(length(unique(ret_box)))
  return(ret_box)
  
}
search_which <- function(x)
{
  xs = x[1]
  xe = x[length(x)]
  
  xsl = which(xfull == xs)[1]
  xel = which(xfull == xe)
  xel = xel[length(xel)]
  
  xes <<- xfull[xsl:xel]
  select_first_loc<-function(id){
    tmpmark = which(xes == id)
    tmpmark = tmpmark[1]
    return(tmpmark)
  }
  
  ret_box = lapply(x,select_first_loc)
  ret_box = do.call('c',ret_box)
  ret_box = ret_box+(xsl-1)
  #print(length(unique(ret_box)))
  return(ret_box)
  
}
season_analysis<-function(
  
){
  
  df = fread('contr_in_source_variance.csv')
  df = as.data.frame(df)
  sou_names = df[,1]
  df = df[,-1]
  
  
  
  monthly_anal<-function(x){
    x = matrix(x,nrow = 12,byrow = F)
    mean_fun <- function(x){
      x = mean(x,na.rm = T)
    }
    xmean = apply(x,2,mean_fun)
    return(xmean)
  }
  
  df_mon_mean = apply(df,1,monthly_anal)
  df_mon_mean = as.data.frame(df_mon_mean)
  colnames(df_mon_mean) = sou_names
  
  sum_pos<-function(x){
    xs = sum(x[which(x>0)])
    return(xs)
  }
  
  df_sum_mon = apply(df_mon_mean,1,sum_pos)
  
  
  library(reshape2)
  month =  c('JAN','FEB','MAR','APR','MAY',
                            "JUN",'JUL','AUG','SEP',"OCT",'NOV',"DEC")
  
  df_mon_mean = as.data.frame(df_mon_mean)
  df_mon_mean$month = month
  df_mon_mean_m = reshape2::melt(df_mon_mean,'month')
  
  library(RColorBrewer) 
  mycolors = colorRampPalette(brewer.pal(11,'Spectral'))(7)
  mycolors = rev(mycolors)
  mycolors[1] = 'white'
  colnames(df_mon_mean_m) = c('Month','SourceType','value')
  
  df_mon_mean_m$Ratio = cut(df_mon_mean_m$value,breaks = c(-10,0,10,20,30,40,50,60))
  df_mon_mean_m$Month = factor(df_mon_mean_m$Month,levels = month)
  df_mon_mean_m$SourceType = factor(df_mon_mean_m$SourceType,levels = sou_names)
  
  
  p1 = ggplot()+
    geom_tile(data = df_mon_mean_m, aes(x = Month, y = SourceType, fill = Ratio),color = 'black')+
    #scale_fill_distiller(palette = 1)
    scale_fill_manual(values = mycolors)+
    theme_bw()+
    theme(
      panel.background = element_rect(fill = 'transparent'),
      axis.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      axis.title = element_text(color = 'black',size = 14,face = 'bold',hjust = 0.5),
      legend.position = 'bottom',
      legend.direction = 'horizontal',
      legend.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      legend.title = element_text(color = 'black',size = 14, face = 'bold',hjust = 0.5)
    )+
    guides(fill = guide_legend(nrow = 1))
  dir.create('plot')
  png('plot/contr_monthly_var.png',
      height = 20,
      width = 21,
      units = 'cm',
      res = 800)
  print(p1)
  dev.off()
  
  
  
}
select_important_factor_postive_relative<-function(
  coeffddf,countrys  
){
  posid = which(coeffddf$type == 'increasing_TWS')
  negid = which(coeffddf$type =='declining_TWS')
  
  pos_coeff = coeffddf[posid,]
  neg_coeff = coeffddf[negid,]
  
  pos_country = countrys[posid]
  neg_country = countrys[negid]
  
  # for pos
  pos_negid = which(pos_coeff$coeff_freshwater_withdraw >0)
  neg_negid = which(neg_coeff$coeff_freshwater_withdraw >0)
  
  
  pos_negdf = pos_coeff[pos_negid,]
  neg_negdf = neg_coeff[neg_negid,]
  pos_neg_country = pos_country[pos_negid]
  neg_neg_country = neg_country[neg_negid]
  
  
  pos_neg_dif = abs(pos_negdf$coeff_freshwater_withdraw)-
    (abs(pos_negdf$coeff_pmeato3)+abs(pos_negdf$coeff_pmeato4))
  neg_neg_dif = abs(neg_negdf$coeff_freshwater_withdraw)-
    abs(neg_negdf$coeff_pmeato3)
  
  pos_neg_peo_id = which(pos_neg_dif >0)
  neg_neg_peo_id = which(neg_neg_dif >0)
  
  pos_neg_peo_country = pos_neg_country[pos_neg_peo_id]
  neg_neg_peo_country = neg_neg_country[neg_neg_peo_id]
  
  
  select_country1 = 
    data.frame(country = pos_neg_peo_country,
               type = 'pos_trend')
  select_country2 = 
    data.frame(country  = neg_neg_peo_country,
               type = 'neg_trend')
  
  return(list(select_country1,
              select_country2))
  
  country_label <- as.data.frame(
    fread('/media/sdb5/Vapor_projcts/Vapor_tibet/main_plot_data/fig3/country_label.csv')
  )
  country_label = country_label[-which(country_label$name == 'Hong Kong'|
                                         country_label$name == 'Macau'),]
  country_label$latitude[which(country_label$name=='India')]=
    country_label$latitude[which(country_label$name=='India')]+2
  
  citys = shp_management('china_city')
  city_china = citys[citys$PINYIN %in%
                       c('Wulumuqi','Shijiazhuang'),]
  city_china = as.data.frame(city_china,xy = T)
  city_china1 = data.frame(
    country = c('NCP','XJ'),
    latitude = city_china$coords.x2,
    longitude = city_china$coords.x1,
    name = c('North China Plain','Xinjiang')
  )
  
  country_label = rbind(country_label,city_china1)
  
  country_in1 = which(country_label$name %in% select_country1$country )
  country_in2 = which(country_label$name %in% select_country2$country)
  
  country_in1 = country_label[country_in1,]
  country_in2 = country_label[country_in2,]
  
  country_in1$type = 'pos_tws'
  country_in2$type = 'neg_tws'
  
  country_in = rbind(country_in1,country_in2)
  
  
  world = shp_management('world')
  world = crop(world,extent(-20,180,0,90))
  hsr = shapefile('analysis_output/fig2/combine_sub_window.shp')
  
  p = ggplot()+
    geom_polygon(data = world,
                 aes(x = long,y = lat,
                     group = group),
                 size = 0.5,
                 fill = 'grey80')+
    geom_polygon(data = hsr,
                 aes(x = long,y = lat,
                     group = group),
                 size = 0.5,
                 fill = 'transparent',color = 'black')+
    geom_point(data = country_in,
               aes(x = longitude,y = latitude,
                   color = type),
               size = 3,shape = 1)+
    geom_point(data =country_in,
               aes(x = longitude,y = latitude,
                   color = type),
               size = 2,shape = 16)+
    geom_text(data = country_in,
              aes(x = longitude,y = latitude,
                  label = name))+
    facet_wrap(~type,nrow = 2)+
    theme_bw()
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
}v
select_important_factor<-function(
  coeffddf,countrys  
){
  posid = which(coeffddf$type == 'increasing_TWS')
  negid = which(coeffddf$type =='declining_TWS')
  
  pos_coeff = coeffddf[posid,]
  neg_coeff = coeffddf[negid,]
  
  pos_country = countrys[posid]
  neg_country = countrys[negid]
  
  # for pos
  pos_negid = which(pos_coeff$coeff_freshwater_withdraw <0)
  neg_negid = which(neg_coeff$coeff_freshwater_withdraw <0)
  
  
  pos_negdf = pos_coeff[pos_negid,]
  neg_negdf = neg_coeff[neg_negid,]
  pos_neg_country = pos_country[pos_negid]
  neg_neg_country = neg_country[neg_negid]
  
  
  pos_neg_dif = abs(pos_negdf$coeff_freshwater_withdraw)-
    (abs(pos_negdf$coeff_pmeato3)+abs(pos_negdf$coeff_pmeato4))
  neg_neg_dif = abs(neg_negdf$coeff_freshwater_withdraw)-
    abs(neg_negdf$coeff_pmeato3)
  
  pos_neg_peo_id = which(pos_neg_dif >0)
  neg_neg_peo_id = which(neg_neg_dif >0)
  
  pos_neg_peo_country = pos_neg_country[pos_neg_peo_id]
  neg_neg_peo_country = neg_neg_country[neg_neg_peo_id]
  
  
  select_country1 = 
    data.frame(country = pos_neg_peo_country,
               type = 'pos_trend')
  select_country2 = 
    data.frame(country  = neg_neg_peo_country,
               type = 'neg_trend')
  
  return(list(select_country1,
              select_country2))
 
   country_label <- as.data.frame(
    fread('/media/sdb5/Vapor_projcts/Vapor_tibet/main_plot_data/fig3/country_label.csv')
  )
  country_label = country_label[-which(country_label$name == 'Hong Kong'|
                                         country_label$name == 'Macau'),]
  country_label$latitude[which(country_label$name=='India')]=
    country_label$latitude[which(country_label$name=='India')]+2
  
  citys = shp_management('china_city')
  city_china = citys[citys$PINYIN %in%
                       c('Wulumuqi','Shijiazhuang'),]
  city_china = as.data.frame(city_china,xy = T)
  city_china1 = data.frame(
    country = c('NCP','XJ'),
    latitude = city_china$coords.x2,
    longitude = city_china$coords.x1,
    name = c('North China Plain','Xinjiang')
  )
  
  country_label = rbind(country_label,city_china1)
  
  country_in1 = which(country_label$name %in% select_country1$country )
  country_in2 = which(country_label$name %in% select_country2$country)
  
  country_in1 = country_label[country_in1,]
  country_in2 = country_label[country_in2,]
  
  country_in1$type = 'pos_tws'
  country_in2$type = 'neg_tws'
  
  country_in = rbind(country_in1,country_in2)
  
  
  world = shp_management('world')
  world = crop(world,extent(-20,180,0,90))
  hsr = shapefile('analysis_output/fig2/combine_sub_window.shp')
  
  p = ggplot()+
    geom_polygon(data = world,
                 aes(x = long,y = lat,
                     group = group),
                 size = 0.5,
                 fill = 'grey80')+
    geom_polygon(data = hsr,
                 aes(x = long,y = lat,
                     group = group),
                 size = 0.5,
                 fill = 'transparent',color = 'black')+
    geom_point(data = country_in,
               aes(x = longitude,y = latitude,
                   color = type),
               size = 3,shape = 1)+
    geom_point(data =country_in,
               aes(x = longitude,y = latitude,
                   color = type),
               size = 2,shape = 16)+
    geom_text(data = country_in,
              aes(x = longitude,y = latitude,
                  label = name))+
    facet_wrap(~type,nrow = 2)+
    theme_bw()
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
   
  
  
  
}
shp_management_cloud <- function(
  pattern = 'ocean',
  names = 'ao'
){
  library(raster)
  if(pattern == 'ocean'){
    # ocean shp 
    ocean_path = '~/shp/ocean_shp'
    files = list.files(ocean_path,pattern = '*.shp$',full.names = T)
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    
    idr = which(oce_names == names)
    
    tmpshp = shapefile(files[idr])
    return(tmpshp)
    
  }else if(pattern == 'land'){
    # order: ao, 
    # land shp 
    land_path = '~/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == names)
    
    tmpshp = shapefile(files[idr])
    return(tmpshp)
  }else if(pattern =='as_bu_xinjiang'){
    path = '~/shp/asia_bu_xinjiang/'
    files = list.files(path,pattern = '*.shp$',full.names = T)
    
    tmpshp = shapefile(files)
  }else if(pattern == 'xinjiang'){
    shp_path = '/usr/local/flexpart_bk1/shp/Xinjiang_border.shp'
    tmpshp = shapefile(shp_path)
    return(tmpshp)
    
  }else if(pattern == 'combine_ocean'){
    xinjiang = shapefile('/usr/local/flexpart_bk1/shp/Xinjiang_border.shp')
    ocean_path = '~/shp/ocean_shp'
    files = list.files(ocean_path,pattern = '*.shp$',full.names = T)
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    
    idr = which(oce_names == names)
    
    tmpshp = shapefile(files[idr])
    tmpshp = do.call('bind',list(xinjiang,tmpshp))
    return(tmpshp)
  }else if(pattern == 'combine_land'){
    xinjiang = shapefile('/usr/local/flexpart_bk1/shp/Xinjiang_border.shp')
    
    land_path = '~/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == names)
    
    tmpshp = shapefile(files[idr])
    tmpshp = do.call('bind',list(xinjiang,tmpshp))
    return(tmpshp)
  }else if(pattern == 'world'){
    shp_path = '~/shp/world_continent.shp'
    tmpshp= shapefile(shp_path)
    return(tmpshp)
  }
  
  
  
  
  
  
  
}



shp_management <- function(
  pattern = 'ocean',
  names = 'ao'
){
  library(raster)
  if(pattern == 'ocean'){
    # ocean shp 
    ocean_path = '/media/sdb1/shp/ocean_shp'
    files = list.files(ocean_path,pattern = '*.shp$',full.names = T)
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    
    idr = which(oce_names == names)
    
    tmpshp = shapefile(files[idr])
    return(tmpshp)
    
  }else if(pattern == 'land'){
    # order: ao, 
    # land shp 
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == names)
    
    tmpshp = shapefile(files[idr])
    return(tmpshp)
  }else if(pattern =='as_bu_xinjiang'){
    path = '/media/sdb1/shp/asia_bu_xinjiang/'
    files = list.files(path,pattern = '*.shp$',full.names = T)
    
    tmpshp = shapefile(files)
  }else if(pattern == 'xinjiang'){
    shp_path = '/usr/local/flexpart_bk1/shp/Xinjiang_border.shp'
    tmpshp = shapefile(shp_path)
    return(tmpshp)
    
  }else if(pattern == 'combine_ocean'){
    xinjiang = shapefile('/usr/local/flexpart_bk1/shp/Xinjiang_border.shp')
    ocean_path = '/media/sdb1/shp/ocean_shp'
    files = list.files(ocean_path,pattern = '*.shp$',full.names = T)
    oce_names = c('ao','ato','bs','cs','io','ms','po','rs')
    
    idr = which(oce_names == names)
    
    tmpshp = shapefile(files[idr])
    tmpshp = do.call('bind',list(xinjiang,tmpshp))
    return(tmpshp)
  }else if(pattern == 'combine_land'){
    xinjiang = shapefile('/usr/local/flexpart_bk1/shp/Xinjiang_border.shp')
    
    land_path = '/media/sdb1/shp/north_land/'
    files = list.files(land_path,pattern = '*.shp$',full.names = T)
    con_names = c('as','eu','naf','na')
    
    idr = which(con_names == names)
    
    tmpshp = shapefile(files[idr])
    tmpshp = do.call('bind',list(xinjiang,tmpshp))
    return(tmpshp)
  }else if(pattern == 'china'){
    shp_path = '/media/sdb1/shp/China/China.shp'
    tmpshp= shapefile(shp_path)
    return(tmpshp)
  }else if(pattern == 'world'){
    shp_path = '/media/sdb1/shp/world_continent.shp'
    tmpshp= shapefile(shp_path)
    return(tmpshp)
  }else if(pattern == 'world_country'){
    shp_path = '/media/sdb1/shp/world_country/world.shp'
    tmpshp= shapefile(shp_path)
    return(tmpshp)
  }else if(pattern == 'world_include_ocean'){
    shp_path = '/media/sdb1/shp/world_oce.shp'
    tmpshp= shapefile(shp_path)
    return(tmpshp)
  }else if(pattern == 'shamo'){
    shp_path = '/media/sdb1/shp/north_land/shamo.shp'
    tmpshp = shapefile(shp_path)
    return(tmpshp)
  }else if(pattern == 'xinjiang_jishui_south'){
    shp_path = '/media/sdb1/shp/xinjiang_jishui/south_shp1.shp'
    tmpshp = shapefile(shp_path)
    return(tmpshp)
  }else if(pattern == 'xinjiang_jishui_north'){
    shp_path = '/media/sdb1/shp/xinjiang_jishui/north_shp1.shp'
    tmpshp = shapefile(shp_path)
    return(tmpshp)
  }else if(pattern == 'xinjiang_south'){
    shp_path = '/media/sdb1/shp/xinjiang_jishui/South_Xinjiang.shp'
    tmpshp = shapefile(shp_path)
    return(tmpshp)
  }else if(pattern == 'xinjiang_north'){
    shp_path = '/media/sdb1/shp/xinjiang_jishui/North_Xinjiang.shp'
    tmpshp = shapefile(shp_path)
    return(tmpshp)
  }else if(pattern == 'yrb'){
    shp_path = '/media/sdb5/Vapor_projcts/Vapor_yellow_river/shp/yrbasin'
    shp_path = list.files(shp_path,pattern = '*.shp$',full.names = T)
    tmpshp = shapefile(shp_path)
    return(tmpshp)
  }else if(pattern == 'tibet'){
    shp_path = '/media/sdb5/Vapor_projcts/Vapor_tibet/shp/tibet/'
    shp_path = list.files(shp_path,pattern = '*.shp$',full.names = T)
    tmpshp = shapefile(shp_path)
    return(tmpshp)
  }else if(pattern == 'province_yrb'){
    shp_path = '/media/sdb5/Vapor_projcts/Vapor_yellow_river/shp/Province/'
    files = list.files(shp_path,pattern = '*.shp$')
    
    filesname = '1'
    for(i in 1:length(files)){
      tmp = strsplit(files[i],'[.]')[[1]][1]
      tmp = tolower(tmp)
      filesname = c(filesname,tmp)
    }
    filesname = filesname[-1]
    
    shp_path = list.files(shp_path,
                          pattern = '*.shp$',full.names = T)
    
    id = which(filesname == names)
    shp_path = shp_path[id]
    
    tmpshp = shapefile(shp_path)
    return(tmpshp)
  }else if(pattern == 'whole_province'){
    shp_path = '/media/sdb5/Vapor_projcts/Vapor_yellow_river/shp/full_province.shp'
    tmpshp = shapefile(shp_path)
    return(tmpshp)
  }else if(pattern == 'eco_subregions'){
    shp_path = '/media/sdb5/Vapor_projcts/Vapor_yellow_river/shp/ChinaGeoEcoRegionsshp/ChinaGeoEcoRegions.shp'
    tmpshp = shapefile(shp_path)
    return(tmpshp)
  }else if(pattern == 'yrb_subregions'){
    base = '/media/sdb5/Vapor_projcts/Vapor_yellow_river'
    shp_path = 'shp/yrb_cluster'
    shp_path = paste0(shp_path,'/',
                      'region',1:7,'.shp')
    shp_path = paste0(base,'/',shp_path)
    
    shp_li = lapply(shp_path,shapefile)
    return(shp_li)
    
  }else if(pattern == 'sanjiangyuan'){
    input = '/media/sdb5/Vapor_projcts/Vapor_tibet/shp/sanjiangyuan/Sanjiangyuan_Boundary.shp'
    shp = shapefile(input)
    return(shp)
    
  }else if(pattern == 'neg_points'){
    input = 'shp/neg_points/'
    input = list.files(input,full.names = T,
                       pattern = '*.shp$')[c(2,4,5)]
    
    shp = lapply(input,shapefile)
    shp1 = as.data.frame(shp[[1]],xy = T) 
    shp2 = as.data.frame(shp[[2]],xy = T)
    shp3 = as.data.frame(shp[[3]],xy = T)
    
    shps = data.frame(
      long = c(shp1$coords.x1,shp2$coords.x1,shp3$coords.x1),
      lat = c(shp1$coords.x2,shp2$coords.x2,shp3$coords.x2)
      
    )
    return(shps)
  }else if(pattern == 'asiarivers'){
    setwd('/media/sdb5/Vapor_projcts/Vapor_tibet')
    path = 'shp//asia_rivers/asrivs.shp'
    
    shps = shapefile(path)
    
    return(shps)
  }else if(pattern == 'tibet_river'){
    setwd('/media/sdb5/Vapor_projcts/Vapor_tibet')
    path = 'shp/tibet_river/tibet_river.shp'
    shps = shapefile(path)
    return(shps)
  }else if(pattern == 'china'){
    #setwd('/media/sdb5/Vapor_projcts/Vapor_tibet')
    path = '/media/sdb1/shp/China/China.shp'
    shps = shapefile(path)
    return(shps)
  }else if(pattern == 'china_city'){
    #setwd('/media/sdb5/Vapor_projcts/Vapor_tibet')
    path = '/media/sdb1/shp/China/cities.shp'
    shps = shapefile(path)
    return(shps)
  }
  
  
  
  
  
  
  
}


  
  
si_appendix_plot <-function(
  
){
  
  
  
  # spatiotemporal evolution of monthly mean TWS anomalies
  # and PMEATO anomalies
  source('/home/share/R_project/xinjiang_vapor/mmk_monthly_analysis.R')
  mmk_monthly_analysis()
}
slope_select<-function(
  index
){
  i = 2
  diff_back_box =1
  tp_box = 1
  diff_front_box = 1
  while(i <=(length(index)-12)){
    
    diff_front = index[i] - index[i-1]
    diff_back = index[i+1] - index[i]
    #diff_front2 = index[i] - index[i-2]
    #diff_back2 = index[i+2] - index[i]
    
    
    #print(diff_back)
    if(diff_front >0 & 
       diff_back >0){
      
    }else if(diff_front <0 &
             diff_back <0){
      
    }else{
      tp_box = c(tp_box,i)
      
    }
    #diff_front_box = c(diff_front_box,diff_front)
    #diff_back_box = c(diff_back_box,diff_back)
    i = i+1
  }
  #diff_back_box = diff_back_box[-1]
  #diff_front_box = diff_front_box[-1]
  
  
  tp_box = tp_box[-1]
  return(tp_box)  
}
source_fun<-function(
  
){
  files = list.files('/home/share/R_project/xinjiang_vapor',pattern = '.R$',full.names = T)
  sapply(files,source)
}
source_id_by_convey_amount <-function(
  pattern = 'north'
){
  i = 1:4
  order_fun<-function(i){
    files = c('north_moun','north_jishui','south_moun','south_jishui')
    
    con_amount_input = paste0('convey_amount_based_era5_eva_in_target/mean/',
                              files[i],'.csv')
    
    con_amount = fread(con_amount_input)
    con_amount = as.data.frame(con_amount)
    
    con_sum = apply(con_amount,2,sum)
    con_sum = as.numeric(con_sum)/180
    
    id_re = as.numeric(which(con_sum <1000))
    con_sum = con_sum[-id_re]
    order = order(con_sum,decreasing = T)
    
    return(order)
  }
  order = lapply(i,order_fun)
  
  order_north = c(order[[1]],order[[2]])
  order_south = c(order[[3]],order[[4]])
  
  order_north = as.numeric(unique(order_north))
  order_south = as.numeric(unique(order_south))
  if(pattern == 'north'){
    return(order_north)
  }else{
    return(order_south)
  }
  
}
source_id_identify <-function(
  pattern = 'north'
){
  i = 1:4
  id_re_fun<-function(i){
    files = c('north_moun','north_jishui','south_moun','south_jishui')
    
    con_amount_input = paste0('convey_amount_based_era5_eva_in_target/mean/',
                              files[i],'.csv')
    
    con_amount = fread(con_amount_input)
    con_amount = as.data.frame(con_amount)
    
    con_sum = apply(con_amount,2,sum)
    con_sum = as.numeric(con_sum)/180
    id_re = as.numeric(which(con_sum <1000))
    
    
    return(id_re)
  }
  id_re = lapply(i,id_re_fun)
  
  id_north = c(id_re[[1]],id_re[[2]])
  id_south = c(id_re[[3]],id_re[[4]])
  
  id_north = as.numeric(unique(id_north))
  id_south = as.numeric(unique(id_south))
  if(pattern == 'north'){
    return(id_north)
  }else{
    return(id_south)
  }
  
}
spatial_monthly_evo_tas_mmk <- function(
  
){
  library(ggplot2)
  library(data.table)
  
  input_tas_mean = 'analysis_output/fig3/landtas_mmk.csv'
  tas_mean = fread(input_tas_mean)
  tas_mean = as.data.frame(tas_mean)
  
  natas = which(is.na(tas_mean[,3]))
  tas_mean = tas_mean[-natas,]
  
  tas_mean = as.data.frame(tas_mean)
  colnames(tas_mean) = c('long','lat',
                         toupper(month.abb))
  
  tas_meamm  = reshape2::melt(tas_mean,c('long','lat'))
  idbigzero <- which(tas_meamm$value >=0)
  tas_meamm = tas_meamm[idbigzero,]
  
  idbig1000 <- which(tas_meamm$value>10)
  tas_meamm = tas_meamm[-idbig1000,]
  
  tas_meamm$cuts = cut(tas_meamm$value,
                       breaks = c(seq(0,10,2)),
                       right = F)
  mypal = colorRampPalette(brewer.pal(11,'Spectral'))(5)
  p = ggplot()+
    geom_polygon(data = world,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    geom_polygon(data = xj,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    
    geom_tile(data = tas_meamm,aes(
      x = long,y = lat,fill = cuts
    ))+
    scale_fill_manual(values = mypal)+
    facet_wrap(~variable,nrow = 4)+
    theme_bw()
}
spatial_monthly_evolution_tas_mean<-function(
  
){
  library(ggplot2)
  library(data.table)
  
  input_tas_mean = 'analysis_output/fig3/landtas_mean.csv'
  tas_mean = fread(input_tas_mean)
  tas_mean = as.data.frame(tas_mean)
  
  natas = which(is.na(tas_mean$tmptasmean))
  tas_mean = tas_mean[-natas,]
  
  tas_mean = as.data.frame(tas_mean)
  colnames(tas_mean) = c('long','lat',
                         toupper(month.abb))
  
  tas_meamm  = reshape2::melt(tas_mean,c('long','lat'))
  idbigzero <- which(tas_meamm$value >=0)
  tas_meamm = tas_meamm[idbigzero,]
  
  tas_meamm$cuts = cut(tas_meamm$value,
                       breaks = c(seq(0,40,5),90) )
  p = ggplot()+
    geom_polygon(data = world,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    geom_polygon(data = xj,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    
    geom_tile(data = tas_meamm,aes(
      x = long,y = lat,fill = cuts
    ))+
    scale_fill_brewer(palette = 'Spectral',
                      direction = -1)+
    facet_wrap(~variable,nrow = 4)+
    theme_bw()
  
  
  
  
}
spatial_pattern_increasing_decling_tws <- function(
  countrys,coeffddf
){
  posid = which(coeffddf$type == 'increasing_TWS')
  negid = which(coeffddf$type =='declining_TWS')
  
  pos_country = countrys[posid]
  neg_country = countrys[negid]
  
  country_label <- as.data.frame(
    fread('/media/sdb5/Vapor_projcts/Vapor_tibet/main_plot_data/fig3/country_label.csv')
  )
  country_label = country_label[-which(country_label$name == 'Hong Kong'|
                                         country_label$name == 'Macau'),]
  country_label$latitude[which(country_label$name=='India')]=
    country_label$latitude[which(country_label$name=='India')]+2
  
  citys = shp_management('china_city')
  city_china = citys[citys$PINYIN %in%
                       c('Wulumuqi','Shijiazhuang'),]
  city_china = as.data.frame(city_china,xy = T)
  city_china1 = data.frame(
    country = c('NCP','XJ'),
    latitude = city_china$coords.x2,
    longitude = city_china$coords.x1,
    name = c('North China Plain','Xinjiang')
  )
  
  country_label = rbind(country_label,city_china1)
  
  country_in1 = which(country_label$name %in% pos_country)
  country_in2 = which(country_label$name %in% neg_country)
  country_in1 = country_label[country_in1,]
  country_in2 = country_label[country_in2,]
  
  country_in1$type = 'pos_tws'
  country_in2$type = 'neg_tws'
    
  country_in = rbind(country_in1,country_in2)
  
  
  world = shp_management('world')
  world = crop(world,extent(-20,180,0,90))
  hsr = shapefile('analysis_output/fig2/combine_sub_window.shp')
  
  p = ggplot()+
    geom_polygon(data = world,
                 aes(x = long,y = lat,
                     group = group),
                 size = 0.5,
                 fill = 'grey80')+
    geom_polygon(data = hsr,
                 aes(x = long,y = lat,
                     group = group),
                 size = 0.5,
                 fill = 'transparent',color = 'black')+
    geom_point(data = country_in,
               aes(x = longitude,y = latitude,
                   color = type),
               size = 3,shape = 1)+
    geom_point(data =country_in,
               aes(x = longitude,y = latitude,
                   color = type),
               size = 2,shape = 16)+
    geom_text(data = country_in,
              aes(x = longitude,y = latitude,
                  label = name))+
    facet_wrap(~type,nrow=2)+
    theme_bw()
  
  return(p)
  
  
  
}
spatial_pattern_of_tws_neg_multiple_year <-function(
years  
){
  
  #years = seq(2020,2098,12)
  
  dfs = lapply(years,spatial_pattern_of_tws_neg_infuture_by_year,
               mode = 'ssp245')
  dfs = do.call(rbind,dfs)
  
  neg_bords = list.files('shp/cluster_tws_neg_shp_deter/',
                         full.names = T,
                         pattern = '*.shp$')
  neg_bords = lapply(neg_bords[1:2],shapefile)  
  neg_bords = do.call(bind,neg_bords)
  
  tibet = shp_management('tibet')
  library(RColorBrewer)
  
  negid = which(dfs$tws245 <=0)
  dfs = dfs[negid,]
  
  dfs$level = 
    cut(dfs$tws245,
        breaks = seq(round(min(dfs$tws245))-1,0,1))
  
  nclass = length(unique(dfs$level))
  cols = colorRampPalette(brewer.pal(9,name = 'Spectral'))(nclass*8)
  cols = cols[seq(1,nclass*4,4)[1:nclass]]
  
  p = ggplot()+
    geom_polygon(data = tibet,
                 aes(x =long,y = lat,group = group),
                 color = 'black',size = 0.5,
                 fill = 'transparent')+
    geom_polygon(data = neg_bords,
                 aes(x =long,y = lat,group = group),
                 color = 'black',size = 0.5,
                 fill = 'transparent')+
    geom_tile(data = dfs,
              aes(x = long,y = lat,fill = level))+
    scale_fill_manual(values = cols)+
    facet_wrap(~type,nrow = 2)+theme_bw()+
    theme(legend.position = 'bottom')
  
  output_png = 'main_plot/spatial_pattern_negtws_multis/'
  dir.create(output_png)
  output_png = paste0(output_png,'/fig3.png')
  png(output_png,
      height = 20,
      width = 25,
      units = 'cm',
      res = 800)
  print(p)
  dev.off()
  
  return(p)
}













spatio_temporal_var_with_tibet_as_center <-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  # import shp 
  tibet = shp_management('tibet')
  world = shp_management('world')
  # import grace TWS
  tws = data_management('grace')
  
  
  
  ex_tibet = extent(tibet)
  minlat = ex_tibet[3]
  maxlat = ex_tibet[4]
  minlong = ex_tibet[1]
  maxlong = ex_tibet[2]
  
  ex_box = extent(minlong-30,maxlong+50,minlat-20,maxlat+20)
  tws = crop(tws,ex_box)
  tws = mask(tws,world)
  
  twsdf = as.data.frame(tws,xy = T)
  naid = which(is.na(twsdf[,3]))
  twsdf = twsdf[-naid,]
  
  loc = twsdf[,1:2]
  colnames(loc) = c('long','lat')
  twsdf = twsdf[,-c(1,2)]
  
  calc_month_mean <-function(x){
    x = c(x,rep(NA,6))
    xm= matrix(x,nrow = 12)
    xmean = apply(xm,1,mean,na.rm = T)
    return(xmean)
  }
  
  twsdf_mon_mean = apply(twsdf,1,calc_month_mean)
  twsdf_mon_mean = t(twsdf_mon_mean)
  colnames(twsdf_mon_mean) = month.abb
  twsdf_annual_sum = apply(twsdf_mon_mean,1,sum)
  
  
  ann_sum_twsdf = data.frame(loc,tws_anoma_sum = twsdf_annual_sum)
  dfm = reshape2::melt(ann_sum_twsdf,c('long','lat'))
  
  negid = which(dfm$value<=0)
  dfm_neg = dfm[negid,]
  
  world_crop = crop(world,ex_box)
  
  dfm_neg$levels = cut(dfm_neg$value,
                   breaks = c(-223,-100,seq(-50,0,10)))
  library(data.table)
  traj_df = '/media/sdb5/Vapor_projcts/Vapor_tibet/whole_time_traj/whole_time_traj.csv'
  traj_df = fread(traj_df)
  traj_df = as.data.frame(traj_df)
  
  library(RColorBrewer)
  library(ggplot2)
  lincolor = colorRampPalette(brewer.pal(9,'Spectral'))(20)
  idfil = which(traj_df[,4]>minlong)
  traj_df_fil = traj_df[idfil,]
  world_crop = crop(world,ex_box)
  p_ann_sum_neg = ggplot()+
    geom_tile(data = dfm_neg,aes(x = long,y = lat,fill = levels))+
    geom_polygon(data = world_crop,aes(x = long,y = lat,group = group ),
                 size = 1,color = 'black',fill = 'transparent')+
    geom_polygon(data = tibet,aes(x = long,y = lat,group = group ),
                 size = 1,color = 'black',fill = 'transparent')+
    geom_path(data = traj_df,aes(x = long,y = lat,
                                         group = routeid,
                                         color = factor(routeid)),
              size = 1,
              arrow=arrow(angle=30,length=unit(0.11,"inches"),
                          type="closed"))+
    #scale_fill_gradientn(colors = mycolor)+
    #scale_fill_manual(values = fillcolor)+
    scale_color_manual(values = lincolor)+
    scale_fill_brewer(palette = 'Spectral')+
    theme_bw()
  
  calc_sum_by_annu <-function(x){
    x = c(x,rep(NA,6))
    xm= matrix(x,nrow = 12)
    xm = xm[,-ncol(xm)]
    xmean = apply(xm,2,sum,na.rm = T)
    return(xmean)
  }
  
  sum_by_annu = apply(twsdf,1,calc_sum_by_annu)
  sum_by_annu = t(sum_by_annu)
  colnames(sum_by_annu) = paste0('year',2003:2016)
  df_sum_annu = data.frame(loc,sum_by_annu)
  
  dfm2 = reshape2::melt(df_sum_annu,c('long','lat'))
  
  dfm2_neg = dfm2[which(dfm2$value<=0 ),]
  
  dfm2_neg$levels = cut(dfm2_neg$value,
                        breaks = c(-670,-200,seq(-100,0,20)))
  
  input_glacer = paste0('/media/sdb5/Vapor_projcts/Vapor_tibet/shp/glacier_by_year/',
                  'year_',2003:2015,'.shp')
  year = 2003:2015
  glacier_df = 1
  for(i in 1:length(input_glacer)){
    x = shapefile(input_glacer[i])
    xdf = fortify(x)
    xdf$type = paste0('year',year[i])
    glacier_df = rbind(glacier_df,xdf)
  }
  glacier_df = glacier_df[-1,]
  
  dfm2_neg$type = dfm2_neg$variable
  
  fontsize = 14
  text_theme = theme(
    axis.text = element_text(size = fontsize),
    strip.text = element_text(size = fontsize),
    legend.text = element_text(size = fontsize),
    axis.title = element_text(size = fontsize,face = 'bold'),
    #strip.title = element_text(size = fontsize,face = 'bold'),
    legend.title = element_text(size = fontsize,face = 'bold'),
    legend.position = 'bottom'
  )
  p_sum_by_annu = ggplot()+
    geom_tile(data = dfm2_neg,aes(x = long,y = lat,fill = levels))+
    geom_polygon(data = world_crop,aes(x = long,y = lat,group = group ),
                 size = 1,color = 'black',fill = 'transparent')+
    #geom_polygon(data = glacier_df,aes(x = long,y = lat,group = group ),
    #             size = 1,color = 'black',fill = 'transparent')+
    geom_polygon(data = tibet,aes(x = long,y = lat,group = group ),
                 size = 1,color = 'black',fill = 'transparent')+
    
    scale_fill_brewer(palette = 'Spectral')+
    facet_wrap(~type)+
    theme_bw()+
    text_theme+
    guides(fill = guide_legend(title = 'TWS_SUM_BY_ANNU',
                               title.position = 'top'))+
    xlab('Longitude')+
    ylab('Latitude')
  
  library(cowplot)
  library(gridExtra)
  library(ggpubr)
  
  pleg = as_ggplot(get_legend(p_sum_by_annu))
  p2 = ggdraw()+
    draw_plot(p_sum_by_annu+
                theme(legend.position = 'none'))+
    draw_plot(pleg,x = 0.65, y = 0.1,
              width = 0.22, height = 0.15)
    
  setwd('/media/sdb5/Vapor_projcts/Vapor_tibet')
  dir.create('main_plot/tws_sum_by_annu')
  output = 'main_plot/tws_sum_by_annu/tws_sum_by_annu.png'
  png(output,
      height = 25,
      width = 27,
      units = 'cm',
      res = 800)
  print(p2)
  dev.off()
  
  
  
  
  
  
  
}
spatio_tws_evolu<-function(
  
){
  input_tws_mean = 'analysis_output/fig3/twsmean_mon.csv'
  input_pme_mean = 'analysis_output/fig3/pmemean_mon.csv'
  
  tws_mean = fread(input_tws_mean)
  tws_mean = as.data.frame(tws_mean)
  pme_mean = as.data.frame(fread(input_pme_mean))
  
  
  naidtws = which(is.na(tws_mean$JAN))
  tws_mean = tws_mean[-naidtws,]
  loc = tws_mean[,1:2]
  tws_mean = tws_mean[,-c(1,2)]
  
  
  naidpme = which(is.na(pme_mean$JAN))
  pme_mean = pme_mean[-naidpme,]
  loc_pme = pme_mean[,1:2]
  pme_mean = pme_mean[,-c(1,2)]

  #tws_mean = apply(tws_mean,2,class_fun)
  
  tws_mean = apply(tws_mean,1,sum,na.rm = T)
  pme_mean = apply(pme_mean,1,sum,na.rm = T)
  
  twsdf = data.frame(
    long = loc[,1],
    lat = loc[,2],
    twsclass = tws_mean
  )
  
  coordinates(twsdf) = ~long+lat
  gridded(twsdf) = T
  twsdf = raster(twsdf)
  
  shp_as = shp_management('land','as')
  shp_eu = shp_management('land','eu')
  shp_naf = shp_management('land','naf')
  shp_as_eu = bind(shp_as,shp_eu,shp_naf)
  ex_as_ato = extent(shp_as_eu)
  ex_as_ato = extent(-50,ex_as_ato[2],ex_as_ato[3],
                     ex_as_ato[4])
  
  twsdf = crop(twsdf,ex_as_ato)
  twsdf = mask(twsdf,shp_as_eu)
  twsdf = as.data.frame(twsdf,xy =T)
  colnames(twsdf) = c('long','lat','twsclass')
  
  dem = raster('global_dem/global_dem.nc')
  
  dem1 = crop(dem,extent(0,180,-90,90))
  dem2 = crop(dem,extent(180,360,-90,90))
  extent(dem2) = extent(-180,0,-90,90)
  dem = merge(dem2,dem1)
  
  
  dem_crop = crop(dem,ex_as_ato)
  dem_crop = mask(dem_crop,shp_as_eu)
  
  dem_cropdf = as.data.frame(dem_crop,
                             xy = T)
  
  colnames(dem_cropdf) = c('long','lat','dem')
  naiddem = which(is.na(dem_cropdf$dem))
  
  dem_cropdf = dem_cropdf[-naiddem,]
  dem_cropdf$type = '(b) Spatial evolution of the sum of monthly TWS and PMEATO anomalies'
  
  
  
  pmedf <-data.frame(
    long = loc_pme[,1],
    lat = loc_pme[,2],
    pmeclass = pme_mean
  )
  
  twsdfm = reshape2::melt(twsdf,
                           c('long','lat'))
  pmedfm = reshape2::melt(pmedf,
                          c('long','lat'))
  
  lessid = which(twsdfm$value<0)
  #lessid_pme = which(pmedfm$value < 0)
  
  #pmedfm = pmedfm[lessid_pme,]
  twsdfm = twsdfm[lessid,]
  
  pmedfm$cuts = cut(pmedfm$value,
                    breaks = c(-140,seq(0,500,100),540),
                    right = F)
  twsdfm$cuts = cut(twsdfm$value,
                     breaks = c(-1900,
                              seq(-500,-200,100),
                              seq(-100,0,10)),
                    right=F)
  
  mycolor = colorRampPalette(
    brewer.pal(11,'Spectral'))(15)
  pmecolor = colorRampPalette(
    brewer.pal(11,'Spectral'))(7)
  
  shp_subs =  'sub_windows'
  num = 1:19
  input_shp = paste0(shp_subs,'/sub_window',num,'.shp')
  shp_subs = do.call('bind',lapply(input_shp,shapefile))
  
  library(ggnewscale)
  source('/home/share/R_project/xinjiang_vapor/month_longit_evolution.R')
  tws_meanm_agg = month_longit_evolution()
  tile_col = colorRampPalette(
    brewer.pal(11,'Spectral')
  )(30)
  tile_col = tile_col[c(1:15,23:29)]
  
  twsdfm$type = '(b) Spatial evolution of the sum of monthly TWS and PMEATO anomalies'
  tws_meanm_agg$type = '(a) Monthly Evolution of Mean TWS Anomaly alongside Longitude'
  pmedfm$type = '(b) Spatial evolution of the sum of monthly TWS and PMEATO anomalies'
  #fwrite(twsdfm,'analysis_output/fig3/tws_month_sum.csv')
  tws_meanm_agg$Indices_class = cut(tws_meanm_agg$value,
                                breaks = c(seq(-60,-10,5),
                                           seq(-5,0,1),
                                           seq(10,140,20)))
  
  world = shp_management('world')
  xj = shp_management('xinjiang')
  world= crop(world,extent(-180,180,0,90))
  
  world_df =fortify(world)
  xj_df = fortify(xj)
  #shp_com_df = fortify(shp_com)
  shp_subs_df = fortify(shp_subs)
  
  world_df$type = '(b) Spatial evolution of the sum of monthly TWS and PMEATO anomalies'
  xj_df$type = '(b) Spatial evolution of the sum of monthly TWS and PMEATO anomalies'
  #shp_com_df$type = '(b) Spatial evolution of the sum of monthly TWS and PMEATO anomalies'
  shp_subs_df$type = '(b) Spatial evolution of the sum of monthly TWS and PMEATO anomalies'
  
  
  land_scale = data.frame(
    xstart = c(-180,-180),
    xend = c(180,180),
    ystart = c(30,60),
    yend = c(30,60),
    type = '(b) Spatial evolution of the sum of monthly TWS and PMEATO anomalies'
  )
  fontsize = 12
  text_theme_set = theme(
    ##############
    axis.text = element_text(
      color = 'black',
      size = fontsize),
    axis.title = element_text(face = 'bold',
                              color = 'black',
                              size = fontsize),
    legend.text = element_text(
      color = 'black',
      size = fontsize),
    legend.title = element_text(
      color = 'black',
      size = fontsize),
    legend.position = 'bottom',
    strip.text = element_text(
      color = 'black',
      size = fontsize)
    ##############
  )
  p1 = ggplot()+
    geom_tile(data = tws_meanm_agg,
              aes(x = Longitude,
                  y = Time,
                  fill = Indices_class
              ))+
    scale_fill_manual(values = tile_col)+
    xlim(c(-180,180))+
    geom_vline(xintercept = 130)+
    geom_vline(xintercept = 0)+
    geom_vline(xintercept = -94.75)+
    theme_bw()+
    text_theme_set
  
  # input of currents ocean
  cur_df = as.data.frame(
    fread('analysis_output/fig4/current_df.csv')
  )
  
  idless50 = which(cur_df$lat <= 50)
  cur_df = cur_df[idless50,]
  
  idbig1 = which(cur_df$u>0 &
                   cur_df$v >0)
  idbig2 = which(cur_df$u<0 &
                   cur_df$v >0)
  
  cur_df1 = cur_df[idbig1,]
  cur_df2 = cur_df[idbig2,]
  
  cid1 = seq(1,nrow(cur_df1),30)
  cid2 = seq(1,nrow(cur_df2),200)
  
  cur_df1 = cur_df1[cid1,]
  cur_df2 = cur_df2[cid2,]
  
  
  cols_cur = c('#2988AE','#30376E')
  
  cluster_traj_df = fread('analysis_output/fig2/cluster_traj_df.csv')
  cluster_traj_df = as.data.frame(cluster_traj_df)
  route_col = pal_npg()(10)[4]
  route_col = colorRampPalette(brewer.pal(10,'Spectral'))(20)
  
  route_col = colorRampPalette(brewer.pal(
    9,'Blues'
  ))(20)
  
  p2 = ggplot()+
    ##############
    geom_polygon(data = world_df,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    
    geom_tile(data = twsdfm,
              aes(x = long,y = lat,fill = cuts))+
    
    scale_fill_manual(values = mycolor,
                      guide = guide_legend(
                        title = 'TWS_MON_SUM',
                        nrow = 3))+
    new_scale_fill()+
    geom_tile(data = pmedfm,
              aes(x = long,y = lat,fill = cuts))+
    scale_fill_manual(values = pmecolor,
                      guide = guide_legend(
                        title = 'PME_MON_SUM',
                        nrow = 3))+
    geom_polygon(data = xj_df,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    
    geom_segment(data = land_scale,
              aes(x = xstart,xend = xend,
                  y = ystart,yend = yend),
              linetype = 'dashed',
              color = 'black',
              size = 0.5)+
    geom_vline(xintercept = 130)+
    stat_contour(data = dem_cropdf,
                 aes(x = long,y = lat,
                     z = dem),
                 breaks = c(2000))+
    geom_segment(data = cur_df1,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.15,'cm'),
                               type = 'open'),
                 color = cols_cur[1])+
    geom_segment(data = cur_df2,
                 aes(x = long,y = lat,
                     xend = long+u,
                     yend = lat+v),
                 arrow = arrow(angle = 20,unit(0.2,'cm'),
                               type = 'open'),
                 color = cols_cur[2])+
    
    ##############
    theme_bw()
  
  traj_points  = data.frame(
    x = c(0,20,39,50,85,115,30,39,20,-10,-90,-25,-45,-60),
    y = c(50,45,51,40,43,36,58,32,28,25,18,5,25,40)
  )
  traj_points1  = data.frame(
    x = c(0,20,39,50),
    y = c(50,45,51,40)
  )
  
  traj_points2  = data.frame(
    x = c(30,39,50),
    y = c(58,51,40)
  )
  traj_points3  = data.frame(
    x = c(-10,20,39,50),
    y = c(25,28,32,40)
  )
  traj_points4 = data.frame(
    x = c(50,85,115),
    y = c(40,43,36)
  )
  
  traj_points5 = data.frame(
    x = c(-90,-45),
    y = c(18,25)
  )
  
  traj_points6 = data.frame(
    x = c(-25,-10),
    y = c(5,25)
  )
  
  
  traj_points7 = data.frame(
    x = c(-45,0),
    y = c(25,50)
  )
  
  
  
  traj_points8 = data.frame(
    x = c(-90,-60,0),
    y = c(18,40,50)
  )
  
  traj_points9 = data.frame(
    x = c(-25,-45),
    y = c(5,25)
  )
  p2 = p2+
    geom_point(data = traj_points,
               aes(x = x,y = y),
               size = 5,
               color = 'blue',
               shape = 1)+
    geom_point(data = traj_points,
               aes(x = x,y = y),
               size = 6,
               color = '#4876FF',
               shape = 1)+
    geom_point(data = traj_points,
               aes(x = x,y = y),
               size = 7,
               color = '#4876FF',
               shape = 1)+
    geom_path(data  =traj_points1,
              aes(x = x,y = y),
              size = 1,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))+
    geom_path(data  =traj_points2,
              aes(x = x,y = y),
              size = 1,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))+
    geom_path(data  =traj_points3,
              aes(x = x,y = y),
              size = 1,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))+
    geom_path(data  =traj_points4,
              aes(x = x,y = y),
              size = 2,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))+
    geom_path(data  =traj_points5,
              aes(x = x,y = y),
              size = 1,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))+
    geom_path(data  =traj_points6,
              aes(x = x,y = y),
              size = 1,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))+
    geom_path(data  =traj_points7,
              aes(x = x,y = y),
              size = 1,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))+
    geom_path(data  =traj_points8,
              aes(x = x,y = y),
              size = 1,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))+
    geom_path(data  =traj_points9,
              aes(x = x,y = y),
              size = 1,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))
 
  
  
  p2 = p2+text_theme_set+
    geom_vline(xintercept = 0)+
    geom_vline(xintercept = -94.75)+
    theme(
      strip.text = element_blank()
    )
  
  
  world_crop = crop(world,
                    extent(0,130,30,60))
  
  world_df_crop = fortify(world_crop,xy = T)
  
  p3 = ggplot()+
    ##############
    geom_polygon(data = world_df_crop,
                             aes(x = long,y = lat,group = group),
                             fill = 'transparent',
                             color = 'black',
                             size = 0.5)+
    
    geom_tile(data = twsdfm,
              aes(x = long,y = lat,fill = cuts))+
    
    scale_fill_manual(values = mycolor)+
    new_scale_fill()+
    geom_tile(data = pmedfm,
              aes(x = long,y = lat,fill = cuts))+
    scale_fill_manual(values = pmecolor)+
    geom_polygon(data = xj_df,
                 aes(x = long,y = lat,group = group),
                 fill = 'transparent',
                 color = 'black',
                 size = 0.5)+
    #geom_vline(xintercept = 130)+
    stat_contour(data = dem_cropdf,
                 aes(x = long,y = lat,
                     z = dem),
                 breaks = c(2000))+
    xlim(c(0,130))+
    ylim(c(30,60))+
    ##############
    theme_bw()
  p3 = p3+
    geom_text_contour(
      data = dem_cropdf,
      aes(x = long,y = lat,
          z = dem),
      breaks = 2000,
      size = 5,
      check_overlap = T
    )
    
  p3 = p3+text_theme_set
  
  p3 = p3+
    geom_point(data = traj_points,
               aes(x = x,y = y),
               size = 5,
               color = 'blue',
               shape = 1)+
    geom_point(data = traj_points,
               aes(x = x,y = y),
               size = 6,
               color = '#4876FF',
               shape = 1)+
    geom_point(data = traj_points,
               aes(x = x,y = y),
               size = 7,
               color = '#4876FF',
               shape = 1)+
    geom_path(data  =traj_points1,
              aes(x = x,y = y),
              size = 1,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))+
    geom_path(data  =traj_points2,
              aes(x = x,y = y),
              size = 1,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))+
    geom_path(data  =traj_points3,
              aes(x = x,y = y),
              size = 1,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))+
    geom_path(data  =traj_points4,
              aes(x = x,y = y),
              size = 2,
              linetype = 1,
              color = '#4876FF',
              arrow=arrow(angle=30,length=unit(0.2,"inches"),
                          type="open"))
  
  world_crop2 = crop(world,
                     extent(-94.75,180,30,60))
  world_crop2_df = fortify(world_crop2,xy = T)
  textdf = data.frame(
    x = c(140),
    y = c(59),
    label = c('(E180.00°, N60.00°)')
  )
  textdf2 = data.frame(
    label = '(W94.75°, N30.00°)',
    x  = -55,
    y = 31
  )
  p4 = ggplot()+
    ##############
  geom_polygon(data = world_crop2_df,
               aes(x = long,y = lat,group = group),
               fill = 'grey80',
               color = 'black',
               size = 0.5,
               alpha = 0.7)+
    ##############
    theme_void()+
    xlim(-94.75,180)+
    ylim(30,60)+
    geom_vline(xintercept = -94.75)+
    geom_vline(xintercept = 180)+
    geom_hline(yintercept = 30)+
    geom_hline(yintercept = 60)+
    #coord_fixed(1.3)+
    theme(
      legend.position = 'none'
    )
  
  p1 = p1 + theme(
    legend.position = 'none',
    axis.title = element_blank()
  )
  
  p3 = p3+theme(
    legend.position = 'none',
    axis.title = element_blank()
  )
  
  p2 = p2+theme(
    legend.position = 'none',
    axis.title = element_blank()
  )
  
  
  library(cowplot)
  
  p23 = plot_grid(
    p1,p2,p3,
    align = 'hv',
    axis = 'lr',
    rel_widths = c(1,1,1),
    rel_heights = c(1.5,2,2),
    ncol = 1
  )
  
  p234 = ggdraw()+
    draw_plot(p23)+
    draw_plot(p4,x = 0.06, y = 0.82,
              width = 0.23,height = 0.1)
  
  
  
  
  dir.create('main_plot/fig3')
  png('main_plot/fig3/fig3_3.png',
      height = 27,
      width = 25,
      units = 'cm',
      res = 800)
  print(p234)
  dev.off()
  
  p1_leg = p1+theme(
    legend.position = 'bottom'
  )+
  guides(fill = guide_legend(nrow = 3))
  
  p2_leg = p2+theme(
    legend.position = 'bottom'
  )
  
  library(ggpubr)
  p1_leg = get_legend(p1_leg)
  p2_leg = get_legend(p2_leg)
  p1_leg = as_ggplot(p1_leg)
  p2_leg = as_ggplot(p2_leg)
  
  
  png('main_plot/fig3/fig3_leg1.png',
      height = 5,
      width = 28,
      units = 'cm',
      res = 800)
  print(p1_leg)
  dev.off()
  png('main_plot/fig3/fig3_leg2.png',
      height =5,
      width = 40,
      units = 'cm',
      res = 800)
  print(p2_leg)
  dev.off()
}
speed_up_krige<-function(
  df,
  locdf
){
  library(maps)
  library(fields)
  library(ggplot2)
  library(geoR)
  library(maptools)
  library(png)
  700
  df = loc1
  
  locdf = df[,1:2]
  
  subs_long = seq(-180,180,180)
  subs_lat = seq(-60,90,75)
  
  subslong1 = rep(subs_long[1:2],2)
  subslong2 = rep(subs_long[2:3],2)
  
  subslat1 = rep(subs_lat[1:2],each = 2)
  subslat2 = rep(subs_lat[2:3],each = 2)
  
  cond = cbind(subslong1,subslong2,subslat1,subslat2)
  
  i = 1:nrow(cond)
  cond <<- cond
  df <<- df
  locdf <<- locdf
  group_by_df <-function(i){
    longdf = locdf[,1]
    latdf = locdf[,2]
    
    id = which(longdf >=cond[i,1] &
                 longdf <=cond[i,2] &
                 latdf >= cond[i,3] &
                 latdf <= cond[i,4])
    return(id)
  }
  
  idli = lapply(i,group_by_df)
  idli <<- idli
  i <<- 1:length(idli)
  idre_fun <-function(i){
    len = length(idli[[i]])
    if(len == 0){
      return(i)
    }
  }
  idtell = lapply(i,idre_fun)
  idtell = do.call('c',idtell)
  
  idli = idli[-idtell]
  cond = cond[-idtell,]
  
  i = 1:length(idli)
  len_tell<-function(i){
    len = length(idli[[i]])
    return(len)
  }
  lens = lapply(i,len_tell)
  lens = do.call('c',lens)
  
  i <<- 1:length(idli)
  df <<- df
  cond <<- cond
  idli <<- idli
  
  long = seq(-180,180,0.5)
  lat = seq(-60,90,0.5)
  grid = expand.grid(long,lat)
  
  world = shp_management('world')
  
  inusa <-map.where(world,x=grid[,1],y=grid[,2])
  inusa <-!is.na(inusa)
  grid <-grid[inusa,]
  
  grid2 <<- grid
  
  cluster_krig <-function(i){
    
    library(gstat)
    library(raster)
    library(sp)
    idgrid = which(grid2[,1]>=cond[i,1]&
               grid2[,1]<=cond[i,2]&
               grid2[,2]>=cond[i,3]&
               grid2[,2]<=cond[i,4])
    
    tmpgrid = grid2[idgrid,]
    tmpgridloc = tmpgrid
    
    tmpgrid = SpatialPoints(tmpgrid)
    gridded(tmpgrid) = T
    
    m <- vgm(.59, "Sph", 874, .04)
    tmpdf = df[idli[[i]],]
    colnames(tmpdf) = c('long','lat','pr')
    coordinates(tmpdf) = ~long+lat
    
    tmpx = krige(pr~1,tmpdf,tmpgrid,
              model = m,beta = 5.9)
    
    pred = tmpx$var1.pred
    pred[which(pred<0)] = 0
    ret = data.frame(
      long = tmpgridloc[,1],
      lat = tmpgridloc[,2],
      pr = pred
    )
    return(ret)
  }
  
  cl = makeCluster(14)
  clusterExport(cl,c('i','cond','grid2',
                     'df','idli'))
  system.time(retdf <- parLapply(cl,i,cluster_krig))
  stopCluster(cl)
  
  retdf = do.call('rbind',retdf)
  
  xpred = x$var1.pred
  xpred[which(xpred<0)] =0
  retdf$pr - x$var1.pred
  
  coordinates(retdf) = ~long+lat
  gridded(retdf) = T
  r2 = raster(retdf)
  plot(r2)
}

































speed_up_krige2<-function(
  df,
  locdf
){
  library(maps)
  library(fields)
  library(ggplot2)
  library(geoR)
  library(maptools)
  library(png)
  library(maps)
  library(fields)
  library(ggplot2)
  library(geoR)
  library(maptools)
  library(png)
  700
  df = loc1
  
  locdf = df[,1:2]
  
  
  
  long = seq(-180,180,0.5)
  lat = seq(-60,90,0.5)
  grid = expand.grid(long,lat)
  
  world = shp_management(pattern = 'land',names = 'eu')
  
  inusa <-map.where(world,x=grid[,1],y=grid[,2])
  inusa <-!is.na(inusa)
  grid <-grid[inusa,]
  
  grid2 <<- grid
  
  cond = extent(world)
  
  cluster_krig <-function(i){
    
    library(gstat)
    library(raster)
    library(sp)
    idgrid = which(grid2[,1]>=cond[1]&
                     grid2[,1]<=cond[2]&
                     grid2[,2]>=cond[i,3]&
                     grid2[,2]<=cond[i,4])
    
    tmpgrid = grid2[idgrid,]
    tmpgridloc = tmpgrid
    
    tmpgrid = SpatialPoints(tmpgrid)
    gridded(tmpgrid) = T
    
    m <- vgm(.59, "Sph", 874, .04)
    tmpdf = df[idli[[i]],]
    colnames(tmpdf) = c('long','lat','pr')
    coordinates(tmpdf) = ~long+lat
    
    tmpx = krige(pr~1,tmpdf,tmpgrid,
                 model = m,beta = 5.9)
    
    pred = tmpx$var1.pred
    pred[which(pred<0)] = 0
    ret = data.frame(
      long = tmpgridloc[,1],
      lat = tmpgridloc[,2],
      pr = pred
    )
    return(ret)
  }
  
  cl = makeCluster(14)
  clusterExport(cl,c('i','cond','grid2',
                     'df','idli'))
  system.time(retdf <- parLapply(cl,i,cluster_krig))
  stopCluster(cl)
  
  retdf = do.call('rbind',retdf)
  
  xpred = x$var1.pred
  xpred[which(xpred<0)] =0
  retdf$pr - x$var1.pred
  
  coordinates(retdf) = ~long+lat
  gridded(retdf) = T
  r2 = raster(retdf)
  plot(r2)
}

































spei_fun<-function(x,scale=3){
  library(SPEI)
  x = ts(x,c(2003,1),frequency = 12)
  spei3 = spei(x,scale)
  spei3 = spei3$fitted
  return(spei3)
}
sst_analysis <-function(
  
){
  # cal mean sst analysis 
  input_ato_shp = paste0('cluster_shp/ato/ato',
                         1:4,'.shp')
  
  sst = data_management('global_era5_sst')
  sst = sst[[1:174]]
  sst = sst - 273.15
  
  sub_mean_fun<-function(x){
    x = cellStats(x,'mean')
    return(x)
  }
  trend_fun <-function(x){
    xt = ts(x,start = c(2003,1),frequency = 12)
    xt = decompose(xt)$trend
    
    xt = as.numeric(xt)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }
  ato_sst = 1
  
  for(i in 1:4){
    tmpshp = shapefile(input_ato_shp[i])
    
    tmpsst = crop(sst,tmpshp)
    tmpsst = as.list(tmpsst)
    
    sst_mean = lapply(tmpsst,sub_mean_fun)
    
    sst_mean = do.call('c',sst_mean)
    sst_mean = sst_mean[1:174]
    
    sst_meant = trend_fun(sst_mean)
    
    ato_sst = cbind(ato_sst,sst_meant)
  }
  ato_sst =ato_sst[,-1]
  
  output = 'analysis_output/ato_mean_trend_sst.csv'
  write.csv(ato_sst,output)
  
}
sst_mean_monthly_analysis<-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  sst = data_management('global_era5_sst')
  world = shp_management('world')
  
  world = crop(world,extent(-180,180,0,90))
  
  sst = crop(sst,world)
  sst = mask(sst,world)
  
  janid = seq(1,174,12)
  febid = seq(2,174,12)
  marid = seq(3,174,12)
  aprid = seq(4,174,12)
  mayid = seq(5,174,12)
  junid = seq(6,174,12)
  julid = seq(7,174,12)
  augid = seq(8,174,12)
  sepid = seq(9,174,12)
  octid = seq(10,174,12)
  novid = seq(11,174,12)
  decid = seq(12,174,12)
  
  monid = list(janid,febid,marid,aprid,
               mayid,junid,julid,augid,
               sepid,octid,novid,decid)
  
  
  
  monid <<- monid
  sst <<- sst
  
  cell_mean_fun <-function(i){
    tmpid = monid[[i]]
    tmptws = tws[[tmpid]]
    
    
    tmptwsdf = as.data.frame(tmptws,
                             xy = T)
    loc = tmptwsdf[,1:2]
    tmptwsdf = tmptwsdf[,-c(1,2)]
    
    tmptwsmean = apply(tmptwsdf,1,mean
                       ,na.rm = T)
    retbox = cbind(loc,tmptwsmean)
    return(retbox)
  }
  i = 1:length(monid)
  mon_mean_box = lapply(i,cell_mean_fun)
  
  sstmean1 = mon_mean_box[[1]]
  sstmean2 = mon_mean_box[[2]][,3]
  sstmean3 = mon_mean_box[[3]][,3]
  sstmean4 = mon_mean_box[[4]][,3]
  sstmean5 = mon_mean_box[[5]][,3]
  sstmean6 = mon_mean_box[[6]][,3]
  sstmean7 = mon_mean_box[[7]][,3]
  sstmean8 = mon_mean_box[[8]][,3]
  sstmean9 = mon_mean_box[[9]][,3]
  sstmean10 = mon_mean_box[[10]][,3]
  sstmean11 = mon_mean_box[[11]][,3]
  sstmean12 = mon_mean_box[[12]][,3]
  
  sstmean_mon = cbind(sstmean1,
                      sstmean2,
                      sstmean3,
                      sstmean4,
                      sstmean5,
                      sstmean6,
                      sstmean7,
                      sstmean8,
                      sstmean9,
                      sstmean10,
                      sstmean11,
                      sstmean12)
  
  output_sst_mean = 'analysis_output/fig3/ocesst_mean.csv'
  #fwrite(mon_mean_box,output_sst_mean)
  fwrite(sstmean_mon,output_sst_mean)
  
  
}
stand_fun<-function(
  x,mode = 'other'
){
  if(mode == "grace"){
    xs= x/(max(x)-min(x))  
  }else{
    xs= (x -mean(x))/(max(x)-min(x))
  }
  
  return(xs)
}
sub_cal_mean_eva_in_source<-function(
  mode = 'ato'
){
  
  # input file 
  input = '/media/sdb5/Data/era5_eva_masked_in_source'
  input = paste0(input ,'/',mode)
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/era5_source_eva_2003_2017.nc')
  input <<- input  
  # output
  output = 'era5_eva_mean'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output = paste0(output,'/region',1:4)
  sapply(output,dir.create)
  output = paste0(output,'/era5_eva_mean.csv')
  
  output <<- output
  # cal ep sum 
  
  sum_ep <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    tmp = stack(input[i])
    
    sum_fun <-function(x){
      x = cellStats(x,'mean',na.rm = T)
      return(x)
    }
    
    tmp = as.list(tmp)
    ret = lapply(tmp,sum_fun)
    ret = do.call(c,ret)
    
    ret = as.numeric(ret)
    #$id = which(ret <0)
    #ret[id] = 0
    
    ret =  matrix(ret,ncol =1)
    colnames(ret) = 'ERA5'
    
    fwrite(ret,output[i])
  }
  
  i <<- 1:4
  library(doParallel)
  
  cl = makeCluster(4)
  clusterExport(cl,c('i','input','output'))
  parLapply(cl,i,sum_ep)
  stopCluster(cl)
  
  print(paste0('Pass',mode))
  
}
sub_cal_mean_pe_in_source<-function(
  mode = 'ato'
){
  
  # input file 
  input = '/media/sdb5/Data/era5_pe_masked'
  input = paste0(input ,'/',mode)
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/era5_source_pe_2003_2017.nc')
  input <<- input  
  # output
  output = 'era5_pe_mean'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output = paste0(output,'/region',1:4)
  sapply(output,dir.create)
  output = paste0(output,'/era5_pe_sum.csv')
  
  output <<- output
  # cal ep sum 
  
  sum_ep <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    tmp = stack(input[i])
    
    sum_fun <-function(x){
      x = cellStats(x,'mean',na.rm = T)
      return(x)
    }
    
    tmp = as.list(tmp)
    ret = lapply(tmp,sum_fun)
    ret = do.call(c,ret)
    
    ret = as.numeric(ret)
    #$id = which(ret <0)
    #ret[id] = 0
    
    ret =  matrix(ret,ncol =1)
    colnames(ret) = 'ERA5'
    
    fwrite(ret,output[i])
  }
  
  i <<- 1:4
  library(doParallel)
  
  cl = makeCluster(4)
  clusterExport(cl,c('i','input','output'))
  parLapply(cl,i,sum_ep)
  stopCluster(cl)
  
  print(paste0('Pass',mode))
  
}
sub_cal_mean_pr_in_source<-function(
  mode = 'ato'
){
  
  # input file 
  input = '/media/sdb5/Data/era5_pr_masked'
  input = paste0(input ,'/',mode)
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/era5_source_pr_2003_2017.nc')
  input <<- input  
  # output
  output = 'era5_pr_mean'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output = paste0(output,'/region',1:4)
  sapply(output,dir.create)
  output = paste0(output,'/era5_pr_mean.csv')
  
  output <<- output
  # cal ep sum 
  
  sum_ep <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    tmp = stack(input[i])
    
    sum_fun <-function(x){
      x = cellStats(x,'mean',na.rm = T)
      return(x)
    }
    
    tmp = as.list(tmp)
    ret = lapply(tmp,sum_fun)
    ret = do.call(c,ret)
    
    ret = as.numeric(ret)
    #$id = which(ret <0)
    #ret[id] = 0
    
    ret =  matrix(ret,ncol =1)
    colnames(ret) = 'ERA5'
    
    fwrite(ret,output[i])
  }
  
  i <<- 1:4
  library(doParallel)
  
  cl = makeCluster(4)
  clusterExport(cl,c('i','input','output'))
  parLapply(cl,i,sum_ep)
  stopCluster(cl)
  
  print(paste0('Pass',mode))
  
}
sub_cal_mean_sst_in_source<-function(
  mode = 'ato'
){
  
  # input file 
  input = '/media/sdb5/Data/era5_sst_masked'
  input = paste0(input ,'/',mode)
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/era5_source_sst_2003_2017.nc')
  input <<- input  
  # output
  output = 'era5_sst_mean'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output = paste0(output,'/region',1:4)
  sapply(output,dir.create)
  output = paste0(output,'/era5_sst_mean.csv')
  
  output <<- output
  # cal ep sum 
  
  sum_ep <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    tmp = stack(input[i])
    
    sum_fun <-function(x){
      x = cellStats(x,'mean',na.rm = T)
      return(x)
    }
    
    tmp = as.list(tmp)
    ret = lapply(tmp,sum_fun)
    ret = do.call(c,ret)
    
    ret = as.numeric(ret)
    #$id = which(ret <0)
    #ret[id] = 0
    
    ret =  matrix(ret,ncol =1)
    colnames(ret) = 'ERA5'
    
    fwrite(ret,output[i])
  }
  
  i <<- 1:4
  library(doParallel)
  
  cl = makeCluster(4)
  clusterExport(cl,c('i','input','output'))
  parLapply(cl,i,sum_ep)
  stopCluster(cl)
  
  print(paste0('Pass',mode))
  
}
sub_cal_mean_tas_in_source<-function(
  mode = 'ato'
){
  
  # input file 
  input = '/media/sdb5/Data/era5_tas_masked'
  input = paste0(input ,'/',mode)
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/era5_source_tas_2003_2017.nc')
  input <<- input  
  # output
  output = 'era5_tas_mean'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output = paste0(output,'/region',1:4)
  sapply(output,dir.create)
  output = paste0(output,'/era5_tas_mean.csv')
  
  output <<- output
  # cal ep sum 
  
  sum_ep <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    tmp = stack(input[i])
    
    sum_fun <-function(x){
      x = cellStats(x,'mean',na.rm = T)
      return(x)
    }
    
    tmp = as.list(tmp)
    ret = lapply(tmp,sum_fun)
    ret = do.call(c,ret)
    
    ret = as.numeric(ret)
    #$id = which(ret <0)
    #ret[id] = 0
    
    ret =  matrix(ret,ncol =1)
    colnames(ret) = 'ERA5'
    
    fwrite(ret,output[i])
  }
  
  i <<- 1:4
  library(doParallel)
  
  cl = makeCluster(4)
  clusterExport(cl,c('i','input','output'))
  parLapply(cl,i,sum_ep)
  stopCluster(cl)
  
  print(paste0('Pass',mode))
  
}
sub_cal_random_forest_importance<-function(
  df
){
  # libr
  library(randomForest)
  
  set.seed(100)
  id_train = sample(nrow(df),0.7*nrow(df),replace = FALSE)
  #id_train = 1:round(0.7*nrow(df))
  train = df[id_train,]
  test = df[-id_train,]
  
  set.seed(432)
  model_ini = randomForest(tws ~ ., data = train,
                           importance = T,
                           ntree = 500,
                           mtry = 3
                           
  )
  
  # PREDICTING WITH INITIAL MODEL
  pred_train = as.numeric(predict(model_ini,train))
  pred_test =  as.numeric(predict(model_ini,test))
  
  library(caret)
  # tune mtry
  mtry_len = ncol(df)-1
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = 1:mtry_len)
  
  set.seed(432)
  rf_mtry = train(tws ~ .,
                  data = train,
                  method = 'rf',
                  tuneGrid = tuneGrid,
                  trControl = trControl,
                  importance = T
  )
  
  rf_mtry_res = rf_mtry$results[,1:2]
  
  id_mtry = which.min(rf_mtry_res$RMSE)
  
  rf_mtry_best = rf_mtry_res[id_mtry,1]
  
  
  # find number of trees
  
  trControl = trainControl(method = 'cv',number = 10,
                           search = 'grid')
  
  tuneGrid = expand.grid(mtry = rf_mtry_best)
  
  mod_par_cart = 1
  for(ntree in seq(100,1000,100)){
    set.seed(432)
    rf_mtry = train(tws ~ .,
                    data = train,
                    method = 'rf',
                    ntree = ntree,
                    tuneGrid = tuneGrid,
                    trControl = trControl,
                    importance = T
    )
    
    rf_mod = rf_mtry$results[,c(1,2)]
    rf_mod = cbind(rf_mod,ntree)
    mod_par_cart = rbind(mod_par_cart,rf_mod)
  }
  mod_par_cart = mod_par_cart[-1,]
  
  id_best = which.min(mod_par_cart$RMSE)
  
  ntree_best = mod_par_cart[id_best,3]
  
  set.seed(432)
  
  model_best = randomForest(tws ~ ., data = train,
                            importance = T,
                            ntree = ntree_best,
                            mtry = rf_mtry_best
  )

  importance = model_best$importance
  
  return(importance)
  
}











sub_cal_sum_ep_in_source<-function(
  mode = 'ato'
){
  
  # input file 
  input = '/media/sdb5/Data/era5_ep_masked'
  input = paste0(input ,'/',mode)
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/era5_source_ep_2003_2017.nc')
  input <<- input  
  # output
  output = 'era5_ep_sum'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output = paste0(output,'/region',1:4)
  sapply(output,dir.create)
  output = paste0(output,'/era5_ep_sum.csv')
  
  output <<- output
  # cal ep sum 
  
  sum_ep <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    tmp = stack(input[i])
    
    sum_fun <-function(x){
      x = cellStats(x,'sum',na.rm = T)
      return(x)
    }
    
    tmp = as.list(tmp)
    ret = lapply(tmp,sum_fun)
    ret = do.call(c,ret)
    
    ret = as.numeric(ret)
    id = which(ret <0)
    ret[id] = 0
    
    ret =  matrix(ret,ncol =1)
    colnames(ret) = 'ERA5'
    
    fwrite(ret,output[i])
  }
  
  i <<- 1:4
  library(doParallel)
  
  cl = makeCluster(4)
  clusterExport(cl,c('i','input','output'))
  parLapply(cl,i,sum_ep)
  stopCluster(cl)
  
  print(paste0('Pass',mode))
  
}
sub_cal_sum_eva_in_source<-function(
  mode = 'ato'
){
  
  # input file 
  input = '/media/sdb5/Data/era5_eva_masked_in_source'
  input = paste0(input ,'/',mode)
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/era5_source_eva_2003_2017.nc')
  input <<- input  
  # output
  output = 'era5_eva_sum'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output = paste0(output,'/region',1:4)
  sapply(output,dir.create)
  output = paste0(output,'/era5_eva_sum.csv')
  
  output <<- output
  # cal ep sum 
  
  sum_ep <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    tmp = stack(input[i])
    
    sum_fun <-function(x){
      x = cellStats(x,'sum',na.rm = T)
      return(x)
    }
    
    tmp = as.list(tmp)
    ret = lapply(tmp,sum_fun)
    ret = do.call(c,ret)
    
    ret = as.numeric(ret)
    #$id = which(ret <0)
    #ret[id] = 0
    
    ret =  matrix(ret,ncol =1)
    colnames(ret) = 'ERA5'
    
    fwrite(ret,output[i])
  }
  
  i <<- 1:4
  library(doParallel)
  
  cl = makeCluster(4)
  clusterExport(cl,c('i','input','output'))
  parLapply(cl,i,sum_ep)
  stopCluster(cl)
  
  print(paste0('Pass',mode))
  
}
sub_cal_sum_pe_in_source<-function(
  mode = 'ato'
){
  
  # input file 
  input = '/media/sdb5/Data/era5_pe_masked'
  input = paste0(input ,'/',mode)
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/era5_source_pe_2003_2017.nc')
  input <<- input  
  # output
  output = 'era5_pe_sum'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output = paste0(output,'/region',1:4)
  sapply(output,dir.create)
  output = paste0(output,'/era5_pe_sum.csv')
  
  output <<- output
  # cal ep sum 
  
  sum_ep <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    tmp = stack(input[i])
    
    sum_fun <-function(x){
      x = cellStats(x,'sum',na.rm = T)
      return(x)
    }
    
    tmp = as.list(tmp)
    ret = lapply(tmp,sum_fun)
    ret = do.call(c,ret)
    
    ret = as.numeric(ret)
    #$id = which(ret <0)
    #ret[id] = 0
    
    ret =  matrix(ret,ncol =1)
    colnames(ret) = 'ERA5'
    
    fwrite(ret,output[i])
  }
  
  i <<- 1:4
  library(doParallel)
  
  cl = makeCluster(4)
  clusterExport(cl,c('i','input','output'))
  parLapply(cl,i,sum_ep)
  stopCluster(cl)
  
  print(paste0('Pass',mode))
  
}
sub_cal_sum_pet_in_source<-function(
  mode = 'ato'
){
  
  # input file 
  input = '/media/sdb5/Data/era5_pet_masked'
  input = paste0(input ,'/',mode)
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/era5_source_pet_2003_2017.nc')
  input <<- input  
  # output
  output = 'era5_pet_sum'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output = paste0(output,'/region',1:4)
  sapply(output,dir.create)
  output = paste0(output,'/era5_pet_sum.csv')
  
  output <<- output
  # cal ep sum 
  
  sum_ep <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    tmp = stack(input[i])
    
    sum_fun <-function(x){
      x = cellStats(x,'sum',na.rm = T)
      return(x)
    }
    
    tmp = as.list(tmp)
    ret = lapply(tmp,sum_fun)
    ret = do.call(c,ret)
    
    ret = as.numeric(ret)
    #$id = which(ret <0)
    #ret[id] = 0
    
    ret =  matrix(ret,ncol =1)
    colnames(ret) = 'ERA5'
    
    fwrite(ret,output[i])
  }
  
  i <<- 1:4
  library(doParallel)
  
  cl = makeCluster(4)
  clusterExport(cl,c('i','input','output'))
  parLapply(cl,i,sum_ep)
  stopCluster(cl)
  
  print(paste0('Pass',mode))
  
}
sub_cal_sum_pr_in_source_based_gpcc<-function(
  mode = 'ato'
){
  
  # input file 
  input = '/media/sdb5/Data/gpcc_pr_masked'
  input = paste0(input ,'/',mode)
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/gpcc_source_pr_2003_2017.nc')
  input <<- input  
  # output
  output = 'gpcc_pr_sum'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output = paste0(output,'/region',1:4)
  sapply(output,dir.create)
  output = paste0(output,'/gpcc_pr_sum.csv')
  
  output <<- output
  # cal ep sum 
  
  sum_ep <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    tmp = stack(input[i])
    
    sum_fun <-function(x){
      x = cellStats(x,'sum',na.rm = T)
      return(x)
    }
    
    tmp = as.list(tmp)
    ret = lapply(tmp,sum_fun)
    ret = do.call(c,ret)
    
    ret = as.numeric(ret)
    #$id = which(ret <0)
    #ret[id] = 0
    
    ret =  matrix(ret,ncol =1)
    colnames(ret) = 'gpcc'
    
    fwrite(ret,output[i])
  }
  
  i <<- 1:4
  library(doParallel)
  
  cl = makeCluster(4)
  clusterExport(cl,c('i','input','output'))
  parLapply(cl,i,sum_ep)
  stopCluster(cl)
  
  print(paste0('Pass',mode))
  
}
sub_cal_sum_pr_in_source<-function(
  mode = 'ato'
){
  
  # input file 
  input = '/media/sdb5/Data/era5_pr_masked'
  input = paste0(input ,'/',mode)
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/era5_source_pr_2003_2017.nc')
  input <<- input  
  # output
  output = 'era5_pr_sum'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output = paste0(output,'/region',1:4)
  sapply(output,dir.create)
  output = paste0(output,'/era5_pr_sum.csv')
  
  output <<- output
  # cal ep sum 
  
  sum_ep <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    tmp = stack(input[i])
    
    sum_fun <-function(x){
      x = cellStats(x,'sum',na.rm = T)
      return(x)
    }
    
    tmp = as.list(tmp)
    ret = lapply(tmp,sum_fun)
    ret = do.call(c,ret)
    
    ret = as.numeric(ret)
    #$id = which(ret <0)
    #ret[id] = 0
    
    ret =  matrix(ret,ncol =1)
    colnames(ret) = 'ERA5'
    
    fwrite(ret,output[i])
  }
  
  i <<- 1:4
  library(doParallel)
  
  cl = makeCluster(4)
  clusterExport(cl,c('i','input','output'))
  parLapply(cl,i,sum_ep)
  stopCluster(cl)
  
  print(paste0('Pass',mode))
  
}
sub_cal_sum_tws_in_source<-function(
  mode = 'ato'
){
  
  # input file 
  input = '/media/sdb5/Data/tws_in_source'
  input = paste0(input ,'/',mode)
  input = paste0(input,'/region',1:4)
  input = paste0(input,'/tws_in_source_2003_2017.nc')
  input <<- input  
  # output
  output = 'tws_in_source'
  dir.create(output)
  output = paste0(output,'/',mode)
  dir.create(output)
  output = paste0(output,'/region',1:4)
  sapply(output,dir.create)
  output = paste0(output,'/tws_sum.csv')
  
  output <<- output
  # cal ep sum 
  
  sum_ep <- function(i){
    library(raster)
    library(ncdf4)
    library(data.table)
    tmp = stack(input[i])
    
    sum_fun <-function(x){
      x = cellStats(x,'sum',na.rm = T)
      return(x)
    }
    
    tmp = as.list(tmp)
    ret = lapply(tmp,sum_fun)
    ret = do.call(c,ret)
    
    ret = as.numeric(ret)
    #$id = which(ret <0)
    #ret[id] = 0
    
    ret =  matrix(ret,ncol =1)
    colnames(ret) = 'TWS'
    
    fwrite(ret,output[i])
  }
  
  i <<- 1:4
  library(doParallel)
  
  cl = makeCluster(4)
  clusterExport(cl,c('i','input','output'))
  parLapply(cl,i,sum_ep)
  stopCluster(cl)
  
  print(paste0('Pass',mode))
  
}
sub_mmk_test <-function(d)
{
  df = d
  df = as.data.frame(df,xy = T)
  df = df[-which(is.na(df[,3])),]
  loc = df[,1:2]
  df = df[,-c(1,2)]
  sub_mmk <- function(x){
    source('/home/share/R_project/xinjiang_vapor/mmkTrend.R')
    x = as.numeric(x)
    tr = mmkTrend(x)$Zc
    return(tr)
  }
  df = apply(df,1,sub_mmk)
  df = data.frame(loc,df)
  colnames(df) = c('x','y','mmk')
  
  ggplot()+
    geom_tile(data = df,
              aes(x =x,y = y,fill =mmk))
}
sub_train_based_era5_cmip6_ssp245_proj_trend <- function(
  
){
  SWs = paste0('SW',1:10)
  path = 'analysis_output/figS_proj_pme_trend'
  dir.create(path)
  output_train_245 = paste0(path,'/train_ssp245')
  output_valid_245 = paste0(path,'/valid_ssp245')
  output_imp_245 = paste0(path,'/import_ssp245')
  
  dir.create(output_train_245)
  dir.create(output_valid_245)
  dir.create(output_imp_245)
  
  output_train_245 = paste0(output_train_245,'/',
                            SWs,'.csv')
  output_valid_245 = paste0(output_valid_245,'/',
                            SWs,'.csv')
  output_imp_245 = paste0(output_imp_245,
                          '/',SWs,'.csv')
  
  SWs<<- SWs
  output_train_245 <<- output_train_245
  output_valid_245 <<- output_valid_245
  output_imp_245<<- output_imp_245
  
  sub_train_fun245 <-function(i){
    print(i)
    tws_sw = twsdf[,i]
    naid = which(is.na(tws_sw))
    tws_sw = tws_sw[-naid]
    tws_sw <<- tws_sw
    
    # building up model between tws and 
    # grace 
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws_era5_cmip6.R')
    df = data.frame(
      tws = tws_sw,
      pme1 = era5_pme[,1],
      pme3 = era5_pme[,2]
      #sst1 = era5_sst[,1],
      #sst3 = era5_sst[,2]
    )
    
    pme1_pj245 = as.matrix(pme1_ssp245[1:390,])
    pme3_pj245 = as.matrix(pme3_ssp245[1:390,])
    sst1_pj245 = as.matrix(sst1_ssp245[1:390,])
    sst3_pj245 = as.matrix(sst3_ssp245[1:390,])
    
    source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
    #pme1_pj245 = trend_fun(pme1_pj245)
    #pme3_pj245 = trend_fun(pme3_pj245)
    #sst1_pj245 = trend_fun(sst1_pj245)
    sst3_pj245 = trend_fun(sst3_pj245)
    
    naid = which(is.na(pme3_pj245[,1]))
    #pme3_pj245 = pme3_pj245[-naid,]
    sst3_pj245 = sst3_pj245[-naid,]
    #pme1_pj245 = pme1_pj245[-naid,]
    
    ret_box = random_forest_model_tws_era5_cmip6(df)
    ret_box_train = ret_box[[1]]
    ret_box_valid = ret_box[[2]]
    model_best = ret_box[[3]]
    
    impmat = model_best$importance
    
    colnames(ret_box_train) = c('TWS_OBS',
                                'TWS_PROJ')
    colnames(ret_box_valid) = c('TWS_OBS',
                                "TWS_PROJ")
    
    ret_box_train$SWs = SWs[i]
    ret_box_valid$SWs = SWs[i]
    
    library(data.table)
    fwrite(ret_box_train
           ,output_train_245[i])
    fwrite(ret_box_valid,
           output_valid_245[i])
    fwrite(impmat,
           output_imp_245[i])
    
    
    pred_mean_box = 1
    pred_max_box = 1
    pred_min_box = 1
    
    for(j in 1:ncol(pme3_pj245)){
      df_project = data.frame(
        pme1= pme1_pj245[,j],
        pme3 = pme3_pj245[,j]
        #sst3 = sst3_pj245[,j]
      )
      cl_con_inter <- function(x){
        c(mean(x),quantile(x,c(0.05,0.95)))
      }
      
      pred_tws = predict(model_best,
                         df_project,
                         predict.all = T)
      pred_box = t(apply(pred_tws$individual,
                         1,cl_con_inter))
      
      pred_mean = predict(model_best,
                          df_project)
      pred_max = pred_box[,3]
      pred_min = pred_box[,2]
      
      pred_mean_box = cbind(pred_mean_box,
                            pred_mean)
      pred_max_box = cbind(pred_max_box,
                           pred_max)
      pred_min_box = cbind(pred_min_box,
                           pred_min)
    }
    pred_mean_box = pred_mean_box[,-1]
    pred_min_box = pred_min_box[,-1]
    pred_max_box = pred_max_box[,-1]
    
    pred_mean = apply(pred_mean_box,1,mean)
    pred_max = apply(pred_max_box,1,mean)
    pred_min = apply(pred_min_box,1,mean)
    
    rets = data.frame(
      mean = pred_mean,
      max = pred_max,
      min = pred_min
    )  
    return(rets)
    
    
  }
  
  i = 1:10
  
  i <<- i
  library(doParallel)
  cl = makeCluster(10)
  clusterExport(cl,c('i','twsdf',
                     'era5_pme','era5_sst',
                     'pme3_ssp245',
                     'sst3_ssp245',
                     'pme1_ssp245',
                     'sst1_ssp245'))
  system.time(ret245 <- parLapply(cl,i,
                                  sub_train_fun245))
  stopCluster(cl)
  
  extract_mean_pred <- function(x){
    retmean = 1
    for(i in 1:10){
      retmean = cbind(retmean,x[[i]][,1])
    }
    retmean = retmean[,-1]
    colnames(retmean) = paste0('SW',1:10)
    return(retmean)
  }
  extract_max_pred <- function(x){
    retmax = 1
    for(i in 1:10){
      retmax = cbind(retmax,x[[i]][,2])
    }
    retmax = retmax[,-1]
    colnames(retmax) = paste0('SW',1:10)
    return(retmax)
  }
  extract_min_pred <- function(x){
    retmin = 1
    for(i in 1:10){
      retmin = cbind(retmin,x[[i]][,3])
    }
    retmin = retmin[,-1]
    colnames(retmin) = paste0('SW',1:10)
    return(retmin)
  }
  
  ret_mean = extract_mean_pred(ret245)
  ret_max = extract_max_pred(ret245)
  ret_min = extract_min_pred(ret245)
  
  
  date = seq(as.Date('2018-01-01'),
             as.Date('2050-06-01'),
             '1 month')
  ret_mean = data.frame(
    date =date,
    ret_mean
  )
  
  ret_max = data.frame(
    date = date,
    ret_max
  )
  
  ret_min = data.frame(
    date = date,
    ret_min 
  )
  
  ret_mean = reshape2::melt(ret_mean,'date')
  ret_max = reshape2::melt(ret_max,'date')
  ret_min = reshape2::melt(ret_min,'date')
  
  ret_maxmin = data.frame(
    ret_max[,1:2],
    max = ret_max[,3],
    min = ret_min[,3]
  )
  colnames(ret_mean) = c('date','variable','SSP245')
  
  return(list(ret_mean,ret_maxmin))
}
sub_train_based_era5_cmip6_ssp245_proj <- function(
  
){
  SWs = paste0('SW',1:10)
  path = 'analysis_output/figS_proj_pme'
  dir.create(path)
  output_train_245 = paste0(path,'/train_ssp245')
  output_valid_245 = paste0(path,'/valid_ssp245')
  output_imp_245 = paste0(path,'/import_ssp245')
  
  dir.create(output_train_245)
  dir.create(output_valid_245)
  dir.create(output_imp_245)
  
  output_train_245 = paste0(output_train_245,'/',
                            SWs,'.csv')
  output_valid_245 = paste0(output_valid_245,'/',
                            SWs,'.csv')
  output_imp_245 = paste0(output_imp_245,
                          '/',SWs,'.csv')
  
  SWs<<- SWs
  output_train_245 <<- output_train_245
  output_valid_245 <<- output_valid_245
  output_imp_245<<- output_imp_245
  
  sub_train_fun245 <-function(i){
    print(i)
    tws_sw = twsdf[,i]
    naid = which(is.na(tws_sw))
    tws_sw = tws_sw[-naid]
    tws_sw <<- tws_sw
    
    # building up model between tws and 
    # grace 
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws_era5_cmip6.R')
    df = data.frame(
      tws = tws_sw,
      pme1 = era5_pme[,1],
      pme3 = era5_pme[,2]
      #sst1 = era5_sst[,1],
      #sst3 = era5_sst[,2]
    )
    
    pme1_pj245 = as.matrix(pme1_ssp245[175:576,])
    pme3_pj245 = as.matrix(pme3_ssp245[175:576,])
    sst1_pj245 = as.matrix(sst1_ssp245[175:576,])
    sst3_pj245 = as.matrix(sst3_ssp245[175:576,])
    
    source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
    pme1_pj245 = trend_fun(pme1_pj245)
    pme3_pj245 = trend_fun(pme3_pj245)
    #sst1_pj245 = trend_fun(sst1_pj245)
    sst3_pj245 = trend_fun(sst3_pj245)
    
    naid = which(is.na(pme3_pj245[,1]))
    pme3_pj245 = pme3_pj245[-naid,]
    sst3_pj245 = sst3_pj245[-naid,]
    pme1_pj245 = pme1_pj245[-naid,]
    
    ret_box = random_forest_model_tws_era5_cmip6(df)
    ret_box_train = ret_box[[1]]
    ret_box_valid = ret_box[[2]]
    model_best = ret_box[[3]]
    
    impmat = model_best$importance
    
    colnames(ret_box_train) = c('TWS_OBS',
                                'TWS_PROJ')
    colnames(ret_box_valid) = c('TWS_OBS',
                                "TWS_PROJ")
    
    ret_box_train$SWs = SWs[i]
    ret_box_valid$SWs = SWs[i]
    
    library(data.table)
    fwrite(ret_box_train
           ,output_train_245[i])
    fwrite(ret_box_valid,
           output_valid_245[i])
    fwrite(impmat,
           output_imp_245[i])
    
    
    pred_mean_box = 1
    pred_max_box = 1
    pred_min_box = 1
    
    for(j in 1:ncol(pme3_pj245)){
      df_project = data.frame(
        pme1= pme1_pj245[,j],
        pme3 = pme3_pj245[,j]
        #sst3 = sst3_pj245[,j]
      )
      cl_con_inter <- function(x){
        c(mean(x),quantile(x,c(0.05,0.95)))
      }
      
      pred_tws = predict(model_best,
                         df_project,
                         predict.all = T)
      pred_box = t(apply(pred_tws$individual,
                         1,cl_con_inter))
      
      pred_mean = predict(model_best,
                          df_project)
      pred_max = pred_box[,3]
      pred_min = pred_box[,2]
      
      pred_mean_box = cbind(pred_mean_box,
                            pred_mean)
      pred_max_box = cbind(pred_max_box,
                           pred_max)
      pred_min_box = cbind(pred_min_box,
                           pred_min)
    }
    pred_mean_box = pred_mean_box[,-1]
    pred_min_box = pred_min_box[,-1]
    pred_max_box = pred_max_box[,-1]
    
    pred_mean = apply(pred_mean_box,1,mean)
    pred_max = apply(pred_max_box,1,mean)
    pred_min = apply(pred_min_box,1,mean)
    
    rets = data.frame(
      mean = pred_mean,
      max = pred_max,
      min = pred_min
    )  
    return(rets)
    
    
  }
  
  i = 1:10
  
  i <<- i
  library(doParallel)
  cl = makeCluster(10)
  clusterExport(cl,c('i','twsdf',
                     'era5_pme','era5_sst',
                     'pme3_ssp245',
                     'sst3_ssp245',
                     'pme1_ssp245',
                     'sst1_ssp245'))
  system.time(ret245 <- parLapply(cl,i,
                                  sub_train_fun245))
  stopCluster(cl)
  
  extract_mean_pred <- function(x){
    retmean = 1
    for(i in 1:10){
      retmean = cbind(retmean,x[[i]][,1])
    }
    retmean = retmean[,-1]
    colnames(retmean) = paste0('SW',1:10)
    return(retmean)
  }
  extract_max_pred <- function(x){
    retmax = 1
    for(i in 1:10){
      retmax = cbind(retmax,x[[i]][,2])
    }
    retmax = retmax[,-1]
    colnames(retmax) = paste0('SW',1:10)
    return(retmax)
  }
  extract_min_pred <- function(x){
    retmin = 1
    for(i in 1:10){
      retmin = cbind(retmin,x[[i]][,3])
    }
    retmin = retmin[,-1]
    colnames(retmin) = paste0('SW',1:10)
    return(retmin)
  }
  
  ret_mean = extract_mean_pred(ret245)
  ret_max = extract_max_pred(ret245)
  ret_min = extract_min_pred(ret245)
  
  
  date = seq(as.Date('2018-01-01'),
             as.Date('2050-06-01'),
             '1 month')
  ret_mean = data.frame(
    date =date,
    ret_mean
  )
  
  ret_max = data.frame(
    date = date,
    ret_max
  )
  
  ret_min = data.frame(
    date = date,
    ret_min 
  )
  
  ret_mean = reshape2::melt(ret_mean,'date')
  ret_max = reshape2::melt(ret_max,'date')
  ret_min = reshape2::melt(ret_min,'date')
  
  ret_maxmin = data.frame(
    ret_max[,1:2],
    max = ret_max[,3],
    min = ret_min[,3]
  )
  colnames(ret_mean) = c('date','variable','SSP245')
  
  return(list(ret_mean,ret_maxmin))
}
sub_train_based_era5_cmip6_ssp245 <- function(
  
){
  SWs = paste0('SW',1:10)
  path = 'analysis_output/figS8-11'
  dir.create(path)
  output_train_245 = paste0(path,'/train_ssp245')
  output_valid_245 = paste0(path,'/valid_ssp245')
  output_imp_245 = paste0(path,'/import_ssp245')
  
  dir.create(output_train_245)
  dir.create(output_valid_245)
  dir.create(output_imp_245)
  
  output_train_245 = paste0(output_train_245,'/',
                            SWs,'.csv')
  output_valid_245 = paste0(output_valid_245,'/',
                            SWs,'.csv')
  output_imp_245 = paste0(output_imp_245,
                          '/',SWs,'.csv')
  
  SWs<<- SWs
  output_train_245 <<- output_train_245
  output_valid_245 <<- output_valid_245
  output_imp_245<<- output_imp_245
  
  sub_train_fun245 <-function(i){
    print(i)
    tws_sw = twsdf[,i]
    naid = which(is.na(tws_sw))
    tws_sw = tws_sw[-naid]
    tws_sw <<- tws_sw
    
    # building up model between tws and 
    # grace 
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws_era5_cmip6.R')
    df = data.frame(
      tws = tws_sw,
      pme1 = era5_pme[,1],
      pme3 = era5_pme[,2]
      #sst1 = era5_sst[,1],
      #sst3 = era5_sst[,2]
    )
    
    pme1_pj245 = as.matrix(pme1_ssp245[175:576,])
    pme3_pj245 = as.matrix(pme3_ssp245[175:576,])
    #sst1_pj245 = as.matrix(sst1_ssp245[175:576,])
    sst3_pj245 = as.matrix(sst3_ssp245[175:576,])
    
    source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
    pme1_pj245 = trend_fun(pme1_pj245)
    pme3_pj245 = trend_fun(pme3_pj245)
    #sst1_pj245 = trend_fun(sst1_pj245)
    sst3_pj245 = trend_fun(sst3_pj245)
    
    naid = which(is.na(pme3_pj245[,1]))
    pme3_pj245 = pme3_pj245[-naid,]
    sst3_pj245 = sst3_pj245[-naid,]
    pme1_pj245 = pme1_pj245[-naid,]
    
    ret_box = random_forest_model_tws_era5_cmip6(df)
    ret_box_train = ret_box[[1]]
    ret_box_valid = ret_box[[2]]
    model_best = ret_box[[3]]
    
    impmat = model_best$importance
    
    colnames(ret_box_train) = c('TWS_OBS',
                                'TWS_PROJ')
    colnames(ret_box_valid) = c('TWS_OBS',
                                "TWS_PROJ")
    
    ret_box_train$SWs = SWs[i]
    ret_box_valid$SWs = SWs[i]
    
    library(data.table)
    fwrite(ret_box_train
           ,output_train_245[i])
    fwrite(ret_box_valid,
           output_valid_245[i])
    fwrite(impmat,
           output_imp_245[i])
    
    
    pred_mean_box = 1
    pred_max_box = 1
    pred_min_box = 1
    
    for(j in 1:ncol(pme3_pj245)){
      df_project = data.frame(
        pme1= pme1_pj245[,j],
        pme3 = pme3_pj245[,j]
        #sst3 = sst3_pj245[,j]
      )
      cl_con_inter <- function(x){
        c(mean(x),quantile(x,c(0.05,0.95)))
      }
      
      pred_tws = predict(model_best,
                         df_project,
                         predict.all = T)
      pred_box = t(apply(pred_tws$individual,
                         1,cl_con_inter))
      
      pred_mean = predict(model_best,
                          df_project)
      pred_max = pred_box[,3]
      pred_min = pred_box[,2]
      
      pred_mean_box = cbind(pred_mean_box,
                            pred_mean)
      pred_max_box = cbind(pred_max_box,
                           pred_max)
      pred_min_box = cbind(pred_min_box,
                           pred_min)
    }
    pred_mean_box = pred_mean_box[,-1]
    pred_min_box = pred_min_box[,-1]
    pred_max_box = pred_max_box[,-1]
    
    pred_mean = apply(pred_mean_box,1,mean)
    pred_max = apply(pred_max_box,1,mean)
    pred_min = apply(pred_min_box,1,mean)
    
    rets = data.frame(
      mean = pred_mean,
      max = pred_max,
      min = pred_min
    )  
    return(rets)
    
    
  }
  
  i = 1:10
  
  i <<- i
  library(doParallel)
  cl = makeCluster(10)
  clusterExport(cl,c('i','twsdf',
                     'era5_pme','era5_sst',
                     'pme3_ssp245',
                     'sst3_ssp245',
                     'pme1_ssp245',
                     'sst1_ssp245'))
  system.time(ret245 <- parLapply(cl,i,
                                  sub_train_fun245))
  stopCluster(cl)
  
  extract_mean_pred <- function(x){
    retmean = 1
    for(i in 1:10){
      retmean = cbind(retmean,x[[i]][,1])
    }
    retmean = retmean[,-1]
    colnames(retmean) = paste0('SW',1:10)
    return(retmean)
  }
  extract_max_pred <- function(x){
    retmax = 1
    for(i in 1:10){
      retmax = cbind(retmax,x[[i]][,2])
    }
    retmax = retmax[,-1]
    colnames(retmax) = paste0('SW',1:10)
    return(retmax)
  }
  extract_min_pred <- function(x){
    retmin = 1
    for(i in 1:10){
      retmin = cbind(retmin,x[[i]][,3])
    }
    retmin = retmin[,-1]
    colnames(retmin) = paste0('SW',1:10)
    return(retmin)
  }
  
  ret_mean = extract_mean_pred(ret245)
  ret_max = extract_max_pred(ret245)
  ret_min = extract_min_pred(ret245)
  
  
  date = seq(as.Date('2018-01-01'),
             as.Date('2050-06-01'),
             '1 month')
  ret_mean = data.frame(
    date =date,
    ret_mean
  )
  
  ret_max = data.frame(
    date = date,
    ret_max
  )
  
  ret_min = data.frame(
    date = date,
    ret_min 
  )
  
  ret_mean = reshape2::melt(ret_mean,'date')
  ret_max = reshape2::melt(ret_max,'date')
  ret_min = reshape2::melt(ret_min,'date')
  
  ret_maxmin = data.frame(
    ret_max[,1:2],
    max = ret_max[,3],
    min = ret_min[,3]
  )
  colnames(ret_mean) = c('date','variable','SSP245')
  
  return(list(ret_mean,ret_maxmin))
}
sub_train_based_era5_cmip6_ssp585_proj_trend <- function(
  
){
  
  SWs = paste0('SW',1:10)
  path = 'analysis_output/figS_proj_pme'
  dir.create(path)
  output_train_585 = paste0(path,'/train_ssp585')
  output_valid_585 = paste0(path,'/valid_ssp585')
  output_imp_585 = paste0(path,'/import_ssp585')
  
  dir.create(output_train_585)
  dir.create(output_valid_585)
  dir.create(output_imp_585)
  
  output_train_585 = paste0(output_train_585,'/',
                            SWs,'.csv')
  output_valid_585 = paste0(output_valid_585,'/',
                            SWs,'.csv')
  output_imp_585 = paste0(output_imp_585,
                          '/',SWs,'.csv')
  
  SWs<<- SWs
  output_train_585 <<- output_train_585
  output_valid_585 <<- output_valid_585
  output_imp_585<<- output_imp_585
  
  
  sub_train_fun585 <-function(i){
    print(i)
    tws_sw = twsdf[,i]
    naid = which(is.na(tws_sw))
    tws_sw = tws_sw[-naid]
    tws_sw <<- tws_sw
    
    # building up model between tws and 
    # grace 
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws_era5_cmip6.R')
    df = data.frame(
      tws = tws_sw,
      pme1 = era5_pme[,1],
      pme3 = era5_pme[,2]
      #sst1 = era5_sst[,1],
      #sst3 = era5_sst[,2]
    )
    
    pme1_pj585 = as.matrix(pme1_ssp585[1:390,])
    pme3_pj585 = as.matrix(pme3_ssp585[1:390,])
    sst1_pj585 = as.matrix(sst1_ssp585[1:390,])
    sst3_pj585 = as.matrix(sst3_ssp585[1:390,])
    
    source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
    #pme1_pj585 = trend_fun(pme1_pj585)
    #pme3_pj585 = trend_fun(pme3_pj585)
    sst1_pj585 = trend_fun(sst1_pj585)
    sst3_pj585 = trend_fun(sst3_pj585)
    
    naid = which(is.na(pme3_pj585[,1]))
    #pme3_pj585 = pme3_pj585[-naid,]
    sst3_pj585 = sst3_pj585[-naid,]
    #pme1_pj585 = pme1_pj585[-naid,]
    
    ret_box = random_forest_model_tws_era5_cmip6(df)
    ret_box_train = ret_box[[1]]
    ret_box_valid = ret_box[[2]]
    model_best = ret_box[[3]]
    
    impmat = model_best$importance
    
    colnames(ret_box_train) = c('TWS_OBS',
                                'TWS_PROJ')
    colnames(ret_box_valid) = c('TWS_OBS',
                                "TWS_PROJ")
    
    ret_box_train$SWs = SWs[i]
    ret_box_valid$SWs = SWs[i]
    
    library(data.table)
    fwrite(ret_box_train
           ,output_train_585[i])
    fwrite(ret_box_valid,
           output_valid_585[i])
    fwrite(impmat,
           output_imp_585[i])
    
    pred_mean_box = 1
    pred_max_box = 1
    pred_min_box = 1
    
    for(j in 1:ncol(pme3_pj585)){
      df_project = data.frame(
        pme1= pme1_pj585[,j],
        pme3 = pme3_pj585[,j]
        #sst3 = sst3_pj585[,j]
      )
      cl_con_inter <- function(x){
        c(mean(x),quantile(x,c(0.05,0.95)))
      }
      
      
      pred_tws = predict(model_best,
                         df_project,
                         predict.all = T)
      pred_box = t(apply(pred_tws$individual,
                         1,cl_con_inter))
      
      pred_mean = predict(model_best,
                          df_project)
      pred_max = pred_box[,3]
      pred_min = pred_box[,2]
      
      pred_mean_box = cbind(pred_mean_box,
                            pred_mean)
      pred_max_box = cbind(pred_max_box,
                           pred_max)
      pred_min_box = cbind(pred_min_box,
                           pred_min)
    }
    pred_mean_box = pred_mean_box[,-1]
    pred_min_box = pred_min_box[,-1]
    pred_max_box = pred_max_box[,-1]
    
    pred_mean = apply(pred_mean_box,1,mean)
    pred_max = apply(pred_max_box,1,mean)
    pred_min = apply(pred_min_box,1,mean)
    
    rets = data.frame(
      mean = pred_mean,
      max = pred_max,
      min = pred_min
    )  
    return(rets)
    
  }
  
  i = 1:10
  
  i <<- i
  library(doParallel)
  cl = makeCluster(10)
  clusterExport(cl,c('i','twsdf',
                     'era5_pme','era5_sst',
                     'pme3_ssp585',
                     'sst3_ssp585',
                     'pme1_ssp585',
                     'sst1_ssp585'))
  system.time(ret585 <- parLapply(cl,i,
                                  sub_train_fun585))
  stopCluster(cl)
  
  
  extract_mean_pred <- function(x){
    retmean = 1
    for(i in 1:10){
      retmean = cbind(retmean,x[[i]][,1])
    }
    retmean = retmean[,-1]
    colnames(retmean) = paste0('SW',1:10)
    return(retmean)
  }
  extract_max_pred <- function(x){
    retmax = 1
    for(i in 1:10){
      retmax = cbind(retmax,x[[i]][,2])
    }
    retmax = retmax[,-1]
    colnames(retmax) = paste0('SW',1:10)
    return(retmax)
  }
  extract_min_pred <- function(x){
    retmin = 1
    for(i in 1:10){
      retmin = cbind(retmin,x[[i]][,3])
    }
    retmin = retmin[,-1]
    colnames(retmin) = paste0('SW',1:10)
    return(retmin)
  }
  
  
  ret_mean = extract_mean_pred(ret585)
  ret_max = extract_max_pred(ret585)
  ret_min = extract_min_pred(ret585)
  
  
  date = seq(as.Date('2018-01-01'),
             as.Date('2050-06-01'),
             '1 month')
  ret_mean = data.frame(
    date =date,
    ret_mean
  )
  
  ret_max = data.frame(
    date = date,
    ret_max
  )
  
  ret_min = data.frame(
    date = date,
    ret_min 
  )
  
  ret_mean = reshape2::melt(ret_mean,'date')
  ret_max = reshape2::melt(ret_max,'date')
  ret_min = reshape2::melt(ret_min,'date')
  
  ret_maxmin = data.frame(
    ret_max[,1:2],
    max = ret_max[,3],
    min = ret_min[,3]
  )
  colnames(ret_mean) = c('date','variable','SSP585')
  
  return(list(ret_mean,ret_maxmin))
}
sub_train_based_era5_cmip6_ssp585_proj <- function(
  
){
  
  SWs = paste0('SW',1:10)
  path = 'analysis_output/figS_proj_pme'
  dir.create(path)
  output_train_585 = paste0(path,'/train_ssp585')
  output_valid_585 = paste0(path,'/valid_ssp585')
  output_imp_585 = paste0(path,'/import_ssp585')
  
  dir.create(output_train_585)
  dir.create(output_valid_585)
  dir.create(output_imp_585)
  
  output_train_585 = paste0(output_train_585,'/',
                            SWs,'.csv')
  output_valid_585 = paste0(output_valid_585,'/',
                            SWs,'.csv')
  output_imp_585 = paste0(output_imp_585,
                          '/',SWs,'.csv')
  
  SWs<<- SWs
  output_train_585 <<- output_train_585
  output_valid_585 <<- output_valid_585
  output_imp_585<<- output_imp_585
  
  
  sub_train_fun585 <-function(i){
    print(i)
    tws_sw = twsdf[,i]
    naid = which(is.na(tws_sw))
    tws_sw = tws_sw[-naid]
    tws_sw <<- tws_sw
    
    # building up model between tws and 
    # grace 
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws_era5_cmip6.R')
    df = data.frame(
      tws = tws_sw,
      pme1 = era5_pme[,1],
      pme3 = era5_pme[,2]
      #sst1 = era5_sst[,1],
      #sst3 = era5_sst[,2]
    )
    
    pme1_pj585 = as.matrix(pme1_ssp585[175:576,])
    pme3_pj585 = as.matrix(pme3_ssp585[175:576,])
    sst1_pj585 = as.matrix(sst1_ssp585[175:576,])
    sst3_pj585 = as.matrix(sst3_ssp585[175:576,])
    
    source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
    pme1_pj585 = trend_fun(pme1_pj585)
    pme3_pj585 = trend_fun(pme3_pj585)
    sst1_pj585 = trend_fun(sst1_pj585)
    sst3_pj585 = trend_fun(sst3_pj585)
    
    naid = which(is.na(pme3_pj585[,1]))
    pme3_pj585 = pme3_pj585[-naid,]
    sst3_pj585 = sst3_pj585[-naid,]
    pme1_pj585 = pme1_pj585[-naid,]
    
    ret_box = random_forest_model_tws_era5_cmip6(df)
    ret_box_train = ret_box[[1]]
    ret_box_valid = ret_box[[2]]
    model_best = ret_box[[3]]
    
    impmat = model_best$importance
    
    colnames(ret_box_train) = c('TWS_OBS',
                                'TWS_PROJ')
    colnames(ret_box_valid) = c('TWS_OBS',
                                "TWS_PROJ")
    
    ret_box_train$SWs = SWs[i]
    ret_box_valid$SWs = SWs[i]
    
    library(data.table)
    fwrite(ret_box_train
           ,output_train_585[i])
    fwrite(ret_box_valid,
           output_valid_585[i])
    fwrite(impmat,
           output_imp_585[i])
    
    pred_mean_box = 1
    pred_max_box = 1
    pred_min_box = 1
    
    for(j in 1:ncol(pme3_pj585)){
      df_project = data.frame(
        pme1= pme1_pj585[,j],
        pme3 = pme3_pj585[,j]
        #sst3 = sst3_pj585[,j]
      )
      cl_con_inter <- function(x){
        c(mean(x),quantile(x,c(0.05,0.95)))
      }
      
      
      pred_tws = predict(model_best,
                         df_project,
                         predict.all = T)
      pred_box = t(apply(pred_tws$individual,
                         1,cl_con_inter))
      
      pred_mean = predict(model_best,
                          df_project)
      pred_max = pred_box[,3]
      pred_min = pred_box[,2]
      
      pred_mean_box = cbind(pred_mean_box,
                            pred_mean)
      pred_max_box = cbind(pred_max_box,
                           pred_max)
      pred_min_box = cbind(pred_min_box,
                           pred_min)
    }
    pred_mean_box = pred_mean_box[,-1]
    pred_min_box = pred_min_box[,-1]
    pred_max_box = pred_max_box[,-1]
    
    pred_mean = apply(pred_mean_box,1,mean)
    pred_max = apply(pred_max_box,1,mean)
    pred_min = apply(pred_min_box,1,mean)
    
    rets = data.frame(
      mean = pred_mean,
      max = pred_max,
      min = pred_min
    )  
    return(rets)
    
  }
  
  i = 1:10
  
  i <<- i
  library(doParallel)
  cl = makeCluster(10)
  clusterExport(cl,c('i','twsdf',
                     'era5_pme','era5_sst',
                     'pme3_ssp585',
                     'sst3_ssp585',
                     'pme1_ssp585',
                     'sst1_ssp585'))
  system.time(ret585 <- parLapply(cl,i,
                                  sub_train_fun585))
  stopCluster(cl)
  
  
  extract_mean_pred <- function(x){
    retmean = 1
    for(i in 1:10){
      retmean = cbind(retmean,x[[i]][,1])
    }
    retmean = retmean[,-1]
    colnames(retmean) = paste0('SW',1:10)
    return(retmean)
  }
  extract_max_pred <- function(x){
    retmax = 1
    for(i in 1:10){
      retmax = cbind(retmax,x[[i]][,2])
    }
    retmax = retmax[,-1]
    colnames(retmax) = paste0('SW',1:10)
    return(retmax)
  }
  extract_min_pred <- function(x){
    retmin = 1
    for(i in 1:10){
      retmin = cbind(retmin,x[[i]][,3])
    }
    retmin = retmin[,-1]
    colnames(retmin) = paste0('SW',1:10)
    return(retmin)
  }
  
  
  ret_mean = extract_mean_pred(ret585)
  ret_max = extract_max_pred(ret585)
  ret_min = extract_min_pred(ret585)
  
  
  date = seq(as.Date('2018-01-01'),
             as.Date('2050-06-01'),
             '1 month')
  ret_mean = data.frame(
    date =date,
    ret_mean
  )
  
  ret_max = data.frame(
    date = date,
    ret_max
  )
  
  ret_min = data.frame(
    date = date,
    ret_min 
  )
  
  ret_mean = reshape2::melt(ret_mean,'date')
  ret_max = reshape2::melt(ret_max,'date')
  ret_min = reshape2::melt(ret_min,'date')
  
  ret_maxmin = data.frame(
    ret_max[,1:2],
    max = ret_max[,3],
    min = ret_min[,3]
  )
  colnames(ret_mean) = c('date','variable','SSP585')
  
  return(list(ret_mean,ret_maxmin))
}
sub_train_based_era5_cmip6_ssp585 <- function(
  
){
  
  SWs = paste0('SW',1:10)
  path = 'analysis_output/figS8-11'
  dir.create(path)
  output_train_585 = paste0(path,'/train_ssp585')
  output_valid_585 = paste0(path,'/valid_ssp585')
  output_imp_585 = paste0(path,'/import_ssp585')
  
  dir.create(output_train_585)
  dir.create(output_valid_585)
  dir.create(output_imp_585)
  
  output_train_585 = paste0(output_train_585,'/',
                            SWs,'.csv')
  output_valid_585 = paste0(output_valid_585,'/',
                            SWs,'.csv')
  output_imp_585 = paste0(output_imp_585,
                          '/',SWs,'.csv')
  
  SWs<<- SWs
  output_train_585 <<- output_train_585
  output_valid_585 <<- output_valid_585
  output_imp_585<<- output_imp_585
  
  
  sub_train_fun585 <-function(i){
    print(i)
    tws_sw = twsdf[,i]
    naid = which(is.na(tws_sw))
    tws_sw = tws_sw[-naid]
    tws_sw <<- tws_sw
    
    # building up model between tws and 
    # grace 
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_tws_era5_cmip6.R')
    df = data.frame(
      tws = tws_sw,
      pme1 = era5_pme[,1],
      pme3 = era5_pme[,2]
      #sst1 = era5_sst[,1],
      #sst3 = era5_sst[,2]
    )
    
    pme1_pj585 = as.matrix(pme1_ssp585[175:576,])
    pme3_pj585 = as.matrix(pme3_ssp585[175:576,])
    #sst1_pj585 = as.matrix(sst1_ssp585[175:576,])
    sst3_pj585 = as.matrix(sst3_ssp585[175:576,])
    
    source('/home/share/R_project/xinjiang_vapor/trend_fun.R')
    pme1_pj585 = trend_fun(pme1_pj585)
    pme3_pj585 = trend_fun(pme3_pj585)
    #sst1_pj585 = trend_fun(sst1_pj585)
    sst3_pj585 = trend_fun(sst3_pj585)
    
    naid = which(is.na(pme3_pj585[,1]))
    pme3_pj585 = pme3_pj585[-naid,]
    sst3_pj585 = sst3_pj585[-naid,]
    pme1_pj585 = pme1_pj585[-naid,]
    
    ret_box = random_forest_model_tws_era5_cmip6(df)
    ret_box_train = ret_box[[1]]
    ret_box_valid = ret_box[[2]]
    model_best = ret_box[[3]]
    
    impmat = model_best$importance
    
    colnames(ret_box_train) = c('TWS_OBS',
                                'TWS_PROJ')
    colnames(ret_box_valid) = c('TWS_OBS',
                                "TWS_PROJ")
    
    ret_box_train$SWs = SWs[i]
    ret_box_valid$SWs = SWs[i]
    
    library(data.table)
    fwrite(ret_box_train
           ,output_train_585[i])
    fwrite(ret_box_valid,
           output_valid_585[i])
    fwrite(impmat,
           output_imp_585[i])
    
    pred_mean_box = 1
    pred_max_box = 1
    pred_min_box = 1
    
    for(j in 1:ncol(pme3_pj585)){
      df_project = data.frame(
        pme1= pme1_pj585[,j],
        pme3 = pme3_pj585[,j]
        #sst3 = sst3_pj585[,j]
      )
      cl_con_inter <- function(x){
        c(mean(x),quantile(x,c(0.05,0.95)))
      }
      
      
      pred_tws = predict(model_best,
                         df_project,
                         predict.all = T)
      pred_box = t(apply(pred_tws$individual,
                         1,cl_con_inter))
      
      pred_mean = predict(model_best,
                          df_project)
      pred_max = pred_box[,3]
      pred_min = pred_box[,2]
        
      pred_mean_box = cbind(pred_mean_box,
                           pred_mean)
      pred_max_box = cbind(pred_max_box,
                           pred_max)
      pred_min_box = cbind(pred_min_box,
                           pred_min)
    }
    pred_mean_box = pred_mean_box[,-1]
    pred_min_box = pred_min_box[,-1]
    pred_max_box = pred_max_box[,-1]
    
    pred_mean = apply(pred_mean_box,1,mean)
    pred_max = apply(pred_max_box,1,mean)
    pred_min = apply(pred_min_box,1,mean)
    
    rets = data.frame(
      mean = pred_mean,
      max = pred_max,
      min = pred_min
    )  
    return(rets)
    
  }
  
  i = 1:10
  
  i <<- i
  library(doParallel)
  cl = makeCluster(10)
  clusterExport(cl,c('i','twsdf',
                     'era5_pme','era5_sst',
                     'pme3_ssp585',
                     'sst3_ssp585',
                     'pme1_ssp585',
                     'sst1_ssp585'))
  system.time(ret585 <- parLapply(cl,i,
                                  sub_train_fun585))
  stopCluster(cl)
  
  
  extract_mean_pred <- function(x){
    retmean = 1
    for(i in 1:10){
      retmean = cbind(retmean,x[[i]][,1])
    }
    retmean = retmean[,-1]
    colnames(retmean) = paste0('SW',1:10)
    return(retmean)
  }
  extract_max_pred <- function(x){
    retmax = 1
    for(i in 1:10){
      retmax = cbind(retmax,x[[i]][,2])
    }
    retmax = retmax[,-1]
    colnames(retmax) = paste0('SW',1:10)
    return(retmax)
  }
  extract_min_pred <- function(x){
    retmin = 1
    for(i in 1:10){
      retmin = cbind(retmin,x[[i]][,3])
    }
    retmin = retmin[,-1]
    colnames(retmin) = paste0('SW',1:10)
    return(retmin)
  }
  
  
  ret_mean = extract_mean_pred(ret585)
  ret_max = extract_max_pred(ret585)
  ret_min = extract_min_pred(ret585)
  
  
  date = seq(as.Date('2018-01-01'),
             as.Date('2050-06-01'),
             '1 month')
  ret_mean = data.frame(
    date =date,
    ret_mean
  )
  
  ret_max = data.frame(
    date = date,
    ret_max
  )
  
  ret_min = data.frame(
    date = date,
    ret_min 
  )
  
  ret_mean = reshape2::melt(ret_mean,'date')
  ret_max = reshape2::melt(ret_max,'date')
  ret_min = reshape2::melt(ret_min,'date')
  
  ret_maxmin = data.frame(
    ret_max[,1:2],
    max = ret_max[,3],
    min = ret_min[,3]
  )
  colnames(ret_mean) = c('date','variable','SSP585')
  
  return(list(ret_mean,ret_maxmin))
}
svd_import_pmeato_df <- function(
  
){
  input_pme = 'NC_mod_xinjiang/era5_pme_ato_raster/pme_whole.nc'
  pme = stack(input_pme) 
  pmedf = as.data.frame(pme,xy = T)
  naid = which(is.na(pmedf[,3]))
  pmedf = pmedf[-naid,]
  
  loc_pme = pmedf[,1:2]
  pmedf = pmedf[,-c(1,2)]
  
  pmedf = t(pmedf)
  pmedf = pmedf[1:174,]
  i = 1:ncol(pmedf)
  i <<- i
  pmedf <<- pmedf
  library(doParallel)
  cl = makeCluster(10)
  clusterExport(cl,c('i','pmedf'))
  system.time(pme_st <- parLapply(cl,i,stand_trend_fun))
  stopCluster(cl)
  
  pme_st = do.call('cbind',pme_st)
  
  dir.create('NC_mod_xinjiang/svd_mca_analysis')
  output_pme = 'NC_mod_xinjiang/svd_mca_analysis/pme_st.csv'
  output_loc_pme = 'NC_mod_xinjiang/svd_mca_analysis/loc_pme.csv'
  library(data.table)
  fwrite(pme_st,output_pme)
  fwrite(loc_pme,output_loc_pme)
  
  
  
  
  
  
  
}
svd_mca_analysis <- function(
  
){
  # import 
  #install.packages('s2dverification')
  library(s2dverification)
  stand_trend_fun<-function(i){
    x = pmedf[,i]
    x = ts(x,start = c(2003,1),
           frequency = 12)
    x = decompose(x)$trend
    x = x[-which(is.na(x))]
    
    x = (x-mean(x))/(max(x)-min(x))
    return(x)
  }
  # import pme in ato field during 2003-2016
  source("/home/share/R_project/xinjiang_vapor/svd_import_pmeato_df.R")
  #svd_import_pmeato_df()
  input_pme = 'NC_mod_xinjiang/svd_mca_analysis/pme_st.csv'
  input_loc_pme = 'NC_mod_xinjiang/svd_mca_analysis/loc_pme.csv'
  
  pme_st = as.data.frame(fread(input_pme))
  loc_pme = as.data.frame(fread(input_loc_pme))
  
  #import tws across the eurasia during 2003-2016
  source("/home/share/R_project/xinjiang_vapor/calc_tws_across_the_mid_lat_eurasia.R")
  #calc_tws_across_the_mid_lat_eurasia()
  input_tws_st = 'NC_mod_xinjiang/svd_mca_analysis/tws_st.csv'
  input_loc_tws = 'NC_mod_xinjiang/svd_mca_analysis/loc_tws.csv'
  tws_st = as.data.frame(fread(input_tws_st))
  loc_tws = as.data.frame(fread(input_loc_tws))
  
  tws_st = t(tws_st) # 52809 162
  pme_st = t(pme_st) # 84050 162
  
  
  
  calc_smat_fun2 <- function(i){
    x = tws_st[i,]
    sub_calc<-function(y){
      tmpcov = cov(x,y)
      return(tmpcov)
    }
    ret_cov = apply(pme_st,1,sub_calc)
    return(ret_cov)
  }
  
  i = 1:nrow(tws_st)
  i <<- i 
  pme_st <<- pme_st
  tws_st <<- tws_st
  library(doParallel)
  cl = makeCluster(10)
  clusterExport(cl,c('i','pme_st','tws_st'))
  system.time(ret<- parLapply(cl,i,calc_smat_fun2))
  stopCluster(cl)
  
  library(data.table)
  library(doParallel)
  input_cxy = 'NC_mod_xinjiang/svd_mca_analysis/Cxy.csv'
  cxy = as.data.frame(fread(input_cxy))
  cxy = t(cxy)
  
  system.time(svds <- svd())
  
}
test_rm_var<-function(
  
){
  generate_random_df <- function(
    i
  ){
    d =runif(100000,i,1000)
    return(d)
  }
  
  for(i in 1:100){
    d = generate_random_df(i)
    d = cbind(d,d,d,d)
    fwrite(d,'test_mem.csv')
    rm(d)
    
  }
}
 traj_import <- function(
   
 ){
   library(data.table)
   input_traj = list.files('/media/sdb1/xinjiang_output_file',full.names = T)
   input_traj = paste0(input_traj,'/output/mean_route_released/mean_route_released.csv')
   
   traj_df = lapply(input_traj,fread)
   traj_df = lapply(traj_df,as.data.frame)
   
   for(i in 1:length(traj_df)){
     yearmon = substr(input_traj[[i]],42,47)
     mon1 = as.numeric(substr(input_traj[[i]],46,47))
     
     mon = c('JAN','FEB','MAR','APR',
                    'MAY','JUN','JUL','AUG',
                    "SEP",'OCT','NOV','DEC')
     mon = mon[mon1]
     
     traj_df[[i]]$uni_id = paste0(traj_df[[i]]$source_name,'_',traj_df[[i]]$cluster,
                                  '_',yearmon)
     
     traj_df[[i]]$sou_mon = paste0(traj_df[[i]]$source_name,'_',mon)
     traj_df[[i]]$mon = mon
   }
   return(traj_df)
 }
traj_plot_fun_by_mon<-function(
  
  
){
  monname = c('JAN','FEB','MAR','APR','MAY',"JUN",
              'JUL',"AUG",'SEP','OCT','NOV',"DEC")
  input_monthly_traj = 'monthly_kmeans_traj'
  #dir.create(input_monthly_traj)
  input_monthly_traj = paste0(input_monthly_traj,'/',
                               monname,'.csv')
  
  df = lapply(input_monthly_traj,fread)
  traj_df_by_mon = do.call('rbind',df)
  traj_df_by_mon$group = paste0(traj_df_by_mon$month,'_',
                                traj_df_by_mon$routeid)
  
  source('/home/share/R_project/xinjiang_vapor/shp_management.R')
  world = shp_management("world")
  world = crop(world,extent(-180,180,0,90))
  
  xj = shp_management('xinjiang')
  
  library(RColorBrewer)
  mycolor = colorRampPalette(brewer.pal(11,'Spectral'))(12)
  
  
  
  library(ggplot2)
  # Trajectory Plot
  #####
  p = ggplot()+
    geom_polygon(data = world,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 1)+
    geom_polygon(data = xj,aes(x = long,y = lat,group = group),
                 fill = 'transparent',color = 'black',
                 size = 1)+
    geom_path(data = traj_df_by_mon,aes(x = long,y = lat,
                                        group = group,
                                        color = month))+
    scale_color_manual(values = mycolor)+
    facet_wrap(~month,nrow = 4)+
    theme_bw()
  #####
  return()
  
}
trend_fun <- function(x){
  
  sub_fun_his <-function(x){
    x = ts(x,start = c(2003,1),
           frequency = 12)
    x = decompose(x)$trend
    
    xt = as.numeric(x)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }
  sub_fun_fut <-function(x){
    x = ts(x,start = c(2017,7),
           frequency = 12)
    x = decompose(x)$trend
    
    xt = as.numeric(x)
    stand_fun <-function(y){
      y = (y - mean(y,na.rm = T))/(max(y,na.rm = T) -min(y,na.rm = T))
    }
    xy  = stand_fun(xt)
    return(xy)
  }
  
  
  if(is.null(ncol(x))){
    x = as.numeric(x)
    if(length(x)<=174){
      xm = sub_fun_his(x)
    }else{
      xm = sub_fun_fut(x)
    }
    
  }else{
    if(nrow(x)<=174){
      xm = apply(x,2,sub_fun_his)
    }else{
      xm = apply(x,2,sub_fun_fut)
    }
    
    
  }
  return(xm)
}
trend_funRaster <-function(x){
  x = as.numeric(x)
  xtell = mean(x)
  if(is.na(xtell)){
    x = NA
  }else{
    xt = ts(x,start = c(2003,1),
            frequency = 12)
    xt = decompose(xt)$trend
    xt = as.numeric(xt)
    naid = which(is.na(xt))
    xt = xt[-naid]
    xt = as.numeric(xt)
    xt = xt/(max(xt) - min(xt))
    source('/home/share/R_project/xinjiang_vapor/mmkTrend.R')
    
    mmk = mmkTrend(xt)$Zc
    mmk = as.numeric(mmk)
    x = mmk
  }
  return(x)
}
trend_index<-function(
  x,
  start=c(2003,1),
  fre = 12
){
  
  xts = ts(x,start = start,frequency = fre)
  xtrend = decompose(xts)$trend
  naid = which(is.na(xtrend))
  xtrend =xtrend[-naid]
  return(xtrend)
}
tws_in_tibet_analysis <-function(
  
){
  tws = data_management('grace')
  tibet = shp_management('tibet')
  
  tws = mask(crop(tws,extent(tibet)),tibet)
  
  twsdf = as.data.frame(tws,xy = T)
  colnames(twsdf) = c('long','lat','tws')
  
  naid = which(is.na(twsdf[,3]))


  
  
  
}
tws_mmk_analysis <-function(
  
){
  source('/home/share/R_project/xinjiang_vapor/data_management.R')
  
  tws = data_management('grace')
  library(raster)
  mmk_cal <-function(x){
    source('/home/share/R_project/xinjiang_vapor/mmkTrend.R')
    if(!anyNA(x)){
      mt = mmkTrend(x)$Zc
    }else{
      mt = NA
    }
    return(mt)
  }
  xj = shp_management('xinjiang')
  
  tws = crop(tws,xj)
  tws = mask(tws,xj)
  
  tws_mmk = calc(tws,mmk_cal)
  
  
  beginCluster(12)
  z1 <- clusterR(tws,calc,args = list(fun = mmk_cal),export = 'tws')
  endCluster()
  
}
validate_cmip6_pme_linear <-function(
  
){
  dir.create('analysis_output/fig4/pme_linear')
  library(data.table)
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  source('/home/share/R_project/xinjiang_vapor/source_id_identify.R')
  
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:180,]
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:180,]
  
  era5_pme = pe_in_source[,c(5,7)] - pet_sum[,c(5,7)]
  
  input_pme_cmip6 = list.files('analysis_output/cmip6_by_model/pme',
                               full.names = T)
  pme_cmip6 = lapply(lapply(input_pme_cmip6,fread),as.data.frame)
  
  pme1_ssp245_train = pme_cmip6[[1]][1:180,]
  pme1_ssp585_train = pme_cmip6[[2]][1:180,]
  pme3_ssp245_train = pme_cmip6[[3]][1:180,]
  pme3_ssp585_train = pme_cmip6[[4]][1:180,]
  
  pme1_ssp245_proj = pme_cmip6[[1]][181:576,]
  pme1_ssp585_proj = pme_cmip6[[2]][181:576,]
  pme3_ssp245_proj = pme_cmip6[[3]][181:576,]
  pme3_ssp585_proj = pme_cmip6[[4]][181:576,]
  
  pme1_ssp245_train<<- pme1_ssp245_train
  pme1_ssp585_train <<- pme1_ssp585_train
  pme3_ssp245_train<<- pme3_ssp245_train
  pme3_ssp585_train <<- pme3_ssp585_train
  pme1_ssp245_proj <<- pme1_ssp245_proj
  pme1_ssp585_proj <<- pme1_ssp585_proj
  pme3_ssp245_proj <<- pme3_ssp245_proj
  pme3_ssp585_proj <<- pme3_ssp585_proj
  
  i = 1:ncol(pme1_ssp245_train)
  correct_fun1_ssp245 <-function(i){
    df = data.frame(
      pr = era5_pme[,1],
      cmip6 = pme1_ssp245_train[,i]
    )
    df_project = data.frame(
      cmip6 = pme1_ssp245_proj[,i]
    )
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_pr_cmip6.R')
    ret = random_forest_model_pr_cmip6(df,df_project)
    return(ret)
  }
  correct_fun1_ssp585 <-function(i){
    df = data.frame(
      pr = era5_pme[,1],
      cmip6 = pme1_ssp585_train[,i]
    )
    df_project = data.frame(
      cmip6 = pme1_ssp585_proj[,i]
    )
    #source('/home/share/R_project/xinjiang_vapor/random_forest_model_pr_cmip6.R')
    ret = random_forest_model_pr_cmip6(df,df_project)
    return(ret)
  }
  correct_fun3_ssp245 <-function(i){
    df = data.frame(
      pr = era5_pme[,2],
      cmip6 = pme3_ssp245_train[,i]
    )
    df_project = data.frame(
      cmip6 = pme3_ssp245_proj[,i]
    )
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_pr_cmip6.R')
    ret = random_forest_model_pr_cmip6(df,df_project)
    return(ret)
  }
  correct_fun3_ssp585 <-function(i){
    df = data.frame(
      pr = era5_pme[,2],
      cmip6 = pme3_ssp585_train[,i]
    )
    df_project = data.frame(
      cmip6 = pme3_ssp585_proj[,i]
    )
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_pr_cmip6.R')
    ret = random_forest_model_pr_cmip6(df,df_project)
    return(ret)
  }
  
  ret1_245 = lapply(i,correct_fun1_ssp245)
  ret1_585 = lapply(i,correct_fun1_ssp585)
  ret3_245 = lapply(i,correct_fun3_ssp245)
  ret3_585 = lapply(i,correct_fun3_ssp585)
  
  ret1_245 <<- ret1_245
  ret1_585 <<- ret1_585
  ret3_585 <<- ret3_585
  ret3_245 <<- ret3_245
  
  i = 1:ncol(pme1_ssp245_train)
  extract_train1_pr245 <- function(i){
    if(i!=1){
      tmp = ret1_245[[i]][[1]][,2]
    }else{
      tmp = ret1_245[[i]][[1]]
    }
    return(tmp)
  }
  extract_train1_pr585 <- function(i){
    if(i !=1){
      tmp = ret1_585[[i]][[1]][,2]
      
    }else{
      tmp = ret1_585[[i]][[1]]
      
    }
    return(tmp)
  }
  extract_train3_pr245 <- function(i){
    if(i !=1){
      tmp = ret3_245[[i]][[1]][,2]
    }else{
      tmp = ret3_245[[i]][[1]]
    }
    
    return(tmp)
  }
  extract_train3_pr585 <- function(i){
    if(i !=1){
      tmp = ret3_585[[i]][[1]][,2]
    }else{
      tmp = ret3_585[[i]][[1]]
    }
    
    return(tmp)
  }
  ret1_245_train = lapply(i,extract_train1_pr245)
  ret3_245_train = lapply(i,extract_train3_pr245)
  ret1_585_train = lapply(i,extract_train1_pr585)
  ret3_585_train = lapply(i,extract_train3_pr585)
  
  ret1_245_train = do.call(cbind,ret1_245_train)
  ret3_245_train = do.call(cbind,ret3_245_train)
  ret1_585_train = do.call(cbind,ret1_585_train)
  ret3_585_train = do.call(cbind,ret3_585_train)
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(ret1_245_train) = c('ERA5',modelnames)
  colnames(ret3_245_train) = c('ERA5',modelnames)
  colnames(ret1_585_train) = c('ERA5',modelnames)
  colnames(ret3_585_train) = c('ERA5',modelnames)
  
  datefull = seq(as.Date('2003-01-01'),
                 as.Date('2050-12-01'),
                 '1 month')
  
  ret1_245_train = data.frame(date = datefull[1:126],
                              ret1_245_train)
  ret1_585_train = data.frame(date = datefull[1:126],
                              ret1_585_train)
  ret3_245_train = data.frame(date = datefull[1:126],
                              ret3_245_train)
  ret3_585_train = data.frame(date = datefull[1:126],
                              ret3_585_train)
  
  fwrite(ret1_245_train,'analysis_output/fig4/pme/pme_ato1_245_train.csv')
  fwrite(ret1_585_train,'analysis_output/fig4/pme/pme_ato1_585_train.csv')
  fwrite(ret3_245_train,'analysis_output/fig4/pme/pme_ato3_245_train.csv')
  fwrite(ret3_585_train,'analysis_output/fig4/pme/pme_ato3_585_train.csv')
  
  
  df1 = reshape2::melt(ret1_245_train,'date')
  df2 = reshape2::melt(ret1_585_train,'date')
  df3 = reshape2::melt(ret3_245_train,'date')
  df4 = reshape2::melt(ret3_585_train,'date')
  
  er1 = ret1_245_train[,1:2]
  er3 = ret3_245_train[,1:2]
  
  p1 = ggplot()+
    geom_line(data = df1,
              aes(x = date,
                  y = value,
                  color = variable))+
    geom_line(data = er1,
              aes(x = date,y = ERA5),
              color = 'black',size = 1)+
    scale_color_npg()+
    facet_wrap(~variable,nrow = 2)+
    theme_bw()
  
  # fut 
  i = 1:ncol(pme1_ssp245_train)
  extract_fut1_pr245 <- function(i){
    if(i!=1){
      tmp = ret1_245[[i]][[3]]
    }else{
      tmp = ret1_245[[i]][[3]]
    }
    return(tmp)
  }
  extract_fut1_pr585 <- function(i){
    if(i !=1){
      tmp = ret1_585[[i]][[3]]
      
    }else{
      tmp = ret1_585[[i]][[3]]
      
    }
    return(tmp)
  }
  extract_fut3_pr245 <- function(i){
    if(i !=1){
      tmp = ret3_245[[i]][[3]]
    }else{
      tmp = ret3_245[[i]][[3]]
    }
    
    return(tmp)
  }
  extract_fut3_pr585 <- function(i){
    if(i !=1){
      tmp = ret3_585[[i]][[3]]
    }else{
      tmp = ret3_585[[i]][[3]]
    }
    
    return(tmp)
  }
  
  
  ret_fut1_245 = lapply(i,extract_fut1_pr245)
  ret_fut1_585 = lapply(i,extract_fut1_pr585)
  ret_fut3_245 = lapply(i,extract_fut3_pr245)
  ret_fut3_585 = lapply(i,extract_fut3_pr585)
  
  ret_fut1_245 <<- ret_fut1_245
  ret_fut1_585 <<- ret_fut1_585
  ret_fut3_245 <<- ret_fut3_245
  ret_fut3_585 <<- ret_fut3_585
  
  ret_to_df1 <-function(i){
    x = ret_fut1_245[[i]][,2]
    return(x)
  }
  ret_to_df2 <-function(i){
    x = ret_fut1_585[[i]][,2]
    return(x)
  }
  ret_to_df3 <-function(i){
    x = ret_fut3_245[[i]][,2]
    return(x)
  }
  ret_to_df4 <-function(i){
    x = ret_fut3_585[[i]][,2]
    return(x)
  }
  
  df_fut1 = data.frame(
    ret_fut1_245[[1]],
    do.call('cbind',lapply(i,ret_to_df1))[,-1]
  )
  df_fut2 = data.frame(
    ret_fut1_585[[1]],
    do.call('cbind',lapply(i,ret_to_df2))[,-1]
  )
  
  df_fut3 = data.frame(
    ret_fut3_245[[1]],
    do.call('cbind',lapply(i,ret_to_df3))[,-1]
  )
  df_fut4 = data.frame(
    ret_fut3_585[[1]],
    do.call('cbind',lapply(i,ret_to_df4))[,-1]
  )
  
  #df_fut1 = trend_fun_fut(df_fut1)
  #df_fut2 = trend_fun_fut(df_fut2)
  #df_fut3 = trend_fun_fut(df_fut3)
  #df_fut4 = trend_fun_fut(df_fut4)
  
  colnames(df_fut1) = c('date',modelnames)
  colnames(df_fut2) = c('date',modelnames)
  colnames(df_fut3) = c('date',modelnames)
  colnames(df_fut4) = c('date',modelnames)
  
  df_fut1m = reshape2::melt(df_fut1,'date')
  df_fut2m = reshape2::melt(df_fut2,'date')
  df_fut3m = reshape2::melt(df_fut3,'date')
  df_fut4m = reshape2::melt(df_fut4,'date')
  
  df_fut1m$type = 'SSP245_Pr1'
  df_fut2m$type = 'SSP585_Pr1'
  df_fut3m$type = 'SSP245_Pr3'
  df_fut4m$type = 'SSP585_Pr3'
  
  dffutm = rbind(df_fut1m,df_fut2m,
                 df_fut3m,df_fut4m)
  
  dir.create('analysis_output/fig4/pme')
  fwrite(df_fut1,'analysis_output/fig4/pme/pme_ato1_ssp245_proj.csv')
  fwrite(df_fut2,'analysis_output/fig4/pme/pme_ato1_ssp585_proj.csv')
  fwrite(df_fut3,'analysis_output/fig4/pme/pme_ato3_ssp245_proj.csv')
  fwrite(df_fut4,'analysis_output/fig4/pme/pme_ato3_ssp585_proj.csv')
  
  
  p = ggplot()+
    geom_line(data = dffutm,
              aes(x = date,y= value,
                  color = type,
                  group = type),
              size = 1)+
    scale_color_npg()+
    facet_wrap(~variable,nrow = 4)+
    theme_bw()
  
  extract_test1_pr245 <- function(i){
    if(i!=1){
      tmp = ret1_245[[i]][[2]][,2]
    }else{
      tmp = ret1_245[[i]][[2]]
    }
    return(tmp)
  }
  extract_test1_pr585 <- function(i){
    if(i !=1){
      tmp = ret1_585[[i]][[2]][,2]
      
    }else{
      tmp = ret1_585[[i]][[2]]
      
    }
    return(tmp)
  }
  extract_test3_pr245 <- function(i){
    if(i !=1){
      tmp = ret3_245[[i]][[2]][,2]
    }else{
      tmp = ret3_245[[i]][[2]]
    }
    
    return(tmp)
  }
  extract_test3_pr585 <- function(i){
    if(i !=1){
      tmp = ret3_585[[i]][[2]][,2]
    }else{
      tmp = ret3_585[[i]][[2]]
    }
    
    return(tmp)
  }
  
  ret1_245_test = lapply(i,extract_test1_pr245)
  ret1_585_test = lapply(i,extract_test1_pr585)
  ret3_245_test = lapply(i,extract_test3_pr245)
  ret3_585_test = lapply(i,extract_test3_pr585)
  
  ret1_245_test = do.call(cbind,ret1_245_test)
  ret3_245_test = do.call(cbind,ret3_245_test)
  ret1_585_test = do.call(cbind,ret1_585_test)
  ret3_585_test = do.call(cbind,ret3_585_test)
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(ret1_245_test) = c('ERA5',modelnames)
  colnames(ret3_245_test) = c('ERA5',modelnames)
  colnames(ret1_585_test) = c('ERA5',modelnames)
  colnames(ret3_585_test) = c('ERA5',modelnames)
  
  datefull = seq(as.Date('2003-01-01'),
                 as.Date('2050-12-01'),
                 '1 month')
  
  ret1_245_test = data.frame(date = datefull[127:180],
                             ret1_245_test)
  ret1_585_test = data.frame(date = datefull[127:180],
                             ret1_585_test)
  ret3_245_test = data.frame(date = datefull[127:180],
                             ret3_245_test)
  ret3_585_test = data.frame(date = datefull[127:180],
                             ret3_585_test)
  
  fwrite(ret1_245_test,'analysis_output/fig4/pme/pme_ato1_245_test.csv')
  fwrite(ret1_585_test,'analysis_output/fig4/pme/pme_ato1_585_test.csv')
  fwrite(ret3_245_test,'analysis_output/fig4/pme/pme_ato3_245_test.csv')
  fwrite(ret3_585_test,'analysis_output/fig4/pme/pme_ato3_585_test.csv')
  
}







validate_cmip6_pme <-function(
  
){
  dir.create('analysis_output/fig4/pme')
  library(data.table)
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  source('/home/share/R_project/xinjiang_vapor/source_id_identify.R')
  
  source('/home/share/R_project/xinjiang_vapor/import_pe_in_source.R')
  pe_in_source = import_pe_in_source('era5_pr_sum',
                                     name = 'era5_pr_sum.csv')
  pe_in_source = pe_in_source[1:180,]
  pet_sum = import_pe_in_source('era5_pet_sum','era5_pet_sum.csv')
  pet_sum = pet_sum[1:180,]
  
  era5_pme = pe_in_source[,c(5,7)] - pet_sum[,c(5,7)]
  
  input_pme_cmip6 = list.files('analysis_output/cmip6_by_model/pme',
                         full.names = T)
  pme_cmip6 = lapply(lapply(input_pme_cmip6,fread),as.data.frame)
  
  pme1_ssp245_train = pme_cmip6[[1]][1:180,]
  pme1_ssp585_train = pme_cmip6[[2]][1:180,]
  pme3_ssp245_train = pme_cmip6[[3]][1:180,]
  pme3_ssp585_train = pme_cmip6[[4]][1:180,]
  
  pme1_ssp245_proj = pme_cmip6[[1]][181:576,]
  pme1_ssp585_proj = pme_cmip6[[2]][181:576,]
  pme3_ssp245_proj = pme_cmip6[[3]][181:576,]
  pme3_ssp585_proj = pme_cmip6[[4]][181:576,]
  
  pme1_ssp245_train<<- pme1_ssp245_train
  pme1_ssp585_train <<- pme1_ssp585_train
  pme3_ssp245_train<<- pme3_ssp245_train
  pme3_ssp585_train <<- pme3_ssp585_train
  pme1_ssp245_proj <<- pme1_ssp245_proj
  pme1_ssp585_proj <<- pme1_ssp585_proj
  pme3_ssp245_proj <<- pme3_ssp245_proj
  pme3_ssp585_proj <<- pme3_ssp585_proj
  
  i = 1:ncol(pme1_ssp245_train)
  correct_fun1_ssp245 <-function(i){
    df = data.frame(
      pr = era5_pme[,1],
      cmip6 = pme1_ssp245_train[,i]
    )
    df_project = data.frame(
      cmip6 = pme1_ssp245_proj[,i]
    )
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_pr_cmip6.R')
    ret = random_forest_model_pr_cmip6(df,df_project)
    return(ret)
  }
  correct_fun1_ssp585 <-function(i){
    df = data.frame(
      pr = era5_pme[,1],
      cmip6 = pme1_ssp585_train[,i]
    )
    df_project = data.frame(
      cmip6 = pme1_ssp585_proj[,i]
    )
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_pr_cmip6.R')
    ret = random_forest_model_pr_cmip6(df,df_project)
    return(ret)
  }
  correct_fun3_ssp245 <-function(i){
    df = data.frame(
      pr = era5_pme[,2],
      cmip6 = pme3_ssp245_train[,i]
    )
    df_project = data.frame(
      cmip6 = pme3_ssp245_proj[,i]
    )
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_pr_cmip6.R')
    ret = random_forest_model_pr_cmip6(df,df_project)
    return(ret)
  }
  correct_fun3_ssp585 <-function(i){
    df = data.frame(
      pr = era5_pme[,2],
      cmip6 = pme3_ssp585_train[,i]
    )
    df_project = data.frame(
      cmip6 = pme3_ssp585_proj[,i]
    )
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_pr_cmip6.R')
    ret = random_forest_model_pr_cmip6(df,df_project)
    return(ret)
  }
  
  ret1_245 = lapply(i,correct_fun1_ssp245)
  ret1_585 = lapply(i,correct_fun1_ssp585)
  ret3_245 = lapply(i,correct_fun3_ssp245)
  ret3_585 = lapply(i,correct_fun3_ssp585)
  
  ret1_245 <<- ret1_245
  ret1_585 <<- ret1_585
  ret3_585 <<- ret3_585
  ret3_245 <<- ret3_245
  
  i = 1:ncol(pme1_ssp245_train)
  extract_train1_pr245 <- function(i){
    if(i!=1){
      tmp = ret1_245[[i]][[1]][,2]
    }else{
      tmp = ret1_245[[i]][[1]]
    }
    return(tmp)
  }
  extract_train1_pr585 <- function(i){
    if(i !=1){
      tmp = ret1_585[[i]][[1]][,2]
      
    }else{
      tmp = ret1_585[[i]][[1]]
      
    }
    return(tmp)
  }
  extract_train3_pr245 <- function(i){
    if(i !=1){
      tmp = ret3_245[[i]][[1]][,2]
    }else{
      tmp = ret3_245[[i]][[1]]
    }
    
    return(tmp)
  }
  extract_train3_pr585 <- function(i){
    if(i !=1){
      tmp = ret3_585[[i]][[1]][,2]
    }else{
      tmp = ret3_585[[i]][[1]]
    }
    
    return(tmp)
  }
  ret1_245_train = lapply(i,extract_train1_pr245)
  ret3_245_train = lapply(i,extract_train3_pr245)
  ret1_585_train = lapply(i,extract_train1_pr585)
  ret3_585_train = lapply(i,extract_train3_pr585)
  
  ret1_245_train = do.call(cbind,ret1_245_train)
  ret3_245_train = do.call(cbind,ret3_245_train)
  ret1_585_train = do.call(cbind,ret1_585_train)
  ret3_585_train = do.call(cbind,ret3_585_train)
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(ret1_245_train) = c('ERA5',modelnames)
  colnames(ret3_245_train) = c('ERA5',modelnames)
  colnames(ret1_585_train) = c('ERA5',modelnames)
  colnames(ret3_585_train) = c('ERA5',modelnames)
  
  datefull = seq(as.Date('2003-01-01'),
             as.Date('2050-12-01'),
             '1 month')
  
  ret1_245_train = data.frame(date = datefull[1:126],
                              ret1_245_train)
  ret1_585_train = data.frame(date = datefull[1:126],
                              ret1_585_train)
  ret3_245_train = data.frame(date = datefull[1:126],
                              ret3_245_train)
  ret3_585_train = data.frame(date = datefull[1:126],
                              ret3_585_train)
  
  fwrite(ret1_245_train,'analysis_output/fig4/pme/pme_ato1_245_train.csv')
  fwrite(ret1_585_train,'analysis_output/fig4/pme/pme_ato1_585_train.csv')
  fwrite(ret3_245_train,'analysis_output/fig4/pme/pme_ato3_245_train.csv')
  fwrite(ret3_585_train,'analysis_output/fig4/pme/pme_ato3_585_train.csv')
  
  
  df1 = reshape2::melt(ret1_245_train,'date')
  df2 = reshape2::melt(ret1_585_train,'date')
  df3 = reshape2::melt(ret3_245_train,'date')
  df4 = reshape2::melt(ret3_585_train,'date')

  er1 = ret1_245_train[,1:2]
  er3 = ret3_245_train[,1:2]
  
  p1 = ggplot()+
    geom_line(data = df1,
              aes(x = date,
                  y = value,
                  color = variable))+
    geom_line(data = er1,
              aes(x = date,y = ERA5),
              color = 'black',size = 1)+
    scale_color_npg()+
    facet_wrap(~variable,nrow = 2)+
    theme_bw()
    
  # fut 
  i = 1:ncol(pme1_ssp245_train)
  extract_fut1_pr245 <- function(i){
    if(i!=1){
      tmp = ret1_245[[i]][[3]]
    }else{
      tmp = ret1_245[[i]][[3]]
    }
    return(tmp)
  }
  extract_fut1_pr585 <- function(i){
    if(i !=1){
      tmp = ret1_585[[i]][[3]]
      
    }else{
      tmp = ret1_585[[i]][[3]]
      
    }
    return(tmp)
  }
  extract_fut3_pr245 <- function(i){
    if(i !=1){
      tmp = ret3_245[[i]][[3]]
    }else{
      tmp = ret3_245[[i]][[3]]
    }
    
    return(tmp)
  }
  extract_fut3_pr585 <- function(i){
    if(i !=1){
      tmp = ret3_585[[i]][[3]]
    }else{
      tmp = ret3_585[[i]][[3]]
    }
    
    return(tmp)
  }
  
  
  ret_fut1_245 = lapply(i,extract_fut1_pr245)
  ret_fut1_585 = lapply(i,extract_fut1_pr585)
  ret_fut3_245 = lapply(i,extract_fut3_pr245)
  ret_fut3_585 = lapply(i,extract_fut3_pr585)
  
  ret_fut1_245 <<- ret_fut1_245
  ret_fut1_585 <<- ret_fut1_585
  ret_fut3_245 <<- ret_fut3_245
  ret_fut3_585 <<- ret_fut3_585
  
  ret_to_df1 <-function(i){
    x = ret_fut1_245[[i]][,2]
    return(x)
  }
  ret_to_df2 <-function(i){
    x = ret_fut1_585[[i]][,2]
    return(x)
  }
  ret_to_df3 <-function(i){
    x = ret_fut3_245[[i]][,2]
    return(x)
  }
  ret_to_df4 <-function(i){
    x = ret_fut3_585[[i]][,2]
    return(x)
  }
  
  df_fut1 = data.frame(
    ret_fut1_245[[1]],
    do.call('cbind',lapply(i,ret_to_df1))[,-1]
  )
  df_fut2 = data.frame(
    ret_fut1_585[[1]],
    do.call('cbind',lapply(i,ret_to_df2))[,-1]
  )
  
  df_fut3 = data.frame(
    ret_fut3_245[[1]],
    do.call('cbind',lapply(i,ret_to_df3))[,-1]
  )
  df_fut4 = data.frame(
    ret_fut3_585[[1]],
    do.call('cbind',lapply(i,ret_to_df4))[,-1]
  )
  
  #df_fut1 = trend_fun_fut(df_fut1)
  #df_fut2 = trend_fun_fut(df_fut2)
  #df_fut3 = trend_fun_fut(df_fut3)
  #df_fut4 = trend_fun_fut(df_fut4)
  
  colnames(df_fut1) = c('date',modelnames)
  colnames(df_fut2) = c('date',modelnames)
  colnames(df_fut3) = c('date',modelnames)
  colnames(df_fut4) = c('date',modelnames)
  
  df_fut1m = reshape2::melt(df_fut1,'date')
  df_fut2m = reshape2::melt(df_fut2,'date')
  df_fut3m = reshape2::melt(df_fut3,'date')
  df_fut4m = reshape2::melt(df_fut4,'date')
  
  df_fut1m$type = 'SSP245_Pr1'
  df_fut2m$type = 'SSP585_Pr1'
  df_fut3m$type = 'SSP245_Pr3'
  df_fut4m$type = 'SSP585_Pr3'
  
  dffutm = rbind(df_fut1m,df_fut2m,
                 df_fut3m,df_fut4m)
  
  dir.create('analysis_output/fig4/pme')
  fwrite(df_fut1,'analysis_output/fig4/pme/pme_ato1_ssp245_proj.csv')
  fwrite(df_fut2,'analysis_output/fig4/pme/pme_ato1_ssp585_proj.csv')
  fwrite(df_fut3,'analysis_output/fig4/pme/pme_ato3_ssp245_proj.csv')
  fwrite(df_fut4,'analysis_output/fig4/pme/pme_ato3_ssp585_proj.csv')
  
  
    p = ggplot()+
      geom_line(data = dffutm,
                aes(x = date,y= value,
                    color = type,
                    group = type),
                size = 1)+
      scale_color_npg()+
      facet_wrap(~variable,nrow = 4)+
      theme_bw()
  
  extract_test1_pr245 <- function(i){
      if(i!=1){
        tmp = ret1_245[[i]][[2]][,2]
      }else{
        tmp = ret1_245[[i]][[2]]
      }
      return(tmp)
    }
  extract_test1_pr585 <- function(i){
      if(i !=1){
        tmp = ret1_585[[i]][[2]][,2]
        
      }else{
        tmp = ret1_585[[i]][[2]]
        
      }
      return(tmp)
    }
  extract_test3_pr245 <- function(i){
      if(i !=1){
        tmp = ret3_245[[i]][[2]][,2]
      }else{
        tmp = ret3_245[[i]][[2]]
      }
      
      return(tmp)
    }
  extract_test3_pr585 <- function(i){
      if(i !=1){
        tmp = ret3_585[[i]][[2]][,2]
      }else{
        tmp = ret3_585[[i]][[2]]
      }
      
      return(tmp)
    }
    
  ret1_245_test = lapply(i,extract_test1_pr245)
  ret1_585_test = lapply(i,extract_test1_pr585)
  ret3_245_test = lapply(i,extract_test3_pr245)
  ret3_585_test = lapply(i,extract_test3_pr585)
  
  ret1_245_test = do.call(cbind,ret1_245_test)
  ret3_245_test = do.call(cbind,ret3_245_test)
  ret1_585_test = do.call(cbind,ret1_585_test)
  ret3_585_test = do.call(cbind,ret3_585_test)
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(ret1_245_test) = c('ERA5',modelnames)
  colnames(ret3_245_test) = c('ERA5',modelnames)
  colnames(ret1_585_test) = c('ERA5',modelnames)
  colnames(ret3_585_test) = c('ERA5',modelnames)
  
  datefull = seq(as.Date('2003-01-01'),
                 as.Date('2050-12-01'),
                 '1 month')
  
  ret1_245_test = data.frame(date = datefull[127:180],
                             ret1_245_test)
  ret1_585_test = data.frame(date = datefull[127:180],
                             ret1_585_test)
  ret3_245_test = data.frame(date = datefull[127:180],
                             ret3_245_test)
  ret3_585_test = data.frame(date = datefull[127:180],
                             ret3_585_test)
  
  fwrite(ret1_245_test,'analysis_output/fig4/pme/pme_ato1_245_test.csv')
  fwrite(ret1_585_test,'analysis_output/fig4/pme/pme_ato1_585_test.csv')
  fwrite(ret3_245_test,'analysis_output/fig4/pme/pme_ato3_245_test.csv')
  fwrite(ret3_585_test,'analysis_output/fig4/pme/pme_ato3_585_test.csv')
  
}







validate_cmip6_sst <-function(
  
){
  library(data.table)
  sst_in_source1 = fread('era5_sst_mean/ato/region1/era5_sst_mean.csv')
  sst_in_source3 = fread('era5_sst_mean/ato/region3/era5_sst_mean.csv')
  
  sst_in_source1 = as.data.frame(sst_in_source1)
  sst_in_source3 = as.data.frame(sst_in_source3)
  
  sst_in_source = data.frame(
    sst1 = sst_in_source1[,1],
    sst3 = sst_in_source3[,1])
  
  input_sst = list.files('analysis_output/cmip6_by_model/sst',
                         full.names = T)
  
  sst = lapply(lapply(input_sst,fread),as.data.frame)
  
  sst1_ssp245_train = sst[[1]][1:180,]
  sst1_ssp585_train = sst[[2]][1:180,]
  sst3_ssp245_train = sst[[3]][1:180,]
  sst3_ssp585_train = sst[[4]][1:180,]
  
  sst1_ssp245_proj = sst[[1]][181:576,]
  sst1_ssp585_proj = sst[[2]][181:576,]
  sst3_ssp245_proj = sst[[3]][181:576,]
  sst3_ssp585_proj = sst[[4]][181:576,]
  
  sst1_ssp245_train<<- sst1_ssp245_train
  sst1_ssp585_train <<- sst1_ssp585_train
  sst3_ssp245_train<<- sst3_ssp245_train
  sst3_ssp585_train <<- sst3_ssp585_train
  sst1_ssp245_proj <<- sst1_ssp245_proj
  sst1_ssp585_proj <<- sst1_ssp585_proj
  sst3_ssp245_proj <<- sst3_ssp245_proj
  sst3_ssp585_proj <<- sst3_ssp585_proj
  
  i = 1:ncol(sst1_ssp245_train)
  correct_fun1_ssp245 <-function(i){
    df = data.frame(
      sst = sst_in_source[,1],
      cmip6 = sst1_ssp245_train[,i]
    )
    df_project = data.frame(
      cmip6 = sst1_ssp245_proj[,i]
    )
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_sst_cmip6.R')
    ret = random_forest_model_sst_cmip6(df,df_project)
    return(ret)
  }
  correct_fun1_ssp585 <-function(i){
    df = data.frame(
      sst = sst_in_source[,1],
      cmip6 = sst1_ssp585_train[,i]
    )
    df_project = data.frame(
      cmip6 = sst1_ssp585_proj[,i]
    )
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_sst_cmip6.R')
    ret = random_forest_model_sst_cmip6(df,df_project)
    return(ret)
  }
  correct_fun3_ssp245 <-function(i){
    df = data.frame(
      sst = sst_in_source[,2],
      cmip6 = sst3_ssp245_train[,i]
    )
    df_project = data.frame(
      cmip6 = sst3_ssp245_proj[,i]
    )
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_sst_cmip6.R')
    ret = random_forest_model_sst_cmip6(df,df_project)
    return(ret)
  }
  correct_fun3_ssp585 <-function(i){
    df = data.frame(
      sst = sst_in_source[,2],
      cmip6 = sst3_ssp585_train[,i]
    )
    df_project = data.frame(
      cmip6 = sst3_ssp585_proj[,i]
    )
    source('/home/share/R_project/xinjiang_vapor/random_forest_model_sst_cmip6.R')
    ret = random_forest_model_sst_cmip6(df,df_project)
    return(ret)
  }
  
  ret1_245 = lapply(i,correct_fun1_ssp245)
  ret1_585 = lapply(i,correct_fun1_ssp585)
  ret3_245 = lapply(i,correct_fun3_ssp245)
  ret3_585 = lapply(i,correct_fun3_ssp585)
  
  ret1_245 <<- ret1_245
  ret1_585 <<- ret1_585
  ret3_585 <<- ret3_585
  ret3_245 <<- ret3_245
  
  i = 1:ncol(sst1_ssp245_train)
  extract_train1_pr245 <- function(i){
    if(i!=1){
      tmp = ret1_245[[i]][[1]][,2]
    }else{
      tmp = ret1_245[[i]][[1]]
    }
    return(tmp)
  }
  extract_train1_pr585 <- function(i){
    if(i !=1){
      tmp = ret1_585[[i]][[1]][,2]
      
    }else{
      tmp = ret1_585[[i]][[1]]
      
    }
    return(tmp)
  }
  extract_train3_pr245 <- function(i){
    if(i !=1){
      tmp = ret3_245[[i]][[1]][,2]
    }else{
      tmp = ret3_245[[i]][[1]]
    }
    
    return(tmp)
  }
  extract_train3_pr585 <- function(i){
    if(i !=1){
      tmp = ret3_585[[i]][[1]][,2]
    }else{
      tmp = ret3_585[[i]][[1]]
    }
    
    return(tmp)
  }
  
  ret1_245_train = lapply(i,extract_train1_pr245)
  ret3_245_train = lapply(i,extract_train3_pr245)
  ret1_585_train = lapply(i,extract_train1_pr585)
  ret3_585_train = lapply(i,extract_train3_pr585)
  
  ret1_245_train = do.call(cbind,ret1_245_train)
  ret3_245_train = do.call(cbind,ret3_245_train)
  ret1_585_train = do.call(cbind,ret1_585_train)
  ret3_585_train = do.call(cbind,ret3_585_train)
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(ret1_245_train) = c('ERA5',modelnames)
  colnames(ret3_245_train) = c('ERA5',modelnames)
  colnames(ret1_585_train) = c('ERA5',modelnames)
  colnames(ret3_585_train) = c('ERA5',modelnames)
  
  datefull = seq(as.Date('2003-01-01'),
                 as.Date('2050-12-01'),
                 '1 month')
  
  ret1_245_train = data.frame(date = datefull[1:126],
                              ret1_245_train)
  ret1_585_train = data.frame(date = datefull[1:126],
                              ret1_585_train)
  ret3_245_train = data.frame(date = datefull[1:126],
                              ret3_245_train)
  ret3_585_train = data.frame(date = datefull[1:126],
                              ret3_585_train)
  
  dir.create('analysis_output/fig4/sst')
  fwrite(ret1_245_train,'analysis_output/fig4/sst/sst_ato1_245_train.csv')
  fwrite(ret1_585_train,'analysis_output/fig4/sst/sst_ato1_585_train.csv')
  fwrite(ret3_245_train,'analysis_output/fig4/sst/sst_ato3_245_train.csv')
  fwrite(ret3_585_train,'analysis_output/fig4/sst/sst_ato3_585_train.csv')
  
  
  df1 = reshape2::melt(ret1_245_train,'date')
  df2 = reshape2::melt(ret1_585_train,'date')
  df3 = reshape2::melt(ret3_245_train,'date')
  df4 = reshape2::melt(ret3_585_train,'date')
  
  er1 = ret1_245_train[,1:2]
  er3 = ret3_245_train[,1:2]
  
  p1 = ggplot()+
    geom_line(data = df1,
              aes(x = date,
                  y = value,
                  color = variable))+
    geom_line(data = er1,
              aes(x = date,y = ERA5),
              color = 'black',size = 1)+
    scale_color_npg()+
    facet_wrap(~variable,nrow = 2)+
    theme_bw()
  
  # fut 
  i = 1:ncol(sst1_ssp245_train)
  extract_fut1_pr245 <- function(i){
    if(i!=1){
      tmp = ret1_245[[i]][[3]]
    }else{
      tmp = ret1_245[[i]][[3]]
    }
    return(tmp)
  }
  extract_fut1_pr585 <- function(i){
    if(i !=1){
      tmp = ret1_585[[i]][[3]]
      
    }else{
      tmp = ret1_585[[i]][[3]]
      
    }
    return(tmp)
  }
  extract_fut3_pr245 <- function(i){
    if(i !=1){
      tmp = ret3_245[[i]][[3]]
    }else{
      tmp = ret3_245[[i]][[3]]
    }
    
    return(tmp)
  }
  extract_fut3_pr585 <- function(i){
    if(i !=1){
      tmp = ret3_585[[i]][[3]]
    }else{
      tmp = ret3_585[[i]][[3]]
    }
    
    return(tmp)
  }
  
  
  ret_fut1_245 = lapply(i,extract_fut1_pr245)
  ret_fut1_585 = lapply(i,extract_fut1_pr585)
  ret_fut3_245 = lapply(i,extract_fut3_pr245)
  ret_fut3_585 = lapply(i,extract_fut3_pr585)
  
  ret_fut1_245 <<- ret_fut1_245
  ret_fut1_585 <<- ret_fut1_585
  ret_fut3_245 <<- ret_fut3_245
  ret_fut3_585 <<- ret_fut3_585
  
  ret_to_df1 <-function(i){
    x = ret_fut1_245[[i]][,2]
    return(x)
  }
  ret_to_df2 <-function(i){
    x = ret_fut1_585[[i]][,2]
    return(x)
  }
  ret_to_df3 <-function(i){
    x = ret_fut3_245[[i]][,2]
    return(x)
  }
  ret_to_df4 <-function(i){
    x = ret_fut3_585[[i]][,2]
    return(x)
  }
  
  df_fut1 = data.frame(
    ret_fut1_245[[1]],
    do.call('cbind',lapply(i,ret_to_df1))[,-1]
  )
  df_fut2 = data.frame(
    ret_fut1_585[[1]],
    do.call('cbind',lapply(i,ret_to_df2))[,-1]
  )
  
  df_fut3 = data.frame(
    ret_fut3_245[[1]],
    do.call('cbind',lapply(i,ret_to_df3))[,-1]
  )
  df_fut4 = data.frame(
    ret_fut3_585[[1]],
    do.call('cbind',lapply(i,ret_to_df4))[,-1]
  )
  
  
  colnames(df_fut1) = c('date',modelnames)
  colnames(df_fut2) = c('date',modelnames)
  colnames(df_fut3) = c('date',modelnames)
  colnames(df_fut4) = c('date',modelnames)
  
  df_fut1m = reshape2::melt(df_fut1,'date')
  df_fut2m = reshape2::melt(df_fut2,'date')
  df_fut3m = reshape2::melt(df_fut3,'date')
  df_fut4m = reshape2::melt(df_fut4,'date')
  
  df_fut1m$type = 'SSP245_SST1'
  df_fut2m$type = 'SSP585_SST1'
  df_fut3m$type = 'SSP245_SST3'
  df_fut4m$type = 'SSP585_SST3'
  
  dffutm = rbind(df_fut1m,df_fut2m,
                 df_fut3m,df_fut4m)
  
  dir.create('analysis_output/fig4')
  fwrite(df_fut1,'analysis_output/fig4/sst/sst_ato1_ssp245_proj.csv')
  fwrite(df_fut2,'analysis_output/fig4/sst/sst_ato1_ssp585_proj.csv')
  fwrite(df_fut3,'analysis_output/fig4/sst/sst_ato3_ssp245_proj.csv')
  fwrite(df_fut4,'analysis_output/fig4/sst/sst_ato3_ssp585_proj.csv')
  
  
  p = ggplot()+
    geom_line(data = dffutm,
              aes(x = date,y= value,
                  color = type,
                  group = type),
              size = 1)+
    scale_color_npg()+
    facet_wrap(~variable,nrow = 4)+
    theme_bw()
  
  extract_test1_pr245 <- function(i){
    if(i!=1){
      tmp = ret1_245[[i]][[2]][,2]
    }else{
      tmp = ret1_245[[i]][[2]]
    }
    return(tmp)
  }
  extract_test1_pr585 <- function(i){
    if(i !=1){
      tmp = ret1_585[[i]][[2]][,2]
      
    }else{
      tmp = ret1_585[[i]][[2]]
      
    }
    return(tmp)
  }
  extract_test3_pr245 <- function(i){
    if(i !=1){
      tmp = ret3_245[[i]][[2]][,2]
    }else{
      tmp = ret3_245[[i]][[2]]
    }
    
    return(tmp)
  }
  extract_test3_pr585 <- function(i){
    if(i !=1){
      tmp = ret3_585[[i]][[2]][,2]
    }else{
      tmp = ret3_585[[i]][[2]]
    }
    
    return(tmp)
  }
  
  ret1_245_test = lapply(i,extract_test1_pr245)
  ret1_585_test = lapply(i,extract_test1_pr585)
  ret3_245_test = lapply(i,extract_test3_pr245)
  ret3_585_test = lapply(i,extract_test3_pr585)
  
  ret1_245_test = do.call(cbind,ret1_245_test)
  ret3_245_test = do.call(cbind,ret3_245_test)
  ret1_585_test = do.call(cbind,ret1_585_test)
  ret3_585_test = do.call(cbind,ret3_585_test)
  
  modelnames = list.files('/media/root/Shen_drive1/CMIP6/SST')
  modelnames <<- modelnames
  
  colnames(ret1_245_test) = c('ERA5',modelnames)
  colnames(ret3_245_test) = c('ERA5',modelnames)
  colnames(ret1_585_test) = c('ERA5',modelnames)
  colnames(ret3_585_test) = c('ERA5',modelnames)
  
  datefull = seq(as.Date('2003-01-01'),
                 as.Date('2050-12-01'),
                 '1 month')
  
  ret1_245_test = data.frame(date = datefull[127:180],
                             ret1_245_test)
  ret1_585_test = data.frame(date = datefull[127:180],
                             ret1_585_test)
  ret3_245_test = data.frame(date = datefull[127:180],
                             ret3_245_test)
  ret3_585_test = data.frame(date = datefull[127:180],
                             ret3_585_test)
  
  fwrite(ret1_245_test,'analysis_output/fig4/sst/sst_ato1_245_test.csv')
  fwrite(ret1_585_test,'analysis_output/fig4/sst/sst_ato1_585_test.csv')
  fwrite(ret3_245_test,'analysis_output/fig4/sst/sst_ato3_245_test.csv')
  fwrite(ret3_585_test,'analysis_output/fig4/sst/sst_ato3_585_test.csv')
  
}







var_analysis_between_epsource_p <- function(
  
){
  files = c('north_moun','north_jishui','south_moun','south_jishui')
  gpcc_pr = paste0('gpcc_pr_in_target/',files,'.csv')
  era5_pr = paste0('era5_pr_in_target/',files,'.csv')
  
  con_amount_input = paste0('convey_amount_based_era5_in_target')
  
  
  # 2003-2013
  # 2013-2017
  i = 1:4
  var_fun <-function(i){
    files = c('north_moun','north_jishui','south_moun','south_jishui')
    gpcc_pr = paste0('gpcc_pr_in_target/',files[i],'.csv')
    print(gpcc_pr)
    #era5_pr = paste0('era5_pr_in_target/',files[i],'.csv')
    con_amount_input = paste0('convey_amount_based_era5_in_target/mean/',
                              files[i],'.csv')
    
    gpcc = fread(gpcc_pr)
    con_amount = fread(con_amount_input)
    
    colnames(gpcc) = 'gpcc_pr'
    colnames(con_amount) = paste0('pr',1:12)
    
    gpcc = as.data.frame(gpcc)
    con_amount = as.data.frame(con_amount)
    
    con_sum = apply(con_amount,2,sum)
    id_re = as.numeric(which(con_sum <100))
    if(length(id_re)>0){
      con_amount = con_amount[,-id_re]  
    }
    
    df = data.frame(gpcc,con_amount)
    
    trend_fun <- function(x){
      xa = (x -mean(x))/(max(x) - min(x))
      xt = ts(xa,start = c(2003,1),frequency = 12)
      xt = decompose(xt)$trend
      return(xt)
    }
    df = apply(df,2,trend_fun)
    
    
    
    date = seq(as.Date('2003-01-01'),as.Date('2017-12-01'),'1 month')
    df = data.frame(date,df)
    
    dfm = melt(df,'date')
    
    pvar = ggplot()+
      geom_line(data = dfm,aes(x = date,y = value,
                               color = variable))+
      facet_wrap(~variable,nrow = 4,scales = 'free')+
      theme_bw()
  }
}

























var_analysis_cmip6_project_tws <-function(
  
){
  input = 'simu_cmip6_tws'
  pattern = c('hist_ssp245','hist_ssp585')
  
  input = paste0(input,'/',pattern)
  
  i = 1:2
  input <<- input
  
  
  trend_cmip6_proj<-function(x){
    tx = ts(x,c(2017,7),frequency = 12)
    ttx = decompose(tx)$trend
    stand_trend <-function(x){
      xt = (x -mean(x,na.rm = T))/(max(x,na.rm=T) - min(x,na.rm = T))
      return(xt)
    }
    ttx = stand_trend(ttx)
    return(ttx)
  }
  trend_cmip6_train<-function(x){
    tx = ts(x,c(2003,1),frequency = 12)
    ttx = decompose(tx)$trend
    stand_trend <-function(x){
      xt = (x -mean(x,na.rm = T))/(max(x,na.rm=T) - min(x,na.rm = T))
      return(xt)
    }
    ttx = stand_trend(ttx)
    return(ttx)
  }
  trend_cmip6_test<-function(x){
    tx = ts(x,c(2013,2),frequency = 12)
    ttx = decompose(tx)$trend
    stand_trend <-function(x){
      xt = (x -mean(x,na.rm = T))/(max(x,na.rm=T) - min(x,na.rm = T))
      return(xt)
    }
    ttx = stand_trend(ttx)
    
    return(ttx)
  }
  
  
  
  sub_var<-function(i){
    input1 = list.files(input[i],full.names = T)
    
    proj_box = lapply(input1[c(1,4)],fread)
    test_box = lapply(input1[c(2,5)],fread)
    train_box = lapply(input1[c(3,6)],fread)
    
    proj_box = lapply(proj_box,as.data.frame)
    test_box = lapply(test_box,as.data.frame)
    train_box = lapply(train_box,as.data.frame)
    
    north_proj = proj_box[[1]]
    north_test = test_box[[1]]
    north_train = train_box[[1]]
    
    south_proj = proj_box[[2]]
    south_test = test_box[[2]]
    south_train = train_box[[2]]
    
    
    north_proj_trend = north_proj
    south_proj_trend = south_proj
    north_test_trend = north_test
    south_test_trend = south_test
    north_train_trend = north_train
    south_train_trend = south_train
    
    north_proj_trend = apply(north_proj,2,trend_cmip6_proj)
    south_proj_trend = apply(south_proj,2,trend_cmip6_proj)
    
    north_test_trend = apply(north_test,2,trend_cmip6_test)
    south_test_trend = apply(south_test,2,trend_cmip6_test)
    
    north_train_trend = apply(north_train,2,trend_cmip6_train)
    south_train_trend = apply(south_train,2,trend_cmip6_train)
    
    return(list(north_train_trend,
                south_train_trend,
                north_test_trend,
                south_test_trend,
                north_proj_trend,
                south_proj_trend))
    
  }
  
  ret_box = lapply(i,sub_var)
  ret_box1 = ret_box[[1]] #ssp245
  ret_box2 = ret_box[[2]] #ssp585
  
  # import cmip6 tws ssp245
  north_train_trend_ssp245 = ret_box1[[1]]
  south_train_trend_ssp245 = ret_box1[[2]]
  north_test_trend_ssp245 = ret_box1[[3]]
  south_test_trend_ssp245 = ret_box1[[4]]
  north_proj_trend_ssp245 = ret_box1[[5]]
  south_proj_trend_ssp585 = ret_box1[[6]]
  
  north_train_trend_ssp585 = ret_box2[[1]]
  south_train_trend_ssp585 = ret_box2[[2]]
  north_test_trend_ssp585 = ret_box2[[3]]
  south_test_trend_ssp585 = ret_box2[[4]]
  north_proj_trend_ssp585 = ret_box2[[5]]
  south_proj_trend_ssp585 = ret_box2[[6]]
  # import tws
  ##########################
  stand_fun1 <-function(x){
    x= x/(max(x)-min(x))
  }
  
  input_tws = 'tws_in_target/'
  files_jishui = c('north_jishui','south_jishui')
  
  input_tws_north = paste0(input_tws,files_jishui[1],'.csv')
  input_tws_south = paste0(input_tws,files_jishui[2],'.csv')
  
  north_tws_jishui = as.data.frame(fread(input_tws_north))
  south_tws_jishui = as.data.frame(fread(input_tws_south)[,1])
  
  north_tws_jishui = as.numeric(north_tws_jishui[,1])
  south_tws_jishui = as.numeric(south_tws_jishui[,1])
  
  north_tws = stand_fun1(north_tws_jishui)
  south_tws = stand_fun1(south_tws_jishui)
  
  north_tws_train = north_tws[1:121]
  south_tws_train = south_tws[1:121]
  north_tws_test = north_tws[122:174]
  south_tws_test = south_tws[122:174]
  
  #north_tws_train = trend_cmip6_train(north_tws_train)
  #south_tws_train = trend_cmip6_train(south_tws_train)
  #north_tws_test = trend_cmip6_test(north_tws_test)
  #south_tws_test = trend_cmip6_test(south_tws_test)
  ##########################
  
  var_compare <- function(date,tws,df){
    df = data.frame(date,df)
    df = reshape2::melt(df,'date')
    df_tws = data.frame(date,tws)
    
    pline = ggplot()+
      geom_line(data = df,aes(x = date,y = value))+
      geom_line(data = df_tws,aes(x = date,y = tws),
                color = 'black',linetype = 'dashed')+
      facet_wrap(~variable,nrow = 2,scales = 'free')+
      theme_bw()
    
    pline
  }
  pl_ribbion_fun1 <-function(date,tws,df){
    df1 = data.frame(date,mean = df$xmean,
                         tws = tws)
    
    df1 = reshape2::melt(df1,'date')
    
    df_rib = data.frame(date,xmin = df$xmin,
                        xmax = df$xmax)
    
    
    pline = ggplot()+
      geom_line(data = df1,aes(x = date,y = value,
                              color = variable))+
      geom_ribbon(data = df_rib,aes(x = date, ymin = xmin,
                                    ymax = xmax),
                  fill = 'grey80',alpha = 0.5,color = 'transparent')+
      theme_bw()
    
    pline
    
    
  }
  
  date_train = seq(as.Date('2003-01-01'),as.Date('2013-01-01'),
                   '1 month')
  date_test = seq(as.Date('2013-02-01'),as.Date('2017-06-01'),
                  '1 month')
  date_proj = seq(as.Date('2017-07-01'),as.Date('2050-12-11'),
                  '1 month')
  
  statistc_cal_fun<-function(x){
    mean_fun <-function(x){
      x = mean(x,na.rm = T)
      return(x)
    }  
    max_fun <-function(x){
      x = max(x,na.rm = T)
      return(x)
    }  
    
    min_fun <-function(x){
      x = min(x,na.rm = T)
      return(x)
    }  
    
    xmean = apply(x,1,mean_fun)
    xmin = apply(x,1,min_fun)
    xmax = apply(x,1,max_fun)
    d = data.frame(xmin,xmean,xmax)
    return(d)
  }
  
  north_train_trend_ssp245 = statistc_cal_fun(north_train_trend_ssp245)
  north_train_trend_ssp245 = statistc_cal_fun(north_train_trend_ssp245)
  pl_ribbion_fun1(date_train,north_tws_train,north_train_trend_ssp245)
  pl_ribbion_fun1(date_test,north_tws_test,north_test_trend_ssp245)
  
  # var compare 245
  var_compare(date_train,north_tws_train,north_train_trend_ssp245)
  var_compare(date_test,north_tws_test,north_test_trend_ssp245)
  var_compare(date_train,south_tws_train,south_train_trend_ssp245)
  var_compare(date_test,south_tws_test,south_test_trend_ssp245)
  
  # var compare 585
  var_compare(date_train,north_tws_train,north_train_trend_ssp585)
  var_compare(date_test,north_tws_test,north_test_trend_ssp585)
  var_compare(date_train,south_tws_train,south_train_trend_ssp585)
  var_compare(date_test,south_tws_test,south_test_trend_ssp585)
  
  north_proj_df = data.frame(date = date_proj,north_proj_trend)
  north_proj_dfm = reshape2::melt(north_proj_df,'date')
  
  pline = ggplot()+
    geom_line(data = north_proj_dfm,aes(x = date,y = value,color = variable))+
    facet_wrap(~variable,nrow = 2,scales = 'free')+
    theme_bw()
  
  south_proj_df = data.frame(date = date_proj,south_proj_trend)
  south_proj_dfm = reshape2::melt(south_proj_df,'date')
  
  pline2 = ggplot()+
    geom_line(data = south_proj_dfm,aes(x = date,y = value))+
    facet_wrap(~variable,nrow = 2,scales = 'free')+
    theme_bw()
  
  
  
}
var_analysis<-function(
  
){
  library(data.table)
  source('/home/share/R_project/xinjiang_vapor/trend_index.R')
  source('/home/share/R_project/xinjiang_vapor/stand_fun.R')
  contr = fread('analysis_output/contr_in_source_variance_new.csv')
  source('/home/share/R_project/xinjiang_vapor/stand_fun.R')
  sou_name = contr[,1]
  contr = contr[,-1]  
  sum_fun<-function(x){
    x = sum(x,na.rm = T)
  }
  
  contr_sum = apply(contr,2,sum_fun)
  
  contr_sum = as.numeric(contr_sum)
  contr_sum_t = trend_index(contr_sum,c(2003,1),12)
  
  # gpcc 
  source('/home/share/R_project/xinjiang_vapor/gpcc_pr_in_xinjiang.R')
  gpcc_trend = gpcc_pr_in_xinjiang()
  
  # gws
  source('/home/share/R_project/xinjiang_vapor/gws_in_xinjiang.R')
  gws_trend = gws_in_xinjiang()
  
  # era5_evpor
  source('/home/share/R_project/xinjiang_vapor/era5_evapor.R')
  era5_eva = era5_evapor()
  
  # era5_temper
  source('/home/share/R_project/xinjiang_vapor/era5_temper.R')
  era5t = era5_tmp()
  
  # ndvi 
  source('/home/share/R_project/xinjiang_vapor/ndvi_in_xinjiang.R')
  ndvi = ndvi_in_xinjiang()
  
  # tt_released
  tt_re = data_management(mode = 'total_released')
  tt_re_t = trend_index(tt_re,start = c(2003,1),fre = 12)
  tt_re_s = stand_fun(tt_re_t)
  
  
  contr_sum_s = stand_fun(contr_sum_t)
  gpcc_s = stand_fun(gpcc_trend)
  gws_s = stand_fun(gws_trend)
  eva_s = stand_fun(era5_eva)
  t_s = stand_fun(era5t)
  ndvi_s = stand_fun(ndvi)
  
  date = seq(as.Date('2003-07-01'),
             as.Date('2017-06-01'),'1 month')
  
  eva_p = stand_fun(era5_eva - gpcc_trend)
  df = data.frame(date,gpcc_s,gws_s,eva_s)
  library(ggplot2)
  library(reshape2)
  dfm = melt(df,'date')
  
  
  p = ggplot()+
    geom_line(data = dfm,aes(x = date,y = value,color = variable),size = 1)+
    theme_bw()+
    theme(
      panel.background = element_rect(fill = 'transparent'),
      axis.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      axis.title = element_text(color = 'black',size = 14,face = 'bold',hjust = 0.5),
      legend.position = 'bottom',
      legend.direction = 'horizontal',
      legend.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5),
      legend.title = element_text(color = 'black',size = 14, face = 'bold',hjust = 0.5),
      strip.text = element_text(color = 'black',size = 12, face = 'bold',hjust = 0.5)
    )+
    guides(color = guide_legend(nrow = 1))+
    xlab('Date (month)')+
    ylab('Index')
    
  png('plot/co-var.png',
      height = 15,
      width = 21,
      units = 'cm',
      res = 800)
  print(p)
  dev.off()
  
  
  
}
wind_fileds_at_different_level<-function(
  
){
  input_files = list.files('/media/sdb1/xinjiang_output_file',
                           full.names = T)
  
  
  input_files <<- input_files
  input_land = paste0(input_files,'/output/contr_released_land')
  input_ocean = paste0(input_files,'/output/contr_released_ocean')
  input_land <<- input_land
  input_ocean <<- input_ocean
  
  fread_in <- function(x){
    
    x = list.files(x,full.names = T)
    print(x)
    x = lapply(x,fread)
    x = lapply(x,as.data.frame)
    rbind_fun <- function(x){return(x[,1:3])}
    x = lapply(x,rbind_fun)
    x = do.call(rbind,x)
    return(x)
  }
  
  land_df = lapply(input_land,fread_in)
  oce_df = lapply(input_ocean,fread_in)
  
  land_df = lapply(land_df,as.data.frame)
  oce_df = lapply(oce_df,as.data.frame)
  
  land_df = do.call(rbind,land_df)
  oce_df = do.call(rbind,oce_df)
  
  height = c(land_df[,3],oce_df[,3])
  long = c(land_df[,1],oce_df[,1])
  lat = c(land_df[,2],oce_df[,2])
  
  df = data.frame(long,lat,height)
  height = aggregate(df$height,list(long,lat),mean)
  
  
  
  
}
world_ocean_shp <-function(
  
){
  shp_path = '/root/下载/World_Seas_IHO_v3'
  files = list.files(shp_path,full.names = T,pattern = '.shp$')
  shp = shapefile(files)
  shp <<- shp
  
  names_shp = shp$NAME
  tran_to_li <- function(name){
    shp_sub = shp[shp$NAME == name,]
    ex = extent(shp_sub)[3]
    if(ex >= 0){
      return(shp_sub)
    }
  }
  system.time(ret_shp_li <- lapply(names_shp,tran_to_li))
  
  id_re = 1
  for(i in 1:length(ret_shp_li)){
    if(is.null(ret_shp_li[[i]])){
      id_re = c(id_re, i)
    }
  }
  id_re = id_re[-1]
  ret_shp_li = ret_shp_li[-id_re]
  
  # get Atlantic Ocean
  shp_ato = shp[shp$NAME == 'North Atlantic Ocean',]
  shp_indian = shp[shp$NAME == 'Indian Ocean',]
  cr_ex = extent(extent(shp_indian)[1],extent(shp_indian)[2],0,extent(shp_indian)[4])
  shp_indian = crop(shp_indian,cr_ex)
  
  ret_shp_li = c(ret_shp_li,shp_ato,shp_indian)
  # import label csv 
  labels_csv = read.csv('/media/sdb1/shp/names_north_ocean_shp.csv')
  labels_csv = labels_csv[,-1]
  
  po_li = list()
  ato_li = list()
  ao_li = list()
  io_li = list()
  ms_li = list()
  rs_li = list()
  bs_li = list()
  
  for(i in 1:length(ret_shp_li)){
    tmpname = ret_shp_li[[i]]$NAME
    tmpid_in_label = which(as.character(labels_csv$Sea) == tmpname)
    
    if(length(tmpid_in_label) == 1){
      tmpocean = labels_csv[tmpid_in_label,2]
    }else{
      tmpocean ='NA'
      #print(tmpname)
    }
    
    if(tmpocean == "PO" |tmpname =='North Pacific Ocean' ){
      po_li = c(po_li,ret_shp_li[[i]])
    }else if(tmpocean == 'ATO'|tmpname =='North Atlantic Ocean'){# atlantic seaw
      ato_li = c(ato_li, ret_shp_li[[i]])
    }else if(tmpocean == 'AO'|tmpname =='Arctic Ocean'){# artic sea
      ao_li = c(ao_li,ret_shp_li[[i]])
      #print(tmpocean)
    }else if(tmpocean == 'IO'|tmpname =='Indian Ocean'){ # indian sea
      io_li = c(io_li, ret_shp_li[[i]])
    }else if(tmpocean == 'MS'|tmpname =='Mediterranean Sea - Eastern Basin'|tmpname == 'Mediterranean Sea - Western Basin'){# medi sea
      ms_li = c(ms_li,ret_shp_li[[i]])
    }else if(tmpocean == 'RS'|tmpname =='Red Sea'){ # red sea
      rs_li = c(rs_li,ret_shp_li[[i]])
    }else if(tmpocean == 'BS'|tmpname =='BS'){ # black sea
      bs_li = c(bs_li,ret_shp_li[[i]])
    }
  }
  
  sth_china_sea = shp[shp$NAME == 'South China Sea',]
  po_li = c(po_li,sth_china_sea)
  
  ara_bin_sea = shp[shp$NAME =='Arabian Sea',]
  io_li = c(io_li, ara_bin_sea)
  
  id_non = 1
  for(i in 1:length(ao_li)){
    if(extent(ao_li[[i]])[4]<62){
      id_non = c(id_non,i)
    }
  }
  id_non = id_non[-1]
  
  kt_sea = ao_li[[id_non]]
  ao_li = ao_li[-id_non]
  ato_li = c(ato_li,kt_sea)
  
  # combine shps
  po_li_b = do.call('bind',po_li)
  ato_li_b = do.call('bind',ato_li)
  ao_li_b = do.call('bind',ao_li)
  io_li_b = do.call('bind',io_li)
  ms_li_b = do.call('bind',ms_li)
  rs_li_b = do.call('bind',rs_li)
  bs_li_b = do.call('bind',bs_li)
  
  cat_sea = shapefile('/media/sdb1/shp/caspian_sea.shp')
  
  #dir.create('/media/sdb1/shp/ocean_shp')
  output = paste0('/media/sdb1/shp/ocean_shp/',c('po','ato','ao','io','ms','rs','bs','cs'),
                  '.shp')
  out_li = list(po_li_b,ato_li_b,ao_li_b,io_li_b,ms_li_b,rs_li_b,bs_li_b,cat_sea)
  
  for(i in 1:length(out_li)){
    shapefile(out_li[[i]],output[i])
  }
  
  p = ggplot()+
    geom_polygon(data = po_li_b,aes(x = long,y = lat,group = group),fill = 'blue')+
    geom_polygon(data = ato_li_b,aes(x = long,y = lat,group = group),fill = 'yellow')+
    geom_polygon(data = ao_li_b,aes(x = long,y = lat,group = group),fill = 'red')+
    geom_polygon(data = io_li_b,aes(x = long,y = lat,group = group),fill = 'pink')+
    geom_polygon(data = ms_li_b,aes(x = long,y = lat,group = group),fill = 'grey')+
    geom_polygon(data = rs_li_b,aes(x = long,y = lat,group = group),fill = 'green')+
    geom_polygon(data = bs_li_b,aes(x = long,y = lat,group = group),fill = 'black')+
    geom_polygon(data = shp,aes(x = long,y = lat,group= group),fill = 'transparent',
                 color = 'black')
  
  
  

}
library(raster)
library(doParallel)
#tmptws is raster stack
beginCluster(12)
mon_mean = clusterR(tmptws,calc,
                    args = list(fun = mmkfunRaster))
endCluster()
